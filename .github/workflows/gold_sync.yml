name: Tải Giá Vàng DOJI Định Kỳ

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

concurrency:
  group: 'gold-sync-group' # <-- Tên nhóm 2
  cancel-in-progress: true  # Tự hủy tác vụ cũ (Đúng ý bạn)

permissions:
  contents: write

jobs:
  update-gold-price:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Kiểm tra mã nguồn (Checkout Repository)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 1.5. Cập nhật (Pull) thay đổi mới nhất
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git pull --rebase

      - name: 2. Thiết lập Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: 3. Cài đặt Dependencies (axios, xml2js)
        run: npm install axios xml2js

      - name: 4. Chạy Script Tải và Lưu Dữ Liệu
        run: node scripts/gold_scraper.js
        env:
          DOJI_API_KEY: ${{ secrets.DOJI_API_KEY }}
        
      - name: 5. Kiểm tra thay đổi
        id: commit
        run: |
          if git diff --quiet gold_history.json; then
            echo "Không có thay đổi dữ liệu, bỏ qua commit."
            echo "commit_required=false" >> $GITHUB_OUTPUT
          else
            echo "Dữ liệu đã thay đổi, chuẩn bị commit."
            echo "commit_required=true" >> $GITHUB_OUTPUT
          fi
          
      - name: 6. Commit và Đẩy (Push) Thay Đổi
        if: steps.commit.outputs.commit_required == 'true'
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          git add gold_history.json
          git commit -m "Auto sync: Cập nhật giá vàng DOJI vào $(date +%H:%M) ngày $(date +%d-%m-%Y)"
          
          # Không cần pull ở đây nữa vì đã làm ở bước 1.5
          git push
