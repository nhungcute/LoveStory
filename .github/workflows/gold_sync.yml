name: Tải Giá Vàng DOJI Định Kỳ

on:
  # Lịch trình chạy: Chạy 2 lần mỗi giờ, vào phút thứ 0 và 30
  schedule:
    - cron: '*/10 * * * *'
  
  # Cho phép chạy thủ công từ tab Actions
  workflow_dispatch: 

# ... (Phần trước Jobs giữ nguyên) ...

jobs:
  update-gold-price:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write # Đảm bảo quyền GHI đã được thiết lập

    steps:
      - name: 1. Kiểm tra mã nguồn (Checkout Repository)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: 2. Thiết lập Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: 3. Cài đặt Dependencies (axios, xml2js)
        # Giữ nguyên bước cài đặt thủ công.
        run: npm install axios xml2js

      - name: 4. Chạy Script Tải và Lưu Dữ Liệu
        run: node scripts/gold_scraper.js
        env:
          DOJI_API_KEY: ${{ secrets.DOJI_API_KEY }} 
          
      # ▼▼▼ THAY THẾ LOGIC COMMIT VÀ PUSH BẰNG CÁC BƯỚC NÀY ▼▼▼

      - name: 5. Kiểm tra và Chuẩn bị Commit
        id: git_check
        run: |
          # Thiết lập người dùng cho commit
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # Kiểm tra xem file gold_history.json có thay đổi không
          # Dùng git status --porcelain để có đầu ra sạch (hoặc trống)
          git status --porcelain gold_history.json
          
          # Lưu trạng thái thay đổi vào output
          if [[ $(git status --porcelain gold_history.json) ]]; then
            echo "commit_needed=true" >> $GITHUB_OUTPUT
            echo "Tìm thấy thay đổi trong gold_history.json."
          else
            echo "commit_needed=false" >> $GITHUB_OUTPUT
            echo "Không tìm thấy thay đổi trong gold_history.json, bỏ qua commit."
          fi
          
      - name: 6. Commit Thay Đổi (Nếu cần)
        # Chỉ chạy nếu bước 5 xác định cần commit
        if: steps.git_check.outputs.commit_needed == 'true'
        run: |
          # Chỉ thêm file mà ta cần commit
          git add gold_history.json
          
          # Commit với thông điệp động
          git commit -m "Auto sync: Cập nhật giá Nhẫn Tròn vào $(date +%H:%M) ngày $(date +%d-%m-%Y)"
          
          # Đẩy lên repository
          git push
