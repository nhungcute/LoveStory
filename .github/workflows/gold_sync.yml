name: Tải Giá Vàng DOJI Định Kỳ

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

# ▼▼▼ SỬA LỖI 1: THÊM KHỐI CONCURRENCY ▼▼▼
# Khối này đảm bảo chỉ có 1 tác vụ chạy tại một thời điểm.
# Nếu một tác vụ mới được kích hoạt, nó sẽ hủy tác vụ cũ đang chạy.
concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true
# ▲▲▲ KẾT THÚC SỬA LỖI 1 ▲▲▲

permissions:
  contents: write

jobs:
  update-gold-price:
    runs-on: ubuntu-latest
    steps:
      - name: Kiểm tra mã nguồn (Checkout Repository)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Thiết lập Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cài đặt Dependencies (axios, xml2js)
        run: npm install axios xml2js

      - name: Chạy Script Tải và Lưu Dữ Liệu
        run: node scripts/gold_scraper.js
        env:
          DOJI_API_KEY: ${{ secrets.DOJI_API_KEY }}

      - name: Kiểm tra thay đổi và Commit
        id: commit
        run: |
          # ▼▼▼ SỬA LỖI 2: SỬA LOGIC IF ▼▼▼
          # Lệnh `git diff --quiet` trả về 0 (true) NẾU KHÔNG CÓ THAY ĐỔI.
          if git diff --quiet gold_history.json; then
            echo "Không có thay đổi dữ liệu, bỏ qua commit."
            echo "commit_required=false" >> $GITHUB_OUTPUT
          else
            echo "Dữ liệu đã thay đổi, chuẩn bị commit."
            echo "commit_required=true" >> $GITHUB_OUTPUT
          fi
          # ▲▲▲ KẾT THÚC SỬA LỖI 2 ▲▲▲
          
      - name: Commit và Đẩy (Push) Thay Đổi
        if: steps.commit.outputs.commit_required == 'true'
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # git pull vẫn giữ nguyên để xử lý các commit thủ công (nếu có)
          git pull --rebase
          
          git add gold_history.json
          git commit -m "Auto sync: Cập nhật giá vàng DOJI vào $(date +%H:%M) ngày $(date +%d-%m-%Y)"
          git push
