<!doctype html>
<html lang="vi" class="h-100">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Social Memory</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css">
    <style>
	 
		:root {
		  --primary-color: #4ade80;
		  --primary-dark: #22c55e;
		  --secondary-color: #f0fdf4;
		  --text-dark: #1f2937;
		  --text-light: #6b7280;
		  --bg-color: #ffffff;
		  /* updated background default */
		  --card-bg: #ffffff;
		  --font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
			Roboto, Helvetica, Arial, sans-serif;
		  --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
		  --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
		  --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
		  --radius: 1rem;
		  /* Spacing / UI sizes */
		  --header-spacing: 10px;
		  --avatar-size: 41px;
		  /* z-index stack (tweak as needed) */
		  /* H·ªÜ TH·ªêNG Z-INDEX CHU·∫®N H√ìA */
		  --z-base: 1;
		  --z-fab: 1000;
		  --z-header: 1030;
		  --z-backdrop-base: 1040;
		  --z-modal-layout: 1050;
		  --z-backdrop-2: 1055;
		  --z-modal-popup: 1060;
		  --z-toast: 1090;
		  --z-viewer: 2000;
		}
		.theme-bg-primary {
		  background-color: var(--primary-color);
		}
		.theme-bg-secondary {
		  background-color: var(--secondary-color);
		}
		.theme-text-primary {
		  color: var(--primary-color);
		}
		.theme-text-secondary {
		  color: var(--secondary-color);
		}
		/* Basic layout & typography */
		body,
		#app {
		  box-sizing: border-box;
		  font-family: var(--font-family);
		  height: 100%;
		  margin: 0;
		  padding: 0;
		  background-color: var(--bg-color);
		  color: var(--text-dark);
		  overscroll-behavior-y: none;
		}
		#app {
		  display: flex;
		  flex-direction: column;
		  height: 100%;
		  width: 100%;
		  background-color: var(--bg-color);
		}
		 
		.app-header
		{
		  position: relative;
		  z-index: var(--z-header);
		  height: 55px;
		  display: flex;
		  align-items: center; 
		  justify-content: space-between;
		  padding: 0 12px;
		  background: linear-gradient(
			135deg,
			var(--primary-color) 0%,
			var(--secondary-color) 100%
		  );
		  color: white;
		  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
		}
		/* ƒê·∫£m b·∫£o khung n·ªôi dung b√™n trong gi√£n full chi·ªÅu ngang */
		.app-header > div 
		{
		  width: 100%;
		}
		.app-header .d-flex.gap-3 {
		  gap: 12px !important; 
		}
		.app-header .avatar-circle {
		  width: var(--avatar-size);
		  height: var(--avatar-size);
		  border-radius: 50%;
		  border: 1px solid var(--primary-color);
		  display: flex;
		  align-items: center;
		  justify-content: center;
		  background: white;
		}
		/* Main content & feed */
		.main-content {
		  position: relative;
		  flex: 1;
		  overflow-y: auto;
		  overflow-x: hidden;
		  overscroll-behavior-y: contain;
		}
		/* Posts container compacting */
		#posts-container {
		  content-visibility: auto;
		  contain-intrinsic-size: 1000px; /* ∆Ø·ªõc l∆∞·ª£ng chi·ªÅu cao danh s√°ch */
		}
		/* Cards & common components */
		.stat-card,
		.memory-card,
		.album-card {
		  background: var(--card-bg);
		  border-radius: 1rem;
		  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
		  transition: transform 0.2s;
		  position: relative;
		}
		/* Buttons / FAB */
		.btn-primary {
		  background: linear-gradient(
			135deg,
			var(--primary-color) 0%,
			var(--secondary-color) 100%
		  );
		  border: none;
		  color: #fff;
		}
		.fab-btn {
		  position: fixed;
		  bottom: 70px;
		  right: 20px;
		  width: 45px;
		  height: 45px;
		  border-radius: 50%;
		  background: linear-gradient(
			135deg,
			var(--primary-color) 0%,
			var(--secondary-color) 100%
		  );
		  color: white;
		  border: none;
		  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
		  z-index: var(--z-fab);
		}
		.avatar-circle {
		  width: var(--avatar-size);
		  height: var(--avatar-size);
		  border-radius: 50%;
		  border: 1.5px solid var(--primary-color);
		  display: flex;
		  align-items: center;
		  justify-content: center;
		  background: white;
		  overflow: hidden;
		  /* <--- QUAN TR·ªåNG: C·∫Øt ·∫£nh th√†nh h√¨nh tr√≤n */
		}
		/* Avatar sizes */
		.avatar-circle-sm {
		  width: 40px;
		  height: 40px;
		}
		.avatar-circle-lg {
		  width: 96px;
		  height: 96px;
		}
		/* Icons & small UI helpers */
		.icon-box {
		  width: 56px;
		  height: 56px;
		  border-radius: 50%;
		  display: flex;
		  align-items: center;
		  justify-content: center;
		}
		.icon-box-sm {
		  width: 48px;
		  height: 48px;
		}
		/* Like animation */
		@keyframes heartBeat {
		  0%,
		  100% {
			transform: scale(1);
		  }
		  25% {
			transform: scale(1.2);
		  }
		  50% {
			transform: scale(1.1);
		  }
		}
		.like-btn.active {
		  color: #dc3545;
		  animation: heartBeat 0.3s ease;
		}
		/* Notifications */
		.notification-item {
		  border-bottom: 1px solid #dee2e6;
		  transition: background 0.2s;
		}
		.notification-item.unread {
		  background: #e7f3ff;
		}
		/* -----------------------
			  Modal stacking & sizing
			  Use namespace so we can override Bootstrap when loaded after it.
			  ----------------------- */
		/* Backdrop 1 (under full modal) */
		.modal-backdrop.show {
		  opacity: 0.5;
		  background-color: #000;
		  z-index: var(--z-backdrop-base);
		  backdrop-filter: none;
		  -webkit-backdrop-filter: none;
		}
		/* Backdrop 2 (when multiple backdrops stacked) */
		.modal-backdrop.show ~ .modal-backdrop.show {
		  z-index: var(--z-backdrop-2);
		  opacity: 0.9;
		  backdrop-filter: blur(5px);
		  -webkit-backdrop-filter: blur(5px);
		}
		/* Put specific popups above backdrop 2 */
		#addBikeEntryModal,
		#addGoldEntryModal {
		  z-index: calc(var(--z-backdrop-2) + 10);
		}
		 
		/* Constrain modal area between header and bottom nav without !important */
		.modal {
		  top: 62px;
		  bottom: 50px;
		  height: auto;
		  padding: 0;
		  overflow: hidden;
		}
		/* Backdrop constrained similarly */
		.modal-backdrop {
		  top: 62px;
		  bottom: 50px;
		  height: auto;
		  z-index: var(--z-backdrop-base);
		}
		/* Modal dialog fills remaining area */
		.modal-dialog {
		  margin: 0;
		  height: 100%;
		  width: 100%;
		  max-width: none;
		}
		/* Modal content full height */
		.modal-content {
		  height: 100%;
		  border-radius: 0;
		  border: none;
		  box-shadow: none;
		  background-color: var(--card-bg);
		}
		/* Modal body uses internal scroll */
		.modal-body {
		  overflow-y: auto;
		  height: 100%;
		}
		/* Small popups (post options / confirm / comment options etc.) */
		#postOptionsModal,
		#commentOptionsModal,
		#deleteConfirmModal,
		#addBikeEntryModal,
		#addGoldEntryModal,
		#editCommentContentModal {
		  top: 0;
		  bottom: 0;
		  height: 100%;
		  padding: 0; 
		}
		#postOptionsModal .modal-dialog,
		#commentOptionsModal .modal-dialog,
		#deleteConfirmModal .modal-dialog,
		#addBikeEntryModal .modal-dialog,
		#addGoldEntryModal .modal-dialog,
		#editCommentContentModal .modal-dialog {
		  width: 85%;
		  max-width: 350px;
		  margin: auto;
		  height: 100%;
		  display: flex;
		  align-items: center;
		  justify-content: center;
		}
		#postOptionsModal .modal-content,
		#commentOptionsModal .modal-content,
		#deleteConfirmModal .modal-content,
		#addBikeEntryModal .modal-content,
		#addGoldEntryModal .modal-content,
		#editCommentContentModal .modal-content {
		  height: auto;
		  max-height: 85vh;
		  border-radius: 20px;
		  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
		  overflow: hidden;
		  border: none;
		}
		/* Center list items in option menus */
		#postOptionsModal .list-group-item,
		#commentOptionsModal .list-group-item {
		  display: flex;
		  align-items: center;
		  justify-content: center;
		  text-align: center;
		  gap: 10px;
		  padding: 1rem;
		}
		/* Image viewer (lightbox) - full screen override */
		#imageViewerModal {
		  z-index: var(--z-viewer);
		}
		#imageViewerModal .modal-dialog {
		  margin: 0;
		  padding: 0;
		  width: 100%;
		  height: 100%;
		  max-width: none;
		  position: fixed;
		  top: 0;
		  bottom: 0;
		  left: 0;
		  right: 0;
		}
		#imageViewerModal .modal-content {
		  height: 100%;
		  border-radius: 0;
		  background-color: #000;
		}
		#imageViewerModal .modal-header {
		  position: absolute;
		  top: 0;
		  left: 0;
		  width: 100%;
		  z-index: 10;
		  background: linear-gradient(
			to bottom,
			rgba(0, 0, 0, 1) 0%,
			rgba(0, 0, 0, 0) 100%
		  );
		  border-bottom: none;
		  padding: 10px 15px;
		}
		#full-image-list {
		  flex: 1;
		  width: 100%;
		  overflow-y: auto;
		  padding-top: 50px;
		  padding-bottom: 20px;
		  background-color: #000;
		}
		/* Hide the backdrop for imageViewer (we rely on the modal covering all) */
		#imageViewerModal ~ .modal-backdrop {
		  display: none;
		}
		/* -----------------------
			  Post image grid layouts (grouped + compact)
			  ----------------------- */
		.post-image-grid {
		  display: grid;
		  gap: 4px;
		  width: 100%;
		  border-radius: 5px;
		  overflow: hidden;
		  box-sizing: border-box;
		}
		/* Layout variants */
		.post-image-grid.layout-1 {
		  grid-template-columns: 1fr;
		}
		.post-image-grid.layout-2 {
		  grid-template-columns: 1fr 1fr;
		  height: 250px;
		}
		.post-image-grid.layout-1-wide {
		  grid-template-columns: repeat(2, 1fr);
		  grid-template-rows: 200px 150px;
		}
		.post-image-grid.layout-1-wide .img-box:first-child {
		  grid-column: span 2;
		}
		.post-image-grid.layout-1-tall {
		  grid-template-columns: 2fr 1fr;
		  grid-template-rows: repeat(2, 150px);
		}
		.post-image-grid.layout-1-tall .img-box:first-child {
		  grid-row: span 2;
		  height: 100%;
		}
		.post-image-grid.layout-grid-2x2 {
		  grid-template-columns: repeat(2, 1fr);
		  grid-template-rows: 200px 200px;
		}
		/* Generic img box */
		.post-image-grid .img-box {
		  position: relative;
		  overflow: hidden;
		  width: 100%;
		  height: 100%;
		}
		.post-image-grid img {
		  width: 100%;
		  height: 100%;
		  object-fit: cover;
		  display: block;
		}
		.image-overlay {
		  position: absolute;
		  inset: 0;
		  background: rgba(0, 0, 0, 0.5);
		  color: #fff;
		  display: flex;
		  align-items: center;
		  justify-content: center;
		  font-size: 2rem;
		  font-weight: 700;
		}
		/* Lightbox item tweaks (display long images correctly + side borders + bottom separator) */
		.lightbox-item {
		  position: relative;
		  width: 100%;
		  display: flex;
		  align-items: center;
		  justify-content: center;
		  background: #000;
		  border-left: 2px solid #000;
		  border-right: 2px solid #000;
		  border-bottom: 2px solid #fff;
		  margin-bottom: 0;
		}
		.lightbox-item:last-child {
		  border-bottom: none;
		}
		.lightbox-image {
		  width: 100%;
		  height: auto;
		  max-height: none;
		  object-fit: contain;
		  display: block;
		}
		/* --- TRANG TR√ç LAYOUT SELECTOR --- */
		.layout-preview-box {
		  border: 2px solid #e5e7eb;
		  /* M√†u vi·ªÅn m·∫∑c ƒë·ªãnh nh·∫°t */
		  border-radius: 12px;
		  cursor: pointer;
		  transition: all 0.2s ease-in-out;
		  background: #fff;
		  opacity: 0.8;
		  position: relative;
		  overflow: hidden;
		}
		.layout-preview-box:hover {
		  border-color: #b0b3b8;
		  transform: translateY(-2px);
		  opacity: 1;
		}
		/* Tr·∫°ng th√°i ƒë∆∞·ª£c ch·ªçn */
		.layout-preview-box.selected {
		  border-color: var(--primary-color);
		  background-color: var(--secondary-color);
		  opacity: 1;
		  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
		}
		.layout-preview-box.selected p {
		  color: var(--primary-dark);
		  font-weight: 800 !important;
		}
		/* Icon check mark khi ch·ªçn (trang tr√≠ th√™m) */
		.layout-preview-box.selected::after {
		  content: "\F26E";
		  /* Bootstrap icon check code */
		  font-family: "bootstrap-icons";
		  position: absolute;
		  top: 4px;
		  right: 4px;
		  background: var(--primary-color);
		  color: white;
		  width: 18px;
		  height: 18px;
		  border-radius: 50%;
		  font-size: 12px;
		  display: flex;
		  align-items: center;
		  justify-content: center;
		}
		/* Ph·∫ßn hi·ªÉn th·ªã c√°c √¥ vu√¥ng m√¥ ph·ªèng */
		.layout-grid-visual {
		  display: grid;
		  gap: 3px;
		  height: 60px;
		  /* Chi·ªÅu cao c·ªë ƒë·ªãnh cho khung review */
		  width: 100%;
		  margin-bottom: 6px;
		  pointer-events: none;
		}
		.layout-grid-visual div {
		  background-color: #d1d5db;
		  /* M√†u x√°m c·ªßa c√°c √¥ ·∫£nh gi·∫£ l·∫≠p */
		  border-radius: 4px;
		  transition: background-color 0.2s;
		}
		.layout-preview-box.selected .layout-grid-visual div {
		  background-color: var(--primary-color);
		  /* ƒê·ªïi m√†u √¥ ·∫£nh khi ƒë∆∞·ª£c ch·ªçn */
		  opacity: 0.6;
		}
		/* --- TRANG TR√ç THEME SELECTOR (Profile) --- */
		.theme-option {
		  height: 20px;
		  /* B·∫Øt bu·ªôc ph·∫£i c√≥ chi·ªÅu cao */
		  border-radius: 12px;
		  cursor: pointer;
		  transition: all 0.2s ease;
		  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
		}
		.theme-option:hover {
		  transform: translateY(-2px);
		  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
		}
		/* Tr·∫°ng th√°i ƒëang ƒë∆∞·ª£c ch·ªçn */
		.theme-option.selected {
		  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
		}
		/* --- C√ÅC KI·ªÇU GRID C·ª§ TH·ªÇ --- */
		/* L∆∞·ªõi 2x2 (ƒê·ªÅu nhau) */
		.layout-grid-visual.visual-2x2 {
		  grid-template-columns: 1fr 1fr;
		  grid-template-rows: 1fr 1fr;
		}
		/* 1 Ngang (Tr√™n to, d∆∞·ªõi nh·ªè) */
		.layout-grid-visual.visual-1-wide {
		  grid-template-columns: 1fr 1fr;
		  grid-template-rows: 1.6fr 1fr;
		  /* T·ª∑ l·ªá h√†ng tr√™n to h∆°n */
		}
		.layout-grid-visual.visual-1-wide div:first-child {
		  grid-column: span 2;
		}
		/* 1 D·ªçc (Tr√°i to, ph·∫£i nh·ªè) */
		.layout-grid-visual.visual-1-tall {
		  grid-template-columns: 1.6fr 1fr;
		  /* T·ª∑ l·ªá c·ªôt tr√°i to h∆°n */
		  grid-template-rows: 1fr 1fr;
		}
		.layout-grid-visual.visual-1-tall div:first-child {
		  grid-row: span 2;
		}
		/* -----------------------
			  Pull-to-refresh (PTR) optimized
			  ----------------------- */
		.ptr-element {
		  position: relative;
		  width: 100%;
		  height: 0;
		  overflow: hidden;
		  display: flex;
		  align-items: center;
		  justify-content: center;
		  transition: height 0.2s ease;
		  z-index: 10;
		  background-color: transparent;
		}
		.ptr-element.ptr-loading {
		  height: 60px;
		}
		.ptr-element.is-pulling {
		  transition: none;
		}
		.ptr-content {
		  padding-bottom: 15px;
		  display: flex;
		  flex-direction: column;
		  align-items: center;
		  justify-content: center;
		  opacity: 0;
		  transition: opacity 0.2s;
		}
		#ptr-text {
		  display: none;
		}
		.ptr-element.is-pulling .ptr-content,
		.ptr-element.ptr-loading .ptr-content {
		  opacity: 1;
		}
		.ptr-circle-svg {
		  width: 30px;
		  height: 30px;
		  transform: rotate(-90deg);
		}
		.ptr-circle-bg {
		  stroke: #e5e7eb;
		  stroke-width: 3;
		  fill: none;
		}
		.ptr-circle-progress {
		  stroke: red;
		  stroke-width: 3;
		  fill: none;
		  stroke-linecap: round;
		  stroke-dasharray: 76;
		  stroke-dashoffset: 76;
		  transition: stroke-dashoffset 0.1s, stroke 0.3s;
		}
		.ptr-loading .ptr-circle-progress {
		  stroke: #006b68;
		}
		.ptr-loading .ptr-circle-svg {
		  animation: ptr-spin 0.6s linear infinite;
		  transform-origin: center;
		}
		@keyframes ptr-spin {
		  0% {
			transform: rotate(0deg);
		  }
		  100% {
			transform: rotate(360deg);
		  }
		}
		/* -----------------------
			  Compact feed visual tweaks
			  ----------------------- */
		.post-author-name {
		  font-size: 14.5px;
		  font-weight: 600;
		  color: #000;
		  line-height: 1.2;
		}
		.post-timestamp {
		  font-size: 11.5px;
		  color: #65676b;
		  font-weight: 400;
		}
		.post-content-text {
		  font-size: 13px;
		  line-height: 1.2;
		  color: #050505;
		  white-space: pre-wrap;
		  margin: 5px 5px 10px 0px;
		}
		/* Post card tweaks for white background feed */
		.post-card {
		  background: white;
		  border-radius: 0;
		  box-shadow: none;
		  /* ƒê·∫£m b·∫£o kh√¥ng c√≥ b√≥ng */
		  margin-bottom: 0;
		  border: none;
		  /* Ch·ªâ t·∫°o 1 ƒë∆∞·ªùng k·∫ª x√°m ·ªü b√™n d∆∞·ªõi m·ªói b√†i */
		  border-bottom: 1px solid #e0e0e0;
		  padding: 0;
		}
		/* Drag handles / size toggle (shown only in edit mode) */
		.drag-handle,
		.size-toggle {
		  position: absolute;
		  display: none;
		  align-items: center;
		  justify-content: center;
		  z-index: 10;
		}
		.layout-edit-mode .drag-handle,
		.layout-edit-mode .size-toggle {
		  display: flex;
		}
		/* Stats container responsive columns */
		.stats-container {
		  display: grid;
		  grid-template-columns: 1fr;
		  gap: 1rem;
		}
		.stats-container.two-columns {
		  grid-template-columns: 1fr 1fr;
		  gap: 0.75rem;
		}
		/* --- HASHTAG SYSTEM --- */
		/* --- HASHTAG SYSTEM (FACEBOOK STYLE) --- */
		.hashtag {
		  color: #1877f2;
		  /* M√†u xanh Facebook */
		  font-weight: 500;
		  /* Gi·∫£m ƒë·ªô ƒë·∫≠m m·ªôt ch√∫t cho gi·ªëng FB */
		  cursor: pointer;
		  text-decoration: none;
		  background-color: transparent;
		  /* FB kh√¥ng c√≥ m√†u n·ªÅn cho tag trong b√†i vi·∫øt */
		  transition: all 0.2s;
		}
		.hashtag:hover {
		  text-decoration: underline;
		  background-color: rgba(24, 119, 242, 0.1);
		  /* Hover m·ªõi hi·ªán n·ªÅn nh·∫π */
		  border-radius: 2px;
		}
		/* Khu v·ª±c Trending (Chip) */
		.trending-tag-chip {
		  display: inline-flex;
		  align-items: center;
		  padding: 6px 12px;
		  background: #ebf5ff;
		  /* N·ªÅn xanh r·∫•t nh·∫°t */
		  border-radius: 20px;
		  font-size: 0.85rem;
		  color: #1877f2;
		  /* Ch·ªØ xanh */
		  font-weight: 600;
		  cursor: pointer;
		  border: 1px solid transparent;
		  transition: all 0.2s;
		}
		.trending-tag-chip:hover,
		.trending-tag-chip.active {
		  background: #1877f2;
		  color: white;
		  border-color: #1877f2;
		}
		/* Thanh tr·∫°ng th√°i ƒëang l·ªçc */
		#active-filter-bar {
		  background: #f0f2f5;
		  color: #050505;
		  padding-top: 10px;
		}
		/* Spinner khi ƒëang t·∫£i th√™m hashtag t·ª´ server */
		.hashtag-loader {
		  padding: 20px;
		  text-align: center;
		  color: #6b7280;
		  font-size: 0.9rem;
		  background: transparent;
		  animation: fadeIn 0.5s;
		}
		@keyframes fadeIn {
		  from {
			opacity: 0;
		  }
		  to {
			opacity: 1;
		  }
		}
		/* --- CH·ªàNH S·ª¨A MENU D∆Ø·ªöI ƒê√ÅY --- */
		
		/* --- S·ª¨A MENU D∆Ø·ªöI ƒê√ÅY (ƒê·ªíNG B·ªò 55PX) --- */
		.bottom-nav {
		  /* 1. Thi·∫øt l·∫≠p chi·ªÅu cao c·ªë ƒë·ªãnh gi·ªëng Header */
		  height: 55px;
		  
		  /* 2. CƒÉn gi·ªØa n·ªôi dung theo chi·ªÅu d·ªçc */
		  display: flex;
		  align-items: center; 
		  
		  /* 3. Padding ch·ªâ l·∫•y tr√°i ph·∫£i, b·ªè tr√™n d∆∞·ªõi (quan tr·ªçng) */
		  padding: 0 10px;
		  
		  background-color: var(--bg-color);
		  box-shadow: 0 -1px 10px rgba(0,0,0,0.03);
		  position: relative;
		  z-index: var(--z-header);
		}

		/* ƒê·∫£m b·∫£o khung ch·ª©a c√°c n√∫t b√™n trong gi√£n full chi·ªÅu ngang */
		.bottom-nav > div {
		  width: 100%;
		  height: 100%; /* Chi·∫øm h·∫øt chi·ªÅu cao cha */
		  display: flex;
		  align-items: center; /* CƒÉn gi·ªØa icon v√† ch·ªØ theo chi·ªÅu d·ªçc */
		  justify-content: space-around;
		}

		.bottom-nav .nav-link {
		  padding: 0; /* Reset padding m·∫∑c ƒë·ªãnh */
		  gap: 2px;   /* Kho·∫£ng c√°ch gi·ªØa Icon v√† Ch·ªØ (nh·ªè l·∫°i x√≠u cho g·ªçn) */
		  display: flex;
		  flex-direction: column;
		  align-items: center;
		  justify-content: center;
		  color: #9ca3af; /* M√†u x√°m m·∫∑c ƒë·ªãnh */
		  transition: all 0.2s;
		}

		/* M√†u khi n√∫t ƒë∆∞·ª£c ch·ªçn (Active) */
		.bottom-nav .nav-link.active {
		  color: var(--primary-color);
		  transform: translateY(-2px); /* Hi·ªáu ·ª©ng nh·∫©y l√™n nh·∫π */
		}

		.bottom-nav .nav-link small {
		  font-weight: 600 !important; 
		  font-size: 10px !important; /* Ch·ªØ nh·ªè l·∫°i ch√∫t ƒë·ªÉ v·ª´a kh√≠t 55px */
		  margin-top: 0;
		}

		/* --- CSS CHO TH√îNG B√ÅO & SWIPE --- */

		/* 1. Ch·∫•m ƒë·ªè th√¥ng b√°o (B·ªã thi·∫øu tr∆∞·ªõc ƒë√¢y) */
		.notification-dot {
		  width: 10px;
		  height: 10px;
		  background-color: #dc3545; /* M√†u ƒë·ªè */
		  border-radius: 50%;
		  display: inline-block;
		}

		/* 2. Container cho hi·ªáu ·ª©ng vu·ªët */
		.notification-swipe-wrapper {
		  position: relative;
		  overflow: hidden;
		  border-bottom: 1px solid #dee2e6;
		  background-color: #fff; /* ƒê·∫£m b·∫£o n·ªÅn wrapper l√† tr·∫Øng */
		}

		/* 3. Ph·∫ßn n·ªôi dung ch√≠nh (S·∫Ω tr∆∞·ª£t sang tr√°i) */
		.notification-content-box {
		  /* B√°o tr∆∞·ªõc cho tr√¨nh duy·ªát ƒë·ªÉ t·ªëi ∆∞u GPU */
		  will-change: transform;
		  /* Gi·ªØ nguy√™n c√°c thu·ªôc t√≠nh kh√°c */
		  transition: transform 0.2s ease-out;
		}
		/* M√†u n·ªÅn khi ch∆∞a ƒë·ªçc (C·∫≠p nh·∫≠t c·∫£ shadow ƒë·ªÉ che vi·ªÅn) */
		.notification-content-box.unread {
		  background-color: #e7f3ff;
		  box-shadow: -1px 0 0 0 #e7f3ff;
		}
		/* 4. Khu v·ª±c ch·ª©a 3 n√∫t thao t√°c (N·∫±m ch√¨m b√™n d∆∞·ªõi) */
		.notification-actions {
		  position: absolute;
		  top: 1px;
		  bottom: 1px;
		  right: 0;
		  display: flex;
		  z-index: 0;
		  opacity: 0;
		  transition: opacity 0.2s;
		}
		/* Class n√†y s·∫Ω ƒë∆∞·ª£c JS th√™m v√†o khi b·∫Øt ƒë·∫ßu ch·∫°m tay */
		.notification-actions.active {
		  opacity: 1;
		}
		/* Style chung cho c√°c n√∫t vu·ªët */
		.notif-action-btn {
		  width: 60px;
		  height: 100%;
		  border: none;
		  display: flex;
		  flex-direction: column;
		  align-items: center;
		  justify-content: center;
		  color: white;
		  font-size: 0.75rem;
		  cursor: pointer;
		}

		.notif-action-btn i {
		  font-size: 1.3rem !important;
		}

		.btn-mark-read {
		  background-color: #096f40;
		} /* Xanh l√°: ƒê√£ ƒë·ªçc */
		.btn-mark-unread {
		  background-color: #0768f5;
		} /* V√†ng: Ch∆∞a ƒë·ªçc */
		.btn-delete-swipe {
		  background-color: #ff1f34;
		} /* ƒê·ªè: X√≥a */

		/* C√°c popup nh·ªè ph·∫£i n·ªïi l√™n tr√™n modal ch√≠nh */
		.modal-popup-style {
		  z-index: var(--z-modal-popup);
		}
		/* Class chung cho c√°c Popup nh·ªè (Option, Confirm, Edit) */
		.modal-popup-style .modal-dialog {
		  display: flex;
		  align-items: center;
		  justify-content: center;
		  min-height: 100%;
		  margin: 0 auto;
		  width: 85%;
		  max-width: 350px;
		}

		.modal-popup-style .modal-content {
		  border-radius: 20px;
		  border: none;
		  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
		  overflow: hidden;
		}

		.modal-popup-style .list-group-item {
		  text-align: center;
		  padding: 1rem;
		  cursor: pointer;
		}

		/* Viewer ·∫£nh ƒë√® l√™n t·∫•t c·∫£ */
		.app-layout-modal {
		  z-index: var(--z-modal-layout);
		}
		/* End of optimized.css */

    </style>
    <style>@view-transition { navigation: auto; }</style>
  </head>
  <body class="h-100">
    <div id="app">
      <header class="app-header">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <h5 id="app-title" class="mb-0 fw-bold">Love Story</h5>
          </div>
          <div class="d-flex align-items-center gap-3">
            <button class="btn btn-link text-white p-0 position-relative" id="notification-btn" aria-label="M·ªü th√¥ng b√°o"> 
			<i class="bi bi-bell-fill fs-4"></i> 
			<span id="notification-badge" class="position-absolute badge rounded-pill bg-danger d-none" style="font-size: 0.65rem; top: -5px; right: -8px;">0</span> 
			</button> 
            <button class="btn btn-link text-white p-0" id="profile-btn" aria-label="Trang c√° nh√¢n">
              <div class="avatar-circle">
                <div id="header-avatar" class="w-100 h-100 d-flex align-items-center justify-content-center"><i class="bi bi-person-fill theme-text-primary fs-4"></i>
                </div>
              </div>
            </button>
          </div>
        </div>
      </header>
      <div id="edit-mode-banner" class="edit-mode-banner d-none">
        <div class="fw-bold">
          <i class="bi bi-pencil-fill me-2"></i>Ch·∫ø ƒë·ªô ch·ªânh s·ª≠a b·ªë c·ª•c
        </div>
        <small class="d-block mt-1">K√©o <i class="bi bi-arrows-move"></i> ƒë·ªÉ di chuy·ªÉn ‚Ä¢ Nh·∫•n <i class="bi bi-arrows-fullscreen"></i> ƒë·ªÉ ƒë·ªïi k√≠ch th∆∞·ªõc</small>
        <div class="mt-2"><button class="btn btn-light btn-sm" id="exit-edit-mode">Xong</button>
        </div>
      </div>
      <main class="main-content">
        <div id="ptr-element" class="ptr-element">
          <div class="ptr-content">
            <svg class="ptr-circle-svg" viewBox="0 0 30 30">
              <circle class="ptr-circle-bg" cx="15" cy="15" r="12"></circle>
              <circle id="ptr-progress-circle" class="ptr-circle-progress" cx="15" cy="15" r="12"></circle>
            </svg>
            <div id="ptr-text" class="small text-muted fw-bold mt-1" style="font-size: 10px;"> </div>
          </div>
        </div>
        <div id="tab-feed" class="tab-pane h-100 d-none">
          <div id="active-filter-bar" class="d-none fade-in">
            <span class="fw-bold theme-text-primary">
            <i class="bi bi-hash me-1"></i>Hashtag: <span id="current-filter-name">#tag</span>
            </span>
            <button class="btn btn-sm btn-outline-danger rounded-pill" onclick="clearHashtagFilter()">
            <i class="bi bi-x-lg"></i> B·ªè l·ªçc
            </button>
          </div>
          <div class="container pt-2 pb-5" id="posts-container">
          </div>
        </div>
        <div id="tab-home" class="tab-pane h-100">
          <div class="container pt-2 pb-5">
            <div id="stats-container" class="stats-container"></div>
          </div>
        </div>
        <div id="tab-search" class="tab-pane h-100 d-none">
		  <div class="container pt-3 pb-5">
			<div class="card shadow-sm border-0 mb-3">
			  <div class="card-body p-2 d-flex align-items-center">
				<i class="bi bi-search text-muted ms-2 fs-5"></i>
				<input type="text" id="smart-search-input" class="form-control border-0 shadow-none" placeholder="H·ªèi t√¥i v·ªÅ k·ª∑ ni·ªám...">
				<button class="btn btn-sm btn-light rounded-circle" id="clear-search" style="display:none;">
				  <i class="bi bi-x"></i>
				</button>
			  </div>
			</div>

			<div id="search-suggestions" class="d-flex gap-2 overflow-auto pb-2 mb-2 no-scrollbar">
			  <span class="badge bg-light text-dark border p-2 fw-normal cursor-pointer" onclick="triggerSearch('nhi·ªÅu like nh·∫•t')">‚ù§Ô∏è Nhi·ªÅu like nh·∫•t</span>
			  <span class="badge bg-light text-dark border p-2 fw-normal cursor-pointer" onclick="triggerSearch('sinh nh·∫≠t')">üéÇ Sinh nh·∫≠t</span>
			  <span class="badge bg-light text-dark border p-2 fw-normal cursor-pointer" onclick="triggerSearch('th·ªëng k√™')">üìä Th·ªëng k√™</span>
			</div>

			<div id="search-results-area">
			  <div class="text-center py-5 text-muted">
				 <i class="bi bi-robot theme-text-primary" style="font-size: 3rem;"></i>
				 <p class="mt-3">Nh·∫≠p t·ª´ kh√≥a ho·∫∑c c√¢u h·ªèi.<br>V√≠ d·ª•: "H√¥m nay ƒÉn g√¨", "Ng√†y k·ª∑ ni·ªám"...</p>
			  </div>
			</div>
		  </div>
		</div>
      </main>
      <button class="fab-btn d-none" id="fab-btn"> <i class="bi bi-plus-lg fs-4"></i> </button> 
      <nav class="bottom-nav">
		  <div class="d-flex justify-content-around py-1">
			<button class="nav-link border-0 bg-transparent d-flex flex-column align-items-center" data-tab="feed"> 
			  <i class="bi bi-globe2 fs-4"></i> <small class="fw-semibold">B·∫£ng tin</small> 
			</button> 
			<button class="nav-link border-0 bg-transparent d-flex flex-column align-items-center active" data-tab="home"> 
			  <i class="bi bi-house-fill fs-4"></i> <small class="fw-semibold">Home</small> 
			</button> 
			<button class="nav-link border-0 bg-transparent d-flex flex-column align-items-center" data-tab="search"> 
			  <i class="bi bi-search fs-4"></i> <small class="fw-semibold">T√¨m ki·∫øm</small> 
			</button>
		  </div>
		</nav>
      <div class="modal fade" id="notificationsModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title theme-text-primary fw-bold"><i class="bi bi-bell-fill me-2"></i>Th√¥ng b√°o</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
            </div>
            <div class="modal-body p-0">
              <div class="d-flex justify-content-between align-items-center p-3 border-bottom"><button class="btn btn-sm btn-outline-primary" id="mark-all-read"> <i class="bi bi-check-all me-1"></i>ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc </button> <button class="btn btn-sm btn-outline-danger" id="clear-all-notifications"> <i class="bi bi-trash me-1"></i>X√≥a t·∫•t c·∫£ </button>
              </div>
              <div id="notifications-list"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal fade app-layout-modal" id="createMemoryModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title theme-text-primary fw-bold">T·∫°o k·ª∑ ni·ªám</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3"><input type="text" class="form-control" id="memory-title" placeholder="Ti√™u ƒë·ªÅ k·ª∑ ni·ªám">
              </div>
              <div class="mb-3"><input type="date" class="form-control" id="memory-date">
              </div>
              <div class="mb-3"><textarea class="form-control" id="memory-content" rows="4" placeholder="K·ªÉ v·ªÅ k·ª∑ ni·ªám c·ªßa b·∫°n..."></textarea>
              </div>
              <div id="memory-image-preview-container" class="d-none mb-3">
                <div class="position-relative"><img id="memory-image-preview" class="w-100 rounded" style="max-height: 300px; object-fit: cover;" src="" alt="Preview"> <button class="btn btn-danger position-absolute top-0 end-0 m-2" id="remove-memory-image"> <i class="bi bi-x-lg"></i> </button>
                </div>
              </div>
              <div class="mb-3"><label class="btn btn-outline-primary w-100"> <i class="bi bi-image me-2"></i>Th√™m ·∫£nh <input type="file" id="memory-image-input" accept="image/*" class="d-none"> </label>
              </div>
              <button class="btn btn-primary w-100 py-3" id="create-memory-btn"> <i class="bi bi-save me-2"></i>L∆∞u k·ª∑ ni·ªám </button>
            </div>
          </div>
        </div>
      </div>
      <div class="modal fade" id="createAlbumModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title theme-text-primary fw-bold">T·∫°o album m·ªõi</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3"><input type="text" class="form-control" id="album-name" placeholder="T√™n album">
              </div>
              <button class="btn btn-primary w-100" id="create-album-btn"> <i class="bi bi-plus-circle me-2"></i>T·∫°o album </button>
            </div>
          </div>
        </div>
      </div>
      <div class="modal fade app-layout-modal" id="albumDetailModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title theme-text-primary fw-bold" id="album-detail-title">Album</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3"><label class="btn btn-outline-primary w-100"> <i class="bi bi-plus-circle me-2"></i>Th√™m ·∫£nh <input type="file" id="album-image-input" accept="image/*" class="d-none"> </label>
              </div>
              <div class="row g-2" id="album-photos">
                <div class="col-12 text-center py-5 text-muted">
                  <i class="bi bi-camera" style="font-size: 3rem;"></i>
                  <p class="mt-2">Ch∆∞a c√≥ ·∫£nh</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal fade app-layout-modal" id="commentModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title theme-text-primary fw-bold">B√¨nh lu·∫≠n</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body d-flex flex-column">
              <div class="flex-grow-1 overflow-auto mb-3" id="comments-list">
                <p class="text-center text-muted py-5">Ch∆∞a c√≥ b√¨nh lu·∫≠n</p>
              </div>
              <div class="input-group"><input type="text" class="form-control" id="comment-input" placeholder="Vi·∫øt b√¨nh lu·∫≠n..."> <button class="btn btn-primary" id="send-comment"> <i class="bi bi-send"></i> </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal fade app-layout-modal" id="profileModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title theme-text-primary fw-bold">H·ªì s∆° c√° nh√¢n</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="text-center mb-4">
                <div class="avatar-circle avatar-circle-lg mx-auto mb-3" style="border: 1.5px solid var(--primary-color);">
                  <div id="profile-avatar" class="w-100 h-100 d-flex align-items-center justify-content-center"><i class="bi bi-person-fill theme-text-primary" style="font-size: 3rem;"></i>
                  </div>
                </div>
                <label class="btn btn-sm btn-outline-primary"> <i class="bi bi-camera me-1"></i> ƒê·ªïi ·∫£nh ƒë·∫°i di·ªán <input type="file" id="avatar-input" accept="image/*" class="d-none"> </label>
              </div>
              <div class="mb-3"><label class="form-label fw-semibold"> <i class="bi bi-person me-2"></i>T√™n ng∆∞·ªùi d√πng </label> <input type="text" class="form-control" id="profile-username" placeholder="username">
              </div>
              <div class="mb-4"><label class="form-label fw-semibold"> <i class="bi bi-card-text me-2"></i>T√™n hi·ªÉn th·ªã </label> <input type="text" class="form-control" id="profile-fullname" placeholder="T√™n c·ªßa b·∫°n">
              </div>
              <div class="border-top pt-4">
                <h6 class="fw-bold theme-text-primary mb-3"><i class="bi bi-gear me-2"></i>C√†i ƒë·∫∑t</h6>
                <div class="card mb-3">
                  <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                      <div class="icon-box icon-box-sm theme-bg-primary text-white me-3"><i class="bi bi-palette-fill"></i>
                      </div>
                      <div>
                        <h6 class="mb-0 fw-bold">Giao di·ªán</h6>
                        <small class="text-muted">Ch·ªçn m√†u s·∫Øc cho ·ª©ng d·ª•ng</small>
                      </div>
                    </div>
                    <div class="d-flex gap-2 justify-content-between">
                      <div class="theme-option flex-fill" data-theme="green" style="background: linear-gradient(135deg, #006B68 0%, #FFC62F 100%);"></div>
                      <div class="theme-option flex-fill" data-theme="purple" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
                      <div class="theme-option flex-fill" data-theme="blue" style="background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);"></div>
                      <div class="theme-option flex-fill" data-theme="red" style="background: linear-gradient(135deg, #dc2626 0%, #fb923c 100%);"></div>
                    </div>
                  </div>
                </div>
                <div class="card mb-3">
                  <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                      <div class="icon-box icon-box-sm text-white me-3" style="background: #6f42c1;"><i class="bi bi-grid-3x3"></i>
                      </div>
                      <div>
                        <h6 class="mb-0 fw-bold">Ch·ªânh s·ª≠a b·ªë c·ª•c</h6>
                        <small class="text-muted">S·∫Øp x·∫øp v√† thay ƒë·ªïi k√≠ch th∆∞·ªõc kh·ªëi d·ªØ li·ªáu</small>
                      </div>
                    </div>
                    <button class="btn btn-outline-primary w-100" id="enter-layout-edit"> <i class="bi bi-pencil-square me-2"></i>Ch·ªânh s·ª≠a b·ªë c·ª•c </button>
                  </div>
                </div>
              </div>
              <button class="btn btn-primary w-100 py-3 mt-3" id="save-profile"> <i class="bi bi-check-circle me-2"></i>L∆∞u thay ƒë·ªïi </button>
            </div>
          </div>
        </div>
      </div>
      <div class="modal fade modal-popup-style" id="postOptionsModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="list-group list-group-flush"><button class="list-group-item list-group-item-action" id="edit-post-option"> <i class="bi bi-pencil theme-text-primary me-2"></i> <span class="fw-semibold">Ch·ªânh s·ª≠a b√†i vi·∫øt</span> </button> <button class="list-group-item list-group-item-action text-danger" id="delete-post-option"> <i class="bi bi-trash me-2"></i> <span class="fw-semibold">X√≥a b√†i vi·∫øt</span> </button> <button class="list-group-item list-group-item-action" data-bs-dismiss="modal"> H·ªßy </button>
            </div>
          </div>
        </div>
      </div>
      <div class="modal fade modal-popup-style" id="deleteConfirmModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content text-center p-3">
            <div class="modal-body">
              <i class="bi bi-trash text-danger" style="font-size: 2rem;"></i>
              <p>X√°c nh·∫≠n x√≥a?</p>
              <div class="d-flex gap-2"><button class="btn btn-secondary flex-fill" data-bs-dismiss="modal">H·ªßy</button> <button class="btn btn-danger flex-fill" id="confirm-delete">X√≥a</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal fade app-layout-modal" id="bikeStatsModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title theme-text-primary fw-bold"><i class="bi bi-bar-chart-fill me-2"></i>Th·ªëng k√™ l∆∞·ª£t ƒë·∫°p</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="row g-3 mb-4">
                <div class="col-4">
                  <div class="card text-center p-3">
                    <i class="bi bi-calendar-day theme-text-primary fs-3"></i>
                    <p class="small text-muted mb-1 mt-2">H√¥m nay</p>
                    <p id="stats-today" class="fs-4 fw-bold theme-text-primary mb-0">0</p>
                  </div>
                </div>
                <div class="col-4">
                  <div class="card text-center p-3">
                    <i class="bi bi-calendar-week text-success fs-3"></i>
                    <p class="small text-muted mb-1 mt-2">Tu·∫ßn n√†y</p>
                    <p id="stats-week" class="fs-4 fw-bold text-success mb-0">0</p>
                  </div>
                </div>
                <div class="col-4">
                  <div class="card text-center p-3">
                    <i class="bi bi-calendar-month text-warning fs-3"></i>
                    <p class="small text-muted mb-1 mt-2">Th√°ng n√†y</p>
                    <p id="stats-month" class="fs-4 fw-bold text-warning mb-0">0</p>
                  </div>
                </div>
              </div>
              <!--div class="card p-3 mb-3">
                <h6 class="fw-bold mb-3">Bi·ªÉu ƒë·ªì</h6>
                <div id="bike-chart" style="height: 250px;"></div>
                  </div---->
              <div class="p-3 bg-white mb-2">
                <h6 class="fw-bold mb-3 small text-muted text-uppercase">Bi·ªÉu ƒë·ªì</h6>
                <div style="overflow-x: auto; overflow-y: hidden; white-space: nowrap; -webkit-overflow-scrolling: touch;">
                  <div id="bike-chart" style="height: 200px; min-width: 100%;">
                    <div class="d-flex align-items-center justify-content-center h-100 text-muted small">
                      ƒêang t·∫£i bi·ªÉu ƒë·ªì...
                    </div>
                  </div>
                </div>
                <div class="text-center small text-muted mt-1">L∆∞·ªõt sang ngang ƒë·ªÉ xem th√™m &larr; &rarr;</div>
              </div>
              <div class="card p-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h6 class="fw-bold mb-0">L·ªãch s·ª≠</h6>
                  <button class="btn btn-sm btn-outline-primary" id="add-bike-entry"> <i class="bi bi-plus-circle me-1"></i>Th√™m </button>
                </div>
                <div id="bike-history-list"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal fade modal-popup-style" id="addBikeEntryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title fw-bold theme-text-primary">Th√™m l∆∞·ª£t ƒë·∫°p</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label fw-bold">Ch·ªçn Ng√†y</label>
                <input type="date" id="manual-bike-date" class="form-control form-control-lg">
              </div>
              <div class="mb-3">
                <label class="form-label fw-bold">Ch·ªçn Gi·ªù</label>
                <input type="time" id="manual-bike-time" class="form-control form-control-lg">
              </div>
              <div class="text-center text-muted small">
                L∆∞·ª£t ƒë·∫°p s·∫Ω ƒë∆∞·ª£c l∆∞u v√†o l·ªãch s·ª≠ v·ªõi th·ªùi gian b·∫°n ch·ªçn.
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
              <button type="button" class="btn btn-primary theme-bg-primary border-0" onclick="saveManualBikeEntry()">L∆∞u</button>
            </div>
          </div>
        </div>
      </div>
      <div class="modal fade app-layout-modal" id="goldStatsModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title theme-text-primary fw-bold"><i class="bi bi-bar-chart-fill me-2"></i>Th·ªëng k√™ gi√° v√†ng</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="row g-3 mb-4">
                <div class="col-6">
                  <div class="card text-center p-3">
                    <i class="bi bi-arrow-up-circle text-success fs-3"></i>
                    <p class="small text-muted mb-1 mt-2">Cao nh·∫•t</p>
                    <p id="gold-highest-price" class="fs-5 fw-bold text-success mb-0">-</p>
                    <small id="gold-highest-date" class="text-muted">-</small>
                  </div>
                </div>
                <div class="col-6">
                  <div class="card text-center p-3">
                    <i class="bi bi-arrow-down-circle text-danger fs-3"></i>
                    <p class="small text-muted mb-1 mt-2">Th·∫•p nh·∫•t</p>
                    <p id="gold-lowest-price" class="fs-5 fw-bold text-danger mb-0">-</p>
                    <small id="gold-lowest-date" class="text-muted">-</small>
                  </div>
                </div>
              </div>
              <div class="card p-3 mb-3">
                <h6 class="fw-bold mb-3">Bi·ªÉu ƒë·ªì</h6>
                <div id="gold-chart" style="height: 250px;"></div>
              </div>
              <div class="card p-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h6 class="fw-bold mb-0">L·ªãch s·ª≠</h6>
                  <button class="btn btn-sm btn-outline-primary" id="add-gold-entry"> <i class="bi bi-plus-circle me-1"></i>Th√™m </button>
                </div>
                <div id="gold-history-list"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal fade" id="addGoldEntryModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content border-0 shadow">
            <div class="modal-header border-bottom-0 pb-0">
              <h5 class="modal-title theme-text-primary fw-bold">
                <i class="bi bi-plus-lg me-2"></i>Th√™m Giao D·ªãch
              </h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body pt-3">
              <div class="row g-3">
                <div class="col-6">
                  <label class="form-label fw-bold small text-muted">Ng√†y Giao D·ªãch</label>
                  <input type="date" class="form-control" id="gold-trans-date">
                </div>
                <div class="col-6">
                  <label class="form-label fw-bold small text-muted">Lo·∫°i Giao D·ªãch</label>
                  <select class="form-select" id="gold-trans-type">
                    <option value="buy">Mua (Buy)</option>
                    <option value="sell">B√°n (Sell)</option>
                  </select>
                </div>
                <div class="col-6">
                  <label class="form-label fw-bold small text-muted">S·ªë l∆∞·ª£ng (ch·ªâ)</label>
                  <input type="number" class="form-control" id="gold-trans-qty" placeholder="0" step="0.1">
                </div>
                <div class="col-6">
                  <label class="form-label fw-bold small text-muted">Gi√° (VND/ch·ªâ)</label>
                  <input type="number" class="form-control" id="gold-trans-price" placeholder="0" step="1000">
                </div>
                <div class="col-12">
                  <label class="form-label fw-bold small text-muted">Ghi ch√∫</label>
                  <textarea class="form-control" id="gold-trans-note" rows="2" placeholder="Ghi ch√∫ giao d·ªãch..."></textarea>
                </div>
              </div>
              <button class="btn btn-primary w-100 mt-4 py-2 fw-bold" id="save-gold-transaction">
              L∆∞u Giao D·ªãch
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999;">
        <div id="loadingToast" class="toast" role="alert">
          <div class="toast-body d-flex align-items-center">
            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
            ƒêang x·ª≠ l√Ω...
          </div>
        </div>
      </div>
      <div class="position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 9999;">
        <div id="successToast" class="toast" role="alert">
          <div class="toast-body bg-success text-white rounded"><i class="bi bi-check-circle me-2"></i> <span id="toast-message">Th√†nh c√¥ng!</span>
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="createPostModal" tabindex="-1">
      <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title theme-text-primary fw-bold">T·∫°o b√†i vi·∫øt</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3"><textarea class="form-control" id="post-input" rows="4" placeholder="B·∫°n ƒëang nghƒ© g√¨?"></textarea>
            </div>
            <div id="image-preview-container" class="d-none mb-3">
              <div class="d-flex justify-content-between align-items-center mb-2"><span class="text-muted"><span id="image-count">0</span> ·∫£nh</span> <button class="btn btn-sm btn-outline-danger" id="clear-all-images"> <i class="bi bi-trash"></i> X√≥a t·∫•t c·∫£ </button>
              </div>
              <div id="images-preview-grid" class="mt-2"></div>
            </div>
            <div id="image-options" class="d-none mb-2 d-flex justify-content-end border-bottom pb-2">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="hd-quality-switch" checked>
                <label class="form-check-label small fw-semibold" for="hd-quality-switch">Ch·∫•t l∆∞·ª£ng HD</label>
              </div>
            </div>
            <div id="layout-selector" class="d-none mb-3 fade-in">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <p class="form-label fw-bold small text-muted text-uppercase mb-0">
                  <i class="bi bi-grid-1x2 me-1"></i>Ch·ªçn b·ªë c·ª•c
                </p>
                <span class="badge bg-light text-secondary border">T·ª± ƒë·ªông ƒë·ªÅ xu·∫•t</span>
              </div>
              <div class="row g-2">
                <div class="col-4">
                  <div class="layout-preview-box p-2 text-center" data-layout="grid-2x2">
                    <div class="layout-grid-visual visual-2x2">
                      <div></div>
                      <div></div>
                      <div></div>
                      <div></div>
                    </div>
                  </div>
                </div>
                <div class="col-4">
                  <div class="layout-preview-box p-2 text-center" data-layout="1-wide">
                    <div class="layout-grid-visual visual-1-wide">
                      <div></div>
                      <div></div>
                      <div></div>
                    </div>
                  </div>
                </div>
                <div class="col-4">
                  <div class="layout-preview-box p-2 text-center" data-layout="1-tall">
                    <div class="layout-grid-visual visual-1-tall">
                      <div></div>
                      <div></div>
                      <div></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="mb-3"><label class="btn btn-outline-primary w-100"> <i class="bi bi-image me-2"></i>Th√™m ·∫£nh <input type="file" id="image-input" accept="image/*" multiple class="d-none"> </label>
            </div>
            <button class="btn btn-primary w-100 py-3" id="post-btn" onclick="handlePostSubmit()" disabled> 
            <i class="bi bi-send me-2"></i>ƒêƒÉng b√†i 
            </button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="imageViewerModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-fullscreen">
        <div class="modal-content" style="background-color: black;">
          <div class="modal-header border-0 position-fixed w-100 p-3" style="z-index: 1060; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); top: 0;">
            <button type="button" class="btn btn-link text-white p-0" data-bs-dismiss="modal">
            <i class="bi bi-arrow-left fs-3"></i> </button>
            <span class="text-white ms-3 fw-bold" id="viewer-counter">·∫¢nh chi ti·∫øt</span> 
          </div>
          <div class="modal-body p-0 overflow-auto d-flex flex-column align-items-center" id="full-image-list" ...>
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="commentOptionsModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="list-group list-group-flush">
            <button class="list-group-item list-group-item-action" id="edit-comment-btn">
            <i class="bi bi-pencil theme-text-primary me-2"></i>Ch·ªânh s·ª≠a b√¨nh lu·∫≠n
            </button>
            <button class="list-group-item list-group-item-action text-danger" id="delete-comment-btn">
            <i class="bi bi-trash me-2"></i>X√≥a b√¨nh lu·∫≠n
            </button>
            <button class="list-group-item list-group-item-action" data-bs-dismiss="modal">H·ªßy</button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="editCommentContentModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title fw-bold">S·ª≠a b√¨nh lu·∫≠n</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="text" id="edit-comment-input" class="form-control" placeholder="Nh·∫≠p n·ªôi dung m·ªõi...">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
            <button type="button" class="btn btn-primary" id="save-edit-comment">L∆∞u</button>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // --- C·∫§U H√åNH K·∫æT N·ªêI ---
      const API_URL = 'https://script.google.com/macros/s/AKfycby39A6IHy2JD711g_6hmdj85u_en-gi3_tVMvSAdfnebEq1HkYP-105NeQVarKQJ7HSUQ/exec';
      
      let userFingerprint = null;
      
      // --- C√ÅC H√ÄM TI·ªÜN √çCH (ƒê·∫∂T L√äN ƒê·∫¶U) ---
      
      // 5. Qu·∫£n l√Ω LocalStorage
      const STORAGE_KEY = 'social_memory_profile';
      
      function saveLocalData(data) {
         localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      }
      
      function getLocalData() {
         const data = localStorage.getItem(STORAGE_KEY);
         return data ? JSON.parse(data) : null;
      }
      
      // 1. T·∫°o Fingerprint (ƒê·ªãnh danh thi·∫øt b·ªã)
      async function getBrowserFingerprint() {
         const str = navigator.userAgent + navigator.language + screen.width + 'x' + screen.height;
         const msgBuffer = new TextEncoder().encode(str);
         const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
         return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
      }
      
      // 2. N√©n ·∫£nh (<20KB ƒë·ªÉ l∆∞u Sheet)
      function compressImageTo20KB(file) {
         return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
               const img = new Image();
               img.src = e.target.result;
               img.onload = () => {
                  const canvas = document.createElement('canvas');
                  let w = img.width,
                     h = img.height;
                  const MAX = 600; // Resize nh·ªè l·∫°i tr∆∞·ªõc
                  if (w > h && w > MAX) {
                     h *= MAX / w;
                     w = MAX;
                  } else if (h > MAX) {
                     w *= MAX / h;
                     h = MAX;
                  }
      
                  canvas.width = w;
                  canvas.height = h;
                  const ctx = canvas.getContext('2d');
                  ctx.drawImage(img, 0, 0, w, h);
      
                  let quality = 0.8;
                  let dataUrl = canvas.toDataURL('image/jpeg', quality);
                  while (dataUrl.length > 20000 && quality > 0.1) { // Gi·ªõi h·∫°n 20KB
                     quality -= 0.1;
                     dataUrl = canvas.toDataURL('image/jpeg', quality);
                  }
                  resolve(dataUrl);
               }
            }
         });
      }
      
      // 3. H√†m g·ª≠i d·ªØ li·ªáu chung (Router Client) 
      async function sendToServer(payload) {
         try {
            const res = await fetch(API_URL, {
               method: 'POST',
               // TH√äM D√íNG N√ÄY: Gi√∫p b·ªè qua b∆∞·ªõc ki·ªÉm duy·ªát CORS ph·ª©c t·∫°p c·ªßa Google
               headers: {
                  "Content-Type": "text/plain;charset=utf-8",
               },
               body: JSON.stringify(payload)
            });
            return await res.json();
         } catch (e) {
            console.error("L·ªói API:", e);
            return {
               status: 'error',
               message: e.message
            };
         }
      }
      
      // 4. H√†m sinh t√™n ng·∫´u nhi√™n
      function generateIdentity() {
         const animal = randomAnimals[Math.floor(Math.random() * randomAnimals.length)];
         const color = randomColors[Math.floor(Math.random() * randomColors.length)];
         const fullname = `${animal} ${color}`;
         // T·∫°o username kh√¥ng d·∫•u: G·∫•u ƒê·ªè -> gaudo123
         const username = fullname.normalize("NFD").replace(/[\u0300-\u036f]/g, "")
            .replace(/\s/g, '').toLowerCase() + Math.floor(Math.random() * 999);
         return {
            fullname,
            username
         };
      }
      
      // --- D·ªÆ LI·ªÜU RANDOM ---
      const randomAnimals = ['G·∫•u', 'H·ªï', 'S∆∞ T·ª≠', 'Voi', 'H∆∞∆°u', 'C√°', 'V·∫πt', 'M√®o', 'Ch√≥', 'R√πa', 'Kh·ªâ', 'Th·ªè', 'S√≥i', 'C√°o', 'Heo', 'B√≤', 'G√†', 'V·ªãt', 'C√∫', 'D√™', 'C·ª´u', 'Ki·∫øn', 'T√©p', 'T√¥m'];
      const randomColors = ['Xanh', 'ƒê·ªè', 'T√≠m', 'V√†ng', 'Cam', 'H·ªìng', 'ƒêen', 'Tr·∫Øng'];
      
      const defaultConfig = {
         app_title: 'Love Story',
         welcome_message: 'L∆∞u gi·ªØ k·ª∑ ni·ªám ƒë·∫πp'
      };
      
      const themes = {
         green: {
            primary: '#006B68',
            secondary: '#FFC62F',
            text: '#212529',
            bg: '#f8f9fa',
            surface: '#ffffff'
         },
         purple: {
            primary: '#667eea',
            secondary: '#764ba2',
            text: '#1f2937',
            bg: '#f8f9fa',
            surface: '#ffffff'
         },
         blue: {
            primary: '#1e3a8a',
            secondary: '#3b82f6',
            text: '#000000',
            bg: '#f0f9ff',
            surface: '#ffffff'
         },
         red: {
            primary: '#dc2626',
            secondary: '#fb923c',
            text: '#000000',
            bg: '#fef2f2',
            surface: '#ffffff'
         }
      };
      
      const defaultStatsLayout = [{
            id: 'bike',
            column: 0,
            size: 'medium'
         },
         {
            id: 'days',
            column: 0,
            size: 'medium'
         },
         {
            id: 'memory',
            column: 0,
            size: 'medium'
         },
         {
            id: 'event',
            column: 0,
            size: 'medium'
         },
         {
            id: 'gold',
            column: 0,
            size: 'medium'
         }
      ];
      
      let allData = [];
      let currentProfile = null;
      let currentTab = 'home';
      let currentAlbumId = null;
      let currentPostId = null;
      let pendingDeleteId = null;
      let pendingDeleteType = null;
      let currentImages = []; // B√¢y gi·ªù m·∫£ng n√†y s·∫Ω ch·ª©a File Object (nh·∫π), kh√¥ng ch·ª©a Base64 (n·∫∑ng)
      let currentImagePreviews = []; // M·∫£ng n√†y ch·ª©a Base64 nh·ªè x√≠u ch·ªâ ƒë·ªÉ hi·ªÉn th·ªã Preview cho ƒë·∫πp
      let memoryImageData = null;
      let recordCount = 0;
      let currentTheme = 'green';
      let selectedLayout = 'grid-2x2';
      let isEditMode = false;
      let statsLayout = [...defaultStatsLayout];
      let draggedElement = null;
      let draggedId = null;
      
      let serverFeedData = []; // Bi·∫øn ch·ª©a d·ªØ li·ªáu t·∫£i t·ª´ sheet feed
      
      let loadingToast, successToast;
      let createPostModal, createMemoryModal, createAlbumModal, albumDetailModal, commentModal, profileModal, postOptionsModal, deleteConfirmModal, bikeStatsModal, addBikeEntryModal, goldStatsModal, addGoldEntryModal, notificationsModal;
      
      let isEditingPost = false;
      let currentEditPostId = null;
      
      // --- BI·∫æN QU·∫¢N L√ù PH√ÇN TRANG HISTORY ---
      let bikeHistoryPage = 1;
      let bikeHistoryLoading = false;
      let bikeHistoryHasMore = true;
      
      // --- BI·∫æN QU·∫¢N L√ù PH√ÇN TRANG FEED ---
      let feedPage = 1;
      let feedLoading = false;
      let feedHasMore = true;
      // --- HASHTAG LOGIC START ---
      
      let currentHashFilter = null; // <--- X√ìA D√íNG N√ÄY ·ªû ƒê√ÇY
      // --- BI·∫æN QU·∫¢N L√ù PH√ÇN TRANG notifPage ---
      let notifPage = 1;
      let notifLoading = false;
      let notifHasMore = true;
      let serverNotifications = []; // Cache d·ªØ li·ªáu
      // [M·ªöI] Th·ªùi ƒëi·ªÉm cu·ªëi c√πng ng∆∞·ªùi d√πng th·ª±c hi·ªán thao t√°c ghi
      let pendingTasksCount = 0;
      let lastUserActionTime = 0;
      
      let isEditingGold = false; // ƒêang ·ªü ch·∫ø ƒë·ªô s·ª≠a hay th√™m?
      let currentEditGoldId = null; // ID c·ªßa giao d·ªãch ƒëang s·ª≠a
      // Th√™m d√≤ng n√†y v√†o danh s√°ch bi·∫øn global (c√πng ch·ªó v·ªõi createPostModal...)
      let imageViewerModal;
      
      // Bi·∫øn to√†n c·ª•c l∆∞u d·ªØ li·ªáu v√†ng
      let goldMarketData = [];
      let goldPortfolioData = [];
      // --- BI·∫æN TO√ÄN C·ª§C M·ªöI CHO COMMENT ---
      let currentCommentId = null;
      let currentCommentContent = '';
      let commentOptionsModal = new bootstrap.Modal(document.getElementById('commentOptionsModal'));
      let editCommentContentModal = new bootstrap.Modal(document.getElementById('editCommentContentModal'));
       
      // Trong h√†m initApp ho·∫∑c (async () => { ... })();
      // Th√™m d√≤ng n√†y v√†o ph·∫ßn kh·ªüi t·∫°o:
      imageViewerModal = new bootstrap.Modal(document.getElementById('imageViewerModal'));
      // --- BI·∫æN QU·∫¢N L√ù TI·∫æN TR√åNH UPLOAD ---
      // --- LOGIC X·ª¨ L√ù VU·ªêT (SWIPE) & CLICK TH√îNG MINH ---
	let touchStartX = 0;
	let currentSwipedId = null; 
		let isSwiping = false; // Bi·∫øn c·ªù ƒë·ªÉ ch·∫∑n click nh·∫ßm khi ƒëang vu·ªët
	// --- LOGIC X·ª¨ L√ù VU·ªêT (SWIPE) & CLICK TH√îNG MINH (ƒê√É FIX L·ªñI CU·ªòN TRANG) ---
	let touchStartY = 0; // [M·ªöI] Th√™m bi·∫øn l∆∞u t·ªça ƒë·ªô Y
	let isScrolling = false; // [M·ªöI] Bi·∫øn c·ªù x√°c ƒë·ªãnh ƒëang cu·ªôn trang
	// --- BI·∫æN QU·∫¢N L√ù PH√ÇN TRANG FEED ---
  
	// [M·ªöI] Observer to√†n c·ª•c d√πng chung
	const globalScrollObserver = new IntersectionObserver((entries) => {
		entries.forEach(entry => {
			if (entry.isIntersecting) {
				// L·∫•y h√†m callback t·ª´ thu·ªôc t√≠nh c·ªßa ph·∫ßn t·ª≠
				const callback = entry.target._onIntersect;
				if (typeof callback === 'function') {
					callback();
				}
			}
		});
	}, { threshold: 0.1 });
      // L·∫Øng nghe s·ª± ki·ªán t·∫Øt tr√¨nh duy·ªát/tab
      window.addEventListener('beforeunload', (e) => {
         if (pendingTasksCount > 0) {
            // K√≠ch ho·∫°t c·∫£nh b√°o m·∫∑c ƒë·ªãnh c·ªßa tr√¨nh duy·ªát
            e.preventDefault();
            e.returnValue = 'D·ªØ li·ªáu ƒëang ƒë∆∞·ª£c g·ª≠i l√™n m√°y ch·ªß. B·∫°n c√≥ ch·∫Øc mu·ªën r·ªùi ƒëi?';
            return 'D·ªØ li·ªáu ƒëang ƒë∆∞·ª£c g·ª≠i l√™n m√°y ch·ªß. B·∫°n c√≥ ch·∫Øc mu·ªën r·ªùi ƒëi?';
         }
      });
      
      function applyTheme(themeName) {
         const theme = themes[themeName];
         if (!theme) return;
      
         document.documentElement.style.setProperty('--primary-color', theme.primary);
         document.documentElement.style.setProperty('--secondary-color', theme.secondary);
         document.documentElement.style.setProperty('--text-color', theme.text);
         document.documentElement.style.setProperty('--bg-color', theme.bg);
         document.documentElement.style.setProperty('--surface-color', theme.surface);
      
         document.querySelectorAll('.theme-option').forEach(opt => opt.classList.remove('selected'));
         const selected = document.querySelector(`[data-theme="${themeName}"]`);
         if (selected) selected.classList.add('selected');
      
         currentTheme = themeName;
      }
      
      if (window.elementSdk) {
         window.elementSdk.init({
            defaultConfig,
            onConfigChange: async (config) => {
               //document.getElementById('app-title').textContent = config.app_title || defaultConfig.app_title;
               document.getElementById('welcome-message').textContent = config.welcome_message || defaultConfig.welcome_message;
            },
            mapToCapabilities: () => ({
               recolorables: [],
               borderables: [],
               fontEditable: undefined,
               fontSizeable: undefined
            }),
            mapToEditPanelValues: (config) => new Map([
               ['app_title', config.app_title || defaultConfig.app_title],
               ['welcome_message', config.welcome_message || defaultConfig.welcome_message]
            ])
         });
      }
      
      // Th√™m v√†o v√πng Utils ho·∫∑c ƒë·∫ßu script
      const formatCurrency = (value) => {
         return new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND'
         }).format(value);
      };
      
      const formatPNL = (value) => {
         if (value > 0) return `<span class="text-success">+${formatCurrency(value)}</span>`;
         if (value < 0) return `<span class="text-danger">${formatCurrency(value)}</span>`;
         return `<span class="text-muted">${formatCurrency(value)}</span>`;
      };
      
      const dataHandler = {
         onDataChanged(data) {
            allData = data;
            recordCount = data.length;
      
            currentProfile = data.find(d => d.type === 'profile');
            if (currentProfile) {
               if (currentProfile.themeName) applyTheme(currentProfile.themeName);
               if (currentProfile.statsLayout) {
                  try {
                     statsLayout = JSON.parse(currentProfile.statsLayout);
                  } catch {
                     statsLayout = [...defaultStatsLayout];
                  }
               }
            }
      
            updateAvatarDisplays();
            updateNotificationBadge();
      
            if (currentTab === 'feed') renderPosts();
            else if (currentTab === 'home') {
               renderStats();
               updateStats();
            } else if (currentTab === 'albums') renderAlbums();
      
            if (currentAlbumId && albumDetailModal && albumDetailModal._isShown) renderAlbumPhotos();
         }
      };
	  
	  function manageCacheSize() {
			let total = 0;
			for (let x in localStorage) {
				if(localStorage.hasOwnProperty(x)) {
					// T√≠nh dung l∆∞·ª£ng (kho·∫£ng x2 v√¨ UTF-16)
					total += ((localStorage[x].length * 2) / 1024 / 1024); 
				}
			}
			console.log(`Dung l∆∞·ª£ng LocalStorage ƒëang d√πng: ${total.toFixed(2)} MB`);

			// N·∫øu d√πng qu√° 4.5MB (g·∫ßn m·ª©c gi·ªõi h·∫°n 5MB), h√£y x√≥a b·ªõt
			if (total > 4.5) {
				console.warn("B·ªô nh·ªõ ƒë·∫ßy, ƒëang d·ªçn d·∫πp...");
				localStorage.removeItem('cached_feed_data'); // X√≥a feed c≈© v√¨ n√≥ n·∫∑ng nh·∫•t
				localStorage.removeItem('cached_notifications'); // X√≥a th√¥ng b√°o c≈©
				// Gi·ªØ l·∫°i Profile v√† BabyRun v√¨ n√≥ quan tr·ªçng v√† nh·∫π
			}
		}
      
      // --- KH·ªûI T·∫†O ·ª®NG D·ª§NG ---_-----------------------------------------------------------------------------------------------------------
      
      // H√†m 1: ƒê·ªìng b·ªô Profile (X·ª≠ l√Ω ƒë·ªãnh danh)
      // H√†m 1: ƒê·ªìng b·ªô Profile (X·ª≠ l√Ω ƒë·ªãnh danh - T·ªêI ∆ØU UX)
      async function syncUserProfile() {
         try {
            // 1. L·∫§Y FINGERPRINT HI·ªÜN T·∫†I
            userFingerprint = await getBrowserFingerprint();
            console.log("Device Fingerprint:", userFingerprint);
      
            // 2. [QUAN TR·ªåNG] LOAD T·ª™ LOCAL STORAGE TR∆Ø·ªöC (HI·ªÜN NGAY L·∫¨P T·ª®C)
            const localData = getLocalData();
            if (localData) {
               console.log("Loaded from Cache:", localData);
               currentProfile = localData;
               applyTheme(currentProfile.themeName);
               updateAvatarDisplays();
            }
      
            // 3. G·ªåI SERVER KI·ªÇM TRA (BACKGROUND SYNC)
            // Ki·ªÉm tra xem Fingerprint n√†y ƒë√£ g·∫Øn v·ªõi User n√†o ch∆∞a
            const res = await sendToServer({
               action: 'get_profile',
               fingerprint: userFingerprint
            });
      
            if (res && res.status === 'success' && res.data) {
               // A. SERVER C√ì D·ªÆ LI·ªÜU
               console.log("Server synced:", res.data);
      
               // So s√°nh xem d·ªØ li·ªáu Server c√≥ kh√°c Local kh√¥ng
               // N·∫øu kh√°c (ho·∫∑c Local ch∆∞a c√≥) th√¨ c·∫≠p nh·∫≠t l·∫°i
               if (!localData || localData.username !== res.data.username || localData.avatarData !== res.data.avaurl) {
                  currentProfile = {
                     username: res.data.username,
                     fullName: res.data.fullname,
                     avatarData: res.data.avaurl,
                     themeName: res.data.theme
                  };
                  saveLocalData(currentProfile); // L∆∞u ƒë√® Local
                  applyTheme(currentProfile.themeName);
                  updateAvatarDisplays();
                  showToast(`ƒê·ªìng b·ªô th√†nh c√¥ng: ${res.data.fullname}`);
               }
      
            } else if (!localData) {
               // B. M√ÅY M·ªöI TINH & SERVER KH√îNG BI·∫æT L√Ä AI
               // T·∫°o t·∫°m ƒë·ªãnh danh kh√°ch
               console.log("New Device -> Generated Guest Identity");
               const identity = generateIdentity();
               currentProfile = {
                  username: identity.username,
                  fullName: identity.fullname,
                  avatarData: '',
                  themeName: 'green'
               };
               // Kh√¥ng l∆∞u Server v·ªôi, ch·ªâ l∆∞u Local ƒë·ªÉ d√πng t·∫°m
               saveLocalData(currentProfile);
               applyTheme(currentProfile.themeName);
               updateAvatarDisplays();
            }
         } catch (err) {
            console.error("L·ªói sync profile:", err);
            // N·∫øu l·ªói m·∫°ng, App v·∫´n ch·∫°y t·ªët nh·ªù d·ªØ li·ªáu Local ƒë√£ load ·ªü b∆∞·ªõc 2
         }
      }
      
      // H√†m 2: ƒê·ªìng b·ªô Baby Run (X·ª≠ l√Ω s·ªë li·ªáu)
      // H√†m 2: ƒê·ªìng b·ªô Baby Run & Gi√° V√†ng cho Home
      async function syncBabyRunStats() {
         try {
            const now = new Date();
            const dateStr = `${String(now.getDate()).padStart(2, '0')}/${String(now.getMonth() + 1).padStart(2, '0')}/${now.getFullYear()}`;
      
            // G·ªçi API l·∫•y s·ªë li·ªáu Home
            const res = await sendToServer({
               action: 'get_babyrun_count',
               date: dateStr
            });
      
            if (res && (res.status === 'success' || res.result === 'success')) {
               // 1. C·∫≠p nh·∫≠t L∆∞·ª£t ƒë·∫°p
               console.log("Stats loaded:", res);
               const bikeCountEl = document.getElementById('bike-count');
               if (bikeCountEl) {
                  bikeCountEl.textContent = res.count;
                  localStorage.setItem('cached_babyrun_count', res.count);
               }
      
               // 2. [M·ªöI] C·∫≠p nh·∫≠t Gi√° V√†ng
               if (res.gold) {
                  const goldBuyEl = document.getElementById('gold-buy');
                  const goldSellEl = document.getElementById('gold-sell');
      
                  // H√†m formatCurrency ƒë√£ c√≥ s·∫µn trong code c·ªßa b·∫°n
                  if (goldBuyEl) goldBuyEl.textContent = formatCurrency(res.gold.buy);
                  if (goldSellEl) goldSellEl.textContent = formatCurrency(res.gold.sell);
               }
            }
         } catch (err) {
            console.error("L·ªói sync home stats:", err);
         }
      }
      
      // --- MAIN INITIALIZATION ---
      (async () => {
         // 1. Kh·ªüi t·∫°o UI/Modal (Gi·ªØ nguy√™n)
         loadingToast = new bootstrap.Toast(document.getElementById('loadingToast'));
         successToast = new bootstrap.Toast(document.getElementById('successToast'));
         createPostModal = new bootstrap.Modal(document.getElementById('createPostModal'));
         createMemoryModal = new bootstrap.Modal(document.getElementById('createMemoryModal'));
         createAlbumModal = new bootstrap.Modal(document.getElementById('createAlbumModal'));
         albumDetailModal = new bootstrap.Modal(document.getElementById('albumDetailModal'));
         commentModal = new bootstrap.Modal(document.getElementById('commentModal'));
         profileModal = new bootstrap.Modal(document.getElementById('profileModal'));
         postOptionsModal = new bootstrap.Modal(document.getElementById('postOptionsModal'));
         deleteConfirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
         bikeStatsModal = new bootstrap.Modal(document.getElementById('bikeStatsModal'));
         addBikeEntryModal = new bootstrap.Modal(document.getElementById('addBikeEntryModal'));
         goldStatsModal = new bootstrap.Modal(document.getElementById('goldStatsModal'));
         addGoldEntryModal = new bootstrap.Modal(document.getElementById('addGoldEntryModal'));
         notificationsModal = new bootstrap.Modal(document.getElementById('notificationsModal'));
      
		// ===> [CH√àN H√ÄM G·ªåI ·ªû ƒê√ÇY] <===
		// Ki·ªÉm tra v√† d·ªçn d·∫πp b·ªô nh·ªõ ngay khi m·ªü app
		manageCacheSize();
   
         if (window.dataSdk) await window.dataSdk.init(dataHandler);
      
         // 2. LOAD OFFLINE FIRST (Hi·ªÉn th·ªã ngay l·∫≠p t·ª©c)
         const localData = getLocalData();
         if (localData) {
            currentProfile = localData;
            applyTheme(currentProfile.themeName);
            updateAvatarDisplays();
         }
      
         const cachedRun = localStorage.getItem('cached_babyrun_count');
         if (cachedRun && document.getElementById('bike-count')) {
            document.getElementById('bike-count').textContent = cachedRun;
         }
      
         if (currentTab === 'home') {
            renderStats();
            updateStats();
         }
      
         // Set ng√†y m·∫∑c ƒë·ªãnh
         const today = new Date();
         if (document.getElementById('bike-entry-date')) document.getElementById('bike-entry-date').valueAsDate = today;
         if (document.getElementById('gold-entry-date')) document.getElementById('gold-entry-date').valueAsDate = today;
      
		// ============================================================
		// B∆Ø·ªöC 2: G·ªåI SERVER THEO TH·ª® T·ª∞ ∆ØU TI√äN
		// ============================================================

		// A. T·∫£i s·ªë li·ªáu quan tr·ªçng nh·∫•t (Baby Run & V√†ng) - Ch·∫°y tr∆∞·ªõc
		// D√πng await ƒë·ªÉ ƒë·∫£m b·∫£o s·ªë li·ªáu m·ªõi nh·∫•t v·ªÅ tr∆∞·ªõc khi l√†m vi·ªác kh√°c
		await loadCriticalStats(); 

		// B. T·∫£i th√¥ng tin n·ªÅn (Profile & Badge Notification) - Ch·∫°y sau/song song
		// Kh√¥ng d√πng await ƒë·ªÉ kh√¥ng ch·∫∑n vi·ªác t·∫£i Feed
		loadBackgroundInfo(); 
		
		
		// C. T·∫£i B·∫£ng tin (N·∫∑ng nh·∫•t) - Ch·∫°y cu·ªëi c√πng
		// D. Load B·∫£ng tin t·ª´ Cache (HI·ªÇN TH·ªä NGAY L·∫¨P T·ª®C)
		const cachedFeed = localStorage.getItem('cached_feed_data');
		if (cachedFeed) {
		   try {
			   const parsedFeed = JSON.parse(cachedFeed);
			   if (parsedFeed && parsedFeed.length > 0) {
				   serverFeedData = parsedFeed; // G√°n v√†o bi·∫øn to√†n c·ª•c
				   renderPostsPaged(serverFeedData, 1); // V·∫Ω ra m√†n h√¨nh ngay
				   console.log("ƒê√£ load Feed t·ª´ Cache:", parsedFeed.length, "b√†i");
			   }
		   } catch (e) {
			   console.error("L·ªói ƒë·ªçc cache feed");
		   }
		}
   
		loadFeedData(1);

		// D. T·∫£i danh s√°ch th√¥ng b√°o (ƒê·ªÉ s·∫µn ƒë√≥)
		loadNotifications(1);
      
      })();
      
      function showToast(message) {
         document.getElementById('toast-message').textContent = message;
         successToast.show();
      }
      
      function showLoading() {
         loadingToast.show();
      }
      
      function hideLoading() {
         loadingToast.hide();
      }
      
      function updateNotificationBadge() {
         const notifications = allData.filter(d => d.type === 'notification');
         const unreadCount = notifications.filter(n => !n.isRead).length;
         const badge = document.getElementById('notification-badge');
      
         if (unreadCount > 0) {
            badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
            badge.classList.remove('d-none');
         } else {
            badge.classList.add('d-none');
         }
      }
      
      function renderNotifications() {
         const notifications = allData.filter(d => d.type === 'notification').sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
         const container = document.getElementById('notifications-list');
      
         if (notifications.length === 0) {
            container.innerHTML = `
      			  <div class="text-center py-5">
      				<i class="bi bi-bell-slash theme-text-primary" style="font-size: 4rem;"></i>
      				<p class="fw-semibold fs-5 mt-3">Ch∆∞a c√≥ th√¥ng b√°o</p>
      				<p class="text-muted">C√°c th√¥ng b√°o m·ªõi s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y</p>
      			  </div>
      			`;
            return;
         }
      
         container.innerHTML = notifications.map(notif => {
            const iconMap = {
               like: 'heart-fill text-danger',
               comment: 'chat-fill text-primary',
               memory: 'star-fill text-warning',
               album: 'folder-fill text-info',
               system: 'info-circle-fill theme-text-primary'
            };
      
            const icon = iconMap[notif.notifType] || iconMap.system;
      
            return `
      			  <div class="notification-item p-2 ${notif.isRead ? '' : 'unread'}" data-id="${notif.__backendId}">
      				<div class="d-flex align-items-start">
      				  <div class="me-3">
      					<i class="bi bi-${icon} fs-6"></i>
      				  </div>
      				  <div class="flex-grow-1">
      					<p class="mb-1 fw-semibold">${notif.title}</p>
      					<p class="mb-1 text-muted small">${notif.message}</p>
      					<small class="text-muted">${formatDate(notif.createdAt)}</small>
      				  </div>
      				  ${!notif.isRead ? '<div class="notification-dot ms-2"></div>' : ''}
      				  <button class="btn btn-sm btn-link text-danger delete-notification" data-id="${notif.__backendId}">
      					<i class="bi bi-x-lg"></i>
      				  </button>
      				</div>
      			  </div>
      			`;
         }).join('');
      }
      
      async function createNotification(type, title, message) {
         if (recordCount >= 999) return;
      
         await window.dataSdk.create({
            type: 'notification',
            notifType: type,
            title: title,
            message: message,
            isRead: false,
            createdAt: new Date().toISOString()
         });
		
      }
      
	  // --- [LU·ªíNG 1] T·∫¢I S·ªê LI·ªÜU QUAN TR·ªåNG (∆Øu ti√™n cao nh·∫•t) ---
async function loadCriticalStats() {
    try {
        const now = new Date();
        const dateStr = `${String(now.getDate()).padStart(2, '0')}/${String(now.getMonth() + 1).padStart(2, '0')}/${now.getFullYear()}`;

        // G·ªçi API nh·∫π nh·∫•t c√≥ th·ªÉ
        const res = await sendToServer({
            action: 'get_critical_stats',
            date: dateStr
        });

        if (res.status === 'success') {
            // 1. C·∫≠p nh·∫≠t S·ªë l∆∞·ª£t ƒë·∫°p
            const bikeCountEl = document.getElementById('bike-count');
            if (bikeCountEl) {
                bikeCountEl.textContent = res.count;
                // [QUAN TR·ªåNG] L∆∞u Cache ƒë·ªÉ l·∫ßn sau m·ªü app l√† c√≥ ngay
                localStorage.setItem('cached_babyrun_count', res.count); 
            }
            
            // 2. C·∫≠p nh·∫≠t Gi√° v√†ng
            if (res.gold) {
                const goldBuyEl = document.getElementById('gold-buy');
                const goldSellEl = document.getElementById('gold-sell');
                if (goldBuyEl) goldBuyEl.textContent = formatCurrency(res.gold.buy);
                if (goldSellEl) goldSellEl.textContent = formatCurrency(res.gold.sell);
            }
        }
    } catch (e) {
        console.error("L·ªói t·∫£i Critical Stats:", e);
    }
}

// --- [LU·ªíNG 2] T·∫¢I TH√îNG TIN N·ªÄN (∆Øu ti√™n th·∫•p h∆°n) ---
async function loadBackgroundInfo() {
    try {
        const fingerprint = await getBrowserFingerprint();
        const res = await sendToServer({
            action: 'get_background_info',
            fingerprint: fingerprint
        });

        if (res.status === 'success') {
            // 1. C·∫≠p nh·∫≠t Profile (n·∫øu c√≥ thay ƒë·ªïi)
            if (res.profile) {
                const localData = getLocalData();
                // Ch·ªâ c·∫≠p nh·∫≠t DOM n·∫øu d·ªØ li·ªáu th·ª±c s·ª± kh√°c (tr√°nh nh√°y h√¨nh)
                if (!localData || localData.username !== res.profile.username || localData.avatarData !== res.profile.avaurl) {
                    currentProfile = {
                        username: res.profile.username,
                        fullName: res.profile.fullname,
                        avatarData: res.profile.avaurl,
                        themeName: res.profile.theme
                    };
                    saveLocalData(currentProfile);
                    applyTheme(currentProfile.themeName);
                    updateAvatarDisplays();
                }
            }

            // 2. C·∫≠p nh·∫≠t Badge th√¥ng b√°o
            const badge = document.getElementById('notification-badge');
            const count = res.unreadCount || 0;
            if (count > 0) {
                badge.textContent = count > 99 ? '99+' : count;
                badge.classList.remove('d-none');
            } else {
                badge.classList.add('d-none');
            }
        }
    } catch (e) {
        console.error("L·ªói t·∫£i Background Info:", e);
    }
}

      function updateAvatarDisplays() {
         const avatarText = currentProfile?.fullName?.[0]?.toUpperCase() || currentProfile?.username?.[0]?.toUpperCase() || 'U';
         const avatarImg = currentProfile?.avatarData;
      
         ['header-avatar', 'profile-avatar'].forEach(id => {
            const container = document.getElementById(id);
            if (avatarImg) {
               container.innerHTML = `<img src="${avatarImg}" class="w-100 h-100 object-fit-cover" alt="Avatar">`;
            } else {
               container.innerHTML = `<i class="bi bi-person-fill theme-text-primary ${id === 'profile-avatar' ? 'fs-1' : 'fs-4'}"></i>`;
            }
         });
      
         if (currentProfile) {
            document.getElementById('profile-username').value = currentProfile.username || '';
            document.getElementById('profile-fullname').value = currentProfile.fullName || '';
         }
      }
      
      // --- H√ÄM X·ª¨ L√ù TH·ªúI GIAN TH√îNG MINH (M·ªöI) ---
      // --- S·ª¨A L·∫†I H√ÄM N√ÄY ƒê·ªÇ H·∫æT L·ªñI NaNaNa ---
      function formatTimeSmart(dateStr) {
         if (!dateStr) return '';
      
         // 1. Ki·ªÉm tra xem c√≥ ph·∫£i ng√†y th√°ng h·ª£p l·ªá kh√¥ng
         const date = new Date(dateStr);
         if (isNaN(date.getTime())) {
            // N·∫øu kh√¥ng ph·∫£i ng√†y (v√≠ d·ª•: "ƒêang g·ª≠i..."), tr·∫£ v·ªÅ nguy√™n vƒÉn text ƒë√≥
            return dateStr;
         }
      
         const now = new Date();
         const diffMs = now - date;
         const diffSeconds = Math.floor(diffMs / 1000);
      
         // X·ª≠ l√Ω logic hi·ªÉn th·ªã
         if (diffSeconds < 60) {
            return `${Math.max(1, diffSeconds)} gi√¢y`;
         }
      
         const diffMinutes = Math.floor(diffSeconds / 60);
         if (diffMinutes < 60) {
            return `${diffMinutes} ph√∫t`;
         }
      
         const diffHours = Math.floor(diffMinutes / 60);
         if (diffHours < 24) {
            return `${diffHours} gi·ªù`;
         }
      
         const diffDays = Math.floor(diffHours / 24);
         if (diffDays <= 7) {
            return `${diffDays} ng√†y`;
         }
      
         // Qu√° 7 ng√†y -> Hi·ªán Full: 14:42 21/01/2026
         const hh = String(date.getHours()).padStart(2, '0');
         const mm = String(date.getMinutes()).padStart(2, '0');
         const dd = String(date.getDate()).padStart(2, '0');
         const mo = String(date.getMonth() + 1).padStart(2, '0');
         const yyyy = date.getFullYear();
      
         return `${hh}:${mm} ${dd}/${mo}/${yyyy}`;
      }
      
      function parseComments(commentsStr) {
         if (!commentsStr) return [];
         try {
            return JSON.parse(commentsStr);
         } catch {
            return [];
         }
      }
      
      function parseImages(imageStr) {
         if (!imageStr) return [];
         try {
            return JSON.parse(imageStr);
         } catch {
            return imageStr ? [imageStr] : [];
         }
      }
      
      function updateStats() {
         const startDate = new Date('2022-02-22');
         const today = new Date();
         const diffTime = Math.abs(today - startDate);
         const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
         const daysEl = document.getElementById('days-together');
         if (daysEl) daysEl.textContent = `${diffDays} ng√†y`;
      
         const memoryCount = allData.filter(d => d.type === 'memory').length;
         const memoryEl = document.getElementById('memory-count');
         if (memoryEl) memoryEl.textContent = memoryCount;
      
      
         // Gi·∫£i ph√°p: ∆Øu ti√™n l·∫•y t·ª´ Cache LocalStorage (do h√†m syncBabyRunStats ƒë√£ l∆∞u)
      
         const bikeEl = document.getElementById('bike-count');
         if (bikeEl) {
            // 1. L·∫•y s·ªë li·ªáu t·ª´ Cache (∆Øu ti√™n s·ªë 1)
            const cachedCount = localStorage.getItem('cached_babyrun_count');
      
            // 2. N·∫øu c√≥ Cache th√¨ d√πng Cache, n·∫øu kh√¥ng m·ªõi t√≠nh t·ª´ allData (Fallback)
            if (cachedCount !== null && cachedCount !== undefined) {
               bikeEl.textContent = cachedCount;
            } else {
               // Logic c≈© (ch·ªâ d√πng khi kh√¥ng c√≥ cache)
               const bikeEntries = allData.filter(d => d.type === 'bike_entry');
               const todayStr = new Date().toISOString().split('T')[0];
               const todayCount = bikeEntries.filter(e => e.date === todayStr).reduce((sum, e) => sum + (e.count || 0), 0);
               bikeEl.textContent = todayCount;
            }
         }
      }
      
      function calculateBikeStats() {
         const bikeEntries = allData.filter(d => d.type === 'bike_entry');
         const today = new Date();
         const todayStr = today.toISOString().split('T')[0];
      
         const todayCount = bikeEntries.filter(e => e.date === todayStr).reduce((sum, e) => sum + (e.count || 0), 0);
      
         const weekStart = new Date(today);
         weekStart.setDate(today.getDate() - today.getDay());
         weekStart.setHours(0, 0, 0, 0);
         const weekCount = bikeEntries.filter(e => {
            const entryDate = new Date(e.date);
            return entryDate >= weekStart;
         }).reduce((sum, e) => sum + (e.count || 0), 0);
      
         const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
         const monthCount = bikeEntries.filter(e => {
            const entryDate = new Date(e.date);
            return entryDate >= monthStart;
         }).reduce((sum, e) => sum + (e.count || 0), 0);
      
         return {
            todayCount,
            weekCount,
            monthCount
         };
      }
      
      function renderBikeChart() {
         const bikeEntries = allData.filter(d => d.type === 'bike_entry');
         const chartContainer = document.getElementById('bike-chart');
      
         const days = [];
         for (let i = 6; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            days.push(date.toISOString().split('T')[0]);
         }
      
         const counts = days.map(day => {
            return bikeEntries.filter(e => e.date === day).reduce((sum, e) => sum + (e.count || 0), 0);
         });
      
         const maxCount = Math.max(...counts, 1);
      
         chartContainer.innerHTML = `
      			<div class="d-flex align-items-end justify-content-between" style="height: 100%;">
      			  ${days.map((day, i) => {
      				const height = (counts[i] / maxCount) * 100;
      				const date = new Date(day);
      				const dayName = ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'][date.getDay()];
      				return `
      				  <div class="d-flex flex-column align-items-center" style="flex: 1;">
      					<div class="mb-2 small fw-bold theme-text-primary">${counts[i]}</div>
      					<div class="w-100 theme-bg-primary rounded-top" style="height: ${height}%; min-height: 5px; max-width: 40px; margin: 0 auto;"></div>
      					<div class="mt-2 small text-muted">${dayName}</div>
      				  </div>
      				`;
      			  }).join('')}
      			</div>
      		  `;
      }
      
      function renderBikeHistory() {
         const bikeEntries = allData.filter(d => d.type === 'bike_entry').sort((a, b) => new Date(b.date) - new Date(a.date));
         const container = document.getElementById('bike-history-list');
      
         if (bikeEntries.length === 0) {
            container.innerHTML = '<p class="text-center text-muted py-3">Ch∆∞a c√≥ d·ªØ li·ªáu</p>';
            return;
         }
      
         container.innerHTML = bikeEntries.map(entry => {
            const date = new Date(entry.date);
            const dateStr = date.toLocaleDateString('vi-VN', {
               day: '2-digit',
               month: '2-digit',
               year: 'numeric'
            });
            return `
      			  <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
      				<div>
      				  <p class="mb-0 fw-semibold">${entry.count} l∆∞·ª£t</p>
      				  <small class="text-muted">${dateStr}</small>
      				  ${entry.note ? `<p class="small text-muted mb-0 mt-1">${entry.note}</p>` : ''}
      				</div>
      				<button class="btn btn-sm btn-outline-danger delete-bike-entry" data-id="${entry.__backendId}">
      				  <i class="bi bi-trash"></i>
      				</button>
      			  </div>
      			`;
         }).join('');
      }
      
      // --- H√ÄM CH√çNH: HI·ªÇN TH·ªä TH·ªêNG K√ä ---
      async function showBikeStats() {
         bikeStatsModal.show();
      
         // Reset tr·∫°ng th√°i ph√¢n trang
         bikeHistoryPage = 1;
         bikeHistoryHasMore = true;
         bikeHistoryLoading = false;
      
         // Reset UI Loading
         document.getElementById('stats-today').textContent = '...';
         document.getElementById('stats-week').textContent = '...';
         document.getElementById('stats-month').textContent = '...';
      
         const historyContainer = document.getElementById('bike-history-list');
         if (historyContainer) {
            historyContainer.innerHTML = '<div class="d-flex justify-content-center align-items-center py-3"><div class="spinner-border text-primary spinner-border-sm" role="status"></div></div>';
         }
      
         // G·ªçi API TRANG 1 (Limit 15 d√≤ng - ƒê·ªß cho 1 ng√†y)
         loadBikeHistoryData(1);
      }
      
      async function loadBikeHistoryData(page) {
         if (bikeHistoryLoading) return;
         bikeHistoryLoading = true;
      
         try {
            const res = await sendToServer({
               action: 'get_bike_stats',
               page: page,
               limit: 15 // Ch·ªâ t·∫£i 15 d√≤ng m·ªói l·∫ßn -> R·∫•t nhanh
            });
      
            if (res.status === 'success') {
               // 1. N·∫øu l√† trang 1: C·∫≠p nh·∫≠t Stats & Chart
               if (page === 1) {
                  if (res.stats) {
                     document.getElementById('stats-today').textContent = res.stats.today;
                     document.getElementById('stats-week').textContent = res.stats.week;
                     document.getElementById('stats-month').textContent = res.stats.month;
                  }
                  if (res.history) renderBikeChartFromServer(res.history);
               }
      
               // 2. Render Danh s√°ch Log
               bikeHistoryHasMore = res.hasMore; // Server b√°o c√≤n d·ªØ li·ªáu ko
               renderBikeHistoryPaged(res.logs, page);
            }
         } catch (e) {
            console.error("L·ªói t·∫£i l·ªãch s·ª≠:", e);
         } finally {
            bikeHistoryLoading = false;
         }
      }
      
      // --- H√ÄM PH·ª§ TR·ª¢: T·∫†O HTML CHO 1 D√íNG LOG ---
      function createLogItemHtml(log) {
         const firstLetter = log.username ? log.username.charAt(0).toUpperCase() : '?';
         return `
      				<div class="list-group-item border-0 p-2 d-flex justify-content-between align-items-center mb-1 rounded hover-bg-light">
      					<div class="d-flex align-items-center">
      						 <div class="rounded-circle theme-bg-primary d-flex align-items-center justify-content-center text-white me-2 shadow-sm" style="width: 32px; height: 32px; font-size: 12px; font-weight: bold;">
      							${firstLetter}
      						 </div>
      						 <div class="d-flex flex-column">
      							 <span class="small fw-bold text-dark">${log.username || '·∫®n danh'}</span>
      						 </div>
      					</div>
      					<div class="text-end">
      						<span class="badge bg-light text-secondary border fw-normal font-monospace">${log.time || '--:--'}</span>
      					</div>
      				</div>
      			`;
      }
      
      // --- H√ÄM RENDER CH√çNH (ƒê√É FIX L·ªñI TR√ôNG GROUP NG√ÄY) ---
      function renderBikeHistoryPaged(logsData, page) {
         const container = document.getElementById('bike-history-list');
         if (!container) return;
      
         // 1. X√≥a n√∫t Load More c≈© tr∆∞·ªõc khi th√™m d·ªØ li·ªáu m·ªõi
         const oldTrigger = document.getElementById('load-more-trigger');
         if (oldTrigger) oldTrigger.remove();
      
         // 2. N·∫øu l√† trang 1 th√¨ reset to√†n b·ªô
         if (page === 1) {
            container.innerHTML = '';
            if (!logsData || logsData.length === 0) {
               container.innerHTML = '<p class="text-center text-muted py-3 small">Ch∆∞a c√≥ d·ªØ li·ªáu chi ti·∫øt</p>';
               return;
            }
         }
      
         // 3. Gom nh√≥m d·ªØ li·ªáu m·ªõi theo ng√†y
         const groups = {};
         logsData.forEach(item => {
            if (!item.date) return;
            if (!groups[item.date]) groups[item.date] = [];
            groups[item.date].push(item);
         });
      
         // L·∫•y danh s√°ch c√°c ng√†y trong l√¥ d·ªØ li·ªáu m·ªõi (Th·ª© t·ª±: M·ªõi -> C≈©)
         const dates = Object.keys(groups);
      
         // 4. X·ª¨ L√ù G·ªòP (MERGE) N·∫æU TR√ôNG NG√ÄY
         if (page > 1 && dates.length > 0) {
            // L·∫•y ng√†y ƒë·∫ßu ti√™n c·ªßa l√¥ m·ªõi
            const firstDateOfNewBatch = dates[0];
      
            // T√¨m nh√≥m ng√†y cu·ªëi c√πng ƒëang hi·ªÉn th·ªã tr√™n m√†n h√¨nh
            const lastRenderedGroup = container.querySelector('.history-group:last-child');
      
            if (lastRenderedGroup) {
               const lastRenderedDate = lastRenderedGroup.getAttribute('data-date');
      
               // N·∫øu ng√†y cu·ªëi c√πng c·ªßa l√¥ c≈© TR√ôNG v·ªõi ng√†y ƒë·∫ßu ti√™n c·ªßa l√¥ m·ªõi
               if (lastRenderedDate === firstDateOfNewBatch) {
                  // -> G·ªòP V√ÄO
                  const itemsToAppend = groups[firstDateOfNewBatch];
                  const listGroup = lastRenderedGroup.querySelector('.list-group');
                  const badge = lastRenderedGroup.querySelector('.badge');
      
                  // a. Th√™m c√°c d√≤ng log m·ªõi v√†o nh√≥m c≈©
                  let itemsHtml = '';
                  itemsToAppend.forEach(log => {
                     itemsHtml += createLogItemHtml(log);
                  });
                  listGroup.insertAdjacentHTML('beforeend', itemsHtml);
      
                  // b. C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng tr√™n Badge (S·ªë c≈© + S·ªë m·ªõi th√™m)
                  if (badge) {
                     // L·∫•y s·ªë t·ª´ text "15 l∆∞·ª£t" -> 15
                     const currentCount = parseInt(badge.textContent) || 0;
                     badge.textContent = `${currentCount + itemsToAppend.length} l∆∞·ª£t`;
                  }
      
                  // c. X√≥a ng√†y n√†y kh·ªèi danh s√°ch c·∫ßn render m·ªõi (ƒë·ªÉ kh√¥ng b·ªã l·∫∑p l·∫°i header)
                  delete groups[firstDateOfNewBatch];
                  const idx = dates.indexOf(firstDateOfNewBatch);
                  if (idx > -1) dates.splice(idx, 1);
               }
            }
         }
      
         // 5. RENDER C√ÅC NH√ìM C√íN L·∫†I (B√åNH TH∆Ø·ªúNG)
         let htmlContent = '';
         dates.forEach(date => {
            const items = groups[date];
            // Th√™m class 'history-group' v√† thu·ªôc t√≠nh 'data-date' ƒë·ªÉ h·ªó tr·ª£ vi·ªác t√¨m ki·∫øm sau n√†y
            htmlContent += `
      					<div class="mb-3 history-group fade-in" data-date="${date}">
      						<div class="d-flex align-items-center justify-content-between bg-light px-3 py-2 rounded mb-2 shadow-sm sticky-top" style="top: -1px; z-index: 5;">
      							<span class="fw-bold text-dark small"><i class="bi bi-calendar-check me-1"></i> ${date}</span>
      							<span class="badge theme-bg-primary rounded-pill" style="font-weight: normal;">${items.length} l∆∞·ª£t</span>
      						</div>
      						<div class="list-group list-group-flush px-2">
      							${items.map(log => createLogItemHtml(log)).join('')}
      						</div>
      					</div>
      				`;
         });
      
         // Ch√®n HTML m·ªõi v√†o cu·ªëi container
         container.insertAdjacentHTML('beforeend', htmlContent);
      
         // 6. T·∫†O L·∫†I N√öT LOAD MORE (N·∫æU C√íN D·ªÆ LI·ªÜU)
         if (bikeHistoryHasMore) {
            const trigger = document.createElement('div');
            trigger.id = 'load-more-trigger';
            trigger.className = 'py-3 text-center text-muted small cursor-pointer';
            trigger.innerHTML = `<span class="spinner-border spinner-border-sm me-1 d-none" id="load-spinner"></span> <span id="load-text">Vu·ªët l√™n ho·∫∑c nh·∫•n ƒë·ªÉ xem th√™m c≈© h∆°n</span>`;
      
            trigger.addEventListener('click', () => triggerLoadMore());
            container.appendChild(trigger);
      
            // Auto Scroll
            setupInfiniteScroll(trigger);
         } else {
            const endMsg = document.createElement('div');
            endMsg.className = 'text-center py-3 text-muted small';
            endMsg.innerHTML = '--- H·∫øt l·ªãch s·ª≠ ---';
            container.appendChild(endMsg);
         }
      }
      
      function triggerLoadMore() {
         if (bikeHistoryLoading || !bikeHistoryHasMore) return;
      
         // Hi·ªáu ·ª©ng loading
         const spinner = document.getElementById('load-spinner');
         if (spinner) spinner.classList.remove('d-none');
      
         bikeHistoryPage++;
         loadBikeHistoryData(bikeHistoryPage);
      }
      
      function setupInfiniteScroll(target) {
         const observer = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting) {
               triggerLoadMore();
            }
         }, {
            threshold: 0.1
         });
         observer.observe(target);
      }
      
      // --- H√ÄM V·∫º BI·ªÇU ƒê·ªí (ƒê√£ s·ª≠a s·∫Øp x·∫øp TƒÉng d·∫ßn chu·∫©n x√°c) ---
      function renderBikeChartFromServer(historyData) {
         const chartContainer = document.getElementById('bike-chart');
         if (!chartContainer) return;
      
         if (!historyData || historyData.length === 0) {
            chartContainer.innerHTML = '<div class="text-center py-5 text-muted small">Ch∆∞a c√≥ d·ªØ li·ªáu bi·ªÉu ƒë·ªì</div>';
            return;
         }
      
         // 1. S·∫Øp x·∫øp d·ªØ li·ªáu TƒÇNG D·∫¶N (C≈© -> M·ªõi)
         // S·ª≠ d·ª•ng h√†m helper ƒë·ªÉ parse ng√†y an to√†n
         const parseDateVal = (dateStr) => {
            if (!dateStr) return 0;
            try {
               // dateStr d·∫°ng "15/01/2026"
               const parts = dateStr.trim().split('/');
               if (parts.length < 3) return 0;
               // Tr·∫£ v·ªÅ Timestamp: NƒÉm, Th√°ng (0-11), Ng√†y
               return new Date(parts[2], parseInt(parts[1]) - 1, parts[0]).getTime();
            } catch (e) {
               return 0;
            }
         };
      
         const sortedData = [...historyData].sort((a, b) => {
            return parseDateVal(a.date) - parseDateVal(b.date);
         });
      
         // 2. C·∫•u h√¨nh k√≠ch th∆∞·ªõc
         const itemWidth = 60;
         const chartHeight = 160;
         // ƒê·ªô r·ªông t·ªïng = s·ªë l∆∞·ª£ng c·ªôt * 60px (ho·∫∑c t·ªëi thi·ªÉu b·∫±ng chi·ªÅu r·ªông m√†n h√¨nh)
         const totalWidth = Math.max(chartContainer.parentElement.offsetWidth, sortedData.length * itemWidth);
      
         const counts = sortedData.map(d => parseInt(d.count) || 0);
         // T√≠nh gi√° tr·ªã l·ªõn nh·∫•t ƒë·ªÉ chia t·ªâ l·ªá chi·ªÅu cao (th√™m 20% ƒë·ªám cho ƒë·∫πp)
         const maxVal = Math.max(...counts, 5) * 1.2;
      
         // 3. T√≠nh t·ªça ƒë·ªô X, Y cho t·ª´ng ƒëi·ªÉm
         const points = sortedData.map((d, i) => {
            const x = (i * itemWidth) + (itemWidth / 2);
            const count = parseInt(d.count) || 0;
            const y = chartHeight - ((count / maxVal) * chartHeight);
            return {
               x,
               y,
               count,
               date: d.date
            };
         });
      
         // 4. T·∫°o ƒë∆∞·ªùng cong m·ªÅm m·∫°i (Bezier Curve)
         const getControlPoint = (current, previous, next, reverse) => {
            const p = previous || current;
            const n = next || current;
            const smoothing = 0.2;
            const oX = n.x - p.x;
            const oY = n.y - p.y;
            const length = Math.sqrt(Math.pow(oX, 2) + Math.pow(oY, 2)) * smoothing;
            const angle = Math.atan2(oY, oX) + (reverse ? Math.PI : 0);
            return {
               x: current.x + Math.cos(angle) * length,
               y: current.y + Math.sin(angle) * length
            };
         };
      
         let pathD = `M ${points[0].x} ${points[0].y}`;
         for (let i = 0; i < points.length - 1; i++) {
            const p0 = points[i - 1];
            const p1 = points[i];
            const p2 = points[i + 1];
            const p3 = points[i + 2];
            const cp1 = getControlPoint(p1, p0, p2, false);
            const cp2 = getControlPoint(p2, p1, p3, true);
            pathD += ` C ${cp1.x} ${cp1.y}, ${cp2.x} ${cp2.y}, ${p2.x} ${p2.y}`;
         }
      
         // T·∫°o v√πng m√†u b√™n d∆∞·ªõi ƒë∆∞·ªùng bi·ªÉu ƒë·ªì
         const areaPathD = `${pathD} L ${points[points.length - 1].x} ${chartHeight} L ${points[0].x} ${chartHeight} Z`;
      
         const strokeColor = 'var(--primary-color)';
         const circleColor = 'var(--surface-color, #fff)';
      
         // 5. Render SVG
         chartContainer.innerHTML = `
      				<svg width="${totalWidth}" height="200" xmlns="http://www.w3.org/2000/svg">
      					<defs>
      						<linearGradient id="chartGradient" x1="0" x2="0" y1="0" y2="1">
      							<stop offset="0%" stop-color="${strokeColor}" stop-opacity="0.4"/>
      							<stop offset="100%" stop-color="${strokeColor}" stop-opacity="0.0"/>
      						</linearGradient>
      						<filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
      							<feDropShadow dx="0" dy="4" stdDeviation="4" flood-color="${strokeColor}" flood-opacity="0.3"/>
      						</filter>
      					</defs>
      
      					<line x1="0" y1="${chartHeight}" x2="${totalWidth}" y2="${chartHeight}" stroke="#eee" stroke-width="1" />
      					<line x1="0" y1="${chartHeight/2}" x2="${totalWidth}" y2="${chartHeight/2}" stroke="#eee" stroke-width="1" stroke-dasharray="4" />
      
      					<path d="${areaPathD}" fill="url(#chartGradient)" stroke="none" style="transition: fill 0.3s;" />
      
      					<path d="${pathD}" fill="none" stroke="${strokeColor}" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" filter="url(#shadow)" style="transition: stroke 0.3s;" />
      
      					${points.map((p, i) => `
      						<g class="chart-point">
      							${ (p.count > 0) ? 
      								`<text x="${p.x}" y="${p.y - 12}" fill="${strokeColor}" font-size="11" text-anchor="middle" font-weight="bold">${p.count}</text>` 
      								: '' 
      							}
      							<circle cx="${p.x}" cy="${p.y}" r="5" fill="${strokeColor}" stroke="${circleColor}" stroke-width="2" />
      							<text x="${p.x}" y="${chartHeight + 25}" fill="#999" font-size="10" text-anchor="middle">${p.date.substring(0, 5)}</text>
      						</g>
      					`).join('')}
      				</svg>
      			`;
      
         // 6. T·ª± ƒë·ªông cu·ªôn sang ph·∫£i (Right) ƒë·ªÉ xem ng√†y m·ªõi nh·∫•t
         setTimeout(() => {
            const wrapper = chartContainer.parentElement; // div cha c√≥ overflow-x: auto
            if (wrapper) {
               wrapper.scrollLeft = wrapper.scrollWidth; // Cu·ªôn h·∫øt c·ª° sang ph·∫£i
            }
         }, 100);
      }
      
      // --- H√ÄM RENDER L·ªäCH S·ª¨ (GROUP BY DATE) ---
      function renderBikeHistoryFromServer(logsData) {
         const container = document.getElementById('bike-history-list');
         if (!container) return;
      
         if (!logsData || logsData.length === 0) {
            container.innerHTML = '<p class="text-center text-muted py-3 small">Ch∆∞a c√≥ d·ªØ li·ªáu chi ti·∫øt g·∫ßn ƒë√¢y</p>';
            return;
         }
      
         // 1. Nh√≥m d·ªØ li·ªáu theo ng√†y
         const groups = {};
         logsData.forEach(item => {
            if (!item.date) return;
            if (!groups[item.date]) groups[item.date] = [];
            groups[item.date].push(item);
         });
      
         // 2. T·∫°o HTML
         let htmlContent = '';
         const dates = Object.keys(groups); // Danh s√°ch c√°c ng√†y
      
         // L∆∞u √Ω: logsData t·ª´ server th∆∞·ªùng ƒë√£ ƒë∆∞·ª£c sort m·ªõi nh·∫•t -> c≈© nh·∫•t
         // n√™n keys(groups) c≈©ng s·∫Ω theo th·ª© t·ª± ƒë√≥.
      
         dates.forEach(date => {
            const items = groups[date];
      
            // Header Ng√†y
            htmlContent += `
      					<div class="mb-3">
      						<div class="d-flex align-items-center justify-content-between bg-light px-3 py-2 rounded mb-2 shadow-sm sticky-top" style="top: 0px; z-index: 5;">
      							<span class="fw-bold text-dark small"><i class="bi bi-calendar-check me-1"></i> ${date}</span>
      							<span class="badge theme-bg-primary rounded-pill" style="font-weight: normal;">${items.length} l∆∞·ª£t</span>
      						</div>
      						<div class="list-group list-group-flush px-2">
      				`;
      
            // Items trong ng√†y
            items.forEach(log => {
               // L·∫•y ch·ªØ c√°i ƒë·∫ßu c·ªßa t√™n ƒë·ªÉ l√†m Avatar
               const firstLetter = log.username ? log.username.charAt(0).toUpperCase() : '?';
      
               htmlContent += `
      						<div class="list-group-item border-0 p-2 d-flex justify-content-between align-items-center mb-1 rounded hover-bg-light">
      							<div class="d-flex align-items-center">
      								 <div class="rounded-circle theme-bg-primary d-flex align-items-center justify-content-center text-white me-2 shadow-sm" style="width: 32px; height: 32px; font-size: 12px; font-weight: bold;">
      									${firstLetter}
      								 </div>
      								 <div class="d-flex flex-column">
      									 <span class="small fw-bold text-dark">${log.username || '·∫®n danh'}</span>
      								 </div>
      							</div>
      							<div class="text-end">
      								<span class="badge bg-light text-secondary border fw-normal font-monospace">${log.time || '--:--'}</span>
      							</div>
      						</div>
      					`;
            });
      
            htmlContent += `
      						</div>
      					</div>
      				`;
         });
      
         container.innerHTML = htmlContent;
      }
      
      function calculateGoldStats() {
         const goldEntries = allData.filter(d => d.type === 'gold_entry');
      
         if (goldEntries.length === 0) {
            return {
               highest: null,
               lowest: null,
               highestDate: null,
               lowestDate: null
            };
         }
      
         let highest = goldEntries[0];
         let lowest = goldEntries[0];
      
         goldEntries.forEach(entry => {
            if (entry.sellPrice > highest.sellPrice) highest = entry;
            if (entry.buyPrice < lowest.buyPrice) lowest = entry;
         });
      
         return {
            highest: highest.sellPrice,
            highestDate: highest.date,
            lowest: lowest.buyPrice,
            lowestDate: lowest.date
         };
      }
      
      function renderGoldChart() {
         const goldEntries = allData.filter(d => d.type === 'gold_entry');
         const chartContainer = document.getElementById('gold-chart');
      
         const days = [];
         for (let i = 6; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            days.push(date.toISOString().split('T')[0]);
         }
      
         const buyPrices = days.map(day => {
            const entry = goldEntries.find(e => e.date === day);
            return entry ? entry.buyPrice : null;
         });
      
         const sellPrices = days.map(day => {
            const entry = goldEntries.find(e => e.date === day);
            return entry ? entry.sellPrice : null;
         });
      
         const allPrices = [...buyPrices, ...sellPrices].filter(p => p !== null);
         const maxPrice = allPrices.length > 0 ? Math.max(...allPrices) : 1;
         const minPrice = allPrices.length > 0 ? Math.min(...allPrices) : 0;
         const range = maxPrice - minPrice || 1;
      
         chartContainer.innerHTML = `
      			<div class="position-relative" style="height: 100%;">
      			  <svg width="100%" height="100%" style="position: absolute; top: 0; left: 0;">
      				${days.map((day, i) => {
      				  const x = (i / (days.length - 1)) * 100;
      				  const buyY = buyPrices[i] ? 100 - ((buyPrices[i] - minPrice) / range * 80) : null;
      				  const sellY = sellPrices[i] ? 100 - ((sellPrices[i] - minPrice) / range * 80) : null;
      				  const nextBuyY = buyPrices[i + 1] ? 100 - ((buyPrices[i + 1] - minPrice) / range * 80) : null;
      				  const nextSellY = sellPrices[i + 1] ? 100 - ((sellPrices[i + 1] - minPrice) / range * 80) : null;
      				  const nextX = ((i + 1) / (days.length - 1)) * 100;
      				  
      				  let lines = '';
      				  if (buyY !== null && nextBuyY !== null && i < days.length - 1) {
      					lines += `<line x1="${x}%" y1="${buyY}%" x2="${nextX}%" y2="${nextBuyY}%" stroke="#198754" stroke-width="2"/>`;
      				  }
      				  if (sellY !== null && nextSellY !== null && i < days.length - 1) {
      					lines += ` < line x1 = "${x}%"
         y1 = "${sellY}%"
         x2 = "${nextX}%"
         y2 = "${nextSellY}%"
         stroke = "#dc3545"
         stroke - width = "2" / > `;
      				  }
      				  
      				  let circles = '';
      				  if (buyY !== null) {
      					circles += ` < circle cx = "${x}%"
         cy = "${buyY}%"
         r = "4"
         fill = "#198754" / > `;
      				  }
      				  if (sellY !== null) {
      					circles += ` < circle cx = "${x}%"
         cy = "${sellY}%"
         r = "4"
         fill = "#dc3545" / > `;
      				  }
      				  
      				  return lines + circles;
      				}).join('')}
      			  </svg>
      			  <div class="d-flex justify-content-between position-absolute w-100" style="bottom: 0;">
      				${days.map(day => {
      				  const date = new Date(day);
      				  const dayName = ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'][date.getDay()];
      				  return `<small class="text-muted">${dayName}</small>`;
      				}).join('')}
      			  </div>
      			</div>
      			<div class="mt-3 d-flex gap-3 justify-content-center">
      			  <div><span class="badge bg-success">‚óè</span> Gi√° mua</div>
      			  <div><span class="badge bg-danger">‚óè</span> Gi√° b√°n</div>
      			</div>
      		  `;
      }
      
      function renderGoldHistory() {
         const goldEntries = allData.filter(d => d.type === 'gold_entry').sort((a, b) => new Date(b.date) - new Date(a.date));
         const container = document.getElementById('gold-history-list');
      
         if (goldEntries.length === 0) {
            container.innerHTML = '<p class="text-center text-muted py-3">Ch∆∞a c√≥ d·ªØ li·ªáu</p>';
            return;
         }
      
         container.innerHTML = goldEntries.map(entry => {
            const date = new Date(entry.date);
            const dateStr = date.toLocaleDateString('vi-VN', {
               day: '2-digit',
               month: '2-digit',
               year: 'numeric'
            });
            return `
      			  <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
      				<div>
      				  <div class="d-flex gap-3 mb-1">
      					<span class="text-success fw-semibold">${entry.buyPrice?.toLocaleString('vi-VN')}</span>
      					<span class="text-danger fw-semibold">${entry.sellPrice?.toLocaleString('vi-VN')}</span>
      				  </div>
      				  <small class="text-muted">${dateStr}</small>
      				  ${entry.note ? `<p class="small text-muted mb-0 mt-1">${entry.note}</p>` : ''}
      				</div>
      				<button class="btn btn-sm btn-outline-danger delete-gold-entry" data-id="${entry.__backendId}">
      				  <i class="bi bi-trash"></i>
      				</button>
      			  </div>
      			`;
         }).join('');
      }
      
      async function showGoldStats() {
         goldStatsModal.show();
      
         // Hi·ªán loading
         document.getElementById('gold-chart').innerHTML = '<div class="d-flex justify-content-center align-items-center h-100"><div class="spinner-border text-primary"></div></div>';
         document.getElementById('gold-history-list').innerHTML = '<div class="text-center py-3 text-muted">ƒêang t·∫£i d·ªØ li·ªáu...</div>';
      
         try {
            // G·ªçi API l·∫•y d·ªØ li·ªáu m·ªõi nh·∫•t t·ª´ goldchart v√† goldmb
            const res = await sendToServer({
               action: 'get_gold_data'
            });
      
            if (res.status === 'success') {
               goldMarketData = res.chartData; // D·ªØ li·ªáu bi·ªÉu ƒë·ªì gi√°
               goldPortfolioData = res.portfolio; // D·ªØ li·ªáu giao d·ªãch c√° nh√¢n
      
               // 1. V·∫Ω bi·ªÉu ƒë·ªì 2 ƒë∆∞·ªùng (Mua/B√°n)
               renderDoubleLineGoldChart(goldMarketData);
      
               // 2. T√≠nh to√°n P&L v√† v·∫Ω danh s√°ch giao d·ªãch (Logic ph·ª©c t·∫°p c·ªßa b·∫°n)
               loadGoldPortfolio();
            }
         } catch (e) {
            console.error(e);
            showToast('L·ªói t·∫£i d·ªØ li·ªáu v√†ng');
         }
      }
      
      
      // --- H√ÄM V·∫º BI·ªÇU ƒê·ªí 2 ƒê∆Ø·ªúNG (Xanh/ƒê·ªè) ---
      // --- H√ÄM V·∫º BI·ªÇU ƒê·ªí 2 ƒê∆Ø·ªúNG (C√ì TOOLTIP T∆Ø∆†NG T√ÅC) ---
      // --- H√ÄM V·∫º BI·ªÇU ƒê·ªí 2 ƒê∆Ø·ªúNG (FIX: CAO/TH·∫§P THEO GI√Å B√ÅN) ---
      function renderDoubleLineGoldChart(data) {
         const chartContainer = document.getElementById('gold-chart');
         if (!data || data.length === 0) {
            chartContainer.innerHTML = '<p class="text-center text-muted small pt-5">Ch∆∞a c√≥ d·ªØ li·ªáu gi√°</p>';
            return;
         }
      
         // L·∫•y 30 ng√†y g·∫ßn nh·∫•t ƒë·ªÉ v·∫Ω
         const limit = 30;
         const chartData = data.slice(-limit);
      
         // 1. T√çNH TO√ÅN HI·ªÇN TH·ªä TEXT (CAO/TH·∫§P THEO GI√Å B√ÅN)
         const sellPrices = chartData.map(d => d.sell);
         const maxSell = Math.max(...sellPrices);
         const minSell = Math.min(...sellPrices);
      
         // T√¨m ng√†y t∆∞∆°ng ·ª©ng
         const maxItem = chartData.find(d => d.sell === maxSell);
         const minItem = chartData.find(d => d.sell === minSell);
      
         document.getElementById('gold-highest-price').textContent = formatCurrency(maxSell);
         document.getElementById('gold-highest-date').textContent = maxItem ? maxItem.date : '-';
      
         document.getElementById('gold-lowest-price').textContent = formatCurrency(minSell);
         document.getElementById('gold-lowest-date').textContent = minItem ? minItem.date : '-';
      
         // 2. T√çNH TO√ÅN V·∫º BI·ªÇU ƒê·ªí (V·∫´n d√πng c·∫£ Buy/Sell ƒë·ªÉ scale cho ƒë·∫πp)
         const allPrices = [...chartData.map(d => d.buy), ...chartData.map(d => d.sell)];
         const minVal = Math.min(...allPrices);
         const maxVal = Math.max(...allPrices);
         const padding = (maxVal - minVal) * 0.1 || (maxVal * 0.1);
         const chartMin = minVal - padding;
         const chartMax = maxVal + padding;
         const chartRange = chartMax - chartMin || 1;
      
         // K√≠ch th∆∞·ªõc SVG
         const width = chartContainer.offsetWidth || 350;
         const height = 250;
      
         let stepX = 0;
         if (chartData.length > 1) {
            stepX = width / (chartData.length - 1);
         } else {
            stepX = width / 2;
         }
      
         const getY = (price) => height - ((price - chartMin) / chartRange * height);
      
         // T·∫°o ƒë∆∞·ªùng Path
         let pathBuy = `M 0 ${getY(chartData[0].buy)}`;
         let pathSell = `M 0 ${getY(chartData[0].sell)}`;
      
         if (chartData.length > 1) {
            chartData.forEach((d, i) => {
               pathBuy += ` L ${i * stepX} ${getY(d.buy)}`;
            });
            chartData.forEach((d, i) => {
               pathSell += ` L ${i * stepX} ${getY(d.sell)}`;
            });
         } else {
            pathBuy += ` L ${width} ${getY(chartData[0].buy)}`;
            pathSell += ` L ${width} ${getY(chartData[0].sell)}`;
         }
      
         // --- HTML M·ªöI: SVG + TOOLTIP ---
         chartContainer.innerHTML = `
      				<div class="position-relative" style="height: 100%;">
      					<div id="chart-tooltip-box" class="position-absolute start-50 translate-middle-x bg-white shadow-sm border rounded px-2 py-1 text-center d-none" 
      						 style="top: -30px; z-index: 10; min-width: 120px; white-space: nowrap;">
      						 <small class="d-block fw-bold text-dark" id="tt-date">--/--</small>
      						 <div class="d-flex gap-2 justify-content-center" style="font-size: 0.75rem;">
      							<span class="text-success fw-bold" id="tt-buy">-</span>
      							<span class="text-danger fw-bold" id="tt-sell">-</span>
      						 </div>
      					</div>
      
      					<svg width="100%" height="100%" viewBox="0 0 ${width} ${height}" preserveAspectRatio="none">
      						<line x1="0" y1="${height/2}" x2="${width}" y2="${height/2}" stroke="#eee" stroke-dasharray="4"/>
      						<line x1="0" y1="${height*0.25}" x2="${width}" y2="${height*0.25}" stroke="#f8f9fa" stroke-dasharray="4"/>
      						<line x1="0" y1="${height*0.75}" x2="${width}" y2="${height*0.75}" stroke="#f8f9fa" stroke-dasharray="4"/>
      
      						<path d="${pathSell}" fill="none" stroke="#dc3545" stroke-width="2" />
      						<path d="${pathBuy}" fill="none" stroke="#198754" stroke-width="2" />
      
      						${chartData.map((d, i) => {
      							const cx = (chartData.length > 1) ? i * stepX : width / 2;
      							const cyBuy = getY(d.buy);
      							const cySell = getY(d.sell);
      							
      							return `
      							<g onclick="updateChartTooltip('${d.date}', ${d.buy}, ${d.sell})" 
      							   style="cursor: pointer;">
      								<rect x="${cx - 10}" y="0" width="20" height="${height}" fill="transparent" />
      								<circle cx="${cx}" cy="${cyBuy}" r="3" fill="#198754" />
      								<circle cx="${cx}" cy="${cySell}" r="3" fill="#dc3545" />
      							</g>
      							`;
      						}).join('')}
      					</svg>
      				</div>
      			`;
      
         const last = chartData[chartData.length - 1];
         updateChartTooltip(last.date, last.buy, last.sell);
      }
      
      // H√†m c·∫≠p nh·∫≠t n·ªôi dung Tooltip
      function updateChartTooltip(date, buy, sell) {
         const box = document.getElementById('chart-tooltip-box');
         if (box) {
            box.classList.remove('d-none');
            document.getElementById('tt-date').textContent = date;
            document.getElementById('tt-buy').textContent = `M: ${formatCurrency(buy)}`;
            document.getElementById('tt-sell').textContent = `B: ${formatCurrency(sell)}`;
         }
      }
      
      // --- LOGIC T√çNH TO√ÅN PORTFOLIO & HI·ªÇN TH·ªä ---
      // --- LOGIC T√çNH TO√ÅN PORTFOLIO (C·∫¨P NH·∫¨T: FONT SIZE 0.8REM, B·ªé BOLD) ---
      function loadGoldPortfolio() {
         const listEl = document.getElementById('gold-history-list');
         listEl.innerHTML = '';
      
         if (goldPortfolioData.length === 0) {
            listEl.innerHTML = '<p class="text-center text-muted py-3">Ch∆∞a c√≥ giao d·ªãch n√†o</p>';
            return;
         }
      
         // 1. S·∫Øp x·∫øp giao d·ªãch
         const transactions = [...goldPortfolioData].sort((a, b) => new Date(a.date) - new Date(b.date));
      
         let totalHolding = 0;
         let avgCost = 0;
         let totalRealizedPNL = 0;
      
         const enrichedTransactions = [];
      
         // 2. PASS 1: T√≠nh to√°n
         for (let i = 0; i < transactions.length; i++) {
            const tx = {
               ...transactions[i],
               quantity_chi: Number(transactions[i].quantity_chi),
               price_per_chi: Number(transactions[i].price_per_chi)
            };
            let realizedPNL = 0;
      
            if (tx.type === 'buy') {
               const newTotalValue = (totalHolding * avgCost) + (tx.quantity_chi * tx.price_per_chi);
               const newTotalQty = totalHolding + tx.quantity_chi;
               avgCost = (newTotalQty > 0) ? (newTotalValue / newTotalQty) : 0;
               totalHolding = newTotalQty;
            } else if (tx.type === 'sell') {
               realizedPNL = (tx.price_per_chi - avgCost) * tx.quantity_chi;
               totalRealizedPNL += realizedPNL;
               totalHolding -= tx.quantity_chi;
            }
      
            enrichedTransactions.push({
               ...tx,
               avgCostAtTx: avgCost,
               realizedPNL_for_this_tx: realizedPNL
            });
         }
      
         // 3. PASS 2: Backward pass
         let currentBlockAvgCost = 0;
         if (enrichedTransactions.length > 0) {
            currentBlockAvgCost = enrichedTransactions[enrichedTransactions.length - 1].avgCostAtTx;
         }
         for (let i = enrichedTransactions.length - 1; i >= 0; i--) {
            const tx = enrichedTransactions[i];
            if (tx.type === 'sell') currentBlockAvgCost = tx.avgCostAtTx;
            tx.avgCostAtTx = currentBlockAvgCost;
         }
      
         // 4. T√çNH CH·ªà S·ªê T·ªîNG K·∫æT
         // a. T·ªïng v·ªën mua (Capital)
         const totalInvestedCapital = totalHolding * avgCost;
      
         // b. L√£i hi·ªán t·∫°i (Unrealized PNL) - S·ª¨A ƒê·ªîI ·ªû ƒê√ÇY
         let currentMarketBuyPrice = 0;
         if (typeof goldMarketData !== 'undefined' && goldMarketData.length > 0) {
            // L·∫•y gi√° MUA (buy) c·ªßa ng√†y m·ªõi nh·∫•t
            // (ƒê√¢y l√† gi√° ti·ªám v√†ng mua v√†o -> T·ª©c l√† gi√° m√¨nh c√≥ th·ªÉ b√°n ra ƒë·ªÉ ch·ªët l·ªùi)
            currentMarketBuyPrice = goldMarketData[goldMarketData.length - 1].buy;
         }
      
         let unrealizedPNL = 0;
         if (totalHolding > 0 && currentMarketBuyPrice > 0) {
            // C√¥ng th·ª©c: (Gi√° tr·ªã th·ªã tr∆∞·ªùng hi·ªán t·∫°i - T·ªïng v·ªën b·ªè ra)
            unrealizedPNL = (currentMarketBuyPrice * 1000 * totalHolding) - totalInvestedCapital;
         }
      
         // 5. HI·ªÇN TH·ªä DANH S√ÅCH (ƒê√É S·ª¨A CSS T·∫†I ƒê√ÇY)
         enrichedTransactions.reverse().forEach(tx => {
            const isBuy = tx.type === 'buy';
            const titleClass = isBuy ? 'text-success' : 'text-danger';
            const icon = isBuy ? 'bi-plus-circle' : 'bi-dash-circle';
            const titleText = isBuy ? 'MUA' : 'B√ÅN';
            const dateStr = new Date(tx.date).toLocaleDateString('vi-VN');
      
            let col4Html = '';
            if (!isBuy) {
               // [S·ª¨A]: B·ªè fw-bold, th√™m font-size: 0.8rem
               col4Html = `
      						<div class="text-center border-start">
      							<span class="text-muted" style="font-size: 0.65rem;">L√£i/L·ªó</span>
      							<p class="mb-0 ${tx.realizedPNL_for_this_tx >= 0 ? 'text-success' : 'text-danger'}" style="font-size: 0.8rem;">
      								${formatPNL(tx.realizedPNL_for_this_tx)}
      							</p>
      						</div>`;
            } else {
               col4Html = `<div class="text-center border-start"><span class="text-muted" style="font-size: 0.65rem;">-</span></div>`;
            }
      
            // [S·ª¨A]: B·ªè fw-bold, th√™m font-size: 0.8rem cho c√°c c·ªôt gi√° tr·ªã
            listEl.innerHTML += `
      					<div class="card mb-2 shadow-sm border-0">
      						<div class="card-body p-2">
      							<div class="d-flex justify-content-between align-items-center mb-2 pb-2 border-bottom">
      								<div>
      									<span class="fw-bold ${titleClass}"><i class="bi ${icon} me-1"></i>${titleText}</span>
      									<span class="text-muted small ms-2">${dateStr}</span>
      								</div>
      								<div class="d-flex gap-3">
      									<button class="btn btn-sm text-warning p-0" onclick="openEditGoldTx('${tx.id}')"><i class="bi bi-pencil-square"></i></button>
      									<button class="btn btn-sm text-danger p-0" onclick="deleteGoldTx('${tx.id}')"><i class="bi bi-trash"></i></button>
      								</div>
      							</div>
      							<div class="row g-0">
      								<div class="col-3 text-center">
      									<span class="text-muted" style="font-size: 0.65rem;">S·ªë l∆∞·ª£ng</span>
      									<p class="mb-0 text-dark" style="font-size: 0.8rem;">${tx.quantity_chi} ch·ªâ</p>
      								</div>
      								<div class="col-3 text-center border-start">
      									<span class="text-muted" style="font-size: 0.65rem;">Gi√° GD</span>
      									<p class="mb-0 text-dark" style="font-size: 0.8rem;">${formatCurrency(tx.price_per_chi)}</p>
      								</div>
      								<div class="col-3 text-center border-start">
      									<span class="text-muted" style="font-size: 0.65rem;">Gi√° V·ªën</span>
      									<p class="mb-0 text-dark" style="font-size: 0.8rem;">${formatCurrency(tx.avgCostAtTx)}</p>
      								</div>
      								<div class="col-3">${col4Html}</div>
      							</div>
      							${tx.note ? `<div class="mt-2 small text-muted fst-italic border-top pt-1">${tx.note}</div>` : ''}
      						</div>
      					</div>
      				`;
         });
      
         // 6. SUMMARY CARD
         const summaryHtml = `
      				<div class="card bg-light mb-3 border-primary shadow-sm">
      					<div class="card-body p-2">
      						<div class="row text-center mb-2">
      							<div class="col-6 border-end">
      								<small class="text-muted text-uppercase" style="font-size: 0.7rem;">T·ªïng s·ªë l∆∞·ª£ng</small>
      								<div class="fw-bold theme-text-primary fs-5">${totalHolding.toFixed(2)} ch·ªâ</div>
      							</div>
      							<div class="col-6">
      								 <small class="text-muted text-uppercase" style="font-size: 0.7rem;">T·ªïng v·ªën mua</small>
      								 <div class="fw-bold text-dark fs-5">${formatCurrency(totalInvestedCapital)}</div>
      							</div>
      						</div>
      						<div class="row text-center border-top pt-2">
      							<div class="col-6 border-end">
      								<small class="text-muted text-uppercase" style="font-size: 0.7rem;">L√£i hi·ªán t·∫°i</small>
      								<div class="fw-bold fs-6">${formatPNL(unrealizedPNL)}</div>
      							</div>
      							<div class="col-6">
      								<small class="text-muted text-uppercase" style="font-size: 0.7rem;">L√£i ƒë√£ ch·ªët</small>
      								<div class="fw-bold fs-6">${formatPNL(totalRealizedPNL)}</div>
      							</div>
      						</div>
      					</div>
      				</div>
      			`;
         listEl.insertAdjacentHTML('afterbegin', summaryHtml);
      }
      
      // H√†m x√≥a giao d·ªãch
      async function deleteGoldTx(id) {
         if (!confirm("X√≥a giao d·ªãch n√†y?")) return;
         showLoading();
         try {
            await sendToServer({
               action: 'delete_gold_transaction',
               id: id
            });
            showToast('ƒê√£ x√≥a');
            showGoldStats(); // Reload l·∫°i
         } catch (e) {
            showToast('L·ªói x√≥a');
         }
         hideLoading();
      }
      
      function renderStats() {
         const container = document.getElementById('stats-container');
         const leftColumn = statsLayout.filter(s => s.column === 0);
         const rightColumn = statsLayout.filter(s => s.column === 1);
         const hasRightColumn = rightColumn.length > 0;
      
         if (hasRightColumn) container.classList.add('two-columns');
         else container.classList.remove('two-columns');
      
         const renderCard = (stat) => {
            const sizeClass = `size-${stat.size}`;
      
            // T√¨m ƒëo·∫°n code n√†y trong h√†m renderStats()
            if (stat.id === 'bike') {
      
               // --- TH√äM ƒêO·∫†N T√çNH TU·ªîI THAI N√ÄY V√ÄO ---
               const dueDate = new Date('2026-04-26'); // Ng√†y d·ª± sinh c·ªßa b·∫°n
               const today = new Date();
      
               // Reset gi·ªù v·ªÅ 0h ƒë·ªÉ t√≠nh ng√†y cho chu·∫©n
               dueDate.setHours(0, 0, 0, 0);
               today.setHours(0, 0, 0, 0);
      
               // T√≠nh ng√†y b·∫Øt ƒë·∫ßu thai k·ª≥ (D·ª± sinh - 280 ng√†y)
               const startDate = new Date(dueDate);
               startDate.setDate(dueDate.getDate() - 280);
      
               // T√≠nh s·ªë ng√†y ƒë√£ qua
               const diffTime = today - startDate;
               const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
      
               // ƒê·ªïi ra tu·∫ßn v√† ng√†y l·∫ª
               const weeks = Math.floor(diffDays / 7);
               const days = diffDays % 7;
      
               const babyAgeText = `Em b√© ${weeks} tu·∫ßn ${days} ng√†y`;
               // ----------------------------------------
      
               return `
      				<div class="stat-card p-3 ${sizeClass}" data-stat-id="bike" draggable="${isEditMode}">
      				  <div class="drag-handle"><i class="bi bi-arrows-move"></i></div>
      				  <div class="size-toggle"><i class="bi bi-arrows-fullscreen"></i></div>
      				  <button class="btn btn-link p-0 position-absolute top-0 end-0 m-2 text-muted bike-chart-btn" style="z-index: 5;">
      					<i class="bi bi-bar-chart-fill fs-5"></i>
      				  </button>
      				  <div class="text-center">
      					<div class="icon-box theme-bg-primary text-white mx-auto mb-2 baby-run-btn" style="cursor: pointer; transition: transform 0.1s;">
      					  <span style="font-size: 32px; filter: brightness(0) invert(1);">üë£</span>
      					</div>
      					
      					<p class="text-muted small mb-1 fw-bold theme-text-primary">${babyAgeText}</p>
      					
      					<p id="bike-count" class="fs-2 fw-bold theme-text-primary mb-0">0</p>
      				  </div>
      				</div>
      			  `;
            } else if (stat.id === 'gold') {
               return `
      				<div class="stat-card p-3 ${sizeClass}" data-stat-id="gold" draggable="${isEditMode}">
      				  <div class="drag-handle"><i class="bi bi-arrows-move"></i></div>
      				  <div class="size-toggle"><i class="bi bi-arrows-fullscreen"></i></div>
      				  <button class="btn btn-link p-0 position-absolute top-0 end-0 m-2 text-muted gold-chart-btn" style="z-index: 5;">
      					<i class="bi bi-bar-chart-fill fs-5"></i>
      				  </button>
      				  <div class="d-flex align-items-center mb-2">
      					<div class="icon-box text-white me-3" style="background: #f59e0b;">
      					  <i class="bi bi-coin fs-4"></i>
      					</div>
      					<div>
      					  <p class="text-muted small mb-1">Gi√° v√†ng</p>
      					</div>
      				  </div>
      				  <div class="row g-2 ms-5 ps-2">
      					<div class="col-6">
      					  <small class="text-muted">Gi√° mua</small>
      					  <p id="gold-buy" class="fs-5 fw-bold text-success mb-0">-</p>
      					</div>
      					<div class="col-6">
      					  <small class="text-muted">Gi√° b√°n</small>
      					  <p id="gold-sell" class="fs-5 fw-bold text-danger mb-0">-</p>
      					</div>
      				  </div>
      				</div>
      			  `;
            }
            return '';
         };
      
         if (hasRightColumn) {
            container.innerHTML = leftColumn.map(renderCard).join('') + rightColumn.map(renderCard).join('');
         } else {
            container.innerHTML = leftColumn.map(renderCard).join('');
         }
      
         if (isEditMode) {
            container.classList.add('layout-edit-mode');
            setupDragAndDrop();
         } else {
            container.classList.remove('layout-edit-mode');
         }
      }
      
      function setupDragAndDrop() {
         const cards = document.querySelectorAll('.stat-card');
      
         cards.forEach(card => {
            card.addEventListener('dragstart', (e) => {
               draggedElement = card;
               draggedId = card.dataset.statId;
               card.classList.add('dragging');
               e.dataTransfer.effectAllowed = 'move';
            });
      
            card.addEventListener('dragend', () => {
               card.classList.remove('dragging');
               document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('border', 'border-primary'));
               draggedElement = null;
               draggedId = null;
            });
      
            card.addEventListener('dragover', (e) => {
               e.preventDefault();
               if (draggedElement === card) return;
               card.classList.add('border', 'border-primary');
            });
      
            card.addEventListener('dragleave', () => {
               card.classList.remove('border', 'border-primary');
            });
      
            card.addEventListener('drop', (e) => {
               e.preventDefault();
               if (!draggedId || draggedElement === card) return;
      
               const targetId = card.dataset.statId;
               const draggedStat = statsLayout.find(s => s.id === draggedId);
               const targetStat = statsLayout.find(s => s.id === targetId);
      
               if (!draggedStat || !targetStat) return;
      
               const rect = card.getBoundingClientRect();
               const midX = rect.left + rect.width / 2;
               let newColumn = targetStat.column;
      
               if (e.clientX < midX && targetStat.column === 1) newColumn = 0;
               else if (e.clientX >= midX && targetStat.column === 0) newColumn = 1;
      
               statsLayout = statsLayout.filter(s => s.id !== draggedId);
               draggedStat.column = newColumn;
      
               const newTargetIndex = statsLayout.indexOf(targetStat);
               if (newTargetIndex >= 0) {
                  if (e.clientX < midX) statsLayout.splice(newTargetIndex, 0, draggedStat);
                  else statsLayout.splice(newTargetIndex + 1, 0, draggedStat);
               } else {
                  statsLayout.push(draggedStat);
               }
      
               card.classList.remove('border', 'border-primary');
               renderStats();
               updateStats();
            });
      
            const sizeToggle = card.querySelector('.size-toggle');
            sizeToggle.addEventListener('click', (e) => {
               e.stopPropagation();
               const statId = card.dataset.statId;
               const stat = statsLayout.find(s => s.id === statId);
               if (!stat) return;
      
               const sizes = ['small', 'medium', 'large'];
               const currentIndex = sizes.indexOf(stat.size);
               stat.size = sizes[(currentIndex + 1) % sizes.length];
      
               renderStats();
               updateStats();
            });
         });
      }
      
      function enterEditMode() {
         isEditMode = true;
         document.getElementById('edit-mode-banner').classList.remove('d-none');
         profileModal.hide();
      
         currentTab = 'home';
         document.querySelectorAll('.nav-link').forEach(b => b.classList.remove('active'));
         document.querySelector('[data-tab="home"]').classList.add('active');
      
         document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('d-none'));
         document.getElementById('tab-home').classList.remove('d-none');
      
         renderStats();
         updateStats();
      }
      
      function exitEditMode() {
         isEditMode = false;
         document.getElementById('edit-mode-banner').classList.add('d-none');
         renderStats();
         updateStats();
         saveLayoutToProfile();
      }
      
      async function saveLayoutToProfile() {
         if (!currentProfile) {
            if (recordCount >= 999) {
               showToast('ƒê√£ ƒë·∫°t gi·ªõi h·∫°n 999 m·ª•c!');
               return;
            }
      
            const result = await window.dataSdk.create({
               type: 'profile',
               username: '',
               fullName: '',
               avatarData: '',
               themeName: currentTheme,
               statsLayout: JSON.stringify(statsLayout),
               createdAt: new Date().toISOString()
            });
      
            if (result.isOk) showToast('ƒê√£ l∆∞u b·ªë c·ª•c!');
         } else {
            await window.dataSdk.update({
               ...currentProfile,
               statsLayout: JSON.stringify(statsLayout)
            });
            showToast('ƒê√£ l∆∞u b·ªë c·ª•c!');
         }
      }
      
      function renderPostImages(images, layout) {
         if (!images || images.length === 0) return '';
         const count = images.length;
         let layoutClass = '';
      
         // Logic ch·ªçn class CSS
         if (count === 1) {
            layoutClass = 'layout-1';
         } else if (count === 2) {
            layoutClass = 'layout-2';
         } else {
            // T·ª´ 3 ·∫£nh tr·ªü l√™n -> X√©t theo Layout
            // M·∫∑c ƒë·ªãnh n·∫øu kh√¥ng c√≥ layout ho·∫∑c layout l·ªói th√¨ v·ªÅ grid-2x2
            const validLayout = layout || 'grid-2x2';
      
            if (validLayout === '1-wide') {
               layoutClass = 'layout-1-wide';
            } else if (validLayout === '1-tall') {
               layoutClass = 'layout-1-tall';
            } else {
               // M·∫∑c ƒë·ªãnh l√† Grid 2x2
               layoutClass = 'layout-grid-2x2';
            }
         }
      
         let html = `<div class="post-image-grid ${layoutClass}">`;
      
         // S·ªë l∆∞·ª£ng ·∫£nh t·ªëi ƒëa ƒë∆∞·ª£c hi·ªÉn th·ªã (t√πy theo layout m√† hi·ªÉn th·ªã 3, 4 hay 5 ·∫£nh)
         // ƒê·ªÉ ƒë∆°n gi·∫£n v√† ƒë·∫πp, ta hi·ªÉn th·ªã t·ªëi ƒëa 4 khung ·∫£nh (n·∫øu > 4 th√¨ hi·ªán s·ªë +)
         // Ho·∫∑c v·ªõi layout 1-wide/1-tall th√¨ hi·ªÉn th·ªã 3 khung.
      
         let displayLimit = 4;
         if (layoutClass === 'layout-1-wide' || layoutClass === 'layout-1-tall') {
            displayLimit = 3; // Layout n√†y ch·ªâ ƒë·∫πp khi hi·ªán 3 ·∫£nh (1 to 2 nh·ªè)
         }
      
         const showCount = Math.min(count, displayLimit);
      
         for (let i = 0; i < showCount; i++) {
            html += `<div class="img-box">`;
            html += `<img src="${images[i]}" alt="Image">`;
      
            // N·∫øu l√† ·∫£nh cu·ªëi c√πng ƒë∆∞·ª£c v·∫Ω V√Ä t·ªïng s·ªë ·∫£nh nhi·ªÅu h∆°n s·ªë ch·ªó hi·ªÉn th·ªã
            if (i === showCount - 1 && count > displayLimit) {
               html += `<div class="image-overlay">+${count - displayLimit}</div>`;
            }
      
            html += `</div>`;
         }
      
         html += '</div>';
         return html;
      }
      
      // --- H√ÄM RENDER POSTS (ƒê√£ th√™m S·∫Øp x·∫øp M·ªõi -> C≈©) ---
      // H√†m t·∫°o HTML cho 1 b√†i vi·∫øt (T√°ch ra ƒë·ªÉ t√°i s·ª≠ d·ª•ng)
      // --- H√ÄM T·∫†O HTML CHO 1 B√ÄI VI·∫æT (FULL) ---
      // --- H√ÄM T·∫†O HTML B√ÄI VI·∫æT (FULL V·ªöI COMMENT) ---
      // --- H√ÄM T·∫†O HTML B√ÄI VI·∫æT (C·∫¨P NH·∫¨T HEADER: T√äN ¬∑ TH·ªúI GIAN) ---
      // --- H√ÄM T·∫†O HTML B√ÄI VI·∫æT (ƒê√É S·ª¨A: NG√ÄY GI·ªú XU·ªêNG D√íNG NH∆Ø C≈®) ---
      // --- H√ÄM T·∫†O HTML B√ÄI VI·∫æT (ƒê√É CƒÇN CH·ªàNH N√öT LIKE TH·∫≤NG H√ÄNG) ---
      // --- H√ÄM T·∫†O HTML CHO 1 B√ÄI VI·∫æT (FULL) ---
		function createPostHtml(post) {
			// 1. Chu·∫©n b·ªã d·ªØ li·ªáu c∆° b·∫£n
			const displayName = post.fullname || post.username || 'Ng∆∞·ªùi d√πng';
			const avatarUrl = post.avatar;
			const images = parseImages(post.imageData);
			
			// Ki·ªÉm tra xem ng∆∞·ªùi ƒëang xem c√≥ ph·∫£i ch·ªß b√†i vi·∫øt kh√¥ng
			const isOwner = currentProfile && currentProfile.username === post.username;

			// Icon t√≠ch xanh (ch·ªâ hi·ªán cho ch·ªß s·ªü h·ªØu - t√πy ch·ªânh logic c·ªßa b·∫°n)
			const verifiedIcon = isOwner ? `<i class="bi bi-patch-check-fill text-primary ms-1"></i>` : '';

			// X·ª≠ l√Ω Avatar (·∫¢nh ho·∫∑c Ch·ªØ c√°i ƒë·∫ßu)
			const avatarHtml = avatarUrl ?
				`<img src="${avatarUrl}" class="w-100 h-100 object-fit-cover" alt="Avatar">` :
				`<div class="w-100 h-100 d-flex align-items-center justify-content-center bg-light text-primary fw-bold fs-5">${displayName.charAt(0).toUpperCase()}</div>`;

			// -----------------------------------------------------------
			// [QUAN TR·ªåNG] X·ª≠ l√Ω g√≥c tr√™n b√™n ph·∫£i (Tr·∫°ng th√°i Upload / Menu)
			// -----------------------------------------------------------
			let statusBadge = '';

			if (post.isUploading) {
				// TR∆Ø·ªúNG H·ª¢P 1: ƒêang ƒëƒÉng b√†i -> Hi·ªán Spinner + Text tr·∫°ng th√°i
				// ID n√†y (status-badge-...) s·∫Ω ƒë∆∞·ª£c h√†m updatePostStatus t√¨m ƒë·ªÉ c·∫≠p nh·∫≠t ch·ªØ
				statusBadge = `
				   <div id="status-badge-${post.__backendId}" class="ms-auto d-flex align-items-center text-muted small">
					  <span class="spinner-border spinner-border-sm me-1" style="width: 0.8rem; height: 0.8rem;"></span>
					  ${post.uploadStatus || 'ƒêang x·ª≠ l√Ω...'}
				   </div>
				`;
			} else if (isOwner) {
				// TR∆Ø·ªúNG H·ª¢P 2: B√†i ƒë√£ ƒëƒÉng & L√† ch·ªß b√†i vi·∫øt -> Hi·ªán n√∫t 3 ch·∫•m
				statusBadge = `
					<button class="btn btn-sm btn-link text-muted post-menu-btn ms-auto" data-id="${post.__backendId}">
						<i class="bi bi-three-dots"></i>
					</button>
				`;
			} else {
				// TR∆Ø·ªúNG H·ª¢P 3: B√†i ng∆∞·ªùi kh√°c -> ƒê·ªÉ tr·ªëng
				statusBadge = '<div class="ms-auto"></div>';
			}
			// -----------------------------------------------------------

			// X·ª≠ l√Ω n√∫t Like (Tim ƒë·ªè hay Tim r·ªóng)
			const heartIconClass = post.liked ? 'bi-heart-fill text-danger' : 'bi-heart';
			const likeCountText = post.likes > 0 ? post.likes : 'Th√≠ch';
			const likeBtnClass = post.liked ? 'active' : '';

			// X·ª≠ l√Ω th·ªùi gian hi·ªÉn th·ªã
			const timeDisplay = formatTimeSmart(post.timestamp || post.createdAt);

			// -----------------------------------------------------------
			// X·ª≠ l√Ω hi·ªÉn th·ªã B√¨nh lu·∫≠n (Hi·ªán 2 c√°i ƒë·∫ßu, c√≤n l·∫°i ·∫©n)
			// -----------------------------------------------------------
			let commentsHtml = '';
			const comments = post.commentsData || []; // D·ªØ li·ªáu comment ƒë√≠nh k√®m (n·∫øu c√≥)
			
			if (comments.length > 0) {
				const visibleComments = comments.slice(0, 2);
				const hiddenComments = comments.slice(2);
				
				// T·∫°o HTML cho c√°c comment hi·ªÉn th·ªã
				let commentListHtml = visibleComments.map(c => createCommentHtml(c)).join('');

				// N·∫øu c√≤n comment ·∫©n -> T·∫°o n√∫t "Xem th√™m"
				if (hiddenComments.length > 0) {
					const hiddenHtml = hiddenComments.map(c => createCommentHtml(c)).join('');
					commentListHtml += `
						<div id="hidden-comments-${post.__backendId}" class="d-none fade-in">
							${hiddenHtml}
						</div>
						<div class="text-start ms-5">
							<button class="btn btn-link btn-sm p-0 text-decoration-none text-muted fw-bold" style="font-size: 0.8rem;"
									onclick="document.getElementById('hidden-comments-${post.__backendId}').classList.remove('d-none'); this.remove();">
								Xem th√™m ${hiddenComments.length} b√¨nh lu·∫≠n kh√°c...
							</button>
						</div>`;
				}
				commentsHtml = `<div class="comments-section mt-0 fade-in"><div id="comments-container-${post.__backendId}">${commentListHtml}</div></div>`;
			} else {
				// N·∫øu ch∆∞a c√≥ comment, t·∫°o container r·ªóng ƒë·ªÉ ch·ªù append
				commentsHtml = `<div class="comments-section mt-2" id="comments-container-${post.__backendId}"></div>`;
			}

			// -----------------------------------------------------------
			// TR·∫¢ V·ªÄ HTML FULL
			// -----------------------------------------------------------
			return `
				<div class="post-card p-3 fade-in" id="post-${post.__backendId}">
					
					<div class="d-flex align-items-center mb-2">
						<div class="avatar-circle avatar-circle-sm me-2 overflow-hidden border">
							${avatarHtml}
						</div>
						<div>
							<p class="mb-0 d-flex align-items-center post-author-name"> 
								${displayName} ${verifiedIcon}
							</p>
							<div class="post-timestamp"> 
								${timeDisplay}
							</div>
						</div>
						${statusBadge}
					</div>
					
					${post.content ? `<div class="post-content-text">${processTextWithHashtags(post.content)}</div>` : ''}
					${renderPostImages(images, post.layout || 'grid-2x2')}
					
					<div class="d-flex gap-4 my-2" style="margin-left: 15px !important;">
						<button class="btn btn-sm btn-link text-decoration-none text-muted d-flex align-items-center justify-content-start ps-0 gap-2 like-btn ${likeBtnClass}" 
								data-id="${post.__backendId}" ${post.isUploading ? 'disabled' : ''}>
							<i class="bi ${heartIconClass} fs-5"></i>
							<span>${likeCountText}</span>
						</button>
						
						<button class="btn btn-sm btn-link text-decoration-none text-muted d-flex align-items-center justify-content-start gap-2 show-comment-input-btn" 
								data-id="${post.__backendId}" ${post.isUploading ? 'disabled' : ''}>
							<i class="bi bi-chat fs-5"></i>
							<span>B√¨nh lu·∫≠n</span>
						</button>
					</div>

					${commentsHtml}

					<div class="d-flex align-items-center mt-2 gap-2 d-none" id="comment-input-box-${post.__backendId}">
						<input type="text" class="form-control form-control-sm rounded-pill bg-light border-0" 
							   id="input-cmt-${post.__backendId}" placeholder="Vi·∫øt b√¨nh lu·∫≠n...">
						<button class="btn btn-sm btn-primary rounded-circle send-inline-cmt-btn" data-id="${post.__backendId}">
							<i class="bi bi-send-fill"></i>
						</button>
					</div>
				</div>
			`;
		}
      
      // H√†m Render ch√≠nh (H·ªó tr·ª£ Append)
      function renderPostsPaged(newPosts, page) {
         const container = document.getElementById('posts-container');
      
         // X√≥a trigger c≈©
         const oldTrigger = document.getElementById('feed-load-more');
         if (oldTrigger) oldTrigger.remove();
      
         // N·∫øu trang 1: X√≥a tr·∫Øng container v√† check r·ªóng
         if (page === 1) {
            container.innerHTML = '';
            if (!newPosts || newPosts.length === 0) {
               container.innerHTML = `
      						<div class="text-center py-5">
      							<i class="bi bi-newspaper theme-text-primary" style="font-size: 4rem;"></i>
      							<p class="fw-semibold fs-5 mt-3">Ch∆∞a c√≥ b√†i ƒëƒÉng</p>
      							<p class="text-muted">Nh·∫•n + ƒë·ªÉ t·∫°o b√†i vi·∫øt ƒë·∫ßu ti√™n</p>
      						</div>
      					`;
               return;
            }
         }
      
         // Append b√†i m·ªõi
         let html = newPosts.map(post => createPostHtml(post)).join('');
         container.insertAdjacentHTML('beforeend', html);
      
         // Th√™m Trigger Load More n·∫øu c√≤n d·ªØ li·ªáu
         // Th√™m Trigger Load More n·∫øu c√≤n d·ªØ li·ªáu
		if (feedHasMore) {
			const trigger = document.createElement('div');
			trigger.id = 'feed-load-more';
			trigger.className = 'py-4 text-center text-muted small';
			trigger.innerHTML = `<div class="spinner-border spinner-border-sm text-secondary" role="status"></div> ƒêang t·∫£i th√™m tin...`;

			// G√°n h√†m callback tr·ª±c ti·∫øp v√†o element
			trigger._onIntersect = () => {
				if (!feedLoading) {
					feedPage++;
					loadFeedData(feedPage);
				}
			};

			container.appendChild(trigger);
			
			// Y√™u c·∫ßu Observer to√†n c·ª•c theo d√µi ph·∫ßn t·ª≠ n√†y
			globalScrollObserver.observe(trigger);
		} else if (page > 1) {
            // ƒê√£ h·∫øt tin ƒë·ªÉ load
            container.insertAdjacentHTML('beforeend', '<div class="text-center py-4 text-muted small">--- B·∫°n ƒë√£ xem h·∫øt tin ---</div>');
         }
      }
      
      // Gi·ªØ l·∫°i h√†m renderPosts c≈© (nh∆∞ng g·ªçi sang h√†m m·ªõi) ƒë·ªÉ t∆∞∆°ng th√≠ch v·ªõi c√°c ƒëo·∫°n code kh√°c g·ªçi n√≥
      function renderPosts() {
         // H√†m n√†y ch·ªß y·∫øu d√πng khi Create/Edit post xong mu·ªën v·∫Ω l·∫°i t·∫•t c·∫£
         // Trong logic m·ªõi, t·ªët nh·∫•t l√† ch·ªâ render l·∫°i t·ª´ ƒë·∫ßu m·∫£ng serverFeedData
         renderPostsPaged(serverFeedData, 1);
      }
      
      function renderAlbums() {
         const container = document.getElementById('albums-container');
         const albums = allData.filter(d => d.type === 'album').sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      
         if (albums.length === 0) {
            container.innerHTML = `
      			  <div class="col-12 text-center py-5">
      				<i class="bi bi-folder theme-text-primary" style="font-size: 4rem;"></i>
      				<p class="fw-semibold fs-5 mt-3">Ch∆∞a c√≥ album</p>
      				<p class="text-muted">T·∫°o album ƒë·ªÉ s·∫Øp x·∫øp ·∫£nh</p>
      			  </div>
      			`;
            return;
         }
      
         container.innerHTML = albums.map(album => {
            const photos = allData.filter(d => d.type === 'album_photo' && d.albumId === album.__backendId);
            const coverImg = photos[0]?.imageData;
      
            return `
      			  <div class="col-6">
      				<div class="album-card album-item" data-album-id="${album.__backendId}" style="cursor: pointer;">
      				  <div class="ratio ratio-1x1 bg-light rounded-top overflow-hidden">
      					${coverImg 
      					  ? `<img src="${coverImg}" class="object-fit-cover" alt="Album">`
      					  : `<div class="d-flex align-items-center justify-content-center"><i class="bi bi-folder theme-text-primary" style="font-size: 3rem;"></i></div>`
      					}
      				  </div>
      				  <div class="p-2">
      					<p class="fw-bold mb-0 text-truncate">${album.albumName}</p>
      					<small class="text-muted">${photos.length} ·∫£nh</small>
      				  </div>
      				</div>
      			  </div>
      			`;
         }).join('');
      }
      
      function renderAlbumPhotos() {
         const container = document.getElementById('album-photos');
         const photos = allData.filter(d => d.type === 'album_photo' && d.albumId === currentAlbumId);
      
         if (photos.length === 0) {
            container.innerHTML = `
      			  <div class="col-12 text-center py-5 text-muted">
      				<i class="bi bi-camera" style="font-size: 3rem;"></i>
      				<p class="mt-2">Ch∆∞a c√≥ ·∫£nh</p>
      			  </div>
      			`;
            return;
         }
      
         container.innerHTML = photos.map(photo => `
      			<div class="col-4">
      			  <div class="position-relative">
      				<img src="${photo.imageData}" class="w-100 rounded ratio ratio-1x1 object-fit-cover" alt="Photo">
      				<button class="btn btn-danger btn-sm position-absolute top-0 end-0 m-1 delete-photo-btn" data-id="${photo.__backendId}">
      				  <i class="bi bi-x-lg"></i>
      				</button>
      			  </div>
      			</div>
      		  `).join('');
      }
      
      function renderComments(postId) {
         const post = allData.find(d => d.__backendId === postId);
         if (!post) return;
      
         const comments = parseComments(post.comments);
         const container = document.getElementById('comments-list');
      
         if (comments.length === 0) {
            container.innerHTML = `<p class="text-center text-muted py-5">Ch∆∞a c√≥ b√¨nh lu·∫≠n</p>`;
            return;
         }
      
         container.innerHTML = comments.map(comment => `
      			<div class="card mb-2">
      			  <div class="card-body p-3">
      				<div class="d-flex align-items-center mb-2">
      				  <div class="avatar-circle avatar-circle-sm me-2" style="width: 32px; height: 32px;">
      					<span class="small theme-text-primary fw-bold">${comment.author?.[0]?.toUpperCase() || 'U'}</span>
      				  </div>
      				  <div>
      					<p class="fw-bold small mb-0">${comment.author || 'Ng∆∞·ªùi d√πng'}</p>
      					<small class="text-muted">${formatDate(comment.time)}</small>
      				  </div>
      				</div>
      				<p class="mb-0 ms-5">${comment.text}</p>
      			  </div>
      			</div>
      		  `).join('');
      }
      
      function updateImagePreview() {
         const previewContainer = document.getElementById('image-preview-container');
         const imageOptions = document.getElementById('image-options'); // [M·ªöI]
         const layoutSelector = document.getElementById('layout-selector');
         const postBtn = document.getElementById('post-btn');
         const imageCount = document.getElementById('image-count');
         const gridContainer = document.getElementById('images-preview-grid');
      
         if (currentImages.length === 0) {
            previewContainer.classList.add('d-none');
            imageOptions.classList.add('d-none'); // ·∫®n n√∫t HD
            layoutSelector.classList.add('d-none'); // ·∫®n Layout
            postBtn.disabled = !document.getElementById('post-input').value.trim();
            return;
         }
      
         // Hi·ªÉn th·ªã container ·∫£nh
         previewContainer.classList.remove('d-none');
         imageCount.textContent = currentImages.length;
         postBtn.disabled = false;
      
         // [LOGIC M·ªöI] Hi·ªÉn th·ªã n√∫t HD ngay khi c√≥ ·∫£nh
         imageOptions.classList.remove('d-none');
      
         // [LOGIC M·ªöI] Ch·ªâ hi·ªÉn th·ªã ch·ªçn Layout n·∫øu >= 3 ·∫£nh
         if (currentImages.length >= 3) {
            layoutSelector.classList.remove('d-none');
         } else {
            layoutSelector.classList.add('d-none');
         }
      
         gridContainer.innerHTML = renderPostImages(currentImagePreviews, selectedLayout);
      }
      
      // S·ª≠a th√™m: N√∫t x√≥a t·∫•t c·∫£
      document.getElementById('clear-all-images').addEventListener('click', () => {
         currentImages = [];
         currentImagePreviews = [];
         updateImagePreview();
      });
      
      function compressImage(file, maxWidth = 1920, quality = 0.8) {
         return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
               const img = new Image();
               img.onload = () => {
                  const canvas = document.createElement('canvas');
                  let width = img.width;
                  let height = img.height;
      
                  // Resize th√¥ng minh: Ch·ªâ thu nh·ªè n·∫øu ·∫£nh qu√° l·ªõn (>1920px)
                  if (width > maxWidth) {
                     height = (height * maxWidth) / width;
                     width = maxWidth;
                  }
      
                  canvas.width = width;
                  canvas.height = height;
                  const ctx = canvas.getContext('2d');
      
                  // V·∫Ω ·∫£nh l√™n canvas (l√†m m·ªãn ·∫£nh)
                  ctx.imageSmoothingEnabled = true;
                  ctx.imageSmoothingQuality = 'high';
                  ctx.drawImage(img, 0, 0, width, height);
      
                  // Xu·∫•t ra Base64 ch·∫•t l∆∞·ª£ng cao
                  resolve(canvas.toDataURL('image/jpeg', quality));
               };
               img.src = e.target.result;
            };
            reader.readAsDataURL(file);
         });
      }
      
      // Notifications
      // --- X·ª¨ L√ù TH√îNG B√ÅO (NOTIFICATIONS) ---
      
      // 1. N√∫t ƒê√°nh d·∫•u t·∫•t c·∫£ ƒë√£ ƒë·ªçc
		document.getElementById('mark-all-read').addEventListener('click', async () => {
			// [S·ª¨A] Ch·ªçn ƒë√∫ng class m·ªõi l√† .notification-content-box
			const unreadItems = document.querySelectorAll('.notification-content-box.unread');
			
			unreadItems.forEach(el => {
			   // 1. B·ªè class unread (ƒë·ªÉ ƒë·ªïi m√†u n·ªÅn)
			   el.classList.remove('unread');
			   
			   // 2. T√¨m v√† x√≥a ch·∫•m ƒë·ªè b√™n trong
			   const dot = el.querySelector('.notification-dot');
			   if (dot) dot.remove();
			});
		 
			// 3. ·∫®n s·ªë ƒë·ªè tr√™n thanh Header
			const badge = document.getElementById('notification-badge');
			if (badge) badge.classList.add('d-none');
		 
			showToast('ƒê√£ ƒë√°nh d·∫•u t·∫•t c·∫£ ƒë√£ ƒë·ªçc');
		 
			// 4. G·ª≠i l√™n Server (Gi·ªØ nguy√™n)
			try {
			   await sendToServer({
				  action: 'notification_action',
				  type: 'mark_all_read'
			   });
			} catch (e) {
			   console.error("L·ªói sync:", e);
			}
		 });
      
      // 2. N√∫t X√≥a t·∫•t c·∫£ th√¥ng b√°o
      document.getElementById('clear-all-notifications').addEventListener('click', async () => {
         showDeleteConfirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·∫°ch l·ªãch s·ª≠ th√¥ng b√°o kh√¥ng?', null, 'all-notifications');
      });
       
      
      
      // Navigation ƒëi·ªÅu h∆∞·ªõng 
      // --- S·ª¨A L·∫†I LOGIC CHUY·ªÇN TAB ---
      document.querySelectorAll('.nav-link').forEach(btn => {
         btn.addEventListener('click', () => {
      
            if (isEditMode) {
               showToast('Vui l√≤ng tho√°t ch·∫ø ƒë·ªô ch·ªânh s·ª≠a tr∆∞·ªõc!');
               return;
            }
      
            // --> TH√äM D√íNG N√ÄY: ƒê√≥ng m·ªçi modal ƒëang m·ªü tr∆∞·ªõc khi chuy·ªÉn tab
            closeAllModals();
      
            const targetTab = btn.dataset.tab; // feed, home, albums
      
            // 1. C·∫≠p nh·∫≠t UI Active cho n√∫t b·∫•m
            document.querySelectorAll('.nav-link').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
      
            // 2. ·∫®n/Hi·ªán Tab Content (Ch·ªâ thao t√°c CSS, kh√¥ng ƒë·ª•ng v√†o d·ªØ li·ªáu)
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('d-none'));
            document.getElementById(`tab-${targetTab}`).classList.remove('d-none');
      
            currentTab = targetTab;
      
            // 3. X·ª≠ l√Ω n√∫t FAB (N√∫t tr√≤n +)
            const fabBtn = document.getElementById('fab-btn');
            if (currentTab === 'feed') fabBtn.classList.remove('d-none');
            else fabBtn.classList.add('d-none');
      
            // 4. [T·ªêI ∆ØU] KH√îNG RESET D·ªÆ LI·ªÜU KHI CHUY·ªÇN TAB
            // Ch·ªâ t·∫£i l·∫ßn ƒë·∫ßu ti√™n n·∫øu ch∆∞a c√≥ d·ªØ li·ªáu
            if (currentTab === 'feed' && serverFeedData.length === 0) {
               loadFeedData(1);
            } else if (currentTab === 'home') {
               // Home th√¨ c√≥ th·ªÉ update nh·∫π s·ªë li·ªáu n·∫øu mu·ªën
               updateStats();
            } else if (currentTab === 'search') {
				// Focus v√†o √¥ t√¨m ki·∫øm khi m·ªü tab
				setTimeout(() => {
					const input = document.getElementById('smart-search-input');
					if(input) input.focus();
				}, 100);
			}
         });
      });
      
      // --- X·ª¨ L√ù N√öT CHU√îNG (M·ªû MODAL & LOAD D·ªÆ LI·ªÜU) ---
      // --- 3. C·∫¨P NH·∫¨T S·ª∞ KI·ªÜN CLICK N√öT CHU√îNG ---
      // Khi ·∫•n v√†o chu√¥ng -> ·∫®n s·ªë ƒë·ªè ƒëi (Gi·∫£ ƒë·ªãnh ng∆∞·ªùi d√πng ƒë√£ xem)
      document.getElementById('notification-btn').addEventListener('click', () => {
      
         // --> TH√äM D√íNG N√ÄY
         closeAllModals();
      
         notificationsModal.show();
      
         // 1. ·∫®n badge ƒë·ªè ngay (UI ph·∫£n h·ªìi t·ª©c th√¨)
         const badge = document.getElementById('notification-badge');
         badge.classList.add('d-none');
         badge.textContent = '0';
      
         const container = document.getElementById('notifications-list');
      
         // 2. KI·ªÇM TRA & HI·ªÇN TH·ªä D·ªÆ LI·ªÜU T·ª™ CACHE
         if (serverNotifications.length > 0) {
            // [FIX] N·∫øu ƒë√£ c√≥ d·ªØ li·ªáu ng·∫ßm, ph·∫£i V·∫º RA NGAY
            container.innerHTML = '';
            renderNotificationsPaged(serverNotifications, container);
         } else {
            // N·∫øu ch∆∞a c√≥ g√¨ (m·ªõi m·ªü web), hi·ªán Spinner quay
            container.innerHTML = '<div class="d-flex justify-content-center align-items-center py-5"><div class="spinner-border text-primary" role="status"></div></div>';
         }
      
         // 3. LU√îN G·ªåI SERVER ƒê·ªÇ L·∫§Y TIN M·ªöI NH·∫§T (Silent Refresh)
         // ƒê·ªÉ ƒë·∫£m b·∫£o n·∫øu c√≥ tin m·ªõi h∆°n cache th√¨ n√≥ s·∫Ω t·ª± c·∫≠p nh·∫≠t sau 1-2 gi√¢y
         loadNotifications(1);
      });
      
      // --- H√ÄM T·∫¢I TH√îNG B√ÅO T·ª™ SERVER (TH√îNG MINH H∆†N) ---
      async function loadNotifications(page) {
         // N·∫øu ƒëang loading (tr·ª´ khi l√† trang 1 ch·∫°y ng·∫ßm th√¨ c√≥ th·ªÉ cho qua, nh∆∞ng ƒë·ªÉ an to√†n c·ª© ch·∫∑n)
         if (notifLoading) return;
      
         // Ch·ªâ hi·ªán spinner n·∫øu Modal ƒëang m·ªü v√† ch∆∞a c√≥ d·ªØ li·ªáu
         const container = document.getElementById('notifications-list');
         const isModalOpen = document.getElementById('notificationsModal').classList.contains('show');
      
         if (isModalOpen && page === 1 && serverNotifications.length === 0) {
            // Thay ƒëo·∫°n HTML c≈©
            container.innerHTML = '<div class="d-flex justify-content-center align-items-center py-5"><div class="spinner-border text-primary" role="status"></div></div>';
         }
      
         notifLoading = true;
      
         try {
            const res = await sendToServer({
               action: 'get_notifications',
               page: page,
               limit: 10
            });
      
            if (res.status === 'success') {
               notifHasMore = res.hasMore;
      
               // 1. C·∫¨P NH·∫¨T D·ªÆ LI·ªÜU V√ÄO B·ªò NH·ªö (CACHE)
               if (page === 1) {
                  serverNotifications = res.data;
               } else {
                  serverNotifications = serverNotifications.concat(res.data);
               }
      
               // 2. CH·ªà V·∫º GIAO DI·ªÜN N·∫æU MODAL ƒêANG M·ªû
               if (isModalOpen) {
                  if (page === 1) container.innerHTML = ''; // X√≥a loading c≈©
                  else {
                     const oldTrigger = document.getElementById('notif-load-more');
                     if (oldTrigger) oldTrigger.remove();
                  }
                  renderNotificationsPaged(res.data, container);
               }
               // N·∫øu Modal ƒë√≥ng: D·ªØ li·ªáu ƒë√£ v√†o serverNotifications. 
               // L·∫ßn sau ·∫•n chu√¥ng, s·ª± ki·ªán Click s·∫Ω l·∫•y serverNotifications ra hi·ªÉn th·ªã ngay l·∫≠p t·ª©c.
            }
         } catch (e) {
            console.error(e);
            if (isModalOpen && page === 1) container.innerHTML = '<div class="text-center py-3 text-danger small">L·ªói k·∫øt n·ªëi</div>';
         } finally {
            notifLoading = false;
         }
      }
      
      // --- H√ÄM RENDER TH√îNG B√ÅO (ƒê√öNG FORMAT & CH·∫§M ƒê·ªé) ---
      // --- H√ÄM RENDER TH√îNG B√ÅO (C√ì SWIPE & DOT ƒê·ªé) ---
	function renderNotificationsPaged(newNotifs, container) {
		if (serverNotifications.length === 0) {
			container.innerHTML = `
				<div class="text-center py-5">
					<i class="bi bi-bell-slash theme-text-primary" style="font-size: 3rem;"></i>
					<p class="fw-semibold mt-3">Ch∆∞a c√≥ th√¥ng b√°o</p>
				</div>`;
			return;
		}

		const html = newNotifs.map(notif => {
			// Map Icon t∆∞∆°ng ·ª©ng lo·∫°i th√¥ng b√°o
			const iconMap = {
				like: 'heart-fill text-danger',
				comment: 'chat-fill text-primary',
				memory: 'star-fill text-warning',
				album: 'folder-fill text-info',
				system: 'info-circle-fill theme-text-primary',
				create_post: 'pencil-square text-success',
				update_post: 'pencil-fill text-warning',
				delete_post: 'trash-fill text-danger'
			};

			let iconClass = iconMap.system;
			if (notif.action) {
				if (notif.action.includes('create')) iconClass = iconMap.create_post;
				else if (notif.action.includes('update')) iconClass = iconMap.update_post;
				else if (notif.action.includes('delete')) iconClass = iconMap.delete_post;
				else iconClass = iconMap[notif.action] || iconMap.system;
			}

			// Ki·ªÉm tra xem c√≥ ch·∫•m ƒë·ªè kh√¥ng
			const dotHtml = !notif.isRead ?
            `<div class="notification-dot ms-auto me-2" style="flex-shrink: 0;"></div>` :
            `<div class="ms-auto me-2"></div>`;

			const relatedPostId = notif.relatedId || notif.postId || ''; 

			return `
				<div class="notification-swipe-wrapper" id="notif-wrap-${notif.__backendId}">
					<div class="notification-actions">
						<button class="notif-action-btn btn-mark-unread" onclick="handleSwipeAction('${notif.__backendId}', 'unread')">
							<i class="bi bi-envelope"></i>
						</button>
						<button class="notif-action-btn btn-mark-read" onclick="handleSwipeAction('${notif.__backendId}', 'read')">
							<i class="bi bi-envelope-open"></i>
						</button>
						<button class="notif-action-btn btn-delete-swipe" onclick="handleSwipeAction('${notif.__backendId}', 'delete')">
							<i class="bi bi-trash"></i>
						</button>
					</div>

					<div class="notification-content-box p-3 ${notif.isRead ? '' : 'unread'}" 
						 data-id="${notif.__backendId}" 
						 data-post-id="${relatedPostId}"
						 onclick="if(!isSwiping) handleNotificationClick('${notif.__backendId}')"
						 ontouchstart="handleTouchStart(event, '${notif.__backendId}')"
						 ontouchmove="handleTouchMove(event)"
						 ontouchend="handleTouchEnd(event)">
						
						<div class="d-flex align-items-center pointer-event-none">
							<div class="me-3">
								<i class="bi bi-${iconClass} fs-4"></i>
							</div>
							<div class="flex-grow-1" style="font-size: 0.9rem; line-height: 1.3;">
								<strong>${notif.fullname || 'H·ªá th·ªëng'}</strong> ${notif.title}
								<div class="text-muted small">${notif.formattedTime || formatTimeSmart(notif.createdAt)}</div>
								${notif.message ? `<div class="text-muted small text-truncate" style="max-width: 220px;">${notif.message}</div>` : ''}
							</div>
							${dotHtml}
							<i class="bi bi-chevron-left text-black-50 small ms-2" style="font-size: 0.7rem;"></i>
						</div>
					</div>
				</div>
			`;
		}).join('');

		container.insertAdjacentHTML('beforeend', html);

		// Logic Load More (Gi·ªØ nguy√™n c·ªßa b·∫°n)
		if (notifHasMore) {
			const trigger = document.createElement('div');
			trigger.id = 'notif-load-more';
			trigger.className = 'py-3 text-center text-muted small cursor-pointer';
			trigger.innerHTML = '<span>ƒêang t·∫£i th√™m...</span>';
			container.appendChild(trigger);

			const observer = new IntersectionObserver((entries) => {
				if (entries[0].isIntersecting && !notifLoading) {
					notifPage++;
					loadNotifications(notifPage);
				}
			}, { threshold: 0.1 });
			observer.observe(trigger);
		} else if (serverNotifications.length > 5) {
			container.insertAdjacentHTML('beforeend', '<div class="text-center py-3 text-muted small">--- H·∫øt th√¥ng b√°o ---</div>');
		}
	}
      
      // Layout Edit Mode
      document.getElementById('enter-layout-edit').addEventListener('click', enterEditMode);
      document.getElementById('exit-edit-mode').addEventListener('click', exitEditMode);
      
      // FAB Button
      document.getElementById('fab-btn').addEventListener('click', () => {
         if (currentTab === 'feed') createPostModal.show();
         else if (currentTab === 'albums') createAlbumModal.show();
      });
      
      // Theme Selection
      document.querySelectorAll('.theme-option').forEach(opt => {
         opt.addEventListener('click', () => applyTheme(opt.dataset.theme));
      });
      
      // Layout Selection 
      document.querySelectorAll('.layout-preview-box').forEach(opt => {
         opt.addEventListener('click', () => {
            const layout = opt.dataset.layout;
            updateLayoutSelectionUI(layout); // D√πng h√†m m·ªõi ƒë·ªÉ ƒë·ªìng b·ªô
      
            // Render l·∫°i ·∫£nh preview ngay l·∫≠p t·ª©c
            updateImagePreview();
         });
      });
      
      // Create Post
      const postInput = document.getElementById('post-input');
      const postBtn = document.getElementById('post-btn');
      const imageInput = document.getElementById('image-input');
      
      postInput.addEventListener('input', () => {
         postBtn.disabled = !postInput.value.trim() && currentImages.length === 0;
      });
      
      // --- S·ª¨A L·∫†I S·ª∞ KI·ªÜN CH·ªåN ·∫¢NH ---
      imageInput.addEventListener('change', async (e) => {
         const files = Array.from(e.target.files);
         if (files.length === 0) return;
      
         // [TH√äM D√íNG N√ÄY] Lu√¥n t·ª± ƒë·ªông b·∫≠t HD khi ng∆∞·ªùi d√πng ch·ªçn ·∫£nh m·ªõi
         document.getElementById('hd-quality-switch').checked = true;
      
         // Gi·ªõi h·∫°n 50 ·∫£nh
         if (currentImages.length + files.length > 50) {
            showToast('Ch·ªâ ƒë∆∞·ª£c ch·ªçn t·ªëi ƒëa 50 ·∫£nh!');
            return;
         }
      
         showLoading();
      
         for (const file of files) {
            // 1. L∆∞u file g·ªëc v√†o m·∫£ng (ƒë·ªÉ d√†nh t√≠ n·ªØa upload)
            currentImages.push(file);
      
            // 2. T·∫°o b·∫£n Preview nh·∫π (resize nh·ªè x√≠u ch·ªâ ƒë·ªÉ xem tr√™n web)
            // D√πng h√†m n√©n c≈© ƒë·ªÉ t·∫°o thumbnail hi·ªÉn th·ªã cho ƒë·ª° lag m√°y
            const previewBase64 = await compressImage(file, 300, 0.6);
            currentImagePreviews.push(previewBase64);
         }
      
         if (currentImages.length >= 3) {
            // M·∫∑c ƒë·ªãnh ch·ªçn 1 Ngang
            updateLayoutSelectionUI('1-wide');
         } else {
            // N·∫øu √≠t ·∫£nh, m·∫∑c ƒë·ªãnh v·ªÅ l∆∞·ªõi c∆° b·∫£n
            updateLayoutSelectionUI('grid-2x2');
         }
      
         hideLoading();
         updateImagePreview(); // H√†m n√†y c·∫ßn s·ª≠a l·∫°i ch√∫t ·ªü b∆∞·ªõc d∆∞·ªõi
         e.target.value = '';
      });
      
      document.getElementById('images-preview-grid').addEventListener('click', (e) => {
         const removeBtn = e.target.closest('.remove-preview-img');
         if (removeBtn) {
            const index = parseInt(removeBtn.dataset.index);
            currentImages.splice(index, 1);
            updateImagePreview();
         }
      });
      
      document.getElementById('clear-all-images').addEventListener('click', () => {
         currentImages = [];
         updateImagePreview();
      });
      
      
      // Reset l·∫°i modal v·ªÅ ch·∫ø ƒë·ªô "T·∫°o m·ªõi" khi ƒë√≥ng
      document.getElementById('createPostModal').addEventListener('hidden.bs.modal', function () {
         isEditingPost = false;
         currentEditPostId = null;
      
         // S·ª¨A 1: D√πng ƒë√∫ng ID 'post-input' thay v√¨ 'post-content'
         const postInputEl = document.getElementById('post-input');
         if (postInputEl) postInputEl.value = '';
      
         // S·ª¨A 2: G·ªçi h√†m updateImagePreview() ƒë·ªÉ reset ·∫£nh thay v√¨ g·ªçi ID sai
         currentImages = []; // X√≥a d·ªØ li·ªáu ·∫£nh
         updateImagePreview(); // H√†m n√†y s·∫Ω t·ª± ƒë·ªông ·∫©n container ·∫£nh
      
         // Reset text ti√™u ƒë·ªÅ v√† n√∫t b·∫•m
         document.querySelector('#createPostModal .modal-title').textContent = "T·∫°o b√†i vi·∫øt";
      
         // Reset n√∫t ƒëƒÉng (gi·ªØ l·∫°i icon)
         const postBtn = document.getElementById('post-btn');
         if (postBtn) postBtn.innerHTML = '<i class="bi bi-send me-2"></i>ƒêƒÉng b√†i';
         // [TH√äM D√íNG N√ÄY] ƒê·∫£m b·∫£o l·∫ßn sau m·ªü l√™n n√∫t v·∫´n B·∫≠t
         document.getElementById('hd-quality-switch').checked = true;
         // Reset layout v·ªÅ m·∫∑c ƒë·ªãnh
         updateLayoutSelectionUI('1-wide');
      });
      
      // Create Memory
      const memoryImageInput = document.getElementById('memory-image-input');
      const memoryImagePreview = document.getElementById('memory-image-preview');
      const memoryImagePreviewContainer = document.getElementById('memory-image-preview-container');
      
      memoryImageInput.addEventListener('change', async (e) => {
         const file = e.target.files[0];
         if (file) {
            showLoading();
            memoryImageData = await compressImage(file);
            memoryImagePreview.src = memoryImageData;
            memoryImagePreviewContainer.classList.remove('d-none');
            hideLoading();
         }
      });
      
      document.getElementById('remove-memory-image').addEventListener('click', () => {
         memoryImageData = null;
         memoryImagePreviewContainer.classList.add('d-none');
         memoryImageInput.value = '';
      });
      
      document.getElementById('create-memory-btn').addEventListener('click', async () => {
         if (recordCount >= 999) {
            showToast('ƒê√£ ƒë·∫°t gi·ªõi h·∫°n 999 m·ª•c!');
            return;
         }
      
         const title = document.getElementById('memory-title').value.trim();
         const date = document.getElementById('memory-date').value;
         const content = document.getElementById('memory-content').value.trim();
      
         if (!title && !content && !memoryImageData) return;
      
         showLoading();
         const result = await window.dataSdk.create({
            type: 'memory',
            memoryTitle: title || 'K·ª∑ ni·ªám',
            memoryDate: date || new Date().toISOString().split('T')[0],
            content: content,
            imageData: memoryImageData || '',
            createdAt: new Date().toISOString()
         });
         hideLoading();
      
         if (result.isOk) {
            document.getElementById('memory-title').value = '';
            document.getElementById('memory-date').value = '';
            document.getElementById('memory-content').value = '';
            memoryImageData = null;
            memoryImagePreviewContainer.classList.add('d-none');
            memoryImageInput.value = '';
            createMemoryModal.hide();
            showToast('ƒê√£ l∆∞u k·ª∑ ni·ªám!');
            await createNotification('memory', 'K·ª∑ ni·ªám m·ªõi', `ƒê√£ th√™m k·ª∑ ni·ªám: ${title || 'K·ª∑ ni·ªám'}`);
         } else {
            showToast('L·ªói: ' + result.error.message);
         }
      });
      
      // Create Album
      document.getElementById('create-album-btn').addEventListener('click', async () => {
         if (recordCount >= 999) {
            showToast('ƒê√£ ƒë·∫°t gi·ªõi h·∫°n 999 m·ª•c!');
            return;
         }
      
         const name = document.getElementById('album-name').value.trim();
         if (!name) return;
      
         showLoading();
         const result = await window.dataSdk.create({
            type: 'album',
            albumName: name,
            createdAt: new Date().toISOString()
         });
         hideLoading();
      
         if (result.isOk) {
            document.getElementById('album-name').value = '';
            createAlbumModal.hide();
            showToast('ƒê√£ t·∫°o album!');
            await createNotification('album', 'Album m·ªõi', `ƒê√£ t·∫°o album: ${name}`);
         } else {
            showToast('L·ªói: ' + result.error.message);
         }
      });
       
       
      
      // Profile
      document.getElementById('profile-btn').addEventListener('click', () => {
         // --> TH√äM D√íNG N√ÄY
         closeAllModals();
      
         profileModal.show();
      });
      
      // 3. ƒê·ªïi ·∫¢nh ƒê·∫°i Di·ªán (S·ª≠a: Ch·ªâ Preview, KH√îNG l∆∞u server ngay)
      document.getElementById('avatar-input').addEventListener('change', async (e) => {
         const file = e.target.files[0];
         if (file) {
            showLoading();
            try {
               // 1. N√©n ·∫£nh xu·ªëng < 20KB
               const avatarData = await compressImageTo20KB(file);
      
               // 2. C·∫≠p nh·∫≠t bi·∫øn local 'currentProfile' ƒë·ªÉ hi·ªÉn th·ªã preview ngay l·∫≠p t·ª©c
      
               currentProfile = {
                  username: '',
                  fullName: '',
                  avatarData: '',
                  themeName: currentProfile.themeName
               };
      
               currentProfile.avatarData = avatarData;
               currentProfile.username = document.getElementById('profile-username').value.trim() || '';
               currentProfile.fullName = document.getElementById('profile-fullname').value.trim() || '';
      
               // 3. V·∫Ω l·∫°i ·∫£nh l√™n giao di·ªán (Header v√† Modal)
               updateAvatarDisplays();
      
               // 4. Th√¥ng b√°o (Kh√¥ng g·ªçi sendToServer ·ªü ƒë√¢y n·ªØa)
               showToast('ƒê√£ t·∫£i ·∫£nh (Nh·∫•n "L∆∞u thay ƒë·ªïi" ƒë·ªÉ ho√†n t·∫•t)');
            } catch (err) {
               console.error(err);
               showToast('L·ªói x·ª≠ l√Ω ·∫£nh');
            } finally {
               hideLoading();
            }
         }
      });
      
      // 4. L∆∞u Th√¥ng Tin Profile (C·∫≠p nh·∫≠t LocalStorage)
      // X·ª≠ l√Ω n√∫t L∆ØU trong Modal H·ªì s∆° (OPTIMISTIC UI)
      const saveProfileBtn = document.getElementById('save-profile');
      if (saveProfileBtn) {
         saveProfileBtn.addEventListener('click', () => {
            lastUserActionTime = Date.now(); // [M·ªöI] Ch·∫∑n sync ƒë·ªÉ kh√¥ng load l·∫°i avatar c≈©
            const fullnameInput = document.getElementById('profile-fullname');
            const usernameInput = document.getElementById('profile-username');
      
            // 1. Validate d·ªØ li·ªáu
            const newUsername = usernameInput.value.trim();
            const newFullname = fullnameInput.value.trim();
      
            if (!newUsername) {
               showToast('Vui l√≤ng nh·∫≠p Username!');
               return;
            }
      
            // --- B·∫ÆT ƒê·∫¶U OPTIMISTIC UI UPDATE ---
      
            // 2. C·∫≠p nh·∫≠t ngay l·∫≠p t·ª©c v√†o bi·∫øn c·ª•c b·ªô
            const previousProfile = {
               ...currentProfile
            }; // L∆∞u l·∫°i ƒë·ªÅ ph√≤ng l·ªói
      
            // T·∫°o object profile m·ªõi
            currentProfile = {
               ...currentProfile,
               username: newUsername,
               fullName: newFullname || newUsername,
               themeName: currentTheme,
               avatarData: currentProfile.avatarData || ''
            };
      
            // 3. L∆∞u ngay v√†o LocalStorage
            saveLocalData(currentProfile);
      
            // 4. C·∫≠p nh·∫≠t giao di·ªán ngay l·∫≠p t·ª©c (Header, Avatar...)
            updateAvatarDisplays();
            //const appTitle = document.getElementById('app-title');
            //if(appTitle) appTitle.textContent = currentProfile.fullName;
      
            // 5. ƒê√≥ng Modal NGAY L·∫¨P T·ª®C
            const modalEl = document.getElementById('profileModal');
            const modalInstance = bootstrap.Modal.getInstance(modalEl);
            if (modalInstance) modalInstance.hide();
      
            // 6. B√°o th√†nh c√¥ng ngay
            showToast('ƒê√£ c·∫≠p nh·∫≠t h·ªì s∆°!');
      
            renderPosts(); // C·∫≠p nh·∫≠t l·∫°i t√™n v√† t√≠ch xanh tr√™n b√†i vi·∫øt c≈© ngay l·∫≠p t·ª©c
            // --- X·ª¨ L√ù NG·∫¶M (BACKGROUND SYNC) ---
            // G·ª≠i l√™n server sau, kh√¥ng b·∫Øt ng∆∞·ªùi d√πng ch·ªù
            sendToServer({
               action: 'save_profile',
               username: currentProfile.username,
               fullname: currentProfile.fullName,
               avaurl: currentProfile.avatarData || '',
               theme: currentProfile.themeName || 'green',
               fingerprint: userFingerprint || 'unknown'
            }).then(res => {
               if (res.status === 'success') {
                  console.log('ƒê·ªìng b·ªô Server th√†nh c√¥ng');
               } else {
                  console.warn('Server ch∆∞a l∆∞u ƒë∆∞·ª£c, nh∆∞ng Local ƒë√£ l∆∞u');
               }
            }).catch(err => {
               console.error('L·ªói ƒë·ªìng b·ªô server:', err);
               // T√πy ch·ªçn: C√≥ th·ªÉ revert l·∫°i profile c≈© n·∫øu mu·ªën ch·∫∑t ch·∫Ω
               // currentProfile = previousProfile;
               // saveLocalData(currentProfile);
               // showToast('L·ªói k·∫øt n·ªëi! ƒê√£ ho√†n t√°c.');
            });
         });
      }
      
      // Post interactions
      // --- S·ª∞ KI·ªÜN T∆Ø∆†NG T√ÅC B√ÄI VI·∫æT (LIKE, COMMENT, MENU) ---
      document.getElementById('posts-container').addEventListener('click', async (e) => {
      
         // A. X·ª¨ L√ù LIKE (C·∫¨P NH·∫¨T L·∫†C QUAN)
         const likeBtn = e.target.closest('.like-btn');
         if (likeBtn) {
            // Ch·∫∑n click li√™n t·ª•c
            if (likeBtn.disabled) return;
      
            // 1. L·∫•y tr·∫°ng th√°i hi·ªán t·∫°i t·ª´ giao di·ªán
            const icon = likeBtn.querySelector('i');
            const textSpan = likeBtn.querySelector('span');
            const isCurrentlyLiked = icon.classList.contains('bi-heart-fill');
            const postId = likeBtn.dataset.id;
      
            // 2. C·∫≠p nh·∫≠t UI NGAY L·∫¨P T·ª®C (Kh√¥ng ch·ªù Server)
            if (isCurrentlyLiked) {
               // ƒêang th√≠ch -> B·ªè th√≠ch
               icon.className = 'bi bi-heart fs-5'; // Tr√°i tim r·ªóng
               icon.classList.remove('text-danger');
      
               let currentCount = parseInt(textSpan.textContent) || 0;
               // N·∫øu ƒëang l√† ch·ªØ 'Th√≠ch' th√¨ coi l√† 0
               if (isNaN(currentCount)) currentCount = 0;
      
               const newCount = Math.max(0, currentCount - 1);
               textSpan.textContent = newCount > 0 ? newCount : 'Th√≠ch';
      
               likeBtn.classList.remove('active');
            } else {
               // Ch∆∞a th√≠ch -> Th√≠ch
               icon.className = 'bi bi-heart-fill text-danger fs-5'; // Tr√°i tim ƒë·∫∑c ƒë·ªè
      
               let currentCount = parseInt(textSpan.textContent) || 0;
               if (isNaN(currentCount)) currentCount = 0;
      
               textSpan.textContent = currentCount + 1;
      
               // Th√™m hi·ªáu ·ª©ng nh√∫n nh·∫£y
               likeBtn.classList.add('active');
            }
      
            // 3. G·ª≠i l·ªánh l√™n Server (Ch·∫°y ng·∫ßm)
            try {
               const username = currentProfile ? currentProfile.username : 'anonymous';
               const res = await sendToServer({
                  action: 'like_post',
                  postId: postId,
                  username: username
               });
      
               // N·∫øu server tr·∫£ v·ªÅ s·ªë l∆∞·ª£ng ch√≠nh x√°c, c·∫≠p nh·∫≠t l·∫°i cho chu·∫©n
               if (res.status === 'success' && res.newCount !== undefined) {
                  textSpan.textContent = res.newCount > 0 ? res.newCount : 'Th√≠ch';
               }
            } catch (e) {
               console.error("L·ªói like:", e);
               // N·∫øu l·ªói m·∫°ng nghi√™m tr·ªçng th√¨ c√≥ th·ªÉ revert UI l·∫°i ·ªü ƒë√¢y (t√πy ch·ªçn)
            }
            return;
         }
      
         // B. X·ª¨ L√ù M·ªû COMMENT
         const commentBtn = e.target.closest('.comment-btn');
         if (commentBtn) {
            currentPostId = commentBtn.dataset.id;
            // Load comment t·ª´ server thay v√¨ t·ª´ d·ªØ li·ªáu post c≈©
            loadCommentsForPost(currentPostId);
            commentModal.show();
            return;
         }
      
         // C. X·ª¨ L√ù MENU 3 CH·∫§M (S·ª≠a/X√≥a)
         const menuBtn = e.target.closest('.post-menu-btn');
         if (menuBtn) {
            currentPostId = menuBtn.dataset.id;
            postOptionsModal.show();
         }
      });
      
      // Post Options 
      document.getElementById('edit-post-option').addEventListener('click', () => {
         // G·ªçi h√†m openEditPost ƒë√£ s·ª≠a ·ªü tr√™n
         openEditPost(currentPostId);
      });
      
      document.getElementById('delete-post-option').addEventListener('click', () => {
         postOptionsModal.hide();
         showDeleteConfirm('X√≥a b√†i ƒëƒÉng n√†y?', currentPostId, 'post');
      });
      
      // Comments
      document.getElementById('commentModal').addEventListener('hidden.bs.modal', () => {
         currentPostId = null;
      });
      
      // --- G·ª¨I COMMENT ---
      // --- G·ª¨I COMMENT (C·∫¨P NH·∫¨T L·∫†C QUAN) ---
      document.getElementById('send-comment').addEventListener('click', async () => {
         const input = document.getElementById('comment-input');
         const text = input.value.trim();
         if (!text || !currentPostId) return;
      
         const container = document.getElementById('comments-list');
      
         // 1. T·∫°o d·ªØ li·ªáu gi·∫£ l·∫≠p (Optimistic Data)
         const tempId = 'temp_' + Date.now();
         const tempComment = {
            id: tempId,
            username: currentProfile.username,
            fullname: currentProfile.fullName,
            avatar: currentProfile.avatarData,
            content: text,
            formattedTime: "ƒêang g·ª≠i..."
         };
      
         // 2. Hi·ªÉn th·ªã ngay l·∫≠p t·ª©c
         // N·∫øu ƒëang hi·ªán "Ch∆∞a c√≥ b√¨nh lu·∫≠n" th√¨ x√≥a ƒëi
         if (container.querySelector('.bi-chat-dots')) {
            container.innerHTML = '';
         }
      
         const html = createCommentHtml(tempComment);
         container.insertAdjacentHTML('beforeend', html);
      
         // Cu·ªôn xu·ªëng cu·ªëi
         const newItem = document.getElementById(`comment-${tempId}`);
         if (newItem) newItem.scrollIntoView({
            behavior: 'smooth',
            block: 'end'
         });
      
         // X√≥a √¥ nh·∫≠p li·ªáu ngay
         input.value = '';
      
         // 3. G·ª≠i Server (Background)
         try {
            const res = await sendToServer({
               action: 'comment_action',
               type: 'add',
               postId: currentPostId,
               username: currentProfile.username,
               content: text
            });
      
            if (res.status === 'success') {
               if (newItem) {
                  // 1. S·ª¨A L·ªñI HI·ªÇN TH·ªä: C·∫≠p nh·∫≠t text th·ªùi gian
                  // D√πng 'small.text-muted' (Th·∫ª small c√≥ class text-muted) thay v√¨ '.text-muted.small'
                  const timeEl = newItem.querySelector('small.text-muted');
                  if (timeEl) timeEl.textContent = "V·ª´a xong";
      
                  // 2. C·∫¨P NH·∫¨T ID TH·∫¨T (Quan tr·ªçng ƒë·ªÉ X√≥a/S·ª≠a ƒë∆∞·ª£c ngay)
                  // N·∫øu kh√¥ng c·∫≠p nh·∫≠t ID, khi b·∫•m x√≥a ngay l·∫≠p t·ª©c s·∫Ω b·ªã l·ªói v√¨ ID v·∫´n l√† temp_...
                  if (res.id) {
                     // ƒê·ªïi ID c·ªßa d√≤ng comment
                     newItem.id = `comment-${res.id}`;
      
                     // C·∫≠p nh·∫≠t data-id cho n√∫t 3 ch·∫•m (Menu t√πy ch·ªçn)
                     const optionBtn = newItem.querySelector('.comment-options-btn');
                     if (optionBtn) {
                        optionBtn.dataset.id = res.id;
                        // C·∫≠p nh·∫≠t l·∫°i n·ªôi dung g·ªëc v√†o data-content ƒë·ªÉ t√≠nh nƒÉng S·ª≠a ho·∫°t ƒë·ªông ƒë√∫ng
                        optionBtn.dataset.content = text;
                     }
                  }
               }
            } else {
               throw new Error("Server error");
            }
         } catch (e) {
            // L·ªói: X√≥a comment gi·∫£ ƒëi v√† b√°o l·ªói, tr·∫£ l·∫°i n·ªôi dung v√†o √¥ nh·∫≠p
            if (newItem) newItem.remove();
            input.value = text;
            showToast('L·ªói g·ª≠i b√¨nh lu·∫≠n! Vui l√≤ng th·ª≠ l·∫°i.');
         }
      });
      
      // --- X√ìA COMMENT (D√πng Event Delegation) ---
      // --- X√ìA COMMENT (C·∫¨P NH·∫¨T L·∫†C QUAN) ---
      document.getElementById('comments-list').addEventListener('click', async (e) => {
         const deleteBtn = e.target.closest('.delete-comment-btn');
         if (deleteBtn) {
            if (!confirm("X√≥a b√¨nh lu·∫≠n n√†y?")) return;
      
            const cmtId = deleteBtn.dataset.id;
            const commentItem = document.getElementById(`comment-${cmtId}`);
      
            // 1. ·∫®n ngay l·∫≠p t·ª©c (UI)
            if (commentItem) {
               commentItem.style.transition = "opacity 0.3s, height 0.3s";
               commentItem.style.opacity = "0";
               setTimeout(() => commentItem.style.display = "none", 300);
            }
      
            // 2. G·ª≠i Server (Background)
            try {
               const res = await sendToServer({
                  action: 'comment_action',
                  type: 'delete',
                  commentId: cmtId,
                  username: currentProfile.username
               });
      
               if (res.status !== 'success') {
                  throw new Error("L·ªói x√≥a");
               }
            } catch (e) {
               // L·ªói: Hi·ªán l·∫°i comment
               if (commentItem) {
                  commentItem.style.display = "flex";
                  setTimeout(() => commentItem.style.opacity = "1", 50);
               }
               showToast('Kh√¥ng th·ªÉ x√≥a b√¨nh lu·∫≠n!');
            }
         }
      });
      
      // Delete confirmation
      function showDeleteConfirm(message, id, type) {
         pendingDeleteId = id;
         pendingDeleteType = type;
         deleteConfirmModal.show();
      }
      
      // Bike stats
      document.getElementById('stats-container').addEventListener('click', (e) => {
         const chartBtn = e.target.closest('.bike-chart-btn');
         if (chartBtn) {
            e.stopPropagation();
            showBikeStats();
         }
      
         const goldChartBtn = e.target.closest('.gold-chart-btn');
         if (goldChartBtn) {
            e.stopPropagation();
            showGoldStats();
         }
      });
      
      document.getElementById('add-bike-entry').addEventListener('click', () => {
         //document.getElementById('bike-entry-count').value = 1;
         //document.getElementById('bike-entry-date').valueAsDate = new Date();
         //document.getElementById('bike-entry-note').value = '';
         addBikeEntryModal.show();
      });
      
      document.getElementById('bike-history-list').addEventListener('click', async (e) => {
         const deleteBtn = e.target.closest('.delete-bike-entry');
         if (deleteBtn) {
            const entryId = deleteBtn.dataset.id;
            const entry = allData.find(d => d.__backendId === entryId);
            if (entry) {
               showLoading();
               await window.dataSdk.delete(entry);
               hideLoading();
               showToast('ƒê√£ x√≥a!');
               showBikeStats();
            }
         }
      });
      
      // Gold stats 
		document.getElementById('add-gold-entry').addEventListener('click', () => {
			// 1. Reset tr·∫°ng th√°i v·ªÅ Th√™m M·ªõi
			isEditingGold = false;
			currentEditGoldId = null;

			// 2. Reset Form
			document.getElementById('gold-trans-qty').value = '';
			document.getElementById('gold-trans-price').value = '';
			document.getElementById('gold-trans-note').value = '';
			document.getElementById('gold-trans-date').valueAsDate = new Date();

			// 3. ƒê·ªïi l·∫°i ti√™u ƒë·ªÅ Modal v·ªÅ m·∫∑c ƒë·ªãnh
			document.querySelector('#addGoldEntryModal .modal-title').innerHTML = '<i class="bi bi-plus-lg me-2"></i>Th√™m Giao D·ªãch M·ªõi';
			document.getElementById('save-gold-transaction').textContent = 'L∆∞u Giao D·ªãch';

			// 4. M·ªü Modal (D√πng bi·∫øn to√†n c·ª•c ƒë√£ khai b√°o ·ªü ƒë·∫ßu script)
			if (addGoldEntryModal) {
				addGoldEntryModal.show();
			} else {
				// Fallback n·∫øu ch∆∞a kh·ªüi t·∫°o (√≠t khi x·∫£y ra)
				const modal = new bootstrap.Modal(document.getElementById('addGoldEntryModal'));
				modal.show();
			}
		});
      
      // --- X·ª¨ L√ù L∆ØU GIAO D·ªäCH V√ÄNG (C·∫¨P NH·∫¨T L·∫†C QUAN) ---
      // --- X·ª¨ L√ù L∆ØU HO·∫∂C C·∫¨P NH·∫¨T GIAO D·ªäCH V√ÄNG ---
      document.getElementById('save-gold-transaction').addEventListener('click', async () => {
         // 1. L·∫•y d·ªØ li·ªáu
         const date = document.getElementById('gold-trans-date').value;
         const type = document.getElementById('gold-trans-type').value;
         const qty = parseFloat(document.getElementById('gold-trans-qty').value);
         const price = parseFloat(document.getElementById('gold-trans-price').value);
         const note = document.getElementById('gold-trans-note').value;
      
         if (!date || !qty || !price) {
            showToast('Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!');
            return;
         }
      
         // ƒê√≥ng Modal
         const modalEl = document.getElementById('addGoldEntryModal');
         const modalInstance = bootstrap.Modal.getInstance(modalEl);
         if (modalInstance) modalInstance.hide();
      
         // --- LOGIC PH√ÇN CHIA (TH√äM hay S·ª¨A) ---
         const isEdit = isEditingGold; // L∆∞u l·∫°i bi·∫øn n√†y v√¨ async c√≥ th·ªÉ l√†m thay ƒë·ªïi context
         const targetId = isEdit ? currentEditGoldId : ('temp_' + Date.now());
      
         // 2. [OPTIMISTIC UI] C·∫≠p nh·∫≠t m·∫£ng c·ª•c b·ªô NGAY L·∫¨P T·ª®C
         const newTxData = {
            id: targetId,
            date: date,
            type: type,
            quantity_chi: qty,
            price_per_chi: price,
            note: note
         };
      
         if (isEdit) {
            // S·ª≠a: T√¨m v√† thay th·∫ø trong m·∫£ng
            const index = goldPortfolioData.findIndex(x => x.id === targetId);
            if (index !== -1) {
               goldPortfolioData[index] = {
                  ...goldPortfolioData[index],
                  ...newTxData
               };
            }
            showToast('ƒê√£ c·∫≠p nh·∫≠t (ƒêang ƒë·ªìng b·ªô...)');
         } else {
            // Th√™m: Push v√†o m·∫£ng
            goldPortfolioData.push(newTxData);
            showToast('ƒê√£ th√™m m·ªõi (ƒêang ƒë·ªìng b·ªô...)');
         }
      
         // V·∫Ω l·∫°i giao di·ªán ngay
         loadGoldPortfolio();
      
         // 3. G·ª¨I SERVER (BACKGROUND SYNC)
         try {
            const actionName = isEdit ? 'update_gold_transaction' : 'log_gold_transaction';
      
            const res = await sendToServer({
               action: actionName,
               id: isEdit ? targetId : undefined, // N·∫øu s·ª≠a th√¨ g·ª≠i ID
               date: date,
               type: type,
               quantity: qty,
               price: price,
               note: note
            });
      
            if (res.status === 'success') {
               console.log('ƒê·ªìng b·ªô th√†nh c√¥ng');
               // N·∫øu l√† Th√™m m·ªõi -> C·∫≠p nh·∫≠t ID th·∫≠t t·ª´ server tr·∫£ v·ªÅ
               if (!isEdit && res.id) {
                  const tempItem = goldPortfolioData.find(x => x.id === targetId);
                  if (tempItem) tempItem.id = res.id;
               }
            } else {
               throw new Error(res.message);
            }
         } catch (e) {
            console.error(e);
            showToast('L·ªói ƒë·ªìng b·ªô! ƒêang ho√†n t√°c...');
      
            // 4. HO√ÄN T√ÅC N·∫æU L·ªñI (ROLLBACK)
            if (isEdit) {
               // S·ª≠a l·ªói th√¨ kh√≥ ho√†n t√°c ch√≠nh x√°c n·∫øu kh√¥ng backup, 
               // nh∆∞ng reload l·∫°i t·ª´ server l√† an to√†n nh·∫•t
               showGoldStats();
            } else {
               // Th√™m l·ªói th√¨ x√≥a d√≤ng t·∫°m ƒëi
               const idx = goldPortfolioData.findIndex(x => x.id === targetId);
               if (idx > -1) {
                  goldPortfolioData.splice(idx, 1);
                  loadGoldPortfolio();
               }
            }
         }
      });
      
      // Set ng√†y m·∫∑c ƒë·ªãnh khi m·ªü modal
      document.getElementById('addGoldEntryModal').addEventListener('show.bs.modal', function () {
         if (!document.getElementById('gold-trans-date').value) {
            document.getElementById('gold-trans-date').valueAsDate = new Date();
         }
      });
      
      document.getElementById('gold-history-list').addEventListener('click', async (e) => {
         const deleteBtn = e.target.closest('.delete-gold-entry');
         if (deleteBtn) {
            const entryId = deleteBtn.dataset.id;
            const entry = allData.find(d => d.__backendId === entryId);
            if (entry) {
               showLoading();
               await window.dataSdk.delete(entry);
               hideLoading();
               showToast('ƒê√£ x√≥a!');
               showGoldStats();
            }
         }
      });
      
      // --- X·ª¨ L√ù X√ìA (OPTIMISTIC UPDATE CHO B√ÄI VI·∫æT) ---
      // --- S·ª∞ KI·ªÜN N√öT X√ÅC NH·∫¨N X√ìA (CONFIRM DELETE) - B·∫¢N FULL ---
      document.getElementById('confirm-delete').addEventListener('click', async () => {
      
         // 1. Ki·ªÉm tra h·ª£p l·ªá (S·ª≠a l·∫°i ƒëi·ªÅu ki·ªán ƒë·ªÉ ch·∫•p nh·∫≠n tr∆∞·ªùng h·ª£p x√≥a t·∫•t c·∫£ th√¥ng b√°o - id l√† null)
         if (!pendingDeleteId && pendingDeleteType !== 'all-notifications') {
            deleteConfirmModal.hide();
            return;
         }
      
         // ===============================================
         // TR∆Ø·ªúNG H·ª¢P 1: X√ìA B√ÄI VI·∫æT (POST) -> C·∫¨P NH·∫¨T L·∫†C QUAN
         // ===============================================
         if (pendingDeleteType === 'post') {
            const postId = pendingDeleteId;
            const postEl = document.getElementById(`post-${postId}`);
      
            // 1. ƒê√≥ng Modal ngay l·∫≠p t·ª©c
            deleteConfirmModal.hide();
      
            // 2. Backup d·ªØ li·ªáu (ƒë·ªÉ ho√†n t√°c n·∫øu l·ªói)
            const originalFeedData = [...serverFeedData];
      
            // 3. C·∫≠p nh·∫≠t UI ngay l·∫≠p t·ª©c
            // A. X√≥a kh·ªèi bi·∫øn d·ªØ li·ªáu c·ª•c b·ªô
            const postIndex = serverFeedData.findIndex(p => p.__backendId === postId);
            if (postIndex > -1) {
               serverFeedData.splice(postIndex, 1);
            }
      
            // B. T·∫°o hi·ªáu ·ª©ng bi·∫øn m·∫•t tr√™n giao di·ªán
            if (postEl) {
               postEl.style.transition = "all 0.4s ease-out";
               postEl.style.opacity = "0";
               postEl.style.transform = "translateX(50px)";
               postEl.style.height = postEl.offsetHeight + 'px';
      
               setTimeout(() => {
                  postEl.style.height = '0';
                  postEl.style.margin = '0';
                  postEl.style.padding = '0';
                  postEl.style.overflow = 'hidden';
      
                  setTimeout(() => {
                     postEl.remove();
                     if (serverFeedData.length === 0) renderPosts();
                  }, 200);
               }, 400);
            }
      
            showToast('ƒê√£ x√≥a b√†i vi·∫øt');
      
            // 4. G·ª≠i Server (Ch·∫°y ng·∫ßm)
            try {
               const res = await sendToServer({
                  action: 'feed_action',
                  type: 'delete',
                  id: postId
               });
      
               if (res.status !== 'success') {
                  throw new Error(res.message || 'L·ªói t·ª´ server');
               }
            } catch (e) {
               console.error("L·ªói x√≥a post:", e);
               // 5. Ho√†n t√°c n·∫øu l·ªói
               showToast('L·ªói k·∫øt n·ªëi! ƒêang kh√¥i ph·ª•c b√†i vi·∫øt...');
               serverFeedData = originalFeedData;
               renderPosts();
            }
      
            // Reset bi·∫øn t·∫°m
            pendingDeleteId = null;
            pendingDeleteType = null;
            return;
         }
      
         // ===============================================
         // TR∆Ø·ªúNG H·ª¢P 2: X√ìA T·∫§T C·∫¢ TH√îNG B√ÅO -> C·∫¨P NH·∫¨T L·∫†C QUAN
         // ===============================================
         if (pendingDeleteType === 'all-notifications') {
            const list = document.getElementById('notifications-list');
            const originalContent = list.innerHTML;
      
            // 1. UI L·∫°c quan (X√≥a ngay)
            list.innerHTML = `
      				  <div class="text-center py-5">
      					<i class="bi bi-bell-slash theme-text-primary" style="font-size: 3rem;"></i>
      					<p class="fw-semibold mt-3">Ch∆∞a c√≥ th√¥ng b√°o</p>
      				  </div>
      				`;
            document.getElementById('notification-badge').classList.add('d-none');
            showToast('ƒê√£ x√≥a t·∫•t c·∫£ th√¥ng b√°o');
      
            // 2. ƒê√≥ng Modal
            deleteConfirmModal.hide();
      
            // 3. G·ª≠i Server
            try {
               const res = await sendToServer({
                  action: 'notification_action',
                  type: 'delete_all'
               });
               if (res.status === 'success') serverNotifications = [];
            } catch (e) {
               console.error(e);
               showToast('L·ªói k·∫øt n·ªëi! ƒêang ho√†n t√°c...');
               list.innerHTML = originalContent;
            }
      
            // Reset bi·∫øn t·∫°m
            pendingDeleteId = null;
            pendingDeleteType = null;
            return;
         }
      
         // ===============================================
         // --> TH√äM ƒêO·∫†N N√ÄY V√ÄO ƒê√ÇY <--
         // TR∆Ø·ªúNG H·ª¢P 3: X√ìA B√åNH LU·∫¨N (COMMENT)
         // ===============================================
         if (pendingDeleteType === 'comment') {
            const cmtId = pendingDeleteId;
            const commentItem = document.getElementById(`comment-${cmtId}`);
      
            // 1. ƒê√≥ng Modal
            deleteConfirmModal.hide();
      
            // 2. UI L·∫°c quan: ·∫®n comment ngay l·∫≠p t·ª©c
            if (commentItem) {
               commentItem.style.transition = "all 0.3s ease";
               commentItem.style.opacity = "0";
               commentItem.style.height = "0";
               commentItem.style.margin = "0";
               commentItem.style.padding = "0";
               setTimeout(() => commentItem.remove(), 300);
            }
      
            // 3. G·ª≠i Server (Ch·∫°y ng·∫ßm)
            try {
               const res = await sendToServer({
                  action: 'comment_action',
                  type: 'delete',
                  commentId: cmtId,
                  username: currentProfile.username
               });
      
               if (res.status !== 'success') {
                  throw new Error("L·ªói t·ª´ server");
               }
            } catch (e) {
               console.error(e);
               showToast('Kh√¥ng th·ªÉ x√≥a b√¨nh lu·∫≠n! ƒêang kh√¥i ph·ª•c...');
               // N·∫øu l·ªói th√¨ v·∫Ω l·∫°i comment (ho·∫∑c reload) - ·ªü ƒë√¢y reload cho ƒë∆°n gi·∫£n
               if (currentPostId) loadCommentsForPost(currentPostId);
            }
      
            // Reset bi·∫øn t·∫°m
            pendingDeleteId = null;
            pendingDeleteType = null;
            return;
         }

// [TH√äM M·ªöI] X√ìA 1 TH√îNG B√ÅO RI√äNG L·∫∫
    // ===============================================
    if (pendingDeleteType === 'notification_single') {
        const notifId = pendingDeleteId;
        const wrapBox = document.getElementById(`notif-wrap-${notifId}`);

        // 1. ƒê√≥ng Modal
        deleteConfirmModal.hide();

        // 2. UI L·∫°c quan: ·∫®n d√≤ng th√¥ng b√°o ƒëi
        if (wrapBox) {
            wrapBox.style.transition = 'height 0.3s, opacity 0.3s';
            wrapBox.style.height = '0px';
            wrapBox.style.opacity = '0';
            setTimeout(() => wrapBox.remove(), 300);
        }

        // 3. X√≥a kh·ªèi Cache c·ª•c b·ªô (ƒë·ªÉ n·∫øu ƒë√≥ng m·ªü l·∫°i kh√¥ng b·ªã hi·ªán l·∫°i)
        const idx = serverNotifications.findIndex(n => n.__backendId === notifId);
        if (idx > -1) serverNotifications.splice(idx, 1);

        // 4. G·ª≠i Server
        try {
            await sendToServer({ action: 'notification_action', type: 'delete_one', id: notifId });
        } catch (e) {
            console.error("L·ªói x√≥a notification:", e);
            showToast('L·ªói k·∫øt n·ªëi!');
            // N·∫øu mu·ªën k·ªπ t√≠nh: Reload l·∫°i danh s√°ch th√¥ng b√°o ƒë·ªÉ kh√¥i ph·ª•c
        }

        // Reset bi·∫øn t·∫°m
        pendingDeleteId = null;
        pendingDeleteType = null;
        return;
    }
      
         // ===============================================
         // TR∆Ø·ªúNG H·ª¢P 4: C√ÅC LO·∫†I KH√ÅC (ALBUM, ·∫¢NH...) -> LOGIC C≈® (Loading)
         // ===============================================
      
         showLoading();
      
         try {
            if (pendingDeleteType === 'photo') {
               const item = allData.find(d => d.__backendId === pendingDeleteId);
               if (item) await window.dataSdk.delete(item);
               showToast('ƒê√£ x√≥a ·∫£nh!');
               if (currentAlbumId) renderAlbumPhotos();
            } else if (pendingDeleteType === 'album') {
               const item = allData.find(d => d.__backendId === pendingDeleteId);
               if (item) await window.dataSdk.delete(item);
               showToast('ƒê√£ x√≥a album!');
               renderAlbums();
            } else {
               // Fallback cho c√°c lo·∫°i kh√°c
               const item = allData.find(d => d.__backendId === pendingDeleteId);
               if (item) await window.dataSdk.delete(item);
               showToast('ƒê√£ x√≥a!');
            }
      
         } catch (e) {
            console.error(e);
            showToast('L·ªói khi x√≥a!');
         } finally {
            hideLoading();
            deleteConfirmModal.hide();
            pendingDeleteId = null;
            pendingDeleteType = null;
         }
      });
      
      document.getElementById('deleteConfirmModal').addEventListener('hidden.bs.modal', () => {
         pendingDeleteId = null;
         pendingDeleteType = null;
      });
      
      // --- X·ª¨ L√ù: T·ª∞ ƒê·ªòNG LOAD TH√îNG TIN KHI NH·∫¨P USERNAME ---
      // --- X·ª¨ L√ù: T·ª∞ ƒê·ªòNG LOAD & LI√äN K·∫æT THI·∫æT B·ªä ---
      const usernameInput = document.getElementById('profile-username');
      
      usernameInput.addEventListener('blur', async () => {
         const inputVal = usernameInput.value.trim();
         if (!inputVal || (currentProfile && inputVal === currentProfile.username)) return;
      
         showLoading();
      
         try {
            const res = await sendToServer({
               action: 'get_profile_by_username',
               username: inputVal
            });
      
            if (res.status === 'success' && res.data) {
               console.log("Ph√°t hi·ªán User c≈©, ƒëang li√™n k·∫øt thi·∫øt b·ªã...", res.data);
      
               currentProfile = {
                  username: res.data.username,
                  fullName: res.data.fullname,
                  avatarData: res.data.avaurl,
                  themeName: res.data.theme
               };
               saveLocalData(currentProfile);
      
               updateAvatarDisplays();
               applyTheme(currentProfile.themeName);
      
               // --- TH√äM D√íNG N√ÄY: V·∫º L·∫†I B·∫¢NG TIN NGAY L·∫¨P T·ª®C ---
               if (serverFeedData.length > 0) renderPosts();
               // ----------------------------------------------------
      
               await sendToServer({
                  action: 'save_profile',
                  username: currentProfile.username,
                  fullname: currentProfile.fullName,
                  avaurl: currentProfile.avatarData,
                  theme: currentProfile.themeName,
                  fingerprint: userFingerprint
               });
      
               showToast(`ƒê√£ kh√¥i ph·ª•c & Li√™n k·∫øt thi·∫øt b·ªã: ${res.data.fullname}`);
            }
         } catch (e) {
            console.error(e);
         } finally {
            hideLoading();
         }
      });
      
      // --- X·ª¨ L√ù CLICK BABY RUN (OPTIMISTIC UPDATE) ---
      document.getElementById('stats-container').addEventListener('click', async (e) => {
         // --- X·ª¨ L√ù CLICK BABY RUN (OPTIMISTIC UPDATE) ---
         const btn = e.target.closest('.baby-run-btn');
         if (btn) {
            lastUserActionTime = Date.now(); // [M·ªöI] Ch·∫∑n sync ng·∫ßm trong 10s t·ªõi
            // 1. Hi·ªáu ·ª©ng click (Thu nh·ªè nh·∫π t·∫°o c·∫£m gi√°c b·∫•m th·∫≠t)
            btn.style.transition = "transform 0.1s";
            btn.style.transform = "scale(0.85)";
            setTimeout(() => btn.style.transform = "scale(1)", 150);
      
            // 2. C·∫≠p nh·∫≠t UI ngay l·∫≠p t·ª©c
            const countEl = document.getElementById('bike-count');
            const currentVal = parseInt(countEl.textContent) || 0;
            countEl.textContent = currentVal + 1;
      
            // Rung nh·∫π s·ªë ƒë·∫øm
            countEl.style.transition = "color 0.2s";
            countEl.style.color = "var(--secondary-color)"; // ƒê·ªïi m√†u ch·ªõp nho√°ng
            setTimeout(() => countEl.style.color = "", 300);
      
            // 3. G·ª≠i Server (Background)
            const username = currentProfile ? currentProfile.username : 'anonymous';
      
            // Kh√¥ng d√πng await ƒë·ªÉ kh√¥ng ch·∫∑n lu·ªìng
            sendToServer({
               action: 'log_babyrun',
               username: username,
               fingerprint: userFingerprint
            }).then(res => {
               if (res.status !== 'success' && res.result !== 'success') {
                  throw new Error('L·ªói server');
               }
            }).catch(err => {
               console.error('L·ªói babyrun:', err);
               // Ho√†n t√°c n·∫øu l·ªói
               countEl.textContent = currentVal;
               showToast('L·ªói m·∫°ng! Kh√¥ng l∆∞u ƒë∆∞·ª£c.');
            });
      
            return; // D·ª´ng x·ª≠ l√Ω s·ª± ki·ªán click
         }
      });
      
      // --- H√ÄM L∆ØU L∆Ø·ª¢T ƒê·∫†P TH·ª¶ C√îNG --- 
      async function saveManualBikeEntry() {
         lastUserActionTime = Date.now(); // [M·ªöI]
         // 1. L·∫•y d·ªØ li·ªáu Input
         const dateInput = document.getElementById('manual-bike-date');
         const timeInput = document.getElementById('manual-bike-time');
      
         if (!dateInput || !timeInput || !dateInput.value || !timeInput.value) {
            showToast('Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß Ng√†y v√† Gi·ªù');
            return;
         }
      
         // 2. Chu·∫©n b·ªã d·ªØ li·ªáu
         const [year, month, day] = dateInput.value.split('-');
         const formattedDate = `${day}/${month}/${year}`; // dd/MM/yyyy
         const formattedTime = timeInput.value + ':00'; // HH:mm:ss
      
         // --- B∆Ø·ªöC QUAN TR·ªåNG: UI PH·∫¢N H·ªíI NGAY L·∫¨P T·ª®C ---
      
         // A. ƒê√≥ng Modal ngay (Kh√¥ng ch·ªù server)
         const modalEl = document.getElementById('addBikeEntryModal');
         const modalInstance = bootstrap.Modal.getInstance(modalEl);
         if (modalInstance) modalInstance.hide();
      
         // B. Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng ngay ("Gi·∫£ v·ªù" l√† ƒë√£ xong)
         showToast('ƒê√£ ghi nh·∫≠n l∆∞·ª£t ƒë·∫°p!');
      
         // C. C·∫≠p nh·∫≠t s·ªë li·ªáu tr√™n giao di·ªán NGAY (N·∫øu ng√†y ch·ªçn l√† "H√¥m nay")
         const today = new Date();
         const isToday = (parseInt(day) === today.getDate() &&
            parseInt(month) === (today.getMonth() + 1) &&
            parseInt(year) === today.getFullYear());
      
         let oldTodayCount = 0; // L∆∞u l·∫°i ƒë·ªÉ rollback n·∫øu l·ªói
         const countEl = document.getElementById('bike-count'); // S·ªë ·ªü m√†n h√¨nh ch√≠nh
         const statsTodayEl = document.getElementById('stats-today'); // S·ªë ·ªü trong Modal th·ªëng k√™
      
         if (isToday) {
            // C·∫≠p nh·∫≠t m√†n h√¨nh ch√≠nh
            if (countEl) {
               oldTodayCount = parseInt(countEl.textContent) || 0;
               countEl.textContent = oldTodayCount + 1;
      
               // Hi·ªáu ·ª©ng nh√∫n nh·∫£y cho s·ªë
               countEl.style.transition = "transform 0.2s";
               countEl.style.transform = "scale(1.3)";
               setTimeout(() => countEl.style.transform = "scale(1)", 200);
            }
            // C·∫≠p nh·∫≠t modal th·ªëng k√™ (n·∫øu ƒëang m·ªü)
            if (statsTodayEl) {
               const val = parseInt(statsTodayEl.textContent) || 0;
               statsTodayEl.textContent = val + 1;
            }
         }
      
         // --- B∆Ø·ªöC 3: G·ª¨I SERVER (CH·∫†Y NG·∫¶M - BACKGROUND) ---
         try {
            const res = await sendToServer({
               action: 'log_babyrun',
               username: currentProfile ? currentProfile.username : 'anonymous',
               customDate: formattedDate,
               customTime: formattedTime
            });
      
            if (res.status !== 'success' && res.result !== 'success') {
               throw new Error(res.message || 'L·ªói server');
            }
      
            // N·∫øu th√†nh c√¥ng th·∫≠t s·ª±: Reload ng·∫ßm l·∫°i th·ªëng k√™ ƒë·ªÉ ƒë·∫£m b·∫£o ƒë·ªìng b·ªô
            // (Kh√¥ng g·ªçi showBikeStats() v√¨ n√≥ s·∫Ω b·∫≠t modal l√™n, ch·ªâ g·ªçi c·∫≠p nh·∫≠t ng·∫ßm n·∫øu c·∫ßn)
            // ·ªû ƒë√¢y ta tin t∆∞·ªüng v√†o Optimistic UI n√™n kh√¥ng c·∫ßn reload l·∫°i ngay.
      
         } catch (e) {
            console.error("L·ªói l∆∞u server:", e);
      
            // --- ROLLBACK (N·∫æU L·ªñI) ---
            // Tr·∫£ l·∫°i s·ªë c≈© n·∫øu n√£y l·ª° c·ªông
            if (isToday && countEl) countEl.textContent = oldTodayCount;
            if (isToday && statsTodayEl) statsTodayEl.textContent = parseInt(statsTodayEl.textContent) - 1;
      
            showToast('L·ªói k·∫øt n·ªëi! ƒê√£ ho√†n t√°c d·ªØ li·ªáu.');
         }
      }
      
      // Ki·ªÉm tra ph·∫ßn t·ª≠ t·ªìn t·∫°i tr∆∞·ªõc khi g·∫Øn s·ª± ki·ªán
      const addBikeModalEl = document.getElementById('addBikeEntryModal');
      if (addBikeModalEl) {
         addBikeModalEl.addEventListener('show.bs.modal', function () {
            const now = new Date();
      
            // Set Date: YYYY-MM-DD
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');
      
            const dateInput = document.getElementById('manual-bike-date');
            if (dateInput) dateInput.value = `${yyyy}-${mm}-${dd}`;
      
            // Set Time: HH:mm
            const hh = String(now.getHours()).padStart(2, '0');
            const min = String(now.getMinutes()).padStart(2, '0');
      
            const timeInput = document.getElementById('manual-bike-time');
            if (timeInput) timeInput.value = `${hh}:${min}`;
         });
      }
      
      // --- H√ÄM X·ª¨ L√ù ƒêƒÇNG / C·∫¨P NH·∫¨T B√ÄI VI·∫æT (ƒê√É S·ª¨A) ---
      // X·ª≠ l√Ω ƒêƒÉng b√†i / L∆∞u b√†i vi·∫øt (OPTIMISTIC UI)
      // --- H√ÄM X·ª¨ L√ù ƒêƒÇNG / C·∫¨P NH·∫¨T B√ÄI VI·∫æT (FULL) ---
      // --- H√ÄM X·ª¨ L√ù ƒêƒÇNG B√ÄI (LOGIC K√âP: HD & STANDARD) ---
      // --- H√ÄM X·ª¨ L√ù ƒêƒÇNG B√ÄI (ƒê√É FIX L·ªñI M·∫§T ·∫¢NH KHI ƒê√ìNG MODAL) ---
      // --- H√ÄM X·ª¨ L√ù ƒêƒÇNG / S·ª¨A B√ÄI (TH√îNG MINH: KH√îNG UPLOAD L·∫†I ·∫¢NH C≈®) ---
      // --- H√ÄM X·ª¨ L√ù ƒêƒÇNG / S·ª¨A B√ÄI (ƒê√É FIX L·ªñI ID B√ÄI VI·∫æT B·ªä RESET) ---
      async function handlePostSubmit() {
         const contentInput = document.getElementById('post-input');
         const content = contentInput.value;
         const postBtn = document.getElementById('post-btn');
         const isHD = document.getElementById('hd-quality-switch').checked;
      
         // --- [FIX QUAN TR·ªåNG] L∆ØU LAYOUT V√ÄO BI·∫æN C·ª§C B·ªò NGAY L·∫¨P T·ª®C ---
         // Ph·∫£i l∆∞u ngay ·ªü ƒë√¢y, v√¨ n·∫øu ƒë·ªÉ xu·ªëng d∆∞·ªõi sau khi g·ªçi modal.hide()
         // th√¨ bi·∫øn to√†n c·ª•c selectedLayout s·∫Ω b·ªã reset v·ªÅ 'grid-2x2'
         const finalLayout = selectedLayout;
         // ---------------------------------------------------------------
      
         // 1. Sao ch√©p d·ªØ li·ªáu ƒë·ªÉ tr√°nh l·ªói khi ƒë√≥ng Modal
         const imagesToProcess = [...currentImages];
         const previewsToSave = [...currentImagePreviews];
      
         const isUpdateMode = isEditingPost;
         const postIdToUpdate = currentEditPostId;
      
         if (!content && imagesToProcess.length === 0) {
            showToast('Vui l√≤ng vi·∫øt g√¨ ƒë√≥ ho·∫∑c th√™m ·∫£nh!');
            return;
         }
      
         lastUserActionTime = Date.now();
         pendingTasksCount++;
         postBtn.disabled = true;
      
         // --- X·ª¨ L√ù OPTIMISTIC UI ---
         let tempId;
      
         if (isUpdateMode && postIdToUpdate) {
            tempId = postIdToUpdate;
            const postIndex = serverFeedData.findIndex(p => p.__backendId === tempId);
            if (postIndex !== -1) {
               serverFeedData[postIndex] = {
                  ...serverFeedData[postIndex],
                  content: content,
                  imageData: JSON.stringify(previewsToSave),
                  layout: finalLayout, // <--- S·ª¨A: D√πng bi·∫øn c·ª•c b·ªô
                  isUploading: true,
                  uploadStatus: 'ƒêang l∆∞u...'
               };
            }
         } else {
            tempId = 'temp_' + Date.now();
            const now = new Date();
            const newOptimisticPost = {
               __backendId: tempId,
               username: currentProfile ? currentProfile.username : 'AnDanh',
               fullname: currentProfile ? currentProfile.fullName : '·∫®n Danh',
               avatar: currentProfile ? currentProfile.avatarData : '',
               content: content,
               imageData: JSON.stringify(previewsToSave),
               createdAt: "V·ª´a xong",
               timestamp: now.getTime(),
               layout: finalLayout, // <--- S·ª¨A: D√πng bi·∫øn c·ª•c b·ªô
               likes: 0,
               liked: false,
               comments: '[]',
               isUploading: true,
               uploadStatus: 'ƒêang x·ª≠ l√Ω...'
            };
            serverFeedData.unshift(newOptimisticPost);
         }
      
         renderPosts();
      
         if (currentTab !== 'feed') document.querySelector('[data-tab="feed"]').click();
      
         // ƒê√≥ng Modal (L·ªánh n√†y s·∫Ω k√≠ch ho·∫°t s·ª± ki·ªán reset selectedLayout v·ªÅ m·∫∑c ƒë·ªãnh)
         createPostModal.hide();
      
         try {
            let finalImageData = [];
      
            // ... (ƒêo·∫°n x·ª≠ l√Ω upload ·∫£nh gi·ªØ nguy√™n) ...
            if (imagesToProcess.length > 0) {
               for (let i = 0; i < imagesToProcess.length; i++) {
                  const item = imagesToProcess[i];
                  if (typeof item === 'string') {
                     finalImageData.push(item);
                     continue;
                  }
                  const file = item;
                  const qualityText = isHD ? "HD" : "SD";
                  updatePostStatus(tempId, `Send ${i + 1}/${imagesToProcess.length} (${qualityText})`);
      
                  if (isHD) {
                     if (i > 0) await new Promise(r => setTimeout(r, 500));
                     const base64Data = await readFileAsBase64(file);
                     const fileName = new Date().getTime() + "_" + i;
      
                     const res = await sendToServer({
                        action: 'upload_single_image',
                        image: base64Data,
                        name: fileName
                     });
                     if (res.status === 'success') finalImageData.push(res.url);
                     else throw new Error("L·ªói ·∫£nh s·ªë " + (i + 1));
                  } else {
                     const compressedBase64 = await compressImage(file, 1920, 0.8);
                     finalImageData.push(compressedBase64);
                  }
               }
            }
      
            // ============================================================
            // G·ª¨I L·ªÜNH L√äN SERVER
            // ============================================================
            updatePostStatus(tempId, 'Post...');
      
            const res = await sendToServer({
               action: 'feed_action',
               type: isUpdateMode ? 'update' : 'create',
               id: isUpdateMode ? postIdToUpdate : undefined,
               username: currentProfile ? currentProfile.username : 'Anonymous',
               content: content,
               image: JSON.stringify(finalImageData),
               layout: finalLayout, // <--- S·ª¨A: D√πng bi·∫øn c·ª•c b·ªô thay v√¨ selectedLayout
               fingerprint: userFingerprint
            });
      
            if (res.status === 'success') {
               const targetId = isUpdateMode ? postIdToUpdate : tempId;
               const finalPost = serverFeedData.find(p => p.__backendId === targetId);
      
               if (finalPost) {
                  if (!isUpdateMode && res.id) finalPost.__backendId = res.id;
                  if (res.time) finalPost.createdAt = res.time;
                  if (res.images && res.images.length > 0) finalPost.imageData = JSON.stringify(res.images);
      
                  delete finalPost.isUploading;
                  delete finalPost.uploadStatus;
      
                  renderPosts();
                  showToast(isUpdateMode ? 'ƒê√£ c·∫≠p nh·∫≠t b√†i vi·∫øt!' : 'ƒê√£ ƒëƒÉng th√†nh c√¥ng!');
               }
            } else {
               throw new Error(res.message);
            }
      
         } catch (err) {
            console.error("L·ªói:", err);
            showToast('L·ªói: ' + err.message);
            const badgeEl = document.getElementById(`status-badge-${tempId}`);
            if (badgeEl) {
               badgeEl.className = "badge bg-danger text-white ms-auto";
               badgeEl.innerHTML = `<i class="bi bi-exclamation-triangle me-1"></i> L·ªói`;
            }
         } finally {
            postBtn.disabled = false;
            postBtn.innerHTML = '<i class="bi bi-send me-2"></i>ƒêƒÉng b√†i';
            pendingTasksCount--;
      
            if (contentInput) contentInput.value = '';
            currentImages = [];
            currentImagePreviews = [];
            document.getElementById('hd-quality-switch').checked = true;
         }
      }
      
      // H√†m ph·ª• tr·ª£ c·∫≠p nh·∫≠t tr·∫°ng th√°i UI cho g·ªçn code
      function updatePostStatus(tempId, text) {
         const tempPost = serverFeedData.find(p => p.__backendId === tempId);
         if (tempPost) tempPost.uploadStatus = text;
      
         const badgeEl = document.getElementById(`status-badge-${tempId}`);
         if (badgeEl) {
            badgeEl.innerHTML = `
      					<span class="spinner-border spinner-border-sm me-1" style="width: 0.7rem; height: 0.7rem;"></span>
      					${text}
      				`;
         }
      }
      
      // --- H√ÄM X√ìA B√ÄI VI·∫æT ---
      async function deletePost(postId) {
         if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†i vi·∫øt n√†y?')) return;
      
         // 1. ·∫®n b√†i vi·∫øt tr√™n giao di·ªán NGAY L·∫¨P T·ª®C (Optimistic UI)
         const postEl = document.getElementById(`post-${postId}`);
         if (postEl) {
            postEl.style.transition = "opacity 0.5s";
            postEl.style.opacity = "0";
            setTimeout(() => postEl.remove(), 500);
         }
      
         try {
            // 2. G·ª≠i l·ªánh x√≥a l√™n Server
            const res = await sendToServer({
               action: 'feed_action',
               type: 'delete',
               id: postId
            });
      
            if (res.status === 'success' || res.result === 'success') {
               showToast('ƒê√£ x√≥a b√†i vi·∫øt');
            } else {
               showToast('L·ªói x√≥a server: ' + res.message);
               // N·∫øu l·ªói th√¨ reload l·∫°i feed ƒë·ªÉ hi·ªán l·∫°i b√†i
               loadFeedData();
            }
         } catch (e) {
            console.error(e);
            showToast('L·ªói k·∫øt n·ªëi!');
         }
      }
      
      // --- 2. H√ÄM CHU·∫®N B·ªä FORM ƒê·ªÇ S·ª¨A (ƒê√É FIX LOAD ·∫¢NH) ---
      // --- 2. H√ÄM CHU·∫®N B·ªä FORM ƒê·ªÇ S·ª¨A (ƒê√É FIX LOAD ·∫¢NH PREVIEW) ---
      function openEditPost(id) {
         // 1. T√¨m b√†i vi·∫øt
         let post = null;
         if (typeof serverFeedData !== 'undefined' && serverFeedData.length > 0) {
            post = serverFeedData.find(d => d.__backendId === id);
         }
         if (!post) post = allData.find(d => d.__backendId === id);
      
         if (!post) {
            showToast("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu b√†i vi·∫øt!");
            return;
         }
      
         isEditingPost = true;
         currentEditPostId = id;
      
         // 2. ƒêi·ªÅn n·ªôi dung
         const contentInput = document.getElementById('post-input');
         if (contentInput) contentInput.value = post.content || '';
      
         // 3. X·ª≠ l√Ω ·∫£nh
         currentImages = parseImages(post.imageData);
      
         // [FIX QUAN TR·ªåNG] ƒê·ªìng b·ªô sang bi·∫øn Previews ƒë·ªÉ hi·ªÉn th·ªã l√™n UI
         // V√¨ ·∫£nh c≈© l√† Link URL n√™n c√≥ th·ªÉ d√πng l√†m src cho th·∫ª img lu√¥n
         currentImagePreviews = [...currentImages];
      
         // 4. X·ª≠ l√Ω Layout
         // N·∫øu layout c≈© l√† 'auto' (do d·ªØ li·ªáu c≈©) ho·∫∑c null -> √©p v·ªÅ 'grid-2x2'
         let postLayout = post.layout;
         if (!postLayout || postLayout === 'auto') postLayout = 'grid-2x2';
      
         selectedLayout = postLayout;
      
         if (currentImages.length >= 3) {
            document.getElementById('layout-selector').classList.remove('d-none');
            // G·ªçi h√†m update UI ƒë·ªÉ highlight ƒë√∫ng √¥ ƒëang l∆∞u
            updateLayoutSelectionUI(selectedLayout);
         } else {
            document.getElementById('layout-selector').classList.add('d-none');
            // Reset v·ªÅ m·∫∑c ƒë·ªãnh n·∫øu ·∫©n
            updateLayoutSelectionUI('grid-2x2');
         }
      
         // 5. C·∫≠p nh·∫≠t giao di·ªán Preview
         updateImagePreview();
      
         // 6. ƒê·ªïi ti√™u ƒë·ªÅ Modal
         const modalTitle = document.querySelector('#createPostModal .modal-title');
         if (modalTitle) modalTitle.textContent = "Ch·ªânh s·ª≠a b√†i vi·∫øt";
      
         const modalBtn = document.querySelector('#createPostModal .btn-primary');
         if (modalBtn) modalBtn.innerHTML = '<i class="bi bi-check-circle me-2"></i>L∆∞u thay ƒë·ªïi';
      
         // 7. M·ªü Modal
         createPostModal.show();
      
         // ·∫®n modal t√πy ch·ªçn c≈©
         postOptionsModal.hide();
      }
      
      // --- 3. S·ª¨A L·ªñI RESET FORM KHI ƒê√ìNG MODAL (FIX L·ªñI NULL) ---
      const createPostModalEl = document.getElementById('createPostModal');
      if (createPostModalEl) {
         createPostModalEl.addEventListener('hidden.bs.modal', function () {
            isEditingPost = false;
            currentEditPostId = null;
      
            // QUAN TR·ªåNG: D√πng ƒë√∫ng ID 'post-input' ƒë·ªÉ x√≥a tr·∫Øng
            const contentInput = document.getElementById('post-input');
            if (contentInput) contentInput.value = '';
      
            // Reset ·∫£nh v√† giao di·ªán v·ªÅ m·∫∑c ƒë·ªãnh
            currentImages = [];
            updateImagePreview();
      
            document.querySelector('#createPostModal .modal-title').textContent = "T·∫°o b√†i vi·∫øt";
            const modalBtn = document.querySelector('#createPostModal .btn-primary');
            if (modalBtn) modalBtn.innerHTML = '<i class="bi bi-send me-2"></i>ƒêƒÉng b√†i';
      
            selectedLayout = 'grid-2x2';
         });
      }
      
      // [S·ª¨A L·∫†I] H√†m t·∫£i Feed h·ªó tr·ª£ ch·∫ø ƒë·ªô l√†m m·ªõi ng·∫ßm (Background Refresh)
      async function loadFeedData(page = 1, isBackgroundRefresh = false) {
         const container = document.getElementById('posts-container');
         if (feedLoading) return;
         feedLoading = true;
       
         if (page === 1 && !isBackgroundRefresh) {
            container.innerHTML = '<div class="d-flex justify-content-center align-items-center py-5"><div class="spinner-border text-primary" role="status"></div></div>';
         }
      
         try {
            const payload = {
               action: 'get_feed',
               page: page,
               limit: 10,
               username: currentProfile ? currentProfile.username : ''
            };
      
            // N·∫øu ƒëang c√≥ filter hashtag, g·ª≠i k√®m l√™n server
            if (currentHashFilter) {
               payload.hashtag = currentHashFilter;
            } 
            const res = await sendToServer(payload); 
      
            if (res.status === 'success') {
               if (page === 1) {
                  serverFeedData = res.data;
               } else {
                  serverFeedData = serverFeedData.concat(res.data);
               }
               feedHasMore = res.hasMore;
               renderPostsPaged(res.data, page);
			   
			   try {
                    // L·∫•y 20 b√†i ƒë·∫ßu ti√™n
                    const cacheData = res.data.slice(0, 20);
                    // L∆∞u v√†o LocalStorage
                    localStorage.setItem('cached_feed_data', JSON.stringify(cacheData));
                } catch (e) {
                    console.warn("LocalStorage b·ªã ƒë·∫ßy, kh√¥ng l∆∞u ƒë∆∞·ª£c cache Feed", e);
                }
      
               // [Quan tr·ªçng] N·∫øu ƒëang l·ªçc m√† server tr·∫£ v·ªÅ r·ªóng
               if (page === 1 && res.data.length === 0) {
                  container.innerHTML = `<div class="text-center py-5 text-muted">
      							<i class="bi bi-search" style="font-size: 2rem;"></i>
      							<p class="mt-2">Kh√¥ng c√≥ d·ªØ li·ªáu tag <b>${currentHashFilter}</b></p>
      						 </div>`;
               }
       
               if (!currentHashFilter) 
					renderTrendingTags();
            } else { 
               if (page === 1 && !isBackgroundRefresh) container.innerHTML = '<div class="text-center py-5">L·ªói t·∫£i d·ªØ li·ªáu</div>';
            }
         } catch (e) {
            console.error(e);
            if (page === 1 && !isBackgroundRefresh) container.innerHTML = '<div class="text-center py-5">L·ªói k·∫øt n·ªëi</div>';
         } finally {
            feedLoading = false;
         }
      }
      
      // --- 1. TH√äM H√ÄM ƒê·ªíNG B·ªò S·ªê L∆Ø·ª¢NG CH∆ØA ƒê·ªåC ---
      async function syncUnreadCount() {
         try {
            const res = await sendToServer({
               action: 'get_unread_count'
            });
      
            if (res.status === 'success') {
               const badge = document.getElementById('notification-badge');
               const count = res.count;
      
               if (count > 0) {
                  // N·∫øu > 99 th√¨ hi·ªán 99+ cho g·ªçn
                  badge.textContent = count > 99 ? '99+' : count;
                  badge.classList.remove('d-none');
      
                  // Hi·ªáu ·ª©ng rung nh·∫π ƒë·ªÉ g√¢y ch√∫ √Ω
                  badge.style.animation = "none";
                  setTimeout(() => badge.style.animation = "heartBeat 0.5s", 10);
               } else {
                  badge.classList.add('d-none');
               }
            }
         } catch (e) {
            console.error("L·ªói l·∫•y s·ªë l∆∞·ª£ng noti:", e);
         }
      }
      
      // --- T√çNH NƒÇNG XEM ·∫¢NH FULL (LIGHTBOX) ---
      
      // G·∫Øn s·ª± ki·ªán click cho container ch·ª©a b√†i vi·∫øt
      document.getElementById('posts-container').addEventListener('click', (e) => {
         // T√¨m xem ng∆∞·ªùi d√πng c√≥ click v√†o khung ·∫£nh (.img-box) kh√¥ng
         const imgBox = e.target.closest('.img-box');
      
         if (imgBox) {
            // T√¨m b√†i vi·∫øt t∆∞∆°ng ·ª©ng
            const postCard = imgBox.closest('.post-card');
            if (postCard) {
               // L·∫•y ID b√†i vi·∫øt (d·∫°ng post-UID -> l·∫•y UID)
               const postId = postCard.id.replace('post-', '');
               openImageViewer(postId);
            }
         }
      });
      
      function openImageViewer(postId) {
         // 1. T√¨m d·ªØ li·ªáu b√†i vi·∫øt
         const post = serverFeedData.find(p => p.__backendId === postId);
         if (!post) return;
      
         // 2. L·∫•y danh s√°ch ·∫£nh
         const images = parseImages(post.imageData);
         if (!images || images.length === 0) return;
      
         // 3. Render ·∫£nh v√†o Modal
         const container = document.getElementById('full-image-list');
         const counter = document.getElementById('viewer-counter');
      
         container.innerHTML = '';
         counter.textContent = `Chi ti·∫øt (${images.length} ·∫£nh)`;
      
         images.forEach((imgUrl, index) => {
            // T·∫°o container wrapper
            const wrapper = document.createElement('div');
            wrapper.className = "lightbox-item"; // S·ª≠ d·ª•ng class CSS m·ªõi t·∫°o
      
            // T·∫°o th·∫ª ·∫£nh
            const img = document.createElement('img');
            img.src = imgUrl;
            img.className = "lightbox-image"; // S·ª≠ d·ª•ng class CSS m·ªõi t·∫°o
            img.alt = `·∫¢nh chi ti·∫øt ${index + 1}`;
      
            // Lazy load ƒë·ªÉ m·ªü modal nhanh h∆°n
            img.loading = "lazy";
      
            wrapper.appendChild(img);
            container.appendChild(wrapper);
         });
      
         // 4. Hi·ªÉn th·ªã Modal
         imageViewerModal.show();
      }
      
      // Th√™m v√†o v√πng Utils
      function readFileAsBase64(file) {
         return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
            reader.readAsDataURL(file);
         });
      }
      
      // X·ª≠ l√Ω khi ƒë√≥ng modal ƒë·ªÉ x√≥a s·∫°ch d·ªØ li·ªáu (ti·∫øt ki·ªám b·ªô nh·ªõ)
      document.getElementById('imageViewerModal').addEventListener('hidden.bs.modal', function () {
         document.getElementById('full-image-list').innerHTML = '';
      });
      
      // --- T√çNH NƒÇNG T·ª∞ ƒê·ªòNG C·∫¨P NH·∫¨T (BACKGROUND SYNC) ---
      
      async function runBackgroundSync() {
         // --- CHECK 1: KI·ªÇM TRA ƒê·∫¶U V√ÄO (Nh∆∞ c≈©) ---
         if (typeof isEditingPost !== 'undefined' && isEditingPost) return;
         if (typeof pendingTasksCount !== 'undefined' && pendingTasksCount > 0) return;
         if (typeof lastUserActionTime !== 'undefined' && (Date.now() - lastUserActionTime < 10000)) return;
      
         console.log("ƒêang ch·∫°y ƒë·ªìng b·ªô ng·∫ßm...");
      
         // C√°c h√†m ƒë·ªìng b·ªô nh·∫π (Notification, Stats...) c√≥ th·ªÉ ƒë·ªÉ ch·∫°y t·ª± nhi√™n
         syncUnreadCount();
         syncBabyRunStats();
         loadNotifications(1);
      
         // --- PH·∫¶N QUAN TR·ªåNG: ƒê·ªíNG B·ªò FEED ---
         try {
            // G·ªçi Server (M·∫•t 1-2 gi√¢y ƒë·ªÉ ph·∫£n h·ªìi)
            const res = await sendToServer({
               action: 'get_feed',
               page: 1,
               limit: 5
            });
      
            // ============================================================
            // [QUAN TR·ªåNG] CHECK 2: KI·ªÇM TRA L·∫†I SAU KHI C√ì D·ªÆ LI·ªÜU
            // ============================================================
            // L√Ω do: Trong l√∫c ch·ªù server (1-2s kia), c√≥ th·ªÉ ng∆∞·ªùi d√πng ƒë√£ k·ªãp ·∫•n "ƒêƒÉng b√†i"
            // N·∫øu l√∫c n√†y ta v·∫Ω l·∫°i giao di·ªán th√¨ s·∫Ω l√†m h·ªèng b√†i ƒëƒÉng m·ªõi c·ªßa h·ªç.
      
            if (typeof isEditingPost !== 'undefined' && isEditingPost) {
               console.log("H·ªßy sync feed v√¨ ng∆∞·ªùi d√πng ƒëang s·ª≠a b√†i.");
               return;
            }
            if (typeof pendingTasksCount !== 'undefined' && pendingTasksCount > 0) {
               console.log("H·ªßy sync feed v√¨ ph√°t hi·ªán t√°c v·ª• upload m·ªõi.");
               return;
            }
            if (typeof lastUserActionTime !== 'undefined' && (Date.now() - lastUserActionTime < 10000)) {
               console.log("H·ªßy sync feed v√¨ ng∆∞·ªùi d√πng v·ª´a thao t√°c.");
               return;
            }
            // ============================================================
      
            if (res.status === 'success' && res.data.length > 0) {
               processNewFeedData(res.data);
            }
         } catch (e) {
            console.warn("L·ªói sync ng·∫ßm:", e);
         }
      }
      
      // H√†m x·ª≠ l√Ω d·ªØ li·ªáu Feed m·ªõi (Ch·ªâ th√™m b√†i ch∆∞a c√≥)
      // [FIX] H√†m x·ª≠ l√Ω d·ªØ li·ªáu Feed: H·ªó tr·ª£ c·∫£ Th√™m, S·ª≠a v√† X√≥a t·ª± ƒë·ªông
      function processNewFeedData(newPosts) {
         if (!serverFeedData) return;
      
         const container = document.getElementById('posts-container');
      
         // ============================================================
         // 1. X·ª¨ L√ù DELETE (X√≥a b√†i ƒë√£ m·∫•t tr√™n server kh·ªèi Client)
         // ============================================================
         if (newPosts.length > 0) {
            // L·∫•y timestamp c·ªßa b√†i C≈® NH·∫§T trong danh s√°ch v·ª´a t·∫£i v·ªÅ (l√†m m·ªëc)
            // V√≠ d·ª•: Server tr·∫£ v·ªÅ 5 b√†i m·ªõi nh·∫•t, b√†i th·ª© 5 l√† m·ªëc th·ªùi gian.
            const oldestFetchedTime = newPosts[newPosts.length - 1].timestamp;
      
            // Duy·ªát qua c√°c b√†i ƒëang hi·ªÉn th·ªã tr√™n m√†n h√¨nh
            // (Clone m·∫£ng b·∫±ng [...] ƒë·ªÉ tr√°nh l·ªói khi splice tr·ª±c ti·∫øp)
            [...serverFeedData].forEach((localPost) => {
               // Logic: N·∫øu b√†i ·ªü local c√≥ th·ªùi gian >= m·ªëc th·ªùi gian v·ª´a t·∫£i v·ªÅ
               // (nghƒ©a l√† n√≥ thu·ªôc ph·∫°m vi Top 5 b√†i m·ªõi nh·∫•t)
               // NH∆ØNG l·∫°i kh√¥ng t√¨m th·∫•y trong danh s√°ch newPosts -> ƒê√£ b·ªã x√≥a tr√™n Server.
               if (localPost.timestamp >= oldestFetchedTime) {
                  const stillExists = newPosts.some(p => p.__backendId === localPost.__backendId);
      
                  if (!stillExists) {
                     // A. X√≥a kh·ªèi giao di·ªán
                     const el = document.getElementById(`post-${localPost.__backendId}`);
                     if (el) {
                        el.style.transition = "all 0.5s";
                        el.style.opacity = "0";
                        el.style.height = "0";
                        setTimeout(() => el.remove(), 500);
                     }
      
                     // B. X√≥a kh·ªèi b·ªô nh·ªõ ƒë·ªám
                     const realIndex = serverFeedData.findIndex(p => p.__backendId === localPost.__backendId);
                     if (realIndex > -1) serverFeedData.splice(realIndex, 1);
      
                     console.log("ƒê√£ ƒë·ªìng b·ªô: X√≥a b√†i", localPost.__backendId);
                  }
               }
            });
         }
      
         // ============================================================
         // 2. X·ª¨ L√ù ADD (Th√™m) & UPDATE (S·ª≠a)
         // ============================================================
         // Duy·ªát ng∆∞·ª£c t·ª´ c≈© -> m·ªõi ƒë·ªÉ ch√®n l√™n ƒë·∫ßu ƒë√∫ng th·ª© t·ª±
         for (let i = newPosts.length - 1; i >= 0; i--) {
            const serverPost = newPosts[i];
            const localIndex = serverFeedData.findIndex(p => p.__backendId === serverPost.__backendId);
      
            // --- TR∆Ø·ªúNG H·ª¢P 1: B√ÄI VI·∫æT M·ªöI (ADD) ---
            if (localIndex === -1) {
               serverFeedData.unshift(serverPost);
      
               if (container) {
                  // X√≥a th√¥ng b√°o r·ªóng n·∫øu c√≥
                  const emptyMsg = container.querySelector('.text-center.py-5');
                  if (emptyMsg && emptyMsg.innerText.includes('Ch∆∞a c√≥ b√†i')) emptyMsg.remove();
      
                  const postHtml = createPostHtml(serverPost);
                  container.insertAdjacentHTML('afterbegin', postHtml);
      
                  // Hi·ªáu ·ª©ng highlight m√†u xanh nh·∫π
                  const newEl = document.getElementById(`post-${serverPost.__backendId}`);
                  if (newEl) {
                     newEl.style.backgroundColor = "#f0fdf4";
                     setTimeout(() => newEl.style.backgroundColor = "", 2000);
                  }
               }
            }
            // --- TR∆Ø·ªúNG H·ª¢P 2: B√ÄI VI·∫æT ƒê√É C√ì (UPDATE) ---
            else {
               const localPost = serverFeedData[localIndex];
      
               // So s√°nh xem c√≥ g√¨ thay ƒë·ªïi kh√¥ng (N·ªôi dung, ·∫¢nh, Layout, Like...)
               const isChanged =
                  localPost.content !== serverPost.content ||
                  localPost.imageData !== serverPost.imageData ||
                  localPost.layout !== serverPost.layout ||
                  localPost.likes !== serverPost.likes;
      
               if (isChanged) {
                  console.log("ƒê√£ ƒë·ªìng b·ªô: C·∫≠p nh·∫≠t b√†i", serverPost.__backendId);
      
                  // A. C·∫≠p nh·∫≠t d·ªØ li·ªáu v√†o b·ªô nh·ªõ (Merge ƒë√® l√™n c√°i c≈©)
                  serverFeedData[localIndex] = {
                     ...localPost,
                     ...serverPost
                  };
      
                  // B. V·∫Ω l·∫°i giao di·ªán (Render l·∫°i HTML)
                  const existingEl = document.getElementById(`post-${serverPost.__backendId}`);
                  if (existingEl) {
                     // T·∫°o HTML m·ªõi t·ª´ d·ªØ li·ªáu m·ªõi
                     const newHtmlFull = createPostHtml(serverPost);
      
                     // M·∫πo: T·∫°o div t·∫°m ƒë·ªÉ l·∫•y n·ªôi dung b√™n trong, gi·ªØ nguy√™n th·∫ª bao ngo√†i c≈©
                     const tempDiv = document.createElement('div');
                     tempDiv.innerHTML = newHtmlFull;
                     const newContent = tempDiv.firstElementChild.innerHTML;
      
                     // G√°n n·ªôi dung m·ªõi v√†o
                     existingEl.innerHTML = newContent;
      
                     // Hi·ªáu ·ª©ng nh√°y v√†ng nh·∫π b√°o hi·ªáu v·ª´a update
                     existingEl.style.transition = "background-color 0.5s";
                     existingEl.style.backgroundColor = "#fffbeb";
                     setTimeout(() => existingEl.style.backgroundColor = "", 1000);
                  }
               }
            }
         }
      }
      
      // H√†m c·∫≠p nh·∫≠t giao di·ªán √¥ ch·ªçn Layout (Highlight √¥ ƒë∆∞·ª£c ch·ªçn)
      function updateLayoutSelectionUI(layoutName) {
         // C·∫≠p nh·∫≠t bi·∫øn to√†n c·ª•c
         selectedLayout = layoutName;
      
         // C·∫≠p nh·∫≠t giao di·ªán (x√≥a class selected c≈©, th√™m v√†o √¥ m·ªõi)
         document.querySelectorAll('.layout-preview-box').forEach(opt => {
            opt.classList.remove('selected');
            if (opt.dataset.layout === layoutName) {
               opt.classList.add('selected');
            }
         });
      }
      
      // --- H√ÄM X·ª¨ L√ù K√âO ƒê·ªÇ L√ÄM M·ªöI (PULL TO REFRESH) --- 
      function setupPullToRefresh() {
         const container = document.querySelector('.main-content');
         const ptrElement = document.getElementById('ptr-element');
         const progressCircle = document.getElementById('ptr-progress-circle');
      
         // C·∫•u h√¨nh
         const threshold = 100;
         const maxPull = 160;
         const circumference = 76;
      
         let startY = 0;
         let isPulling = false;
         let isReadyToRefresh = false;
      
         // 1. CH·∫†M TAY (TOUCH START)
         container.addEventListener('touchstart', (e) => {
            if (container.scrollTop <= 0) {
               startY = e.touches[0].clientY;
               isPulling = true;
               isReadyToRefresh = false;
      
               ptrElement.classList.add('is-pulling');
               ptrElement.classList.remove('ptr-loading');
      
               // Reset v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu
               progressCircle.style.strokeDashoffset = circumference;
      
               // [QUAN TR·ªåNG] Reset v·ªÅ m√†u ƒê·ªé khi b·∫Øt ƒë·∫ßu k√©o l·∫°i
               progressCircle.style.stroke = 'red';
            }
         }, {
            passive: true
         });
      
         // 2. K√âO TAY (TOUCH MOVE)
         container.addEventListener('touchmove', (e) => {
            if (!isPulling) return;
      
            const currentY = e.touches[0].clientY;
            const diff = currentY - startY;
      
            if (diff > 0 && container.scrollTop <= 0) {
               if (e.cancelable) e.preventDefault();
      
               let pullDistance = diff * 0.5;
               if (pullDistance > maxPull) pullDistance = maxPull;
      
               ptrElement.style.height = `${pullDistance}px`;
      
               let progress = pullDistance / threshold;
               if (progress > 1) progress = 1;
      
               const offset = circumference - (progress * circumference);
               progressCircle.style.strokeDashoffset = offset;
      
               // X·ª≠ l√Ω logic ƒë·∫°t ng∆∞·ª°ng (Ch·ªâ rung, kh√¥ng ƒë·ªïi m√†u ·ªü ƒë√¢y n·ªØa ƒë·ªÉ gi·ªØ m√†u ƒë·ªè)
               if (progress >= 1 && !isReadyToRefresh) {
                  isReadyToRefresh = true;
                  if (navigator.vibrate) navigator.vibrate(15);
               } else if (progress < 1 && isReadyToRefresh) {
                  isReadyToRefresh = false;
               }
            } else {
               isPulling = false;
               ptrElement.style.height = '0px';
               ptrElement.classList.remove('is-pulling');
            }
         }, {
            passive: false
         });
      
         // 3. TH·∫¢ TAY (TOUCH END)
         container.addEventListener('touchend', async () => {
            if (!isPulling) return;
      
            isPulling = false;
            ptrElement.classList.remove('is-pulling');
      
            if (isReadyToRefresh) {
               // A. ƒê√É ƒê·∫†T NG∆Ø·ª†NG -> B·∫ÆT ƒê·∫¶U LOAD
               ptrElement.style.height = '60px';
               ptrElement.classList.add('ptr-loading');
      
               // [QUAN TR·ªåNG] ƒê·ªïi sang m√†u XANH #006b68 khi b·∫Øt ƒë·∫ßu quay
               progressCircle.style.stroke = '#006b68';
      
               // T·∫°o h√¨nh ch·ªØ C quay tr√≤n
               progressCircle.style.strokeDashoffset = '20';
      
               // G·ªçi h√†m refresh
               await handlePageRefresh();
      
               // B. LOAD XONG -> ƒê√ìNG L·∫†I
               setTimeout(() => {
                  ptrElement.style.height = '0px';
                  setTimeout(() => {
                     ptrElement.classList.remove('ptr-loading');
                     progressCircle.style.strokeDashoffset = circumference;
                     // Reset l·∫°i m√†u ƒë·ªè cho l·∫ßn sau (ƒë·ªÅ ph√≤ng)
                     progressCircle.style.stroke = 'red';
                  }, 300);
               }, 500);
            } else {
               // C. H·ª¶Y B·ªé
               ptrElement.style.height = '0px';
               setTimeout(() => {
                  progressCircle.style.strokeDashoffset = circumference;
                  progressCircle.style.stroke = 'red';
               }, 300);
            }
         });
      }
      
      // H√†m ƒëi·ªÅu ph·ªëi l√†m m·ªõi d·ªØ li·ªáu
      async function handlePageRefresh() {
		   console.log("ƒêang l√†m m·ªõi trang:", currentTab);
		   try {
			  if (currentTab === 'feed') {
				 feedPage = 1;
				 await loadFeedData(1, true); // true = t·∫£i ng·∫ßm
			  } else if (currentTab === 'home') {
				 // 1. T·∫£i l·∫°i s·ªë li·ªáu quan tr·ªçng tr∆∞·ªõc
				 await loadCriticalStats();
				 
				 // 2. T·∫£i c√°c th√¥ng tin ph·ª• sau
				 loadBackgroundInfo();
				 
				 renderStats();
				 updateStats();
			  }
		   } catch (e) {
			  console.error("L·ªói refresh:", e);
		   }
		}
      
      // H√†m m·ªü form s·ª≠a giao d·ªãch
      function openEditGoldTx(id) {
         const tx = goldPortfolioData.find(t => t.id === id);
         if (!tx) {
            showToast("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu!");
            return;
         }
      
         // 1. Set tr·∫°ng th√°i sang S·ª≠a
         isEditingGold = true;
         currentEditGoldId = id;
      
         // 2. ƒêi·ªÅn d·ªØ li·ªáu c≈© v√†o Form
         document.getElementById('gold-trans-date').value = tx.date; // yyyy-MM-dd
         document.getElementById('gold-trans-type').value = tx.type;
         document.getElementById('gold-trans-qty').value = tx.quantity_chi;
         document.getElementById('gold-trans-price').value = tx.price_per_chi;
         document.getElementById('gold-trans-note').value = tx.note || '';
      
         // 3. ƒê·ªïi ti√™u ƒë·ªÅ Modal v√† N√∫t b·∫•m cho d·ªÖ hi·ªÉu
         document.querySelector('#addGoldEntryModal .modal-title').innerHTML = '<i class="bi bi-pencil-square me-2"></i>S·ª≠a Giao D·ªãch';
         document.getElementById('save-gold-transaction').textContent = 'C·∫≠p nh·∫≠t';
      
         // 4. M·ªü Modal
         const modal = new bootstrap.Modal(document.getElementById('addGoldEntryModal'));
         modal.show();
      }
      
      // --- H√ÄM TI·ªÜN √çCH: ƒê√ìNG T·∫§T C·∫¢ MODAL ---
      function closeAllModals() {
         // 1. Danh s√°ch t·∫•t c·∫£ c√°c bi·∫øn Modal ƒëang d√πng
         const allModals = [
            createPostModal, createMemoryModal, createAlbumModal, albumDetailModal,
            commentModal, profileModal, postOptionsModal, deleteConfirmModal,
            bikeStatsModal, addBikeEntryModal, goldStatsModal, addGoldEntryModal,
            notificationsModal, imageViewerModal
         ];
      
         // 2. Duy·ªát qua v√† ·∫©n t·ª´ng c√°i n·∫øu n√≥ ƒëang t·ªìn t·∫°i
         allModals.forEach(modal => {
            if (modal) modal.hide();
         });
      
         // 3. D·ªçn d·∫πp s·∫°ch s·∫Ω c√°c l·ªõp n·ªÅn ƒëen (backdrop) n·∫øu c√≤n s√≥t l·∫°i
         // (Ph√≤ng tr∆∞·ªùng h·ª£p b·∫•m nhanh qu√° Bootstrap ch∆∞a k·ªãp x√≥a DOM)
         setTimeout(() => {
            document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
            document.body.classList.remove('modal-open');
            document.body.style = ''; // Reset style c·ªßa body
         }, 150); // ƒê·ª£i m·ªôt ch√∫t cho hi·ªáu ·ª©ng ·∫©n modal ch·∫°y xong
      }
      
      // --- H√ÄM HELPER: T·∫†O HTML CHO 1 B√åNH LU·∫¨N (GIAO DI·ªÜN M·ªöI) ---
      // --- H√ÄM T·∫†O HTML B√åNH LU·∫¨N (GIAO DI·ªÜN M·ªöI: T√äN + TIME + MENU C√ôNG D√íNG) ---
      // --- H√ÄM T·∫†O HTML B√åNH LU·∫¨N (ƒê√É S·ª¨A: N√öT 3 CH·∫§M CƒÇN S√ÅT M√âP PH·∫¢I) ---
      function createCommentHtml(cmt) {
         const currentUser = currentProfile ? currentProfile.username : '';
         const isOwner = (currentUser && cmt.username === currentUser);
      
         const menuHtml = isOwner ?
            `<button class="btn btn-sm text-muted p-0 comment-options-btn" 
      						   style="line-height: 1.2;"
      						   data-id="${cmt.id}" data-content="${cmt.content}" data-post-id="${cmt.postId || ''}">
      					 <i class="bi bi-three-dots"></i>
      				   </button>` :
            '';
      
         const avatarHtml = cmt.avatar ?
            `<img src="${cmt.avatar}" class="w-100 h-100 object-fit-cover">` :
            `<span class="small fw-bold">${cmt.fullname.charAt(0).toUpperCase()}</span>`;
      
         const timeDisplay = formatTimeSmart(cmt.time || cmt.formattedTime || new Date());
      
         return `
      				<div class="d-flex mb-2 comment-item" id="comment-${cmt.id}">
      					<div class="avatar-circle avatar-circle-sm me-1 flex-shrink-0 overflow-hidden border" style="width: 32px; height: 32px;">
      						${avatarHtml}
      					</div>
      					
      					<div class="flex-grow-1" style="min-width: 0;">
      						<div class="bg-light rounded-3 p-2 px-3 d-inline-block position-relative" style="width: 100%;">
      							
      							<div class="d-flex align-items-center justify-content-between mb-1">
      								
      								<div class="d-flex align-items-center" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
      									<span class="fw-bold small me-1 text-dark">${cmt.fullname}</span>
      									<span class="text-muted mx-1" style="font-size: 0.3rem;">‚óè</span>
      									<small class="text-muted" style="font-size: 0.6rem;">${timeDisplay}</small>
      								</div>
      								
      								<div class="ms-2">
      									 ${menuHtml}
      								</div>
      							</div>
      
      							<p class="mb-0 text-dark small content-text" style="word-wrap: break-word; word-break: break-word; white-space: pre-wrap;">${cmt.content}</p>
      						</div>
      					</div>
      				</div>
      			`;
      }
      
      // 1. S·ª∞ KI·ªÜN CLICK TRONG POST CONTAINER
      document.getElementById('posts-container').addEventListener('click', async (e) => {
      
         // A. B·∫§M N√öT "B√åNH LU·∫¨N" (Hi·ªán √¥ nh·∫≠p)
         const showInputBtn = e.target.closest('.show-comment-input-btn');
         if (showInputBtn) {
            const pid = showInputBtn.dataset.id;
            const box = document.getElementById(`comment-input-box-${pid}`);
            box.classList.toggle('d-none');
            if (!box.classList.contains('d-none')) {
               document.getElementById(`input-cmt-${pid}`).focus();
            }
            return;
         }
      
         // B. B·∫§M G·ª¨I B√åNH LU·∫¨N (INLINE)
         const sendBtn = e.target.closest('.send-inline-cmt-btn');
         if (sendBtn) {
            const pid = sendBtn.dataset.id;
            const input = document.getElementById(`input-cmt-${pid}`);
            const content = input.value.trim();
            if (!content) return;
      
            // UI L·∫°c quan: Th√™m ngay v√†o danh s√°ch v·ªõi ID t·∫°m
            const container = document.getElementById(`comments-container-${pid}`);
            const tempId = 'temp_' + Date.now();
            const tempCmt = {
               id: tempId,
               username: currentProfile.username,
               fullname: currentProfile.fullName,
               avatar: currentProfile.avatarData,
               content: content,
               formattedTime: "ƒêang g·ª≠i..."
            };
      
            // N·∫øu ch∆∞a c√≥ class padding th√¨ th√™m v√†o cho ƒë·∫πp
            if (!container.parentElement.classList.contains('bg-light')) {
               container.parentElement.className = "comments-section bg-light rounded-3 p-2 mt-3 fade-in";
            }
      
            container.insertAdjacentHTML('beforeend', createCommentHtml(tempCmt));
            input.value = ''; // X√≥a √¥ nh·∫≠p
      
            // --- [PH·∫¶N S·ª¨A L·∫†I] X·ª≠ l√Ω c·∫≠p nh·∫≠t sau khi g·ª≠i th√†nh c√¥ng ---
            try {
               const res = await sendToServer({
                  action: 'comment_action',
                  type: 'add',
                  postId: pid,
                  username: currentProfile.username,
                  content: content
               });
      
               if (res.status === 'success') {
                  // 1. T√¨m l·∫°i d√≤ng b√¨nh lu·∫≠n v·ª´a th√™m b·∫±ng ID t·∫°m
                  const newItem = document.getElementById(`comment-${tempId}`);
                  if (newItem) {
                     // 2. C·∫≠p nh·∫≠t th·ªùi gian: "ƒêang g·ª≠i..." -> "V·ª´a xong"
                     // T√¨m th·∫ª small c√≥ class text-muted ch·ª©a th·ªùi gian
                     const timeEl = newItem.querySelector('small.text-muted');
                     if (timeEl) timeEl.textContent = "V·ª´a xong";
      
                     // 3. C·∫≠p nh·∫≠t ID th·∫≠t t·ª´ Server tr·∫£ v·ªÅ (ƒë·ªÉ c√≥ th·ªÉ S·ª≠a/X√≥a ngay l·∫≠p t·ª©c)
                     if (res.id) {
                        newItem.id = `comment-${res.id}`; // ƒê·ªïi ID c·ªßa th·∫ª cha
      
                        // C·∫≠p nh·∫≠t data-id cho n√∫t 3 ch·∫•m (Menu t√πy ch·ªçn)
                        const optionBtn = newItem.querySelector('.comment-options-btn');
                        if (optionBtn) {
                           optionBtn.dataset.id = res.id;
                           // C·∫≠p nh·∫≠t l·∫°i n·ªôi dung g·ªëc v√†o data-content ƒë·ªÉ t√≠nh nƒÉng S·ª≠a ho·∫°t ƒë·ªông ƒë√∫ng
                           optionBtn.dataset.content = content;
                        }
                     }
                  }
               }
            } catch (e) {
               console.error(e);
               // N·∫øu l·ªói: C√≥ th·ªÉ hi·ªán th√¥ng b√°o ho·∫∑c x√≥a comment t·∫°m ƒëi
               const newItem = document.getElementById(`comment-${tempId}`);
               if (newItem) newItem.remove(); // X√≥a comment t·∫°m n·∫øu l·ªói
               showToast('L·ªói g·ª≠i b√¨nh lu·∫≠n!');
            }
            return;
         }
      
         // C. B·∫§M MENU 3 CH·∫§M C·ª¶A COMMENT
         const optBtn = e.target.closest('.comment-options-btn');
         if (optBtn) {
            currentCommentId = optBtn.dataset.id;
            currentCommentContent = optBtn.dataset.content;
            commentOptionsModal.show();
         }
      });
      
      // 2. X·ª¨ L√ù TRONG MODAL T√ôY CH·ªåN COMMENT
      
      // N√∫t X√≥a
      // --- S·ª¨A L·∫†I: N√öT X√ìA TRONG MENU B√åNH LU·∫¨N ---
      document.getElementById('delete-comment-btn').addEventListener('click', () => {
         if (!currentCommentId) return;
      
         // 1. ƒê√≥ng modal t√πy ch·ªçn (3 ch·∫•m)
         commentOptionsModal.hide();
      
         // 2. M·ªü modal x√°c nh·∫≠n x√≥a chung
         // type: 'comment' ƒë·ªÉ ph√¢n bi·ªát
         showDeleteConfirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b√¨nh lu·∫≠n n√†y?', currentCommentId, 'comment');
      });
      
      // N√∫t S·ª≠a (M·ªü modal nh·∫≠p li·ªáu)
      document.getElementById('edit-comment-btn').addEventListener('click', () => {
         commentOptionsModal.hide();
         document.getElementById('edit-comment-input').value = currentCommentContent;
         editCommentContentModal.show();
      });
      
      // N√∫t L∆∞u (Trong modal s·ª≠a)
      document.getElementById('save-edit-comment').addEventListener('click', async () => {
         const newContent = document.getElementById('edit-comment-input').value.trim();
         if (!newContent || !currentCommentId) return;
      
         editCommentContentModal.hide();
      
         // UI L·∫°c quan: C·∫≠p nh·∫≠t text ngay
         const el = document.getElementById(`comment-${currentCommentId}`);
         if (el) {
			const oldContent = currentCommentContent; // L∆∞u n·ªôi dung c≈©
            el.querySelector('.content-text').textContent = newContent;
            // C·∫≠p nh·∫≠t l·∫°i data-content cho n√∫t 3 ch·∫•m ƒë·ªÉ l·∫ßn sau s·ª≠a ti·∫øp
            const btn = el.querySelector('.comment-options-btn');
            if (btn) btn.dataset.content = newContent;
         }
      
         
		 try {
				// G·ª≠i Server
				 await sendToServer({
					action: 'comment_action',
					type: 'edit',
					commentId: currentCommentId,
					username: currentProfile.username,
					content: newContent
				 });
			} catch (e) {
				el.querySelector('.content-text').textContent = oldContent; // Ho√†n t√°c n·∫øu l·ªói
				showToast('L·ªói s·ª≠a b√¨nh lu·∫≠n');
			}

      });
      
      // --- H√ÄM T·∫¢I COMMENT T·ª™ SERVER ---
      async function loadCommentsForPost(postId) {
         const container = document.getElementById('comments-list');
         container.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div></div>';
      
         try {
            const res = await sendToServer({
               action: 'get_post_comments',
               postId: postId
            });
      
            if (res.status === 'success') {
               const comments = res.data;
               if (!comments || comments.length === 0) {
                  container.innerHTML = `<div class="text-center py-5">
      							<i class="bi bi-chat-dots text-muted" style="font-size: 3rem;"></i>
      							<p class="text-muted mt-2">Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o. H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n!</p>
      						</div>`;
               } else {
                  // S·ª≠ d·ª•ng h√†m helper ƒë√£ t·∫°o ·ªü tr√™n
                  container.innerHTML = comments.map(cmt => createCommentHtml(cmt)).join('');
               }
            } else {
               container.innerHTML = '<p class="text-center text-muted py-5">L·ªói t·∫£i b√¨nh lu·∫≠n</p>';
            }
         } catch (e) {
            console.error(e);
            container.innerHTML = '<p class="text-center text-muted py-5">L·ªói k·∫øt n·ªëi</p>';
         }
      }
      
      // --- HASHTAG LOGIC START ---
      
      // Th√™m h√†m n√†y v√†o ph·∫ßn Utils
		function escapeHtml(text) {
			if (!text) return text;
			return text
				.replace(/&/g, "&amp;")
				.replace(/</g, "&lt;")
				.replace(/>/g, "&gt;")
				.replace(/"/g, "&quot;")
				.replace(/'/g, "&#039;");
		}

		// S·ª≠a l·∫°i h√†m n√†y
		function processTextWithHashtags(text) {
		   if (!text) return '';
		   // B∆Ø·ªöC 1: L√ÄM S·∫†CH CODE HTML TR∆Ø·ªöC
		   const safeText = escapeHtml(text); 
		   // B∆Ø·ªöC 2: M·ªöI G·∫ÆN LINK HASHTAG
		   return safeText.replace(/(^|\s)(#[\w\p{L}]+)/gu, '$1<span class="hashtag" onclick="filterByHashtag(\'$2\')">$2</span>');
		}
      
      // H√†m 2: Th·ªëng k√™ Hashtag t·ª´ d·ªØ li·ªáu feed
      function renderTrendingTags() {
         if (!serverFeedData || serverFeedData.length === 0) return;
      
         const tagCounts = {};
      
         // Qu√©t to√†n b·ªô b√†i vi·∫øt ƒë·ªÉ ƒë·∫øm tag
         serverFeedData.forEach(post => {
            if (!post.content) return;
            // T√¨m t·∫•t c·∫£ c√°c tag trong n·ªôi dung
            const matches = post.content.match(/#[\w\p{L}]+(?=\s|$)/gu);
            if (matches) {
               matches.forEach(tag => {
                  const cleanTag = tag.trim(); // B·ªè kho·∫£ng tr·∫Øng th·ª´a
                  tagCounts[cleanTag] = (tagCounts[cleanTag] || 0) + 1;
               });
            }
         });
      
         // Chuy·ªÉn th√†nh m·∫£ng v√† s·∫Øp x·∫øp gi·∫£m d·∫ßn theo s·ªë l∆∞·ª£ng
         const sortedTags = Object.entries(tagCounts)
            .sort((a, b) => b[1] - a[1]) // S·∫Øp x·∫øp count gi·∫£m d·∫ßn
            .slice(0, 10); // L·∫•y top 10
      
         const container = document.getElementById('trending-tags-container');
         if (!container) return;
      
         if (sortedTags.length === 0) {
            container.style.display = 'none'; // ·∫®n n·∫øu kh√¥ng c√≥ tag n√†o
            return;
         } else {
            container.style.display = 'flex';
         }
      
         // Render HTML
         container.innerHTML = sortedTags.map(([tag, count]) => `
      				<div class="trending-tag-chip" onclick="filterByHashtag('${tag}')">
      					${tag} <span class="ms-1 badge bg-secondary rounded-pill" style="font-size: 0.6rem;">${count}</span>
      				</div>
      			`).join('');
      }
      
      // H√†m 3: Th·ª±c hi·ªán l·ªçc b√†i vi·∫øt
      function filterByHashtag(tag) {
         // 1. L∆∞u tr·∫°ng th√°i
         currentHashFilter = tag;
      
         // 2. Hi·ªán thanh th√¥ng b√°o
         document.getElementById('active-filter-bar').classList.remove('d-none');
         document.getElementById('current-filter-name').textContent = tag;
      
         const container = document.getElementById('posts-container');
         container.innerHTML = ''; // X√≥a tr·∫Øng m√†n h√¨nh c≈©
      
         // 3. L·ªåC CLIENT: L·∫•y ngay b√†i c√≥ s·∫µn trong m√°y
         const localMatches = serverFeedData.filter(post => {
            return post.content && post.content.includes(tag);
         });
      
         // 4. Render b√†i Client ngay l·∫≠p t·ª©c
         if (localMatches.length > 0) {
            const html = localMatches.map(post => createPostHtml(post)).join('');
            container.insertAdjacentHTML('beforeend', html);
         }
      
         // 5. Hi·ªán Spinner "ƒêang t√¨m th√™m..." ·ªü d∆∞·ªõi c√πng
         const loaderHtml = `
      				<div id="hashtag-server-loader" class="hashtag-loader">
      					<div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
      					ƒêang t√¨m th√™m c√°c b√†i c≈© h∆°n...
      				</div>
      			`;
         container.insertAdjacentHTML('beforeend', loaderHtml);
      
         // 6. ·∫®n n√∫t Load More m·∫∑c ƒë·ªãnh c·ªßa Feed (ƒë·ªÉ tr√°nh xung ƒë·ªôt)
         const feedLoadMore = document.getElementById('feed-load-more');
         if (feedLoadMore) feedLoadMore.style.display = 'none';
      
         // Scroll l√™n ƒë·∫ßu
         document.querySelector('.main-content').scrollTop = 0;
      
         // 7. G·ªåI SERVER (B∆∞·ªõc x·ª≠ l√Ω ti·∫øp theo)
         // Truy·ªÅn danh s√°ch ID ƒë√£ hi·ªÉn th·ªã ƒë·ªÉ server (ho·∫∑c client) bi·∫øt ƒë∆∞·ªùng lo·∫°i tr·ª´
         const existingIds = localMatches.map(p => p.__backendId);
         loadServerHashtagResults(tag, existingIds);
      }
      
      // H√†m 4: H·ªßy l·ªçc
      function clearHashtagFilter() {
         currentHashFilter = null;
         document.getElementById('active-filter-bar').classList.add('d-none');
      
         // Render l·∫°i to√†n b·ªô feed g·ªëc
         renderPosts(); // H√†m c≈© c·ªßa b·∫°n
      }
      
      async function loadServerHashtagResults(tag, existingIds) {
         try {
            // G·ª≠i y√™u c·∫ßu l√™n server: "T√¨m cho t√¥i b√†i vi·∫øt c√≥ tag n√†y, l·∫•y nhi·ªÅu nhi·ªÅu ch√∫t (v√≠ d·ª• 50 b√†i)"
            const res = await sendToServer({
               action: 'get_feed',
               page: 1, // Lu√¥n l·∫•y t·ª´ trang 1 c·ªßa k·∫øt qu·∫£ l·ªçc
               limit: 50, // L·∫•y s·ªë l∆∞·ª£ng l·ªõn ƒë·ªÉ qu√©t ƒë∆∞·ª£c nhi·ªÅu b√†i c≈©
               hashtag: tag, // Server s·∫Ω l·ªçc theo c√°i n√†y
               username: currentProfile ? currentProfile.username : ''
            });
      
            // X√≥a Spinner loading
            const loader = document.getElementById('hashtag-server-loader');
            if (loader) loader.remove();
      
            if (res.status === 'success') {
               const serverPosts = res.data;
               const container = document.getElementById('posts-container');
      
               // 8. L·ªåC TR√ôNG: Ch·ªâ l·∫•y nh·ªØng b√†i Server tr·∫£ v·ªÅ m·∫£ Client CH∆ØA C√ì
               const newPosts = serverPosts.filter(p => !existingIds.includes(p.__backendId));
      
               if (newPosts.length > 0) {
                  // V·∫Ω th√™m b√†i m·ªõi v√†o d∆∞·ªõi c√πng
                  const html = newPosts.map(post => createPostHtml(post)).join('');
                  container.insertAdjacentHTML('beforeend', html);
      
                  // Hi·ªáu ·ª©ng b√°o hi·ªáu c√≥ b√†i m·ªõi
                  showToast(`ƒê√£ t√¨m th·∫•y th√™m ${newPosts.length} b√†i c≈©`);
               } else {
                  // N·∫øu server tr·∫£ v·ªÅ to√†n b√†i tr√πng v·ªõi client
                  if (existingIds.length > 0) {
                     container.insertAdjacentHTML('beforeend',
                        '<div class="text-center py-4 text-muted small">--- ƒê√£ hi·ªÉn th·ªã h·∫øt b√†i vi·∫øt ---</div>'
                     );
                  } else {
                     // Tr∆∞·ªùng h·ª£p c·∫£ Client v√† Server ƒë·ªÅu kh√¥ng c√≥ b√†i n√†o
                     container.innerHTML = `<div class="text-center py-5 text-muted">
      								<i class="bi bi-search" style="font-size: 2rem;"></i>
      								<p class="mt-2">Kh√¥ng t√¨m th·∫•y b√†i vi·∫øt n√†o ch·ª©a tag <b>${tag}</b></p>
      							</div>`;
                  }
               }
            }
         } catch (e) {
            console.error(e);
            const loader = document.getElementById('hashtag-server-loader');
            if (loader) {
               loader.innerHTML = '<span class="text-danger">L·ªói t·∫£i th√™m d·ªØ li·ªáu</span>';
            }
         }
      }
      
      // --- HASHTAG LOGIC END ---
      // --- [M·ªöI] T√çNH NƒÇNG: ·∫§N V√ÄO N·ªÄN T·ª∞ ƒê·ªòNG ·∫®N TOAST ---
      document.addEventListener('click', function(event) {
         const toastEl = document.getElementById('successToast');
         
         // 1. Ki·ªÉm tra xem Toast c√≥ ƒëang hi·ªán kh√¥ng (Bootstrap d√πng class 'show')
         if (toastEl && toastEl.classList.contains('show')) {
            
            // 2. Ki·ªÉm tra v·ªã tr√≠ click:
            // N·∫øu click KH√îNG n·∫±m trong toast (t·ª©c l√† click ra n·ªÅn/background)
            if (!toastEl.contains(event.target)) {
               successToast.hide();
            }
         }
      });
      
      // (T√πy ch·ªçn th√™m) Click th·∫≥ng v√†o Toast c≈©ng cho ·∫©n lu√¥n ƒë·ªÉ thao t√°c nhanh h∆°n
      document.getElementById('successToast').addEventListener('click', function() {
         successToast.hide();
      });

// --- C·∫¨P NH·∫¨T LOGIC VU·ªêT (Th√™m class active ƒë·ªÉ hi·ªán n√∫t) ---
 
// --- X·ª¨ L√ù 3 N√öT: UNREAD / READ / DELETE ---
// --- X·ª¨ L√ù 3 N√öT: UNREAD / READ / DELETE ---
async function handleSwipeAction(id, action) {
    // T√¨m ph·∫ßn t·ª≠ ƒë·ªÉ ƒë√≥ng l·∫°i swipe cho g·ªçn
    const contentBox = document.querySelector(`#notif-wrap-${id} .notification-content-box`);
    
    // ƒê√≥ng swipe l·∫°i
    if(contentBox) contentBox.style.transform = `translateX(0px)`;
    currentSwipedId = null;

    if (action === 'delete') {
        // [THAY ƒê·ªîI] G·ªçi Modal x√°c nh·∫≠n chung thay v√¨ confirm() m·∫∑c ƒë·ªãnh
        showDeleteConfirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a th√¥ng b√°o n√†y?', id, 'notification_single');
    } 
    else if (action === 'read' || action === 'unread') {
        // Logic ƒê·ªçc/Ch∆∞a ƒë·ªçc gi·ªØ nguy√™n
        const isRead = (action === 'read');
        
        // UI L·∫°c quan
        if (contentBox) {
            if (isRead) {
                contentBox.classList.remove('unread');
                const dot = contentBox.querySelector('.notification-dot');
                if (dot) dot.remove();
            } else {
                contentBox.classList.add('unread');
                if (!contentBox.querySelector('.notification-dot')) {
                    const flexDiv = contentBox.querySelector('.d-flex');
                    const dotHtml = `<div class="notification-dot ms-auto me-2" style="flex-shrink: 0;"></div>`;
                    flexDiv.insertBefore(createRange(dotHtml), flexDiv.lastElementChild);
                }
            }
        }
        
        await sendToServer({ action: 'notification_action', type: 'toggle_read', id: id, status: isRead });
        const cachedItem = serverNotifications.find(n => n.__backendId === id);
        if(cachedItem) cachedItem.isRead = isRead;
    }
}

// Helper t·∫°o DOM t·ª´ string
function createRange(html) {
    const tpl = document.createElement('template');
    tpl.innerHTML = html;
    return tpl.content.firstChild;
}
 

function handleTouchStart(e, id) {
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY; // [M·ªöI] L∆∞u v·ªã tr√≠ b·∫Øt ƒë·∫ßu Y
    isSwiping = false; 
    isScrolling = false; // Reset tr·∫°ng th√°i
    
    // Hi·ªán n√∫t actions b√™n d∆∞·ªõi (chu·∫©n b·ªã s·∫µn)
    const wrap = document.getElementById(`notif-wrap-${id}`);
    if (wrap) {
        const actions = wrap.querySelector('.notification-actions');
        if (actions) actions.classList.add('active');
    }

    // ƒê√≥ng item c≈© n·∫øu ƒëang m·ªü c√°i kh√°c
    if (currentSwipedId && currentSwipedId !== id) {
        const oldWrap = document.getElementById(`notif-wrap-${currentSwipedId}`);
        if (oldWrap) {
            const oldContent = oldWrap.querySelector('.notification-content-box');
            if (oldContent) oldContent.style.transform = `translateX(0px)`;
            const oldActions = oldWrap.querySelector('.notification-actions');
            if (oldActions) setTimeout(() => oldActions.classList.remove('active'), 200);
        }
        currentSwipedId = null;
    }
}

function handleTouchMove(e) {
    if (isScrolling) return;

    const touchCurrentX = e.touches[0].clientX;
    const touchCurrentY = e.touches[0].clientY;
    
    const diffX = touchCurrentX - touchStartX;
    const diffY = touchCurrentY - touchStartY;

    // Ki·ªÉm tra xem ng∆∞·ªùi d√πng ƒëang c·ªë t√¨nh cu·ªôn d·ªçc hay vu·ªët ngang
    // N·∫øu ch√™nh l·ªách Y l·ªõn h∆°n X => ƒêang cu·ªôn trang
    if (Math.abs(diffY) > Math.abs(diffX)) {
        isScrolling = true;
        return; 
    }

    // N·∫øu vu·ªët ngang (tr√°i ho·∫∑c ph·∫£i)
    // Th√™m ƒëi·ªÅu ki·ªán: Ch·ªâ ch·∫∑n m·∫∑c ƒë·ªãnh (preventDefault) n·∫øu vu·ªët ngang r√µ r√†ng
    if (Math.abs(diffX) > 10) {
        if (e.cancelable) e.preventDefault(); // Ch·∫∑n cu·ªôn trang
        
        // Ch·ªâ x·ª≠ l√Ω logic vu·ªët menu khi vu·ªët sang tr√°i (diffX < 0)
        if (diffX < -5) {
            isSwiping = true; 
            const el = e.currentTarget;
            if (diffX > -200) el.style.transform = `translateX(${diffX}px)`;
        }
    }
}

function handleTouchEnd(e) {
    // N·∫øu n√£y gi·ªù l√† cu·ªôn trang th√¨ kh√¥ng l√†m g√¨ c·∫£
    if (isScrolling) {
        isScrolling = false;
        return;
    }

    const el = e.currentTarget;
    const notifId = el.getAttribute('data-id');
    const touchEndX = e.changedTouches[0].clientX;
    const diff = touchEndX - touchStartX;

    // N·∫øu ch·ªâ ch·∫°m nh·∫π (kh√¥ng di chuy·ªÉn nhi·ªÅu) -> COI L√Ä CLICK
    if (Math.abs(diff) < 5 && !isSwiping) {
        // N·∫øu kh√¥ng ph·∫£i ƒëang vu·ªët th√¨ m·ªõi g·ªçi click
        handleNotificationClick(notifId);
        
        // Reset v·ªã tr√≠ v·ªÅ 0 ƒë·ªÉ an to√†n
        el.style.transform = `translateX(0px)`;
        return;
    }

    // X·ª≠ l√Ω k·∫øt th√∫c Vu·ªët
    if (diff < -60) { 
        // N·∫øu k√©o ƒë·ªß s√¢u -> M·ªü ra
        el.style.transform = `translateX(-180px)`; 
        currentSwipedId = notifId;
    } else {
        // N·∫øu k√©o √≠t -> ƒê√≥ng l·∫°i
        el.style.transform = `translateX(0px)`; 
        if (currentSwipedId === notifId) currentSwipedId = null;
    }
    
    // Reset bi·∫øn sau 1 ch√∫t
    setTimeout(() => { isSwiping = false; }, 100);
}

	// --- H√ÄM CLICK: ƒê·ªåC TH√îNG B√ÅO & M·ªû B√ÄI VI·∫æT (ƒê√É KI·ªÇM TRA LOGIC) ---
	// --- H√ÄM CLICK: ƒê·ªåC TH√îNG B√ÅO & M·ªû B√ÄI VI·∫æT (ƒê√É FIX L·ªñI KH√îNG CHUY·ªÇN TRANG) ---
async function handleNotificationClick(notifId) {
    console.log("Click notif:", notifId);

    // 1. T√¨m ph·∫ßn t·ª≠ trong DOM ƒë·ªÉ l·∫•y th√¥ng tin
    const el = document.querySelector(`#notif-wrap-${notifId} .notification-content-box`);
    
    // L·∫•y ID b√†i vi·∫øt t·ª´ data attribute
    const postId = el ? el.getAttribute('data-post-id') : null;
    console.log("Target Post ID:", postId);

    // 2. UI L·∫†C QUAN: ƒê√°nh d·∫•u l√† ƒë√£ ƒë·ªçc ngay l·∫≠p t·ª©c (ƒë·ªïi m√†u n·ªÅn)
    if (el && el.classList.contains('unread')) {
        handleSwipeAction(notifId, 'read');
    }

    // 3. KI·ªÇM TRA D·ªÆ LI·ªÜU:
    // N·∫øu kh√¥ng c√≥ ID b√†i vi·∫øt (v√≠ d·ª• th√¥ng b√°o h·ªá th·ªëng, ho·∫∑c l·ªói d·ªØ li·ªáu)
    if (!postId || postId === 'undefined' || postId === 'null' || postId === '') {
        // [QUAN TR·ªåNG] B√°o cho ng∆∞·ªùi d√πng bi·∫øt thay v√¨ im l·∫∑ng
        // N·∫øu l√† th√¥ng b√°o h·ªá th·ªëng b√¨nh th∆∞·ªùng th√¨ kh√¥ng c·∫ßn b√°o, nh∆∞ng ƒë·ªÉ debug th√¨ c·ª© hi·ªán toast
        // showToast('Th√¥ng b√°o n√†y kh√¥ng c√≥ li√™n k·∫øt b√†i vi·∫øt'); 
        return;
    }

    // --- B·∫ÆT ƒê·∫¶U QUY TR√åNH M·ªû B√ÄI VI·∫æT ---

    // A. ƒê√ìNG MODAL TH√îNG B√ÅO (D√πng c√°ch m·∫°nh nh·∫•t ƒë·ªÉ ƒë·∫£m b·∫£o ƒë√≥ng ƒë∆∞·ª£c)
    const modalEl = document.getElementById('notificationsModal');
    const modalInstance = bootstrap.Modal.getInstance(modalEl);
    if (modalInstance) {
        modalInstance.hide();
    } else {
        // Fallback n·∫øu ch∆∞a l·∫•y ƒë∆∞·ª£c instance
        new bootstrap.Modal(modalEl).hide();
    }
    
    // X√≥a backdrop (m√†n h√¨nh ƒëen) th·ªß c√¥ng n·∫øu n√≥ b·ªã k·∫πt
    document.querySelectorAll('.modal-backdrop').forEach(bd => bd.remove());
    document.body.classList.remove('modal-open');
    document.body.style = '';

    // B. CHUY·ªÇN TAB SANG B·∫¢NG TIN (FEED)
    const feedTabBtn = document.querySelector('[data-tab="feed"]');
    if (feedTabBtn) {
        feedTabBtn.click();
    }

    // C. T√åM V√Ä CU·ªòN T·ªöI B√ÄI VI·∫æT
    // Delay 300ms ƒë·ªÉ ƒë·∫£m b·∫£o Modal ƒë√£ ƒë√≥ng v√† Tab Feed ƒë√£ hi·ªán ra
    setTimeout(async () => {
        let postEl = document.getElementById(`post-${postId}`);
        
        if (postEl) {
            // TR∆Ø·ªúNG H·ª¢P 1: B√†i vi·∫øt ƒêANG C√ì tr√™n m√†n h√¨nh -> Cu·ªôn t·ªõi
            console.log("B√†i vi·∫øt ƒë√£ c√≥ s·∫µn, cu·ªôn t·ªõi...");
            postEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            highlightPost(postEl);
        } else {
            // TR∆Ø·ªúNG H·ª¢P 2: B√†i vi·∫øt KH√îNG C√ì (B√†i c≈© ch∆∞a load t·ªõi) -> T·∫£i t·ª´ Server
            console.log("B√†i vi·∫øt ch∆∞a c√≥, ƒëang t·∫£i t·ª´ server...", postId);
            showToast('ƒêang t·∫£i b√†i vi·∫øt li√™n quan...');
            
            try {
                // G·ªçi API l·∫•y b√†i vi·∫øt c·ª• th·ªÉ
                const res = await sendToServer({ 
                    action: 'get_feed', 
                    postId: postId, 
                    page: 1, 
                    limit: 1 
                });

                if (res.status === 'success' && res.data && res.data.length > 0) {
                    const postData = res.data[0];
                    
                    // Ki·ªÉm tra xem ƒë√£ c√≥ ch∆∞a (tr√°nh tr√πng l·∫∑p do m·∫°ng lag)
                    const existIndex = serverFeedData.findIndex(p => p.__backendId === postData.__backendId);
                    
                    if (existIndex === -1) {
                        // Ch√®n v√†o ƒë·∫ßu danh s√°ch d·ªØ li·ªáu Feed
                        serverFeedData.unshift(postData);
                        // V·∫Ω l·∫°i B·∫£ng tin ngay l·∫≠p t·ª©c
                        renderPosts(); 
                    }

                    // ƒê·ª£i 1 ch√∫t cho DOM v·∫Ω xong r·ªìi cu·ªôn t·ªõi
                    setTimeout(() => {
                        const newEl = document.getElementById(`post-${postId}`);
                        if (newEl) {
                            newEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            highlightPost(newEl);
                        } else {
                             showToast('Kh√¥ng th·ªÉ hi·ªÉn th·ªã b√†i vi·∫øt');
                        }
                    }, 500);

                } else {
                    showToast('B√†i vi·∫øt n√†y c√≥ th·ªÉ ƒë√£ b·ªã x√≥a');
                }
            } catch (e) {
                console.error("L·ªói t·∫£i b√†i vi·∫øt:", e);
                showToast('L·ªói k·∫øt n·ªëi khi t·∫£i b√†i vi·∫øt');
            }
        }
    }, 300); 
}

	// Helper: Hi·ªáu ·ª©ng nh√°y s√°ng b√†i vi·∫øt ƒë·ªÉ g√¢y ch√∫ √Ω
	function highlightPost(element) {
		// L∆∞u l·∫°i m√†u n·ªÅn c≈©
		const originalBg = element.style.backgroundColor;
		
		element.style.transition = "box-shadow 0.5s, background-color 0.5s";
		element.style.boxShadow = "0 0 15px rgba(34, 197, 94, 0.5)"; // Shadow xanh
		element.style.backgroundColor = "#f0fdf4"; // N·ªÅn xanh nh·∫°t
		
		// Sau 2 gi√¢y th√¨ tr·∫£ v·ªÅ b√¨nh th∆∞·ªùng
		setTimeout(() => {
			element.style.boxShadow = "";
			element.style.backgroundColor = originalBg || "";
		}, 2000);
	}

// --- SMART SEARCH ENGINE ---

// 1. H√†m chu·∫©n h√≥a ti·∫øng Vi·ªát (ƒê·ªÉ t√¨m ki·∫øm kh√¥ng d·∫•u)
function normalizeStr(str) {
    if (!str) return '';
    return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "")
              .replace(/ƒë/g, "d").replace(/ƒê/g, "D")
              .toLowerCase().trim();
}

// 2. X·ª≠ l√Ω s·ª± ki·ªán nh·∫≠p li·ªáu
const searchInput = document.getElementById('smart-search-input');
const clearSearchBtn = document.getElementById('clear-search');

if (searchInput) {
    searchInput.addEventListener('input', (e) => {
        const query = e.target.value;
        clearSearchBtn.style.display = query ? 'block' : 'none';
        
        // Debounce: ƒê·ª£i ng∆∞·ªùi d√πng d·ª´ng g√µ 300ms m·ªõi t√¨m
        if (window.searchTimeout) clearTimeout(window.searchTimeout);
        window.searchTimeout = setTimeout(() => {
            handleSmartSearch(query);
        }, 300);
    });

    clearSearchBtn.addEventListener('click', () => {
        searchInput.value = '';
        handleSmartSearch('');
        clearSearchBtn.style.display = 'none';
    });
}

// H√†m h·ªó tr·ª£ click v√†o chip g·ª£i √Ω
function triggerSearch(text) {
    if(!searchInput) return;
    searchInput.value = text;
    clearSearchBtn.style.display = 'block';
    handleSmartSearch(text);
}

	// 3. LOGIC T√åM KI·∫æM TH√îNG MINH (CORE)
	// --- 3. LOGIC T√åM KI·∫æM TH√îNG MINH (HYBRID: LOCAL + SERVER) ---
	async function handleSmartSearch(query) {
		const container = document.getElementById('search-results-area');
		
		// N·∫øu √¥ t√¨m ki·∫øm r·ªóng, hi·ªán h∆∞·ªõng d·∫´n
		if (!query || !query.trim()) {
			container.innerHTML = `
				<div class="text-center py-5 text-muted">
				   <i class="bi bi-robot theme-text-primary" style="font-size: 3rem;"></i>
				   <p class="mt-3">Nh·∫≠p t·ª´ kh√≥a ho·∫∑c c√¢u h·ªèi.<br>V√≠ d·ª•: "·∫£nh nhi·ªÅu like", "sinh nh·∫≠t"...</p>
				</div>`;
			return;
		}

		const rawQuery = query.toLowerCase();
		const cleanQuery = normalizeStr(query); // ƒê·∫£m b·∫£o b·∫°n ƒë√£ c√≥ h√†m normalizeStr
		let resultsHtml = '';
		let foundAnswer = false; // C·ªù ƒë√°nh d·∫•u n·∫øu ƒë√£ t√¨m th·∫•y c√¢u tr·∫£ l·ªùi d·∫°ng "Th·ªëng k√™/H·ªèi ƒë√°p"

		// --- A. PH√ÇN T√çCH INTENT (H·ªéI ƒê√ÅP TH√îNG MINH) ---
		
		// 1. H·ªèi v·ªÅ b√†i vi·∫øt nhi·ªÅu Like nh·∫•t
		if (cleanQuery.includes('nhieu like') || cleanQuery.includes('thich nhat') || cleanQuery.includes('hot nhat')) {
			const sortedPosts = [...serverFeedData].sort((a, b) => (b.likes || 0) - (a.likes || 0));
			if (sortedPosts.length > 0) {
				resultsHtml += `<div class="alert alert-success mb-3"><i class="bi bi-trophy-fill me-2"></i>B√†i vi·∫øt ƒë∆∞·ª£c y√™u th√≠ch nh·∫•t (trong d·ªØ li·ªáu ƒë√£ t·∫£i):</div>`;
				resultsHtml += createPostHtml(sortedPosts[0]);
				foundAnswer = true;
			}
		}
		
		// 2. H·ªèi v·ªÅ b√†i vi·∫øt nhi·ªÅu Comment nh·∫•t
		else if (cleanQuery.includes('nhieu comment') || cleanQuery.includes('nhieu binh luan') || cleanQuery.includes('soi noi')) {
			const getCmtCount = (p) => parseComments(p.comments).length;
			const sortedPosts = [...serverFeedData].sort((a, b) => getCmtCount(b) - getCmtCount(a));
			if (sortedPosts.length > 0) {
				resultsHtml += `<div class="alert alert-info mb-3"><i class="bi bi-chat-quote-fill me-2"></i>B√†i vi·∫øt s√¥i n·ªïi nh·∫•t (${getCmtCount(sortedPosts[0])} b√¨nh lu·∫≠n)</div>`;
				resultsHtml += createPostHtml(sortedPosts[0]);
				foundAnswer = true;
			}
		}

		// 3. H·ªèi Th·ªëng k√™ t·ªïng quan
		else if (cleanQuery.includes('thong ke') || cleanQuery.includes('tong so')) {
			const totalPosts = serverFeedData.length;
			const totalLikes = serverFeedData.reduce((sum, p) => sum + (p.likes || 0), 0);
			// ƒê·∫øm s∆° b·ªô s·ªë ·∫£nh
			const totalPhotos = serverFeedData.reduce((sum, p) => {
				 const imgs = parseImages(p.imageData); 
				 return sum + (Array.isArray(imgs) ? imgs.length : 0);
			}, 0);
			
			resultsHtml += `
				<div class="card theme-bg-primary text-white mb-3">
					<div class="card-body">
						<h5 class="fw-bold"><i class="bi bi-bar-chart-line me-2"></i>Th·ªëng k√™ (D·ªØ li·ªáu hi·ªÉn th·ªã)</h5>
						<div class="row text-center mt-3">
							<div class="col-4"><h3>${totalPosts}</h3><small>B√†i vi·∫øt</small></div>
							<div class="col-4"><h3>${totalLikes}</h3><small>L∆∞·ª£t th√≠ch</small></div>
							<div class="col-4"><h3>${totalPhotos}</h3><small>B·ª©c ·∫£nh</small></div>
						</div>
						<small class="d-block mt-2 text-white-50 fst-italic">* S·ªë li·ªáu d·ª±a tr√™n c√°c b√†i vi·∫øt ƒë√£ t·∫£i v·ªÅ m√°y.</small>
					</div>
				</div>
			`;
			foundAnswer = true;
		}

		// 4. H·ªèi Ng√†y sinh nh·∫≠t / K·ª∑ ni·ªám
		else if (cleanQuery.includes('sinh nhat') || cleanQuery.includes('ngay sinh')) {
			 const memories = allData.filter(d => d.type === 'memory' && normalizeStr(d.memoryTitle).includes('sinh nhat'));
			 
			 if (memories.length > 0) {
				 resultsHtml += `<h6 class="fw-bold theme-text-primary mb-3">üìÖ S·ª± ki·ªán t√¨m th·∫•y:</h6>`;
				 memories.forEach(mem => {
					 resultsHtml += `
						<div class="card mb-2 border-warning shadow-sm">
							<div class="card-body p-3">
								<h6 class="fw-bold mb-1 text-dark">${mem.memoryTitle}</h6>
								<p class="text-muted small mb-0"><i class="bi bi-calendar-event me-1"></i>${formatDate(mem.memoryDate)}</p>
							</div>
						</div>`;
				 });
				 foundAnswer = true;
			 }
		}

		// --- B. T√åM KI·∫æM N·ªòI DUNG LOCAL (T√åM TRONG FEED ƒêANG C√ì) ---
		
		// Lu√¥n th·ª±c hi·ªán t√¨m ki·∫øm text, tr·ª´ khi ng∆∞·ªùi d√πng h·ªèi th·ªëng k√™ chung chung
		let localMatches = [];
		
		// L·ªçc b√†i vi·∫øt ch·ª©a t·ª´ kh√≥a (c√≥ d·∫•u ho·∫∑c kh√¥ng d·∫•u)
		localMatches = serverFeedData.filter(post => {
			const contentNorm = normalizeStr(post.content);
			const authorNorm = normalizeStr(post.fullname || post.username);
			return contentNorm.includes(cleanQuery) || authorNorm.includes(cleanQuery);
		});

		if (localMatches.length > 0) {
			// Ch·ªâ hi·ªán ti√™u ƒë·ªÅ n·∫øu c√≥ k·∫øt qu·∫£ ƒë·∫∑c bi·ªát ·ªü tr√™n
			if (foundAnswer) {
				 resultsHtml += `<h6 class="fw-bold text-muted mt-4 mb-3 border-top pt-3">B√†i vi·∫øt li√™n quan (${localMatches.length}):</h6>`;
			} else {
				 resultsHtml += `<h6 class="fw-bold text-muted mb-3"><i class="bi bi-phone me-2"></i>K·∫øt qu·∫£ c√≥ s·∫µn trong m√°y (${localMatches.length}):</h6>`;
			}

			localMatches.forEach(post => {
				resultsHtml += createPostHtml(post);
			});
		} else if (!foundAnswer) {
			// N·∫øu kh√¥ng t√¨m th·∫•y g√¨ ·ªü Local v√† c≈©ng kh√¥ng ph·∫£i c√¢u h·ªèi th·ªëng k√™
			resultsHtml += `
				<div class="text-center py-4 text-muted small">
					Ch∆∞a t√¨m th·∫•y k·∫øt qu·∫£ ph√π h·ª£p trong d·ªØ li·ªáu ƒë√£ t·∫£i...
				</div>`;
		}

		// C·∫≠p nh·∫≠t DOM l·∫ßn 1: Hi·ªÉn th·ªã ngay k·∫øt qu·∫£ Local
		container.innerHTML = resultsHtml;

		// --- C. T√åM KI·∫æM SERVER (FULL DATABASE) ---
		// Ch·ªâ g·ªçi server n·∫øu t·ª´ kh√≥a c√≥ √Ω nghƒ©a (> 1 k√Ω t·ª±)
		if (cleanQuery.length >= 2) {
			// T·∫°o Loader Spinner
			const loaderId = 'server-search-loader';
			const loaderHtml = `
				<div id="${loaderId}" class="text-center py-3 text-muted small fade-in mt-2 border-top pt-2">
					<div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
					ƒêang t√¨m th√™m tr√™n m√°y ch·ªß...
				</div>
			`;
			container.insertAdjacentHTML('beforeend', loaderHtml);

			// L·∫•y danh s√°ch ID ƒë√£ hi·ªÉn th·ªã ƒë·ªÉ Server/Client lo·∫°i tr·ª´ tr√πng l·∫∑p
			// Bao g·ªìm c·∫£ b√†i local v·ª´a t√¨m ƒë∆∞·ª£c v√† c√°c b√†i ƒë·∫∑c bi·ªát (n·∫øu c√≥)
			const displayedIds = localMatches.map(p => p.__backendId);
			
			// G·ªçi h√†m t√¨m ki·∫øm server (ƒë·ªãnh nghƒ©a b√™n d∆∞·ªõi)
			await searchServerSide(query, displayedIds, loaderId);
		}
	}
	// --- H√ÄM PH·ª§ TR·ª¢: G·ªåI SERVER T√åM KI·∫æM ---
async function searchServerSide(query, existingIds, loaderId) {
    const container = document.getElementById('search-results-area');
    const loader = document.getElementById(loaderId);

    try {
        // G·ª≠i request t√¨m ki·∫øm l√™n Server
        // Reuse action 'get_feed' nh∆∞ng th√™m tham s·ªë 'searchQuery'
        const res = await sendToServer({
            action: 'get_feed', 
            page: 1,
            limit: 20,          // L·∫•y t·ªëi ƒëa 20 k·∫øt qu·∫£ t·ª´ server
            searchQuery: query, // T·ª´ kh√≥a t√¨m ki·∫øm
            username: currentProfile ? currentProfile.username : ''
        });

        // X√≥a Loader sau khi c√≥ ph·∫£n h·ªìi
        if (loader) loader.remove();

        if (res.status === 'success') {
            const serverPosts = res.data;

            // QUAN TR·ªåNG: L·ªçc tr√πng (Ch·ªâ l·∫•y b√†i m√† Client CH∆ØA hi·ªÉn th·ªã)
            const newMatches = serverPosts.filter(p => !existingIds.includes(p.__backendId));

            if (newMatches.length > 0) {
                let serverHtml = `<h6 class="fw-bold theme-text-primary mt-3 mb-3 border-top pt-3 fade-in"><i class="bi bi-cloud-check me-2"></i>T√¨m th·∫•y th√™m t·ª´ m√°y ch·ªß (${newMatches.length}):</h6>`;
                
                newMatches.forEach(post => {
                    serverHtml += createPostHtml(post);
                });

                container.insertAdjacentHTML('beforeend', serverHtml);
                
                // Cu·ªôn nh·∫π xu·ªëng ƒë·ªÉ ng∆∞·ªùi d√πng bi·∫øt c√≥ th√™m k·∫øt qu·∫£
                // container.lastElementChild.scrollIntoView({ behavior: 'smooth', block: 'end' });
            } else {
                // Server t√¨m ƒë∆∞·ª£c nh∆∞ng tr√πng h·∫øt v·ªõi Local, ho·∫∑c Server c≈©ng kh√¥ng t√¨m th·∫•y
                if (existingIds.length === 0) {
                     container.innerHTML = `
                        <div class="text-center py-5 text-muted">
                            <i class="bi bi-search" style="font-size: 2rem;"></i>
                            <p class="mt-3">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ n√†o cho "<b>${query}</b>"</p>
                        </div>`;
                } else {
                    container.insertAdjacentHTML('beforeend', `
                        <div class="text-center py-3 text-muted small fade-in">
                            ƒê√£ hi·ªÉn th·ªã t·∫•t c·∫£ k·∫øt qu·∫£ li√™n quan.
                        </div>
                    `);
                }
            }
        }
    } catch (e) {
        console.error("L·ªói t√¨m ki·∫øm server:", e);
        if (loader) {
            loader.innerHTML = '<span class="text-danger small"><i class="bi bi-exclamation-circle me-1"></i>L·ªói k·∫øt n·ªëi t·ªõi m√°y ch·ªß</span>';
        }
    }
}
// ==========================================================================
// T√çNH NƒÇNG: VU·ªêT T·ª™ TR√ÅI SANG ƒê·ªÇ ƒê√ìNG (SWIPE TO BACK)
// ==========================================================================

(function setupSwipeToClose() {
    let touchStartX = 0;
    let touchStartY = 0;
    
    // Ch·ªâ k√≠ch ho·∫°t n·∫øu vu·ªët t·ª´ v√πng m√©p tr√°i (t·∫°o c·∫£m gi√°c nh∆∞ n√∫t Back)
    // V√≠ d·ª•: 50px t·ª´ m√©p tr√°i m√†n h√¨nh
    const EDGE_ZONE = 50; 
    
    // Kho·∫£ng c√°ch t·ªëi thi·ªÉu ƒë·ªÉ t√≠nh l√† vu·ªët
    const MIN_SWIPE_DISTANCE = 100;

    document.addEventListener('touchstart', (e) => {
        // Ch·ªâ x·ª≠ l√Ω khi c√≥ Modal ƒëang m·ªü
        const openModal = document.querySelector('.modal.show');
        if (!openModal) return;

        touchStartX = e.changedTouches[0].screenX;
        touchStartY = e.changedTouches[0].screenY;
    }, {passive: true});

    document.addEventListener('touchend', (e) => {
        // Ki·ªÉm tra l·∫°i xem c√≥ modal n√†o ƒëang m·ªü kh√¥ng
        const openModal = document.querySelector('.modal.show');
        if (!openModal) return;

        const touchEndX = e.changedTouches[0].screenX;
        const touchEndY = e.changedTouches[0].screenY;

        // T√≠nh to√°n kho·∫£ng c√°ch
        const diffX = touchEndX - touchStartX;
        const diffY = touchEndY - touchStartY;

        // LOGIC KI·ªÇM TRA ƒêI·ªÄU KI·ªÜN ƒê√ìNG:
        
        // 1. Ph·∫£i l√† vu·ªët t·ª´ m√©p tr√°i (ƒë·ªÉ tr√°nh vu·ªët nh·∫ßm khi ƒëang xem ·∫£nh slide ngang)
        const isFromEdge = touchStartX < EDGE_ZONE;

        // 2. Ph·∫£i vu·ªët sang ph·∫£i (diffX > 0) v√† ƒë·ªß xa
        const isSwipeRight = diffX > MIN_SWIPE_DISTANCE;

        // 3. Ph·∫£i l√† vu·ªët ngang (X) nhi·ªÅu h∆°n vu·ªët d·ªçc (Y) ƒë·ªÉ tr√°nh nh·∫ßm v·ªõi cu·ªôn trang
        const isHorizontal = Math.abs(diffX) > Math.abs(diffY) * 2;

        if (isFromEdge && isSwipeRight && isHorizontal) {
            
            // X·ª¨ L√ù ƒê√ìNG MODAL
            // T√¨m instance Bootstrap c·ªßa modal ƒë√≥ ƒë·ªÉ g·ªçi hide() chu·∫©n
            const modalInstance = bootstrap.Modal.getInstance(openModal);
            if (modalInstance) {
                
                // (T√πy ch·ªçn) Th√™m hi·ªáu ·ª©ng tr∆∞·ª£t sang ph·∫£i cho ƒë·∫πp tr∆∞·ªõc khi ƒë√≥ng
                const dialog = openModal.querySelector('.modal-dialog');
                if(dialog) {
                    dialog.style.transition = 'transform 0.2s ease-out';
                    dialog.style.transform = 'translateX(100%)'; // Tr∆∞·ª£t ra kh·ªèi m√†n h√¨nh
                }

                // ƒê·ª£i 200ms cho hi·ªáu ·ª©ng ch·∫°y xong r·ªìi m·ªõi ƒë√≥ng th·∫≠t (ho·∫∑c ƒë√≥ng lu√¥n c≈©ng ƒë∆∞·ª£c)
                setTimeout(() => {
                    modalInstance.hide();
                    // Reset style sau khi ƒë√≥ng ƒë·ªÉ l·∫ßn sau m·ªü l·∫°i kh√¥ng b·ªã l·ªói v·ªã tr√≠
                    setTimeout(() => {
                         if(dialog) dialog.style.transform = '';
                    }, 300);
                }, 150);
            }
        }
    }, {passive: true});
})();

	// D·ªçn d·∫πp n·ªôi dung n·∫∑ng khi ƒë√≥ng Modal ƒë·ªÉ gi·∫£i ph√≥ng RAM
const heavyModals = ['imageViewerModal', 'albumDetailModal'];

heavyModals.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
        el.addEventListener('hidden.bs.modal', function () {
            // T√¨m container ch·ª©a ·∫£nh v√† x√≥a s·∫°ch con c·ªßa n√≥
            const contentContainers = el.querySelectorAll('.modal-body, #full-image-list, #album-photos');
            contentContainers.forEach(container => {
                // Gi·ªØ l·∫°i c·∫•u tr√∫c loading ho·∫∑c placeholder n·∫øu c·∫ßn, ho·∫∑c x√≥a s·∫°ch
                // ·ªû ƒë√¢y ta x√≥a s·∫°ch ƒë·ªÉ browser thu h·ªìi b·ªô nh·ªõ ·∫£nh
                while (container.firstChild) {
                    container.removeChild(container.firstChild);
                }
            });
        });
    }
});

      
      // K√çCH HO·∫†T ƒê·ªäNH K·ª≤ (Khuy√™n d√πng 60s thay v√¨ 10s)
      setInterval(runBackgroundSync, 60000);
    </script>
  </body>
</html>
