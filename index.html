 <!doctype html>
<html lang="vi" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Love Story</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
  
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <style>
        body {
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
        }
        
        * {
            font-feature-settings: "kern" 1;
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        :root {
            --primary-color: #006B68;
            --secondary-color: #FFC62F;
            --accent-color: #FFFFFF;
            --text-color: #1F2937;
            --bg-color: #F9FAFB;
            --border-color: #E5E7EB;
            --shadow-color: rgba(0, 107, 104, 0.1);
        }

        .theme-spring {
            --primary-color: #10B981;
            --secondary-color: #F59E0B;
            --accent-color: #ECFDF5;
            --text-color: #065F46;
            --bg-color: #F0FDF4;
            --border-color: #D1FAE5;
            --shadow-color: rgba(16, 185, 129, 0.1);
        }

        .theme-summer {
            --primary-color: #F59E0B;
            --secondary-color: #EF4444;
            --accent-color: #FEF3C7;
            --text-color: #92400E;
            --bg-color: #FFFBEB;
            --border-color: #FDE68A;
            --shadow-color: rgba(245, 158, 11, 0.1);
        }

        .theme-night {
            --primary-color: #6366F1;
            --secondary-color: #8B5CF6;
            --accent-color: #1F2937;
            --text-color: #F9FAFB;
            --bg-color: #111827;
            --border-color: #374151;
            --shadow-color: rgba(99, 102, 241, 0.2);
        }

        .theme-romantic {
            --primary-color: #EC4899;
            --secondary-color: #F97316;
            --accent-color: #FDF2F8;
            --text-color: #BE185D;
            --bg-color: #FEF7FF;
            --border-color: #FBCFE8;
            --shadow-color: rgba(236, 72, 153, 0.1);
        }

        .theme-ocean {
            --primary-color: #0EA5E9;
            --secondary-color: #06B6D4;
            --accent-color: #F0F9FF;
            --text-color: #0C4A6E;
            --bg-color: #F8FAFC;
            --border-color: #BAE6FD;
            --shadow-color: rgba(14, 165, 233, 0.1);
        }

        .bg-primary { background-color: var(--primary-color); }
        .bg-secondary { background-color: var(--secondary-color); }
        .bg-accent { background-color: var(--accent-color); }
        .text-primary { color: var(--primary-color); }
        .text-secondary { color: var(--secondary-color); }
        .text-custom { color: var(--text-color); }
        .bg-custom { background-color: var(--bg-color); }
        .border-custom { border-color: var(--border-color); }

        .love-card {
            background-color: var(--accent-color);
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 6px var(--shadow-color);
            transition: all 0.3s ease;
        }

        .love-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px var(--shadow-color);
        }

        .love-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .love-button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .love-button.secondary {
            background-color: var(--secondary-color);
        }

        .love-input {
            border: 2px solid var(--border-color);
            background-color: var(--accent-color);
            color: var(--text-color);
            padding: 0.75rem;
            border-radius: 0.5rem;
            outline: none;
            transition: all 0.3s ease;
        }

        .love-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--shadow-color);
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
		/* G√°n z-index cao h∆°n cho modal chi ti·∫øt ·∫£nh */
        #photoModal {
            z-index: 1050;
        }

        /* G√°n z-index cao nh·∫•t cho modal chia s·∫ª (v√¨ n√≥ m·ªü t·ª´ photoModal) */
        #shareModal {
            z-index: 1100;
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--accent-color);
			padding: 1rem;
            border-radius: 1.5rem;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal.show .modal-content {
            transform: scale(1);
        }

        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .grid-view-1 { grid-template-columns: 1fr; }
        .grid-view-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-view-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-view-4 { grid-template-columns: repeat(4, 1fr); }
        .grid-view-5 { grid-template-columns: repeat(5, 1fr); }
        .grid-view-6 { grid-template-columns: repeat(6, 1fr); }

        @media (max-width: 768px) {
			.mobile-hide-title { display: none; }
			
			/* B·∫Øt l·ªói b·ªã d·ªìn ·∫£nh tr√™n di ƒë·ªông khi ch·ªçn ch·∫ø ƒë·ªô l∆∞·ªõi l·ªõn h∆°n 2 c·ªôt */
			.grid-view-5,
			.grid-view-6 { 
				grid-template-columns: repeat(4, 1fr) !important; /* √âp v·ªÅ 4 c·ªôt */
			}
		}

        @media (min-width: 769px) {
            .grid-view-2 { grid-template-columns: repeat(2, 1fr); }
        }

        .timeline-item {
            position: relative;
            padding-left: 1rem;
            border-left: 2px solid var(--primary-color);
            margin-bottom: 2rem;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -6px;
            top: 0;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--primary-color);
        }

        .photo-grid {
            display: grid;
            gap: 1rem;
            padding: 1rem;
        }

        .photo-item {
            aspect-ratio: 1;
            overflow: hidden;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .photo-item:hover {
            transform: scale(1.05);
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .list-view .photo-item {
            aspect-ratio: auto;
            display: flex;
            align-items: center;
            padding: 1rem;
            background-color: var(--accent-color);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .list-view .photo-item img {
            width: 80px;
            height: 80px;
            border-radius: 0.5rem;
            margin-right: 1rem;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .status-online { background-color: #10B981; }
        .status-offline { background-color: #EF4444; }

        .footer {
            margin-top: auto;
            padding: 2rem;
            text-align: center;
            border-top: 1px solid var(--border-color);
            background-color: var(--accent-color);
        }

        /* Header Menu Styles */
        .menu-icon.active {
            background-color: var(--primary-color) !important;
			color: white !important;
        }

        .menu-icon:not(.active) {
            background-color: #6B7280;
			color: white;
        }
		
		.loading-spinner {
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
		/* CSS cho th√¥ng b√°o ƒë√£ ƒë·ªçc */
        .notification-item.read {
            opacity: 0.6;
            background-color: var(--bg-color);
        }
        .notification-item.read:hover {
            opacity: 1; /* V·∫´n s√°ng l√™n khi hover */
        }
		
        /* Theme Radio Button Styles */
        .theme-radio-default,
        .theme-radio-spring,
        .theme-radio-summer,
        .theme-radio-night,
        .theme-radio-romantic,
        .theme-radio-ocean {
            position: relative;
			display: none;
        }

        .theme-radio-default.selected,
        .theme-radio-spring.selected,
        .theme-radio-summer.selected,
        .theme-radio-night.selected,
        .theme-radio-romantic.selected,
        .theme-radio-ocean.selected {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .theme-radio-default.selected::after,
        .theme-radio-spring.selected::after,
        .theme-radio-summer.selected::after,
        .theme-radio-night.selected::after,
        .theme-radio-romantic.selected::after,
        .theme-radio-ocean.selected::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 6px;
            height: 6px;
            background-color: white;
            border-radius: 50%;
        }

        /* Toggle Switch Styles */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--primary-color);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        .log-pending {
            background-color: #FEF3C7 !important;
            border-left: 4px solid #F59E0B;
        }

        .log-saved {
            background-color: var(--accent-color);
        }
		
		/* AI Mode Button Styling */
        .ai-mode-btn {
            color: white;
            background-color: transparent;
            transition: all 0.2s ease;
            opacity: 0.7;
        }
        .ai-mode-btn.active {
            background-color: white;
            color: var(--primary-color); /* Use primary color for text */
            font-weight: 600;
            opacity: 1;
        }
		
		.photo-selector-item {
			position: relative;
			aspect-ratio: 1;
			overflow: hidden;
			border-radius: 0.5rem;
			cursor: pointer;
			transition: transform 0.2s ease;
			border: 3px solid transparent; 
		}

		.photo-selector-item:hover {
			transform: scale(1.02);
			border-color: var(--secondary-color); /* D√πng m√†u secondary */
		}

		.photo-selector-item.selected {
			border: 3px solid var(--primary-color); /* D√πng m√†u primary */
		}

		.photo-checkbox {
			position: absolute;
			top: 0.5rem;
			right: 0.5rem;
			width: 24px;
			height: 24px;
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 16px;
			transition: all 0.2s ease;
			z-index: 10;
		}

		.photo-checkbox.selected {
			background-color: var(--primary-color); /* D√πng m√†u primary */
			color: white;
		}

		.photo-checkbox.unselected {
			background-color: rgba(255, 255, 255, 0.8);
			color: #6B7280;
			border: 2px solid #D1D5DB;
		}

		/* Grid view classes for modal */
		.grid-1x1 { grid-template-columns: repeat(1, 1fr); }
		.grid-2x2 { grid-template-columns: repeat(2, 1fr); }
		.grid-3x3 { grid-template-columns: repeat(3, 1fr); }
		.grid-4x4 { grid-template-columns: repeat(4, 1fr); }
		.grid-5x5 { grid-template-columns: repeat(5, 1fr); }
		.grid-6x6 { grid-template-columns: repeat(6, 1fr); }
		.grid-list { grid-template-columns: 1fr; }

		#imageSelectorModal .modal-content {
			padding: 0.5rem;
		}
		
		/* CSS cho menu x·ªï d·ªçc (dropdown) m·ªõi */
        #headerMenuIcons.vertical-dropdown {
            /* Ghi ƒë√® style ngang c√≥ s·∫µn */
            position: absolute;
            top: 100%; /* Ngay b√™n d∆∞·ªõi header */
            /*right: 0.5rem;  CƒÉn l·ªÅ ph·∫£i */
            width: 200px;
            
            /* Ghi ƒë√® flex ngang */
            display: flex;
            flex-direction: column; /* X·∫øp d·ªçc */
            align-items: stretch; /* K√©o d√£n c√°c m·ª•c */
            justify-content: flex-start;
            
            /* Ghi ƒë√® style c·ªßa dropdown */
            background-color: var(--accent-color);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.5rem;
            box-shadow: 0 8px 25px var(--shadow-color);
            
            /* Ghi ƒë√® opacity/hidden */
            opacity: 1 !important; 
            visibility: visible !important;
        }

        #headerMenuIcons.vertical-dropdown .menu-icon {
            /* Ghi ƒë√® style c·ªßa n√∫t */
            display: flex;
            justify-content: flex-start; /* CƒÉn tr√°i text/icon */
            width: 100%;
            border-radius: 0.25rem;
            padding: 0.5rem 0.75rem;
            
            /* Style l·∫°i n√∫t */
            height: auto;
            background-color: transparent !important; /* X√≥a n·ªÅn tr√≤n */
            color: var(--text-color); /* M√†u text */
        }
        
        #headerMenuIcons.vertical-dropdown .menu-icon:hover {
             background-color: var(--bg-color) !important;
             color: var(--primary-color);
        }

        #headerMenuIcons.vertical-dropdown .menu-icon.active {
             background-color: var(--primary-color) !important;
             color: white;
        }

        /* Th√™m text cho c√°c n√∫t menu (ch·ªâ hi·ªán ·ªü ch·∫ø ƒë·ªô d·ªçc) */
        .menu-icon::after {
            content: attr(data-title);
            margin-left: 0.75rem;
            font-weight: 500;
            font-size: 0.875rem;
        }
        
        /* ·∫®n text khi ·ªü ch·∫ø ƒë·ªô ngang (m·∫∑c ƒë·ªãnh) */
        #headerMenuIcons:not(.vertical-dropdown) .menu-icon::after {
            display: none;
        }
		
		/* CSS cho Toolbar c·ªßa bi·ªÉu ƒë·ªì v√†ng */
        .chart-toolbar-btn {
            background-color: #f0f0f0; /* M√†u n·ªÅn x√°m nh·∫°t */
            color: #333;
            border: 1px solid #ddd;
            padding: 4px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.75rem; /* 12px */
            font-weight: 600;
            transition: all 0.2s;
        }
        .chart-toolbar-btn:hover {
            background-color: #e0e0e0;
        }
        .chart-toolbar-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        /* ƒê·∫£m b·∫£o bi·ªÉu ƒë·ªì c√≥ m√†u ch·ªØ */
        #homeGoldChart {
            color: #333;
        }
		/* CSS cho danh s√°ch l·ªçc trong Modal */
        .filter-checkbox-label {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .filter-checkbox-label:hover {
            background-color: var(--bg-color);
        }
        .filter-checkbox-label input {
            width: 1.25rem; /* 20px */
            height: 1.25rem; /* 20px */
            margin-right: 0.75rem;
            accent-color: var(--primary-color);
        }

        /* CSS cho giao di·ªán nh√≥m (Grouped View) - Giao di·ªán m·ªõi */
        .category-group-header {
            display: flex;
            align-items: center;
            justify-content: space-between; /* ƒê·∫©y 2 m·ª•c ra 2 b√™n */
            
            padding: 0.75rem 1rem; /* 12px 16px */
            border-radius: 0.75rem; /* 12px, bo tr√≤n */
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            
            /* N·ªÅn Gradient theo Theme (t·ª´ Primary -> Secondary) */
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 150%);
            color: white; /* Ch·ªØ m√†u tr·∫Øng */
            
            font-weight: 700;
            font-size: 1.125rem; /* text-lg */
            box-shadow: 0 4px 10px var(--shadow-color);
        }

        /* CSS cho icon v√† text b√™n tr√°i */
        .category-group-header .header-content {
            display: flex;
            align-items: center;
            gap: 0.75rem; /* Kho·∫£ng c√°ch 12px */
        }
        .category-group-header .header-content i {
            font-size: 1rem; /* 16px */
            opacity: 0.8;
        }

        /* CSS cho "bong b√≥ng" ƒë·∫øm s·ªë l∆∞·ª£ng b√™n ph·∫£i */
        .category-group-header .header-badge {
            background-color: rgba(255, 255, 255, 0.2); /* N·ªÅn m·ªù */
            padding: 0.25rem 0.75rem; /* 4px 12px */
            border-radius: 9999px; /* Bo tr√≤n */
            font-size: 0.75rem; /* 12px, text-xs */
            font-weight: 600;
        }
		#eventPhotosGrid .photo-item {
		  aspect-ratio: 1 / 1;
		  overflow: hidden;
		}
		#eventPhotosGrid .photo-item img {
		  width: 100%;
		  height: 100%;
		  object-fit: cover;
		}
		
		/* --- CSS CHO T√çNH NƒÇNG T√ôY CH·ªàNH GIAO DI·ªÜN --- */
		/* Khi b·∫≠t ch·∫ø ƒë·ªô s·ª≠a, grid s·∫Ω hi·ªán vi·ªÅn ƒë·ªÉ d·ªÖ nh√¨n */
		.edit-mode-active {
			border: 2px dashed #cbd5e1;
			padding: 10px;
			border-radius: 10px;
		}

		/* C√°c widget trong ch·∫ø ƒë·ªô s·ª≠a */
		.widget-item {
			position: relative;
			transition: all 0.2s ease;
		}

		.widget-item.edit-mode {
			border: 2px dashed var(--primary-color);
			border-radius: 0.5rem;
			cursor: move;
			background-color: rgba(255, 255, 255, 0.5);
		}

		.widget-item.sortable-ghost {
			opacity: 0.5;
			background: #e2e8f0;
		}

		/* C√°c n√∫t ƒëi·ªÅu khi·ªÉn widget (X√≥a, Resize...) */
		.widget-controls {
			display: none;
			position: absolute;
			top: 5px;
			right: 5px;
			z-index: 50;
			background: rgba(255, 255, 255, 0.95);
			border-radius: 8px;
			box-shadow: 0 4px 6px rgba(0,0,0,0.1);
			padding: 5px;
			border: 1px solid #e2e8f0;
			/* Grid layout cho c√°c n√∫t ƒëi·ªÅu khi·ªÉn */
			display: grid;
			grid-template-columns: repeat(4, 1fr); /* 4 n√∫t 1 h√†ng */
			gap: 4px;
			width: 140px; /* ƒê·ªô r·ªông c·ªë ƒë·ªãnh */
		}

		/* ·∫®n controls m·∫∑c ƒë·ªãnh, ch·ªâ hi·ªán khi cha c√≥ class edit-mode */
		.widget-item:not(.edit-mode) .widget-controls {
			display: none !important;
		}

		.widget-item.edit-mode .widget-controls {
			display: grid !important;
		}
		/* Hi·ªáu ·ª©ng focus kh·ªëi */
		.widget-item.edit-mode {
			border: 2px dashed var(--primary-color);
			background-color: rgba(255,255,255, 0.8);
			position: relative; 
			/* Quan tr·ªçng: transition m∆∞·ª£t khi ƒë·ªïi size */
			transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
		}

		.control-btn {
			width: 100%; /* Full √¥ grid */
			height: 28px;
			border-radius: 4px;
			border: none;
			color: white;
			font-size: 12px;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
		} /* <-- ƒê√£ th√™m d·∫•u ƒë√≥ng ngo·∫∑c */

		.control-btn:hover { filter: brightness(1.1); }

		.control-btn:hover { filter: brightness(1.1); }
		.control-btn:active { transform: scale(0.95); }
		.control-btn.resize { background-color: #3b82f6; }
		.control-btn.delete { background-color: #ef4444; }
		.control-btn.spacer { background-color: #10b981; }
		.btn-move { background-color: #64748b; } /* X√°m - Di chuy·ªÉn */
		.btn-size { background-color: #3b82f6; } /* Xanh - K√≠ch th∆∞·ªõc */
		.btn-del  { background-color: #ef4444; grid-column: span 4; } /* ƒê·ªè - X√≥a (chi·∫øm c·∫£ d√≤ng) */
	
		/* Toolbar ch·ªânh s·ª≠a n·∫±m d∆∞·ªõi c√πng m√†n h√¨nh */
		#editorToolbar {
			transform: translateY(100%);
			transition: transform 0.3s ease;
		}
		#editorToolbar.show {
			transform: translateY(0);
		}
		
		/* --- CSS CHO TOOLBAR CH·ªàNH S·ª¨A --- */
		#editorToolbar {
			/* ƒê·ªãnh v·ªã c·ªë ƒë·ªãnh */
			position: fixed;
			left: 50%;
			bottom: 20px; /* C√°ch ƒë√°y m√†n h√¨nh 20px */
			
			/* M·∫∑c ƒë·ªãnh: CƒÉn gi·ªØa ngang (-50%) v√† ƒê·∫©y xu·ªëng d∆∞·ªõi m√†n h√¨nh (200%) ƒë·ªÉ ·∫©n */
			transform: translate(-50%, 200%);
			transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
			
			z-index: 9999;
		}

		/* Khi c√≥ class 'show', thanh s·∫Ω tr·ªìi l√™n v·ªã tr√≠ g·ªëc (translateY v·ªÅ 0) */
		#editorToolbar.show {
			transform: translate(-50%, 0);
		}

    </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-screen bg-custom text-custom font-sans flex flex-col overflow-hidden"><!-- Header -->
  <!--
  <header class="bg-accent border-b border-custom shadow-sm sticky top-0 z-50">
   <div class="container mx-auto px-4 py-3">
    <div class="flex items-center justify-between h-10">
     <div class="flex items-center space-x-3"><button onclick="toggleHeaderMenu()" class="flex-shrink-0 w-10 h-10 bg-primary rounded-full flex items-center justify-center transition-all duration-300" id="headerMenuBtn"> <i class="fas fa-heart text-white text-lg"></i> </button>
      <h1 id="headerTitle" class="text-xl font-bold text-primary whitespace-nowrap transition-all duration-300 hidden md:block">Love Story</h1>
     </div>
     <div id="headerMenuIcons" class="flex-1 flex items-center justify-center space-x-1 transition-opacity duration-300 opacity-0 hidden"><button onclick="selectMenuItem('chat')" class="menu-icon flex-shrink-0 w-10 h-10 bg-gray-500 rounded-full flex items-center justify-center hover:bg-primary" data-section="chat" title="Chat AI"> <i class="fas fa-robot text-white text-sm"></i> </button> <button onclick="selectMenuItem('timeline')" class="menu-icon flex-shrink-0 w-10 h-10 bg-gray-500 rounded-full flex items-center justify-center hover:bg-primary" data-section="timeline" title="Timeline"> <i class="fas fa-clock text-white text-sm"></i> </button> <button onclick="selectMenuItem('photos')" class="menu-icon flex-shrink-0 w-10 h-10 bg-gray-500 rounded-full flex items-center justify-center hover:bg-primary" data-section="photos" title="Kho·∫£nh Kh·∫Øc"> <i class="fas fa-images text-white text-sm"></i> </button> <button onclick="selectMenuItem('settings')" class="menu-icon flex-shrink-0 w-10 h-10 bg-gray-500 rounded-full flex items-center justify-center hover:bg-primary" data-section="settings" title="C√†i ƒê·∫∑t"> <i class="fas fa-cog text-white text-sm"></i> </button>
     </div>
     <div class="flex items-center justify-end space-x-3"><button onclick="toggleHeaderMenu()" class="md:hidden flex-shrink-0 w-10 h-10 bg-gray-200 text-gray-700 rounded-full flex items-center justify-center" id="rightMenuBtn"> <i class="fas fa-bars text-lg"></i> </button> <button onclick="openModal('profileModal')" class="flex items-center space-x-2 love-card rounded-full p-1"> <img src="https://ui-avatars.com/api/?name=H√†+M·∫°nh+T√≠n&amp;background=006B68&amp;color=fff" alt="Avatar" class="w-8 h-8 rounded-full"> <span class="hidden md:block font-medium pr-3">H√† M·∫°nh T√≠n</span> </button>
     </div>
    </div>
   </div>
  </header>
  --><!-- Main Content -->
  
  <header class="bg-accent border-b border-custom shadow-sm sticky top-0 z-50">
   <div class="container mx-auto px-4 py-3">
    <div class="flex items-center justify-between h-10">
     <div class="flex items-center space-x-3"><button onclick="showSection('home')" class="flex-shrink-0 w-10 h-10 bg-primary rounded-full flex items-center justify-center transition-all duration-300" id="headerMenuBtn"> <i class="fas fa-heart text-white text-lg"></i> </button>
     <h1 id="headerTitle" class="text-xl font-bold text-primary whitespace-nowrap transition-all duration-300">Love Story</h1>
     </div>
     <div id="headerMenuIcons" class="flex-1 flex items-center justify-center 
space-x-1 transition-opacity duration-300 opacity-0 hidden">
<button onclick="selectMenuItem('chat')" class="menu-icon flex-shrink-0 w-10 h-10 bg-gray-500 rounded-full flex items-center justify-center hover:bg-primary" data-section="chat" title="Chat AI" data-title= "Chat AI"> 
<i class="fas fa-robot text-sm"></i> </button> <button onclick="selectMenuItem('timeline')" class="menu-icon flex-shrink-0 w-10 h-10 bg-gray-500 rounded-full flex items-center justify-center hover:bg-primary" data-section="timeline" title="Timeline" data-title="Timeline"> 
<i class="fas fa-clock text-sm"></i> </button> 
<button onclick="selectMenuItem('photos')" class="menu-icon flex-shrink-0 w-10 h-10 bg-gray-500 rounded-full flex items-center justify-center hover:bg-primary" data-section="photos" title="Kho·∫£nh Kh·∫Øc" data-title="Kho·∫£nh Kh·∫Øc"> <i class="fas fa-images text-sm"></i> </button> 
<button onclick="selectMenuItem('settings')" class="menu-icon flex-shrink-0 w-10 h-10 bg-gray-500 rounded-full flex items-center justify-center hover:bg-primary" data-section="settings" title="C√†i ƒê·∫∑t" data-title="C√†i ƒê·∫∑t"> <i class="fas fa-cog text-sm"></i> </button>
     </div>
     
	<div class="flex items-center justify-end space-x-3"> 
        <button onclick="toggleHeaderMenu()" class="md:hidden flex-shrink-0 w-10 h-10 bg-gray-200 text-gray-700 rounded-full flex items-center justify-center" id="rightMenuBtn"> <i class="fas fa-bars text-lg"></i> </button> 
        
		<div class="relative">
            <button onclick="toggleNotifications()" class="text-custom hover:text-primary transition-colors duration-200 p-2 rounded-full relative" title="Th√¥ng b√°o">
                <i class="bi bi-bell text-xl"></i>
                <span id="notification-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden" style="font-size: 0.6rem;">0</span>
            </button>
            <div id="notifications-dropdown" class="absolute right-0 top-12 bg-accent border border-custom rounded-lg shadow-lg hidden z-50" style="width: 19rem;">
                <div class="p-2 border-b border-custom flex justify-between items-center">
                   <h3 class="font-bold text-primary">Th√¥ng b√°o</h3>
                   <button onclick="markAllNotificationsAsRead()" class="text-custom hover:text-primary transition-colors duration-200 p-1 rounded-full" title="ƒê√°nh d·∫•u t·∫•t c·∫£ ƒë√£ ƒë·ªçc">
                       <i class="bi bi-check-all text-xl"></i>
                   </button>
                </div>
                <div id="notifications-content" class="max-h-96 overflow-y-auto" style="overflow-x: hidden;">
                   <div class="loading-spinner mx-auto my-4"></div>
                </div>
            </div>
        </div>
		
        <button onclick="openModal('profileModal')" class="flex items-center space-x-2 love-card rounded-full p-1"> 
        <img src="https://ui-avatars.com/api/?name=LS&background=006B68&color=fff" alt="Avatar" class="w-8 h-8 rounded-full"> 
        <span id="userNameDisplay" class="hidden md:block font-medium pr-3"> </span> 
        </button>
     </div>
	 
    </div>
   </div>
  </header>
  
  
  <main class="flex-1 container mx-auto px-4 overflow-y-auto"><!-- Home Section -->
   <div id="homeSection" class="section py-6 relative">
    <div id="dashboardGrid" class="grid grid-cols-1 lg:grid-cols-6 gap-6 pb-20 transition-all duration-300">
		<div id="widget-babyrun" class="widget-item lg:col-span-4 relative group" data-col="4">
			<div class="love-card rounded-lg p-6 mb-4 relative h-full"> 
				<button onclick="openBabyRunChart()" class="absolute top-2 right-2 text-gray-400 hover:text-primary transition-colors p-2 rounded-full hover:bg-gray-100" title="Xem bi·ªÉu ƒë·ªì">
					<i class="fas fa-chart-line text-xl"></i>
				</button>
				<div class="flex flex-col items-center justify-center space-y-4">
					<div class="text-center">
						<p class="text-sm text-gray-500">L∆∞·ª£t ƒë·∫°p h√¥m nay</p>
						<p id="babyRunCount" class="text-4xl font-bold text-primary">0</p>
					</div>
					<button id="babyRunBtn" 
							class="w-20 h-20 rounded-full bg-primary text-white shadow-lg hover:scale-105 active:scale-95 transition-transform flex items-center justify-center text-3xl"
							onclick="handleBabyRunClick()">
						<span style="font-size: 32px; filter: brightness(0) invert(1);">üë£</span>
					</button>
				</div>
			</div>
		</div>

		<div id="widget-memories" class="widget-item lg:col-span-4 relative group" data-col="4">
			<div class="love-card rounded-lg p-6 h-full">
				<div class="flex items-center mb-4"><i class="fas fa-calendar-day text-primary text-2xl mr-3"></i>
					<h2 class="text-xl font-bold text-primary">Ng√†y N√†y NƒÉm X∆∞a</h2>
				</div>
				<div id="todayMemories">
					<div class="skeleton h-32 rounded mb-4"></div>
				</div>
			</div>
		</div>

		<div id="widget-days" class="widget-item lg:col-span-2 relative group" data-col="2">
			<div class="love-card rounded-lg p-4 flex items-center space-x-4 h-full">
				<div class="flex-shrink-0 w-12 h-12 bg-primary rounded-full flex items-center justify-center">
					<i class="fas fa-heart text-white text-xl"></i>
				</div>
				<div>
					<p class="text-sm text-gray-500">Ng√†y b√™n nhau</p>
					<p class="text-2xl font-bold text-primary" id="daysTogether">0</p>
				</div>
			</div>
		</div>

		<div id="widget-count-memories" class="widget-item lg:col-span-2 relative group" data-col="2">
			<div class="love-card rounded-lg p-4 flex items-center space-x-4 cursor-pointer h-full" onclick="selectMenuItem('timeline')">
				<div class="flex-shrink-0 w-12 h-12 bg-secondary rounded-full flex items-center justify-center">
					<i class="fas fa-star text-white text-xl"></i>
				</div>
				<div>
					<p class="text-sm text-gray-500">K·ª∑ ni·ªám</p>
					<p class="text-2xl font-bold text-secondary" id="totalMemories">0</p>
				</div>
			</div>
		</div>

		<div id="widget-count-media" class="widget-item lg:col-span-2 relative group" data-col="2">
			<div class="love-card rounded-lg p-4 flex items-center space-x-4 cursor-pointer h-full" onclick="selectMenuItem('photos')">
				<div class="flex-shrink-0 w-12 h-12 bg-primary rounded-full flex items-center justify-center">
					<i class="fas fa-images text-white text-xl"></i>
				</div>
				<div>
					<p class="text-sm text-gray-500">Media</p>
					<p class="text-2xl font-bold text-primary" id="totalPhotos">0</p>
				</div>
			</div>
		</div>

		<div id="widget-upcoming" class="widget-item lg:col-span-2 relative group" data-col="2">
			 <div class="love-card rounded-lg p-4 flex items-center space-x-4 h-full">
				<div class="flex-shrink-0 w-12 h-12 bg-primary rounded-full flex items-center justify-center">
					<i class="fas fa-clock text-white text-xl"></i>
				</div>
				<div id="upcomingEventsContainer" class="flex-1">
					</div>
			</div>
		</div>

		<div id="widget-gold" class="widget-item lg:col-span-2 relative group" data-col="2">
			 <div class="love-card rounded-lg p-4 flex items-center space-x-4 cursor-pointer h-full" onclick="toggleGoldChart()">
				<div class="flex-shrink-0 w-12 h-12 bg-yellow-500 rounded-full flex items-center justify-center">
					<i class="fas fa-ring text-white text-xl"></i>
				</div>
				<div class="w-full">
					<p class="text-sm text-gray-500 mb-1">Gi√° v√†ng (Nh·∫´n tr√≤n 9999)</p>
					<p class="text-sm text-gray-400 mb-1">Gi√° mua:&nbsp&nbsp<span class="font-bold text-yellow-600" id="goldBuyPrice">N/A</span></p>
					<p class="text-sm text-gray-400 mb-1">Gi√° b√°n:&nbsp&nbsp&nbsp<span class="font-bold text-yellow-600" id="goldSellPrice">N/A</span></p>
				</div>
			</div> 
			
			<div id="goldChartContainer" class="love-card rounded-lg p-4 hidden mt-4 absolute top-full left-0 right-0 z-50 shadow-xl border border-gray-200">
				<div class="chart-toolbar mb-4 flex justify-center gap-2">
					<button id="btn-gold-1m" class="chart-toolbar-btn active">1M</button>
					<button id="btn-gold-3m" class="chart-toolbar-btn">3M</button>
					<button id="btn-gold-6m" class="chart-toolbar-btn">6M</button>
					<button id="btn-gold-1y" class="chart-toolbar-btn">1Y</button>
					<button id="btn-gold-3y" class="chart-toolbar-btn">3Y</button>
				</div>
				<div id="homeGoldChart" class="mb-4"></div>
				<div class="border-t border-custom pt-4 mb-4">
					<h3 class="text-lg font-bold text-primary mb-4">T√≥m T·∫Øt Danh M·ª•c</h3>
					<div class="grid grid-cols-2 gap-4"> 
						<div class="text-center flex flex-col justify-center">
							<p class="text-sm text-gray-500">S·ªë L∆∞·ª£ng</p>
							<p class="text-lg font-bold" id="summaryTotalHolding">0 ch·ªâ</p>
						</div>
						<div class="text-center">
							<div>
								<p class="text-sm text-gray-500">L√£i/L·ªó T·∫°m T√≠nh</p>
								<p class="text-lg font-bold" id="summaryUnrealizedPNL">0 ƒë</p>
							</div>
							<div class="mt-2 border-t border-custom"> 
								<p class="text-sm text-gray-500">L√£i/L·ªó ƒê√£ Ch·ªët</p>
								<p class="text-lg font-bold" id="summaryRealizedPNL">0 ƒë</p>
							</div>
						</div>
					</div>
				</div>
				<div class="border-t border-custom pt-4">
					<div class="flex justify-between items-center mb-4">
						<h3 class="text-lg font-bold text-primary">L·ªãch S·ª≠ Giao D·ªãch</h3>
						<button onclick="openGoldModal()" class="love-button w-10 h-10 rounded-full flex items-center justify-center p-0" title="Th√™m giao d·ªãch m·ªõi">
							<i class="fas fa-plus"></i> 
						</button>
					</div>
					<div id="goldTransactionList" class="space-y-3 mb-4 max-h-80 overflow-y-auto">
						<p class="text-sm text-gray-500 text-center">Ch∆∞a c√≥ giao d·ªãch n√†o.</p>
					</div>
				</div>
			</div>
		</div>

	</div>

    <div id="editorToolbar" class="bg-white shadow-2xl rounded-full px-6 py-3 flex items-center space-x-3 border border-gray-200">
        <span class="font-bold text-primary text-sm whitespace-nowrap">Edit</span>
                
        <button onclick="saveLayoutConfig()" class="love-button secondary text-sm px-3 py-1 whitespace-nowrap">
            <i class="fas fa-save mr-1"></i>L∆∞u
        </button>
        
        <button onclick="resetLayoutConfig()" class="love-button text-sm px-3 py-1 whitespace-nowrap bg-red-500 hover:bg-red-600">
            <i class="fas fa-undo mr-1"></i>M·∫∑c ƒë·ªãnh
        </button>
        
        <button onclick="toggleEditMode()" class="w-8 h-8 rounded-full bg-gray-100 text-gray-500 hover:bg-gray-200 flex items-center justify-center ml-2">
            <i class="fas fa-times"></i>
        </button>
    </div>
	
   </div><!-- Chat AI Section -->
   <div id="chatSection" class="section hidden h-full flex flex-col py-6">
    <div class="love-card rounded-lg overflow-hidden flex flex-col flex-1">
      <div class="bg-primary text-white p-4 flex justify-between items-center flex-shrink-0">
        <h2 class="text-lg font-bold"><i class="fas fa-robot mr-2"></i>Chat AI</h2>
        <div class="flex space-x-1 border border-white/50 rounded-md p-0.5">
			<button id="aiModeBtn-google" onclick="switchAiModel('google')" class="ai-mode-btn px-2 py-1 text-xs rounded-sm ">Google</button>
            <button id="aiModeBtn-gpt" onclick="switchAiModel('gpt')" class="ai-mode-btn px-2 py-1 text-xs rounded-sm">GPT</button>
        </div>
      </div>
      <div class="flex-1 overflow-y-auto p-4" id="chatMessages">
        </div>
      <div class="border-t border-custom p-4 flex-shrink-0">
        <div class="flex space-x-3"><input type="text" id="chatInput" placeholder="H·ªèi g√¨..." class="love-input flex-1" onkeypress="handleChatKeyPress(event)"> <button onclick="sendChatMessage()" class="love-button"> <i class="fas fa-paper-plane"></i> </button>
       </div>
      </div>
     </div>
   </div><!-- Timeline Section -->
   <div id="timelineSection" class="section hidden">
    
    <div class="flex justify-between items-center sticky top-0 z-40 bg-custom py-2 mb-6">
     <h2 class="text-xl font-bold text-primary"><i class="fas fa-clock mr-2"></i>S·ª± Ki·ªán</h2>
     
     <div class="flex items-center space-x-2 relative"> <button onclick="toggleFilterDropdown()" class="love-button w-10 h-10 rounded-full flex items-center justify-center p-0" title="L·ªçc s·ª± ki·ªán"> 
            <i class="fas fa-filter"></i> 
        </button>
        
        <div id="filterDropdown" class="hidden absolute top-full right-0 z-50 mt-2 w-72 bg-accent border border-custom rounded-lg shadow-lg">
            <div class="p-2 border-b border-custom">
                <button onclick="clearEventFilter()" class="love-button secondary text-xs px-3 py-1 w-full">X√≥a t·∫•t c·∫£</button>
            </div>
            <div id="filterDropdownList" class="max-h-80 overflow-y-auto p-2">
                </div>
        </div>
        <button id="timelineViewToggle" onclick="toggleTimelineView()" class="love-button w-10 h-10 rounded-full flex items-center justify-center p-0" title="ƒê·ªïi ch·∫ø ƒë·ªô xem"> 
            <i class="fas fa-list"></i> 
        </button>
        <button onclick="openModal('eventModal')" class="love-button w-10 h-10 rounded-full flex items-center justify-center p-0" title="Th√™m s·ª± ki·ªán"> 
            <i class="fas fa-plus"></i> 
        </button>
     </div>
     </div>

    <div id="timelineContainer">
     <div class="skeleton h-40 rounded mb-4"></div>
     <div class="skeleton h-40 rounded mb-4"></div>
     <div class="skeleton h-40 rounded"></div>
    </div>

   </div>
   <!-- Photos Section -->
   <div id="photosSection" class="section hidden">
	<div class="flex justify-between items-center sticky top-0 z-40 bg-custom py-2 mb-6">
     <h2 class="text-xl font-bold text-primary"><i class="fas fa-photo-video mr-2"></i>Kho·∫£nh Kh·∫Øc</h2>
     <div class="flex items-center space-x-3">
		 <button onclick="cyclePhotoView()" class="love-button flex items-center space-x-1 text-sm px-3 py-2" id="viewToggleBtn" style="transform: scale(0.85);"> 
			<i class="fas fa-th text-sm" id="viewToggleIcon"></i> <span id="viewToggleText">2x2</span> 
		 </button>
     </div>
    </div>
    <div id="photosContainer" class="photo-grid grid-view-2"><!-- Photos will be loaded here -->
    </div>
    <div id="photosPagination" class="mt-6 flex justify-center items-center"></div><!-- Pagination will be loaded here -->
    </div>
	<!-- Settings Section -->
   <div id="settingsSection" class="section hidden py-6">
    <h2 class="text-xl font-bold text-primary sticky top-0 z-40 bg-custom py-2 mb-6">
		<i class="fas fa-cog mr-2"></i>C√†i ƒê·∫∑t
	</h2>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><!-- Giao Di·ªán -->
     <div class="love-card rounded-lg p-6">
      <h3 class="text-lg font-bold text-primary mb-4"><i class="fas fa-palette mr-2"></i>Giao Di·ªán</h3>
      <div class="space-y-4">
       <div class="block"><span class="text-sm font-medium mb-3 block">Ch·ªçn Theme:</span>
        <div class="grid grid-cols-2 gap-3">
			<label class="flex items-center justify-center space-x-3 cursor-pointer p-3 rounded-lg border border-custom hover:bg-gray-50 transition-colors"> <input type="radio" name="theme" value="default" class="sr-only" onchange="changeThemeRadio('default')">
				<div class="flex items-center space-x-2">
				   <div class="w-5 h-5 rounded-full bg-gradient-to-r from-teal-600 to-yellow-400 border-2 border-white shadow-sm"></div>
				   <div class="w-3 h-3 rounded-full bg-teal-600"></div>
				  </div>
				  <div class="w-4 h-4 rounded-full border-2 border-gray-300 theme-radio-default"></div>
			</label> 
			<label class="flex items-center justify-center space-x-3 cursor-pointer p-3 rounded-lg border border-custom hover:bg-gray-50 transition-colors"> <input type="radio" name="theme" value="spring" class="sr-only" onchange="changeThemeRadio('spring')">
				  <div 
			class="flex items-center space-x-2">
				   <div class="w-5 h-5 rounded-full bg-gradient-to-r from-emerald-500 to-amber-500 border-2 border-white shadow-sm"></div>
				   <div class="w-3 h-3 rounded-full bg-emerald-500"></div>
				  </div>
				  <div class="w-4 h-4 rounded-full border-2 border-gray-300 theme-radio-spring"></div>
			</label> 
			<label class="flex items-center justify-center space-x-3 cursor-pointer p-3 rounded-lg border border-custom hover:bg-gray-50 transition-colors"> <input type="radio" name="theme" value="summer" class="sr-only" onchange="changeThemeRadio('summer')">
				  <div class="flex items-center space-x-2">
		   
					<div class="w-5 h-5 rounded-full bg-gradient-to-r from-amber-500 to-red-500 border-2 border-white shadow-sm"></div>
				   <div class="w-3 h-3 rounded-full bg-amber-500"></div>
				  </div>
				  <div class="w-4 h-4 rounded-full border-2 border-gray-300 theme-radio-summer"></div>
			</label> 
			<label class="flex items-center justify-center space-x-3 cursor-pointer p-3 rounded-lg border border-custom hover:bg-gray-50 transition-colors"> <input type="radio" name="theme" value="night" class="sr-only" onchange="changeThemeRadio('night')">
				  <div class="flex items-center space-x-2">
				
			   <div class="w-5 h-5 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 border-2 border-white shadow-sm"></div>
				   <div class="w-3 h-3 rounded-full bg-indigo-500"></div>
				  </div>
				  <div class="w-4 h-4 rounded-full border-2 border-gray-300 theme-radio-night"></div>
			</label> 
			<label class="flex items-center justify-center space-x-3 cursor-pointer p-3 rounded-lg border border-custom hover:bg-gray-50 transition-colors"> <input type="radio" name="theme" value="romantic" class="sr-only" onchange="changeThemeRadio('romantic')">
				  <div class="flex items-center space-x-2">
				   <div class="w-5 
			h-5 rounded-full bg-gradient-to-r from-pink-500 to-orange-500 border-2 border-white shadow-sm"></div>
				   <div class="w-3 h-3 rounded-full bg-pink-500"></div>
				  </div>
				  <div class="w-4 h-4 rounded-full border-2 border-gray-300 theme-radio-romantic"></div>
			</label> 
			<label class="flex items-center justify-center space-x-3 cursor-pointer p-3 rounded-lg border border-custom hover:bg-gray-50 transition-colors"> <input type="radio" name="theme" value="ocean" class="sr-only" onchange="changeThemeRadio('ocean')">
				  <div class="flex items-center space-x-2">
				   <div class="w-5 h-5 rounded-full bg-gradient-to-r from-sky-500 to-cyan-500 
			border-2 border-white shadow-sm"></div>
				   <div class="w-3 h-3 rounded-full bg-sky-500"></div>
				  </div>
				  <div class="w-4 h-4 rounded-full border-2 border-gray-300 theme-radio-ocean"></div>
			</label>
		</div>
       </div>
       <div class="flex items-center justify-between">
        <div><span class="font-medium">Hi·ªÉn th·ªã n√∫t menu</span>
         <p class="text-xs text-gray-500 mt-1">·∫®n n√∫t menu tr√™n giao di·ªán</p>
        </div><label class="toggle-switch"> <input type="checkbox" id="showHamburgerMenu" checked onchange="toggleHamburgerMenu()"> <span class="toggle-slider"></span> </label>
       </div>
	   
	   <div class="flex items-center justify-between">
        <div><span class="font-medium">Th√¥ng b√°o h·ªá th·ªëng</span>
         <p class="text-xs text-gray-500 mt-1">T·∫Øt/b·∫≠t c√°c th√¥ng b√°o giao di·ªán.</p>
        </div><label class="toggle-switch"> <input type="checkbox" id="enableSystemNotifications" onchange="toggleSystemNotifications()"> <span class="toggle-slider"></span> </label>
       </div>
	   
	   <div class="flex items-center justify-between">
        <div><span class="font-medium">Menu D·∫°ng D·ªçc</span>
         <p class="text-xs text-gray-500 mt-1">B·∫≠t ƒë·ªÉ menu x·ªï xu·ªëng (d·ªçc) thay v√¨ ngang.</p>
        </div><label class="toggle-switch"> <input type="checkbox" id="verticalMenuToggle" onchange="toggleVerticalMenu()"> <span class="toggle-slider"></span> </label>
       </div>
	   
	   <div class="flex items-center justify-between">
        <div><span class="font-medium">Ch·ªânh s·ª≠a b·ªë c·ª•c</span>
         <p class="text-xs text-gray-500 mt-1">S·∫Øp x·∫øp, thay ƒë·ªïi k√≠ch th∆∞·ªõc c√°c kh·ªëi d·ªØ li·ªáu tr√™n trang ch·ªß.</p>
        </div>
		<button onclick="toggleEditMode(); showSection('home')" class="love-button">
				<i class="fas fa-pencil-alt"></i>
			</button>
       </div>
	    
      </div>
     </div><!-- T·ª± ƒê·ªông C·∫≠p Nh·∫≠t -->
     <div class="love-card rounded-lg p-6">
      <h3 class="text-lg font-bold text-primary mb-4"><i class="fas fa-sync mr-2"></i>Data Google Drive</h3>
      <div class="space-y-4">
       <div class="flex items-center justify-between">
        <div><span class="font-medium">ƒê·ªìng b·ªô metadata ·∫£nh t·ª´ Google Drive</span>
         <p class="text-xs text-gray-500 mt-1">T·ª± ƒë·ªông t·∫£i ·∫£nh t·ª´ Google Drive theo l·ªãch</p>
        </div><label class="toggle-switch"> <input type="checkbox" id="autoSync" checked onchange="updateAutoSyncConfig()"> <span class="toggle-slider"></span> </label>
       </div>
       <div class="grid grid-cols-2 gap-4"><label class="block"> <span class="text-sm font-medium mb-2 block">T·∫ßn su·∫•t:</span> <select id="syncFrequency" class="love-input w-full" onchange="updateAutoSyncConfig()"> <option value="daily">H√†ng ng√†y</option> <option value="weekly">H√†ng tu·∫ßn</option> <option value="monthly">H√†ng th√°ng</option> <option value="once">1 l·∫ßn</option> </select> </label> <label class="block"> <span class="text-sm font-medium mb-2 block">Th·ªùi gian:</span> <input type="text" id="syncTime" class="love-input w-full" value="09:04" placeholder="HH:MM" maxlength="5" oninput="formatTimeInput(this)" onchange="updateAutoSyncConfig()"> </label>
       </div>
       <div class="flex space-x-3"><button onclick="manualSync()" class="love-button w-full"> <i class="fas fa-sync mr-2"></i>ƒê·ªìng B·ªô Th·ªß C√¥ng</button>
       </div>
       <div class="flex space-x-3 mt-2"><button onclick="saveAppConfig()" class="love-button secondary w-full"> <i class="fas fa-save mr-2"></i>L∆∞u</button>
       </div>
      </div>
     </div><!-- Nh·∫≠t k√Ω ho·∫°t ƒë·ªông -->
     <div class="love-card rounded-lg p-6">
      <h3 class="text-lg font-bold text-primary mb-4"><i class="fas fa-file-alt mr-2"></i>Nh·∫≠t K√Ω Ho·∫°t ƒê·ªông</h3>
      <div class="space-y-4">
       <div class="flex items-center justify-between">
        <div><span class="font-medium">B·∫≠t nh·∫≠t k√Ω ho·∫°t ƒë·ªông</span>
         <p class="text-xs text-gray-500 mt-1">L∆∞u ho·∫°t ƒë·ªông ng∆∞·ªùi d√πng</p>
        </div><label class="toggle-switch"> <input type="checkbox" id="enableLogs" checked onchange="updateLogsConfig()"> <span class="toggle-slider"></span> </label>
       </div>
       <div class="space-y-2 text-sm">
        <div class="flex justify-between"><span>T·ªïng s·ªë b·∫£n ghi:</span> <span class="font-bold" id="totalLogs">1,247</span>
        </div>
        <div class="flex justify-between"><span>ƒê√£ l∆∞u file:</span> <span class="font-bold text-green-600" id="savedLogs">0</span>
        </div>
        <div class="flex justify-between"><span>Ch·ªù l∆∞u file:</span> <span class="font-bold text-orange-600" id="pendingLogs">0</span>
        </div>
       </div><button onclick="openModal('logsModal')" class="love-button w-full"> <i class="fas fa-eye mr-2"></i>Chi Ti·∫øt Nh·∫≠t K√Ω </button>
      </div>
     </div><!-- Th√¥ng Tin H·ªá Th·ªëng -->
     <div class="love-card rounded-lg p-6">
      <h3 class="text-lg font-bold text-primary mb-4"><i class="fas fa-info-circle mr-2"></i>Th√¥ng Tin H·ªá Th·ªëng</h3>
      <div class="space-y-3 text-sm">
       <div class="flex justify-between"><span>Phi√™n b·∫£n:</span> <span class="font-bold">v2.1.0</span>
       </div>
       <div class="flex justify-between"><span>GitHub:</span> <span class="flex items-center"> <span class="status-indicator status-online"></span> <span class="font-bold text-green-600">Conn..</span> </span>
       </div>
       <div class="flex justify-between"><span>Google Drive:</span> <span class="flex items-center"> <span class="status-indicator status-online"></span> <span class="font-bold text-green-600">Conn..</span> </span>
       </div>
       <div class="flex justify-between"><span>Dung l∆∞·ª£ng s·ª≠ d·ª•ng:</span> <span id="storageUsageDisplay" class="font-bold">ƒêang t√≠nh...</span>
       </div>
       <div class="flex justify-between"><span>Tr·∫°ng th√°i:</span> <span class="flex items-center"> <span class="status-indicator status-online"></span> <span class="font-bold text-green-600" id="onlineStatus">Onl</span> </span>
       </div>
      </div>
     </div>
    </div>
   </div>
  </main><!-- Footer -->
  <footer class="footer">
   <div class="text-center text-sm text-gray-600">
    <p class="font-medium">B·∫£n quy·ªÅn thu·ªôc v·ªÅ: H√† M·∫°nh T√≠n</p>
    <p>¬© 2025 - ·ª®ng d·ª•ng k·ª∑ ni·ªám</p>
   </div>
  </footer><!-- Modals --> <!-- Search Modal -->
  <div id="searchModal" class="modal">
   <div class="modal-content w-full max-w-2xl">
    <div class="flex justify-between items-center mb-4">
     <h3 class="text-xl font-bold text-primary"><i class="fas fa-search mr-2"></i>T√¨m Ki·∫øm &amp; AI</h3><button onclick="closeModal('searchModal')" class="text-gray-500 hover:text-gray-700"> <i class="fas fa-times text-xl"></i> </button>
    </div>
    <div class="space-y-4"><input type="text" id="searchInput" placeholder="T√¨m ki·∫øm s·ª± ki·ªán, h·ªèi AI..." class="love-input w-full">
     <div class="grid grid-cols-2 md:grid-cols-4 gap-2"><button class="love-button text-sm" onclick="quickSearch('sinh nh·∫≠t')">Sinh nh·∫≠t</button> <button class="love-button text-sm" onclick="quickSearch('du l·ªãch')">Du l·ªãch</button> <button class="love-button text-sm" onclick="quickSearch('k·ª∑ ni·ªám')">K·ª∑ ni·ªám</button> <button class="love-button text-sm" onclick="quickSearch('th·ªëng k√™')">Th·ªëng k√™</button>
     </div>
     <div id="searchResults" class="max-h-60 overflow-y-auto"><!-- Search results will appear here -->
     </div>
    </div>
   </div>
  </div><!-- Profile Modal -->
  <div id="profileModal" class="modal">
   <div class="modal-content w-full max-w-md">
    <div class="flex justify-between items-center mb-4">
     <h3 class="text-xl font-bold text-primary"><i class="fas fa-user mr-2"></i>H·ªì S∆° C√° Nh√¢n</h3><button onclick="closeModal('profileModal')" class="text-gray-500 hover:text-gray-700"> <i class="fas fa-times text-xl"></i> </button>
    </div>
    <div class="text-center mb-6">
        <div class="relative w-20 h-20 mx-auto mb-3">
            <img id="profileAvatarImg" src="https://ui-avatars.com/api/?name=H√†+M·∫°nh+T√≠n&background=006B68&color=fff&size=100" alt="Avatar" class="w-20 h-20 rounded-full">
            <button onclick="triggerAvatarUpload()" class="absolute -bottom-1 -right-1 w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white hover:opacity-90 border-2 border-white">
                <i class="fas fa-camera text-sm"></i>
            </button>
        </div>
        <input type="file" id="avatarUpload" class="hidden" accept="image/*" onchange="handleAvatarUpload(event)">
    </div>
    <div class="space-y-4">
        <label class="block"> <span class="text-sm font-medium mb-2 block">H·ªç t√™n:</span> <input type="text" id="profileNameInput" value="" class="love-input w-full"> </label> 
        <label class="block"> <span class="text-sm font-medium mb-2 block">T√™n ƒëƒÉng nh·∫≠p:</span> <input type="text" id="profileUsernameInput" value="" class="love-input w-full" onchange="checkExistingUsername()"> </label>
	 <div class="love-card rounded p-3">
      <h4 class="font-medium mb-2">Th√¥ng tin thi·∫øt b·ªã:</h4>
      <div class="text-sm space-y-1">
       <p>IP: 192.168.1.100</p>
       <p>Tr√¨nh duy·ªát: Chrome 120.0</p>
       <p>H·ªá ƒëi·ªÅu h√†nh: Windows 11</p>
      </div>
     </div>
     <div class="flex space-x-3">
        <button class="love-button flex-1" onclick="saveProfile()">L∆∞u Thay ƒê·ªïi</button> 
        <button class="love-button secondary" onclick="logoutProfile()">ƒêƒÉng Xu·∫•t</button>
     </div>
    </div>
   </div>
  </div><!-- Event Modal -->
  <div id="eventModal" class="modal">
   <div class="modal-content w-full max-w-lg">
    <div class="flex justify-between items-center mb-4">
     <h3 class="text-xl font-bold text-primary"><i class="fas fa-plus mr-2"></i>Th√™m S·ª± Ki·ªán</h3><button onclick="closeModal('eventModal')" class="text-gray-500 hover:text-gray-700"> <i class="fas fa-times text-xl"></i> </button>
    </div>
    <form id="eventForm" onsubmit="saveEvent(event)">
     <div class="space-y-4"><label class="block"> 
		<label class="block"> 
            <span class="text-sm font-medium mb-2 block">Lo·∫°i s·ª± ki·ªán:</span> 
            <input type="text" id="eventCategory" class="love-input w-full" list="categoryDatalist" placeholder="Ch·ªçn ho·∫∑c nh·∫≠p lo·∫°i s·ª± ki·ªán...">
            <datalist id="categoryDatalist">
                </datalist>
        </label>
		<span class="text-sm font-medium mb-2 block">T√™n s·ª± ki·ªán:</span> <input type="text" id="eventName" required class="love-input w-full" placeholder="V√≠ d·ª•: Sinh nh·∫≠t l·∫ßn th·ª© 25"> </label> <label class="block"> <span class="text-sm font-medium mb-2 block">Ng√†y:</span> <input type="text" id="eventDate" required class="love-input w-full" placeholder="dd-mm-yyyy" pattern="\d{2}-\d{2}-\d{4}" maxlength="10" oninput="formatDateInput(this)"> </label> <label class="block"> <span class="text-sm font-medium mb-2 block">M√¥ t·∫£:</span> <textarea id="eventDescription" rows="3" class="love-input w-full" placeholder="M√¥ t·∫£ chi ti·∫øt v·ªÅ s·ª± ki·ªán..."></textarea> </label>
		
		
		<div><span class="text-sm font-medium mb-2 block">·∫¢nh:</span> <button type="button" onclick="openPhotoSelector()" class="love-button w-full"> <i class="fas fa-images mr-2"></i>Ch·ªçn ·∫¢nh </button>
			<p class="text-xs text-gray-500 mt-1">ƒê√£ ch·ªçn: <span id="selectedImagesCount">0</span> ·∫£nh</p>
		</div>
      <div class="flex space-x-3"><button type="submit" class="love-button flex-1">L∆∞u S·ª± Ki·ªán</button> <button type="button" onclick="closeModal('eventModal')" class="love-button secondary">H·ªßy</button>
      </div>
     </div>
    </form>
   </div>
  </div><!-- Photo Modal -->
  <div id="photoModal" class="modal">
   <div class="modal-content w-full max-w-4xl" style="padding: 1rem;">
    <div class="flex justify-between items-center mb-4">
        <div class="flex items-center space-x-2">
            <h3 class="text-xl font-bold text-primary"><i class="fas fa-image mr-2"></i>Xem ·∫¢nh</h3>
            <div class="relative">
                <button onclick="togglePhotoActionsMenu()" class="text-custom hover:text-primary p-2 rounded-full hover:bg-gray-100">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
                <div id="photoActionsMenu" class="hidden absolute left-0 top-full mt-1 bg-accent border border-custom rounded-lg shadow-lg z-50 min-w-[200px]">
                    <button onclick="openEventLinkModal()" class="w-full text-left px-4 py-2 text-custom hover:bg-gray-100 flex items-center">
                        <i class="fas fa-link mr-2 w-4"></i>G·∫Øn v√†o s·ª± ki·ªán...
                    </button>
                    </div>
            </div>
        </div>
        <button onclick="closeModal('photoModal')" class="text-gray-500 hover:text-gray-700"> <i class="fas fa-times text-xl"></i> </button>
    </div>
    <div class="text-center mb-4"><img id="modalPhoto" src="" alt="" class="mx-auto rounded-lg" style="max-width: 100%; max-height: 50vh; width: auto; height: auto; object-fit: contain;" referrerpolicy="no-referrer">
    </div>
    <div class="flex justify-center space-x-3 mb-4 whitespace-nowrap">
        <button id="likeButton" onclick="toggleLike()" class="love-button" style="transform: scale(0.90);"> <i id="likeIcon" class="fas fa-heart mr-2"></i><span id="likeText">Th√≠ch</span> (<span id="likeCount">0</span>) </button> 
        <button onclick="openShareModal()" class="love-button" style="transform: scale(0.90);"> <i class="fas fa-share mr-2"></i>Chia S·∫ª </button> 
        <button onclick="downloadPhoto()" class="love-button" style="transform: scale(0.90);"> <i class="fas fa-download mr-2"></i>T·∫£i V·ªÅ </button>
    </div>
    <div class="love-card rounded" style="padding: 0.5rem;">
     <h4 class="font-medium mb-3">B√¨nh lu·∫≠n:</h4>
     <div id="commentsContainer" class="space-y-2 mb-4 max-h-32 overflow-y-auto">
      <div class="text-sm text-gray-500">
       Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o
      </div>
     </div>
     <div class="flex space-x-2"><input type="text" id="commentInput" placeholder="Th√™m b√¨nh lu·∫≠n..." class="love-input flex-1" onkeypress="handleCommentKeyPress(event)"> <button onclick="addComment()" class="love-button"><i class="fas fa-paper-plane"></i></button>
     </div>
    </div>
   </div>
  </div>
  
  <div id="goldFormModal" class="modal" style="z-index: 1250;">
   <div class="modal-content w-full max-w-lg">
    <div class="flex justify-between items-center mb-4">
     <h3 id="goldModalTitle" class="text-xl font-bold text-primary"><i class="fas fa-plus mr-2"></i>Th√™m Giao D·ªãch M·ªõi</h3>
     <button onclick="closeModal('goldFormModal')" class="text-gray-500 hover:text-gray-700"> <i class="fas fa-times text-xl"></i> </button>
    </div>
    
    <form id="goldForm" onsubmit="saveGoldTransaction(event)">
     <input type="hidden" id="goldTxId">

     <div class="space-y-4">
        
        <div class="grid grid-cols-2 gap-4">
            <label class="block"> 
                <span class="text-sm font-medium mb-2 block">Ng√†y Giao D·ªãch:</span> 
                <input type="text" id="goldTxDate" required class="love-input w-full" placeholder="dd-mm-yyyy" pattern="\d{2}-\d{2}-\d{4}" maxlength="10" oninput="formatDateInput(this)"> 
            </label>
            <label class="block"> 
                <span class="text-sm font-medium mb-2 block">Lo·∫°i Giao D·ªãch:</span> 
                <select id="goldTxType" required class="love-input w-full">
                    <option value="buy" class="text-green-600 font-bold">Mua-M</option>
                    <option value="sell" class="text-red-600 font-bold">B√°n-B</option>
                </select>
            </label>
        </div>

        <div class="grid grid-cols-2 gap-4">
             <label class="block"> 
                <span class="text-sm font-medium mb-2 block">S·ªë l∆∞·ª£ng (ch·ªâ):</span> 
                <input type="number" step="0.1" id="goldTxQuantity" required class="love-input w-full" placeholder="0.0"> 
            </label>
             <label class="block"> 
                <span class="text-sm font-medium mb-2 block">Gi√° (VND/ch·ªâ):</span> 
                <input type="text" inputmode="numeric" id="goldTxPrice" required class="love-input w-full" placeholder="0" oninput="formatCurrencyInput(event)">
            </label>
        </div>

        <label class="block"> 
            <span class="text-sm font-medium mb-2 block">Ghi ch√∫:</span> 
            <textarea id="goldTxNotes" rows="2" class="love-input w-full" placeholder="Ghi ch√∫ giao d·ªãch..."></textarea> 
        </label>
      
      <div class="flex space-x-3">
        <button type="submit" class="love-button flex-1">L∆∞u Giao D·ªãch</button> 
        <button type="button" id="goldDeleteButton" onclick="deleteGoldTransaction()" class="love-button secondary" style="display: none; background-color: #EF4444;">X√≥a</button>
      </div>
     </div>
    </form>
   </div>
  </div>
  
  <div id="eventFilterModal" class="modal">
   <div class="modal-content w-full max-w-lg">
    <div class="flex justify-between items-center mb-4">
     <h3 class="text-xl font-bold text-primary"><i class="fas fa-filter mr-2"></i>L·ªçc S·ª± Ki·ªán</h3>
     <button onclick="closeModal('eventFilterModal')" class="text-gray-500 hover:text-gray-700"> <i class="fas fa-times text-xl"></i> </button>
    </div>
    
    <div class="flex justify-end mb-4">
        <button onclick="clearEventFilter()" class="love-button secondary text-sm px-3 py-1">X√≥a t·∫•t c·∫£</button>
    </div>

    <div id="filterCategoryList" class="space-y-3 max-h-80 overflow-y-auto mb-4 p-2 border border-custom rounded-lg">
        </div>
      
    <div class="flex space-x-3">
        <button type="button" onclick="applyEventFilter()" class="love-button flex-1">√Åp D·ª•ng</button> 
        <button type="button" onclick="closeModal('eventFilterModal')" class="love-button secondary">H·ªßy</button>
    </div>
   </div>
  </div>
  
  <!-- Share Modal -->
  <div id="shareModal" class="modal">
   <div class="modal-content w-full max-w-md">
    <div class="flex justify-between items-center mb-4">
     <h3 class="text-xl font-bold text-primary"><i class="fas fa-share mr-2"></i>Chia S·∫ª</h3><button onclick="closeModal('shareModal')" class="text-gray-500 hover:text-gray-700"> <i class="fas fa-times text-xl"></i> </button>
    </div>
    <div class="space-y-4">
     <div class="love-card rounded p-3"><label class="text-sm font-medium mb-2 block">Link chia s·∫ª:</label>
      <div class="flex space-x-2"><input type="text" id="shareLink" readonly class="love-input flex-1 text-sm"> <button onclick="copyShareLink()" class="love-button">Copy</button>
      </div>
     </div>
     <div class="grid grid-cols-2 gap-3"><button onclick="shareToFacebook()" class="love-button"> <i class="fab fa-facebook mr-2"></i>Facebook </button> <button onclick="shareToTwitter()" class="love-button"> <i class="fab fa-twitter mr-2"></i>Twitter </button> <button onclick="shareToTelegram()" class="love-button"> <i class="fab fa-telegram mr-2"></i>Telegram </button> <button onclick="generateQRCode()" class="love-button"> <i class="fas fa-qrcode mr-2"></i>T·∫°o QR </button>
     </div>
     <div id="qrCodeContainer" class="text-center mt-4 hidden"><img id="qrCodeImage" src="" alt="QR Code" class="w-32 h-32 mx-auto rounded">
      <p class="text-xs text-gray-500 mt-2">Qu√©t m√£ QR ƒë·ªÉ xem ·∫£nh</p>
     </div>
    </div>
   </div>
  </div>
  <!-- Image Selector Modal -->
  <div id="imageSelectorModal" class="modal" style="z-index: 1200;">
   <div class="modal-content w-full max-w-6xl"> <div class="flex justify-between items-center p-4 border-b border-custom"> <h3 class="text-xl font-bold text-primary">Ch·ªçn ·∫£nh</h3> <button onclick="closeModal('imageSelectorModal')" class="text-gray-500 hover:text-gray-700"> <i class="fas fa-times text-xl"></i> </button>
    </div>
    <div class="p-4"><div class="flex justify-between items-center mb-4">
      <div class="flex space-x-2">
        <button onclick="selectAllPhotos()" class="love-button secondary"> <i class="fas fa-check-double mr-2"></i>Ch·ªçn t·∫•t c·∫£</button> 
        <button onclick="deselectAllPhotos()" class="love-button"> <i class="fas fa-times mr-2"></i>H·ªßy ch·ªçn</button>
      </div>
      <div class="flex items-center space-x-2">
        <span class="text-sm text-custom"></span> 
        <button id="view-toggle-btn" onclick="toggleViewMode()" class="love-button"> <i class="fas fa-th mr-2"></i>3x3</button>
      </div>
     </div><div id="photo-selector-grid" class="mb-4 max-h-[60vh] overflow-y-auto"></div>
	 <div id="photo-selector-pagination" class="flex justify-center space-x-2" style="padding-top: 0.7rem; padding-bottom: 0.7rem;"></div><div class="flex justify-end space-x-3 pt-4 border-t border-custom"> 
      <button onclick="closeModal('imageSelectorModal')" class="love-button secondary">H·ªßy</button> 
      <button onclick="confirmPhotoSelection()" class="love-button"> <i class="fas fa-check mr-2"></i>X√°c nh·∫≠n</button>
     </div>
    </div>
    </div>
	</div>
	
 
  
	<!-- Event Photos Modal -->
  <div id="eventPhotosModal" class="modal">
   <div class="modal-content w-full max-w-4xl">
    <div class="flex justify-between items-center mb-4">
     <h3 class="text-xl font-bold text-primary"><i class="fas fa-images mr-2"></i>·∫¢nh S·ª± Ki·ªán</h3><button onclick="closeModal('eventPhotosModal')" class="text-gray-500 hover:text-gray-700"> <i class="fas fa-times text-xl"></i> </button>
    </div>
    <div id="eventPhotosGrid" class="grid grid-cols-3 md:grid-cols-4 gap-x-3 gap-y-3 max-h-96 overflow-y-auto"><!-- Event photos will be loaded here -->
    </div>
   </div>
  </div>
  
  <div id="eventLinkModal" class="modal" style="z-index: 1060;"> <div class="modal-content w-full max-w-lg">
    <div class="flex justify-between items-center mb-4">
     <h3 class="text-xl font-bold text-primary"><i class="fas fa-link mr-2"></i>G·∫Øn ·∫¢nh v√†o S·ª± Ki·ªán</h3>
     <button onclick="closeModal('eventLinkModal')" class="text-gray-500 hover:text-gray-700"> <i class="fas fa-times text-xl"></i> </button>
    </div>
    <div class="space-y-4">
        <p class="text-sm">Ch·ªçn s·ª± ki·ªán ƒë·ªÉ g·∫Øn ·∫£nh: <strong id="linkPhotoName" class="text-primary"></strong></p>
        
        <input type="text" id="eventLinkSearch" class="love-input w-full" placeholder="T√¨m ki·∫øm s·ª± ki·ªán..." oninput="filterEventLinkList()">
        
        <div id="eventLinkList" class="space-y-2 max-h-80 overflow-y-auto p-2 border border-custom rounded-lg">
            <div class="loading-spinner mx-auto my-4"></div>
        </div>
        
        <div class="text-right">
             <button type="button" onclick="closeModal('eventLinkModal')" class="love-button secondary">ƒê√≥ng</button>
        </div>
		</div>
	   </div>
	</div>
  <!-- Logs Modal -->
  <div id="logsModal" class="modal">
   <div class="modal-content w-full max-w-3xl">
    <div class="flex justify-between items-center mb-4">
     <h3 class="text-xl font-bold text-primary"><i class="fas fa-file-alt mr-2"></i>Nh·∫≠t K√Ω Ho·∫°t ƒê·ªông</h3><button onclick="closeModal('logsModal')" class="text-gray-500 hover:text-gray-700"> <i class="fas fa-times text-xl"></i> </button>
    </div>
    <div class="flex justify-between items-center mb-4">
     <div class="flex space-x-2"><button onclick="clearAllLogs('logsContainer', 'logFilter')" class="love-button secondary text-xs px-3 py-1">X√≥a T·∫•t C·∫£</button> <button onclick="exportLogs('logFilter')" class="love-button text-xs px-3 py-1">Xu·∫•t File</button>
     </div>
     <div class="flex items-center space-x-2">
	 <label class="text-sm">L·ªçc:</label> 
	 <select id="logFilter" onchange="filterLogs()" class="love-input text-xs px-2 py-1"> 
		 <option value="all">T·∫•t c·∫£</option> 
		 <option value="H·ªá th·ªëng">H·ªá th·ªëng</option>
		 <option value="ƒêi·ªÅu h∆∞·ªõng">ƒêi·ªÅu h∆∞·ªõng</option> 
		 <option value="Qu·∫£n l√Ω v√†ng">Qu·∫£n l√Ω v√†ng</option>
		 <option value="Th√™m s·ª± ki·ªán m·ªõi">Th√™m s·ª± ki·ªán</option> 
		 <option value="C·∫≠p nh·∫≠t s·ª± ki·ªán">S·ª≠a s·ª± ki·ªán</option> 
		 <option value="X√≥a s·ª± ki·ªán">X√≥a s·ª± ki·ªán</option> 
		 <option value="ƒê·ªìng b·ªô media">ƒê·ªìng b·ªô</option> 
		 <option value="Thay ƒë·ªïi theme">C√†i ƒë·∫∑t</option> 
		 <option value="M·ªü modal">Modal</option> 
		 <option value="T∆∞∆°ng t√°c ·∫£nh">T∆∞∆°ng t√°c</option> 
		 <option value="Ch·ªçn ·∫£nh">Ch·ªçn ·∫£nh</option> 
		 <option value="Chat AI">Chat AI</option> 
		 <option value="Thay ƒë·ªïi ch·∫ø ƒë·ªô xem">Ch·∫ø ƒë·ªô xem</option> 
		 <option value="Ph√¢n trang ·∫£nh">Ph√¢n trang</option> 
	 </select>
     </div>
    </div>
    <div id="logsContainer" class="space-y-3 max-h-96 overflow-y-auto"><!-- Logs will be loaded here -->
    </div>
   </div>
  </div>
  
  <!----chart so lan dap--->
  <div id="babyRunChartModal" class="modal" style="z-index: 1300;">
    <div class="modal-content w-full max-w-3xl">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-primary"><i class="fas fa-chart-line mr-2"></i>Th·ªëng K√™</h3>
            <button onclick="closeModal('babyRunChartModal')" class="text-gray-500 hover:text-gray-700"> <i class="fas fa-times text-xl"></i> </button>
        </div>

        <div class="bg-white rounded p-2">
            <div id="babyRunChartArea" class="mb-6"></div>
            
            <h4 class="font-bold text-gray-700 mb-2 px-2">Chi ti·∫øt</h4>
            <div class="overflow-x-auto max-h-60 overflow-y-auto border border-gray-200 rounded-lg">
                <table class="min-w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0">
                        <tr>
                            <th scope="col" class="px-6 py-3">Ng√†y</th>
                            <th scope="col" class="px-6 py-3 text-right">S·ªë l·∫ßn</th>
                        </tr>
                    </thead>
                    <tbody id="babyRunTableBody">
                        </tbody>
                </table>
            </div>
            </div>

        <div class="mt-4 text-center">
            <p class="text-sm text-gray-500">D·ªØ li·ªáu ƒë∆∞·ª£c t·ªïng h·ª£p theo ng√†y.</p>
        </div>
    </div>
</div>
  
  <script>
        // Global variables
        let currentSection = 'home';
        let notificationsOpen = false;
		let notificationLogPage = 1;
        let isLoadingNotifications = false;
		let readTimestamps = new Set(); // Set ƒë·ªÉ l∆∞u c√°c timestamp ƒë√£ ƒë·ªçc
        const READ_TIMESTAMPS_KEY = 'loveStoryReadLogs';
		let initialLogsLoaded = false;
		let allNotificationsLoaded = false;
		let goldData = [];
		let isVerticalMenu = false;
		let goldPortfolioData = [];
		let homeGoldChart = null; // Bi·∫øn to√†n c·ª•c ƒë·ªÉ gi·ªØ bi·ªÉu ƒë·ªì
        let editingGoldHoldingId = null; // Bi·∫øn t·∫°m ƒë·ªÉ bi·∫øt ƒëang s·ª≠a hay th√™m m·ªõi
		const predefinedCategories = [
            "Gia ƒë√¨nh", "B√© con", "Du l·ªãch", "Gi·∫£i tr√≠", "Gi√°o d·ª•c", "H√†i k·ªãch", "Phong c√°ch",
            "Khoa h·ªçc v√† c√¥ng ngh·ªá", "Vlog", "Nh·∫°c", "√î t√¥ v√† xe c·ªô",
            "Phim", "Th·ªÉ thao", "Th√∫ c∆∞ng", "Tin t·ª©c",
            "X√£ h·ªôi", "Tr√≤ ch∆°i"
        ];
        
        let allCategories = []; // Bi·∫øn l∆∞u tr·ªØ (predefined + custom)
        let currentEventFilter = []; // M·∫£ng l∆∞u c√°c category ƒëang ƒë∆∞·ª£c l·ªçc
        let isTimelineGrouped = false; // Tr·∫°ng th√°i xem (List/Group)
		// 1. Ki·ªÉm tra xem c√≥ ph·∫£i thi·∫øt b·ªã di ƒë·ªông kh√¥ng (d·ª±a theo CSS media query)
        const isMobile = window.innerWidth <= 768;
		
        let photoViewCycle = ['grid-2', 'grid-3', 'grid-4', 'grid-5', 'grid-6', 'grid-1', 'list'];
        let currentViewIndex = isMobile ? 0 : 4; // B·∫Øt ƒë·∫ßu v·ªõi grid-2 (di dong), v√† grid 6 n·∫øu khong phai di dong
        let currentPhotoView = photoViewCycle[currentViewIndex];
		// 4. Bi·∫øn tr·∫°ng th√°i nh√≥m (M·∫∑c ƒë·ªãnh B·∫≠t)
        let isPhotoGrouped = true; 
        let photoCategoryMap = new Map();
        // 5. H·∫±ng s·ªë ph√¢n trang (M·ªöI)
        const GROUPS_PER_PAGE = 3; // Hi·ªÉn th·ªã 5 nh√≥m (th·ªÉ lo·∫°i) m·ªói trang
		
        //let selectedImages = [];
        let logQueue = [];
        let isOnline = navigator.onLine;
        let pendingLogs = 0;
        let currentUser = null;
        let currentPage = 1;
        let editingEventId = null;
        let currentPhotoId = null;
        let currentPhotoName = null;
		let todayValidMemories = []; // L∆∞u danh s√°ch k·ª∑ ni·ªám cho h√¥m nay
		let upcomingEventInfo = null;
        let currentMemoryIndex = 0; // V·ªã tr√≠ k·ª∑ ni·ªám ƒëang xem
		let currentAiModel = 'google'; // Default AI model ('gpt', 'google');
		
		const STORAGE_COUNT_KEY = 'babyrun_count';
		const STORAGE_DATE_KEY = 'babyrun_date';
		const STORAGE_LOCAL_LOGS = 'babyrun_local_logs';
		
		//let modalViewCycle = ['grid-cols-3', 'grid-cols-4', 'grid-cols-5', 'grid-cols-6', 'grid-cols-2'];
        //let currentModalViewIndex = 0; // B·∫Øt ƒë·∫ßu v·ªõi grid-cols-3
        //let currentModalView = modalViewCycle[currentModalViewIndex];
		let selectedPhotos = new Set(); // THAY TH·∫æ selectedImages, d√πng Set t·ª´ logic new4.html
 
        // Bi·∫øn to√†n c·ª•c cho photo selector (t·ª´ new4.html)
        let photoSelectorPage = 1;
        let photoSelectorViewMode = 'grid-4'; // M·∫∑c ƒë·ªãnh l√† 3x3
        
        // View configuration for photo selector (t·ª´ new4.html)
        const viewConfig = {
            'grid-1': { icon: 'fas fa-square', text: '1x1' },
            'grid-2': { icon: 'fas fa-th-large', text: '2x2' },
            'grid-3': { icon: 'fas fa-th', text: '3x3' },
            'grid-4': { icon: 'fas fa-grip-horizontal', text: '4x4' },
            'grid-5': { icon: 'fas fa-grip-vertical', text: '5x5' },
            'grid-6': { icon: 'fas fa-border-all', text: '6x6' },
            'list': { icon: 'fas fa-list', text: 'Danh s√°ch' }
        };
		
		 
		
		let config = {
            "GITHUB_USERNAME": "nhungcute",
            "REPO_NAME": "LoveStory",
            "PAT1": "ghp_6ayAfXyjrA5qjOgY6Ixyw",
            "PAT2": "7dVfazEjR4HtvzK",
            "CONFIG_FILE_PATH": "configApp.json",
			"BRANCH": "main"
        };
		let appConfigData = {};
  
        // Data storage
        let homeData = {}; // <-- D·ªØ li·ªáu cho trang ch·ªß
        let eventsData = []; // D·ªØ li·ªáu cho trang Timeline
        let photosData = []; // D·ªØ li·ªáu cho trang Kho·∫£nh kh·∫Øc
        let commentsData = [];
        let profilesData = [];
        let logsData = [];
		let cachedServerBabyRunCount = 0;
		 
		
		// Th√™m 2 d√≤ng n√†y (kho·∫£ng d√≤ng 595)
        const imageErrorPlaceholder = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjQwMCIgdmlld0JveD0iMCAwIDQwMCA0MDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI0MDAiIGhlaWdodD0iNDAwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0yMDAgMTAwQzE4MC4xIDEwMCAxNjQuNCAxMTUuNyAxNjQuNCAxMzUuNkMxNjQuNCAxNTUuNSAxODAuMSAxNzEuMiAyMDAgMTcxLjJDMjE5LjkgMTcxLjIgMjM1LjYgMTU1LjUgMjM1LjYgMTM1LjZDMjM1LjYgMTE1LjcgMjE5LjkgMTAwIDIwMCAxMDBaIiBmaWxsPSIjOUI5QkEwIi8+CjxwYXRoIGQ9Ik0xMDAgMzAwSDE1MEwyMDAgMjUwTDI1MCAzMDBIMzAwVjI1MEwyNTAgMjAwTDIwMCAyNTBMMTUwIDIwMEwxMDAgMjUwVjMwMFoiIGZpbGw9IiM5QjlCQTAiLz4KPC9zdmc+';

        function getGridThumbnailUrl(media) {
            if (media.thumbnailLink && media.thumbnailLink.includes('=')) {
                // Hack URL c·ªßa Google ƒë·ªÉ l·∫•y ·∫£nh 400px (n√©t h∆°n 220px)
                return media.thumbnailLink.replace(/=s\d+/, '=s400');
            }
            // D√πng link g·ªëc ho·∫∑c link ƒë√£ t·∫°o
            return media.thumbnailLink || driveAPI.generateThumbnailLink(media.id, media.mimeType);
        }
		
        // GitHub API helper
        class GitHubAPI {
            constructor() {
                this.baseURL = 'https://api.github.com';
                this.token = config.PAT1 + config.PAT2;
            }

            async getFile(filePath) {
                try {
                    const response = await fetch(`${this.baseURL}/repos/${config.GITHUB_USERNAME}/${config.REPO_NAME}/contents/${filePath}`, {
                        headers: {
                            'Authorization': `token ${this.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        // 1. Gi·∫£i m√£ Base64 ra chu·ªói nh·ªã ph√¢n
                        const binaryString = atob(data.content);
                        
                        // 2. Chuy·ªÉn chu·ªói nh·ªã ph√¢n th√†nh m·ªôt m·∫£ng c√°c byte
                        const bytes = new Uint8Array(binaryString.length);
                        for (let i = 0; i < binaryString.length; i++) {
                            bytes[i] = binaryString.charCodeAt(i);
                        }
                        
                        // 3. D√πng TextDecoder ƒë·ªÉ gi·∫£i m√£ m·∫£ng byte theo chu·∫©n UTF-8
                        const decodedString = new TextDecoder('utf-8').decode(bytes);
                        
                        // 4. Ph√¢n t√≠ch chu·ªói JSON ƒë√£ ƒë∆∞·ª£c gi·∫£i m√£ ƒë√∫ng
                        return JSON.parse(decodedString);
                    }
                    return [];
                } catch (error) {
                    console.error(`Error loading ${filePath}:`, error);
                    return [];
                }
            }

            async updateFile(filePath, content, message) {
                try {
                    // L·∫•y SHA c·ªßa file hi·ªán t·∫°i (logic n√†y gi·ªØ nguy√™n)
                    const currentFile = await fetch(`${this.baseURL}/repos/${config.GITHUB_USERNAME}/${config.REPO_NAME}/contents/${filePath}`, {
                        headers: {
                            'Authorization': `token ${this.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    let sha = null;
                    if (currentFile.ok) {
                        const fileData = await currentFile.json();
                        sha = fileData.sha;
                    }

                    const jsonString = JSON.stringify(content, null, 2);
                    const utf8Bytes = new TextEncoder().encode(jsonString);

                    // X·ª≠ l√Ω d·ªØ li·ªáu theo t·ª´ng ƒëo·∫°n nh·ªè ƒë·ªÉ tr√°nh l·ªói stack overflow
                    let binaryString = '';
                    const chunkSize = 8192; // X·ª≠ l√Ω 8KB m·ªói l·∫ßn
                    for (let i = 0; i < utf8Bytes.length; i += chunkSize) {
                        const chunk = utf8Bytes.subarray(i, i + chunkSize);
                        binaryString += String.fromCharCode.apply(null, chunk);
                    }
                    const base64String = btoa(binaryString);

                    // G·ª≠i y√™u c·∫ßu c·∫≠p nh·∫≠t file (logic n√†y gi·ªØ nguy√™n)
                    const response = await fetch(`${this.baseURL}/repos/${config.GITHUB_USERNAME}/${config.REPO_NAME}/contents/${filePath}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${this.token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: message,
                            content: base64String,
                            sha: sha
                        })
                    });
                    return response.ok;
                } catch (error) {
                    console.error(`Error updating ${filePath}:`, error);
                    return false;
                }
            }
			
			async getRawFile(filePath) {
				const branch = config.BRANCH || 'main';
				const rawUrl = `https://raw.githubusercontent.com/${config.GITHUB_USERNAME}/${config.REPO_NAME}/${branch}/${filePath}`;
				
				try {
					const response = await fetch(`${rawUrl}?t=${new Date().getTime()}`);
					
					if (response.ok) {
						// 1. L·∫•y n·ªôi dung d∆∞·ªõi d·∫°ng VƒÇN B·∫¢N (text) tr∆∞·ªõc
						const text = await response.text();
						
						// 2. Ki·ªÉm tra xem file c√≥ r·ªóng kh√¥ng
						if (text.trim() === "") {
							console.warn(`File ${filePath} b·ªã r·ªóng. Tr·∫£ v·ªÅ m·∫£ng [].`);
							return []; // Tr·∫£ v·ªÅ m·∫£ng r·ªóng (h·ª£p l·ªá)
						}
						
						// 3. N·∫øu kh√¥ng r·ªóng, m·ªõi parse JSON
						return JSON.parse(text);
					}
					
					console.error(`L·ªói t·∫£i file th√¥ ${filePath}: ${response.statusText}`);
					return []; // Tr·∫£ v·ªÅ m·∫£ng r·ªóng n·∫øu 404
				} catch (error) {
					// B·∫Øt l·ªói n·∫øu file c√≥ n·ªôi dung, nh∆∞ng JSON b·ªã sai
					console.error(`L·ªói fetch/parse file th√¥ ${filePath}:`, error);
					return [];
				}
			}
		
        }

        // Google Drive API helper
        class GoogleDriveAPI {
            constructor() {
                this.apiKey = config.GDRIVE_API_KEY;
                this.folderId = config.GDRIVE_FOLDER_ID;
            }

            async getAllMediaFiles() {
                try {
                    let allFiles = [];
                    let nextPageToken = null;
                    let pageNumber = 1;
                    
                    do {
                        // X√¢y d·ª±ng URL truy v·∫•n ƒë·ªÉ l·∫•y t·∫•t c·∫£ media (·∫£nh v√† video)
                        // pageSize=1000 ƒë·ªÉ y√™u c·∫ßu t·ªëi ƒëa 1000 file m·ªói l·∫ßn g·ªçi
                        let url = `https://www.googleapis.com/drive/v3/files?q='${this.folderId}'+in+parents+and+(mimeType+contains+'image/'+or+mimeType+contains+'video/')&key=${this.apiKey}&fields=files(id,name,createdTime,modifiedTime,size,webViewLink,thumbnailLink,mimeType,parents,webContentLink),nextPageToken&pageSize=1000`;
                        //let url = `https://www.googleapis.com/drive/v3/files?q='${this.folderId}'+in+parents+and+(mimeType+contains+'image/'+or+mimeType+contains+'video/')&key=${this.apiKey}&fields=files(id,name,modifiedTime,size,parents,webContentLink),nextPageToken&pageSize=1000`;
                        // N·∫øu c√≥ token c·ªßa trang ti·∫øp theo, th√™m n√≥ v√†o URL
                        if (nextPageToken) {
                            url += `&pageToken=${nextPageToken}`;
                        }
                        
                        const response = await fetch(url);
                        if (response.ok) {
                            const data = await response.json();
                            // Chuy·ªÉn ƒë·ªïi ƒë·ªãnh d·∫°ng file cho ph√π h·ª£p v·ªõi ·ª©ng d·ª•ng
                            const transformedFiles = data.files.map((file, index) => ({
                                id: file.id,
                                name: file.name.toUpperCase(),
                                //webViewLink: file.webViewLink || `https://drive.google.com/file/d/${file.id}/view?usp=drivesdk`,
                                //webContentLink: file.webContentLink || `https://drive.google.com/uc?export=download&id=${file.id}`,
                                //thumbnailLink: file.thumbnailLink || this.generateThumbnailLink(file.id, file.mimeType),
                                //createdTime: file.createdTime,
                                //modifiedTime: file.modifiedTime || file.createdTime,
                                size: parseInt(file.size) || 0,
                                //mimeType: file.mimeType,
                                //description: this.generateDescription(file.name, file.mimeType),
                                source: "google-drive",
                                folderId: this.folderId,
                                //loadedAt: new Date().toISOString(),
                                pageNumber: pageNumber,
                                fileType: file.mimeType.startsWith('image/') ? 'image' : 'video'//,
                                //parents: file.parents || [this.folderId]
                            }));
                            
                            // N·ªëi c√°c file c·ªßa trang n√†y v√†o danh s√°ch t·ªïng
                            allFiles = allFiles.concat(transformedFiles);
                            // L·∫•y token cho trang k·∫ø ti·∫øp
                            nextPageToken = data.nextPageToken;
                            pageNumber++;
                            
                            console.log(`ƒê√£ t·∫£i trang ${pageNumber - 1}: ${transformedFiles.length} files (T·ªïng: ${allFiles.length})`);
                        } else {
                            console.error('L·ªói khi g·ªçi Google Drive API:', response.status, response.statusText);
                            break; // D·ª´ng l·∫°i n·∫øu c√≥ l·ªói
                        }
                        
                    } while (nextPageToken); // L·∫∑p l·∫°i n·∫øu v·∫´n c√≤n trang ti·∫øp theo
                    
                    console.log(`Ho√†n th√†nh ƒë·ªìng b·ªô: ${allFiles.length} files t·ª´ ${pageNumber - 1} trang.`);
                    return allFiles;
                } catch (error) {
                    console.error('L·ªói khi t·∫£i media files:', error);
                    return [];
                }
            }

            generateThumbnailLink(fileId, mimeType) {
                return `https://drive.google.com/thumbnail?id=${fileId}&sz=w300-h300`;
            }

            generateDescription(fileName, mimeType) {
                const fileType = mimeType.startsWith('image/') ? '·∫¢nh' : 'Video';
                return `${fileType} k·ª∑ ni·ªám - ${fileName}`;
            }

            async getPhotosMetadata() {
                // Backward compatibility - filter only images
                const allFiles = await this.getAllMediaFiles();
                return allFiles.filter(file => file.mimeType.startsWith('image/'));
            }

            getImageUrl(fileId, type = 'view') {
				const urls = {
					// Endpoint ch√≠nh x√°c ƒë·ªÉ xem ·∫£nh (c√≥ th·ªÉ c·∫ßn quy·ªÅn truy c·∫≠p)
					view: `https://drive.google.com/uc?export=view&id=${fileId}`,
					// Endpoint thumbnail
					thumbnail: `https://drive.google.com/thumbnail?id=${fileId}&sz=w400-h300-c`,
					// Endpoint t·∫£i v·ªÅ tr·ª±c ti·∫øp
					direct: `https://drive.google.com/uc?export=download&id=${fileId}`,
					// S·ª¨A: D√πng 'view' cho highQuality
					highQuality: `https://drive.google.com/uc?export=view&id=${fileId}`,
					fallback: `https://drive.google.com/file/d/${fileId}/view`
				};
				return urls[type] || urls.view;
			}
        }
 
        // Initialize API instances
        const githubAPI = new GitHubAPI();
        const driveAPI = new GoogleDriveAPI(); 
 
		async function loadCoreData() {
            try {
                showLoadingState();
                
                // --- B∆Ø·ªöC 1: T·∫£i file config ch√≠nh (B·∫ÆT BU·ªòC, d√πng API) ---
                try {
                    appConfigData = await githubAPI.getFile(config.CONFIG_FILE_PATH);
                    if (!appConfigData || Object.keys(appConfigData).length === 0) {
                        appConfigData = {};
                    }
                } catch (e) {
                    console.error(`L·ªói nghi√™m tr·ªçng: Kh√¥ng th·ªÉ t·∫£i file config ${config.CONFIG_FILE_PATH}.`, e);
                    appConfigData = {}; 
                }
                
                // --- B∆Ø·ªöC 2: G·ªôp config v√† c·∫≠p nh·∫≠t API keys ---
                config = { ...config, ...appConfigData }; 
                driveAPI.apiKey = config.GDRIVE_API_KEY; 
                driveAPI.folderId = config.GDRIVE_FOLDER_ID;

                // --- B∆Ø·ªöC 3: T·∫£i d·ªØ li·ªáu C·ªêT L√ïI (D√πng h√†m getRawFile SI√äU NHANH) ---
                const [home, profiles] = await Promise.all([
                    githubAPI.getRawFile(config.HOME_DATA_FILE_PATH),  // <-- S·ª¨A ·ªû ƒê√ÇY
                    githubAPI.getRawFile(config.PROFILES_FILE_PATH)    // <-- S·ª¨A ·ªû ƒê√ÇY
                ]);

                homeData = home || {}; 
                profilesData = profiles || [];
                
                loadCurrentUser(); 
                
                return true;
                
            } catch (error) {
                console.error('L·ªói nghi√™m tr·ªçng khi t·∫£i :', error);
                hideLoadingState(); 
                showNotification('L·ªói t·∫£i d·ªØ li·ªáu ch√≠nh! Vui l√≤ng ki·ªÉm tra file configApp.json.', 'error');
                return false;
            }
        }

        async function loadSecondaryData() {
            try {
                // --- B∆Ø·ªöC 4: T·∫£i d·ªØ li·ªáu PH·ª§ (D√πng h√†m getRawFile SI√äU NHANH) ---
                const [events, photos, comments, logs, gold, portfolio] = await Promise.all([
                    githubAPI.getRawFile(config.FILE_PATH),                  
                    githubAPI.getRawFile(config.PHOTOS_METADATA_FILE_PATH),  
                    githubAPI.getRawFile(config.COMMENTS_FILE_PATH),         
                    githubAPI.getRawFile(config.LOGS_FILE_PATH),
					githubAPI.getRawFile(config.CHART_FILE_PATH)     ,
					githubAPI.getRawFile(config.GOLD_PORTFOLIO_FILE_PATH) 
                ]);

                eventsData = events || []; 
                photosData = photos || []; 
                commentsData = comments || [];
                logsData = logs || [];
				goldData = gold || [];
				goldPortfolioData = portfolio || [];
                
                return true;
            } catch (error) {
                console.error('L·ªói khi t·∫£i d·ªØ li·ªáu (events, photos, comments, logs):', error);
                showNotification('L·ªói t·∫£i d·ªØ li·ªáu (s·ª± ki·ªán, ·∫£nh...).', 'error');
                return false;
            }
        }

        async function syncPhotosMetadata(isManual = false) {
            if (!isManual && !config.AUTO_SYNC_METADATA.enabled) return;
            
            try {
                if (isManual) {
                    showNotification('ƒêang ƒë·ªìng b·ªô media files...', 'info');
                }
                
                // Get all media files (images and videos)
                const allMediaFiles = await driveAPI.getAllMediaFiles();
                
                // Separate images and videos for different handling
                const images = allMediaFiles.filter(file => file.fileType === 'image');
                const videos = allMediaFiles.filter(file => file.fileType === 'video');
                
                // Replace all photos data with new data (keep backward compatibility)
                const oldCount = photosData.length;
                photosData = allMediaFiles; // Store all media files in photosData
                
                await githubAPI.updateFile(
                    config.PHOTOS_METADATA_FILE_PATH, 
                    photosData, 
                    isManual ? 'Manual sync: Updated media metadata' : `Auto sync: Updated ${allMediaFiles.length} media files`
                );
                
                const message = `ƒê√£ ƒë·ªìng b·ªô ${allMediaFiles.length} files (${images.length} ·∫£nh, ${videos.length} video) - C≈©: ${oldCount}`;
                addLog('ƒê·ªìng b·ªô media', message);
                showNotification(message, 'success');
                
                // Refresh photos display if on photos section
                if (currentSection === 'photos') {
                    loadPhotos(1);
                }
                
                // Update stats
                updateStats();
                
            } catch (error) {
                console.error('Error syncing media:', error);
                addLog('L·ªói ƒë·ªìng b·ªô', 'Kh√¥ng th·ªÉ ƒë·ªìng b·ªô media t·ª´ Google Drive');
                showNotification('L·ªói khi ƒë·ªìng b·ªô media!', 'error');
            }
        }
 
        // Danh s√°ch t√™n (b·∫°n c√≥ th·ªÉ th√™m/b·ªõt t√πy √Ω)
        const randomAnimals = ['G·∫•u', 'H·ªï', 'S∆∞ T·ª≠', 'Voi', 'H∆∞∆°u', 'C√°', 'V·∫πt', 'M√®o', 'Ch√≥', 'R√πa', 'Kh·ªâ', 'Th·ªè', 'S√≥i', 'C√°o', 'Heo', 'B√≤', 'G√†', 'V·ªãt', 'C√∫', 'D√™', 'C·ª´u', 'Ki·∫øn', 'T√©p', 'T√¥m'];
        const randomColors = ['Xanh', 'ƒê·ªè', 'T√≠m', 'V√†ng', 'Cam', 'H·ªìng', 'ƒêen', 'Tr·∫Øng', 'N√¢u', 'X√°m', 'L·ª•c', 'Lam', 'B·∫°c', 'ƒê·ªìng', 'B√≠ch', 'M∆°'];

        /**
         * L·∫•y m·ªôt ph·∫ßn t·ª≠ ng·∫´u nhi√™n t·ª´ m·∫£ng
         * @param {Array<string>} arr M·∫£ng ƒë·∫ßu v√†o
         * @returns {string} M·ªôt ph·∫ßn t·ª≠ ng·∫´u nhi√™n
         */
        function getRandomItem(arr) {
            return arr[Math.floor(Math.random() * arr.length)];
        }

        /**
         * Chu·∫©n h√≥a chu·ªói: x√≥a d·∫•u, x√≥a kho·∫£ng tr·∫Øng, chuy·ªÉn ch·ªØ th∆∞·ªùng
         * @param {string} str Chu·ªói ƒë·∫ßu v√†o (H·ªç t√™n)
         * @returns {string} Chu·ªói ƒë√£ chu·∫©n h√≥a (username)
         */
        function normalizeString(str) {
            if (!str) return '';
            return str
                .normalize("NFD") // 1. T√°ch d·∫•u (e.g., "√®" -> "e" + "`")
                .replace(/[\u0300-\u036f]/g, "") // 2. X√≥a c√°c k√Ω t·ª± d·∫•u
                .replace(/[ƒëƒê]/g, "d") // 3. Thay th·∫ø 'ƒë' v√† 'ƒê' th√†nh 'd'
                .replace(/\s+/g, '') // 4. X√≥a t·∫•t c·∫£ kho·∫£ng tr·∫Øng
                .toLowerCase(); // 5. Chuy·ªÉn th√†nh ch·ªØ th∆∞·ªùng
        }
          
        function loadCurrentUser() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                updateUserProfile();
            } else {
                // 1. T·∫°o H·ªç t√™n ng·∫´u nhi√™n
                const randomAnimal = getRandomItem(randomAnimals);
                const randomColor = getRandomItem(randomColors);
                const newName = `${randomAnimal} ${randomColor}`; // V√≠ d·ª•: "G·∫•u N√¢u"
                
                // 2. T·∫°o T√™n ƒëƒÉng nh·∫≠p ƒë√£ chu·∫©n h√≥a
                const newUsername = normalizeString(newName); // V√≠ d·ª•: "gaunau"
                
                // 3. T·∫°o Avatar URL d·ª±a tr√™n t√™n m·ªõi
				const newAvatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(newName)}&background=006B68&color=fff`;

                // 4. T·∫°o ƒë·ªëi t∆∞·ª£ng currentUser
                currentUser = {
                    username: newUsername,
                    name: newName,
                    avatarUrl: newAvatarUrl,
                    createdAt: new Date().toISOString(),
                    lastLoginAt: new Date().toISOString()
                };
                
                // 5. L∆∞u user m·ªõi v√†o localStorage
				localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // 6. C·∫≠p nh·∫≠t giao di·ªán (header/modal) v·ªõi t√™n m·ªõi
                updateUserProfile();
            }
        }

        function updateUserProfile() {
            if (currentUser) {
                // Gi·ªØ nguy√™n vi·ªác c·∫≠p nh·∫≠t avatar
                document.querySelector('img[alt="Avatar"]').src = currentUser.avatarUrl;
                // S·ª≠ d·ª•ng ID m·ªõi ƒë·ªÉ ch·ªâ c·∫≠p nh·∫≠t t√™n ng∆∞·ªùi d√πng
                document.getElementById('userNameDisplay').textContent = currentUser.name;
            }
        }

        function showLoadingState() {
            // Show skeleton loading for all sections
            document.querySelectorAll('.skeleton').forEach(el => {
                el.style.display = 'block';
            });
        }

        function hideLoadingState() {
            // Hide skeleton loading
            document.querySelectorAll('.skeleton').forEach(el => {
                el.style.display = 'none';
            });
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', async function() {
            await initializeApp();
            // 1. Thi·∫øt l·∫≠p m·ªôt b·ªô ƒë·∫øm th·ªùi gian, c·ª© m·ªói 15 gi√¢y s·∫Ω g·ªçi h√†m saveLogsBatch m·ªôt l·∫ßn
            setInterval(saveLogsBatch, 15000);
            
            // 2. L·∫Øng nghe s·ª± ki·ªán khi ng∆∞·ªùi d√πng ƒë√≥ng tab, chuy·ªÉn tab ho·∫∑c ·∫©n tr√¨nh duy·ªát
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'hidden') {
                    // N·∫øu c√≥ log ƒëang ch·ªù, th·ª±c hi·ªán l∆∞u ngay l·∫≠p t·ª©c
                    if (logQueue.length > 0) {
                        saveLogsBatch();
                    }
                }
            });
            
            // 3. X·ª≠ l√Ω khi k·∫øt n·ªëi m·∫°ng ƒë∆∞·ª£c ph·ª•c h·ªìi
            window.addEventListener('online', () => {
                isOnline = true;
                updateOnlineStatus();
                // Ngay khi c√≥ m·∫°ng, th·ª≠ l∆∞u ngay c√°c log ƒëang ch·ªù
                saveLogsBatch(); 
            });
                   
            window.addEventListener('offline', () => {
                isOnline = false;
                updateOnlineStatus();
            });

            // T·ª± ƒë·ªông ƒë√≥ng menu khi ng∆∞·ªùi d√πng cu·ªôn trang
            document.addEventListener('scroll', function() {
                const menuIcons = document.getElementById('headerMenuIcons');
                // Ch·ªâ ƒë√≥ng n·∫øu menu ƒëang ƒë∆∞·ª£c hi·ªÉn th·ªã
                if (menuIcons.classList.contains('show')) {
                    closeHeaderMenu();
                }
            });
  
            // Update view button on window resize
            window.addEventListener('resize', updateViewToggleButton);
        });

        async function initializeApp() {
            // Load saved theme
            const savedTheme = localStorage.getItem('loveStoryTheme') || 'default';
            
            // Apply theme to body
            document.body.className = document.body.className.replace(/theme-\w+/g, '');
            if (savedTheme !== 'default') {
                document.body.classList.add(`theme-${savedTheme}`);
            }
            
            // Update radio button selection
            document.querySelector(`.theme-radio-${savedTheme}`).classList.add('selected');
			
			const savedMenuMode = localStorage.getItem('loveStoryMenuMode') || 'horizontal';
            isVerticalMenu = (savedMenuMode === 'vertical');
            document.getElementById('verticalMenuToggle').checked = isVerticalMenu;
			
			loadReadTimestamps();
            
            // Load hamburger menu setting
            const showHamburger = localStorage.getItem('showHamburgerMenu');
            if (showHamburger === 'false') {
                document.getElementById('showHamburgerMenu').checked = false;
                document.getElementById('rightMenuBtn').style.display = 'none';
            } else {
                document.getElementById('showHamburgerMenu').checked = true;
                document.getElementById('rightMenuBtn').style.display = 'flex';
            }
            
            // Initialize view toggle button
            updateViewToggleButton();
			//if (isPhotoGrouped) 
				//document.getElementById('photoGroupToggle').classList.add('active');
            // --- GIAI ƒêO·∫†N 1: T·∫¢I D·ªÆ LI·ªÜU I·ªÇN TH·ªä HOME ---
            const coreDataLoaded = await loadCoreData(); // Ch·ªù d·ªØ li·ªáu Home
            
            if (coreDataLoaded) {
                // T·∫£i c√†i ƒë·∫∑t th√¥ng b√°o (t·ª´ config)
                document.getElementById('enableSystemNotifications').checked = config.ENABLE_NOTI;

				await loadLayoutConfig(); // T·∫£i b·ªë c·ª•c t√πy ch·ªânh
				
                // **Render ngay l·∫≠p t·ª©c c√°c th√†nh ph·∫ßn c·ªßa Home**
                updateStats();           // Home
                loadTodayMemories();     // Home
                loadUpcomingEvents();    // Home
				loadGoldPrice();         // gold
                
                // Render c√°c th√¥ng tin h·ªá th·ªëng c∆° b·∫£n
                updateOnlineStatus();
                updateSyncStatus();
                await updateStorageUsageDisplay();
            }
            
            // ·∫®n skeleton v√† hi·ªÉn th·ªã trang ch·ªß
            hideLoadingState();
            updateNavigation('home');
            showSection('home'); // ƒê·∫£m b·∫£o Trang ch·ªß lu√¥n hi·ªÉn th·ªã ƒë·∫ßu ti√™n

            // --- GIAI ƒêO·∫†N 2: T·∫¢I NG·∫¶M D·ªÆ LI·ªÜU PH·ª§ V√Ä RENDER C√ÅC TAB KH√ÅC ---
            // Ch√∫ng ta d√πng .then() ƒë·ªÉ h√†m n√†y ch·∫°y ng·∫ßm m√† kh√¥ng block UI
            loadSecondaryData().then((secondaryDataLoaded) => {
                if (secondaryDataLoaded) {
                    console.log("ƒê√£ t·∫£i xong d·ªØ li·ªáu ph·ª• (comments, logs).");
                    
                    // **Render c√°c tab c√≤n l·∫°i sau khi c√≥ ƒë·ªß d·ªØ li·ªáu**
                    loadAppConfigToUI(); // Settings (c·∫ßn logsData)
                    loadTimeline();      // Timeline (c·∫ßn commentsData)
                    loadPhotos();        // Photos (c·∫ßn commentsData)
                    updateTotalLogs();   // Settings (c·∫ßn logsData)
					initialLogsLoaded = true; // <-- B·∫¨T C·ªú
					updateNotificationBadge();
                    
                    // C·∫≠p nh·∫≠t l·∫°i UI n·∫øu ng∆∞·ªùi d√πng ƒë√£ chuy·ªÉn tab trong l√∫c ch·ªù
                    if (currentSection === 'photos') {
                         loadPhotos(currentPage);
                    }
                    if (currentSection === 'timeline') {
                         loadTimeline();
                    }
                }
            });
            
            // Set initial AI mode button active
            switchAiModel(currentAiModel);
        }


        function checkAutoSync() {
            // 1. L·∫•y c·∫•u h√¨nh (Gi·ªØ nguy√™n)
            const syncConfig = config.AUTO_SYNC_METADATA;
            if (!syncConfig.enabled) {
                console.log('[Auto Sync] T·ª± ƒë·ªông ƒë·ªìng b·ªô ƒë√£ b·ªã t·∫Øt.');
                return;
            }

            const now = new Date();
            // L·∫•y chu·ªói ng√†y h√¥m nay, v√≠ d·ª•: "2025-10-30"
            const todayStr = now.toISOString().split('T')[0];

            // --- 2. LOGIC KH√ìA (LOCKING) ---
            // 'lastAutoSync_CheckDay' l∆∞u ng√†y cu·ªëi c√πng m√† B·∫§T K·ª≤ client n√†o ƒë√£ ch·∫°y h√†m n√†y.
            const lastCheckDay = localStorage.getItem('lastAutoSync_CheckDay');

            if (lastCheckDay === todayStr) {
                // M·ªôt client kh√°c ƒë√£ ch·∫°y ki·ªÉm tra cho ng√†y h√¥m nay.
                // Client n√†y kh√¥ng c·∫ßn l√†m g√¨ c·∫£.
                // console.log(`[Auto Sync] Check for ${todayStr} already performed by another client.`);
                return; // D·ª´ng l·∫°i
            }

            // --- 3. Y√äU C·∫¶U QUY·ªÄN KI·ªÇM TRA (CLAIM CHECK) ---
            // Client n√†y l√† client ƒë·∫ßu ti√™n trong ng√†y.
            // N√≥ "ƒë√≥ng d·∫•u" ngay l·∫≠p t·ª©c ƒë·ªÉ c√°c client kh√°c (m·ªü sau 1-2 gi√¢y) s·∫Ω d·ª´ng l·∫°i ·ªü b∆∞·ªõc 2.
            console.log(`[Auto Sync] This client is performing the check for ${todayStr}.`);
            localStorage.setItem('lastAutoSync_CheckDay', todayStr);

            // --- 4. LOGIC ƒê·ªíNG B·ªò G·ªêC (Ch·ªâ ch·∫°y tr√™n client n√†y) ---
            
            // 'lastAutoSync_SuccessTimestamp' l∆∞u th·ªùi ƒëi·ªÉm ƒê·ªíNG B·ªò TH√ÄNH C√îNG l·∫ßn cu·ªëi.
            const lastSyncTimestampStr = localStorage.getItem('lastAutoSync_SuccessTimestamp');
            const lastSyncTimestamp = lastSyncTimestampStr ? parseInt(lastSyncTimestampStr, 10) : 0;
            const lastSyncDate = new Date(lastSyncTimestamp);

            // L·∫•y th·ªùi gian m·ª•c ti√™u (v√≠ d·ª•: 09:04)
            const [hours, minutes] = syncConfig.time.split(':').map(Number);
            const targetTimeToday = new Date();
            targetTimeToday.setHours(hours, minutes, 0, 0);

            // T√≠nh to√°n th·ªùi ƒëi·ªÉm h·ª£p l·ªá ti·∫øp theo (Logic g·ªëc c·ªßa b·∫°n)
            let nextValidSyncTime = new Date(lastSyncTimestamp);
            
            switch (syncConfig.frequency) {
                case 'daily':
                    if (lastSyncDate.getDate() < now.getDate() || lastSyncDate.getMonth() < now.getMonth() || lastSyncDate.getFullYear() < now.getFullYear()) {
                        nextValidSyncTime = targetTimeToday;
                    } else {
                        nextValidSyncTime = new Date(targetTimeToday.getTime() + 24 * 60 * 60 * 1000);
                    }
                    break;
                case 'weekly':
                    nextValidSyncTime.setDate(lastSyncDate.getDate() + 7);
                    nextValidSyncTime.setHours(hours, minutes, 0, 0);
                    break;
                case 'monthly':
                    nextValidSyncTime.setMonth(lastSyncDate.getMonth() + 1);
                    nextValidSyncTime.setHours(hours, minutes, 0, 0);
                    break;
                case 'once':
                    if (lastSyncTimestamp > 0) {
                        console.log('[Auto Sync] ƒê√£ ch·∫°y ƒë·ªìng b·ªô 1 l·∫ßn, s·∫Ω kh√¥ng ch·∫°y l·∫°i.');
                        return; // ƒê√£ ch·∫°y 1 l·∫ßn, d·ª´ng l·∫°i
                    }
                    nextValidSyncTime = targetTimeToday;
                    break;
                default:
                    return; // T·∫ßn su·∫•t kh√¥ng h·ª£p l·ªá
            }
            
            // 5. Ki·ªÉm tra v√† th·ª±c hi·ªán ƒë·ªìng b·ªô
            if (now >= nextValidSyncTime) {
                console.log(`[Auto Sync] ƒêang th·ª±c hi·ªán ƒë·ªìng b·ªô theo l·ªãch "${syncConfig.frequency}" l√∫c ${now.toLocaleTimeString()}`);
                
                // G·ªçi h√†m ƒë·ªìng b·ªô (Gi·ªØ nguy√™n)
                syncPhotosMetadata(false); // false = kh√¥ng ph·∫£i th·ªß c√¥ng
                
                // QUAN TR·ªåNG: C·∫≠p nh·∫≠t l·∫°i th·ªùi ƒëi·ªÉm TH√ÄNH C√îNG
                localStorage.setItem('lastAutoSync_SuccessTimestamp', now.getTime().toString());
                
                showNotification(`T·ª± ƒë·ªông ƒë·ªìng b·ªô ƒë√£ ch·∫°y theo l·ªãch`, 'info');
                addLog('T·ª± ƒë·ªông ƒë·ªìng b·ªô', `ƒê√£ ch·∫°y t·ª± ƒë·ªông ƒë·ªìng b·ªô theo l·ªãch ${syncConfig.frequency}`);
            } else {
                console.log(`[Auto Sync] Check complete. Ch∆∞a ƒë·∫øn gi·ªù. L·∫ßn ti·∫øp theo d·ª± ki·∫øn: ${nextValidSyncTime.toLocaleString()}`);
            }
        }

        // Navigation functions
        function showSection(section) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            
            // Show selected section
            document.getElementById(section + 'Section').classList.remove('hidden');
            
            // Update navigation
            updateNavigation(section);
            
            // Log navigation activity
            const sectionNames = {
                'home': 'Trang ch·ªß',
                'chat': 'Chat AI',
                'timeline': 'Timeline',
                'photos': 'Kho·∫£nh kh·∫Øc',
                'settings': 'C√†i ƒë·∫∑t'
            };
            
            if (currentSection !== section) {
                addLog('ƒêi·ªÅu h∆∞·ªõng', `Chuy·ªÉn t·ª´ "${sectionNames[currentSection] || currentSection}" sang "${sectionNames[section]}"`);
            }
            
            currentSection = section;
        }
 
        function toggleHeaderMenu() {
            const menuIcons = document.getElementById('headerMenuIcons');
            const title = document.getElementById('headerTitle');
            const isCurrentlyHidden = menuIcons.classList.contains('hidden');

            if (isVerticalMenu) {
                // --- LOGIC D·ªåC (DROPDOWN) ---
                if (isCurrentlyHidden) {
                    // --- B·∫Øt ƒë·∫ßu s·ª≠a ---
                    // 1. L·∫•y n√∫t hamburger
                    const btn = document.getElementById('rightMenuBtn');
                    // 2. L·∫•y t·ªça ƒë·ªô (v·ªã tr√≠) c·ªßa n√∫t
                    const rect = btn.getBoundingClientRect(); 
                    
                    // 3. Hi·ªÉn th·ªã menu (nh∆∞ng ch∆∞a ƒë·ªãnh v·ªã)
                    menuIcons.classList.remove('hidden');
                    menuIcons.classList.add('vertical-dropdown'); 
                    
                    // 4. L·∫•y chi·ªÅu r·ªông c·ªßa menu (SAU KHI N√ì HI·ªÇN TH·ªä)
                    const menuWidth = menuIcons.offsetWidth;

                    // 5. T√≠nh to√°n v·ªã tr√≠
                    // T√¨m t√¢m c·ªßa n√∫t
                    const buttonCenter = rect.left + (rect.width / 2);
                    // L√πi l·∫°i m·ªôt n·ª≠a chi·ªÅu r·ªông menu
                    const newLeft = buttonCenter - (menuWidth / 2);
                    
                    // 6. CƒÉn l·ªÅ
                    menuIcons.style.left = newLeft + 'px';
                    // 7. Ghi ƒë√® 'right' (n·∫øu c√≥)
                    menuIcons.style.right = 'auto'; 
                    // --- K·∫øt th√∫c s·ª≠a ---
                } else {
                    // ƒê√≥ng menu
                    menuIcons.classList.add('hidden');
                    menuIcons.classList.remove('vertical-dropdown');
                    // Reset style
                    menuIcons.style.left = '';
                    menuIcons.style.right = '';
                }
            } else {
                // --- LOGIC NGANG (GI·ªÆ NGUY√äN) ---
                if (isCurrentlyHidden) {
                    title.classList.add('hidden');
                    menuIcons.classList.remove('hidden');
                    setTimeout(() => menuIcons.classList.remove('opacity-0'), 10);
                } else {
                    menuIcons.classList.add('opacity-0');
                    setTimeout(() => {
                        menuIcons.classList.add('hidden');
                        title.classList.remove('hidden');
                    }, 300);
                }
            }
        }

        function openHeaderMenu() {
            // (H√†m n√†y kh√¥ng c·∫ßn thi·∫øt, ƒë√£ g·ªôp v√†o toggleHeaderMenu)
        }

        function closeHeaderMenu() {
            const menuIcons = document.getElementById('headerMenuIcons');
            const title = document.getElementById('headerTitle');
            
            if (isVerticalMenu) {
                // --- LOGIC D·ªåC (ƒê√ìNG) ---
                menuIcons.classList.add('hidden');
                menuIcons.classList.remove('vertical-dropdown');
                // Reset style
                menuIcons.style.left = '';
                menuIcons.style.right = '';
            } else {
                // --- LOGIC NGANG (ƒê√ìNG) ---
                if (menuIcons.classList.contains('hidden')) return; // ƒê√£ ƒë√≥ng r·ªìi th√¨ th√¥i
                
                menuIcons.classList.add('opacity-0');
                setTimeout(() => {
                    menuIcons.classList.add('hidden');
                    title.classList.remove('hidden');
                }, 300);
            }
        }

        function toggleRightHeaderMenu() {
            toggleHeaderMenu();
        }

        function selectMenuItem(section) {
            showSection(section);
        }

        function updateNavigation(activeSection) {
            // Update header menu navigation
            document.querySelectorAll('.menu-icon').forEach(item => {
                item.classList.remove('active');
            });
            
            const activeItem = document.querySelector(`[data-section="${activeSection}"]`);
            if (activeItem) {
                activeItem.classList.add('active');
            }
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }
		 
        function openPhotoSelector() {
			// 1. Ki·ªÉm tra n·∫øu kh√¥ng c√≥ ·∫£nh (logic t·ª´ new4.html)
			if (photosData.length === 0) {
				// S·ª≠ d·ª•ng h√†m th√¥ng b√°o c·ªßa new5.html
				showNotification('Kh√¥ng c√≥ ·∫£nh n√†o ƒë·ªÉ ch·ªçn', 'info');
				return;
			}
			
			const modalId = 'imageSelectorModal'; // ID modal trong new5.html
			
			// 2. M·ªü modal (logic t·ª´ new5.html)
			document.getElementById(modalId).classList.add('show');
			
			// 3. (T·ª™ NEW4.HTML) C·∫≠p nh·∫≠t n√∫t view 
			const btn = document.getElementById('view-toggle-btn');
			const config = viewConfig[photoSelectorViewMode];
			if (btn) { // Ki·ªÉm tra n√∫t t·ªìn t·∫°i
				btn.innerHTML = `<i class="${config.icon} mr-2"></i>${config.text}`;
			}
			
			// 4. T·∫£i ·∫£nh trang 1 (logic t·ª´ new4.html)
			photoSelectorPage = 1; 
			renderPhotoSelector();
			
			// 5. Ghi log (logic t·ª´ new5.html)
			addLog('M·ªü modal', `ƒê√£ m·ªü "Ch·ªçn ·∫£nh"`);
		}

        // Theme functions
        function changeTheme() {
            const theme = document.getElementById('themeSelect').value;
            document.body.className = document.body.className.replace(/theme-\w+/g, '');
            
            if (theme !== 'default') {
                document.body.classList.add(`theme-${theme}`);
            }
            
            localStorage.setItem('loveStoryTheme', theme);
            addLog('Thay ƒë·ªïi theme', `ƒê√£ chuy·ªÉn sang theme "${document.getElementById('themeSelect').selectedOptions[0].text}"`);
        }

        function changeThemeRadio(theme) {
            // Update body classes
            document.body.className = document.body.className.replace(/theme-\w+/g, '');
            
            if (theme !== 'default') {
                document.body.classList.add(`theme-${theme}`);
            }
            
            // Update radio button selection
            document.querySelectorAll('[class*="theme-radio-"]').forEach(radio => {
                radio.classList.remove('selected');
            });
            document.querySelector(`.theme-radio-${theme}`).classList.add('selected');
            
            // Save to localStorage
            localStorage.setItem('loveStoryTheme', theme);
            
            // Get theme name for log
            const themeNames = {
                'default': 'M·∫∑c ƒë·ªãnh',
                'spring': 'M√πa Xu√¢n', 
                'summer': 'M√πa H√®',
                'night': 'Ban ƒê√™m',
                'romantic': 'L√£ng M·∫°n',
                'ocean': 'ƒê·∫°i D∆∞∆°ng'
            };
            
            addLog('Thay ƒë·ªïi theme', `ƒê√£ chuy·ªÉn sang theme "${themeNames[theme]}"`);
            showNotification(`ƒê√£ chuy·ªÉn sang theme ${themeNames[theme]}!`, 'success');
        }

        // Hamburger menu toggle function
        function toggleHamburgerMenu() {
            const checkbox = document.getElementById('showHamburgerMenu');
            const hamburgerBtn = document.getElementById('rightMenuBtn');
            const isEnabled = checkbox.checked;
            
            if (isEnabled) {
                hamburgerBtn.style.display = 'flex';
                localStorage.setItem('showHamburgerMenu', 'true');
                addLog('C√†i ƒë·∫∑t giao di·ªán', 'ƒê√£ b·∫≠t n√∫t menu hamburger');
            } else {
                hamburgerBtn.style.display = 'none';
                // ƒê√≥ng menu n·∫øu ƒëang m·ªü
                closeHeaderMenu();
                localStorage.setItem('showHamburgerMenu', 'false');
                addLog('C√†i ƒë·∫∑t giao di·ªán', 'ƒê√£ ·∫©n n√∫t menu hamburger');
            }
            
            showNotification(isEnabled ? 'ƒê√£ b·∫≠t menu!' : 'ƒê√£ ·∫©n menu!', 'success');
        }
		
		// H√ÄM M·ªöI: T·∫Øt/B·∫≠t Th√¥ng B√°o H·ªá Th·ªëng  
        async function toggleSystemNotifications() {
            const isEnabled = document.getElementById('enableSystemNotifications').checked;
            
            if (!isEnabled) {
                // C·∫≠p nh·∫≠t appConfigData TR∆Ø·ªöC khi hi·ªÉn th·ªã th√¥ng b√°o cu·ªëi
                config.ENABLE_NOTI = false;
                showNotification('ƒê√£ t·∫Øt th√¥ng b√°o h·ªá th·ªëng!', 'info');
            } else {
                config.ENABLE_NOTI = true;
            }
            
            const logMessage = isEnabled ? 'ƒê√£ b·∫≠t th√¥ng b√°o h·ªá th·ªëng' : 'ƒê√£ t·∫Øt th√¥ng b√°o h·ªá th·ªëng';
            addLog('C√†i ƒë·∫∑t giao di·ªán', logMessage);
            
            try {
                // G·ªçi API ƒë·ªÉ l∆∞u file configApp.json
                const success = await githubAPI.updateFile(
                    config.CONFIG_FILE_PATH,
                    appConfigData, // L∆∞u to√†n b·ªô ƒë·ªëi t∆∞·ª£ng appConfigData
                    `C·∫≠p nh·∫≠t th√¥ng b√°o h·ªá th·ªëng: ${isEnabled ? 'B·∫≠t' : 'T·∫Øt'}`
                );
                
                if (success) {
                    if (isEnabled) {
                        // Ch·ªâ hi·ªÉn th·ªã th√¥ng b√°o B·∫¨T sau khi ƒë√£ l∆∞u th√†nh c√¥ng
                        showNotification('ƒê√£ b·∫≠t v√† l∆∞u th√¥ng b√°o h·ªá th·ªëng!', 'success');
                    }
                } else {
                    // N·∫øu l∆∞u th·∫•t b·∫°i, ƒë·∫£o ng∆∞·ª£c l·∫°i tr·∫°ng th√°i
                    config.ENABLE_NOTI = !isEnabled; 
                    document.getElementById('enableSystemNotifications').checked = !isEnabled;
                    showNotification('L·ªói khi l∆∞u c√†i ƒë·∫∑t!', 'error');
                }
            } catch (error) {
                console.error('Error saving notification config:', error);
                // ƒê·∫£o ng∆∞·ª£c tr·∫°ng th√°i n·∫øu c√≥ l·ªói
                config.ENABLE_NOTI = !isEnabled;
                document.getElementById('enableSystemNotifications').checked = !isEnabled;
                showNotification('L·ªói khi l∆∞u c√†i ƒë·∫∑t!', 'error');
            }
        }
 
		function toggleVerticalMenu() {
            const checkbox = document.getElementById('verticalMenuToggle');
            isVerticalMenu = checkbox.checked;
            
            if (isVerticalMenu) {
                localStorage.setItem('loveStoryMenuMode', 'vertical');
                showNotification('ƒê√£ b·∫≠t menu d·∫°ng d·ªçc!', 'success');
            } else {
                localStorage.setItem('loveStoryMenuMode', 'horizontal');
                showNotification('ƒê√£ b·∫≠t menu d·∫°ng ngang!', 'success');
            }
            addLog('C√†i ƒë·∫∑t giao di·ªán', `Chuy·ªÉn menu sang d·∫°ng ${isVerticalMenu ? 'd·ªçc' : 'ngang'}`);
        }
		
        // Stats functions
        function updateStats() {
            // ƒê·ªçc d·ªØ li·ªáu ƒë√£ t√≠nh to√°n s·∫µn t·ª´ homeData
            const daysEl = document.getElementById('daysTogether');
            if (daysEl) daysEl.textContent = (homeData.daysTogether || 0).toLocaleString();

            const memEl = document.getElementById('totalMemories');
            if (memEl) memEl.textContent = (homeData.totalMemories || 0).toLocaleString();

            const photoEl = document.getElementById('totalPhotos');
            if (photoEl) photoEl.textContent = (homeData.totalPhotos || 0).toLocaleString();
        }
		
		

        function convertDateFormat(dateStr) {
            // Convert DD-MM-YYYY to YYYY-MM-DD
            const parts = dateStr.split('-');
            return `${parts[2]}-${parts[1]}-${parts[0]}`;
        }

        function loadTodayMemories() {
            const container = document.getElementById('todayMemories');
            const today = new Date(); // V·∫´n c·∫ßn ƒë·ªÉ t√≠nh "s·ªë nƒÉm tr∆∞·ªõc"

            // ƒê·ªçc d·ªØ li·ªáu ƒë√£ t√≠nh to√°n s·∫µn
            todayValidMemories = homeData.todayMemories || [];

            if (todayValidMemories.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-calendar-times text-4xl mb-3"></i>
                        <p>Kh√¥ng c√≥ k·ª∑ ni·ªám n√†o v√†o ng√†y h√¥m nay</p>
                    </div>
                `;
                return;
            }
            
            // Logic hi·ªÉn th·ªã HTML gi·ªØ nguy√™n, ch·ªâ d√πng d·ªØ li·ªáu ƒë√£ l·ªçc s·∫µn
            container.innerHTML = todayValidMemories.map((event, index) => {
                const eventDate = new Date(convertDateFormat(event.day));
                const yearsAgo = today.getFullYear() - eventDate.getFullYear();
                
                const eventIdForScroll = event.note_id || event.day; 
                let cardClass = 'love-card rounded-lg p-4 mb-3 cursor-pointer';
                let badgeClass = '';

                if (index === 0) {
                    badgeClass = 'bg-secondary text-white';
                } else {
                    badgeClass = 'bg-primary text-white';
                    cardClass += ' opacity-90';
                }
               
                return `
                    <div class="${cardClass}" onclick="scrollToEvent('${eventIdForScroll}')">
                        <div class="flex items-center space-x-3 mb-2">
                            <span class="${badgeClass} px-3 py-1 rounded-full text-sm font-medium"><i class="fa-regular fa-clock"></i> ${yearsAgo} nƒÉm tr∆∞·ªõc</span>
                            <span class="text-custom opacity-70 text-sm"> <i class="fa-regular fa-calendar"></i> ${formatDateToDDMMYYYY(event.day)}</span>
                        </div>
                        <h4 class="font-bold text-primary text-lg flex items-center">
                            ${escapeHtml(event.name)}
                        </h4>
                    </div>
                `;
            }).join('');
        }
		 
        /**
         * X·ª≠ l√Ω khi b·∫•m n√∫t next/prev c·ªßa "Ng√†y N√†y NƒÉm X∆∞a"
         * @param {number} direction -1 (prev) ho·∫∑c 1 (next)
         */
        function navigateMemory(direction) {
            if (todayValidMemories.length === 0) return;

            // C·∫≠p nh·∫≠t v·ªã tr√≠
            currentMemoryIndex += direction;

            // X·ª≠ l√Ω xoay v√≤ng (wrap-around)
            if (currentMemoryIndex >= todayValidMemories.length) {
                currentMemoryIndex = 0; // Quay v·ªÅ ƒë·∫ßu
            } else if (currentMemoryIndex < 0) {
                currentMemoryIndex = todayValidMemories.length - 1; // ƒêi ƒë·∫øn cu·ªëi
            }
  
        }

        function formatDateFromDDMMYYYY(dateStr) {
            const parts = dateStr.split('-');
            const date = new Date(parts[2], parts[1] - 1, parts[0]);
            return date.toLocaleDateString('vi-VN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function formatDateToDDMMYYYY(dateStr) {
            // Convert DD-MM-YYYY to DD/MM/YYYY format
            return dateStr.replace(/-/g, '/');
        }

        function formatDateToDDMMYYHHMMSS(dateString) {
            if (!dateString) return '';
            
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return dateString;
                
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = String(date.getFullYear()).slice(-2);
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const seconds = String(date.getSeconds()).padStart(2, '0');
                
                return `${day}-${month}-${year} ${hours}:${minutes}:${seconds}`;
            } catch (error) {
                return dateString;
            }
        }

        function loadUpcomingEvents() {
            const container = document.getElementById('upcomingEventsContainer');
            
            // ƒê·ªçc d·ªØ li·ªáu ƒë√£ t√≠nh to√°n s·∫µn
            const nextEvent = homeData.upcomingEvent;
            upcomingEventInfo = nextEvent; // C·∫≠p nh·∫≠t bi·∫øn to√†n c·ª•c
			
            if (!nextEvent || nextEvent.diff <= 0) {
                container.innerHTML = `
                    <div>
                        <p class="text-sm text-gray-500">S·ª± Ki·ªán S·∫Øp T·ªõi</p>
                        <p class="text-xl font-bold text-primary">Kh√¥ng c√≥</p>
                    </div>
                `;
                return;
            }

            // Hi·ªÉn th·ªã th√¥ng tin
            container.innerHTML = `
                <div class="flex items-baseline space-x-2">
                    <p class="text-2xl font-bold text-primary">${nextEvent.diff}</p>
                    <p class="text-sm font-medium text-gray-600">ng√†y n·ªØa</p>
                </div>
                <p class="text-sm text-gray-500">${escapeHtml(nextEvent.name)}</p>
            `;
        }
		
		function loadGoldPrice() {
            const buyPriceEl = document.getElementById('goldBuyPrice');
            const sellPriceEl = document.getElementById('goldSellPrice');

            // ƒê·ªçc d·ªØ li·ªáu ƒë√£ t√≠nh to√°n s·∫µn
            const price = homeData.goldPrice;

            if (price && price.buy > 0) {
                buyPriceEl.textContent = price.buy.toLocaleString('vi-VN');
                sellPriceEl.textContent = price.sell.toLocaleString('vi-VN');
            } else {
                buyPriceEl.textContent = 'N/A';
                sellPriceEl.textContent = 'N/A';
            }
        }
 
		
		function scrollToEvent(eventId) {
            // 1. Chuy·ªÉn sang tab Timeline
            showSection('timeline');
            
            // 2. T√¨m ph·∫ßn t·ª≠
            const element = document.getElementById(`event-item-${eventId}`);
            
            if (element) {
                // 3. Scroll t·ªõi ph·∫ßn t·ª≠
                element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // 4. (T√πy ch·ªçn) Th√™m hi·ªáu ·ª©ng highlight
                element.style.transition = 'all 0.3s ease';
                element.style.transform = 'scale(1.02)';
                element.style.boxShadow = '0 0 15px var(--secondary-color)';
                
                setTimeout(() => {
                    element.style.transform = 'scale(1)';
                    element.style.boxShadow = '';
                }, 1500); // Gi·ªØ highlight trong 1.5 gi√¢y
            } else {
                console.warn(`Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ event-item-${eventId} ƒë·ªÉ scroll t·ªõi.`);
            }
        }
		/**
         * T·∫£i danh s√°ch Lo·∫°i s·ª± ki·ªán (t·ª´ d·ªØ li·ªáu) v√†o datalist
         */
        function loadCategoryDatalist() {
            // 1. L·∫•y t·∫•t c·∫£ category t√πy ch·ªânh t·ª´ eventsData
            const customCategories = eventsData.map(e => e.category).filter(Boolean);
            
            // 2. G·ªôp danh s√°ch (d√πng Set ƒë·ªÉ lo·∫°i b·ªè tr√πng l·∫∑p)
            allCategories = [...new Set([...predefinedCategories, ...customCategories])].sort();

            // 3. ƒê·∫©y v√†o datalist c·ªßa Modal
            const datalist = document.getElementById('categoryDatalist');
            datalist.innerHTML = allCategories.map(cat => `<option value="${escapeHtml(cat)}"></option>`).join('');
        }
        
        /**
         * M·ªü/ƒê√≥ng Dropdown L·ªçc
         */
        function toggleFilterDropdown() {
            const dropdown = document.getElementById('filterDropdown');
            const isHidden = dropdown.classList.toggle('hidden');
            
            if (!isHidden) {
                // M·ªü dropdown
                loadCategoryDatalist(); // C·∫≠p nh·∫≠t danh s√°ch lo·∫°i
                
                const container = document.getElementById('filterDropdownList');
                if (allCategories.length === 0) {
                     container.innerHTML = `<p class="text-gray-500 text-center text-sm p-2">Kh√¥ng c√≥ lo·∫°i s·ª± ki·ªán n√†o.</p>`;
                } else {
                    container.innerHTML = allCategories.map(cat => {
                        const isChecked = currentEventFilter.includes(cat) ? 'checked' : '';
                        
                        // Quan tr·ªçng: G·ªçi applyInstantFilter() ngay khi 'onchange'
                        return `
                            <label class="filter-checkbox-label">
                                <input type="checkbox" onchange="applyInstantFilter(this)" value="${escapeHtml(cat)}" ${isChecked}>
                                <span>${escapeHtml(cat)}</span>
                            </label>
                        `;
                    }).join('');
                }
                addLog('M·ªü modal', 'M·ªü b·ªô l·ªçc s·ª± ki·ªán (dropdown)');
            }
        }

        /**
         * √Åp d·ª•ng b·ªô l·ªçc ngay l·∫≠p t·ª©c khi check
         */
        function applyInstantFilter(checkbox) {
            const category = checkbox.value;
            if (checkbox.checked) {
                // Th√™m v√†o b·ªô l·ªçc
                if (!currentEventFilter.includes(category)) {
                    currentEventFilter.push(category);
                }
            } else {
                // X√≥a kh·ªèi b·ªô l·ªçc
                currentEventFilter = currentEventFilter.filter(c => c !== category);
            }
            
            // T·∫£i l·∫°i timeline ngay l·∫≠p t·ª©c
            loadTimeline();
            addLog('L·ªçc s·ª± ki·ªán', `ƒê√£ (b·ªè) ch·ªçn l·ªçc: ${category}`);
        }
        
        /**
         * X√≥a b·ªô l·ªçc (cho dropdown)
         */
        function clearEventFilter() {
            currentEventFilter = [];
            // B·ªè check t·∫•t c·∫£ checkbox trong dropdown
            document.querySelectorAll('#filterDropdownList input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            loadTimeline(); // T·∫£i l·∫°i Timeline (kh√¥ng l·ªçc)
            addLog('L·ªçc s·ª± ki·ªán', 'ƒê√£ x√≥a b·ªô l·ªçc');
        }

        /**
         * Chuy·ªÉn ƒë·ªïi ch·∫ø ƒë·ªô xem (List / Group)
         */
        function toggleTimelineView() {
            isTimelineGrouped = !isTimelineGrouped;
            const btn = document.getElementById('timelineViewToggle');
            const icon = btn.querySelector('i');

            if (isTimelineGrouped) {
                icon.className = 'fas fa-layer-group';
                btn.title = "Xem d·∫°ng danh s√°ch";
                addLog('Ch·∫ø ƒë·ªô xem', 'ƒê·ªïi sang xem nh√≥m (S·ª± ki·ªán)');
            } else {
                icon.className = 'fas fa-list';
                btn.title = "Xem d·∫°ng nh√≥m";
                addLog('Ch·∫ø ƒë·ªô xem', 'ƒê·ªïi sang xem danh s√°ch (S·ª± ki·ªán)');
            }
            
            loadTimeline(); // T·∫£i l·∫°i Timeline
        }

        /**
         * H√ÄM QUAN TR·ªåNG: T·∫¢I L·∫†I TIMELINE (ƒê√É VI·∫æT L·∫†I HO√ÄN TO√ÄN)
         */
        function loadTimeline() {
            const container = document.getElementById('timelineContainer');
            
            // 0. C·∫≠p nh·∫≠t danh s√°ch lo·∫°i s·ª± ki·ªán (cho modal th√™m/s·ª≠a)
            loadCategoryDatalist();

            // 1. L·ªçc d·ªØ li·ªáu
            let filteredEvents = [];
            if (currentEventFilter.length === 0) {
                filteredEvents = [...eventsData]; // Kh√¥ng l·ªçc
            } else {
                filteredEvents = eventsData.filter(event => 
                    currentEventFilter.includes(event.category)
                );
            }
            
            // 2. S·∫Øp x·∫øp (m·ªõi nh·∫•t tr∆∞·ªõc)
            const sortedEvents = filteredEvents.sort((a, b) => 
                new Date(convertDateFormat(b.day)) - new Date(convertDateFormat(a.day))
            );

            // 3. Hi·ªÉn th·ªã (theo ch·∫ø ƒë·ªô xem)
            if (isTimelineGrouped) {
                // --- 3a. CH·∫æ ƒê·ªò XEM NH√ìM ---
                const groups = new Map();
                
                // Gom nh√≥m
                for (const event of sortedEvents) {
                    const category = event.category || "Kh√¥ng ph√¢n lo·∫°i";
                    if (!groups.has(category)) {
                        groups.set(category, []);
                    }
                    groups.get(category).push(event);
                }
                
                // S·∫Øp x·∫øp c√°c nh√≥m theo t√™n (ƒë·ªÉ "Kh√¥ng ph√¢n lo·∫°i" ·ªü cu·ªëi)
                const sortedGroups = new Map(
                    [...groups.entries()].sort((a, b) => {
                        if (a[0] === "Kh√¥ng ph√¢n lo·∫°i") return 1;
                        if (b[0] === "Kh√¥ng ph√¢n lo·∫°i") return -1;
                        return a[0].localeCompare(b[0]);
                    })
                );

                container.innerHTML = ''; // X√≥a n·ªôi dung c≈©
                if (sortedGroups.size === 0) {
                    container.innerHTML = `<p class="text-center text-gray-500 py-12">Kh√¥ng t√¨m th·∫•y s·ª± ki·ªán n√†o.</p>`;
                    return;
                }

                sortedGroups.forEach((events, category) => {
                    // Th√™m ti√™u ƒë·ªÅ nh√≥m (Layout m·ªõi)
                    container.innerHTML += `
                        <div class="category-group-header">
                            <div class="header-content">
                                <i class="fas fa-tag"></i> 
                                <span>${escapeHtml(category)}</span>
                            </div>
                            <div class="header-badge">
                                ${events.length} s·ª± ki·ªán
                            </div>
                        </div>
                    `;
                    // Th√™m c√°c s·ª± ki·ªán trong nh√≥m (d√πng h√†m renderEvent)
                    container.innerHTML += events.map(event => renderEventHTML(event)).join('');
                });

            } else {
                // --- 3b. CH·∫æ ƒê·ªò XEM DANH S√ÅCH (M·∫∂C ƒê·ªäNH) ---
                if (sortedEvents.length === 0) {
                    container.innerHTML = `<p class="text-center text-gray-500 py-12">Kh√¥ng t√¨m th·∫•y s·ª± ki·ªán n√†o.</p>`;
                    return;
                }
                container.innerHTML = sortedEvents.map((event, index) => 
                    renderEventHTML(event, sortedEvents.length - index) // Th√™m z-index
                ).join('');
            }
        }

        /**
         * H√†m tr·ª£ gi√∫p m·ªõi: T√°ch logic render 1 s·ª± ki·ªán ra (ƒê√£ c·∫≠p nh·∫≠t √¥ "+")
         */
        function renderEventHTML(event, zIndex = 1) {
            let imagesHTML = '';
            if (event.image && event.image.length > 0) {
                const displayImages = event.image.slice(0, 3);
                
                imagesHTML = `
                    <div class="flex space-x-2 mt-4">
                        ${displayImages.map(imageName => {
                            const photo = findPhotoByName(imageName);
                            if (!photo) return '';
                            const imageUrl = driveAPI.getImageUrl(photo.id, 'thumbnail');
                            return `<img src="${imageUrl}" alt="${imageName}" class="w-16 h-16 rounded object-cover cursor-pointer" 
                                       onclick="viewMediaWithDetails('${photo.id}', '${photo.name}', '${photo.fileType}')"
                                       onerror="this.src=imageErrorPlaceholder; this.style.display='none';">`;
                        }).join('')}
                        
                        ${event.image.length > 3 ? 
                            `<div class="w-16 h-16 rounded bg-gray-200 flex items-center justify-center text-sm font-medium cursor-pointer hover:bg-gray-300" 
                                  onclick="viewEventPhotos('${event.note_id}')"
                                  title="Xem t·∫•t c·∫£ ${event.image.length} ·∫£nh">
                                +${event.image.length - 3}
                             </div>` 
                           : ''}
                        </div>
                `;
            }
            
            const safeName = escapeHtml(event.name || '');
            const safeDescription = escapeHtml(event.contdetl || 'Kh√¥ng c√≥ m√¥ t·∫£');
             
            // Style v√† v·ªã tr√≠ c·ªßa Category
            const categoryHTML = event.category 
                ? `<span class="text-xs text-gray-400 mr-2">${escapeHtml(event.category)}</span>` 
                : '';
             
            return `
                <div class="timeline-item" id="event-item-${event.note_id || event.day}" style="z-index: ${zIndex};">
                    <div class="love-card rounded-lg px-6 py-3">
                        <div class="flex justify-between items-start mb-2">
                            
                            <div class="flex-1 min-w-0"> 
                                <div class="flex justify-between items-baseline">
                                    <h3 class="text-base font-bold text-primary mb-0.5 truncate" style="font-size: 0.9em;">${safeName}</h3>
                                </div>
                                <p class="text-secondary font-medium" style="font-size: 0.9em;">${formatDateToDDMMYYYY(event.day)}</p>
                            </div>
                            
                            <div class="relative ml-4 flex-shrink-0 flex items-center">
                                ${categoryHTML} <div class="relative">
                                    <button class="text-custom hover:text-primary transition-colors duration-200 p-2 rounded-full hover:bg-gray-100" onclick="toggleEventMenu('${event.note_id}')">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <div id="menu-${event.note_id}" class="hidden absolute right-0 top-full mt-1 bg-accent border border-custom rounded-lg shadow-lg z-50 min-w-[150px]">
                                        <button class="w-full text-left px-4 py-2 text-blue-600 hover:bg-blue-50" onclick="editEvent('${event.note_id}'); hideEventMenu('${event.note_id}')">
                                            <i class="fas fa-edit mr-2"></i>Ch·ªânh s·ª≠a
                                        </button>
                                        <button class="w-full text-left px-4 py-2 text-green-600 hover:bg-green-50" onclick="viewEventPhotos('${event.note_id}'); hideEventMenu('${event.note_id}')">
                                            <i class="fas fa-images mr-2"></i>Xem ·∫£nh
                                        </button>
                                        <button class="w-full text-left px-4 py-2 text-red-600 hover:bg-red-50 border-t border-custom" onclick="deleteEvent('${event.note_id}'); hideEventMenu('${event.note_id}')">
                                            <i class="fas fa-trash mr-2"></i>X√≥a
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                        </div>
                        <p class="text-gray-700 whitespace-pre-wrap" style="font-size: 0.9em; line-height: 1.4;">${safeDescription}</p>
                        ${imagesHTML} 
                    </div>
                </div>
            `;
        }
		
        /**
         * B·∫≠t/T·∫Øt ch·∫ø ƒë·ªô xem Nh√≥m (Kho·∫£nh kh·∫Øc)
         */
        function togglePhotoGrouping() {
            isPhotoGrouped = !isPhotoGrouped;
            const btn = document.getElementById('photoGroupToggle');

            if (isPhotoGrouped) {
                btn.classList.add('active'); // L√†m s√°ng n√∫t
                addLog('Ch·∫ø ƒë·ªô xem', 'ƒê·ªïi sang xem nh√≥m (Kho·∫£nh kh·∫Øc)');
            } else {
                btn.classList.remove('active');
                addLog('Ch·∫ø ƒë·ªô xem', 'ƒê·ªïi sang xem l∆∞·ªõi (Kho·∫£nh kh·∫Øc)');
            }
            
            // T·∫£i l·∫°i to√†n b·ªô, b·∫Øt ƒë·∫ßu t·ª´ trang 1
            loadPhotos(1);
        }

        /**
         * H√†m render ri√™ng cho Ch·∫ø ƒê·ªô Xem Nh√≥m
         * (ƒê√£ s·ª≠a: Ch·ªâ render c√°c nh√≥m ƒë∆∞·ª£c truy·ªÅn v√†o)
         */
        function renderGroupedPhotos(container, groupsToRender, viewMode) {
            
            container.innerHTML = ''; // X√≥a s·∫°ch
            
            // L·∫∑p qua c√°c nh√≥m ƒë∆∞·ª£c ph√¢n trang
            groupsToRender.forEach((photos, category) => {
                // Th√™m ti√™u ƒë·ªÅ nh√≥m
                container.innerHTML += `
                    <div class="category-group-header">
                        <div class="header-content">
                            <i class="fas fa-tag"></i> 
                            <span>${escapeHtml(category)}</span>
                        </div>
                        <div class="header-badge">
                            ${photos.length} media
                        </div>
                    </div>
                `;
                
                const photoGrid = document.createElement('div');
                
                if (viewMode === 'list') {
                    // --- N·∫øu ch·∫ø ƒë·ªô xem l√† List ---
                    photoGrid.className = 'list-view';
                    photoGrid.innerHTML = photos.map(media => {
                        // (Copy HTML t·ª´ 'list' c·ªßa loadPhotos)
                        const thumbnailUrl = getGridThumbnailUrl(media);
                        const mediaComments = commentsData.find(c => c.ID_IMG === media.name);
                        const likesCount = mediaComments && mediaComments.tim && Array.isArray(mediaComments.tim) ? mediaComments.tim.length : 0;
                        const commentsCount = mediaComments ? (mediaComments.comments ? mediaComments.comments.length : 0) : 0;
                        const isVideo = media.fileType === 'video';
                        const fileIcon = isVideo ? 'fas fa-play-circle' : 'fas fa-image';
                        return `
                            <div class="photo-item" onclick="viewMediaWithDetails('${media.id}', '${media.name}', '${media.fileType}')">
                                <div class="relative">
                                    <img src="${thumbnailUrl}" alt="${media.name}" loading="lazy" referrerpolicy="no-referrer" onerror="this.src=imageErrorPlaceholder; this.style.objectFit='contain';">
                                    ${isVideo ? '<div class="absolute inset-0 flex items-center justify-center"><i class="fas fa-play-circle text-white text-3xl opacity-80"></i></div>' : ''}
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-medium text-primary flex items-center">
                                        <i class="${fileIcon} mr-2"></i>${media.name}
                                    </h4>
                                    <div class="flex items-center space-x-4 mt-2 text-xs text-gray-500">
                                        <span><i class="fas fa-heart mr-1"></i>${likesCount}</span>
                                        <span><i class="fas fa-comment mr-1"></i>${commentsCount}</span>
                                        <span><i class="fas fa-file mr-1"></i>${formatFileSize(media.size)}</span>
                                        <span class="px-2 py-1 bg-gray-200 rounded text-xs">${isVideo ? 'Video' : '·∫¢nh'}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');

                } else {
                    // --- N·∫øu ch·∫ø ƒë·ªô xem l√† Grid (grid-1, grid-2...) ---
                    const viewClassMap = {
                        'grid-1': 'grid-view-1', 'grid-2': 'grid-view-2', 'grid-3': 'grid-view-3',
                        'grid-4': 'grid-view-4', 'grid-5': 'grid-view-5', 'grid-6': 'grid-view-6'
                    };
                    const cssClass = viewClassMap[viewMode] || 'grid-view-3';
                    photoGrid.className = `photo-grid ${cssClass}`; 
                    
                    photoGrid.innerHTML = photos.map(media => {
                        // (Copy HTML t·ª´ 'grid' c·ªßa loadPhotos)
                        const thumbnailUrl = getGridThumbnailUrl(media);
                        const mediaComments = commentsData.find(c => c.ID_IMG === media.name);
                        const likesCount = mediaComments && mediaComments.tim && Array.isArray(mediaComments.tim) ? mediaComments.tim.length : 0;
                        const commentsCount = mediaComments ? (mediaComments.comments ? mediaComments.comments.length : 0) : 0;
                        const isVideo = media.fileType === 'video';
                        return `
                            <div class="photo-item relative" onclick="viewMediaWithDetails('${media.id}', '${media.name}', '${media.fileType}')" title="${media.name}">
                                <img src="${thumbnailUrl}" alt="${media.name}" loading="lazy" referrerpolicy="no-referrer" onerror="this.src=imageErrorPlaceholder; this.style.objectFit='contain';">
                                ${isVideo ? '<div class="absolute inset-0 flex items-center justify-center"><i class="fas fa-play-circle text-white text-4xl opacity-80"></i></div>' : ''}
                                <div class="absolute top-2 right-2">
                                    <span class="bg-black bg-opacity-60 text-white text-xs px-2 py-1 rounded">
                                        ${isVideo ? 'Video' : '·∫¢nh'}
                                    </span>
                                </div>
                                <div class="absolute bottom-2 left-2 bg-black bg-opacity-60 text-white text-xs px-2 py-1 rounded flex items-center space-x-2">
                                    <span class="flex items-center">
                                        <i class="fas fa-heart text-red-500 mr-1"></i>
                                        ${likesCount}
                                    </span>
                                    <span class="flex items-center">
                                        <i class="fas fa-comment text-blue-400 mr-1"></i>
                                        ${commentsCount}
                                    </span>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
                container.appendChild(photoGrid);
            });
        }
		
        /**
         * X√¢y d·ª±ng m·ªôt Map (√°nh x·∫°) t·ª´ T√™n ·∫¢nh -> Lo·∫°i S·ª± Ki·ªán
         * D·ªØ li·ªáu ƒë∆∞·ª£c l·∫•y t·ª´ 'eventsData' (actions.json)
         */
        function buildPhotoCategoryMap() {
            photoCategoryMap.clear();
            for (const event of eventsData) {
                // Ch·ªâ x·ª≠ l√Ω n·∫øu s·ª± ki·ªán c√≥ ·∫£nh V√Ä c√≥ lo·∫°i
                if (event.image && event.category) {
                    for (const imageName of event.image) {
                        // ∆Øu ti√™n b·∫£n ƒë·ªì ƒë·∫ßu ti√™n t√¨m th·∫•y
                        if (!photoCategoryMap.has(imageName)) { 
                            photoCategoryMap.set(imageName, event.category);
                        }
                    }
                }
            }
            console.log(`ƒê√£ t·∫°o b·∫£n ƒë·ªì li√™n k·∫øt ·∫£nh: ${photoCategoryMap.size} ·∫£nh ƒë∆∞·ª£c ph√¢n lo·∫°i.`);
        }

        /**
         * H√†m render ri√™ng cho Ch·∫ø ƒê·ªô Xem Nh√≥m
         * (ƒê√£ s·ª≠a: Ch·ªâ render c√°c nh√≥m ƒë∆∞·ª£c truy·ªÅn v√†o)
         */
        function renderGroupedPhotos(container, groupsToRender, viewMode) {
            
            container.innerHTML = ''; // X√≥a s·∫°ch
            
            // L·∫∑p qua c√°c nh√≥m ƒë∆∞·ª£c ph√¢n trang
            groupsToRender.forEach((photos, category) => {
                // Th√™m ti√™u ƒë·ªÅ nh√≥m
                container.innerHTML += `
                    <div class="category-group-header">
                        <div class="header-content">
                            <i class="fas fa-tag"></i> 
                            <span>${escapeHtml(category)}</span>
                        </div>
                        <div class="header-badge">
                            ${photos.length} media
                        </div>
                    </div>
                `;
                
                const photoGrid = document.createElement('div');
                
                if (viewMode === 'list') {
                    // --- N·∫øu ch·∫ø ƒë·ªô xem l√† List ---
                    photoGrid.className = 'list-view';
                    photoGrid.innerHTML = photos.map(media => {
                        const thumbnailUrl = getGridThumbnailUrl(media);
                        const mediaComments = commentsData.find(c => c.ID_IMG === media.name);
                        const likesCount = mediaComments && mediaComments.tim && Array.isArray(mediaComments.tim) ? mediaComments.tim.length : 0;
                        const commentsCount = mediaComments ? (mediaComments.comments ? mediaComments.comments.length : 0) : 0;
                        const isVideo = media.fileType === 'video';
                        const fileIcon = isVideo ? 'fas fa-play-circle' : 'fas fa-image';
                        return `
                            <div class="photo-item" onclick="viewMediaWithDetails('${media.id}', '${media.name}', '${media.fileType}')">
                                <div class="relative">
                                    <img src="${thumbnailUrl}" alt="${media.name}" loading="lazy" referrerpolicy="no-referrer" onerror="this.src=imageErrorPlaceholder; this.style.objectFit='contain';">
                                    ${isVideo ? '<div class="absolute inset-0 flex items-center justify-center"><i class="fas fa-play-circle text-white text-3xl opacity-80"></i></div>' : ''}
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-medium text-primary flex items-center">
                                        <i class="${fileIcon} mr-2"></i>${media.name}
                                    </h4>
                                    <div class="flex items-center space-x-4 mt-2 text-xs text-gray-500">
                                        <span><i class="fas fa-heart mr-1"></i>${likesCount}</span>
                                        <span><i class="fas fa-comment mr-1"></i>${commentsCount}</span>
                                        <span><i class="fas fa-file mr-1"></i>${formatFileSize(media.size)}</span>
                                        <span class="px-2 py-1 bg-gray-200 rounded text-xs">${isVideo ? 'Video' : '·∫¢nh'}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');

                } else {
                    // --- N·∫øu ch·∫ø ƒë·ªô xem l√† Grid (grid-1, grid-2...) ---
                    const viewClassMap = {
                        'grid-1': 'grid-view-1', 'grid-2': 'grid-view-2', 'grid-3': 'grid-view-3',
                        'grid-4': 'grid-view-4', 'grid-5': 'grid-view-5', 'grid-6': 'grid-view-6'
                    };
                    const cssClass = viewClassMap[viewMode] || 'grid-view-3';
                    photoGrid.className = `photo-grid ${cssClass}`; 
                    
                    photoGrid.innerHTML = photos.map(media => {
                        const thumbnailUrl = getGridThumbnailUrl(media);
                        const mediaComments = commentsData.find(c => c.ID_IMG === media.name);
                        const likesCount = mediaComments && mediaComments.tim && Array.isArray(mediaComments.tim) ? mediaComments.tim.length : 0;
                        const commentsCount = mediaComments ? (mediaComments.comments ? mediaComments.comments.length : 0) : 0;
                        const isVideo = media.fileType === 'video';
                        return `
                            <div class="photo-item relative" onclick="viewMediaWithDetails('${media.id}', '${media.name}', '${media.fileType}')" title="${media.name}">
                                <img src="${thumbnailUrl}" alt="${media.name}" loading="lazy" referrerpolicy="no-referrer" onerror="this.src=imageErrorPlaceholder; this.style.objectFit='contain';">
                                ${isVideo ? '<div class="absolute inset-0 flex items-center justify-center"><i class="fas fa-play-circle text-white text-4xl opacity-80"></i></div>' : ''}
                                <div class="absolute top-2 right-2">
                                    <span class="bg-black bg-opacity-60 text-white text-xs px-2 py-1 rounded">
                                        ${isVideo ? 'Video' : '·∫¢nh'}
                                    </span>
                                </div>
                                <div class="absolute bottom-2 left-2 bg-black bg-opacity-60 text-white text-xs px-2 py-1 rounded flex items-center space-x-2">
                                    <span class="flex items-center">
                                        <i class="fas fa-heart text-red-500 mr-1"></i>
                                        ${likesCount}
                                    </span>
                                    <span class="flex items-center">
                                        <i class="fas fa-comment text-blue-400 mr-1"></i>
                                        ${commentsCount}
                                    </span>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
                container.appendChild(photoGrid);
            });
        }
         
        /**
         * VI·∫æT L·∫†I H√ÄM N√ÄY ƒê·ªÇ H·ªñ TR·ª¢ PH√ÇN TRANG CHO C·∫¢ 2 CH·∫æ ƒê·ªò
         */
        function loadPhotos(page = 1) {
            const container = document.getElementById('photosContainer');
            const paginationContainer = document.getElementById('photosPagination');
            currentPage = page; // Lu√¥n c·∫≠p nh·∫≠t trang hi·ªán t·∫°i

            // 1. Lu√¥n x√¢y d·ª±ng b·∫£n ƒë·ªì n·∫øu n√≥ tr·ªëng
            if (photoCategoryMap.size === 0 && eventsData.length > 0) {
                buildPhotoCategoryMap();
            }

            // 2. Ki·ªÉm tra d·ªØ li·ªáu
            if (photosData.length === 0) {
                container.className = '';
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-500 col-span-full">
                        </div>
                `;
                paginationContainer.innerHTML = '';
                return;
            }

            // === 3. LOGIC M·ªöI: KI·ªÇM TRA CH·∫æ ƒê·ªò NH√ìM ===
            if (isPhotoGrouped) {
                // --- 3a. RENDER CH·∫æ ƒê·ªò XEM NH√ìM (C√ì PH√ÇN TRANG NH√ìM) ---
                
                // Ph√¢n nh√≥m (gi·ªëng h√†m c≈©)
                const groups = new Map();
                for (const photo of photosData) {
                    const category = photoCategoryMap.get(photo.name) || "Kh√¥ng ph√¢n lo·∫°i";
                    if (!groups.has(category)) groups.set(category, []);
                    groups.get(category).push(photo);
                }
                const sortedGroups = new Map(
                    [...groups.entries()].sort((a, b) => {
                        if (a[0] === "Kh√¥ng ph√¢n lo·∫°i") return 1;
                        if (b[0] === "Kh√¥ng ph√¢n lo·∫°i") return -1;
                        return a[0].localeCompare(b[0]);
                    })
                );

                // T√≠nh to√°n ph√¢n trang cho NH√ìM
                const totalPages = Math.ceil(sortedGroups.size / GROUPS_PER_PAGE);
                const startIndex = (page - 1) * GROUPS_PER_PAGE;
                const endIndex = startIndex + GROUPS_PER_PAGE;
                
                // L·∫•y c√°c nh√≥m cho trang n√†y
                const pageGroups = new Map(Array.from(sortedGroups).slice(startIndex, endIndex));

                container.className = ''; // X√≥a class grid/list c≈©
                renderGroupedPhotos(container, pageGroups, currentPhotoView); 
                loadPhotosPagination(page, totalPages); // T·∫£i ph√¢n trang

            } else {
                // --- 3b. RENDER CH·∫æ ƒê·ªò XEM TH∆Ø·ªúNG (KH√îNG NH√ìM) ---
                const photosPerPage = parseInt(config.PHOTOS_PER_PAGE);
                
                const sortedMedia = [...photosData].sort((a, b) => a.name.localeCompare(b.name));
                const totalPages = Math.ceil(sortedMedia.length / photosPerPage);
                const startIndex = (page - 1) * photosPerPage;
                const endIndex = startIndex + photosPerPage;
                const pageMedia = sortedMedia.slice(startIndex, endIndex);

                if (currentPhotoView === 'list') {
                    container.className = 'list-view';
                    container.innerHTML = pageMedia.map(media => {
                        // ... (HTML c·ªßa List View) ...
                        const thumbnailUrl = getGridThumbnailUrl(media);
                        const mediaComments = commentsData.find(c => c.ID_IMG === media.name);
                        const likesCount = mediaComments && mediaComments.tim && Array.isArray(mediaComments.tim) ? mediaComments.tim.length : 0;
                        const commentsCount = mediaComments ? (mediaComments.comments ? mediaComments.comments.length : 0) : 0;
                        const isVideo = media.fileType === 'video';
                        const fileIcon = isVideo ? 'fas fa-play-circle' : 'fas fa-image';
                        return `
                            <div class="photo-item" onclick="viewMediaWithDetails('${media.id}', '${media.name}', '${media.fileType}')">
                                <div class="relative">
                                    <img src="${thumbnailUrl}" alt="${media.name}" loading="lazy" referrerpolicy="no-referrer" onerror="this.src=imageErrorPlaceholder; this.style.objectFit='contain';">
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-medium text-primary flex items-center">
                                        <i class="${fileIcon} mr-2"></i>${media.name}
                                    </h4>
                                    <div class...">${formatFileSize(media.size)}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    const viewClassMap = {
                        'grid-1': 'grid-view-1', 'grid-2': 'grid-view-2', 'grid-3': 'grid-view-3',
                        'grid-4': 'grid-view-4', 'grid-5': 'grid-view-5', 'grid-6': 'grid-view-6'
                    };
                    const cssClass = viewClassMap[currentPhotoView] || 'grid-view-2';
                    container.className = `photo-grid ${cssClass}`;
                    
                    container.innerHTML = pageMedia.map(media => {
                        // ... (HTML c·ªßa Grid View) ...
                        const thumbnailUrl = getGridThumbnailUrl(media);
                        const mediaComments = commentsData.find(c => c.ID_IMG === media.name);
                        const likesCount = mediaComments && mediaComments.tim && Array.isArray(mediaComments.tim) ? mediaComments.tim.length : 0;
                        const commentsCount = mediaComments ? (mediaComments.comments ? mediaComments.comments.length : 0) : 0;
                        const isVideo = media.fileType === 'video';
                        return `
                            <div class="photo-item relative" onclick="viewMediaWithDetails('${media.id}', '${media.name}', '${media.fileType}')" title="${media.name}">
                                <img src="${thumbnailUrl}" alt="${media.name}" loading="lazy" referrerpolicy="no-referrer" onerror="this.src=imageErrorPlaceholder; this.style.objectFit='contain';">
                                <div class="absolute bottom-2 left-2 ...">
                                    <span><i class="fas fa-heart ..."></i>${likesCount}</span>
                                    <span><i class="fas fa-comment ..."></i>${commentsCount}</span>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
                // T·∫£i ph√¢n trang
                loadPhotosPagination(page, totalPages);
            }
        }

        function formatFileSize(bytes) {
            if (!bytes) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function viewMediaWithDetails(mediaId, mediaName, fileType) {
            // Store current media info
            currentPhotoId = mediaId;
            currentPhotoName = mediaName;
            
            const modalPhoto = document.getElementById('modalPhoto');
            
            if (fileType === 'video') {
                // For videos, create a video element
                const videoUrl = `https://drive.google.com/file/d/${mediaId}/preview`;
                modalPhoto.outerHTML = `
					<iframe id="modalPhoto" src="${videoUrl}" 
							style="max-width: 100%; max-height: 50vh; width: 800px; height: 450px; border: none;"
							allow="autoplay">
					</iframe>
				`;
            } else {
                
                if (modalPhoto.tagName !== 'IMG') {
					modalPhoto.outerHTML = `<img id="modalPhoto" src="" alt="" class="mx-auto rounded-lg" style="max-width: 100%; max-height: 50vh; width: auto; height: auto; object-fit: contain;" referrerpolicy="no-referrer">`;
                }
                 
                const imgElement = document.getElementById('modalPhoto');
				loadModalImageWithFallback(imgElement, mediaId);
				
                //imgElement.style.maxWidth = '50vw';
                //imgElement.style.maxHeight = '50vh';
                //imgElement.style.width = 'auto';
                //imgElement.style.height = 'auto';
                //imgElement.style.objectFit = 'contain';
            }
            
            // Load comments and likes for this media
            loadPhotoComments(mediaName);
            loadPhotoLikes(mediaName);
            
            openModal('photoModal');
        }

		// D√°n h√†m n√†y v√†o (kho·∫£ng d√≤ng 1335)
        function loadModalImageWithFallback(imgElement, mediaId) {
            const media = photosData.find(p => p.id === mediaId);
            
            // 1. T·∫°o danh s√°ch URL d·ª± ph√≤ng
            const urls = [
                driveAPI.getImageUrl(mediaId, 'highQuality'), // 1. Th·ª≠ link ch·∫•t l∆∞·ª£ng cao
                media.thumbnailLink ? media.thumbnailLink.replace(/=s\d+/, '=s2048') : null, // 2. Th·ª≠ hack link 2048px
                `https://drive.google.com/thumbnail?id=${mediaId}&sz=w1600`, // 3. Th·ª≠ link 1600px
                media.thumbnailLink // 4. Th·ª≠ link thumbnail g·ªëc
            ].filter(url => url); // L·ªçc b·ªè c√°c link null

            // 2. T·∫°o v√† ch√®n spinner "ƒêang t·∫£i"
            const container = imgElement.parentNode;
            
            // X√≥a spinner c≈© n·∫øu c√≥
            const oldLoader = container.querySelector('.modal-loader');
            if (oldLoader) oldLoader.remove();
            
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'modal-loader w-full flex items-center justify-center mx-auto rounded-lg';
            // D√πng style gi·ªëng h·ªát ·∫£nh ƒë·ªÉ gi·ªØ kh√¥ng gian
            loadingDiv.style.cssText = `max-width: 50vw; max-height: 50vh; min-height: 300px; background: #f8f9fa;`; 
            loadingDiv.innerHTML = `<div class="text-center">
                                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                                        <p class="mt-4 text-gray-600">ƒêang t·∫£i ·∫£nh...</p>
                                    </div>`;
            
            imgElement.style.display = 'none'; // ·∫®n ·∫£nh ƒëi
            container.insertBefore(loadingDiv, imgElement); // Ch√®n spinner v√†o

            // 3. B·∫Øt ƒë·∫ßu qu√° tr√¨nh t·∫£i ·∫£nh
            let urlIndex = 0;
            function tryLoad() {
                if (urlIndex >= urls.length) {
                    // N·∫øu t·∫•t c·∫£ URL ƒë·ªÅu l·ªói
                    loadingDiv.innerHTML = '<p class="text-red-500 p-4">Kh√¥ng th·ªÉ t·∫£i ·∫£nh. Vui l√≤ng th·ª≠ l·∫°i.</p>';
                    return;
                }
                
                // G√°n s·ª± ki·ªán cho ·∫£nh
                imgElement.onload = function() {
                    loadingDiv.remove(); // X√≥a spinner
                    imgElement.style.display = 'block'; // Hi·ªán ·∫£nh
                };
                
                imgElement.onerror = function() {
                    console.warn('Modal Image Load Failed, trying next:', urls[urlIndex]);
                    urlIndex++; // Chuy·ªÉn sang URL ti·∫øp theo
                    tryLoad(); // Th·ª≠ l·∫°i
                };
                
                // B·∫Øt ƒë·∫ßu t·∫£i URL hi·ªán t·∫°i
                imgElement.src = urls[urlIndex];
            }
            
            tryLoad(); // B·∫Øt ƒë·∫ßu t·∫£i URL ƒë·∫ßu ti√™n
        }
		
		
        function viewPhotoWithDetails(photoId, photoName) {
            // Backward compatibility - assume it's an image
            viewMediaWithDetails(photoId, photoName, 'image');
        }

        function loadPhotoComments(photoName) {
            const photoComments = commentsData.find(c => c.ID_IMG === photoName);
            const commentsContainer = document.getElementById('commentsContainer');
            
            if (photoComments && photoComments.comments && photoComments.comments.length > 0) {
                commentsContainer.innerHTML = photoComments.comments.map(comment => {
                    // Safely escape HTML content to prevent font issues
                    const safeUserName = escapeHtml(comment.userName || '·∫®n danh');
                    const safeComment = escapeHtml(comment.comment || '');
                    
                    // Map avatar by username from profiles data
                    let avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(safeUserName)}&background=006B68&color=fff`;
                    const userProfile = profilesData.find(p => p.username === comment.userName);
                    if (userProfile && userProfile.avatarUrl) {
                        avatarUrl = userProfile.avatarUrl;
                    }
                    
                    return `
                        <div class="text-sm border-b border-gray-200 pb-2">
                            <div class="flex items-center space-x-2 mb-1">
                                <img src="${avatarUrl}" 
                                     alt="" class="w-6 h-6 rounded-full"
                                     onerror="this.src='https://ui-avatars.com/api/?name=User&background=006B68&color=fff';">
                                <strong class="font-medium">${safeUserName}</strong>
                                <span class="text-xs text-gray-500">${formatDateToDDMMYYHHMMSS(comment.date_input)}</span>
                            </div>
                            <p class="whitespace-pre-wrap ml-8">${safeComment}</p>
                        </div>
                    `;
                }).join('');
            } else {
                commentsContainer.innerHTML = '<div class="text-sm text-gray-500">Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o</div>';
            }
        }

        function loadPhotosPagination(currentPage, totalPages) {
            const container = document.getElementById('photosPagination');
            
            let paginationHTML = '';
            
            if (currentPage > 1) {
                paginationHTML += `<button onclick="loadPhotos(${currentPage - 1})" class="love-button mr-2">‚Üê Tr∆∞·ªõc</button>`;
            }
            
            paginationHTML += `<span class="mx-4 text-gray-600">Trang ${currentPage} / ${totalPages}</span>`;
            
            if (currentPage < totalPages) {
                paginationHTML += `<button onclick="loadPhotos(${currentPage + 1})" class="love-button ml-2">Sau ‚Üí</button>`;
            }
            
            container.innerHTML = paginationHTML;
        }

        function cyclePhotoView() {
            const oldView = currentPhotoView;
            
            // Move to next view in cycle
            currentViewIndex = (currentViewIndex + 1) % photoViewCycle.length;
            currentPhotoView = photoViewCycle[currentViewIndex];
            
            // Update button text and icon
            updateViewToggleButton();
            
            // Reload photos with new view
            loadPhotos(currentPage);
            
            // Log view change
            const viewNames = {
                'grid-1': '1x1',
                'grid-2': '2x2', 
                'grid-3': '3x3',
                'grid-4': '4x4',
                'grid-5': '5x5',
                'grid-6': '6x6',
                'list': 'Danh s√°ch'
            };
            
            addLog('Thay ƒë·ªïi ch·∫ø ƒë·ªô xem', `Chuy·ªÉn t·ª´ "${viewNames[oldView]}" sang "${viewNames[currentPhotoView]}"`);
        }

        function updateViewToggleButton() {
            const icon = document.getElementById('viewToggleIcon');
            const text = document.getElementById('viewToggleText');
            
            const viewConfig = {
                'grid-1': { icon: 'fas fa-square', text: '1x1' },
                'grid-2': { icon: 'fas fa-th-large', text: '2x2' },
                'grid-3': { icon: 'fas fa-th', text: '3x3' },
                'grid-4': { icon: 'fas fa-grip-horizontal', text: '4x4' },
                'grid-5': { icon: 'fas fa-grip-vertical', text: '5x5' },
                'grid-6': { icon: 'fas fa-border-all', text: '6x6' },
                'list': { icon: 'fas fa-list', text: 'Danh s√°ch' }
            };
            
            const config = viewConfig[currentPhotoView];
            icon.className = config.icon;
            text.textContent = config.text;
        }

        function viewPhoto(url) {
            const modalPhoto = document.getElementById('modalPhoto');
            modalPhoto.src = url;
            
            // Apply consistent sizing
            modalPhoto.style.maxWidth = '50vw';
            modalPhoto.style.maxHeight = '50vh';
            modalPhoto.style.width = 'auto';
            modalPhoto.style.height = 'auto';
            modalPhoto.style.objectFit = 'contain';
            
            openModal('photoModal');
        }

        // Date formatting function
        function formatDateInput(input) {
            let value = input.value.replace(/\D/g, ''); // Remove non-digits
            
            if (value.length >= 2) {
                value = value.substring(0, 2) + '-' + value.substring(2);
            }
            if (value.length >= 5) {
                value = value.substring(0, 5) + '-' + value.substring(5, 9);
            }
            
            input.value = value;
        }

        // Image selection handler
        function handleImageSelection(input) {
            const files = input.files;
            document.getElementById('selectedImagesCount').textContent = files.length;
            
            // Convert FileList to array for easier handling
            selectedImages = Array.from(files);
        }

        // Event functions
        function saveEvent(e) {
            e.preventDefault();
            
            const name = document.getElementById('eventName').value;
            const date = document.getElementById('eventDate').value;
            const description = document.getElementById('eventDescription').value;
            const category = document.getElementById('eventCategory').value.trim() || null; // <-- TH√äM D√íNG N√ÄY
			
            // 1. Ki·ªÉm tra ƒë·ªãnh d·∫°ng (Gi·ªØ nguy√™n)
            if (!/^\d{2}-\d{2}-\d{4}$/.test(date)) {
                showNotification('Vui l√≤ng nh·∫≠p ng√†y ƒë√∫ng ƒë·ªãnh d·∫°ng dd-mm-yyyy!', 'error');
                return;
            }
            
            const imageArray = Array.from(selectedPhotos);
            
            let apiMessage = '';
            let logMessage = '';
            let originalEvent = null; // Bi·∫øn ƒë·ªÉ l∆∞u s·ª± ki·ªán g·ªëc (cho vi·ªác rollback)
            let newEvent = null;      // Bi·∫øn ƒë·ªÉ l∆∞u s·ª± ki·ªán m·ªõi (cho vi·ªác rollback)
            let eventIndex = -1;

            if (editingEventId) {
                // --- X·ª¨ L√ù S·ª¨A S·ª∞ KI·ªÜN ---
                eventIndex = eventsData.findIndex(event => event.note_id === editingEventId);
                if (eventIndex === -1) {
                    showNotification('L·ªói: Kh√¥ng t√¨m th·∫•y s·ª± ki·ªán ƒë·ªÉ s·ª≠a!', 'error');
                    return; 
                }

                // a. L∆∞u l·∫°i s·ª± ki·ªán g·ªëc ƒë·ªÉ ph√≤ng h·ªù rollback
                originalEvent = { ...eventsData[eventIndex] }; 
                
                // b. C·∫≠p nh·∫≠t l·∫°c quan (thay ƒë·ªïi d·ªØ li·ªáu local ngay l·∫≠p t·ª©c)
                eventsData[eventIndex] = {
                    ...eventsData[eventIndex],
                    name: name,
                    day: date,
                    contdetl: description,
                    image: imageArray,
					category: category
                };

                apiMessage = `C·∫≠p nh·∫≠t s·ª± ki·ªán: ${name}`;
                logMessage = `ƒê√£ c·∫≠p nh·∫≠t s·ª± ki·ªán "${name}" v·ªõi ${imageArray.length} ·∫£nh`;
            
            } else {
                // --- X·ª¨ L√ù TH√äM S·ª∞ KI·ªÜN M·ªöI ---
                newEvent = {
                    note_id: Date.now().toString(),
                    name: name,
                    day: date,
                    contdetl: description,
                    image: imageArray,
					category: category
                };

                // b. C·∫≠p nh·∫≠t l·∫°c quan (th√™m v√†o d·ªØ li·ªáu local ngay l·∫≠p t·ª©c)
                eventsData.push(newEvent);

                apiMessage = `Th√™m s·ª± ki·ªán m·ªõi: ${name}`;
                logMessage = `ƒê√£ th√™m s·ª± ki·ªán m·ªõi "${name}" v·ªõi ${imageArray.length} ·∫£nh`;
            }

            // 3. --- C·∫¨P NH·∫¨T UI NGAY L·∫¨P T·ª®C ---
            // (ƒê√¢y l√† ph·∫ßn m·∫•u ch·ªët, gi·ªëng h·ªát addComment)
            loadTimeline();
            updateStats();
            loadTodayMemories();
			
			buildPhotoCategoryMap();
			
            addLog(editingEventId ? 'C·∫≠p nh·∫≠t s·ª± ki·ªán' : 'Th√™m s·ª± ki·ªán m·ªõi', logMessage);
            showNotification('ƒê√£ l∆∞u s·ª± ki·ªán th√†nh c√¥ng!', 'success');
            
            closeModal('eventModal');
            resetEventForm(); // H√†m n√†y c≈©ng s·∫Ω reset editingEventId

            // 4. --- ƒê·ªíNG B·ªò N·ªÄN (BACKGROUND SYNC) ---
            // Ch·∫°y m·ªôt h√†m async t·ª± g·ªçi ƒë·ªÉ l∆∞u file l√™n GitHub m√† kh√¥ng block UI
            (async () => {
                try {
                    const success = await githubAPI.updateFile(
                        config.FILE_PATH, 
                        eventsData, 
                        apiMessage
                    );

                    if (!success) {
                        // 5. --- HO√ÄN T√ÅC (ROLLBACK) N·∫æU L∆ØU TH·∫§T B·∫†I ---
                        throw new Error("API update failed"); // K√≠ch ho·∫°t kh·ªëi catch
                    }
                    // N·∫øu th√†nh c√¥ng: kh√¥ng c·∫ßn l√†m g√¨, UI ƒë√£ ƒë√∫ng.
                    console.log("ƒê·ªìng b·ªô s·ª± ki·ªán l√™n GitHub th√†nh c√¥ng.");

                } catch (error) {
                    console.error('L·ªói khi ƒë·ªìng b·ªô s·ª± ki·ªán:', error);
                    showNotification('L·ªói ƒë·ªìng b·ªô! ƒêang ho√†n t√°c...', 'error');
                    
                    // 5. --- LOGIC HO√ÄN T√ÅC ---
                    if (originalEvent) { 
                        // N·∫øu l√† S·ª¨A, kh√¥i ph·ª•c s·ª± ki·ªán g·ªëc
                        eventsData[eventIndex] = originalEvent;
                    } else {
                        // N·∫øu l√† TH√äM M·ªöI, x√≥a s·ª± ki·ªán v·ª´a th√™m
                        eventsData.pop(); 
                    }
                    
                    // T·∫£i l·∫°i UI ƒë·ªÉ hi·ªÉn th·ªã tr·∫°ng th√°i c≈© (ƒë√£ ho√†n t√°c)
                    loadTimeline();
                    updateStats();
                    loadTodayMemories();
                }
            })(); // <-- D·∫•u () ƒë·ªÉ h√†m t·ª± ch·∫°y
        }
        
        function resetEventForm() {
            document.getElementById('eventForm').reset();
            document.getElementById('selectedImagesCount').textContent = '0';
			document.getElementById('eventCategory').value = '';
			
            selectedPhotos.clear();
            editingEventId = null;
             
            // ƒê·∫∑t ng√†y h√¥m nay l√†m m·∫∑c ƒë·ªãnh khi th√™m m·ªõi
            const today = new Date();
            const todayFormatted = `${String(today.getDate()).padStart(2, '0')}-${String(today.getMonth() + 1).padStart(2, '0')}-${today.getFullYear()}`;
            document.getElementById('eventDate').value = todayFormatted;
           
            // Reset modal title and button text
            const modalTitle = document.querySelector('#eventModal h3');
            modalTitle.innerHTML = '<i class="fas fa-plus mr-2"></i>Th√™m S·ª± Ki·ªán M·ªõi';
            
            const submitBtn = document.querySelector('#eventModal button[type="submit"]');
            submitBtn.innerHTML = 'L∆∞u S·ª± Ki·ªán';
        }

        function editEvent(id) {
            const event = eventsData.find(e => e.note_id === id);
            if (!event) {
                showNotification('Kh√¥ng t√¨m th·∫•y s·ª± ki·ªán!', 'error');
                return;
            }
            
            // Set editing mode
            editingEventId = id;
            
            // Load event data into form
            document.getElementById('eventName').value = event.name || '';
            document.getElementById('eventDate').value = event.day || '';
            document.getElementById('eventDescription').value = event.contdetl || '';
            document.getElementById('eventCategory').value = event.category || '';
			
            // Load current images - ensure it's an array
            selectedPhotos.clear();
            if (Array.isArray(event.image)) {
				event.image.forEach(imageName => selectedPhotos.add(imageName));
			}
            
            // Update selected images count
            document.getElementById('selectedImagesCount').textContent = selectedPhotos.size;
            
            // Update modal title to indicate editing
            const modalTitle = document.querySelector('#eventModal h3');
            modalTitle.innerHTML = '<i class="fas fa-edit mr-2"></i>S·ª≠a S·ª± Ki·ªán';
            
            // Update submit button text
            const submitBtn = document.querySelector('#eventModal button[type="submit"]');
            submitBtn.innerHTML = 'C·∫≠p Nh·∫≠t S·ª± Ki·ªán';
            
            // Open modal
            openModal('eventModal');
            
            addLog('S·ª≠a s·ª± ki·ªán', `ƒêang s·ª≠a s·ª± ki·ªán "${event.name}"`);
        }

        // Thay th·∫ø h√†m deleteEvent c≈© b·∫±ng h√†m n√†y
        async function deleteEvent(id) {
            const event = eventsData.find(e => e.note_id === id);
            if (!event) {
                showNotification('Kh√¥ng t√¨m th·∫•y s·ª± ki·ªán!', 'error');
                return;
            }
            
            // 1. H·ªèi x√°c nh·∫≠n (Gi·ªØ nguy√™n logic c≈©)
            const confirmDelete = await showCustomConfirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a s·ª± ki·ªán "${event.name}"?`);
            
            if (!confirmDelete) {
                return; // Ng∆∞·ªùi d√πng ƒë√£ h·ªßy
            }

            // 2. T√¨m v·ªã tr√≠ s·ª± ki·ªán (D√πng cho c·∫£ c·∫≠p nh·∫≠t v√† rollback)
            const eventIndex = eventsData.findIndex(e => e.note_id === id);
            if (eventIndex === -1) {
                showNotification('L·ªói: Kh√¥ng t√¨m th·∫•y s·ª± ki·ªán!', 'error');
                return;
            }

            // 3. --- C·∫¨P NH·∫¨T L·∫†C QUAN (OPTIMISTIC UPDATE) ---
            // X√≥a s·ª± ki·ªán kh·ªèi m·∫£ng local TR∆Ø·ªöC
            // (Ch√∫ng ta ƒë√£ c√≥ 'event' v√† 'eventIndex' ƒë·ªÉ rollback)
            eventsData.splice(eventIndex, 1);
            
            // C·∫≠p nh·∫≠t UI ngay l·∫≠p t·ª©c
            addLog('X√≥a s·ª± ki·ªán', `ƒê√£ x√≥a s·ª± ki·ªán "${event.name}"`);
            showNotification('ƒê√£ x√≥a s·ª± ki·ªán th√†nh c√¥ng!', 'success');
            loadTimeline();
            updateStats();
            loadTodayMemories();
			
			buildPhotoCategoryMap();

            // 4. --- ƒê·ªíNG B·ªò N·ªÄN (BACKGROUND SYNC) ---
            // Ch·∫°y h√†m async t·ª± g·ªçi ƒë·ªÉ l∆∞u file m√† kh√¥ng block UI
            (async () => {
                try {
                    const success = await githubAPI.updateFile(
                        config.FILE_PATH, 
                        eventsData, // G·ª≠i m·∫£ng eventsData ƒë√£ b·ªã x√≥a
                        `X√≥a s·ª± ki·ªán: ${event.name}`
                    );
                    
                    if (!success) {
                        // 5. --- HO√ÄN T√ÅC (ROLLBACK) N·∫æU L∆ØU TH·∫§T B·∫†I ---
                        throw new Error("API update failed"); // K√≠ch ho·∫°t kh·ªëi catch
                    }
                    
                    // N·∫øu th√†nh c√¥ng: kh√¥ng c·∫ßn l√†m g√¨, UI ƒë√£ ƒë√∫ng.
                    console.log("ƒê·ªìng b·ªô (x√≥a) s·ª± ki·ªán l√™n GitHub th√†nh c√¥ng.");

                } catch (error) {
                    console.error('L·ªói khi ƒë·ªìng b·ªô (x√≥a) s·ª± ki·ªán:', error);
                    showNotification('L·ªói ƒë·ªìng b·ªô! ƒêang ho√†n t√°c...', 'error');
                    
                    // 5. --- LOGIC HO√ÄN T√ÅC ---
                    // Th√™m l·∫°i s·ª± ki·ªán ƒë√£ x√≥a v√†o ƒë√∫ng v·ªã tr√≠ c≈©
                    eventsData.splice(eventIndex, 0, event);
                    
                    // T·∫£i l·∫°i UI ƒë·ªÉ hi·ªÉn th·ªã tr·∫°ng th√°i c≈© (ƒë√£ ho√†n t√°c)
                    loadTimeline();
                    updateStats();
                    loadTodayMemories();
					
                }
            })(); // <-- D·∫•u () ƒë·ªÉ h√†m t·ª± ch·∫°y
        }
        
        function showCustomConfirm(message) {
            return new Promise((resolve) => {
                // Create custom confirmation overlay
                const overlay = document.createElement('div');
                overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[1300]';
                overlay.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-md mx-4">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">X√°c nh·∫≠n x√≥a</h3>
                        <p class="text-gray-700 mb-6">${message}</p>
                        <div class="flex space-x-3 justify-end">
                            <button class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400" onclick="resolveConfirm(false)">
                                H·ªßy
                            </button>
                            <button class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600" onclick="resolveConfirm(true)">
                                X√≥a
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(overlay);
                
                window.resolveConfirm = (result) => {
                    document.body.removeChild(overlay);
                    delete window.resolveConfirm;
                    resolve(result);
                };
            });
        }

        // Global variables for event photos pagination
        let currentEventPhotosPage = 1;
        let currentEventPhotos = [];
        const eventPhotosPerPage = 12;

        function viewEventPhotos(id) {
            const event = eventsData.find(e => e.note_id === id);
            if (!event) {
                showNotification('Kh√¥ng t√¨m th·∫•y s·ª± ki·ªán!', 'error');
                return;
            }
            
            const modalTitle = document.querySelector('#eventPhotosModal h3');
            
            // Update modal title with event name
            modalTitle.innerHTML = `<i class="fas fa-images mr-2"></i>·∫¢nh: ${escapeHtml(event.name)}`;
            
            // Store current event photos
            currentEventPhotos = event.image || [];
            currentEventPhotosPage = 1;
            
            loadEventPhotosPage(1);
            openModal('eventPhotosModal');
            addLog('Xem ·∫£nh s·ª± ki·ªán', `ƒê√£ xem ·∫£nh c·ªßa s·ª± ki·ªán "${event.name}"`);
        }

        function loadEventPhotosPage(page) {
            const eventPhotosGrid = document.getElementById('eventPhotosGrid');
            currentEventPhotosPage = page;
            
            if (currentEventPhotos.length === 0) {
                eventPhotosGrid.innerHTML = `
                    <div class="col-span-full text-center py-8 text-gray-500">
                        <i class="fas fa-images text-4xl mb-3"></i>
                        <p>S·ª± ki·ªán n√†y ch∆∞a c√≥ ·∫£nh n√†o</p>
                    </div>
                `;
                updateEventPhotosPagination(0);
                return;
            }
            
            const totalPages = Math.ceil(currentEventPhotos.length / eventPhotosPerPage);
            const startIndex = (page - 1) * eventPhotosPerPage;
            const endIndex = startIndex + eventPhotosPerPage;
            const pagePhotos = currentEventPhotos.slice(startIndex, endIndex);
            
            eventPhotosGrid.innerHTML = pagePhotos.map(imageName => {
                // --- THAY ƒê·ªîI: Tra c·ª©u ·∫£nh b·∫±ng t√™n ---
                const photo = findPhotoByName(imageName);
                if (!photo) return ''; // B·ªè qua n·∫øu ·∫£nh ƒë√£ b·ªã x√≥a

                const imageUrl = driveAPI.getImageUrl(photo.id, 'thumbnail');
                const highQualityUrl = driveAPI.getImageUrl(photo.id, 'highQuality');
                // --- K·∫øt th√∫c thay ƒë·ªïi ---

                return `
                    <div class="photo-item aspect-square rounded overflow-hidden cursor-pointer hover:opacity-80" 
						onclick="viewMediaWithDetails('${photo.id}', '${photo.name}', '${photo.fileType}')">
                        <img src="${imageUrl}" alt="${imageName}" class="w-full h-full object-cover"
                             onerror="this.src=imageErrorPlaceholder; this.style.display='none';">
                    </div>
                `;
            }).join('');
            
            updateEventPhotosPagination(totalPages);
        }

        function updateEventPhotosPagination(totalPages) {
            const modalContent = document.querySelector('#eventPhotosModal .modal-content');
            let paginationContainer = modalContent.querySelector('.event-photos-pagination');
            
            // Remove existing pagination if any
            if (paginationContainer) {
                paginationContainer.remove();
            }
            
            // Don't show pagination if only 1 page or no photos
            if (totalPages <= 1) return;
            
            // Create new pagination
            paginationContainer = document.createElement('div');
            paginationContainer.className = 'event-photos-pagination mt-4 flex justify-center items-center space-x-2';
            
            let paginationHTML = '';
            
            // Previous button
            if (currentEventPhotosPage > 1) {
                paginationHTML += `<button onclick="loadEventPhotosPage(${currentEventPhotosPage - 1})" class="love-button text-sm px-3 py-1">‚Üê Tr∆∞·ªõc</button>`;
            }
            
            // Page info
            paginationHTML += `<span class="text-sm text-gray-600 mx-3">Trang ${currentEventPhotosPage} / ${totalPages}</span>`;
            
            // Next button
            if (currentEventPhotosPage < totalPages) {
                paginationHTML += `<button onclick="loadEventPhotosPage(${currentEventPhotosPage + 1})" class="love-button text-sm px-3 py-1">Sau ‚Üí</button>`;
            }
            
            paginationContainer.innerHTML = paginationHTML;
            modalContent.appendChild(paginationContainer);
        }

        // Image selector functions
        let currentImageSelectorPage = 1;
        let totalImagePages = 1;
       
        // Chat functions
        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }
		 
		// Google AI helper - Refactored based on example
        class GoogleAI {
            constructor() {
 
                this.apiKey = config.AI_GOOGLE;  
                this.model = 'gemini-2.5-flash'; 
                this.apiVersion = 'v1beta'; 
            }

            /**
             * G·ªçi Google Generative AI API.
             * @param {object} prompt - ƒê·ªëi t∆∞·ª£ng ch·ª©a { query: string, context: string }.
             * @returns {Promise<string>} - C√¢u tr·∫£ l·ªùi t·ª´ AI ho·∫∑c th√¥ng b√°o l·ªói.
             */
            async generateResponse(prompt) {
               
                 const formattedPrompt = `
                    You are an AI assistant for a personal memory application called Love Story.
                    Use the following context data about the user's memories, media, and comments to answer their question.
                    Be friendly and helpful. If the context doesn't contain the answer, say you don't have that specific information but try to answer generally if possible.

                    Context Data:
                    ---
                    ${prompt.context || ''} 
                    ---

                    User's Question: ${prompt.query || prompt} 
                    `;

                 // 2. T·∫°o URL API ƒë·ªông
                 const apiUrl = `https://generativelanguage.googleapis.com/${this.apiVersion}/models/${this.model}:generateContent?key=${config.AI_GOOGLE}`;

                 // 3. Chu·∫©n b·ªã payload g·ª≠i ƒëi
                 const payload = {
                     contents: [{
                         parts: [{
                             text: formattedPrompt
                         }]
                     }] 
                 };

                 try {
                     // 4. Th·ª±c hi·ªán g·ªçi API
                     const response = await fetch(apiUrl, {
                         method: 'POST',
                         headers: {
                             'Content-Type': 'application/json'
                         },
                         body: JSON.stringify(payload)
                     });

                     // 5. X·ª≠ l√Ω k·∫øt qu·∫£
                     const result = await response.json();

                     if (!response.ok) {
                         // X·ª≠ l√Ω l·ªói t·ª´ API
                         console.error('L·ªói t·ª´ Google AI API:', result);
                         const errorMsg = result.error?.message || `L·ªói ${response.status}: ${response.statusText}`;
                         // N√©m l·ªói ƒë·ªÉ h√†m g·ªçi (sendChatMessage) c√≥ th·ªÉ b·∫Øt ƒë∆∞·ª£c
                         throw new Error(`L·ªói khi g·ªçi Google AI API: ${errorMsg}`);
                     } else {
                         // Tr√≠ch xu·∫•t vƒÉn b·∫£n t·ª´ k·∫øt qu·∫£ th√†nh c√¥ng
                         const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                         if (text) {
                             return text.trim(); // Tr·∫£ v·ªÅ n·ªôi dung text
                         } else {
                             console.warn("C·∫•u tr√∫c ph·∫£n h·ªìi Google AI kh√¥ng mong ƒë·ª£i:", result);
                             // N√©m l·ªói n·∫øu kh√¥ng c√≥ text
                             throw new Error("Kh√¥ng nh·∫≠n ƒë∆∞·ª£c n·ªôi dung vƒÉn b·∫£n t·ª´ Google AI.");
                         }
                     }

                 } catch (error) {
                     // B·∫Øt l·ªói m·∫°ng ho·∫∑c l·ªói JavaScript trong qu√° tr√¨nh g·ªçi
                     console.error('L·ªói m·∫°ng ho·∫∑c JavaScript khi g·ªçi Google AI:', error);
                     // N√©m l·∫°i l·ªói ƒë·ªÉ h√†m g·ªçi x·ª≠ l√Ω
                     throw new Error(`ƒê√£ x·∫£y ra l·ªói khi k·∫øt n·ªëi Google AI: ${error.message}`);
                 }
            }
        }
		 
        const googleAI = new GoogleAI(); 
		
		/**
         * WARNING: INSECURE - Calls OpenAI API directly from the client-side.
         * Your API key is exposed in the browser.
         * @param {string} userQuery The user's question.
         * @param {string} localContext D·ªØ li·ªáu t√≥m t·∫Øt (events, comments, etc.).
         * @returns {Promise<string>} C√¢u tr·∫£ l·ªùi t·ª´ GPT ho·∫∑c th√¥ng b√°o l·ªói.
         */
        async function callGPTAPI(userQuery, localContext) {
            
			const apiKey = config.AI_GPT1 + config.AI_GPT2;
            const apiUrl = "https://api.openai.com/v1/chat/completions";
 
            const fullPrompt = `
						You are an AI assistant for a personal memory application called Love Story.
						Use the following context data about the user's memories, media, and comments to answer their question.
						Be friendly and helpful. If the context doesn't contain the answer, say you don't have that specific information but try to answer generally if possible.

						Context Data:
						---
						${localContext}
						---

						User's Question: ${userQuery}
						`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}` // Use the insecure key here
                    },
                    body: JSON.stringify({
                        model: "gpt-3.5-turbo", // Or another model like "gpt-4" if you have access
                        messages: [
                            {
                                role: "system",
                                content: "You are a helpful assistant for the Love Story application."
                            },
                            {
                                role: "user",
                                content: fullPrompt
                            }
                        ],
                        max_tokens: 150, // Limit response length
                        temperature: 0.7 // Controls creativity vs determinism
                    }),
                });

                if (!response.ok) {
                     const errorData = await response.json();
                     console.error("OpenAI API Error:", errorData);
                    throw new Error(`Error from OpenAI API: ${response.statusText} - ${errorData.error?.message || 'Unknown error'}`);
                }

                const data = await response.json();
                // Extract the answer from the response structure
                return data.choices?.[0]?.message?.content?.trim() || "GPT didn't provide a valid answer.";

            } catch (error) {
                console.error('Error calling OpenAI API directly:', error);
                // Provide a more user-friendly error message
                let errorMessage = "An error occurred connecting to the advanced AI.";
                if (error.message.includes("Incorrect API key")) {
                    errorMessage = "Connection failed: Invalid API key.";
                } else if (error.message.includes("quota")) {
                    errorMessage = "Could not connect: API quota exceeded.";
                }
                return errorMessage;
            }
        }
		
		function switchAiModel(modelName) {
            currentAiModel = modelName; // Update the global variable

            // Update button styles
            document.querySelectorAll('.ai-mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeButton = document.getElementById(`aiModeBtn-${modelName}`);
            if (activeButton) {
                activeButton.classList.add('active');
            }
            //showNotification(`ƒê√£ chuy·ªÉn sang ${modelName.toUpperCase()} AI`, 'info');
            //addLog('Chat AI', `Chuy·ªÉn sang model: ${modelName.toUpperCase()}`);
        }
		
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            addLog('Chat AI', `ƒê√£ g·ª≠i tin nh·∫Øn: "${message.length > 50 ? message.substring(0, 50) + '...' : message}"`);
            const container = document.getElementById('chatMessages');

            // Add user message to UI
            container.innerHTML += `
                <div class="mb-4 text-right">
                    <div class="inline-block bg-primary text-white rounded-lg px-4 py-2 max-w-xs">
                        ${escapeHtml(message)}
                    </div>
                </div>
            `;
            input.value = '';
            container.scrollTop = container.scrollHeight;

            // Show typing indicator
            const typingId = 'typing-' + Date.now();
            container.innerHTML += `
                <div class="mb-4" id="${typingId}">
                    <div class="inline-block bg-accent border border-custom rounded-lg px-4 py-2 max-w-xs">
                        <div class="flex items-center mb-1">
                            <i class="fas fa-robot text-primary mr-2"></i>
                            <strong class="text-primary">AI</strong>
                        </div>
                        <div class="flex space-x-1">
                            <div class="w-2 h-2 bg-primary rounded-full animate-bounce"></div>
                            <div class="w-2 h-2 bg-primary rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                            <div class="w-2 h-2 bg-primary rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                        </div>
                    </div>
                </div>
            `;
            container.scrollTop = container.scrollHeight;

            let aiResponse = "";
            const fallbackMessage = "Xin l·ªói, t√¥i ch∆∞a hi·ªÉu c√¢u h·ªèi c·ªßa b·∫°n ho·∫∑c ch∆∞a ƒë∆∞·ª£c l·∫≠p tr√¨nh ƒë·ªÉ tr·∫£ l·ªùi v·ªÅ ƒëi·ªÅu ƒë√≥."; // Define fallback message

            try {
                
                 const eventSummary = eventsData.slice(0, 20).map(e => `- Name: ${e.name} (Date: ${e.day}, Description: ${e.contdetl || 'none'})`).join('\n');
                 const photoSummary = `Total media (photos/videos): ${photosData.length}.`;
                 const profileSummary = `Current user's name: ${currentUser.name}.`;
                 const allComments = commentsData.flatMap(c => (c.comments || []).map(comment => ({ ...comment, imageName: c.ID_IMG }))).sort((a, b) => new Date(b.date_input) - new Date(a.date_input));
                 const recentCommentSummary = allComments.slice(0, 5).map(c => `- (On image: ${c.imageName}) ${c.userName}: "${c.comment}"`).join('\n');
                 const commentSummary = `Total comments: ${allComments.length}\n5 most recent comments:\n${recentCommentSummary || "No comments yet."}`;
                 const localContext = `USER PROFILE:\n${profileSummary}\n\nEVENT SUMMARY (Up to 20 most recent):\n${eventSummary}\n\nMEDIA & COMMENT SUMMARY:\n${photoSummary}\n${commentSummary}`;

                if (currentAiModel === 'gpt') {
                    aiResponse = await callGPTAPI(message, localContext);
                } else if (currentAiModel === 'google') {
                   
                    const googleAIInstance = googleAI || new GoogleAI();
                   
                    aiResponse = await googleAIInstance.generateResponse({ query: message, context: localContext });
                } else {
                    aiResponse = "L·ªói: Ch·∫ø ƒë·ªô AI kh√¥ng x√°c ƒë·ªãnh.";
                }

            } catch (error) {
                console.error(`Error during ${currentAiModel} AI processing:`, error);
                aiResponse = `ƒê√£ x·∫£y ra l·ªói khi t√¥i ƒëang x·ª≠ l√Ω b·∫±ng ${currentAiModel.toUpperCase()} AI.`;
            }

            const typingIndicator = document.getElementById(typingId);
            if (typingIndicator) {
                typingIndicator.remove();
            }

            container.innerHTML += `
                <div class="mb-4">
                    <div class="inline-block bg-accent border border-custom rounded-lg px-4 py-2 max-w-xs">
                        <div class="flex items-center mb-1">
                            <i class="fas fa-robot text-primary mr-2"></i>
                            <strong class="text-primary">AI</strong> </div>
                        ${escapeHtml(aiResponse)}
                    </div>
                </div>
            `;
            container.scrollTop = container.scrollHeight;
        }

        // Search functions
        function quickSearch(query) {
            document.getElementById('searchInput').value = query;
            performSearch(query);
        }

        function performSearch(query) {
            const results = document.getElementById('searchResults');
            
            // Simulate search results
            const matchingEvents = sampleEvents.filter(event => 
                event.name.toLowerCase().includes(query.toLowerCase()) ||
                event.description.toLowerCase().includes(query.toLowerCase())
            );
            
            if (matchingEvents.length > 0) {
                results.innerHTML = matchingEvents.map(event => `
                    <div class="love-card rounded p-3 mb-2 cursor-pointer hover:shadow-md">
                        <h4 class="font-medium text-primary">${event.name}</h4>
                        <p class="text-sm text-gray-600">${formatDate(event.date)}</p>
                    </div>
                `).join('');
            } else {
                results.innerHTML = `
                    <div class="text-center py-4 text-gray-500">
                        <i class="fas fa-search text-2xl mb-2"></i>
                        <p>Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ n√†o</p>
                    </div>
                `;
            }
        }

        // Utility functions
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
		
		/**
         * T√¨m ƒë·ªëi t∆∞·ª£ng photo trong photosData d·ª±a v√†o T√äN
         * @param {string} name - T√™n ·∫£nh (ƒë√£ UPPERCASE)
         * @returns {object | null} - ƒê·ªëi t∆∞·ª£ng photo ho·∫∑c null
         */
        function findPhotoByName(name) {
            if (!name) return null;
            // Gi·∫£ ƒë·ªãnh c·∫£ `name` v√† `p.name` ƒë·ªÅu ƒë√£ ·ªü d·∫°ng UPPERCASE
            return photosData.find(p => p.name === name);
        }

        // New configuration functions
        function loadAppConfigToUI() {
            // Load auto sync settings
            document.getElementById('autoSync').checked = config.AUTO_SYNC_METADATA.enabled;
            document.getElementById('syncFrequency').value = config.AUTO_SYNC_METADATA.frequency;
            document.getElementById('syncTime').value = config.AUTO_SYNC_METADATA.time;
            
            // Load logs setting
            document.getElementById('enableLogs').checked = config.ENABLE_LOGS;
        }

        function formatTimeInput(input) {
            let value = input.value.replace(/\D/g, ''); // Remove non-digits
            
            if (value.length >= 2) {
                value = value.substring(0, 2) + ':' + value.substring(2, 4);
            }
            
            input.value = value;
        }

        function updateAutoSyncConfig() {
            config.AUTO_SYNC_METADATA.enabled = document.getElementById('autoSync').checked;
            config.AUTO_SYNC_METADATA.frequency = document.getElementById('syncFrequency').value;
            config.AUTO_SYNC_METADATA.time = document.getElementById('syncTime').value;
            
            // Update sync status display when config changes
            updateSyncStatus();
            
            // Log the configuration change
            const statusText = config.AUTO_SYNC_METADATA.enabled ? 'B·∫≠t' : 'T·∫Øt';
            addLog('C√†i ƒë·∫∑t t·ª± ƒë·ªông ƒë·ªìng b·ªô', 
                `${statusText} t·ª± ƒë·ªông ƒë·ªìng b·ªô - T·∫ßn su·∫•t: ${config.AUTO_SYNC_METADATA.frequency}, Th·ªùi gian: ${config.AUTO_SYNC_METADATA.time}`);
        }

        function updateLogsConfig() {
            config.ENABLE_LOGS = document.getElementById('enableLogs').checked;
        }

        async function manualSync() {
            await syncPhotosMetadata(true);
            updateSyncStatus();
        }
 
        function updateSyncStatus() {
            updateLogCounts();
        }

        async function saveAppConfig() {
            try {
                // Update config from UI
                updateAutoSyncConfig();
                updateLogsConfig();
                
                // Save to GitHub
                const success = await githubAPI.updateFile(
                    config.CONFIG_FILE_PATH,
                    appConfigData,
                    'C·∫≠p nh·∫≠t c·∫•u h√¨nh ·ª©ng d·ª•ng'
                );
                
                if (success) {
                    showNotification('L∆∞u c·∫•u h√¨nh th√†nh c√¥ng!', 'success');
                    addLog('L∆∞u c·∫•u h√¨nh', 'ƒê√£ l∆∞u c·∫•u h√¨nh ·ª©ng d·ª•ng');
                } else {
                    showNotification('L·ªói khi l∆∞u c·∫•u h√¨nh!', 'error');
                }
                
            } catch (error) {
                console.error('Error saving config:', error);
                showNotification('L·ªói khi l∆∞u c·∫•u h√¨nh!', 'error');
            }
        }
 
        function addLog(action, details) {
            // Ch·ªâ ghi log n·∫øu ng∆∞·ªùi d√πng cho ph√©p trong c√†i ƒë·∫∑t
            if (!document.getElementById('enableLogs').checked) return;
            
            const newLog = {
                timestamp: new Date().toISOString(),
                action: action,
                details: details,
                username: getSessionId(), // L·∫•y ID c·ªßa phi√™n l√†m vi·ªác
                saved: false // Tr·∫°ng th√°i l∆∞u file: false = ch∆∞a l∆∞u, true = ƒë√£ l∆∞u
            };
            
            // Th√™m log m·ªõi v√†o h√†ng ƒë·ª£i
            logQueue.push(newLog);
            
            // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng log ƒëang ch·ªù tr√™n giao di·ªán
            updateLogCounts();
			updateNotificationBadge();
        }

        function getSessionId() {
            let sessionId = sessionStorage.getItem('sessionId');
            if (!sessionId) {
                sessionId = Date.now().toString();
                sessionStorage.setItem('sessionId', sessionId);
            }
            return sessionId;
        }

        function updateOnlineStatus() {
            const statusElement = document.getElementById('onlineStatus');
            if (isOnline) {
                statusElement.textContent = 'Online';
                statusElement.className = 'font-bold text-green-600';
                statusElement.previousElementSibling.className = 'status-indicator status-online';
            } else {
                statusElement.textContent = 'Offline';
                statusElement.className = 'font-bold text-red-600';
                statusElement.previousElementSibling.className = 'status-indicator status-offline';
            }
        }
		
		function triggerAvatarUpload() {
            // 1. K√≠ch ho·∫°t input file ·∫©n khi b·∫•m n√∫t icon
            document.getElementById('avatarUpload').click();
        }

        async function handleAvatarUpload(event) {
            // 2. L·∫•y file ng∆∞·ªùi d√πng ch·ªçn
            const file = event.target.files[0];
            if (!file || !file.type.startsWith('image/')) {
                return;
            }
            
            try {
                // 3. Resize ·∫£nh v·ªÅ ~30KB (30 * 1024 = 30720 bytes)
                //    v·ªõi k√≠ch th∆∞·ªõc t·ªëi ƒëa 256px
                const resizedBlob = await resizeImage(file, 30720, 256);
                
                // 4. Chuy·ªÉn blob ƒë√£ resize th√†nh dataURL ƒë·ªÉ hi·ªÉn th·ªã
                const reader = new FileReader();
                reader.onloadend = () => {
                    const dataURL = reader.result;
                    // 5. C·∫≠p nh·∫≠t ·∫£nh l√™n giao di·ªán v√† l∆∞u
                    updateAvatar(dataURL);
                    //showNotification('ƒê√£ c·∫≠p nh·∫≠t avatar!', 'success');
                };
                reader.readAsDataURL(resizedBlob);
                
            } catch (error) {
                console.error('L·ªói resize ·∫£nh:', error);
                showNotification('L·ªói khi resize ·∫£nh!', 'error');
            }
            
            // Reset input ƒë·ªÉ ng∆∞·ªùi d√πng c√≥ th·ªÉ t·∫£i l·∫°i c√πng 1 file
            event.target.value = null;
        }

        /**
         * C·∫Øt (crop) ·∫£nh th√†nh h√¨nh vu√¥ng, resize, v√† n√©n ·∫£nh
         * @param {File} file File ·∫£nh
         * @param {number} targetBytes K√≠ch th∆∞·ªõc mong mu·ªën (v√≠ d·ª•: 30000)
         * @param {number} finalSize K√≠ch th∆∞·ªõc c·∫°nh cu·ªëi c√πng (v√≠ d·ª•: 256, cho 256x256)
         * @returns {Promise<Blob>} Blob ·∫£nh ƒë√£ resize
         */
        function resizeImage(file, targetBytes, finalSize) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = async () => {
                        
                        // 1. X√°c ƒë·ªãnh k√≠ch th∆∞·ªõc v√† v·ªã tr√≠ crop
                        // L·∫•y chi·ªÅu ng·∫Øn nh·∫•t c·ªßa ·∫£nh
                        const shortestSide = Math.min(img.width, img.height);
                        // T√≠nh to√°n v·ªã tr√≠ b·∫Øt ƒë·∫ßu (X, Y) ƒë·ªÉ crop t·ª´ t√¢m
                        const sourceX = (img.width - shortestSide) / 2;
                        const sourceY = (img.height - shortestSide) / 2;

                        // 2. T·∫°o canvas vu√¥ng
                        const canvas = document.createElement('canvas');
                        canvas.width = finalSize; // K√≠ch th∆∞·ªõc cu·ªëi c√πng (e.g., 256)
                        canvas.height = finalSize; // K√≠ch th∆∞·ªõc cu·ªëi c√πng (e.g., 256)
                        const ctx = canvas.getContext('2d');
                        
                        // 3. V·∫Ω ph·∫ßn ƒë√£ crop (t·ª´ ·∫£nh g·ªëc) v√†o canvas (ƒë√£ resize)
                        // L·ªánh n√†y s·∫Ω l·∫•y 1 h√¨nh vu√¥ng (shortestSide x shortestSide) t·ª´ t√¢m ·∫£nh g·ªëc
                        // v√† v·∫Ω n√≥ v√†o canvas (finalSize x finalSize)
                        ctx.drawImage(
                            img, 
                            sourceX,      // B·∫Øt ƒë·∫ßu crop X t·ª´ ·∫£nh g·ªëc
                            sourceY,      // B·∫Øt ƒë·∫ßu crop Y t·ª´ ·∫£nh g·ªëc
                            shortestSide, // Chi·ªÅu r·ªông v√πng crop
                            shortestSide, // Chi·ªÅu cao v√πng crop
                            0,            // V·∫Ω v√†o X=0 c·ªßa canvas
                            0,            // V·∫Ω v√†o Y=0 c·ªßa canvas
                            finalSize,    // Chi·ªÅu r·ªông canvas (resize)
                            finalSize     // Chi·ªÅu cao canvas (resize)
                        );
                        
                        // L·∫∑p ƒë·ªÉ gi·∫£m ch·∫•t l∆∞·ª£ng JPEG cho ƒë·∫øn khi ƒë·∫°t < 30KB
                        for (let quality = 0.9; quality >= 0.1; quality -= 0.1) {
                            const blob = await new Promise(resolveBlob => 
                                canvas.toBlob(resolveBlob, 'image/jpeg', quality)
                            );
                            
                            if (blob.size <= targetBytes) {
                                resolve(blob); // Tr·∫£ v·ªÅ blob ƒë·∫°t y√™u c·∫ßu
                                return;
                            }
                        }
                        
                        // N·∫øu kh√¥ng th·ªÉ < 30KB, tr·∫£ v·ªÅ ch·∫•t l∆∞·ª£ng th·∫•p nh·∫•t
                        canvas.toBlob(resolve, 'image/jpeg', 0.1);

                    };
                    img.onerror = reject;
                    img.src = e.target.result; // DataURL t·ª´ FileReader
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // C·∫≠p nh·∫≠t ·∫£nh ƒë·∫°i di·ªán tr√™n UI v√† l∆∞u v√†o b·ªô nh·ªõ
        function updateAvatar(dataURL) {
            // C·∫≠p nh·∫≠t t·∫•t c·∫£ c√°c ·∫£nh c√≥ alt="Avatar"
            document.querySelectorAll('img[alt="Avatar"]').forEach(img => {
                img.src = dataURL;
            });
            
			document.getElementById('profileAvatarImg').src = dataURL;
			
            // C·∫≠p nh·∫≠t ƒë·ªëi t∆∞·ª£ng currentUser v√† l∆∞u v√†o localStorage
            if (currentUser) {
                currentUser.avatarUrl = dataURL;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
            }
        }
		
		async function saveProfile() {
            // --- 1. VALIDATE (X√°c th·ª±c d·ªØ li·ªáu) ---
            const name = document.getElementById('profileNameInput').value;
            const username = document.getElementById('profileUsernameInput').value.trim();
            
            if (!name || !username) {
                showNotification('H·ªç t√™n v√† T√™n ƒëƒÉng nh·∫≠p l√† b·∫Øt bu·ªôc!', 'error');
                return;
            }
            
            const avatarUrl = document.getElementById('profileAvatarImg').src;
            const createdAt = new Date().toISOString();

            // --- 2. GET ORIGINAL STATE (L·∫•y tr·∫°ng th√°i c≈© ƒë·ªÉ Rollback) ---
            const oldCurrentUser = { ...currentUser }; // Sao ch√©p user hi·ªán t·∫°i
            const oldProfilesData = JSON.parse(JSON.stringify(profilesData)); // Deep copy m·∫£ng h·ªì s∆°
            const oldLocalStorage = localStorage.getItem('currentUser'); // L∆∞u localStorage c≈©

            // --- 3. MAKE LOCAL CHANGES (Thay ƒë·ªïi d·ªØ li·ªáu local) ---
            const updatedProfile = { name, username, avatarUrl, createdAt };
            let apiMessage = `C·∫≠p nh·∫≠t h·ªì s∆°: ${username}`;

            let userIndex = profilesData.findIndex(p => p.username === username);

            if (userIndex !== -1) {
                // Tr∆∞·ªùng h·ª£p 1: C·∫≠p nh·∫≠t h·ªì s∆° hi·ªán c√≥
                profilesData[userIndex] = { ...profilesData[userIndex], ...updatedProfile };
            } else {
                // Tr∆∞·ªùng h·ª£p 2: ƒê·ªïi t√™n (Rename) ho·∫∑c Th√™m m·ªõi
                // T√¨m v√† x√≥a h·ªì s∆° c≈© n·∫øu t√™n ƒëƒÉng nh·∫≠p thay ƒë·ªïi
                let oldUserIndex = profilesData.findIndex(p => p.username === currentUser.username);
                if (oldUserIndex !== -1) {
                    profilesData.splice(oldUserIndex, 1);
                }
                profilesData.push(updatedProfile); // Th√™m h·ªì s∆° m·ªõi
            }

            // --- 4. UPDATE UI IMMEDIATELY (C·∫¨P NH·∫¨T L·∫†C QUAN) ---
            // C·∫≠p nh·∫≠t UI ngay l·∫≠p t·ª©c m√† kh√¥ng c·∫ßn ch·ªù 'await'
            currentUser = updatedProfile;
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            updateUserProfile(); // C·∫≠p nh·∫≠t header
            
            showNotification('ƒê√£ l∆∞u h·ªì s∆° th√†nh c√¥ng!', 'success'); // Th√¥ng b√°o th√†nh c√¥ng ngay
            addLog('H·ªì s∆°', `ƒê√£ c·∫≠p nh·∫≠t h·ªì s∆°: ${username}`);
            closeModal('profileModal'); // ƒê√≥ng modal ngay

            // --- 5. BACKGROUND SYNC (ƒê·ªìng b·ªô n·ªÅn) ---
            // Ch·∫°y m·ªôt h√†m async t·ª± g·ªçi ƒë·ªÉ l∆∞u file l√™n GitHub
            (async () => {
                try {
                    const success = await githubAPI.updateFile(
                        config.PROFILES_FILE_PATH,
                        profilesData,
                        apiMessage
                    );

                    if (!success) {
                        // N·∫øu l∆∞u th·∫•t b·∫°i, n√©m l·ªói ƒë·ªÉ k√≠ch ho·∫°t 'catch'
                        throw new Error("API update failed for profiles.json");
                    }
                    
                    // N·∫øu th√†nh c√¥ng: kh√¥ng c·∫ßn l√†m g√¨, UI ƒë√£ ƒë√∫ng.
                    console.log("ƒê·ªìng b·ªô h·ªì s∆° l√™n GitHub th√†nh c√¥ng.");

                } catch (error) {
                    // --- 6. ROLLBACK ON FAILURE (Ho√†n t√°c n·∫øu l·ªói) ---
                    console.error('L·ªói khi ƒë·ªìng b·ªô h·ªì s∆°:', error);
                    showNotification('L·ªói ƒë·ªìng b·ªô! ƒêang ho√†n t√°c h·ªì s∆°...', 'error');

                    // Kh√¥i ph·ª•c l·∫°i to√†n b·ªô d·ªØ li·ªáu local
                    profilesData = oldProfilesData; // Kh√¥i ph·ª•c m·∫£ng
                    currentUser = oldCurrentUser; // Kh√¥i ph·ª•c bi·∫øn global
                    localStorage.setItem('currentUser', oldLocalStorage); // Kh√¥i ph·ª•c localStorage

                    // C·∫≠p nh·∫≠t l·∫°i UI v·ªÅ tr·∫°ng th√°i c≈©
                    updateUserProfile();
                }
            })(); // <-- D·∫•u () ƒë·ªÉ h√†m t·ª± ch·∫°y
        }

        function logoutProfile() {
            // 1. X√≥a b·ªô nh·ªõ
            localStorage.removeItem('currentUser');
            currentUser = null;
            
            // 2. Clear c√°c √¥ input trong modal
            document.getElementById('profileNameInput').value = '';
            document.getElementById('profileUsernameInput').value = '';
            
            // 3. Reset avatar trong modal
            const defaultAvatar = 'https://ui-avatars.com/api/?name=?&background=006B68&color=fff&size=100';
            document.getElementById('profileAvatarImg').src = defaultAvatar;

            // 4. ƒê√≥ng modal v√† th√¥ng b√°o
            closeModal('profileModal');
            showNotification('ƒê√£ ƒëƒÉng xu·∫•t!', 'info');
            
            // 5. T·∫£i l·∫°i user (s·∫Ω t·ª± ƒë·ªông t·∫°o user "ƒë·ªông v·∫≠t" m·ªõi)
            loadCurrentUser();
        }
		
		function checkExistingUsername() {
            const usernameInput = document.getElementById('profileUsernameInput');
            const username = usernameInput.value.trim(); // L·∫•y t√™n ƒëƒÉng nh·∫≠p ƒë√£ nh·∫≠p

            // Kh√¥ng c·∫ßn check n·∫øu t√™n ƒëƒÉng nh·∫≠p r·ªóng
            if (!username) return;

            // 1. T√¨m ki·∫øm trong to√†n b·ªô profilesData [cite: 210]
            const existingProfile = profilesData.find(p => p.username === username);

            // 2. N·∫øu t√¨m th·∫•y h·ªì s∆° V√Ä n√≥ kh√¥ng ph·∫£i l√† h·ªì s∆° hi·ªán t·∫°i
            if (existingProfile && existingProfile.username !== currentUser?.username) {
                
                // 3. T·∫£i (load) H·ªç t√™n v√† Avatar t√¨m th·∫•y v√†o c√°c √¥ input [cite: 119]
                document.getElementById('profileNameInput').value = existingProfile.name;
                document.getElementById('profileAvatarImg').src = existingProfile.avatarUrl;
                
                // 4. THAY ƒê·ªîI: Chuy·ªÉn ƒë·ªïi client sang h·ªì s∆° n√†y ngay l·∫≠p t·ª©c
                currentUser = existingProfile;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // 5. C·∫≠p nh·∫≠t header
                updateUserProfile(); 
                
                // 6. Th√¥ng b√°o
                showNotification(`ƒê√£ chuy·ªÉn sang h·ªì s∆°: ${existingProfile.name}`, 'success');
                addLog('H·ªì s∆°', `ƒê√£ chuy·ªÉn ƒë·ªïi sang h·ªì s∆° ${existingProfile.name}`);
            }
        }
		
		async function updateStorageUsageDisplay() {
            // ∆Øu ti√™n s·ª≠ d·ª•ng API Storage.estimate() hi·ªán ƒë·∫°i n·∫øu c√≥
            if (navigator.storage && navigator.storage.estimate) {
                try {
                    const estimate = await navigator.storage.estimate();
                    // estimate.usage l√† t·ªïng s·ªë byte ƒë∆∞·ª£c s·ª≠ d·ª•ng
                    const formattedSize = formatFileSize(estimate.usage);
                    document.getElementById('storageUsageDisplay').textContent = formattedSize;
                } catch (error) {
                    console.error('L·ªói khi ∆∞·ªõc t√≠nh dung l∆∞·ª£ng (Storage.estimate):', error);
                    calculateManualStorageUsage(); // S·ª≠ d·ª•ng ph∆∞∆°ng ph√°p d·ª± ph√≤ng
                }
            } else {
                calculateManualStorageUsage(); // S·ª≠ d·ª•ng ph∆∞∆°ng ph√°p d·ª± ph√≤ng cho tr√¨nh duy·ªát c≈©
            }
        }
        
        function calculateManualStorageUsage() {
            // Ph∆∞∆°ng ph√°p d·ª± ph√≤ng: t√≠nh to√°n th·ªß c√¥ng localStorage v√† sessionStorage
            try {
                let totalBytes = 0;
                
                // T√≠nh to√°n localStorage
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    const value = localStorage.getItem(key);
                    // ∆Ø·ªõc t√≠nh 2 byte m·ªói k√Ω t·ª± (UTF-16)
                    totalBytes += (key.length + (value ? value.length : 0)) * 2; 
                }

                // T√≠nh to√°n sessionStorage
                for (let i = 0; i < sessionStorage.length; i++) {
                    const key = sessionStorage.key(i);
                    const value = sessionStorage.getItem(key);
                    totalBytes += (key.length + (value ? value.length : 0)) * 2; 
                }

                // S·ª≠ d·ª•ng h√†m formatFileSize ƒë√£ c√≥ [cite: 412]
                const formattedSize = formatFileSize(totalBytes);
                document.getElementById('storageUsageDisplay').textContent = formattedSize;
            } catch (error) {
                console.error('L·ªói khi t√≠nh dung l∆∞·ª£ng th·ªß c√¥ng:', error);
                document.getElementById('storageUsageDisplay').textContent = 'L·ªói';
            }
        }

        function updateTotalLogs() {
            document.getElementById('totalLogs').textContent = logsData.length.toLocaleString();
        }

        async function saveLogsBatch() {
            // N·∫øu kh√¥ng c√≥ log n√†o trong h√†ng ƒë·ª£i ho·∫∑c ƒëang offline th√¨ kh√¥ng l√†m g√¨ c·∫£
            if (logQueue.length === 0 || !isOnline) {
                return;
            }

            // Sao ch√©p to√†n b·ªô log ƒëang ch·ªù v√† x√≥a h√†ng ƒë·ª£i ngay l·∫≠p t·ª©c
            // ƒë·ªÉ c√°c log m·ªõi c√≥ th·ªÉ ƒë∆∞·ª£c th√™m v√†o trong l√∫c ƒëang l∆∞u
            const logsToSave = [...logQueue];
            logQueue = [];
            updateLogCounts(); // C·∫≠p nh·∫≠t giao di·ªán v·ªÅ 0
            
            try {
                // ƒê√°nh d·∫•u c√°c log n√†y l√† ƒë√£ l∆∞u
                const savedLogs = logsToSave.map(log => ({
                    ...log,
                    saved: true
                }));
                
                // Th√™m c√°c log m·ªõi v√†o ƒë·∫ßu m·∫£ng logsData ƒë√£ t·∫£i v·ªÅ
                logsData.unshift(...savedLogs.reverse());

                // Gi·ªõi h·∫°n ch·ªâ l∆∞u 1000 log g·∫ßn nh·∫•t ƒë·ªÉ file kh√¥ng qu√° l·ªõn
                if (logsData.length > 1000) {
                    logsData.splice(1000);
                }
                
                // G·ªçi API ƒë·ªÉ c·∫≠p nh·∫≠t file logs.json tr√™n GitHub
                const success = await githubAPI.updateFile(
                    config.LOGS_FILE_PATH,
                    logsData,
                    `Batch log update: ${logsToSave.length} entries`
                );
                
                if (success) {
                    console.log(`L∆∞u th√†nh c√¥ng ${logsToSave.length} nh·∫≠t k√Ω.`);
                    // C·∫≠p nh·∫≠t l·∫°i t·ªïng s·ªë log tr√™n giao di·ªán
                    updateLogCounts();
					updateNotificationBadge();
                } else {
                    // N·∫øu l∆∞u th·∫•t b·∫°i, tr·∫£ l·∫°i c√°c log v√†o h√†ng ƒë·ª£i ƒë·ªÉ th·ª≠ l·∫°i l·∫ßn sau
                    console.error("L∆∞u nh·∫≠t k√Ω th·∫•t b·∫°i, c√°c nh·∫≠t k√Ω ƒë√£ ƒë∆∞·ª£c ƒë∆∞a l·∫°i v√†o h√†ng ƒë·ª£i.");
                    logQueue.unshift(...logsToSave);
                    updateLogCounts();
					updateNotificationBadge();
                }
            } catch (error) {
                console.error('L·ªói nghi√™m tr·ªçng khi ƒëang l∆∞u nh·∫≠t k√Ω:', error);
                // Tr·∫£ l·∫°i log v√†o h√†ng ƒë·ª£i n·∫øu c√≥ l·ªói x·∫£y ra
                logQueue.unshift(...logsToSave);
                updateLogCounts();
				updateNotificationBadge();
            }
        }
        function updateLogCounts() {
            // C·∫≠p nh·∫≠t s·ªë log ch·ªù l∆∞u (trong h√†ng ƒë·ª£i)
            document.getElementById('pendingLogs').textContent = logQueue.length;
            
            // C·∫≠p nh·∫≠t t·ªïng s·ªë log v√† s·ªë log ƒë√£ l∆∞u
            const totalLogs = logsData.length + logQueue.length;
            const savedLogs = logsData.filter(log => log.saved !== false).length;
            
            document.getElementById('totalLogs').textContent = totalLogs.toLocaleString();
            document.getElementById('savedLogs').textContent = savedLogs.toLocaleString();
        }

        // Gi·ªØ l·∫°i h√†m c≈© ƒë·ªÉ t∆∞∆°ng th√≠ch
        function updatePendingLogs() {
            updateLogCounts();
        }

        function updateTotalLogs() {
            updateLogCounts();
        }

        function loadLogsToModal(containerId = 'logsContainer', filterId = 'logFilter') {
            const container = document.getElementById(containerId);
            const filter = document.getElementById(filterId)?.value || 'all';
            
            let filteredLogs = logsData;
            if (filter !== 'all') {
                filteredLogs = logsData.filter(log => log.action === filter);
            }
            
            if (filteredLogs.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-file-alt text-4xl mb-3"></i>
                        <p>Kh√¥ng c√≥ nh·∫≠t k√Ω n√†o${filter !== 'all' ? ' cho b·ªô l·ªçc n√†y' : ''}</p>
                    </div>
                `;
                return;
            }
            
            // K·∫øt h·ª£p logs ƒë√£ l∆∞u v√† logs ch·ªù l∆∞u ƒë·ªÉ hi·ªÉn th·ªã
            const allLogs = [...logsData, ...logQueue.map(log => ({...log, saved: false}))];
            const sortedLogs = allLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            let displayLogs = sortedLogs;
            if (filter !== 'all') {
                displayLogs = sortedLogs.filter(log => log.action === filter);
            }
            
            container.innerHTML = displayLogs.slice(0, 50).map(log => {
                const timeAgo = getTimeAgo(log.timestamp);
                const actionIcon = getActionIcon(log.action);
                const isUnsaved = log.saved === false;
                const cardClass = isUnsaved ? 'log-pending' : 'log-saved';
                const statusIcon = isUnsaved ? 
                    '<i class="fas fa-clock text-orange-500 mr-1" title="Ch·ªù l∆∞u file"></i>' : 
                    '<i class="fas fa-check-circle text-green-500 mr-1" title="ƒê√£ l∆∞u file"></i>';
                
                return `
                    <div class="love-card rounded p-3 text-sm ${cardClass}">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center mb-1">
                                    <i class="${actionIcon} text-primary mr-2"></i>
                                    <strong class="mr-2">${escapeHtml(log.action)}</strong>
                                    ${statusIcon}
                                </div>
                                <p class="text-gray-600 ml-6">${escapeHtml(log.details)}</p>
                            </div>
                            <div class="text-right ml-3">
                                <span class="text-xs text-gray-500">${timeAgo}</span>
                                <br>
                                <span class="text-xs text-gray-400">${formatDateToDDMMYYHHMMSS(log.timestamp)}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            if (displayLogs.length > 50) {
                container.innerHTML += `
                    <div class="text-center py-3 text-gray-500 text-sm">
                        Hi·ªÉn th·ªã 50/${displayLogs.length} b·∫£n ghi g·∫ßn nh·∫•t
                        <br>
                        <span class="text-xs">
                            <i class="fas fa-clock text-orange-500 mr-1"></i>Ch·ªù l∆∞u: ${logQueue.length} | 
                            <i class="fas fa-check-circle text-green-500 mr-1"></i>ƒê√£ l∆∞u: ${logsData.length}
                        </span>
                    </div>
                `;
            }
        }

        function getActionIcon(action) {
            const icons = {
				'H·ªá th·ªëng': 'fas fa-server',
                'ƒê·ªìng b·ªô media': 'fas fa-sync',
                'C·∫≠p nh·∫≠t gi√° v√†ng': 'fas fa-ring',
                'L·ªói H·ªá th·ªëng': 'fas fa-exclamation-triangle',
                'ƒêi·ªÅu h∆∞·ªõng': 'fas fa-compass',
                'Th√™m s·ª± ki·ªán m·ªõi': 'fas fa-plus-circle',
                'C·∫≠p nh·∫≠t s·ª± ki·ªán': 'fas fa-edit',
                'X√≥a s·ª± ki·ªán': 'fas fa-trash',
                'ƒê·ªìng b·ªô media': 'fas fa-sync',
                'Thay ƒë·ªïi theme': 'fas fa-palette',
                'Thay ƒë·ªïi ch·∫ø ƒë·ªô xem': 'fas fa-th',
                'M·ªü modal': 'fas fa-window-maximize',
                'T∆∞∆°ng t√°c ·∫£nh': 'fas fa-heart',
                'B√¨nh lu·∫≠n ·∫£nh': 'fas fa-comment',
                'Ph√¢n trang ·∫£nh': 'fas fa-arrow-right',
                'S·ª≠a s·ª± ki·ªán': 'fas fa-edit',
                'Xem ·∫£nh s·ª± ki·ªán': 'fas fa-images',
                'C√†i ƒë·∫∑t giao di·ªán': 'fas fa-cog',
                'L∆∞u c·∫•u h√¨nh': 'fas fa-save',
                'T·∫£i ·∫£nh': 'fas fa-download',
                'Ch·ªçn ·∫£nh': 'fas fa-check-square',
                'Chat AI': 'fas fa-robot',
                'Xu·∫•t nh·∫≠t k√Ω': 'fas fa-file-export',
				'Qu·∫£n l√Ω v√†ng': 'fas fa-wallet',
            };
            return icons[action] || 'fas fa-info-circle';
        }

        function getTimeAgo(timestamp) {
            const now = new Date();
            const time = new Date(timestamp);
            const diffInSeconds = Math.floor((now - time) / 1000);
            
            if (diffInSeconds < 60) return `${diffInSeconds} gi√¢y tr∆∞·ªõc`;
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} ph√∫t tr∆∞·ªõc`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} gi·ªù tr∆∞·ªõc`;
            if (diffInSeconds < 2592000) return `${Math.floor(diffInSeconds / 86400)} ng√†y tr∆∞·ªõc`;
            return `${Math.floor(diffInSeconds / 2592000)} th√°ng tr∆∞·ªõc`;
        }
		
		/**
         * M·ªü/ƒë√≥ng dropdown th√¥ng b√°o (t·ª´ new4)
         */
        function toggleNotifications() {
            const dropdown = document.getElementById('notifications-dropdown');
            const content = document.getElementById('notifications-content'); // L·∫•y div n·ªôi dung
            notificationsOpen = !notificationsOpen;
            
            if (notificationsOpen) {
                dropdown.classList.remove('hidden');
				allNotificationsLoaded = false;
                // T·∫£i trang 1 v√† Y√äU C·∫¶U reset (true)
                loadNotifications(1, true); 
                // Th√™m tr√¨nh nghe s·ª± ki·ªán cu·ªôn
                content.addEventListener('scroll', handleNotificationScroll);
            } else {
                dropdown.classList.add('hidden');
                // G·ª° b·ªè tr√¨nh nghe s·ª± ki·ªán cu·ªôn
                content.removeEventListener('scroll', handleNotificationScroll);
            }
        }
		
		/**
         * X·ª≠ l√Ω s·ª± ki·ªán cu·ªôn cho dropdown th√¥ng b√°o
         */
        function handleNotificationScroll() {
            const container = document.getElementById('notifications-content');
            
            // THAY ƒê·ªîI: Th√™m ƒëi·ªÅu ki·ªán !allNotificationsLoaded
            if (container.scrollTop + container.clientHeight >= container.scrollHeight - 20 && !isLoadingNotifications && !allNotificationsLoaded) {
                
                // T·∫£i trang ti·∫øp theo
                notificationLogPage++;
                loadNotifications(notificationLogPage, false); // T·∫£i trang N, KH√îNG reset
            }
        }

        /**
         * C·∫≠p nh·∫≠t s·ªë tr√™n badge th√¥ng b√°o (t·ª´ new4, adapt new5)
         */
        function updateNotificationBadge() {
            // N·∫øu logsData ch∆∞a t·∫£i xong l·∫ßn ƒë·∫ßu, KH√îNG L√ÄM G√å C·∫¢
            if (!initialLogsLoaded) {
                return;
            }
            
            const badge = document.getElementById('notification-badge');
            
            // L·∫•y t·∫•t c·∫£ log
            const allLogs = [...logsData, ...logQueue];
            
            // **THAY ƒê·ªîI CH√çNH: L·ªçc ra c√°c log CH∆ØA ƒê·ªåC**
            const unreadLogs = allLogs.filter(log => !readTimestamps.has(log.timestamp));
            const logCount = unreadLogs.length; // ƒê·∫øm s·ªë log ch∆∞a ƒë·ªçc
            
            if (logCount > 0) {
                badge.textContent = logCount > 99 ? '99+' : logCount; // Gi·ªõi h·∫°n 99+
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }
		
		/**
         * T·∫£i danh s√°ch timestamp ƒë√£ ƒë·ªçc t·ª´ localStorage v√†o Set
         */
        function loadReadTimestamps() {
            try {
                const stored = localStorage.getItem(READ_TIMESTAMPS_KEY);
                if (stored) {
                    const timestamps = JSON.parse(stored);
                    readTimestamps = new Set(timestamps);
                }
            } catch (e) {
                console.error('L·ªói t·∫£i danh s√°ch ƒë√£ ƒë·ªçc:', e);
                readTimestamps = new Set();
            }
        }

        /**
         * L∆∞u Set timestamp ƒë√£ ƒë·ªçc v√†o localStorage
         */
        function saveReadTimestamps() {
            try {
                // Chuy·ªÉn Set th√†nh Array ƒë·ªÉ l∆∞u JSON
                localStorage.setItem(READ_TIMESTAMPS_KEY, JSON.stringify([...readTimestamps]));
            } catch (e) {
                console.error('L·ªói l∆∞u danh s√°ch ƒë√£ ƒë·ªçc:', e);
            }
        }

        /**
         * (H√ÄM M·ªöI) X·ª≠ l√Ω khi click v√†o 1 th√¥ng b√°o
         * @param {string} timestamp - ID (timestamp) c·ªßa log
         */
        function toggleNotificationRead(timestamp) {
            // T√¨m ph·∫ßn t·ª≠ trong DOM
            const element = document.getElementById(`log-item-${timestamp}`);

            if (readTimestamps.has(timestamp)) {
                // N·∫øu ƒë√£ ƒë·ªçc -> ƒê√°nh d·∫•u ch∆∞a ƒë·ªçc
                readTimestamps.delete(timestamp);
                if (element) element.classList.remove('read');
            } else {
                // N·∫øu ch∆∞a ƒë·ªçc -> ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc
                readTimestamps.add(timestamp);
                if (element) element.classList.add('read');
            }
            
            saveReadTimestamps();       // L∆∞u l·∫°i
            updateNotificationBadge();  // C·∫≠p nh·∫≠t l·∫°i s·ªë tr√™n badge
        }

        /**
         * (H√ÄM M·ªöI) X·ª≠ l√Ω khi click "ƒê√°nh d·∫•u t·∫•t c·∫£ ƒë√£ ƒë·ªçc"
         */
        function markAllNotificationsAsRead() {
            const allLogs = [...logsData, ...logQueue];
            
            // Th√™m T·∫§T C·∫¢ timestamp v√†o Set
            allLogs.forEach(log => readTimestamps.add(log.timestamp));
            
            saveReadTimestamps();       // L∆∞u l·∫°i
            updateNotificationBadge();  // C·∫≠p nh·∫≠t badge (v·ªÅ 0)
            
            // C·∫≠p nh·∫≠t giao di·ªán cho t·∫•t c·∫£ c√°c item ƒëang hi·ªÉn th·ªã
            document.querySelectorAll('.notification-item').forEach(el => {
                el.classList.add('read');
            });

            showNotification('ƒê√£ ƒë√°nh d·∫•u t·∫•t c·∫£ l√† ƒë√£ ƒë·ªçc!', 'info');
        }

        /**
         * T·∫£i log v√†o dropdown v·ªõi t√≠nh nƒÉng "infinite scroll"
         * @param {number} page - Trang c·∫ßn t·∫£i (b·∫Øt ƒë·∫ßu t·ª´ 1)
         * @param {boolean} isReset - N·∫øu true, x√≥a n·ªôi dung c≈© v√† t·∫£i trang 1
         */
        async function loadNotifications(page = 1, isReset = false) {
            // NgƒÉn ch·∫∑n vi·ªác t·∫£i tr√πng l·∫∑p n·∫øu ƒëang cu·ªôn nhanh
            if (isLoadingNotifications && !isReset) return; 
            isLoadingNotifications = true;

            const container = document.getElementById('notifications-content');
            const logsPerPage = 20; // S·ªë log t·∫£i m·ªói l·∫ßn

            // 1. X·ª≠ l√Ω reset (khi m·ªü) ho·∫∑c x√≥a spinner c≈© (khi cu·ªôn)
            if (isReset) {
                notificationLogPage = 1; // ƒê·∫∑t l·∫°i b·ªô ƒë·∫øm trang
                container.innerHTML = '<div class="loading-spinner mx-auto my-4"></div>';
            } else {
                // X√≥a spinner "ƒëang t·∫£i th√™m" c≈©
                const oldLoader = container.querySelector('.notification-loader');
                if (oldLoader) oldLoader.remove();
            }

            // 2. L·∫•y d·ªØ li·ªáu (logic c≈©)
            const allLogs = [...logsData, ...logQueue.map(log => ({...log, saved: false}))];
            const sortedLogs = allLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // 3. T√≠nh to√°n trang
            const startIndex = (page - 1) * logsPerPage;
            const endIndex = startIndex + logsPerPage;
            const logsToDisplay = sortedLogs.slice(startIndex, endIndex);

            // 4. X·ª≠ l√Ω khi kh√¥ng c√≥ d·ªØ li·ªáu
            // --- B·∫ÆT ƒê·∫¶U TH√äM M·ªöI ---
            let specialNotificationsHtml = '';

            // 1. Th√™m S·ª± ki·ªán S·∫Øp t·ªõi
            if (isReset && upcomingEventInfo && upcomingEventInfo.diff > 0) {
                specialNotificationsHtml += `
                    <div class="notification-item p-3 border-b border-custom" style="background-color: var(--accent-color); opacity: 1;">
                        <div class="flex items-start space-x-3">
                            <div class="text-primary mt-1"><i class="fas fa-calendar-check"></i></div>
                            <div class="flex-1" style="min-width: 0;">
                                <p class="text-sm text-primary font-medium" style="overflow-wrap: break-word;">S·ª± ki·ªán s·∫Øp t·ªõi</p>
                                <p class="text-xs text-custom" style="overflow-wrap: break-word;">${upcomingEventInfo.diff} ng√†y n·ªØa: ${escapeHtml(upcomingEventInfo.name)}</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            // 2. Th√™m "Ng√†y N√†y NƒÉm X∆∞a"
            if (isReset && todayValidMemories && todayValidMemories.length > 0) {
                todayValidMemories.forEach(event => {
                    const yearsAgo = new Date().getFullYear() - new Date(convertDateFormat(event.day)).getFullYear();
                    const eventIdForScroll = event.note_id || event.day;

                    specialNotificationsHtml += `
                    <div class="notification-item p-3 border-b border-custom cursor-pointer hover:bg-gray-100" style="background-color: var(--accent-color); opacity: 1;" 
                         onclick="scrollToEvent('${eventIdForScroll}'); toggleNotifications();">
                        <div class="flex items-start space-x-3">
                            <div class="text-secondary mt-1"><i class="fas fa-calendar-day"></i></div>
                            <div class="flex-1" style="min-width: 0;">
                                <p class="text-sm text-secondary font-medium" style="overflow-wrap: break-word;">Ng√†y N√†y NƒÉm X∆∞a (${yearsAgo} nƒÉm)</p>
                                <p class="text-xs text-custom" style="overflow-wrap: break-word;">${escapeHtml(event.name)}</p>
                            </div>
                        </div>
                    </div>
                    `;
                });
            }

            // 3. X·ª≠ l√Ω khi kh√¥ng c√≥ D·ªÆ LI·ªÜU N√ÄO (c·∫£ ƒë·∫∑c bi·ªát v√† log)
            if (isReset && logsToDisplay.length === 0 && specialNotificationsHtml === '') {
                 container.innerHTML = '<div class="p-4 text-center text-gray-500">Kh√¥ng c√≥ ho·∫°t ƒë·ªông n√†o</div>';
                 isLoadingNotifications = false;
                 return;
            }
            // --- K·∫æT TH√öC TH√äM M·ªöI ---
            
            // N·∫øu kh√¥ng ph·∫£i reset v√† kh√¥ng c√≥ log m·ªõi (ƒë√£ t·∫£i ƒë·∫øn cu·ªëi)
            if (!isReset && logsToDisplay.length === 0) {
                container.innerHTML += '<div class="p-2 text-center text-xs text-gray-500">ƒê√£ t·∫£i t·∫•t c·∫£.</div>';
                isLoadingNotifications = false;
				allNotificationsLoaded = true;
                return;
            }

            // 5. T·∫°o HTML (logic c≈©)
            const notificationsHtml = logsToDisplay.map(log => { 
				const timeAgo = getTimeAgo(log.timestamp);
				const icon = getActionIcon(log.action);
				const isRead = readTimestamps.has(log.timestamp); // Ki·ªÉm tra ƒë√£ ƒë·ªçc?
				
				// D√πng timestamp l√†m ID (ph·∫£i escape ƒë·ªÉ an to√†n)
				const safeTimestamp = escapeHtml(log.timestamp); 

				return `
					<div id="log-item-${safeTimestamp}" 
						 class="notification-item p-2 border-b border-custom hover:bg-gray-100 transition-colors cursor-pointer ${isRead ? 'read' : ''}" 
						 onclick="toggleNotificationRead('${safeTimestamp}')"> 
						<div class="flex items-start space-x-3">
							<div class="text-primary mt-1"><i class="${icon}"></i></div>
							
							<div class="flex-1" style="min-width: 0;">
								
								<p class="text-sm text-custom font-medium" style="overflow-wrap: break-word;">${escapeHtml(log.action)}</p>
								
								<p class="text-xs text-gray-600" style="overflow-wrap: break-word;">${escapeHtml(log.details)}</p>
								
								<div class="flex items-center justify-between mt-1">
									<span class="text-xs text-gray-500">${timeAgo}</span>
								</div>
							</div>
						</div>
					</div>
				`;
            }).join('');

            // 6. Th√™m HTML v√†o container (KH√ÅC BI·ªÜT CH√çNH)
            if (isReset) {
                container.innerHTML = specialNotificationsHtml + notificationsHtml; // Thay th·∫ø (cho trang 1)
            } else {
                container.innerHTML += notificationsHtml; // N·ªëi th√™m (cho trang 2+)
            }

            // 7. Th√™m spinner "ƒëang t·∫£i th√™m" n·∫øu v·∫´n c√≤n log
            if (endIndex < sortedLogs.length) {
                container.innerHTML += '<div class="notification-loader loading-spinner mx-auto my-4"></div>';
            }

            // 8. ƒê√°nh d·∫•u l√† ƒë√£ t·∫£i xong
            isLoadingNotifications = false;
        }
		

        function filterLogs(containerId = 'logsContainer', filterId = 'logFilter') {
            loadLogsToModal(containerId, filterId);
        }

        async function clearAllLogs(containerId = 'logsContainer', filterId = 'logFilter') {
            const confirmClear = await showCustomConfirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t·∫•t c·∫£ nh·∫≠t k√Ω ho·∫°t ƒë·ªông?');
            
            if (!confirmClear) {
                return; // Ng∆∞·ªùi d√πng ƒë√£ h·ªßy
            }

            // --- 1. L∆ØU TR·∫†NG TH√ÅI C≈® ƒê·ªÇ ROLLBACK ---
            const oldLogsData = [...logsData];
            const oldLogQueue = [...logQueue];

            // --- 2. C·∫¨P NH·∫¨T L·∫†C QUAN (OPTIMISTIC UPDATE) ---
            // X√≥a d·ªØ li·ªáu local ngay l·∫≠p t·ª©c
            logsData = [];
            logQueue = [];
            readTimestamps.clear(); // X√≥a b·ªô nh·ªõ "ƒë√£ ƒë·ªçc"

            // C·∫≠p nh·∫≠t UI ngay l·∫≠p t·ª©c
            loadLogsToModal(containerId, filterId); // Hi·ªÉn th·ªã modal tr·ªëng
            updateTotalLogs();                      // C·∫≠p nh·∫≠t s·ªë ƒë·∫øm v·ªÅ 0
            updateNotificationBadge();              // C·∫≠p nh·∫≠t badge v·ªÅ 0
            saveReadTimestamps();                   // L∆∞u l·∫°i tr·∫°ng th√°i "ƒë√£ ƒë·ªçc" (r·ªóng)
            
            showNotification('ƒê√£ x√≥a t·∫•t c·∫£ nh·∫≠t k√Ω!', 'success');

            // --- 3. ƒê·ªíNG B·ªò N·ªÄN (BACKGROUND SYNC) ---
            (async () => {
                try {
                    const success = await githubAPI.updateFile(
                        config.LOGS_FILE_PATH,
                        logsData, // G·ª≠i m·∫£ng r·ªóng
                        'X√≥a t·∫•t c·∫£ nh·∫≠t k√Ω ho·∫°t ƒë·ªông'
                    );
                    
                    if (!success) {
                        throw new Error("API update failed"); // K√≠ch ho·∫°t kh·ªëi catch
                    }
                    // N·∫øu th√†nh c√¥ng: kh√¥ng c·∫ßn l√†m g√¨, UI ƒë√£ ƒë√∫ng.
                    console.log("ƒê·ªìng b·ªô (x√≥a) nh·∫≠t k√Ω th√†nh c√¥ng.");

                } catch (error) {
                    // --- 4. ROLLBACK (HO√ÄN T√ÅC N·∫æU L·ªñI) ---
                    console.error('L·ªói khi ƒë·ªìng b·ªô (x√≥a) nh·∫≠t k√Ω:', error);
                    showNotification('L·ªói ƒë·ªìng b·ªô! ƒêang ho√†n t√°c...', 'error');
                    
                    // Kh√¥i ph·ª•c d·ªØ li·ªáu
                    logsData = oldLogsData;
                    logQueue = oldLogQueue;
                    // (Kh√¥ng c·∫ßn kh√¥i ph·ª•c readTimestamps, v√¨ log ƒë√£ quay l·∫°i)
                    
                    // T·∫£i l·∫°i UI v·ªÅ tr·∫°ng th√°i c≈©
                    loadLogsToModal(containerId, filterId);
                    updateTotalLogs();
                    updateNotificationBadge();
                }
            })();
        }

        function exportLogs(filterId = 'logFilter') {
            try {
                const filter = document.getElementById(filterId)?.value || 'all';
                let exportData = logsData;
                
                if (filter !== 'all') {
                    exportData = logsData.filter(log => log.action === filter);
                }
                
                // Create CSV content
                const csvContent = [
                    ['Th·ªùi gian', 'H√†nh ƒë·ªông', 'Chi ti·∫øt', 'Session ID'].join(','),
                    ...exportData.map(log => [
                        `"${formatDateToDDMMYYHHMMSS(log.timestamp)}"`,
                        `"${log.action}"`,
                        `"${log.details.replace(/"/g, '""')}"`,
                        `"${log.sessionId}"`
                    ].join(','))
                ].join('\n');
                
                // Create and download file
                const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `nhat-ky-hoat-dong-${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification(`ƒê√£ xu·∫•t ${exportData.length} b·∫£n ghi nh·∫≠t k√Ω!`, 'success');
                addLog('Xu·∫•t nh·∫≠t k√Ω', `ƒê√£ xu·∫•t ${exportData.length} b·∫£n ghi nh·∫≠t k√Ω ra file CSV`);
                
            } catch (error) {
                console.error('Error exporting logs:', error);
                showNotification('L·ªói khi xu·∫•t nh·∫≠t k√Ω!', 'error');
            }
        }

        function showNotification(message, type = 'info') {
            if (!config.ENABLE_NOTI) return;
			
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white z-50 ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }



        // Load image selector when modal opens
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('show');
            if (modalId === 'eventModal' && !editingEventId) {
                // Reset form only when adding new event
                resetEventForm();
            } else if (modalId === 'profileModal') {
                // T·∫£i d·ªØ li·ªáu ng∆∞·ªùi d√πng hi·ªán t·∫°i v√†o modal
                if (currentUser) {
                    document.getElementById('profileNameInput').value = currentUser.name;
                    document.getElementById('profileUsernameInput').value = currentUser.username;
                    document.getElementById('profileAvatarImg').src = currentUser.avatarUrl;
                }
            }
            
            // Log modal opening
            const modalNames = {
                'searchModal': 'T√¨m ki·∫øm & AI',
                'profileModal': 'H·ªì s∆° c√° nh√¢n',
                'eventModal': editingEventId ? 'S·ª≠a s·ª± ki·ªán' : 'Th√™m s·ª± ki·ªán m·ªõi',
                'photoModal': 'Xem ·∫£nh chi ti·∫øt',
                'shareModal': 'Chia s·∫ª ·∫£nh',
                'eventPhotosModal': 'Xem ·∫£nh s·ª± ki·ªán',
                'logsModal': 'Nh·∫≠t k√Ω ho·∫°t ƒë·ªông'
                // ƒê√É X√ìA 'notificationModal'
            };
            
            if (modalNames[modalId]) {
                addLog('M·ªü modal', `ƒê√£ m·ªü "${modalNames[modalId]}"`);
            }
            
            // Load logs when opening logs modal
            if (modalId === 'logsModal') {
                loadLogsToModal('logsContainer', 'logFilter');
            }
            // ƒê√É X√ìA 'notificationModal'
        }
		
		function getPagePhotos(page) {
            // S·ª≠a l·ªói parseInt v√† g√°n m·∫∑c ƒë·ªãnh
            const photosPerPage = parseInt(config.PHOTOS_PER_PAGE || 30);
            const startIndex = (page - 1) * photosPerPage;
            const endIndex = startIndex + photosPerPage;
            
            // Lu√¥n s·∫Øp x·∫øp theo t√™n (A-Z) tr∆∞·ªõc khi c·∫Øt
            const sortedPhotos = [...photosData].sort((a, b) => a.name.localeCompare(b.name));
            
            // Tr·∫£ v·ªÅ m·∫£ng ·∫£nh c·ªßa trang hi·ªán t·∫°i
            return sortedPhotos.slice(startIndex, endIndex);
        }
		
		function renderPhotoSelector() {
			const container = document.getElementById('photo-selector-grid');
			
			const pagePhotos = getPagePhotos(photoSelectorPage);
		
			if (photoSelectorViewMode === 'list') {
				container.className = 'grid-list space-y-2'; // Th√™m space-y
				container.innerHTML = `
					${pagePhotos.map(photo => {
						const isSelected = selectedPhotos.has(photo.name);
						return `
							<div class="relative flex items-center space-x-4 p-3 bg-accent rounded-lg hover:bg-gray-100 transition-colors duration-200 ${isSelected ? 'bg-green-50 border border-green-200' : ''}" onclick="togglePhotoSelection('${photo.name}')">
								<img src="${driveAPI.getImageUrl(photo.id, 'thumbnail')}" alt="${photo.name}" class="w-12 h-12 object-cover rounded flex-shrink-0"
									 onerror="this.src='${imageErrorPlaceholder}';">
								<div class="flex-1">
									<h4 class="font-medium text-custom">${photo.name}</h4>
									<p class="text-sm text-gray-500">K√≠ch th∆∞·ªõc: ${formatFileSize(photo.size) || 'N/A'}</p>
								</div>
								<div class="flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center text-sm ${isSelected ? 'bg-primary text-white' : 'bg-gray-300 text-gray-600 border-2 border-gray-400'}">
									<i class="fas fa-check"></i>
								</div>
							</div>
						`;
					}).join('')}
				`;
			} else {
				const gridClass = `grid-${photoSelectorViewMode.split('-')[1]}x${photoSelectorViewMode.split('-')[1]}`;
				container.className = `grid gap-3 ${gridClass}`; // G√°n l·∫°i class grid
				container.innerHTML = `
					${pagePhotos.map(photo => {
						const isSelected = selectedPhotos.has(photo.name);
						return `
							<div class="photo-selector-item ${isSelected ? 'selected' : ''}" onclick="togglePhotoSelection('${photo.name}')">
								<img src="${driveAPI.getImageUrl(photo.id, 'thumbnail')}" alt="${photo.name}" class="w-full h-full object-cover"
									 onerror="this.src='${imageErrorPlaceholder}';">
								<div class="photo-checkbox ${isSelected ? 'selected' : 'unselected'}">
									<i class="fas fa-check"></i>
								</div>
							</div>
						`;
					}).join('')}
				`;
			}
    
			renderPhotoSelectorPagination();
		}
		
		
 
		function renderPhotoSelectorPagination() {
			const container = document.getElementById('photo-selector-pagination');
			// S·ª≠a l·ªói: d√πng config.PHOTOS_PER_PAGE
			const totalPages = Math.ceil(photosData.length / parseInt(config.PHOTOS_PER_PAGE));
			
			if (totalPages <= 1) {
				container.innerHTML = '';
				return;
			}
		
			container.innerHTML = `
				<div class="flex items-center justify-center space-x-4">
					<button onclick="changePhotoSelectorPage(${photoSelectorPage - 1})" 
							class="love-button text-sm ${photoSelectorPage <= 1 ? 'opacity-50 cursor-not-allowed' : ''}" 
							${photoSelectorPage <= 1 ? 'disabled' : ''}>
						<i class="fas fa-chevron-left"></i>
					</button>
					
					<div class="px-4 py-2 bg-accent text-custom rounded-lg font-medium">
						Trang ${photoSelectorPage} / ${totalPages}
					</div>
					
					<button onclick="changePhotoSelectorPage(${photoSelectorPage + 1})" 
							class="love-button text-sm ${photoSelectorPage >= totalPages ? 'opacity-50 cursor-not-allowed' : ''}" 
							${photoSelectorPage >= totalPages ? 'disabled' : ''}>
						<i class="fas fa-chevron-right"></i>
					</button>
				</div>
			`;
	}
 
	function changePhotoSelectorPage(page) {
		photoSelectorPage = page;
		renderPhotoSelector(); // D√πng h√†m render m·ªõi
	}
 
	function selectAllPhotos() {
		// L·∫•y CH·ªà C√ÅC ·∫£nh tr√™n trang hi·ªán t·∫°i
		const pagePhotos = getPagePhotos(photoSelectorPage);
		
		// Th√™m ch√∫ng v√†o Set
		pagePhotos.forEach(photo => selectedPhotos.add(photo.name));
		
		// V·∫Ω l·∫°i modal ƒë·ªÉ hi·ªÉn th·ªã c√°c m·ª•c ƒë√£ ch·ªçn
		renderPhotoSelector(); 
		
		// C·∫≠p nh·∫≠t s·ªë ƒë·∫øm
		document.getElementById('selectedImagesCount').textContent = selectedPhotos.size;
	}
 
	function deselectAllPhotos() {
		// L·∫•y CH·ªà C√ÅC ·∫£nh tr√™n trang hi·ªán t·∫°i
		const pagePhotos = getPagePhotos(photoSelectorPage);
		
		// X√≥a ch√∫ng kh·ªèi Set
		pagePhotos.forEach(photo => selectedPhotos.delete(photo.name));
		
		// V·∫Ω l·∫°i modal ƒë·ªÉ hi·ªÉn th·ªã c√°c m·ª•c ƒë√£ h·ªßy ch·ªçn
		renderPhotoSelector(); 
		
		// C·∫≠p nh·∫≠t s·ªë ƒë·∫øm
		document.getElementById('selectedImagesCount').textContent = selectedPhotos.size;
	}
 
	function confirmPhotoSelection() {
		// C·∫≠p nh·∫≠t count (t·ª´ new5.html)
		document.getElementById('selectedImagesCount').textContent = selectedPhotos.size;
		
		// ƒê√≥ng modal (t·ª´ new5.html)
		closeModal('imageSelectorModal');
	}

	// (T·ª™ NEW4.HTML) Thay th·∫ø cho toggleImageSelection
	function togglePhotoSelection(photoName) {
		if (selectedPhotos.has(photoName)) {
			selectedPhotos.delete(photoName);
		} else {
			selectedPhotos.add(photoName);
		}
		renderPhotoSelector(); // D√πng h√†m render m·ªõi
		
		// C·∫≠p nh·∫≠t count (t·ª´ new5.html)
		// S·ª≠a l·ªói: d√πng selectedPhotos.size
		document.getElementById('selectedImagesCount').textContent = selectedPhotos.size;
	}

	// (T·ª™ NEW4.HTML) Thay th·∫ø cho cycleModalView v√† updateModalViewToggleButton
	function toggleViewMode() {
		const modes = Object.keys(viewConfig);
		const currentIndex = modes.indexOf(photoSelectorViewMode);
		const nextIndex = (currentIndex + 1) % modes.length;
		photoSelectorViewMode = modes[nextIndex];
		
		// Update button
		const btn = document.getElementById('view-toggle-btn');
		const config = viewConfig[photoSelectorViewMode];
		btn.innerHTML = `<i class="${config.icon} mr-2"></i>${config.text}`;
		
		renderPhotoSelector(); // D√πng h√†m render m·ªõi
	}
        // Photo interaction functions
        function loadPhotoLikes(photoName) {
            const photoComments = commentsData.find(c => c.ID_IMG === photoName);
            const likeButton = document.getElementById('likeButton');
            const likeIcon = document.getElementById('likeIcon');
            const likeText = document.getElementById('likeText');
            const likeCount = document.getElementById('likeCount');
            
            let likes = [];
            let isLiked = false;
            
            if (photoComments && photoComments.tim && Array.isArray(photoComments.tim)) {
                likes = photoComments.tim;
                isLiked = likes.some(like => like.userName === currentUser.username);
            }
            
            // Update UI
            likeCount.textContent = likes.length;
            if (isLiked) {
                likeIcon.className = 'fas fa-heart mr-2 text-white';
                likeText.textContent = 'Th√≠ch';
                likeButton.classList.remove('bg-primary', 'hover:opacity-90', 'hover:translate-y-[-1px]'); 
                 
                likeButton.style.backgroundColor = '#ff0000';
                likeButton.style.color = 'white';
                
            } else {
                likeIcon.className = 'fas fa-heart mr-2';
                likeText.textContent = 'Th√≠ch';
                likeButton.classList.add('bg-primary', 'hover:opacity-90', 'hover:translate-y-[-1px]');
                likeButton.style.backgroundColor = ''; 
                likeButton.style.color = '';
            }
        }

        async function toggleLike() {
            if (!currentPhotoName || !currentUser) return;

            // 1. T√¨m ho·∫∑c t·∫°o m·ª•c nh·∫≠p cho ·∫£nh
            let photoComments = commentsData.find(c => c.ID_IMG === currentPhotoName);
            if (!photoComments) {
                photoComments = {
                    ID_IMG: currentPhotoName,
                    tim: [],
                    comments: []
                };
                commentsData.push(photoComments);
            }
            if (!photoComments.tim) photoComments.tim = [];

            // 2. X√°c ƒë·ªãnh h√†nh ƒë·ªông (like hay unlike)
            const existingLikeIndex = photoComments.tim.findIndex(like => like.userName === currentUser.username);
            const isLiking = existingLikeIndex === -1;
            
            // 3. --- C·∫¨P NH·∫¨T L·∫†C QUAN (OPTIMISTIC UPDATE) ---
            // Th·ª±c hi·ªán thay ƒë·ªïi tr√™n d·ªØ li·ªáu local TR∆Ø·ªöC
            if (isLiking) {
                photoComments.tim.push({ userName: currentUser.username });
                showNotification('ƒê√£ th√≠ch ·∫£nh!', 'success');
            } else {
                photoComments.tim.splice(existingLikeIndex, 1);
                showNotification('ƒê√£ b·ªè th√≠ch!', 'info');
            }

            // C·∫≠p nh·∫≠t UI ngay l·∫≠p t·ª©c
            loadPhotoLikes(currentPhotoName); // C·∫≠p nh·∫≠t n√∫t trong modal
            loadPhotos(currentPage);          // C·∫≠p nh·∫≠t s·ªë ƒë·∫øm tr√™n l∆∞·ªõi ·∫£nh
            addLog('T∆∞∆°ng t√°c ·∫£nh', `ƒê√£ ${isLiking ? 'th√≠ch' : 'b·ªè th√≠ch'} ·∫£nh "${currentPhotoName}"`);

            // 4. --- ƒê·ªíNG B·ªò N·ªÄN (BACKGROUND SYNC) ---
            try {
                const success = await githubAPI.updateFile(
                    config.COMMENTS_FILE_PATH,
                    commentsData,
                    `C·∫≠p nh·∫≠t l∆∞·ª£t th√≠ch cho ·∫£nh: ${currentPhotoName}`
                );

                if (!success) {
                    // 5. --- ROLLBACK (N·∫æU TH·∫§T B·∫†I) ---
                    // Ho√†n t√°c l·∫°i thay ƒë·ªïi tr√™n d·ªØ li·ªáu local
                    if (isLiking) {
                        photoComments.tim.pop(); // X√≥a like v·ª´a th√™m
                    } else {
                        // Th√™m l·∫°i like v·ª´a x√≥a (kh√≥ h∆°n, nh∆∞ng v√¨ l√† currentUser n√™n c√≥ th·ªÉ gi·∫£ ƒë·ªãnh)
                        // Trong k·ªãch b·∫£n n√†y, ch√∫ng ta b·ªè qua vi·ªác th√™m l·∫°i ph·ª©c t·∫°p
                        // v√† ch·ªâ th√¥ng b√°o l·ªói
                    }
                    
                    showNotification('L·ªói khi c·∫≠p nh·∫≠t! Vui l√≤ng th·ª≠ l·∫°i.', 'error');
                    
                    // T·∫£i l·∫°i UI v·ªÅ tr·∫°ng th√°i c≈© (tr∆∞·ªõc khi b·∫•m)
                    loadPhotoLikes(currentPhotoName);
                    loadPhotos(currentPage);
                }
                // N·∫øu th√†nh c√¥ng, kh√¥ng c·∫ßn l√†m g√¨ c·∫£ v√¨ UI ƒë√£ ƒë√∫ng

            } catch (error) {
                console.error('Error toggling like:', error);
                showNotification('L·ªói khi th√≠ch ·∫£nh!', 'error');
                // Th·ª±c hi·ªán rollback n·∫øu c√≥ l·ªói
                if (isLiking) photoComments.tim.pop();
                loadPhotoLikes(currentPhotoName);
                loadPhotos(currentPage);
            }
        }

        function handleCommentKeyPress(event) {
            if (event.key === 'Enter') {
                addComment();
            }
        }

        async function addComment() {
            const commentInput = document.getElementById('commentInput');
            const comment = commentInput.value.trim();
            
            if (!comment || !currentPhotoName || !currentUser) return;

            // 1. T√¨m ho·∫∑c t·∫°o m·ª•c nh·∫≠p
            let photoComments = commentsData.find(c => c.ID_IMG === currentPhotoName);
            if (!photoComments) {
                photoComments = {
                    ID_IMG: currentPhotoName,
                    tim: [],
                    comments: []
                };
                commentsData.push(photoComments);
            }
            if (!photoComments.comments) photoComments.comments = [];

            // 2. T·∫°o ƒë·ªëi t∆∞·ª£ng b√¨nh lu·∫≠n m·ªõi
            const newComment = {
                comment: comment,
                date_input: new Date().toISOString(),
                userName: currentUser.username
            };

            // 3. --- C·∫¨P NH·∫¨T L·∫†C QUAN (OPTIMISTIC UPDATE) ---
            // Th√™m b√¨nh lu·∫≠n v√†o d·ªØ li·ªáu local TR∆Ø·ªöC
            photoComments.comments.push(newComment);
            
            // C·∫≠p nh·∫≠t UI ngay l·∫≠p t·ª©c
            commentInput.value = ''; // X√≥a √¥ nh·∫≠p li·ªáu
            loadPhotoComments(currentPhotoName); // T·∫£i l·∫°i danh s√°ch b√¨nh lu·∫≠n
            loadPhotos(currentPage); // C·∫≠p nh·∫≠t s·ªë ƒë·∫øm tr√™n l∆∞·ªõi ·∫£nh
            showNotification('ƒê√£ th√™m b√¨nh lu·∫≠n!', 'success');
            addLog('B√¨nh lu·∫≠n ·∫£nh', `ƒê√£ b√¨nh lu·∫≠n v√†o ·∫£nh "${currentPhotoName}"`);

            // 4. --- ƒê·ªíNG B·ªò N·ªÄN (BACKGROUND SYNC) ---
            try {
                const success = await githubAPI.updateFile(
                    config.COMMENTS_FILE_PATH,
                    commentsData,
                    `Th√™m b√¨nh lu·∫≠n cho ·∫£nh: ${currentPhotoName}`
                );

                if (!success) {
                    // 5. --- ROLLBACK (N·∫æU TH·∫§T B·∫†I) ---
                    // X√≥a b√¨nh lu·∫≠n v·ª´a th√™m kh·ªèi d·ªØ li·ªáu local
                    photoComments.comments.pop();
                    
                    showNotification('L·ªói khi th√™m b√¨nh lu·∫≠n! Vui l√≤ng th·ª≠ l·∫°i.', 'error');
                    
                    // T·∫£i l·∫°i UI v·ªÅ tr·∫°ng th√°i c≈©
                    loadPhotoComments(currentPhotoName);
                    loadPhotos(currentPage);
                    commentInput.value = comment; // Tr·∫£ l·∫°i text cho ng∆∞·ªùi d√πng
                }
                // N·∫øu th√†nh c√¥ng, kh√¥ng c·∫ßn l√†m g√¨

            } catch (error) {
                console.error('Error adding comment:', error);
                showNotification('L·ªói khi th√™m b√¨nh lu·∫≠n!', 'error');
                
                // Rollback n·∫øu c√≥ l·ªói
                photoComments.comments.pop();
                loadPhotoComments(currentPhotoName);
                loadPhotos(currentPage);
                commentInput.value = comment;
            }
        }

        function openShareModal() {
            if (!currentPhotoId) return;
            
            // Set share link to Google Drive original link
            const originalLink = `https://drive.google.com/file/d/${currentPhotoId}/view`;
            document.getElementById('shareLink').value = originalLink;
            
            // Reset QR code
            document.getElementById('qrCodeContainer').classList.add('hidden');
            
            openModal('shareModal');
        }

        function copyShareLink() {
            const shareLink = document.getElementById('shareLink');
            
            // Fallback method for older browsers or when clipboard API fails
            try {
                // Try modern clipboard API first
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(shareLink.value).then(() => {
                        showNotification('ƒê√£ copy link chia s·∫ª!', 'success');
                    }).catch(() => {
                        fallbackCopyTextToClipboard(shareLink.value);
                    });
                } else {
                    fallbackCopyTextToClipboard(shareLink.value);
                }
            } catch (error) {
                fallbackCopyTextToClipboard(shareLink.value);
            }
        }

        function fallbackCopyTextToClipboard(text) {
            // Create temporary textarea element
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            
            try {
                textArea.focus();
                textArea.select();
                const successful = document.execCommand('copy');
                if (successful) {
                    showNotification('ƒê√£ copy link chia s·∫ª!', 'success');
                } else {
                    showNotification('Kh√¥ng th·ªÉ copy link. Vui l√≤ng copy th·ªß c√¥ng!', 'error');
                }
            } catch (error) {
                showNotification('Kh√¥ng th·ªÉ copy link. Vui l√≤ng copy th·ªß c√¥ng!', 'error');
            } finally {
                document.body.removeChild(textArea);
            }
        }

        function shareToFacebook() {
            const shareLink = document.getElementById('shareLink').value;
            const facebookUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareLink)}`;
            window.open(facebookUrl, '_blank', 'noopener,noreferrer');
        }

        function shareToTwitter() {
            const shareLink = document.getElementById('shareLink').value;
            const twitterUrl = `https://twitter.com/intent/tweet?url=${encodeURIComponent(shareLink)}&text=${encodeURIComponent('Xem ·∫£nh n√†y!')}`;
            window.open(twitterUrl, '_blank', 'noopener,noreferrer');
        }

        function shareToTelegram() {
            const shareLink = document.getElementById('shareLink').value;
            const telegramUrl = `https://t.me/share/url?url=${encodeURIComponent(shareLink)}&text=${encodeURIComponent('Xem ·∫£nh n√†y!')}`;
            window.open(telegramUrl, '_blank', 'noopener,noreferrer');
        }

        function generateQRCode() {
            const shareLink = document.getElementById('shareLink').value;
            const qrContainer = document.getElementById('qrCodeContainer');
            const qrImage = document.getElementById('qrCodeImage');
            
            // Use QR Server API to generate QR code
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(shareLink)}`;
            
            qrImage.src = qrUrl;
            qrContainer.classList.remove('hidden');
            
            showNotification('ƒê√£ t·∫°o m√£ QR!', 'success');
        }

        async function downloadPhoto() {
            if (!currentPhotoId || !currentPhotoName) return;
            
            try {
                // Use Google Drive view URL for download (same as share link)
                const downloadUrl = `https://drive.google.com/file/d/${currentPhotoId}/view`;
                
                // Create download link that opens in new tab
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.target = '_blank';
                link.rel = 'noopener noreferrer';
                
                // Trigger download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification('ƒê√£ m·ªü trang t·∫£i ·∫£nh!', 'success');
                addLog('T·∫£i ·∫£nh', `ƒê√£ m·ªü trang t·∫£i ·∫£nh "${currentPhotoName}"`);
                
            } catch (error) {
                console.error('Error downloading photo:', error);
                showNotification('L·ªói khi m·ªü trang t·∫£i ·∫£nh!', 'error');
            }
        }

        // Close modals when clicking outside
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('show');
            }
        });

        // Logic click ra ngo√†i ƒë·ªÉ ƒë√≥ng menu (v·∫´n gi·ªØ nguy√™n nh∆∞ng ƒë∆°n gi·∫£n h∆°n)
        document.addEventListener('click', function(event) {
            const menuIcons = document.getElementById('headerMenuIcons');
            const header = document.querySelector('header');

            // N·∫øu click ra ngo√†i khu v·ª±c header v√† menu ƒëang hi·ªán -> ƒë√≥ng menu
            if (!header.contains(event.target) && !menuIcons.classList.contains('hidden')) {
                closeHeaderMenu();
            }
        });

		/**
         * M·ªü ho·∫∑c ƒë√≥ng menu cho m·ªôt s·ª± ki·ªán
         * @param {string} eventId - ID c·ªßa s·ª± ki·ªán (event.note_id)
         */
        function toggleEventMenu(eventId) {
            const menu = document.getElementById(`menu-${eventId}`);
            if (!menu) return;

            const isHidden = menu.classList.contains('hidden');
            
            // 1. ·∫®n t·∫•t c·∫£ c√°c menu kh√°c
            document.querySelectorAll('[id^="menu-"]').forEach(m => {
                if (m.id !== `menu-${eventId}`) {
                    m.classList.add('hidden');
                }
            });
            
            // 2. B·∫≠t/t·∫Øt menu hi·ªán t·∫°i
            if (isHidden) {
                menu.classList.remove('hidden');
            } else {
                menu.classList.add('hidden');
            }
        }

        /**
         * ·∫®n m·ªôt menu c·ª• th·ªÉ (th∆∞·ªùng g·ªçi sau khi nh·∫•p v√†o m·ªôt t√πy ch·ªçn)
         * @param {string} eventId - ID c·ªßa s·ª± ki·ªán (event.note_id)
         */
        function hideEventMenu(eventId) {
            const menu = document.getElementById(`menu-${eventId}`);
            if (menu) {
                menu.classList.add('hidden');
            }
        }

        /**
         * Tr√¨nh l·∫Øng nghe s·ª± ki·ªán to√†n c·ª•c:
         * ƒê√≥ng t·∫•t c·∫£ c√°c menu 3 ch·∫•m n·∫øu nh·∫•p ra b√™n ngo√†i
         */
        document.addEventListener('click', function(e) {
            // 1. Logic ƒë√≥ng menu 3 ch·∫•m (event menu)
            if (!e.target.closest('[onclick*="toggleEventMenu"]') && !e.target.closest('[id^="menu-"]')) {
                document.querySelectorAll('[id^="menu-"]').forEach(menu => {
                    menu.classList.add('hidden');
                });
            }
			
			// üî• TH√äM LOGIC N√ÄY: ƒê√≥ng menu 3 ch·∫•m (photo modal)
			const photoMenu = document.getElementById('photoActionsMenu');
			if (photoMenu && !photoMenu.classList.contains('hidden')) {
				// N·∫øu click ra ngo√†i n√∫t 3 ch·∫•m V√Ä ra ngo√†i menu
				if (!e.target.closest('[onclick*="togglePhotoActionsMenu"]') && !e.target.closest('#photoActionsMenu')) {
					photoMenu.classList.add('hidden');
				}
			}

            // 2. Logic ƒë√≥ng dropdown th√¥ng b√°o (t·ª´ new4)
            const dropdown = document.getElementById('notifications-dropdown');
            if (notificationsOpen && dropdown && !dropdown.contains(e.target) && !e.target.closest('button[onclick="toggleNotifications()"]')) {
                toggleNotifications();
            }
			
			// 3. Logic ƒë√≥ng dropdown L·ªçc S·ª± Ki·ªán
            const filterDropdown = document.getElementById('filterDropdown');
            if (filterDropdown && !filterDropdown.classList.contains('hidden')) {
                // N·∫øu click ra ngo√†i n√∫t filter V√Ä ra ngo√†i dropdown
                if (!e.target.closest('button[onclick="toggleFilterDropdown()"]') && !e.target.closest('#filterDropdown')) {
                    filterDropdown.classList.add('hidden');
                }
            }
			
        });
		
		/**
         * X·ª≠ l√Ω d·ªØ li·ªáu th√¥ t·ª´ gold_history.json (ƒê√£ c·∫≠p nh·∫≠t ƒë·ªÉ l·∫•y Min/Max/Last)
         */
        function processGoldDataForLineChart(rawData) {
            const productName = "Nh·∫´n Tr√≤n 9999 H∆∞ng Th·ªãnh V∆∞·ª£ng";
            const product = Array.isArray(rawData) ? rawData.find(p => p.product_name === productName) : null;
            
            if (!product || !product.gia || product.gia.length === 0) {
                console.warn("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu gi√° v√†ng ƒë·ªÉ v·∫Ω bi·ªÉu ƒë·ªì.");
                return { buySeries: [], sellSeries: [] };
            }

            // 1. Nh√≥m gi√° (S·∫Øp x·∫øp t·ª´ C≈® -> M·ªöI)
            const prices = product.gia;
            const dailyMap = new Map();
            const sortedPrices = [...prices].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            for (const entry of sortedPrices) {
                const date = new Date(entry.timestamp);
                const dayString = date.toISOString().split('T')[0];
                const buyPrice = parseFloat(entry.ring_buy);
                const sellPrice = parseFloat(entry.ring_sell);

                if (!dailyMap.has(dayString)) {
                    // N·∫øu l√† entry ƒë·∫ßu ti√™n trong ng√†y, g√°n min/max/last b·∫±ng gi√° tr·ªã ƒë√≥
                    dailyMap.set(dayString, {
                        buy_min: buyPrice, buy_max: buyPrice, buy_last: buyPrice,
                        sell_min: sellPrice, sell_max: sellPrice, sell_last: sellPrice
                    });
                } else {
                    // C·∫≠p nh·∫≠t min/max/last cho ng√†y
                    const currentDay = dailyMap.get(dayString);
                    currentDay.buy_min = Math.min(currentDay.buy_min, buyPrice);
                    currentDay.buy_max = Math.max(currentDay.buy_max, buyPrice);
                    currentDay.buy_last = buyPrice; // Entry cu·ªëi c√πng s·∫Ω l√† 'last'
                    
                    currentDay.sell_min = Math.min(currentDay.sell_min, sellPrice);
                    currentDay.sell_max = Math.max(currentDay.sell_max, sellPrice);
                    currentDay.sell_last = sellPrice;
                }
            }

            if (dailyMap.size === 0) return { buySeries: [], sellSeries: [] };

            // 2. ƒêi·ªÅn c√°c ng√†y b·ªã thi·∫øu (S·ª≠a: 'lastBuy' v√† 'lastSell' gi·ªù l√† object)
            const filledBuySeries = [];
            const filledSellSeries = [];
            
            const firstDate = new Date(dailyMap.keys().next().value);
            const today = new Date();
            let currentDate = new Date(firstDate);
            let lastBuyData = null; // L∆∞u tr·ªØ object {y, min, max}
            let lastSellData = null;

            while (currentDate <= today) {
                const dayString = currentDate.toISOString().split('T')[0];
                const entry = dailyMap.get(dayString);

                if (entry) {
                    // N·∫øu c√≥ d·ªØ li·ªáu m·ªõi, c·∫≠p nh·∫≠t
                    lastBuyData = { y: entry.buy_last, min: entry.buy_min, max: entry.buy_max };
                    lastSellData = { y: entry.sell_last, min: entry.sell_min, max: entry.sell_max };
                }
                
                if (lastBuyData !== null) {
                    // ƒê·∫©y (push) object v√†o m·∫£ng
                    filledBuySeries.push({
                        x: currentDate.getTime(),
                        y: lastBuyData.y,
                        min: lastBuyData.min,
                        max: lastBuyData.max
                    });
                    filledSellSeries.push({
                        x: currentDate.getTime(),
                        y: lastSellData.y,
                        min: lastSellData.min,
                        max: lastSellData.max
                    });
                }
                
                currentDate.setDate(currentDate.getDate() + 1);
            }

            return { buySeries: filledBuySeries, sellSeries: filledSellSeries };
        }
 
        /**
         * ·∫®n/hi·ªán kh·ªëi bi·ªÉu ƒë·ªì
         */
        function toggleGoldChart() {
            const container = document.getElementById('goldChartContainer');
            const isHidden = container.classList.toggle('hidden');

            if (!isHidden) {
                // N·∫øu v·ª´a hi·ªán l√™n, g·ªçi h√†m kh·ªüi t·∫°o (ch·ªâ ch·∫°y 1 l·∫ßn)
                initHomeGoldChart();
            }
        }
		
		function formatNumberForInput(value) {
            if (value == null || value === 0) return '0';
            
            // Chuy·ªÉn s·ªë 7000000 th√†nh chu·ªói "7000000"
            const numericValue = String(value); 
            
            // Th√™m d·∫•u ph·∫©y (v√≠ d·ª•: "7,000,000")
            return numericValue.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }
		
		function formatCurrencyInput(event) {
            const input = event.target;
            let value = input.value;
            let cursorPosition = input.selectionStart;

            // 1. Ch·ªâ gi·ªØ l·∫°i s·ªë
            let numericValue = value.replace(/\D/g, '');
            if (numericValue === "") {
                input.value = "";
                return;
            }

            // 2. L∆∞u ƒë·ªô d√†i c≈© tr∆∞·ªõc khi format
            let oldLength = input.value.length;
            let oldCommas = (value.match(/,/g) || []).length;

            // 3. ƒê·ªãnh d·∫°ng l·∫°i b·∫±ng Regex (th√™m d·∫•u ph·∫©y)
            let formattedValue = numericValue.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            
            // 4. C·∫≠p nh·∫≠t gi√° tr·ªã
            input.value = formattedValue;
            
            // 5. C·∫≠p nh·∫≠t v·ªã tr√≠ con tr·ªè
            let newLength = formattedValue.length;
            let newCommas = (formattedValue.match(/,/g) || []).length;
            
            // T√≠nh to√°n v·ªã tr√≠ con tr·ªè m·ªõi
            let newCursorPosition = cursorPosition + (newLength - oldLength);
            
            // ƒêi·ªÅu ch·ªânh n·∫øu m·ªôt d·∫•u ph·∫©y ƒë√£ b·ªã th√™m/x√≥a ngay tr∆∞·ªõc con tr·ªè
            if (newCommas > oldCommas && newCursorPosition === cursorPosition + 1 && formattedValue[newCursorPosition-1] === ',') {
                 newCursorPosition++;
            }
            if (newCommas < oldCommas && originalValue[cursorPosition-1] === ',') {
                 newCursorPosition--;
            }

            input.setSelectionRange(newCursorPosition, newCursorPosition);
        }
		
		/**
         * ƒê·ªãnh d·∫°ng s·ªë ti·ªÅn (v√≠ d·ª•: 7,000,000 ƒë)
         */
        function formatCurrency(value) {
            if (isNaN(value)) value = 0;
            return value.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
        }
        
        /**
         * ƒê·ªãnh d·∫°ng L√£i/L·ªó v·ªõi m√†u s·∫Øc
         */
        function formatPNL(value) {
            if (isNaN(value)) value = 0;
            const formatted = formatCurrency(value);
            if (value > 0) return `<span class="text-green-600 font-bold">+${formatted}</span>`;
            if (value < 0) return `<span class="text-red-500 font-bold">${formatted}</span>`;
            return `<span>${formatted}</span>`;
        }

        /**
         * L·∫•y gi√° th·ªã tr∆∞·ªùng (gi√° MUA c·ªßa ti·ªám) t·ª´ homeData
         */
        function getLiveMarketPrice() {
            const price = homeData.goldPrice;
            // Ch√∫ng ta d√πng gi√° MUA (gi√° ti·ªám mua v√†o, l√† gi√° ch√∫ng ta b√°n ra)
            if (price && price.buy > 0) { 
                return price.buy;
            }
            return 0; // Tr·∫£ v·ªÅ 0 n·∫øu kh√¥ng l·∫•y ƒë∆∞·ª£c gi√°
        }
        
        let editingGoldTxId = null; // Bi·∫øn t·∫°m ƒë·ªÉ bi·∫øt ƒëang s·ª≠a hay th√™m m·ªõi

        /**
         * ƒê·ªãnh d·∫°ng s·ªë ti·ªÅn (v√≠ d·ª•: 7,000,000 ƒë)
         */
        function formatCurrency(value) {
            // S·ª≠a l·ªói: Ki·ªÉm tra (value == null) ƒë·ªÉ b·∫Øt c·∫£ null v√† undefined
            if (value == null || isNaN(value)) {
                value = 0;
            }
            return value.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
        }
        
        /**
         * ƒê·ªãnh d·∫°ng L√£i/L·ªó v·ªõi m√†u s·∫Øc
         */
        function formatPNL(value) {
            if (isNaN(value)) value = 0;
            const formatted = formatCurrency(value);
            if (value > 0) return `<span class="text-green-600 font-bold">+${formatted}</span>`;
            if (value < 0) return `<span class="text-red-500 font-bold">${formatted}</span>`;
            return `<span>${formatted}</span>`;
        }

        /**
         * L·∫•y gi√° th·ªã tr∆∞·ªùng (gi√° MUA c·ªßa ti·ªám) t·ª´ homeData
         */
        function getLiveMarketPrice() {
            const price = homeData.goldPrice;
            // D√πng gi√° MUA (gi√° ti·ªám mua v√†o, l√† gi√° ch√∫ng ta b√°n ra)
            if (price && price.buy > 0) { 
                return price.buy;
            }
            return 0; // Tr·∫£ v·ªÅ 0 n·∫øu kh√¥ng l·∫•y ƒë∆∞·ª£c gi√°
        }
        
        /**
         * M·ªü Modal, ho·∫∑c l√† ƒë·ªÉ th√™m m·ªõi (kh√¥ng c√≥ id) ho·∫∑c s·ª≠a (c√≥ id)
         */
        function openGoldModal(id = null) {
            const form = document.getElementById('goldForm');
            const modalTitle = document.getElementById('goldModalTitle');
            const deleteButton = document.getElementById('goldDeleteButton');
            
            form.reset(); // X√≥a s·∫°ch form
            
            if (id) {
                // --- Ch·∫ø ƒë·ªô S·ª¨A ---
                editingGoldTxId = id; // ƒê√£ s·ª≠a
                const tx = goldPortfolioData.find(h => h.id === id);
                if (!tx) return;
                
                modalTitle.innerHTML = '<i class="fas fa-edit mr-2"></i>S·ª≠a Giao D·ªãch';
                deleteButton.style.display = 'block';
                
                document.getElementById('goldTxId').value = tx.id; // ƒê√£ s·ª≠a
                document.getElementById('goldTxDate').value = tx.date;
                document.getElementById('goldTxType').value = tx.type;
                
                document.getElementById('goldTxQuantity').value = tx.quantity_chi;
                document.getElementById('goldTxPrice').value = formatNumberForInput(tx.price_per_chi);
                document.getElementById('goldTxNotes').value = tx.notes || '';
                
            } else {
                // --- Ch·∫ø ƒë·ªô TH√äM M·ªöI ---
                editingGoldTxId = null; // ƒê√£ s·ª≠a
                document.getElementById('goldTxId').value = ''; // ƒê√£ s·ª≠a
                
                modalTitle.innerHTML = '<i class="fas fa-plus mr-2"></i>Th√™m Giao D·ªãch M·ªõi';
                deleteButton.style.display = 'none';
                
                const today = new Date();
                const todayFormatted = `${String(today.getDate()).padStart(2, '0')}-${String(today.getMonth() + 1).padStart(2, '0')}-${today.getFullYear()}`;
                document.getElementById('goldTxDate').value = todayFormatted;

                document.getElementById('goldTxQuantity').value = '0';
                document.getElementById('goldTxPrice').value = '0';
            }
            
            openModal('goldFormModal');
        }

        /**
         * L∆∞u Giao D·ªãch (H√†m m·ªõi)
         */
        async function saveGoldTransaction(event) {
            event.preventDefault();
            
            const id = document.getElementById('goldTxId').value; // ƒê√£ s·ª≠a
            
            const qtyString = (document.getElementById('goldTxQuantity').value || '0').replace(/,/g, '');
            const priceString = (document.getElementById('goldTxPrice').value || '0').replace(/,/g, '');
            
            const txData = {
                date: document.getElementById('goldTxDate').value,
                type: document.getElementById('goldTxType').value,
                quantity_chi: parseFloat(qtyString),
                price_per_chi: parseFloat(priceString),
                notes: document.getElementById('goldTxNotes').value
            };

            if (txData.quantity_chi <= 0 || txData.price_per_chi <= 0) {
                showNotification('S·ªë l∆∞·ª£ng v√† gi√° ph·∫£i l·ªõn h∆°n 0.', 'error');
                return;
            }

            let logMessage = '';
            
            if (id) {
                // C·∫≠p nh·∫≠t
                const index = goldPortfolioData.findIndex(h => h.id === id);
                if (index > -1) {
                    goldPortfolioData[index] = { ...goldPortfolioData[index], ...txData };
                    logMessage = `ƒê√£ c·∫≠p nh·∫≠t giao d·ªãch v√†ng (ID: ${id})`;
                }
            } else {
                // Th√™m m·ªõi
                txData.id = Date.now().toString();
                goldPortfolioData.push(txData);
                logMessage = `Th√™m giao d·ªãch ${txData.type} (SL: ${txData.quantity_chi} ch·ªâ)`;
            }

            loadGoldPortfolio();
            showNotification('ƒê√£ l∆∞u giao d·ªãch!', 'success');
            addLog('Qu·∫£n l√Ω v√†ng', logMessage);
            closeModal('goldFormModal');

            (async () => {
                try {
                    const success = await githubAPI.updateFile(config.GOLD_PORTFOLIO_FILE_PATH, goldPortfolioData, logMessage);
                    if (!success) throw new Error('API Update Failed');
                } catch (error) {
                    showNotification('L·ªói ƒë·ªìng b·ªô danh m·ª•c v√†ng!', 'error');
                }
            })();
        }
        
        /**
         * X√≥a Giao D·ªãch (H√†m m·ªõi)
         */
        async function deleteGoldTransaction() {
            if (!editingGoldTxId) return; // ƒê√£ s·ª≠a
            
            const confirmDelete = await showCustomConfirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a vƒ©nh vi·ªÖn giao d·ªãch n√†y?");
            if (!confirmDelete) return;

            const index = goldPortfolioData.findIndex(h => h.id === editingGoldTxId); // ƒê√£ s·ª≠a
            if (index > -1) {
                const tx = goldPortfolioData[index];
                goldPortfolioData.splice(index, 1);
                
                const logMessage = `ƒê√£ x√≥a giao d·ªãch v√†ng (ID: ${tx.id})`;

                loadGoldPortfolio();
                showNotification('ƒê√£ x√≥a giao d·ªãch!', 'info');
                addLog('Qu·∫£n l√Ω v√†ng', logMessage);
                closeModal('goldFormModal');

                (async () => {
                    try {
                        await githubAPI.updateFile(config.GOLD_PORTFOLIO_FILE_PATH, goldPortfolioData, logMessage);
                    } catch (error) {
                        showNotification('L·ªói ƒë·ªìng b·ªô!', 'error');
                    }
                })();
            }
        } 
		
		function loadGoldPortfolio() {
			const listEl = document.getElementById('goldTransactionList');
			listEl.innerHTML = '';

			// --- S·∫Øp x·∫øp l·∫°i theo ng√†y ---
			const transactions = [...goldPortfolioData].sort((a, b) => {
				const [dA, mA, yA] = a.date.split('-').map(Number);
				const [dB, mB, yB] = b.date.split('-').map(Number);
				return new Date(yA, mA - 1, dA) - new Date(yB, mB - 1, dB);
			});

			let totalHolding = 0;¬† ¬† ¬† ¬† // S·ªë l∆∞·ª£ng hi·ªán c√≥
			let avgCost = 0;¬† ¬† ¬† ¬† ¬† ¬† ¬†// Gi√° v·ªën b√¨nh qu√¢n hi·ªán t·∫°i
			let totalRealizedPNL = 0;¬† ¬† // T·ªïng l√£i/l·ªó ƒë√£ ch·ªët
			let totalCostBasis = 0;¬† ¬† ¬† // T·ªïng gi√° tr·ªã v·ªën

			const enrichedTransactions = [];

			// --- PASS 1: T√≠nh to√°n P&L v√† gi√° v·ªën ƒë·ªông (Logic n√†y c·ªßa b·∫°n ƒë√£ ƒë√∫ng) ---
			// Ch√∫ng ta t√≠nh to√°n P&L d·ª±a tr√™n gi√° v·ªën b√¨nh qu√¢n ƒë·ªông t·∫°i th·ªùi ƒëi·ªÉm b√°n.
			for (let i = 0; i < transactions.length; i++) {
				const tx = {
					...transactions[i],
					quantity_chi: Number(transactions[i].quantity_chi),
					price_per_chi: Number(transactions[i].price_per_chi)
				};
				let realizedPNL = 0;

				if (tx.type === 'buy') {
					// T√≠nh b√¨nh qu√¢n gia quy·ªÅn ƒë·ªông
					const newTotalValue = (totalHolding * avgCost) + (tx.quantity_chi * tx.price_per_chi);
					const newTotalQty = totalHolding + tx.quantity_chi;
					
					avgCost = (newTotalQty > 0) ? (newTotalValue / newTotalQty) : 0;
					totalHolding = newTotalQty;
					
					totalCostBasis = avgCost * totalHolding;
				}¬†
				else if (tx.type === 'sell') {
					// T√≠nh l√£i/l·ªó theo gi√° v·ªën b√¨nh qu√¢n (avgCost) hi·ªán t·∫°i
					realizedPNL = (tx.price_per_chi - avgCost) * tx.quantity_chi;
					totalRealizedPNL += realizedPNL;

					// Gi·∫£m SL v√† v·ªën (avgCost kh√¥ng ƒë·ªïi khi b√°n)
					totalHolding -= tx.quantity_chi;
					totalCostBasis = avgCost * totalHolding;
				}

				enrichedTransactions.push({
					...tx,
					avgCostAtTx: avgCost, // L∆∞u l·∫°i gi√° v·ªën "ƒë·ªông" t·∫°i th·ªùi ƒëi·ªÉm n√†y
					realizedPNL_for_this_tx: realizedPNL
				});
			}

			// --- PASS 2: C·∫≠p nh·∫≠t gi√° v·ªën "hi·ªÉn th·ªã" (Theo logic c·ªßa ·∫£nh ch·ª•p m√†n h√¨nh) ---
			// Ch√∫ng ta l·∫∑p ng∆∞·ª£c l·∫°i danh s√°ch ƒë·ªÉ g√°n gi√° v·ªën "chu·∫©n" c·ªßa m·ªói "l√¥"
			// cho t·∫•t c·∫£ c√°c giao d·ªãch thu·ªôc l√¥ ƒë√≥.
			let currentBlockAvgCost = 0;
			if (enrichedTransactions.length > 0) {
				// Gi√° v·ªën "chu·∫©n" c·ªßa l√¥ cu·ªëi c√πng l√† gi√° v·ªën c·ªßa giao d·ªãch cu·ªëi c√πng
				currentBlockAvgCost = enrichedTransactions[enrichedTransactions.length - 1].avgCostAtTx;
			}

			for (let i = enrichedTransactions.length - 1; i >= 0; i--) {
				const tx = enrichedTransactions[i];
				
				// Giao d·ªãch "B√°n" (Sell) l√† ranh gi·ªõi c·ªßa m·ªôt l√¥.
				// Gi√° v·ªën (t·ª´ Pass 1) c·ªßa ch√≠nh giao d·ªãch B√°n n√†y l√†
				// gi√° v·ªën "chu·∫©n" cho to√†n b·ªô l√¥ TR∆Ø·ªöC n√≥.
				if (tx.type === 'sell') {
					// C·∫≠p nh·∫≠t gi√° tr·ªã "chu·∫©n" cho l√¥ ti·∫øp theo (c≈© h∆°n)
					currentBlockAvgCost = tx.avgCostAtTx;
				}
				
				// G√°n gi√° v·ªën "chu·∫©n" c·ªßa l√¥ hi·ªán t·∫°i cho giao d·ªãch n√†y ƒë·ªÉ hi·ªÉn th·ªã
				tx.avgCostAtTx = currentBlockAvgCost;
			}


			// --- Hi·ªÉn th·ªã k·∫øt qu·∫£ ---
			enrichedTransactions.forEach(tx => {
				const titleClass = (tx.type === 'buy') ? 'text-green-600' : 'text-red-500';
				const titleIcon = (tx.type === 'buy') ? 'fa-plus-circle' : 'fa-minus-circle';
				const titleText = (tx.type === 'buy') ? 'Mua' : 'B√°n';
				
				let column4_HTML = '';
                    if (tx.type === 'sell') {
                        // N·∫øu l√† B√°n, hi·ªÉn th·ªã PNL
                        column4_HTML = `
                            <div class="text-center border-l border-gray-200">
								<span class="text-xs text-gray-400">PLN</span>
								<p class="font-medium text-custom text-[0.7rem] ${tx.realizedPNL_for_this_tx >= 0 ? 'text-green-600' : 'text-red-600'}"> ${formatPNL(tx.realizedPNL_for_this_tx)} </p>
							</div> 
                        `;
                    } else {
                        // N·∫øu l√† Mua, hi·ªÉn th·ªã c·ªôt r·ªóng (d√πng '-' ƒë·ªÉ gi·ªØ chi·ªÅu cao)
                        column4_HTML = `
                            <div class="text-center border-l border-gray-200">
								<span class="text-xs text-gray-400">-</span>
							</div> 
                        `;
                    }
					
				// Hi·ªÉn th·ªã P&L ch·ªâ cho giao d·ªãch b√°n
				const pnlDisplay = (tx.type === 'sell' && tx.realizedPNL_for_this_tx !== 0) ? `<span>${formatPNL(tx.realizedPNL_for_this_tx)}</span>` : '<span></span>'; // Gi·ªØ ch·ªó ƒë·ªÉ layout kh√¥ng b·ªã v·ª°

				listEl.innerHTML += `
					<div class="love-card rounded-lg p-3 cursor-pointer hover:bg-gray-50 mb-2 shadow-sm border border-gray-100" onclick="openGoldModal('${tx.id}')">
						<div class="flex justify-between items-start text-sm mb-2">
							<p class="font-bold ${titleClass}">
								<i class="fas ${titleIcon} mr-1"></i> ${titleText}
							</p>
							<span class="text-xs text-gray-400">${tx.date}</span>
						</div>
						<div class="grid grid-cols-4 mt-1 pt-2 border-t border-gray-100">
                                    <div class="text-center">
                                        <span class="text-xs text-gray-400">S·ªë l∆∞·ª£ng</span>
                                        <p class="font-medium text-custom text-[0.7rem]">${tx.quantity_chi} ch·ªâ</p>
                                    </div>
                                    
                                    <div class="text-center border-l border-gray-200">
                                        <span class="text-xs text-gray-400">Gi√° GD</span>
                                        <p class="font-medium text-custom text-[0.7rem]">${formatCurrency(tx.price_per_chi)}</p>
                                    </div>
                                    
                                    <div class="text-center border-l border-gray-200">
                                        <span class="text-xs text-gray-400">Gi√° v·ªën</span>
                                        <p class="font-medium text-custom text-[0.7rem]">${formatCurrency(tx.avgCostAtTx)}</p>
                                    </div>
									
									${column4_HTML} 
									
                                </div>
					</div>
				`;
			});

			// --- C·∫≠p nh·∫≠t t·ªïng k·∫øt ---
			// C√°c gi√° tr·ªã n√†y (t·ª´ Pass 1) v·∫´n ch√≠nh x√°c
			const avgCostFinal = totalHolding > 0 ? avgCost : 0;
			const liveMarketPrice = getLiveMarketPrice(); // Gi·∫£ s·ª≠ b·∫°n c√≥ h√†m n√†y
			const marketValue = totalHolding * liveMarketPrice*1000;
			
			// T√≠nh l·∫°i Unrealized PNL d·ª±a tr√™n avgCostFinal (l√† avgCost c·ªßa l√¥ cu·ªëi c√πng)
			const unrealizedPNL = (liveMarketPrice > 0 && totalHolding > 0)
				? (marketValue - (totalHolding * avgCostFinal)) // (Gi√° TT * SL) - (Gi√° v·ªën TB * SL)
				: 0;

			document.getElementById('summaryTotalHolding').textContent = `${totalHolding.toFixed(1)} ch·ªâ`;
			//document.getElementById('summaryAvgCost').textContent = formatCurrency(avgCostFinal);
			document.getElementById('summaryUnrealizedPNL').innerHTML = formatPNL(unrealizedPNL);
			document.getElementById('summaryRealizedPNL').innerHTML = formatPNL(totalRealizedPNL);
		}

		/**
		 * Gi·∫£ ƒë·ªãnh c√°c h√†m h·ªó tr·ª£ n√†y ƒë√£ t·ªìn t·∫°i
		 */
		function formatCurrency(num) {
			if (typeof num !== 'number') return '0';
			return num.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }).replace('¬†‚Ç´', '');
		}

		function formatPNL(pnl) {
			if (typeof pnl !== 'number' || pnl === 0) {
				return '<span class="text-gray-500">0</span>';
			}
			const formatted = formatCurrency(Math.abs(pnl));
			if (pnl > 0) {
				return `<span class="text-green-600">+${formatted}</span>`;
			} else {
				return `<span class="text-red-600">-${formatted}</span>`;
			}
		} 




        /**
         * X·ª≠ l√Ω d·ªØ li·ªáu th√¥ t·ª´ gold_history.json (ƒê√£ c·∫≠p nh·∫≠t ƒë·ªÉ l·∫•y Min/Max/Last)
         */
        function processGoldDataForLineChart(rawData) {
            const productName = "Nh·∫´n Tr√≤n 9999 H∆∞ng Th·ªãnh V∆∞·ª£ng";
            const product = Array.isArray(rawData) ? rawData.find(p => p.product_name === productName) : null;
            
            if (!product || !product.gia || product.gia.length === 0) {
                console.warn("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu gi√° v√†ng ƒë·ªÉ v·∫Ω bi·ªÉu ƒë·ªì.");
                return { buySeries: [], sellSeries: [] };
            }

            // 1. Nh√≥m gi√° (S·∫Øp x·∫øp t·ª´ C≈® -> M·ªöI)
            const prices = product.gia;
            const dailyMap = new Map();
            const sortedPrices = [...prices].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            for (const entry of sortedPrices) {
                const date = new Date(entry.timestamp);
                const dayString = date.toISOString().split('T')[0];
                const buyPrice = parseFloat(entry.ring_buy);
                const sellPrice = parseFloat(entry.ring_sell);

                if (!dailyMap.has(dayString)) {
                    // N·∫øu l√† entry ƒë·∫ßu ti√™n trong ng√†y, g√°n min/max/last b·∫±ng gi√° tr·ªã ƒë√≥
                    dailyMap.set(dayString, {
                        buy_min: buyPrice, buy_max: buyPrice, buy_last: buyPrice,
                        sell_min: sellPrice, sell_max: sellPrice, sell_last: sellPrice
                    });
                } else {
                    // C·∫≠p nh·∫≠t min/max/last cho ng√†y
                    const currentDay = dailyMap.get(dayString);
                    currentDay.buy_min = Math.min(currentDay.buy_min, buyPrice);
                    currentDay.buy_max = Math.max(currentDay.buy_max, buyPrice);
                    currentDay.buy_last = buyPrice; // Entry cu·ªëi c√πng s·∫Ω l√† 'last'
                    
                    currentDay.sell_min = Math.min(currentDay.sell_min, sellPrice);
                    currentDay.sell_max = Math.max(currentDay.sell_max, sellPrice);
                    currentDay.sell_last = sellPrice;
                }
            }

            if (dailyMap.size === 0) return { buySeries: [], sellSeries: [] };

            // 2. ƒêi·ªÅn c√°c ng√†y b·ªã thi·∫øu (S·ª≠a: 'lastBuy' v√† 'lastSell' gi·ªù l√† object)
            const filledBuySeries = [];
            const filledSellSeries = [];
            
            const firstDate = new Date(dailyMap.keys().next().value);
            const today = new Date();
            let currentDate = new Date(firstDate);
            let lastBuyData = null; // L∆∞u tr·ªØ object {y, min, max}
            let lastSellData = null;

            while (currentDate <= today) {
                const dayString = currentDate.toISOString().split('T')[0];
                const entry = dailyMap.get(dayString);

                if (entry) {
                    // N·∫øu c√≥ d·ªØ li·ªáu m·ªõi, c·∫≠p nh·∫≠t
                    lastBuyData = { y: entry.buy_last, min: entry.buy_min, max: entry.buy_max };
                    lastSellData = { y: entry.sell_last, min: entry.sell_min, max: entry.sell_max };
                }
                
                if (lastBuyData !== null) {
                    // ƒê·∫©y (push) object v√†o m·∫£ng
                    filledBuySeries.push({
                        x: currentDate.getTime(),
                        y: lastBuyData.y,
                        min: lastBuyData.min,
                        max: lastBuyData.max
                    });
                    filledSellSeries.push({
                        x: currentDate.getTime(),
                        y: lastSellData.y,
                        min: lastSellData.min,
                        max: lastSellData.max
                    });
                }
                
                currentDate.setDate(currentDate.getDate() + 1);
            }

            return { buySeries: filledBuySeries, sellSeries: filledSellSeries };
        }
		
		/**
         * Kh·ªüi t·∫°o bi·ªÉu ƒë·ªì (ƒê√£ c·∫≠p nh·∫≠t Tooltip theo y√™u c·∫ßu m·ªõi)
         */
        function initHomeGoldChart() {
            if (homeGoldChart || goldData.length === 0) {
                return;
            }
            console.log("ƒêang kh·ªüi t·∫°o bi·ªÉu ƒë·ªì gi√° v√†ng...");
            
            // H√†m n√†y ph·∫£i l√† h√†m M·ªöI NH·∫§T (d√≤ng 3662)
            const { buySeries, sellSeries } = processGoldDataForLineChart(goldData);

            if (buySeries.length === 0) {
                document.getElementById('homeGoldChart').innerHTML = "<p class='text-center text-gray-500'>Kh√¥ng ƒë·ªß d·ªØ li·ªáu ƒë·ªÉ v·∫Ω bi·ªÉu ƒë·ªì.</p>";
                return;
            }

            const options = {
                series: [
                    { name: 'Gi√° Mua', data: buySeries, color: '#00B746' },
                    { name: 'Gi√° B√°n', data: sellSeries, color: '#EF403C' }
                ],
                chart: { type: 'line', height: 250, zoom: { enabled: true }, toolbar: { show: false } },
                xaxis: { type: 'datetime', labels: { datetimeUTC: false, format: 'dd/MM' } },
                yaxis: { 
                    labels: { formatter: (val) => val.toLocaleString('vi-VN') },
                    tooltip: { enabled: true } // B·∫≠t tooltip cho tr·ª•c Y
                },
                stroke: { width: 2 },
 
tooltip: {
                    shared: true,
                    intersect: false,
                    x: {
                        format: 'dd/MM/yyyy'
                    },
                    marker: {
                        show: false 
                    },
                    y: {
                        title: {
                            formatter: () => '' 
                        },
                        // ‚ñº‚ñº‚ñº THAY TH·∫æ TO√ÄN B·ªò H√ÄM FORMATTER N√ÄY ‚ñº‚ñº‚ñº
                        formatter: function(value, { seriesIndex, dataPointIndex, w }) {
                            try {
                                const dataPoint = w.config.series[seriesIndex].data[dataPointIndex];
                                const seriesName = w.config.series[seriesIndex].name;
                                const color = w.config.series[seriesIndex].color;
                                const last = (value || 0).toLocaleString('vi-VN');
                                const min = (dataPoint.min || 0).toLocaleString('vi-VN');
                                const max = (dataPoint.max || 0).toLocaleString('vi-VN');
 
                                return `
								
									<table class="text-xs" style="border-spacing: 10px 2px; width: 100%;">
									  <tr>
										<td></td><td>&nbsp</td>
										<td class="text-gray-500 text-left">Th·∫•p:</td>
										<td class="text-gray-500 text-right">&nbsp${min}</td>
									  </tr>

									  <tr style="height: 20px;">
										<td style="text-align: center; vertical-align: middle;">
										  <span style="
											width: 8px; 
											height: 8px; 
											border-radius: 50%; 
											background: ${color}; 
											display: inline-block;
										  "></span>
										</td>
										<td>&nbsp</td>
										<td style="vertical-align: middle; text-align: left;">
										  <p class="text-xs text-gray-500 m-0">${seriesName}:</p>
										</td>
										<td style="vertical-align: middle; text-align: right;">
										  <p class="text-xs text-gray-700 font-semibold m-0">&nbsp${last}</p>
										</td>
									  </tr>

									  <tr>
										<td></td><td>&nbsp</td>
										<td class="text-gray-500 text-left">Cao:</td>
										<td class="text-gray-500 text-right">&nbsp${max}</td>
									  </tr>
									</table>

                                `;
                            } catch (e) {
                                return (value || 0).toLocaleString('vi-VN');
                            }
                        }
                        // ‚ñ≤‚ñ≤‚ñ≤ K·∫æT TH√öC KH·ªêI THAY TH·∫æ ‚ñ≤‚ñ≤‚ñ≤
                    },
                    style: {
                        fontSize: '13px'
                    }
                }



                
            };

            homeGoldChart = new ApexCharts(document.querySelector("#homeGoldChart"), options);
            homeGoldChart.render();

            // Setup toolbar (gi·ªØ nguy√™n)
            function setupToolbarEvents() {
                const today = new Date().getTime();
                function zoomChart(days) {
                    const startDate = new Date().setDate(new Date().getDate() - days);
                    homeGoldChart.zoomX(startDate, today);
                }
                const buttons = document.querySelectorAll('.chart-toolbar-btn');
                buttons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation(); 
                        buttons.forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        const id = btn.id;
                        if (id === 'btn-gold-1m') zoomChart(31);
                        if (id === 'btn-gold-3m') zoomChart(90);
                        if (id === 'btn-gold-6m') zoomChart(180);
                        if (id === 'btn-gold-1y') zoomChart(365);
                        if (id === 'btn-gold-3y') zoomChart(365 * 3);
                    });
                });
                zoomChart(31);
            }
            setupToolbarEvents();
        }
		
        /**
         * ·∫®n/hi·ªán kh·ªëi bi·ªÉu ƒë·ªì V√Ä T·∫¢I DANH M·ª§C
         */
        function toggleGoldChart() {
            const container = document.getElementById('goldChartContainer');
            const isHidden = container.classList.toggle('hidden');

            if (!isHidden) {
                // N·∫øu v·ª´a hi·ªán l√™n:
                initHomeGoldChart(); // 1. Kh·ªüi t·∫°o bi·ªÉu ƒë·ªì (n·∫øu ch∆∞a)
                loadGoldPortfolio(); // 2. T·∫£i danh m·ª•c giao d·ªãch
            }
        }
		
		/**
		 * (M·ªöI) B·∫≠t/t·∫Øt menu 3 ch·∫•m trong modal xem ·∫£nh
		 */
		function togglePhotoActionsMenu() {
			const menu = document.getElementById('photoActionsMenu');
			if (!menu) return;
			menu.classList.toggle('hidden');
		}

		/**
		 * (M·ªöI) M·ªü modal ƒë·ªÉ ch·ªçn s·ª± ki·ªán g√°n ·∫£nh
		 */
		function openEventLinkModal() {
			// 1. ƒê√≥ng menu 3 ch·∫•m
			const menu = document.getElementById('photoActionsMenu');
			if (menu) menu.classList.add('hidden');

			// 2. Ki·ªÉm tra xem c√≥ ·∫£nh ƒëang ƒë∆∞·ª£c ch·ªçn kh√¥ng
			if (!currentPhotoName) {
				showNotification('L·ªói: Kh√¥ng c√≥ ·∫£nh n√†o ƒë∆∞·ª£c ch·ªçn.', 'error');
				return;
			}

			// 3. C·∫≠p nh·∫≠t t√™n ·∫£nh v√†o modal m·ªõi
			document.getElementById('linkPhotoName').textContent = currentPhotoName;

			// 4. Reset thanh t√¨m ki·∫øm v√† t·∫£i danh s√°ch
			document.getElementById('eventLinkSearch').value = '';
			loadEventLinkList(); // G·ªçi h√†m t·∫£i danh s√°ch

			// 5. M·ªü modal
			openModal('eventLinkModal');
			addLog('M·ªü modal', `M·ªü G·∫Øn ·∫£nh v√†o s·ª± ki·ªán cho: ${currentPhotoName}`);
		}

		/**
		 * (M·ªöI) T·∫£i v√† hi·ªÉn th·ªã danh s√°ch s·ª± ki·ªán v√†o modal
		 * @param {string} filter - Chu·ªói t√¨m ki·∫øm (t√πy ch·ªçn)
		 */
		function loadEventLinkList(filter = '') {
			const container = document.getElementById('eventLinkList');
			const lowerFilter = filter.toLowerCase();

			// S·∫Øp x·∫øp s·ª± ki·ªán theo ng√†y, m·ªõi nh·∫•t tr∆∞·ªõc
			const sortedEvents = [...eventsData].sort((a, b) => 
				new Date(convertDateFormat(b.day)) - new Date(convertDateFormat(a.day))
			);
			
			// L·ªçc s·ª± ki·ªán theo t√™n
			const filteredEvents = sortedEvents.filter(event => 
				event.name.toLowerCase().includes(lowerFilter)
			);

			if (filteredEvents.length === 0) {
				container.innerHTML = '<p class="text-center text-gray-500 p-4">Kh√¥ng t√¨m th·∫•y s·ª± ki·ªán.</p>';
				return;
			}

			// Render danh s√°ch
			container.innerHTML = filteredEvents.map(event => {
				// Ki·ªÉm tra xem ·∫£nh n√†y ƒë√£ ƒë∆∞·ª£c g√°n cho s·ª± ki·ªán n√†y ch∆∞a
				const isAlreadyLinked = event.image && event.image.includes(currentPhotoName);
				
				return `
					<div class="flex items-center justify-between p-3 rounded-lg hover:bg-gray-100 ${isAlreadyLinked ? 'bg-green-50' : 'bg-accent'}">
						<div>
							<p class="font-medium text-custom">${escapeHtml(event.name)}</p>
							<p class="text-sm text-gray-500">${event.day}</p>
						</div>
						<button onclick="linkPhotoToEvent('${event.note_id}')" 
								class="love-button text-sm px-3 py-1 ${isAlreadyLinked ? 'secondary' : ''}"
								style="${isAlreadyLinked ? 'opacity: 0.6; cursor: not-allowed;' : ''}"
								${isAlreadyLinked ? 'disabled' : ''}>
							${isAlreadyLinked ? '<i class="fas fa-check mr-1"></i>ƒê√£ g·∫Øn' : '<i class="fas fa-link mr-1"></i>G·∫Øn'}
						</button>
					</div>
				`;
			}).join('');
		}

		/**
		 * (M·ªöI) H√†m ƒë∆∞·ª£c g·ªçi b·ªüi thanh t√¨m ki·∫øm (oninput)
		 */
		function filterEventLinkList() {
			const filter = document.getElementById('eventLinkSearch').value;
			loadEventLinkList(filter);
		}

		/**
		 * (M·ªöI) H√†m l√µi: Th·ª±c hi·ªán g√°n ·∫£nh v√†o s·ª± ki·ªán
		 * @param {string} eventId - ID c·ªßa s·ª± ki·ªán ƒë∆∞·ª£c ch·ªçn
		 */
		async function linkPhotoToEvent(eventId) {
			if (!currentPhotoName) return;

			const eventIndex = eventsData.findIndex(e => e.note_id === eventId);
			if (eventIndex === -1) {
				showNotification('L·ªói: Kh√¥ng t√¨m th·∫•y s·ª± ki·ªán.', 'error');
				return;
			}
			
			const event = eventsData[eventIndex];
			
			// 1. L∆∞u tr·∫°ng th√°i c≈© ƒë·ªÉ rollback
			const originalImageArray = [...(event.image || [])];

			// 2. C·∫≠p nh·∫≠t l·∫°c quan (Optimistic Update)
			if (!event.image) {
				event.image = [];
			}
			
			if (event.image.includes(currentPhotoName)) {
				return; // ƒê√£ g·∫Øn r·ªìi
			}

			event.image.push(currentPhotoName);

			// 3. C·∫≠p nh·∫≠t UI
			showNotification(`ƒê√£ g·∫Øn ·∫£nh v√†o s·ª± ki·ªán "${event.name}"`, 'success');
			addLog('T∆∞∆°ng t√°c ·∫£nh', `G·∫Øn ·∫£nh "${currentPhotoName}" v√†o s·ª± ki·ªán "${event.name}"`);
			
			// T·∫£i l·∫°i danh s√°ch trong modal ƒë·ªÉ c·∫≠p nh·∫≠t n√∫t "ƒê√£ g·∫Øn"
			loadEventLinkList(document.getElementById('eventLinkSearch').value);
			
			// üî• Quan tr·ªçng: X√¢y d·ª±ng l·∫°i b·∫£n ƒë·ªì ph√¢n lo·∫°i ·∫£nh
			buildPhotoCategoryMap();
			
			// T·∫£i l·∫°i tab kho·∫£nh kh·∫Øc (n·∫øu ƒëang ·ªü ƒë√≥) ƒë·ªÉ c·∫≠p nh·∫≠t tag
			if (currentSection === 'photos') {
				loadPhotos(currentPage);
			}
			
			// 4. ƒê·ªìng b·ªô n·ªÅn (L∆∞u v√†o actions.json)
			(async () => {
				try {
					const success = await githubAPI.updateFile(
						config.FILE_PATH, // actions.json
						eventsData,
						`Link photo ${currentPhotoName} to event ${event.name}`
					);

					if (!success) throw new Error("API update failed");
					
				} catch (error) {
					// 5. Rollback n·∫øu l·ªói
					console.error('L·ªói khi ƒë·ªìng b·ªô file s·ª± ki·ªán:', error);
					showNotification('L·ªói ƒë·ªìng b·ªô! ƒêang ho√†n t√°c...', 'error');
					
					// Kh√¥i ph·ª•c m·∫£ng ·∫£nh c≈©
					eventsData[eventIndex].image = originalImageArray;
					
					// T·∫£i l·∫°i UI
					loadEventLinkList(document.getElementById('eventLinkSearch').value);
					buildPhotoCategoryMap(); // X√¢y d·ª±ng l·∫°i b·∫£n ƒë·ªì (c≈©)
				}
			})();
		}
 
		// --- B·∫ÆT ƒê·∫¶U: Code Logic Bi·ªÉu ƒê·ªì Baby Run ---
        let babyRunChartInstance = null;

        async function openBabyRunChart() {
			openModal('babyRunChartModal');
			
			document.getElementById('babyRunChartArea').innerHTML = '<div class="loading-spinner mx-auto my-10"></div>';
			document.getElementById('babyRunTableBody').innerHTML = '<tr><td colspan="2" class="text-center py-4">ƒêang t·∫£i...</td></tr>';

			try {
				let remoteData = await githubAPI.getRawFile(config.BABYRUN_FILE_PATH);
				if (!Array.isArray(remoteData)) remoteData = [];

				const localQueue = JSON.parse(localStorage.getItem(STORAGE_BABYRUN_QUEUE) || "[]");
				const allData = [...remoteData, ...localQueue];

				// 1. Gom nh√≥m d·ªØ li·ªáu
				const dailyCounts = {};   // D√πng cho Bi·ªÉu ƒë·ªì: { "2024-01-05": 10 }
				const dailyDetails = {};  // D√πng cho B·∫£ng: { "2024-01-05": { "12h30": 1, "13h01": 2 } }
				
				allData.forEach(item => {
					if (item.timerun) {
						const dateObj = new Date(item.timerun);
						const year = dateObj.getFullYear();
						const month = String(dateObj.getMonth() + 1).padStart(2, '0');
						const day = String(dateObj.getDate()).padStart(2, '0');
						const dateKey = `${year}-${month}-${day}`;
						
						// L·∫•y Gi·ªù:Ph√∫t (v√≠ d·ª•: 12h30)
						const h = String(dateObj.getHours()).padStart(2, '0');
						const m = String(dateObj.getMinutes()).padStart(2, '0');
						const timeKey = `${h}h${m}`;

						// C·ªông t·ªïng ng√†y (cho bi·ªÉu ƒë·ªì)
						dailyCounts[dateKey] = (dailyCounts[dateKey] || 0) + 1;

						// C·ªông chi ti·∫øt gi·ªù (cho b·∫£ng)
						if (!dailyDetails[dateKey]) dailyDetails[dateKey] = {};
						dailyDetails[dateKey][timeKey] = (dailyDetails[dateKey][timeKey] || 0) + 1;
					}
				});

				// 2. X·ª≠ l√Ω d·ªØ li·ªáu BI·ªÇU ƒê·ªí (S·∫Øp x·∫øp ng√†y TƒÇNG D·∫¶N)
				const sortedKeys = Object.keys(dailyCounts).sort();
				const seriesData = sortedKeys.map(dateKey => {
					const [y, m, d] = dateKey.split('-');
					return {
						x: `${d}/${m}`, 
						y: dailyCounts[dateKey]
					};
				});

				// 3. X·ª≠ l√Ω d·ªØ li·ªáu B·∫¢NG (S·∫Øp x·∫øp ng√†y GI·∫¢M D·∫¶N)
				const tableHtml = sortedKeys.reverse().map(dateKey => {
					const [y, m, d] = dateKey.split('-');
					const totalCount = dailyCounts[dateKey];
					
					// X·ª≠ l√Ω chi ti·∫øt gi·ªù trong ng√†y (S·∫Øp x·∫øp gi·ªù gi·∫£m d·∫ßn: 14h00 -> 12h00)
					const timeData = dailyDetails[dateKey];
					const sortedTimes = Object.keys(timeData).sort().reverse();
					
					// T·∫°o HTML cho ph·∫ßn chi ti·∫øt gi·ªù
					const detailsHtml = sortedTimes.map(time => {
						const count = timeData[time];
						return `
							<div class="flex justify-between items-center text-xs text-gray-500 py-1 border-l-2 border-gray-200 pl-3 ml-2 hover:bg-gray-50">
								<span>${time}</span>
								<span class="font-medium">${count} l·∫ßn</span>
							</div>
						`;
					}).join('');

					// K·∫øt h·ª£p d√≤ng t·ªïng ng√†y v√† d√≤ng chi ti·∫øt
					return `
						<tr class="bg-gray-50 border-b">
							<td class="px-6 py-3 font-bold text-primary whitespace-nowrap">
								${d}/${m}/${y}
							</td>
							<td class="px-6 py-3 text-right font-bold text-primary">
								T·ªïng: ${totalCount}
							</td>
						</tr>
						<tr class="bg-white border-b">
							<td colspan="2" class="px-4 py-2">
								<div class="grid grid-cols-2 gap-x-4 gap-y-1">
									${detailsHtml}
								</div>
							</td>
						</tr>
					`;
				}).join('');

				// 4. Render
				renderBabyRunChart(seriesData); // V·∫Ω bi·ªÉu ƒë·ªì (H√†m c≈©)
				
				// V·∫Ω b·∫£ng
				const tableBody = document.getElementById('babyRunTableBody');
				if (seriesData.length === 0) {
					tableBody.innerHTML = '<tr><td colspan="2" class="text-center py-4">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
				} else {
					tableBody.innerHTML = tableHtml;
				}

			} catch (error) {
				console.error("L·ªói t·∫£i d·ªØ li·ªáu babyrun:", error);
				document.getElementById('babyRunChartArea').innerHTML = '<p class="text-center text-red-500">L·ªói t·∫£i d·ªØ li·ªáu.</p>';
				document.getElementById('babyRunTableBody').innerHTML = '';
			}
		}

        function renderBabyRunChart(dataSeries) {
			document.getElementById('babyRunChartArea').innerHTML = ""; 

			if (dataSeries.length === 0) {
				document.getElementById('babyRunChartArea').innerHTML = '<p class="text-center text-gray-500 py-10">Ch∆∞a c√≥ d·ªØ li·ªáu n√†o.</p>';
				return;
			}

			const options = {
				series: [{
					name: 'T·ªïng l·∫ßn ƒë·∫°p',
					data: dataSeries
				}],
				chart: {
					type: 'line',
					height: 350,
					zoom: { enabled: false },
					toolbar: { show: false }
				},
				stroke: {
					curve: 'smooth',
					width: 3,
					colors: ['#006B68']
				},
				markers: {
					size: 6,
					colors: ['#FFC62F'],
					strokeColors: '#fff',
					strokeWidth: 2,
					hover: { size: 8 }
				},
				dataLabels: {
					enabled: false,
					offsetY: -10,
					style: {
						colors: ["#304758"]
					},
					background: {
						enabled: true,
						foreColor: '#000',
						padding: 4,
						borderRadius: 2,
						opacity: 0.9,
						borderColor: '#e0e0e0',
					}
				},
				xaxis: {
					type: 'category', // QUAN TR·ªåNG: Chuy·ªÉn sang category ƒë·ªÉ kh√¥ng b·ªã l·∫∑p ng√†y
					tooltip: { enabled: false },
					axisBorder: { show: true },
					axisTicks: { show: true }
				},
				yaxis: {
					title: { text: 'S·ªë l·∫ßn' },
					min: 0,
					forceNiceScale: true,
					labels: {
						formatter: function (val) {
							return val.toFixed(0);
						}
					}
				},
				grid: {
					borderColor: '#f1f1f1',
				},
				tooltip: {
					// Kh√¥ng c·∫ßn format ng√†y n·ªØa v√¨ x ƒë√£ l√† chu·ªói "dd/MM"
					y: {
						formatter: function (val) {
							return val + " l·∫ßn";
						}
					}
				},
				colors: ['#006B68']
			};

			if (babyRunChartInstance) {
				babyRunChartInstance.destroy();
			}

			babyRunChartInstance = new ApexCharts(document.querySelector("#babyRunChartArea"), options);
			babyRunChartInstance.render();
		}
        // --- K·∫æT TH√öC: Code Logic Bi·ªÉu ƒê·ªì Baby Run ---
		
		
   
		// --- 1. C·∫§U H√åNH & BI·∫æN ---
		config.BABYRUN_FILE_PATH = "babyrun.json"; 
		const STORAGE_BABYRUN_QUEUE = 'babyrun_pending_queue';

		// Load h√†ng ƒë·ª£i t·ª´ LocalStorage ngay khi kh·ªüi t·∫°o
		let babyRunQueue = JSON.parse(localStorage.getItem(STORAGE_BABYRUN_QUEUE) || "[]");
		let isSyncingBabyRun = false;
		let babyRunTimeout = null;

		// --- 2. X·ª¨ L√ù CLICK (OPTIMISTIC UI) - ƒê√É S·ª¨A ---
		function handleBabyRunClick() {
			// 1. Hi·ªáu ·ª©ng UI (Gi·ªØ nguy√™n)
			const btn = document.getElementById('babyRunBtn');
			btn.classList.add('scale-110');
			setTimeout(() => btn.classList.remove('scale-110'), 150);

			// --- S·ª¨A ƒê·ªîI: T√çNH TO√ÅN D·ª∞A TR√äN D·ªÆ LI·ªÜU TH·ª∞C T·∫æ ---
			const todayStr = new Date().toISOString().split('T')[0];
			
			// a. L·∫•y danh s√°ch ƒëang ch·ªù t·ª´ LocalStorage
			let localData = JSON.parse(localStorage.getItem(STORAGE_BABYRUN_QUEUE) || "[]");
			
			// b. ƒê·∫øm s·ªë l∆∞·ª£ng ch∆∞a ƒë·ªìng b·ªô c·ªßa ng√†y h√¥m nay
			const localPendingCount = localData.filter(r => 
				r.synced === false && r.timerun.startsWith(todayStr)
			).length;

			// c. T√≠nh t·ªïng c≈© = (S·ªë l∆∞·ª£ng Server ƒë√£ cache) + (S·ªë l∆∞·ª£ng Local ƒëang ch·ªù)
			// cachedServerBabyRunCount l√† bi·∫øn to√†n c·ª•c ƒë∆∞·ª£c c·∫≠p nh·∫≠t ·ªü h√†m updateBabyRunDisplay
			const oldTotal = (cachedServerBabyRunCount || 0) + localPendingCount;
			
			// d. T·ªïng m·ªõi = T·ªïng c≈© + 1
			const realTotal = oldTotal + 1;

			// 2. C·∫≠p nh·∫≠t hi·ªÉn th·ªã
			document.getElementById('babyRunCount').textContent = realTotal;
			
			// 3. Ghi log v·ªõi s·ªë li·ªáu ch√≠nh x√°c
			addLog('T∆∞∆°ng t√°c', `ƒê√£ th√™m 1 ƒë·∫°p. T·ªïng h√¥m nay: ${realTotal}`);

			// 4. T·∫°o b·∫£n ghi m·ªõi
			const newRecord = {
				id: `${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
				username: currentUser?.username || "·∫®n danh",
				timerun: new Date().toISOString(),
				synced: false
			};

			// 5. L∆∞u v√†o LocalStorage (Push tr·ª±c ti·∫øp v√†o bi·∫øn localData ƒë√£ l·∫•y ·ªü b∆∞·ªõc a)
			localData.push(newRecord);
			localStorage.setItem(STORAGE_BABYRUN_QUEUE, JSON.stringify(localData));

			// 6. Debounce Sync (Gi·ªØ nguy√™n)
			if (babyRunTimeout) clearTimeout(babyRunTimeout);
			babyRunTimeout = setTimeout(syncBabyRunBatch, 3000);
		}

		// --- 3. ƒê·ªíNG B·ªò BATCH (C·ªêT L√ïI) ---
		async function syncBabyRunBatch() {
			if (isSyncingBabyRun || !navigator.onLine) return;

			// 1. L·∫•y to√†n b·ªô d·ªØ li·ªáu t·ª´ LocalStorage
			let localData = JSON.parse(localStorage.getItem(STORAGE_BABYRUN_QUEUE) || "[]");

			// 2. L·ªçc ra c√°c item c√≥ synced = false (C·∫ßn g·ª≠i)
			const pendingItems = localData.filter(item => item.synced === false);

			if (pendingItems.length === 0) {
				return; // Kh√¥ng c√≥ g√¨ ƒë·ªÉ g·ª≠i
			}

			isSyncingBabyRun = true;
			console.log(`‚è≥ B·∫Øt ƒë·∫ßu ƒë·ªìng b·ªô ${pendingItems.length} item...`);

			try {
				// --- B∆Ø·ªöC 3: L·∫§Y D·ªÆ LI·ªÜU SERVER ---
				let remoteData = await githubAPI.getFile(config.BABYRUN_FILE_PATH);
				if (!Array.isArray(remoteData)) remoteData = [];

				// --- B∆Ø·ªöC 4: G·ªòP D·ªÆ LI·ªÜU (Merge) ---
				// T·∫°o Map ƒë·ªÉ lo·∫°i b·ªè tr√πng l·∫∑p d·ª±a tr√™n ID
				const mergedMap = new Map();

				// 4a. ƒê∆∞a d·ªØ li·ªáu server v√†o Map
				remoteData.forEach(item => mergedMap.set(item.id, item));

				// 4b. ƒê∆∞a c√°c item ƒëang ch·ªù (pending) v√†o Map
				// L∆∞u √Ω: L√∫c n√†y ta gi·∫£ ƒë·ªãnh g·ª≠i s·∫Ω th√†nh c√¥ng, n√™n trong file json g·ª≠i ƒëi
				// ta c√≥ th·ªÉ set synced=true lu√¥n ho·∫∑c gi·ªØ nguy√™n t√πy logic server.
				// ·ªû ƒë√¢y ta ch·ªâ quan t√¢m ƒë·∫©y d·ªØ li·ªáu v√†o file JSON.
				pendingItems.forEach(item => {
					// Khi l∆∞u l√™n server, b·∫£n ch·∫•t n√≥ ƒë√£ l√† "ƒë∆∞·ª£c sync"
					mergedMap.set(item.id, { ...item, synced: true }); 
				});

				// 4c. Chuy·ªÉn v·ªÅ m·∫£ng & S·∫Øp x·∫øp & C·∫Øt g·ªçn
				const finalData = Array.from(mergedMap.values())
					.sort((a, b) => new Date(b.timerun) - new Date(a.timerun))
					.slice(0, 10000); // Gi·ªõi h·∫°n 10k d√≤ng

				// --- B∆Ø·ªöC 5: G·ª¨I REQUEST API ---
				const success = await githubAPI.updateFile(
					config.BABYRUN_FILE_PATH,
					finalData,
					`Sync: ${pendingItems.length} new records`
				);

				if (success) {
					console.log("‚úÖ ƒê·ªìng b·ªô th√†nh c√¥ng!");

					// --- B∆Ø·ªöC 6: C·∫¨P NH·∫¨T TR·∫†NG TH√ÅI LOCAL (Quan tr·ªçng) ---
					// Duy·ªát qua localData, t√¨m nh·ªØng th·∫±ng v·ª´a g·ª≠i v√† update synced = true
					const pendingIds = new Set(pendingItems.map(i => i.id));
					
					localData = localData.map(item => {
						if (pendingIds.has(item.id)) {
							return { ...item, synced: true }; // ƒê√°nh d·∫•u ƒë√£ xong
						}
						return item;
					});

					// --- B∆Ø·ªöC 7: D·ªåN D·∫∏P (Cleanup) ---
					// T√πy ch·ªçn: X√≥a c√°c item ƒë√£ sync ƒë·ªÉ nh·∫π b·ªô nh·ªõ m√°y
					// Ho·∫∑c gi·ªØ l·∫°i n·∫øu b·∫°n mu·ªën hi·ªán l·ªãch s·ª≠ offline. 
					// ·ªû ƒë√¢y t√¥i s·∫Ω x√≥a c√°c item ƒë√£ sync ƒë·ªÉ tr√°nh LocalStorage b·ªã ƒë·∫ßy.
					localData = localData.filter(item => item.synced === false);

					// L∆∞u l·∫°i m·∫£ng m·ªõi v√†o LocalStorage
					localStorage.setItem(STORAGE_BABYRUN_QUEUE, JSON.stringify(localData));

					// C·∫≠p nh·∫≠t giao di·ªán b·∫±ng d·ªØ li·ªáu ch√≠nh x√°c v·ª´a g·ª≠i
					updateBabyRunDisplay(finalData);
				}

			} catch (error) {
				console.error("‚ùå L·ªói ƒë·ªìng b·ªô:", error);
				// N·∫øu l·ªói, status v·∫´n l√† false, l·∫ßn sau s·∫Ω t·ª± g·ª≠i l·∫°i.
			} finally {
				isSyncingBabyRun = false;
				babyRunTimeout = null;
			}
		}

		// --- 4. HI·ªÇN TH·ªä D·ªÆ LI·ªÜU (LOCAL + REMOTE) ---
		// S·ª≠a ƒë·ªïi: Th√™m tham s·ªë directData ƒë·ªÉ nh·∫≠n d·ªØ li·ªáu t∆∞∆°i ngay sau khi sync
		async function updateBabyRunDisplay(directData = null) {
			const todayStr = new Date().toISOString().split('T')[0];
			
			// 1. ƒê·∫øm s·ªë l∆∞·ª£ng trong LocalStorage M√Ä CH∆ØA SYNC (synced: false)
			const localData = JSON.parse(localStorage.getItem(STORAGE_BABYRUN_QUEUE) || "[]");
			const localPendingCount = localData.filter(r => 
				r.synced === false && r.timerun.startsWith(todayStr)
			).length;

			try {
				let serverData = [];
				if (directData) {
					serverData = directData;
				} else {
					const remoteData = await githubAPI.getRawFile(config.BABYRUN_FILE_PATH);
					serverData = Array.isArray(remoteData) ? remoteData : [];
				}
				
				// ƒê·∫øm s·ªë l∆∞·ª£ng tr√™n server
				const serverCount = serverData.filter(r => r.timerun.startsWith(todayStr)).length;
				
				// --- C·∫¨P NH·∫¨T BI·∫æN TO√ÄN C·ª§C ---
				cachedServerBabyRunCount = serverCount; // <--- TH√äM D√íNG N√ÄY
				
				const total = serverCount + localPendingCount;
				document.getElementById('babyRunCount').textContent = total;
				
			} catch (e) {
				// Offline: Hi·ªÉn th·ªã nh·ªØng g√¨ ƒëang c√≥ trong local (c·∫£ true v√† false n·∫øu ch∆∞a x√≥a)
				const localTodayTotal = localData.filter(r => r.timerun.startsWith(todayStr)).length;
				document.getElementById('babyRunCount').textContent = localTodayTotal;
			}
		}

		// --- 5. K√çCH HO·∫†T ---
        // Ch·∫°y khi m·ªü app
        updateBabyRunDisplay();

        // T·ª± ƒë·ªông sync khi c√≥ m·∫°ng l·∫°i
        window.addEventListener('online', syncBabyRunBatch);

        // C·ªë g·∫Øng sync tr∆∞·ªõc khi ƒë√≥ng tab (Best effort)
        window.addEventListener('beforeunload', () => {
            // Ki·ªÉm tra tr·ª±c ti·∫øp LocalStorage xem c√≥ d·ªØ li·ªáu ch·ªù kh√¥ng
            const queue = JSON.parse(localStorage.getItem(STORAGE_BABYRUN_QUEUE) || "[]");
            if (queue.some(item => item.synced === false)) {
                syncBabyRunBatch();
            }
        });

        // TH√äM M·ªöI: X·ª≠ l√Ω cho Mobile khi ·∫©n tr√¨nh duy·ªát/t·∫Øt m√†n h√¨nh
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
                // Ki·ªÉm tra tr·ª±c ti·∫øp LocalStorage thay v√¨ bi·∫øn babyRunQueue
                const queue = JSON.parse(localStorage.getItem(STORAGE_BABYRUN_QUEUE) || "[]");
                
                // N·∫øu c√≥ b·∫•t k·ª≥ item n√†o ch∆∞a sync (synced === false)
                if (queue.some(item => item.synced === false)) {
                    console.log("App hidden: Triggering immediate sync...");
                    if (babyRunTimeout) clearTimeout(babyRunTimeout); // X√≥a b·ªô ƒë·∫øm gi·ªù
                    syncBabyRunBatch();
                }
            }
        });
		
		// --- LOGIC T√ôY CH·ªàNH LAYOUT N√ÇNG CAO ---
		let sortableInstance = null;
		let isEditMode = false;
		config.LAYOUT_CONFIG_PATH = "layoutConfig.json";

		// 1. B·∫≠t/T·∫Øt ch·∫ø ƒë·ªô Edit
		function toggleEditMode() {
			isEditMode = !isEditMode;
			const grid = document.getElementById('dashboardGrid');
			const toolbar = document.getElementById('editorToolbar');
			
			if (isEditMode) {
				toolbar.classList.add('show');
				grid.classList.add('edit-mode-active');
				
				// K√≠ch ho·∫°t SortableJS (K√©o th·∫£ t·ª± do)
				if (!sortableInstance) {
					sortableInstance = new Sortable(grid, {
						animation: 150,
						ghostClass: 'sortable-ghost',
						handle: '.widget-item', // K√©o n·∫Øm v√†o th√¢n widget
						filter: '.widget-controls, button, a', // Kh√¥ng k√©o khi b·∫•m v√†o n√∫t
						preventOnFilter: false
					});
				}
				
				// Th√™m controls cho t·ª´ng widget
				document.querySelectorAll('.widget-item').forEach(el => addWidgetControls(el));
				showNotification('ƒê√£ b·∫≠t ch·∫ø ƒë·ªô ch·ªânh s·ª≠a', 'info');
			} else {
				toolbar.classList.remove('show');
				grid.classList.remove('edit-mode-active');
				
				if (sortableInstance) {
					sortableInstance.destroy();
					sortableInstance = null;
				}
				removeWidgetControls();
			}
		}

		// 2. T·∫°o b·∫£ng ƒëi·ªÅu khi·ªÉn (10 n√∫t)
		function addWidgetControls(element) {
			if (element.querySelector('.widget-controls')) return;
			
			element.classList.add('edit-mode');
			
			// ƒê·∫£m b·∫£o widget c√≥ min-height ƒë·ªÉ resize
			if (!element.style.minHeight) {
				element.style.minHeight = 'auto'; // M·∫∑c ƒë·ªãnh
			}

			const controls = document.createElement('div');
			controls.className = 'widget-controls';
			
			// HTML c√°c n√∫t ch·ª©c nƒÉng
			controls.innerHTML = `
				<!-----
				<button class="control-btn btn-move" onclick="moveWidget('${element.id}', 'left')" title="Sang Tr√°i"><i class="fas fa-arrow-left"></i></button>
				<button class="control-btn btn-move" onclick="moveWidget('${element.id}', 'up')" title="L√™n Tr√™n"><i class="fas fa-arrow-up"></i></button>
				<button class="control-btn btn-move" onclick="moveWidget('${element.id}', 'down')" title="Xu·ªëng D∆∞·ªõi"><i class="fas fa-arrow-down"></i></button>
				<button class="control-btn btn-move" onclick="moveWidget('${element.id}', 'right')" title="Sang Ph·∫£i"><i class="fas fa-arrow-right"></i></button>
				----->
				<button class="control-btn btn-size" onclick="adjustWidth('${element.id}', -1)" title="Gi·∫£m R·ªông (-1/6)"><i class="fas fa-compress-arrows-alt"></i>W</button>
				<button class="control-btn btn-size" onclick="adjustWidth('${element.id}', 1)" title="TƒÉng R·ªông (+1/6)"><i class="fas fa-expand-arrows-alt"></i>W</button>
				<button class="control-btn btn-size" onclick="adjustHeight('${element.id}', -50)" title="Gi·∫£m Cao"><i class="fas fa-compress-alt"></i>H</button>
				<button class="control-btn btn-size" onclick="adjustHeight('${element.id}', 50)" title="TƒÉng Cao"><i class="fas fa-expand-alt"></i>H</button>
				
				<button class="control-btn btn-del" onclick="deleteWidget('${element.id}')" title="X√≥a/·∫®n kh·ªëi n√†y"><i class="fas fa-trash"></i> X√≥a</button>
			`;

			// NgƒÉn s·ª± ki·ªán click xuy√™n qua (bubbling)
			controls.onclick = (e) => e.stopPropagation();
			element.appendChild(controls);
		}

		function removeWidgetControls() {
			document.querySelectorAll('.widget-controls').forEach(el => el.remove());
			document.querySelectorAll('.widget-item').forEach(el => el.classList.remove('edit-mode'));
		}

		// 3. Logic Di Chuy·ªÉn (Swap DOM)
		function moveWidget(id, direction) {
			const el = document.getElementById(id);
			const parent = el.parentNode;
			const siblings = Array.from(parent.children).filter(c => c.classList.contains('widget-item')); // Ch·ªâ l·∫•y widget
			const index = siblings.indexOf(el);

			if (direction === 'left' || direction === 'up') {
				// Chuy·ªÉn v·ªÅ tr∆∞·ªõc
				if (index > 0) {
					parent.insertBefore(el, siblings[index - 1]);
				}
			} else if (direction === 'right' || direction === 'down') {
				// Chuy·ªÉn ra sau
				if (index < siblings.length - 1) {
					parent.insertBefore(el, siblings[index + 1].nextSibling);
				}
			}
		}

		// 4. Logic Thay ƒë·ªïi Chi·ªÅu R·ªông (Width) - H·ªá th·ªëng 6 c·ªôt
		function adjustWidth(id, delta) {
			const el = document.getElementById(id);
			// L·∫•y s·ªë c·ªôt hi·ªán t·∫°i (m·∫∑c ƒë·ªãnh 2/6 ~ 1/3 m√†n h√¨nh)
			let currentCol = parseInt(el.getAttribute('data-col') || '2');
			
			// C√°c m·ª©c ƒë·ªô r·ªông: 2 (1/3), 3 (1/2), 4 (2/3), 6 (Full)
			// Logic c·ªông tr·ª´ ƒë∆°n gi·∫£n, t·ªëi thi·ªÉu 2, t·ªëi ƒëa 6
			let nextCol = currentCol + delta;
			
			// R√†ng bu·ªôc (Snapping):
			// N·∫øu ƒëang 3 (1/2) + 1 -> l√™n 4 (2/3)
			// N·∫øu ƒëang 4 (2/3) + 1 -> l√™n 6 (Full)
			if (currentCol === 4 && delta > 0) nextCol = 6;
			if (currentCol === 6 && delta < 0) nextCol = 4;

			if (nextCol < 2) nextCol = 2; // Nh·ªè nh·∫•t 1/3 m√†n h√¨nh (2 c·ªôt)
			if (nextCol > 6) nextCol = 6; // L·ªõn nh·∫•t Full m√†n h√¨nh (6 c·ªôt)

			// X√≥a class c≈©
			el.classList.remove(`lg:col-span-${currentCol}`);
			// Th√™m class m·ªõi
			el.classList.add(`lg:col-span-${nextCol}`);
			el.setAttribute('data-col', nextCol);
		}

		// 5. Logic Thay ƒë·ªïi Chi·ªÅu Cao (Height)
		function adjustHeight(id, delta) {
			const el = document.getElementById(id);
			// L·∫•y chi·ªÅu cao hi·ªán t·∫°i (t·ª´ style ho·∫∑c computed)
			let currentHeight = parseInt(el.style.minHeight || el.offsetHeight);
			
			// N·∫øu widget ch∆∞a c√≥ minHeight, l·∫•y chi·ªÅu cao th·∫≠t
			if (!el.style.minHeight) currentHeight = el.offsetHeight;

			let newHeight = currentHeight + delta;
			if (newHeight < 100) newHeight = 100; // T·ªëi thi·ªÉu 100px

			el.style.minHeight = `${newHeight}px`;
			
			// N·∫øu widget c√≥ card b√™n trong, set lu√¥n height cho card ƒë·ªÉ fill
			const card = el.querySelector('.love-card');
			if (card) card.style.height = '100%';
		}

		// 6. X√≥a Widget
		function deleteWidget(id) {
			if(confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a kh·ªëi n√†y? N√≥ s·∫Ω kh√¥ng hi·ªÉn th·ªã n·ªØa cho ƒë·∫øn khi b·∫°n Reset b·ªë c·ª•c.')) {
				const el = document.getElementById(id);
				el.remove();
				// L∆∞u √Ω: Vi·ªác x√≥a DOM s·∫Ω c√≥ hi·ªáu l·ª±c khi b·∫•m "L∆∞u".
			}
		}
  
		// 8. L∆ØU C·∫§U H√åNH (Ch·ªâ l∆∞u nh·ªØng g√¨ ƒëang hi·ªán th·ªã)
		async function saveLayoutConfig() {
			const grid = document.getElementById('dashboardGrid');
			const items = Array.from(grid.children);
			
			const layoutData = items.map(item => {
				if (!item.classList.contains('widget-item')) return null;
				
				return {
					id: item.id,
					colSpan: item.getAttribute('data-col') || '2',
					type: item.getAttribute('data-type') || 'widget',
					minHeight: item.style.minHeight || '',
					// L∆∞u n·ªôi dung HTML n·∫øu l√† spacer ƒë·ªÉ t√°i t·∫°o
					contentHTML: item.getAttribute('data-type') === 'spacer' ? item.innerHTML : '' 
				};
			}).filter(Boolean);

			try {
				const success = await githubAPI.updateFile(
					config.LAYOUT_CONFIG_PATH,
					layoutData,
					"C·∫≠p nh·∫≠t b·ªë c·ª•c trang ch·ªß (6 cols)"
				);
				
				if (success) {
					showNotification('ƒê√£ l∆∞u b·ªë c·ª•c th√†nh c√¥ng!', 'success');
					toggleEditMode();
				} else {
					showNotification('L·ªói khi l∆∞u b·ªë c·ª•c!', 'error');
				}
			} catch (e) {
				console.error(e);
				showNotification('L·ªói h·ªá th·ªëng khi l∆∞u!', 'error');
			}
		}

		// 9. T·∫¢I C·∫§U H√åNH (QUAN TR·ªåNG: ·∫®n nh·ªØng g√¨ kh√¥ng c√≥ trong JSON)
		async function loadLayoutConfig() {
			try {
				const layoutData = await githubAPI.getRawFile(config.LAYOUT_CONFIG_PATH);
				
				// N·∫øu kh√¥ng c√≥ file config ho·∫∑c file r·ªóng -> D√πng m·∫∑c ƒë·ªãnh HTML -> Return lu√¥n
				if (!Array.isArray(layoutData) || layoutData.length === 0) {
					console.log("D√πng b·ªë c·ª•c m·∫∑c ƒë·ªãnh (HTML g·ªëc)");
					return;
				}

				const grid = document.getElementById('dashboardGrid');
				
				// 1. Map c√°c widget G·ªêC ƒëang c√≥ trong HTML (ƒë·ªÉ t√°i s·ª≠ d·ª•ng)
				const availableWidgets = {};
				Array.from(grid.children).forEach(child => {
					if (child.id) availableWidgets[child.id] = child;
				});
				
				// 2. X√≥a s·∫°ch Grid hi·ªán t·∫°i
				grid.innerHTML = '';
				
				// 3. T√°i t·∫°o l·∫°i Grid d·ª±a tr√™n JSON
				layoutData.forEach(item => {
					let widget = null;
					
					if (item.type === 'spacer') {
						// T·∫°o m·ªõi spacer
						widget = document.createElement('div');
						widget.id = item.id;
						widget.innerHTML = item.contentHTML || '';
						widget.className = `widget-item lg:col-span-${item.colSpan} bg-transparent`; // Trong su·ªët khi view
						widget.setAttribute('data-col', item.colSpan);
						widget.setAttribute('data-type', 'spacer');
					} 
					else if (availableWidgets[item.id]) {
						// L·∫•y widget g·ªëc ra d√πng
						widget = availableWidgets[item.id];
						delete availableWidgets[item.id]; // ƒê√°nh d·∫•u ƒë√£ d√πng
						
						// C·∫≠p nh·∫≠t Class Col-span
						widget.className = widget.className.replace(/lg:col-span-\d/g, ''); // X√≥a class c≈©
						widget.classList.add(`lg:col-span-${item.colSpan}`);
						widget.setAttribute('data-col', item.colSpan);
					}
					
					// C·∫≠p nh·∫≠t chi·ªÅu cao & Append v√†o Grid
					if (widget) {
						if (item.minHeight) {
							widget.style.minHeight = item.minHeight;
							// Fix height cho card con
							const card = widget.querySelector('.love-card');
							if (card) card.style.height = '100%';
						}
						grid.appendChild(widget);
					}
				});

				// 4. Nh·ªØng widget c√≥ trong HTML g·ªëc nh∆∞ng KH√îNG c√≥ trong JSON (ƒë√£ b·ªã x√≥a)
				// -> Ch√∫ng s·∫Ω kh√¥ng ƒë∆∞·ª£c append l·∫°i -> T·ª± ƒë·ªông bi·∫øn m·∫•t.
				// Object.values(availableWidgets) l√∫c n√†y ch·ª©a c√°c widget b·ªã x√≥a.
				Object.values(availableWidgets).forEach(widget => {
					grid.appendChild(widget);
				});

			} catch (e) {
				console.error('L·ªói t·∫£i layout:', e);
			}
		}

		// 10. RESET C·∫§U H√åNH (X√≥a file JSON)
		async function resetLayoutConfig() {
			if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën Reset v·ªÅ m·∫∑c ƒë·ªãnh? M·ªçi t√πy ch·ªânh s·∫Ω b·ªã m·∫•t.")) return;
			
			try {
				// G·ª≠i m·∫£ng r·ªóng [] l√™n server coi nh∆∞ x√≥a
				const success = await githubAPI.updateFile(
					config.LAYOUT_CONFIG_PATH,
					[], // M·∫£ng r·ªóng
					"Reset b·ªë c·ª•c v·ªÅ m·∫∑c ƒë·ªãnh"
				);
				
				if (success) {
					showNotification('ƒê√£ reset b·ªë c·ª•c! Vui l√≤ng t·∫£i l·∫°i trang.', 'success');
					setTimeout(() => location.reload(), 1500);
				} else {
					showNotification('L·ªói khi reset!', 'error');
				}
			} catch (e) {
				console.error(e);
				showNotification('L·ªói h·ªá th·ªëng!', 'error');
			}
		}
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98f60467b36d04e3',t:'MTc2MDYwMTU3MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
