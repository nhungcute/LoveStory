<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Love Story üíï</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Quicksand', sans-serif;
            background: linear-gradient(135deg, #FFF5F7 0%, #FFE8ED 50%, #FFF0F5 100%);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(255, 182, 193, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 105, 180, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(255, 192, 203, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }
        
        .calendar-container {
            background: linear-gradient(145deg, #ffffff 0%, #fef7ff 100%);
            border-radius: 20px;
            box-shadow: 
                0 20px 40px rgba(252, 189, 210, 0.3),
                0 0 0 1px rgba(255, 182, 193, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            overflow: hidden;
            width: 90vw;
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            backdrop-filter: blur(10px);
        }
        
        .calendar-container::before {
            content: '';
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 20px;
            animation: sparkle 2s ease-in-out infinite;
            z-index: 10;
        }
        
        .calendar-container::after {
            content: 'üíñ';
            position: absolute;
            bottom: 15px;
            left: 20px;
            font-size: 18px;
            animation: heartbeat 1.5s ease-in-out infinite;
            z-index: 10;
        }
        
        @keyframes sparkle {
            0%, 100% { transform: scale(1) rotate(0deg); opacity: 0.7; }
            50% { transform: scale(1.2) rotate(180deg); opacity: 1; }
        }
        
        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .calendar-header {
            background: linear-gradient(135deg, #FF85A2 0%, #FF6B9D 50%, #E91E63 100%);
            border-radius: 20px 20px 0 0;
            position: relative;
            overflow: hidden;
        }
        
        .calendar-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 30% 20%, rgba(255, 255, 255, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 70% 80%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }
        
        .calendar-header::after {
            content: 'üå∏ üíï üå∏';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
            opacity: 0.3;
            white-space: nowrap;
            pointer-events: none;
        }
        
        .day-name {
            color: #FF85A2;
            font-weight: 600;
        }
        
        .day-name.weekend {
            color: #FF5252;
        }
        
        .date-cell {
            border-radius: 50%;
            width: clamp(28px, 4vw, 45px);
            height: clamp(28px, 4vw, 45px);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
            margin: auto;
            font-size: clamp(14px, 2.3vw, 23px);
        }
        
        .date-cell:hover {
            background-color: #FFE0E8;
            transform: scale(1.1);
        }
        
        .date-cell.today {
            background-color: #FF85A2;
            color: white;
            font-weight: bold;
        }
        
        .date-cell.active {
            background-color: #FFE0E8;
            color: #FF85A2;
            font-weight: bold;
        }
        
        .date-cell.selected {
            box-shadow: 0 0 0 2px #FF5252;
            z-index: 10;
            font-weight: bold;
        }
        
        .date-cell.today.active {
            background-color: #FF85A2;
            color: white;
        }
        
        .date-cell.other-month {
            opacity: 0.4;
            color: #999;
        }
        
        .date-cell.weekend {
            color: #FF5252;
        }
        
        .date-cell.weekend.other-month {
            color: #FF5252;
            opacity: 0.4;
        }
        
        .date-cell.has-event::after {
            content: '';
            position: absolute;
            bottom: 2px;
            width: 4px;
            height: 4px;
            background-color: #FF85A2;
            border-radius: 50%;
        }
        
        .date-cell.weekend.has-event::after {
            background-color: #FF5252;
        }
        
        .date-cell.today.has-event::after,
        .date-cell.active.has-event::after {
            background-color: white;
        }
        
        .date-cell.anniversary {
            position: relative;
            z-index: 1;
        }
        
        .date-cell.anniversary::before {
            content: '‚ù§Ô∏è';
            position: absolute;
            font-size: 10px;
            top: -2px;
            right: 0px;
            z-index: 1;
        }
        
        .date-cell.anniversary::after {
            content: '‚ù§Ô∏è';
            position: absolute;
            font-size: 10px;
            bottom: -2px;
            left: 0px;
            z-index: 1;
        }
        
        .month-nav {
            transition: all 0.3s ease;
            background-color: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .month-nav:hover {
            transform: scale(1.2);
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        .today-info {
            background: linear-gradient(145deg, #ffffff 0%, #fef7ff 100%);
            border: 2px solid #FFE0E8;
            border-radius: 20px;
            box-shadow: 
                0 8px 25px rgba(252, 189, 210, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            position: relative;
            overflow: hidden;
        }
        
        .today-info::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 182, 193, 0.1) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
            pointer-events: none;
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .today-info > * {
            position: relative;
            z-index: 1;
        }
        
        /* Photo Modal Styles */
        #photoModal .modal-dialog {
            margin: 0;
            width: 100vw;
            height: 100vh;
            max-width: none;
        }
        
        #photoModal .modal-content {
            border-radius: 0;
        }
        
        #photoModal .btn-close {
            transition: all 0.3s ease;
            transform: scale(1);
        }
        
        #photoModal .btn-close:hover {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.2) !important;
        }
        
        #photoModal .modal-header {
            transition: opacity 0.3s ease;
        }
        
        #photoModal .modal-footer {
            transition: opacity 0.3s ease;
        }
        
        #photoModal:hover .modal-header,
        #photoModal:hover .modal-footer {
            opacity: 1;
        }
        
        /* Messenger Style Comment Box */
        .messenger-comment-box {
            margin-top: 6px;
        }
        
        .comment-input-container {
            display: flex;
            align-items: center;
            background: #f0f2f5;
            border-radius: 20px;
            padding: 8px 12px;
            gap: 4px;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }
        
        .comment-input-container.focused {
            background: #ffffff;
            border-color: #e91e63;
            box-shadow: 0 0 0 2px rgba(233, 30, 99, 0.2);
        }
        
        .comment-input {
            flex: 1;
            border: none;
            background: transparent;
            resize: none;
            outline: none;
            font-family: 'Quicksand', sans-serif;
            font-size: 14px;
            line-height: 24px;
            max-height: 100px;
            min-height: 24px;
            padding: 0;
            color: #1c1e21;
            display: flex;
            align-items: center;
        }
        
        .comment-input::placeholder {
            color: #65676b;
        }
        
        .send-button {
            background: #e91e63;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: white;
            flex-shrink: 0;
        }
        
        .send-button:hover:not(:disabled) {
            background: #c2185b;
            transform: scale(1.05);
        }
        
        .send-button:active:not(:disabled) {
            transform: scale(0.95);
        }
        
        .send-button:disabled {
            background: #e4e6ea;
            color: #bcc0c4;
            cursor: not-allowed;
            transform: none;
        }
        
        .send-button svg {
            transition: transform 0.2s ease;
            width: 12px;
            height: 12px;
            display: block;
            margin: 0;
            padding: 0;
        }
        
        .send-button:hover:not(:disabled) svg {
            transform: translateX(1px);
        }
        
        /* Animation for send button */
        @keyframes sendPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .send-button.sending {
            animation: sendPulse 0.3s ease;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            #photoModal .modal-header,
            #photoModal .modal-footer {
                padding: 15px;
            }
            
            #photoModal .btn-close {
                padding: 10px;
            }
            
            #modalImage {
                max-height: 85vh !important;
                max-width: 90vw !important;
            }
            
            .comment-input-container {
                padding: 6px 10px;
            }
            
            .send-button {
                width: 21px;
                height: 21px;
            }
            
            .send-button svg {
                width: 9px;
                height: 9px;
            }
        }
        
        @media (max-width: 576px) {
            #photoModal .modal-header h5 {
                font-size: 1rem;
            }
            
            #photoModal .modal-footer p {
                font-size: 0.9rem;
            }
        }

        .p-4 {
            padding: 0.5rem !important; 
        }

        /* Radial Menu Variables */
        :root {
            --menu-radius: 56px;
            --toggle-size: 40px;
            --item-size: 36px;
            --transition-speed: 0.3s;
            --toggle-btn-color: #ff4e00;
            --toggle-btn-hover: #e63900;
            --item-btn-color: #9CA3AF;
            --item-btn-hover: #6B7280;
            --icon-color: white;
        }

        /* Floating Settings Container */
        .floating-settings {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            user-select: none;
            opacity: 0.5;
            transition: all 0.3s ease;
        }

        .floating-settings.active {
            opacity: 1;
        }

        .floating-settings:hover {
            opacity: 1;
        }

        .floating-settings .toggle-btn:hover {
            opacity: 1;
        }

        .floating-settings:hover .toggle-btn {
            opacity: 1;
        }

        .floating-settings.dragging {
            transition: none !important;
        }

        .floating-settings.dragging .toggle-btn {
            pointer-events: none;
        }

        .radial-menu-container {
            position: relative;
            width: var(--toggle-size);
            height: var(--toggle-size);
        }

        .toggle-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: var(--toggle-size);
            height: var(--toggle-size);
            background: var(--toggle-btn-color);
            border: none;
            border-radius: 50%;
            color: var(--icon-color);
            font-size: calc(var(--toggle-size) * 0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: grab;
            z-index: 10;
            transition: transform var(--transition-speed) cubic-bezier(0.68, -0.55, 0.27, 1.55), background 0.2s ease;
            box-shadow: 0 4px 15px rgba(107, 114, 128, 0.4);
        }

        .toggle-btn:active {
            cursor: grabbing;
        }

        .toggle-btn:hover {
            background: #e63900;
            box-shadow: 0 6px 20px rgba(230, 57, 0, 0.6);
            transform: translate(-50%, -50%) scale(1.05);
        }

        .radial-menu-container.active .toggle-btn {
            transform: translate(-50%, -50%) rotate(135deg);
        }

        .menu {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: calc(var(--menu-radius) * 2.5);
            height: calc(var(--menu-radius) * 2.5);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .radial-menu-container.active .menu {
            opacity: 1;
        }

        .menu .item {
            position: absolute;
            top: 50%;
            left: 50%;
            width: var(--item-size);
            height: var(--item-size);
            margin-top: calc(var(--item-size) / -2);
            margin-left: calc(var(--item-size) / -2);
            background: rgba(156, 163, 175, 0.3);
            border: 1px solid rgba(156, 163, 175, 0.4);
            border-radius: 50%;
            color: #6B7280;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 18px;
            font-weight: bold;
            text-decoration: none;
            opacity: 0;
            transform: translate(0, 0);
            transition: transform var(--transition-speed) ease-out, opacity var(--transition-speed) ease-out, background 0.2s ease, color 0.2s ease, border-color 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            cursor: pointer;
        }

        .menu .item:hover {
            background: rgba(107, 114, 128, 0.4);
            border-color: rgba(107, 114, 128, 0.5);
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
        }

        .radial-menu-container.active .menu .item {
            opacity: 1;
        }

        /* Default positioning (top section) - items appear below */
        .radial-menu-container.active .item:nth-child(1) {
            transform: rotate(0deg) translateY(calc(var(--menu-radius) * 1)) rotate(0deg);
            transition-delay: 0.0s;
        }

        .radial-menu-container.active .item:nth-child(2) {
            transform: rotate(45deg) translateY(calc(var(--menu-radius) * 1)) rotate(-45deg);
            transition-delay: 0.05s;
        }

        .radial-menu-container.active .item:nth-child(3) {
            transform: rotate(90deg) translateY(calc(var(--menu-radius) * 1)) rotate(-90deg);
            transition-delay: 0.1s;
        }

        .radial-menu-container.active .item:nth-child(4) {
            transform: rotate(135deg) translateY(calc(var(--menu-radius) * 1)) rotate(-135deg);
            transition-delay: 0.15s;
        }

        .radial-menu-container.active .item:nth-child(5) {
            transform: rotate(180deg) translateY(calc(var(--menu-radius) * 1)) rotate(-180deg);
            transition-delay: 0.2s;
        }

        /* Open to the RIGHT (when button is on the left edge) */
        .radial-menu-container.open-right.active .item:nth-child(1) { 
            transform: rotate(-90deg) translateY(calc(var(--menu-radius) * -1)); 
            transition-delay: 0.0s; 
        }
        .radial-menu-container.open-right.active .item:nth-child(2) { 
            transform: rotate(-45deg) translateY(calc(var(--menu-radius) * -1)); 
            transition-delay: 0.05s; 
        }
        .radial-menu-container.open-right.active .item:nth-child(3) { 
            transform: rotate(0deg) translateY(calc(var(--menu-radius) * -1)); 
            transition-delay: 0.1s; 
        }
        .radial-menu-container.open-right.active .item:nth-child(4) { 
            transform: rotate(45deg) translateY(calc(var(--menu-radius) * -1)); 
            transition-delay: 0.15s; 
        }
        .radial-menu-container.open-right.active .item:nth-child(5) { 
            transform: rotate(90deg) translateY(calc(var(--menu-radius) * -1)); 
            transition-delay: 0.2s; 
        }
        
        /* Open to the LEFT (when button is on the right edge) */
        .radial-menu-container.open-left.active .item:nth-child(1) { 
            transform: rotate(90deg) translateY(calc(var(--menu-radius) * -1)); 
            transition-delay: 0.0s; 
        }
        .radial-menu-container.open-left.active .item:nth-child(2) { 
            transform: rotate(135deg) translateY(calc(var(--menu-radius) * -1)); 
            transition-delay: 0.05s; 
        }
        .radial-menu-container.open-left.active .item:nth-child(3) { 
            transform: rotate(180deg) translateY(calc(var(--menu-radius) * -1)); 
            transition-delay: 0.1s; 
        }
        .radial-menu-container.open-left.active .item:nth-child(4) { 
            transform: rotate(225deg) translateY(calc(var(--menu-radius) * -1)); 
            transition-delay: 0.15s; 
        }
        .radial-menu-container.open-left.active .item:nth-child(5) { 
            transform: rotate(270deg) translateY(calc(var(--menu-radius) * -1)); 
            transition-delay: 0.2s; 
        }
        
        /* Open UP (when button is on the bottom edge) */
        .radial-menu-container.open-up.active .item:nth-child(1) { 
            transform: rotate(180deg) translateY(calc(var(--menu-radius) * -1)); 
            transition-delay: 0.0s; 
        }
        .radial-menu-container.open-up.active .item:nth-child(2) { 
            transform: rotate(225deg) translateY(calc(var(--menu-radius) * -1)); 
            transition-delay: 0.05s; 
        }
        .radial-menu-container.open-up.active .item:nth-child(3) { 
            transform: rotate(270deg) translateY(calc(var(--menu-radius) * -1)); 
            transition-delay: 0.1s; 
        }
        .radial-menu-container.open-up.active .item:nth-child(4) { 
            transform: rotate(315deg) translateY(calc(var(--menu-radius) * -1)); 
            transition-delay: 0.15s; 
        }
        .radial-menu-container.open-up.active .item:nth-child(5) { 
            transform: rotate(360deg) translateY(calc(var(--menu-radius) * -1)); 
            transition-delay: 0.2s; 
        }
        
        /* Open DOWN (when button is on the top edge) */
        .radial-menu-container.open-down.active .item:nth-child(1) { 
            transform: rotate(0deg) translateY(calc(var(--menu-radius) * -1)); 
            transition-delay: 0.0s; 
        }
        .radial-menu-container.open-down.active .item:nth-child(2) { 
            transform: rotate(45deg) translateY(calc(var(--menu-radius) * -1)); 
            transition-delay: 0.05s; 
        }
        .radial-menu-container.open-down.active .item:nth-child(3) { 
            transform: rotate(90deg) translateY(calc(var(--menu-radius) * -1)); 
            transition-delay: 0.1s; 
        }
        .radial-menu-container.open-down.active .item:nth-child(4) { 
            transform: rotate(135deg) translateY(calc(var(--menu-radius) * -1)); 
            transition-delay: 0.15s; 
        }
        .radial-menu-container.open-down.active .item:nth-child(5) { 
            transform: rotate(180deg) translateY(calc(var(--menu-radius) * -1)); 
            transition-delay: 0.2s; 
        }

        /* Tooltip cho radial menu items */
        .menu .item::before {
            content: attr(data-tooltip);
            position: absolute;
            top: 50%;
            right: calc(100% + 10px);
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 10000;
            pointer-events: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .menu .item:hover::before {
            opacity: 1;
            visibility: visible;
        }

    </style>
</head>
<body class="min-h-screen">
    <!-- Floating Decorations -->
    <div class="fixed inset-0 pointer-events-none z-0">
        <div class="absolute top-10 left-10 text-2xl animate-bounce" style="animation-delay: 0s;">üå∏</div>
        <div class="absolute top-20 right-16 text-xl animate-pulse" style="animation-delay: 1s;">üíñ</div>
        <div class="absolute top-1/3 left-20 text-lg animate-bounce" style="animation-delay: 2s;">‚ú®</div>
        <div class="absolute top-1/2 right-10 text-2xl animate-pulse" style="animation-delay: 0.5s;">üå∫</div>
        <div class="absolute bottom-1/3 left-16 text-xl animate-bounce" style="animation-delay: 1.5s;">üíï</div>
        <div class="absolute bottom-20 right-20 text-lg animate-pulse" style="animation-delay: 2.5s;">ü¶ã</div>
        <div class="absolute bottom-10 left-1/4 text-2xl animate-bounce" style="animation-delay: 3s;">üå∑</div>
        <div class="absolute top-1/4 right-1/3 text-lg animate-pulse" style="animation-delay: 0.8s;">üí´</div>
    </div>

    <!-- Floating Settings Button -->
    <div class="floating-settings">
        <div class="radial-menu-container" id="radialMenuContainer">
            <div class="menu">
                <button class="item" data-tooltip="Th√™m s·ª± ki·ªán" id="floatingAddEvent">
                    <i class="bi bi-file-earmark-plus" style="color: #10B981;"></i>
                </button>
                <button class="item" data-tooltip="X√≥a s·ª± ki·ªán" id="floatingDeleteEvent">
                    <i class="bi bi-trash" style="color: #EF4444;"></i>
                </button>

                <button class="item" data-tooltip="C·∫≠p nh·∫≠t danh s√°ch ·∫£nh" id="floatingUploadMetadata">
                    <i class="bi bi-cloud-download" style="color: white;"></i>
                </button>
                <button class="item" data-tooltip="B·∫≠t/T·∫Øt t·ª± ƒë·ªông 9h s√°ng" id="floatingAutoUpdate">
                    <i class="bi bi-alarm"></i>
                </button>
                <button class="item" data-tooltip="Refresh d·ªØ li·ªáu" id="floatingRefreshPhotos">
                    <i class="bi bi-arrow-repeat" style="color: #06B6D4;"></i>
                </button>
            </div>
            <button class="toggle-btn" id="settingsBtn">
                <i class="bi bi-gear"></i>
            </button>
        </div>
    </div>



    <div class="w-full mx-auto relative z-10">
        <!-- Header -->
        <div class="text-center mb-8 px-4">
            <!-- Header removed -->
        </div>

        <!-- Calendar Container -->
        <div class="calendar-container mx-auto">
            <!-- Calendar Header -->
            <div class="calendar-header p-4 md:p-6">
                <div class="flex items-center justify-between">
                    <button id="prevMonth" class="month-nav">
                        <svg class="w-5 h-5" fill="white" stroke="white" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                    </button>
                    
                    <div class="text-center">
                        <h2 id="monthYear" class="text-xl md:text-2xl font-bold text-white"></h2>
                    </div>
                    
                    <button id="nextMonth" class="month-nav">
                        <svg class="w-5 h-5" fill="white" stroke="white" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Days of Week -->
            <div class="grid grid-cols-7 bg-gray-50 border-b">
                <div class="p-2 md:p-3 text-center font-semibold day-name text-base md:text-lg">CN</div>
                <div class="p-2 md:p-3 text-center font-semibold day-name text-base md:text-lg">T2</div>
                <div class="p-2 md:p-3 text-center font-semibold day-name text-base md:text-lg">T3</div>
                <div class="p-2 md:p-3 text-center font-semibold day-name text-base md:text-lg">T4</div>
                <div class="p-2 md:p-3 text-center font-semibold day-name text-base md:text-lg">T5</div>
                <div class="p-2 md:p-3 text-center font-semibold day-name weekend text-base md:text-lg">T6</div>
                <div class="p-2 md:p-3 text-center font-semibold day-name weekend text-base md:text-lg">T7</div>
            </div>

            <!-- Calendar Days -->
            <div id="calendarDays" class="grid grid-cols-7 p-2">
                <!-- Days will be generated by JavaScript -->
            </div>
        </div>

        <!-- Today's Info and Anniversary Info -->
        <div class="mt-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 w-[90%] max-w-[1200px] mx-auto">
                <div class="today-info px-6 py-4 min-h-[120px] flex flex-col justify-center text-center">
                    <p class="text-gray-600 text-sm">H√¥m nay</p>
                    <p id="todayDate" class="text-lg font-bold text-gray-800"></p>
                </div>
                <div id="anniversaryInfo" class="today-info px-6 py-4 bg-gradient-to-r from-pink-50 to-red-50 border-pink-300 min-h-[120px] flex flex-col justify-center text-center">
                    <p id="anniversaryLabel" class="text-pink-600 text-sm">K·ªâ ni·ªám s·∫Øp t·ªõi</p>
                    <p id="anniversaryDate" class="text-lg font-bold text-pink-800"></p>
                    <p id="daysLeft" class="text-sm text-pink-600 mt-1"></p>
                    <p id="anniversaryYears" class="text-xs text-pink-500"></p>
                </div>
            </div>
        </div>

        <!-- Events List -->
        <div class="mt-8 flex justify-center">
            <div class="calendar-container mx-auto">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-800">üìÖ S·ª± ki·ªán</h3>
                        <div class="flex space-x-2" style="display: none;">
                            <button id="addEventBtn" class="p-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors" data-bs-toggle="modal" data-bs-target="#addEventModal">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
                                </svg>
                            </button>
                            <button id="deleteEventBtn" class="p-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors" disabled>
                                <i class="bi bi-trash"></i>
                            </button>

                        </div>
                    </div>
                    
                    <!-- Loading Spinner -->
                    <div id="loading-spinner" class="hidden flex justify-center items-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-pink-500"></div>
                        <span class="ml-2 text-gray-600">ƒêang t·∫£i...</span>
                    </div>
                    
                    <!-- Events Container -->
                    <div id="eventsContainer" class="space-y-3">
                        <!-- Events will be loaded here -->
                    </div>
                    
                    <!-- Empty State -->
                    <div id="emptyState" class="hidden text-center py-8 text-gray-500">
                        <p>üìù Ch∆∞a c√≥ s·ª± ki·ªán n√†o</p>
                    </div>
                    
                    <!-- Error Message -->
                    <div id="errorMessage" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 text-red-700">
                        <p>‚ùå Kh√¥ng th·ªÉ t·∫£i danh s√°ch s·ª± ki·ªán</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Newsfeed Section -->
        <div class="mt-8 flex justify-center">
            <div class="calendar-container mx-auto">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-gray-800">üì∏ Kho·∫£nh Kh·∫Øc ƒê√°ng Y√™u</h3>
                        <div class="flex space-x-2" style="display: none;">
                            <button id="uploadMetadataBtn" class="p-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors" title="C·∫≠p nh·∫≠t danh s√°ch ·∫£nh">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                                </svg>
                            </button>
                            <button id="autoUpdateToggle" class="p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors" title="B·∫≠t/T·∫Øt c·∫≠p nh·∫≠t t·ª± ƒë·ªông 9h s√°ng">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                                </svg>
                            </button>
                            <button id="refreshPhotos" class="p-2 bg-pink-500 text-white rounded-lg hover:bg-pink-600 transition-colors" title="Refresh d·ªØ li·ªáu">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Loading Spinner for Photos -->
                    <div id="photos-loading-spinner" class="hidden flex justify-center items-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-pink-500"></div>
                        <span class="ml-2 text-gray-600">ƒêang t·∫£i ·∫£nh...</span>
                    </div>
                    
                    <!-- Photos Grid -->
                    <div id="photosGrid" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
                        <!-- Photos will be loaded here -->
                    </div>
                    
                    <!-- Pagination Controls -->
                    <div id="paginationControls" class="hidden mt-8 flex flex-col sm:flex-row items-center justify-between gap-4">
                        <div class="text-sm text-gray-600">
                            Hi·ªÉn th·ªã <span id="currentRange"></span> trong t·ªïng s·ªë <span id="totalPhotos"></span> ·∫£nh
                        </div>
                        
                        <div class="flex items-center gap-2">
                            <button id="firstPageBtn" class="px-3 py-2 text-sm bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                                <i class="bi bi-chevron-double-left"></i>
                            </button>
                            <button id="prevPageBtn" class="px-3 py-2 text-sm bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                                <i class="bi bi-chevron-left"></i>
                            </button>
                            
                            <div class="flex items-center gap-1" id="pageNumbers">
                                <!-- Page numbers will be generated here -->
                            </div>
                            
                            <button id="nextPageBtn" class="px-3 py-2 text-sm bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                                <i class="bi bi-chevron-right"></i>
                            </button>
                            <button id="lastPageBtn" class="px-3 py-2 text-sm bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                                <i class="bi bi-chevron-double-right"></i>
                            </button>
                        </div>
                        
                        <div class="text-sm text-gray-600">
                            Trang <span id="currentPageDisplay"></span> / <span id="totalPagesDisplay"></span>
                        </div>
                    </div>
                    
                    <!-- Empty State for Photos -->
                    <div id="photosEmptyState" class="hidden text-center py-8 text-gray-500">
                        <p>üì∑ Ch∆∞a c√≥ ·∫£nh n√†o</p>
                    </div>
                    
                    <!-- Error Message for Photos -->
                    <div id="photosErrorMessage" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 text-red-700">
                        <p>‚ùå Kh√¥ng th·ªÉ t·∫£i danh s√°ch ·∫£nh</p>
                    </div>
                </div>
            </div>
        </div>

    </div>



    <!-- Modal Th√™m S·ª± Ki·ªán -->
    <div class="modal fade" id="addEventModal" tabindex="-1" aria-labelledby="addEventModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-gradient-to-r from-pink-500 to-purple-600 text-white">
                    <h5 class="modal-title" id="addEventModalLabel">‚ú® Th√™m M·ªõi S·ª± Ki·ªán</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addEventForm">
                        <!-- Ng√†y s·ª± ki·ªán -->
                        <div class="mb-3">
                            <label for="eventDate" class="form-label fw-bold">üìÖ Ng√†y s·ª± ki·ªán</label>
                            <input type="date" class="form-control" id="eventDate" required>
                            <div class="form-text">Ho·∫∑c nh·∫≠p theo ƒë·ªãnh d·∫°ng DD/MM/YYYY</div>
                        </div>

                        <!-- N·ªôi dung -->
                        <div class="mb-3">
                            <label for="eventContent" class="form-label fw-bold">üìù N·ªôi dung</label>
                            <textarea class="form-control" id="eventContent" rows="3" placeholder="Nh·∫≠p n·ªôi dung s·ª± ki·ªán..." required></textarea>
                        </div>

                        <!-- M√†u -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">üé® M√†u</label>
                            <div class="d-flex flex-wrap gap-2 mt-2 justify-content-center justify-content-sm-start">
                                <input type="radio" class="btn-check" name="eventColor" id="color-pink" value="bg-pink-500" checked>
                                <label class="btn btn-outline-secondary p-2" for="color-pink">
                                    <div class="w-6 h-6 bg-pink-500 rounded" style="width: 24px; height: 24px;"></div>
                                </label>

                                <input type="radio" class="btn-check" name="eventColor" id="color-blue" value="bg-blue-500">
                                <label class="btn btn-outline-secondary p-2" for="color-blue">
                                    <div class="w-6 h-6 bg-blue-500 rounded" style="width: 24px; height: 24px;"></div>
                                </label>

                                <input type="radio" class="btn-check" name="eventColor" id="color-green" value="bg-green-500">
                                <label class="btn btn-outline-secondary p-2" for="color-green">
                                    <div class="w-6 h-6 bg-green-500 rounded" style="width: 24px; height: 24px;"></div>
                                </label>

                                <input type="radio" class="btn-check" name="eventColor" id="color-yellow" value="bg-yellow-500">
                                <label class="btn btn-outline-secondary p-2" for="color-yellow">
                                    <div class="w-6 h-6 bg-yellow-500 rounded" style="width: 24px; height: 24px;"></div>
                                </label>

                                <input type="radio" class="btn-check" name="eventColor" id="color-purple" value="bg-purple-500">
                                <label class="btn btn-outline-secondary p-2" for="color-purple">
                                    <div class="w-6 h-6 bg-purple-500 rounded" style="width: 24px; height: 24px;"></div>
                                </label>

                                <input type="radio" class="btn-check" name="eventColor" id="color-red" value="bg-red-500">
                                <label class="btn btn-outline-secondary p-2" for="color-red">
                                    <div class="w-6 h-6 bg-red-500 rounded" style="width: 24px; height: 24px;"></div>
                                </label>
                            </div>
                        </div>

                        <!-- Icon -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">üé≠ Icon</label>
                            <div class="d-flex flex-wrap gap-2 mt-2 justify-content-center justify-content-sm-start">
                                <input type="radio" class="btn-check" name="eventIcon" id="icon-heart" value="‚ù§Ô∏è" checked>
                                <label class="btn btn-outline-secondary" for="icon-heart">‚ù§Ô∏è</label>

                                <input type="radio" class="btn-check" name="eventIcon" id="icon-star" value="‚≠ê">
                                <label class="btn btn-outline-secondary" for="icon-star">‚≠ê</label>

                                <input type="radio" class="btn-check" name="eventIcon" id="icon-cake" value="üéÇ">
                                <label class="btn btn-outline-secondary" for="icon-cake">üéÇ</label>

                                <input type="radio" class="btn-check" name="eventIcon" id="icon-gift" value="üéÅ">
                                <label class="btn btn-outline-secondary" for="icon-gift">üéÅ</label>

                                <input type="radio" class="btn-check" name="eventIcon" id="icon-party" value="üéâ">
                                <label class="btn btn-outline-secondary" for="icon-party">üéâ</label>

                                <input type="radio" class="btn-check" name="eventIcon" id="icon-music" value="üéµ">
                                <label class="btn btn-outline-secondary" for="icon-music">üéµ</label>

                                <input type="radio" class="btn-check" name="eventIcon" id="icon-travel" value="‚úàÔ∏è">
                                <label class="btn btn-outline-secondary" for="icon-travel">‚úàÔ∏è</label>

                                <input type="radio" class="btn-check" name="eventIcon" id="icon-work" value="üíº">
                                <label class="btn btn-outline-secondary" for="icon-work">üíº</label>
                            </div>
                        </div>

                        <!-- Folder ·∫£nh -->
                        <div class="mb-3">
                            <label for="eventImageFolder" class="form-label fw-bold">üìÅ Folder ·∫£nh</label>
                            <input type="text" class="form-control" id="eventImageFolder" placeholder="Nh·∫≠p ƒë∆∞·ªùng d·∫´n folder ·∫£nh...">
                            <div class="form-text">T√πy ch·ªçn: ƒê∆∞·ªùng d·∫´n ƒë·∫øn th∆∞ m·ª•c ch·ª©a ·∫£nh li√™n quan</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-primary" id="saveEventBtn">
                        <span class="spinner-border spinner-border-sm d-none" id="saveSpinner" role="status" aria-hidden="true"></span>
                        üíæ L∆∞u S·ª± Ki·ªán
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Photo Modal -->
    <div class="modal fade" id="photoModal" tabindex="-1" aria-labelledby="photoModalLabel" aria-hidden="true" data-bs-backdrop="true" data-bs-keyboard="true">
        <div class="modal-dialog modal-fullscreen-lg-down modal-xl modal-dialog-centered">
            <div class="modal-content bg-transparent border-0 h-100">
                <!-- Header v·ªõi n√∫t ƒë√≥ng -->
                <div class="modal-header border-0 position-absolute w-100 d-flex justify-content-between align-items-center p-3" style="top: 0; left: 0; z-index: 1060; background: linear-gradient(180deg, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0.3) 50%, transparent 100%);">
                    <h5 id="photoModalTitle" class="modal-title text-white fw-bold m-0" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.8);"></h5>
                    <button type="button" class="position-relative" onclick="closePhotoModal()" aria-label="ƒê√≥ng" style="background: white; border: none; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; color: red; font-size: 18px; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
                        ‚úï
                    </button>
                </div>
                
                <!-- N√∫t ƒëi·ªÅu h∆∞·ªõng cƒÉn gi·ªØa -->
                <button type="button" id="prevPhotoBtn" class="btn btn-outline-light position-absolute" onclick="navigatePhoto(-1)" style="left: 20px; top: 50%; transform: translateY(-50%); z-index: 1060; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.6); border: 2px solid rgba(255,255,255,0.3); backdrop-filter: blur(10px);">
                    <i class="bi bi-chevron-left" style="font-size: 20px;"></i>
                </button>
                <button type="button" id="nextPhotoBtn" class="btn btn-outline-light position-absolute" onclick="navigatePhoto(1)" style="right: 20px; top: 50%; transform: translateY(-50%); z-index: 1060; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.6); border: 2px solid rgba(255,255,255,0.3); backdrop-filter: blur(10px);">
                    <i class="bi bi-chevron-right" style="font-size: 20px;"></i>
                </button>
                
                <!-- Body ch·ª©a ·∫£nh -->
                <div class="modal-body p-0 d-flex align-items-center justify-content-center h-100 position-relative" style="background: rgba(0,0,0,0.9);">
                    <!-- Loading spinner -->
                    <div id="imageLoadingSpinner" class="position-absolute d-flex flex-column align-items-center justify-content-center text-white">
                        <div class="spinner-border text-light mb-3" role="status" style="width: 3rem; height: 3rem;">
                            <span class="visually-hidden">ƒêang t·∫£i...</span>
                        </div>
                        <p class="text-center">ƒêang t·∫£i ·∫£nh...</p>
                    </div>
                    
                    <!-- ·∫¢nh ch√≠nh -->
                    <img id="modalImage" src="" alt="Photo" class="img-fluid d-none" 
                         style="max-height: 90vh; max-width: 95vw; object-fit: contain; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);"
                         onload="handleImageLoad()" 
                         onerror="handleImageError()">
                    
                    <!-- Th√¥ng b√°o l·ªói -->
                    <div id="imageErrorMessage" class="d-none text-center text-white">
                        <div class="mb-3">
                            <i class="bi bi-exclamation-triangle" style="font-size: 3rem;"></i>
                        </div>
                        <h5>Kh√¥ng th·ªÉ t·∫£i ·∫£nh</h5>
                        <p class="text-muted">Vui l√≤ng th·ª≠ l·∫°i sau</p>
                    </div>
                </div>
                
                <!-- Footer v·ªõi th√¥ng tin ·∫£nh -->
                <div class="modal-footer border-0 position-absolute w-100 d-flex justify-content-center p-3" style="bottom: 0; left: 0; z-index: 1060; background: linear-gradient(0deg, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0.3) 50%, transparent 100%);">
                    <p id="photoModalDescription" class="text-white text-center m-0" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.8);"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Ch·ªçn S·ª± Ki·ªán Cho ·∫¢nh -->
    <div class="modal fade" id="eventSelectionModal" tabindex="-1" aria-labelledby="eventSelectionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-gradient-to-r from-blue-500 to-purple-600 text-white">
                    <h5 class="modal-title" id="eventSelectionModalLabel">
                        <i class="bi bi-camera-fill me-2"></i>
                        Th√™m ·∫¢nh V√†o S·ª± Ki·ªán
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <p class="text-muted">Ch·ªçn s·ª± ki·ªán ƒë·ªÉ th√™m ·∫£nh n√†y v√†o:</p>
                        <div id="selectedPhotoInfo" class="bg-light p-3 rounded mb-3">
                            <!-- Th√¥ng tin ·∫£nh ƒë∆∞·ª£c ch·ªçn s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                        </div>
                    </div>
                    
                    <!-- Loading Spinner -->
                    <div id="eventSelection-loading-spinner" class="hidden flex justify-center items-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                        <span class="ml-2 text-gray-600">ƒêang t·∫£i danh s√°ch s·ª± ki·ªán...</span>
                    </div>
                    
                    <!-- Danh s√°ch s·ª± ki·ªán -->
                    <div id="eventSelectionList" class="space-y-2 max-h-96 overflow-y-auto">
                        <!-- Danh s√°ch s·ª± ki·ªán s·∫Ω ƒë∆∞·ª£c t·∫£i ·ªü ƒë√¢y -->
                    </div>
                    
                    <!-- Empty State -->
                    <div id="eventSelection-emptyState" class="hidden text-center py-8 text-gray-500">
                        <i class="bi bi-calendar-x display-1 text-muted"></i>
                        <p class="mt-3">Ch∆∞a c√≥ s·ª± ki·ªán n√†o</p>
                        <p class="text-sm">Vui l√≤ng t·∫°o s·ª± ki·ªán tr∆∞·ªõc khi th√™m ·∫£nh</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                    <button type="button" class="btn btn-primary" id="savePhotoToEventsBtn" disabled>
                        <span class="spinner-border spinner-border-sm d-none" id="savePhotoSpinner" role="status" aria-hidden="true"></span>
                        <i class="bi bi-check-lg me-1"></i>
                        L∆∞u Thay ƒê·ªïi
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Hi·ªÉn Th·ªã ·∫¢nh C·ªßa S·ª± Ki·ªán -->
    <div class="modal fade" id="eventPhotosModal" tabindex="-1" aria-labelledby="eventPhotosModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-gradient-to-r from-pink-500 to-purple-600 text-white">
                    <h5 class="modal-title" id="eventPhotosModalLabel">
                        <i class="bi bi-images me-2"></i>
                        ·∫¢nh C·ªßa S·ª± Ki·ªán
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="eventPhotosInfo" class="mb-4">
                        <!-- Th√¥ng tin s·ª± ki·ªán s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                    </div>
                    
                    <!-- Loading Spinner -->
                    <div id="eventPhotos-loading-spinner" class="hidden flex justify-center items-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-pink-500"></div>
                        <span class="ml-2 text-gray-600">ƒêang t·∫£i ·∫£nh...</span>
                    </div>
                    
                    <!-- Grid ·∫£nh -->
                    <div id="eventPhotosGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        <!-- ·∫¢nh s·∫Ω ƒë∆∞·ª£c t·∫£i ·ªü ƒë√¢y -->
                    </div>
                    
                    <!-- Empty State -->
                    <div id="eventPhotos-emptyState" class="hidden text-center py-8 text-gray-500">
                        <i class="bi bi-image display-1 text-muted"></i>
                        <p class="mt-3">S·ª± ki·ªán n√†y ch∆∞a c√≥ ·∫£nh n√†o</p>
                        <p class="text-sm">S·ª≠ d·ª•ng n√∫t <i class="bi bi-camera-fill"></i> tr√™n ·∫£nh ƒë·ªÉ th√™m v√†o s·ª± ki·ªán n√†y</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal X√°c Nh·∫≠n X√≥a -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deleteConfirmModalLabel">
                        <i class="bi bi-trash me-2"></i>
                        X√°c Nh·∫≠n X√≥a
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-3">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a s·ª± ki·ªán n√†y kh√¥ng?</p>
                    <div id="eventToDelete" class="bg-light p-3 rounded">
                        <!-- Th√¥ng tin s·ª± ki·ªán s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                    </div>
                    <p class="text-muted mt-2 mb-0"><small>‚ö†Ô∏è H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!</small></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                        <span class="spinner-border spinner-border-sm d-none" id="deleteSpinner" role="status" aria-hidden="true"></span>
                        <i class="bi bi-trash me-1"></i>
                        X√≥a S·ª± Ki·ªán
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Bi·∫øn c·∫•u h√¨nh to√†n c·ª•c
        let CONFIG = {};
        let GITHUB_USERNAME, REPO_NAME, PAT, FILE_PATH, COMMENTS_FILE_PATH, PHOTOS_METADATA_FILE_PATH, LOGS_FILE_PATH;
        let API_BASE_URL, COMMENTS_API_URL, PHOTOS_METADATA_API_URL, LOGS_API_URL;
        let FOLDER_ID, API_KEY, PHOTOS_PER_PAGE;
        let CONFIG_API_URL;

        // H√†m c·∫≠p nh·∫≠t file c·∫•u h√¨nh
        async function updateConfigFile(key, value) {
            try {
                // ƒê·ªçc file c·∫•u h√¨nh hi·ªán t·∫°i
                const response = await fetch(CONFIG_API_URL, {
                    headers: {
                        'Authorization': `token ${PAT}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const currentConfig = JSON.parse(base64Decode(data.content));
                
                // C·∫≠p nh·∫≠t gi√° tr·ªã
                currentConfig[key] = value;
                CONFIG[key] = value; // C·∫≠p nh·∫≠t bi·∫øn to√†n c·ª•c
                
                // Ghi l·∫°i file c·∫•u h√¨nh
                const updatedContent = JSON.stringify(currentConfig, null, 2);
                const encodedContent = base64Encode(updatedContent);
                
                const updateResponse = await fetch(CONFIG_API_URL, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${PAT}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify({
                        message: `C·∫≠p nh·∫≠t c·∫•u h√¨nh ${key} = ${value}`,
                        content: encodedContent,
                        sha: data.sha
                    })
                });
                
                if (!updateResponse.ok) {
                    throw new Error(`HTTP error! status: ${updateResponse.status}`);
                }
                
                console.log(`‚úÖ ƒê√£ c·∫≠p nh·∫≠t c·∫•u h√¨nh ${key} = ${value}`);
                
            } catch (error) {
                console.error('‚ùå L·ªói khi c·∫≠p nh·∫≠t file c·∫•u h√¨nh:', error);
                // Kh√¥ng throw error ƒë·ªÉ kh√¥ng ·∫£nh h∆∞·ªüng ƒë·∫øn ch·ª©c nƒÉng ch√≠nh
            }
        }

        // H√†m t·∫£i c·∫•u h√¨nh t·ª´ file configApp.json
        async function loadConfig() {
            try {
                console.log('üîß ƒêang t·∫£i c·∫•u h√¨nh t·ª´ configApp.json...');
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 gi√¢y timeout
                
                const response = await fetch('./configApp.json', {
                    signal: controller.signal,
                    cache: 'no-cache'
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    console.error(`‚ùå HTTP Error: ${response.status} - ${response.statusText}`);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                CONFIG = await response.json();
                console.log('üìÑ Raw config loaded:', CONFIG);
                
                // Ki·ªÉm tra c√°c tr∆∞·ªùng b·∫Øt bu·ªôc v·ªõi logging chi ti·∫øt
                const requiredFields = ['GITHUB_USERNAME', 'REPO_NAME', 'PAT1', 'PAT2'];
                const missingFields = requiredFields.filter(field => !CONFIG[field]);
                
                if (missingFields.length > 0) {
                    console.error('‚ùå Thi·∫øu c√°c tr∆∞·ªùng b·∫Øt bu·ªôc:', missingFields);
                    throw new Error(`Thi·∫øu c·∫•u h√¨nh: ${missingFields.join(', ')}`);
                }
                
                // Thi·∫øt l·∫≠p c√°c bi·∫øn t·ª´ config
                GITHUB_USERNAME = CONFIG.GITHUB_USERNAME;
                REPO_NAME = CONFIG.REPO_NAME;
                PAT = CONFIG.PAT1 + CONFIG.PAT2; // Gh√©p PAT1 v√† PAT2
                FILE_PATH = CONFIG.FILE_PATH || 'events.json';
                COMMENTS_FILE_PATH = CONFIG.COMMENTS_FILE_PATH || 'comments.json';
                PHOTOS_METADATA_FILE_PATH = CONFIG.PHOTOS_METADATA_FILE_PATH || 'photos_metadata.json';
                LOGS_FILE_PATH = CONFIG.LOGS_FILE_PATH || 'logs.json';
                
                // Thi·∫øt l·∫≠p c√°c URL API
                API_BASE_URL = `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${FILE_PATH}`;
                COMMENTS_API_URL = `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${COMMENTS_FILE_PATH}`;
                PHOTOS_METADATA_API_URL = `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${PHOTOS_METADATA_FILE_PATH}`;
                LOGS_API_URL = `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${LOGS_FILE_PATH}`;
                CONFIG_API_URL = `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/configApp.json`;
                
                // C·∫•u h√¨nh Google Drive API
                FOLDER_ID = CONFIG.FOLDER_ID || '';
                API_KEY = CONFIG.API_KEY || '';
                PHOTOS_PER_PAGE = CONFIG.PHOTOS_PER_PAGE || 12;
                
                console.log('‚úÖ ƒê√£ t·∫£i c·∫•u h√¨nh th√†nh c√¥ng:', {
                    username: GITHUB_USERNAME,
                    repo: REPO_NAME,
                    folderId: FOLDER_ID ? 'C√≥' : 'Kh√¥ng c√≥',
                    apiKey: API_KEY ? 'C√≥' : 'Kh√¥ng c√≥',
                    photosPerPage: PHOTOS_PER_PAGE,
                    autoLoadMetadata: CONFIG.AUTO_LOAD_METADATA
                });
                
                return true;
            } catch (error) {
                console.error('‚ùå Chi ti·∫øt l·ªói khi t·∫£i c·∫•u h√¨nh:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
                
                let errorMessage = '‚ùå Kh√¥ng th·ªÉ t·∫£i c·∫•u h√¨nh ·ª©ng d·ª•ng';
                
                if (error.name === 'AbortError') {
                    errorMessage = '‚è∞ Timeout khi t·∫£i c·∫•u h√¨nh (qu√° 10 gi√¢y)';
                } else if (error.message.includes('404')) {
                    errorMessage = 'üìÑ Kh√¥ng t√¨m th·∫•y file configApp.json';
                } else if (error.message.includes('Thi·∫øu c·∫•u h√¨nh')) {
                    errorMessage = `üîß ${error.message}`;
                } else if (error.message.includes('JSON')) {
                    errorMessage = 'üìù File c·∫•u h√¨nh kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng JSON';
                }
                
                showMessage(errorMessage, 'error');
                throw error;
            }
        }

        // Global variables
        let allPhotosData = [];
        let currentPhotosPage = [];
        let commentsData = {};
        let reactionsData = {};
        let currentPage = 1;
        let totalPages = 1;
        let isLoadingPhotos = false;
        let autoUpdateInterval = null;
        let selectedPhotoId = null;
        let selectedEventsForPhoto = new Set();

        // H·ªá th·ªëng logging
        async function readLogs() {
            try {
                const response = await fetch(LOGS_API_URL, {
                    headers: {
                        'Authorization': `token ${PAT}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 404) {
                        // File ch∆∞a t·ªìn t·∫°i, t·∫°o file m·ªõi
                        return { content: [], sha: null };
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const content = JSON.parse(base64Decode(data.content));
                return { content, sha: data.sha };
            } catch (error) {
                console.error('L·ªói khi ƒë·ªçc logs t·ª´ GitHub:', error);
                return { content: [], sha: null };
            }
        }

        async function writeLogs(logsArray, sha) {
            const content = JSON.stringify(logsArray, null, 2);
            const encodedContent = base64Encode(content);

            const body = JSON.stringify({
                message: 'C·∫≠p nh·∫≠t logs ho·∫°t ƒë·ªông',
                content: encodedContent,
                ...(sha && { sha: sha })
            });

            try {
                const response = await fetch(LOGS_API_URL, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${PAT}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: body
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('ƒê√£ ghi log th√†nh c√¥ng l√™n GitHub:', data);
                return data;
            } catch (error) {
                console.error('L·ªói khi ghi log l√™n GitHub:', error);
                throw error;
            }
        }

        async function addLog(action, details = '') {
            try {
                const now = new Date();
                const vietnamTime = new Date(now.getTime() + (7 * 60 * 60 * 1000)); // UTC+7
                
                const logEntry = {
                    date: vietnamTime.toLocaleDateString('vi-VN'),
                    time: vietnamTime.toLocaleTimeString('vi-VN'),
                    action: action,
                    details: details,
                    timestamp: vietnamTime.toISOString()
                };

                // ƒê·ªçc logs hi·ªán t·∫°i
                const { content: currentLogs, sha } = await readLogs();
                
                // Th√™m log m·ªõi v√†o ƒë·∫ßu m·∫£ng (log m·ªõi nh·∫•t ·ªü tr√™n)
                currentLogs.unshift(logEntry);
                
                // Gi·ªõi h·∫°n s·ªë l∆∞·ª£ng logs (gi·ªØ 1000 logs g·∫ßn nh·∫•t)
                if (currentLogs.length > 1000) {
                    currentLogs.splice(1000);
                }
                
                // Ghi l·∫°i logs
                await writeLogs(currentLogs, sha);
                
                console.log('ƒê√£ th√™m log:', logEntry);
            } catch (error) {
                console.error('L·ªói khi th√™m log:', error);
                // Kh√¥ng throw error ƒë·ªÉ kh√¥ng ·∫£nh h∆∞·ªüng ƒë·∫øn ch·ª©c nƒÉng ch√≠nh
            }
        }

        // H√†m ki·ªÉm tra v√† t·ª± ƒë·ªông c·∫≠p nh·∫≠t metadata
        function setupAutoUpdate() {
            // Ki·ªÉm tra xem ƒë√£ ƒë·∫øn gi·ªù c·∫≠p nh·∫≠t ch∆∞a
            function checkAndUpdate() {
                const now = new Date();
                const hour = now.getHours();
                const minute = now.getMinutes();
                
                // Ki·ªÉm tra n·∫øu l√† 9h s√°ng (t·ª´ 9:00 ƒë·∫øn 9:05)
                if (hour === 9 && minute >= 0 && minute <= 5) {
                    const lastUpdateKey = 'lastMetadataUpdate';
                    const today = now.toDateString();
                    const lastUpdate = localStorage.getItem(lastUpdateKey);
                    
                    // Ch·ªâ c·∫≠p nh·∫≠t n·∫øu ch∆∞a c·∫≠p nh·∫≠t h√¥m nay
                    if (lastUpdate !== today) {
                        console.log('üïò B·∫Øt ƒë·∫ßu c·∫≠p nh·∫≠t metadata t·ª± ƒë·ªông l√∫c 9h s√°ng...');
                        uploadPhotosMetadata(true).then((photoCount) => {
                            localStorage.setItem(lastUpdateKey, today);
                            showMessage('üåÖ ƒê√£ t·ª± ƒë·ªông c·∫≠p nh·∫≠t metadata ·∫£nh l√∫c 9h s√°ng!', 'success');
                            // Log ƒë√£ ƒë∆∞·ª£c th√™m trong h√†m uploadPhotosMetadata
                            
                            // Th√™m log ho√†n th√†nh
                            addLog('Ch·ª©c nƒÉng c·∫≠p nh·∫≠t t·ª± ƒë·ªông 9h s√°ng ch·∫°y ho√†n th√†nh', `Th√†nh c√¥ng: ${photoCount} ·∫£nh`);
                        }).catch(error => {
                            console.error('L·ªói c·∫≠p nh·∫≠t t·ª± ƒë·ªông:', error);
                            showMessage('‚ö†Ô∏è C·∫≠p nh·∫≠t t·ª± ƒë·ªông th·∫•t b·∫°i. Vui l√≤ng c·∫≠p nh·∫≠t th·ªß c√¥ng.', 'error');
                            // Th√™m log l·ªói
                            addLog('C·∫≠p nh·∫≠t danh s√°ch ·∫£nh v√†o file metadata t·ª± ƒë·ªông', 'Th·∫•t b·∫°i: ' + error.message);
                            addLog('Ch·ª©c nƒÉng c·∫≠p nh·∫≠t t·ª± ƒë·ªông 9h s√°ng ch·∫°y ho√†n th√†nh', 'Th·∫•t b·∫°i: ' + error.message);
                        });
                    }
                }
            }
            
            // Ki·ªÉm tra m·ªói ph√∫t
            autoUpdateInterval = setInterval(checkAndUpdate, 60000);
            
            // Ki·ªÉm tra ngay khi kh·ªüi ƒë·ªông
            checkAndUpdate();
            
            console.log('‚è∞ ƒê√£ thi·∫øt l·∫≠p c·∫≠p nh·∫≠t t·ª± ƒë·ªông metadata l√∫c 9h s√°ng h·∫±ng ng√†y');
        }

        // H√†m d·ª´ng t·ª± ƒë·ªông c·∫≠p nh·∫≠t
        function stopAutoUpdate() {
            if (autoUpdateInterval) {
                clearInterval(autoUpdateInterval);
                autoUpdateInterval = null;
                console.log('‚èπÔ∏è ƒê√£ d·ª´ng c·∫≠p nh·∫≠t t·ª± ƒë·ªông');
            }
        }

        // H√†m upload metadata ·∫£nh l√™n GitHub
        async function uploadPhotosMetadata(isAutoUpdate = false) {
            const uploadBtn = document.getElementById('uploadMetadataBtn');
            const loadingSpinner = document.getElementById('photos-loading-spinner');
            const photosGrid = document.getElementById('photosGrid');
            const emptyState = document.getElementById('photosEmptyState');
            const errorMessage = document.getElementById('photosErrorMessage');
            
            if (isLoadingPhotos) return;
            isLoadingPhotos = true;
            
            try {
                // Hi·ªÉn th·ªã loading
                loadingSpinner.classList.remove('hidden');
                photosGrid.innerHTML = '';
                emptyState.classList.add('hidden');
                errorMessage.classList.add('hidden');
                uploadBtn.disabled = true;
                
                // C·∫≠p nh·∫≠t text loading
                const loadingText = loadingSpinner.querySelector('span');
                if (loadingText) {
                    const updateType = isAutoUpdate ? 't·ª± ƒë·ªông' : 'th·ªß c√¥ng';
                    loadingText.textContent = `ƒêang t·∫£i metadata t·ª´ Google Drive (${updateType})...`;
                }
                
                // T·∫£i t·∫•t c·∫£ ·∫£nh t·ª´ Google Drive
                let allFiles = [];
                let nextPageToken = '';
                let pageCount = 0;
                
                do {
                    const url = `https://www.googleapis.com/drive/v3/files?q='${FOLDER_ID}'+in+parents+and+mimeType+contains+'image/'&key=${API_KEY}&fields=files(id,name,webViewLink,thumbnailLink,webContentLink,createdTime,modifiedTime,size),nextPageToken&pageSize=1000${nextPageToken ? `&pageToken=${nextPageToken}` : ''}`;
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 gi√¢y timeout
                    
                    const response = await fetch(url, {
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    allFiles = allFiles.concat(data.files || []);
                    nextPageToken = data.nextPageToken || '';
                    pageCount++;
                    
                    // C·∫≠p nh·∫≠t loading v·ªõi s·ªë l∆∞·ª£ng ·∫£nh ƒë√£ t·∫£i
                    if (loadingText) {
                        loadingText.textContent = `ƒêang t·∫£i metadata... (${allFiles.length} ·∫£nh, trang ${pageCount})`;
                    }
                    
                    // Th√™m delay nh·ªè gi·ªØa c√°c request ƒë·ªÉ tr√°nh rate limit
                    if (nextPageToken) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                    
                } while (nextPageToken);
                
                // C·∫≠p nh·∫≠t text loading
                if (loadingText) {
                    loadingText.textContent = `ƒêang l∆∞u metadata l√™n GitHub... (${allFiles.length} ·∫£nh)`;
                }
                
                // L∆∞u metadata l√™n GitHub
                await writePhotosMetadata(allFiles);
                
                // C·∫≠p nh·∫≠t d·ªØ li·ªáu local
                allPhotosData = allFiles;
                totalPages = Math.ceil(allPhotosData.length / PHOTOS_PER_PAGE);
                currentPage = 1;
                
                // T·∫£i comments v√† reactions
                const { content: commentsArray } = await readComments();
                commentsData = {};
                reactionsData = {};
                
                if (Array.isArray(commentsArray)) {
                    commentsArray.forEach(entry => {
                        if (entry.ID_IMG) {
                            if (entry.comments && Array.isArray(entry.comments)) {
                                if (!commentsData[entry.ID_IMG]) {
                                    commentsData[entry.ID_IMG] = [];
                                }
                                entry.comments.forEach(comment => {
                                    commentsData[entry.ID_IMG].push({
                                        text: comment.comment,
                                        timestamp: comment.date_input
                                    });
                                });
                            }
                            
                            reactionsData[entry.ID_IMG] = {
                                count_tim: entry.count_tim || 0
                            };
                        }
                    });
                }
                
                loadingSpinner.classList.add('hidden');
                
                if (allPhotosData.length === 0) {
                    emptyState.classList.remove('hidden');
                    showMessage('Kh√¥ng t√¨m th·∫•y ·∫£nh n√†o trong folder!', 'error');
                    return;
                }
                
                // Hi·ªÉn th·ªã trang ƒë·∫ßu ti√™n
                displayPhotosPage(1);
                updatePaginationControls();
                
                const updateType = isAutoUpdate ? 't·ª± ƒë·ªông' : 'th·ªß c√¥ng';
                showMessage(`‚úÖ ƒê√£ c·∫≠p nh·∫≠t ${updateType} th√†nh c√¥ng ${allFiles.length} ·∫£nh l√™n GitHub!`, 'success');
                
                // Th√™m log cho c·∫£ hai lo·∫°i c·∫≠p nh·∫≠t
                if (isAutoUpdate) {
                    addLog('C·∫≠p nh·∫≠t danh s√°ch ·∫£nh v√†o file metadata t·ª± ƒë·ªông', `${allFiles.length} ·∫£nh`);
                } else {
                    addLog('C·∫≠p nh·∫≠t danh s√°ch ·∫£nh v√†o file metadata th·ªß c√¥ng', `${allFiles.length} ·∫£nh`);
                }
                
                // Tr·∫£ v·ªÅ s·ªë l∆∞·ª£ng ·∫£nh ƒë·ªÉ s·ª≠ d·ª•ng trong log t·ª± ƒë·ªông
                return allFiles.length;
                
            } catch (error) {
                console.error('L·ªói khi upload metadata:', error);
                loadingSpinner.classList.add('hidden');
                
                if (error.name === 'AbortError') {
                    errorMessage.querySelector('p').textContent = '‚è∞ Upload metadata b·ªã timeout. Vui l√≤ng th·ª≠ l·∫°i.';
                } else if (error.message.includes('403')) {
                    errorMessage.querySelector('p').textContent = 'üîí Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p folder ·∫£nh ho·∫∑c GitHub.';
                } else if (error.message.includes('404')) {
                    errorMessage.querySelector('p').textContent = 'üìÅ Kh√¥ng t√¨m th·∫•y folder ·∫£nh ho·∫∑c repository.';
                } else {
                    errorMessage.querySelector('p').textContent = '‚ùå Kh√¥ng th·ªÉ upload metadata. Vui l√≤ng th·ª≠ l·∫°i.';
                }
                
                errorMessage.classList.remove('hidden');
                showMessage('‚ùå L·ªói khi c·∫≠p nh·∫≠t metadata ·∫£nh!', 'error');
            } finally {
                isLoadingPhotos = false;
                uploadBtn.disabled = false;
            }
        }

        // H√†m ghi metadata ·∫£nh l√™n GitHub
        async function writePhotosMetadata(photosArray, sha = null) {
            const content = JSON.stringify(photosArray, null, 2);
            const encodedContent = base64Encode(content);

            // N·∫øu kh√¥ng c√≥ sha, th·ª≠ ƒë·ªçc file hi·ªán t·∫°i ƒë·ªÉ l·∫•y sha
            if (!sha) {
                try {
                    const response = await fetch(PHOTOS_METADATA_API_URL, {
                        headers: {
                            'Authorization': `token ${PAT}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        sha = data.sha;
                    }
                } catch (error) {
                    console.log('File metadata ch∆∞a t·ªìn t·∫°i, s·∫Ω t·∫°o m·ªõi');
                }
            }

            const body = JSON.stringify({
                message: `C·∫≠p nh·∫≠t metadata ${photosArray.length} ·∫£nh - ${new Date().toLocaleString('vi-VN')}`,
                content: encodedContent,
                ...(sha && { sha: sha })
            });

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 gi√¢y timeout
                
                const response = await fetch(PHOTOS_METADATA_API_URL, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${PAT}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: body,
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('ƒê√£ ghi metadata ·∫£nh th√†nh c√¥ng l√™n GitHub:', data);
                return data;
            } catch (error) {
                console.error('L·ªói khi ghi metadata ·∫£nh l√™n GitHub:', error);
                throw error;
            }
        }

        // H√†m ƒë·ªçc metadata ·∫£nh t·ª´ GitHub
        async function loadPhotosMetadataFromGitHub() {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 gi√¢y timeout
                
                const response = await fetch(PHOTOS_METADATA_API_URL, {
                    headers: {
                        'Authorization': `token ${PAT}`,
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        console.log('File metadata ch∆∞a t·ªìn t·∫°i');
                        return [];
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const content = JSON.parse(base64Decode(data.content));
                return content;
            } catch (error) {
                console.error('L·ªói khi ƒë·ªçc metadata t·ª´ GitHub:', error);
                return [];
            }
        }

        // H√†m t·∫£i t·∫•t c·∫£ ·∫£nh t·ª´ GitHub metadata (thay th·∫ø cho Google Drive API)
        async function loadAllPhotosFromMetadata() {
            if (isLoadingPhotos) return;
            isLoadingPhotos = true;
            
            const loadingSpinner = document.getElementById('photos-loading-spinner');
            const photosGrid = document.getElementById('photosGrid');
            const emptyState = document.getElementById('photosEmptyState');
            const errorMessage = document.getElementById('photosErrorMessage');
            
            try {
                // Hi·ªÉn th·ªã loading
                loadingSpinner.classList.remove('hidden');
                photosGrid.innerHTML = '';
                emptyState.classList.add('hidden');
                errorMessage.classList.add('hidden');
                
                const loadingText = loadingSpinner.querySelector('span');
                if (loadingText) {
                    loadingText.textContent = 'ƒêang t·∫£i danh s√°ch ·∫£nh...';
                }
                
                // T·∫£i metadata t·ª´ GitHub
                const photosMetadata = await loadPhotosMetadataFromGitHub();
                
                if (!photosMetadata || photosMetadata.length === 0) {
                    loadingSpinner.classList.add('hidden');
                    emptyState.classList.remove('hidden');
                    showMessage('üì∑ Ch∆∞a c√≥ metadata ·∫£nh. Vui l√≤ng nh·∫•n n√∫t c·∫≠p nh·∫≠t ƒë·ªÉ t·∫£i ·∫£nh t·ª´ Google Drive!', 'error');
                    return;
                }
                
                allPhotosData = photosMetadata;
                totalPages = Math.ceil(allPhotosData.length / PHOTOS_PER_PAGE);
                currentPage = 1;
                
                // T·∫£i comments v√† reactions
                const { content: commentsArray } = await readComments();
                commentsData = {};
                reactionsData = {};
                
                if (Array.isArray(commentsArray)) {
                    commentsArray.forEach(entry => {
                        if (entry.ID_IMG) {
                            if (entry.comments && Array.isArray(entry.comments)) {
                                if (!commentsData[entry.ID_IMG]) {
                                    commentsData[entry.ID_IMG] = [];
                                }
                                entry.comments.forEach(comment => {
                                    commentsData[entry.ID_IMG].push({
                                        text: comment.comment,
                                        timestamp: comment.date_input
                                    });
                                });
                            }
                            
                            reactionsData[entry.ID_IMG] = {
                                count_tim: entry.count_tim || 0
                            };
                        }
                    });
                }
                
                loadingSpinner.classList.add('hidden');
                
                // Hi·ªÉn th·ªã trang ƒë·∫ßu ti√™n
                displayPhotosPage(1);
                updatePaginationControls();
                
                // Th√™m log
                addLog('Load refresh hi·ªÉn th·ªã ·∫£nh tr√™n grid', `${allPhotosData.length} ·∫£nh`);
                
            } catch (error) {
                console.error('L·ªói khi t·∫£i metadata t·ª´ GitHub:', error);
                loadingSpinner.classList.add('hidden');
                
                if (error.name === 'AbortError') {
                    errorMessage.querySelector('p').textContent = '‚è∞ T·∫£i metadata b·ªã timeout. Vui l√≤ng th·ª≠ l·∫°i.';
                } else {
                    errorMessage.querySelector('p').textContent = '‚ùå Kh√¥ng th·ªÉ t·∫£i danh s√°ch ·∫£nh. Vui l√≤ng th·ª≠ l·∫°i.';
                }
                
                errorMessage.classList.remove('hidden');
            } finally {
                isLoadingPhotos = false;
            }
        }

        // H√†m t·∫£i t·∫•t c·∫£ ·∫£nh t·ª´ Google Drive v·ªõi ph√¢n trang (gi·ªØ l·∫°i ƒë·ªÉ backup)
        async function loadAllPhotosFromDrive() {
            if (isLoadingPhotos) return;
            isLoadingPhotos = true;
            
            const loadingSpinner = document.getElementById('photos-loading-spinner');
            const photosGrid = document.getElementById('photosGrid');
            const emptyState = document.getElementById('photosEmptyState');
            const errorMessage = document.getElementById('photosErrorMessage');
            
            try {
                // Hi·ªÉn th·ªã loading
                loadingSpinner.classList.remove('hidden');
                photosGrid.innerHTML = '';
                emptyState.classList.add('hidden');
                errorMessage.classList.add('hidden');
                
                // T·∫£i t·∫•t c·∫£ ·∫£nh v·ªõi pageSize l·ªõn v√† timeout
                let allFiles = [];
                let nextPageToken = '';
                let pageCount = 0;
                const maxPages = 10; // Gi·∫£m s·ªë trang ƒë·ªÉ tr√°nh timeout
                
                do {
                    const url = `https://www.googleapis.com/drive/v3/files?q='${FOLDER_ID}'+in+parents+and+mimeType+contains+'image/'&key=${API_KEY}&fields=files(id,name,webViewLink,thumbnailLink,webContentLink),nextPageToken&pageSize=500${nextPageToken ? `&pageToken=${nextPageToken}` : ''}`;
                    
                    // Th√™m timeout cho fetch request
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 gi√¢y timeout
                    
                    const response = await fetch(url, {
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    allFiles = allFiles.concat(data.files || []);
                    nextPageToken = data.nextPageToken || '';
                    pageCount++;
                    
                    // C·∫≠p nh·∫≠t loading v·ªõi s·ªë l∆∞·ª£ng ·∫£nh ƒë√£ t·∫£i
                    const loadingText = loadingSpinner.querySelector('span');
                    if (loadingText) {
                        loadingText.textContent = `ƒêang t·∫£i ·∫£nh... (${allFiles.length} ·∫£nh)`;
                    }
                    
                    // Th√™m delay nh·ªè gi·ªØa c√°c request ƒë·ªÉ tr√°nh rate limit
                    if (nextPageToken && pageCount < maxPages) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                    
                } while (nextPageToken && pageCount < maxPages);
                
                allPhotosData = allFiles;
                totalPages = Math.ceil(allPhotosData.length / PHOTOS_PER_PAGE);
                currentPage = 1;
                
                loadingSpinner.classList.add('hidden');
                
                if (allPhotosData.length === 0) {
                    emptyState.classList.remove('hidden');
                    return;
                }
                
                // T·∫£i comments v√† reactions, chuy·ªÉn ƒë·ªïi c·∫•u tr√∫c d·ªØ li·ªáu
                const { content: commentsArray } = await readComments();
                commentsData = {};
                reactionsData = {};
                
                // Chuy·ªÉn ƒë·ªïi t·ª´ m·∫£ng sang object v·ªõi key l√† t√™n file ·∫£nh
                if (Array.isArray(commentsArray)) {
                    commentsArray.forEach(entry => {
                        if (entry.ID_IMG) {
                            // X·ª≠ l√Ω comments t·ª´ m·∫£ng comments trong entry
                            if (entry.comments && Array.isArray(entry.comments)) {
                                if (!commentsData[entry.ID_IMG]) {
                                    commentsData[entry.ID_IMG] = [];
                                }
                                entry.comments.forEach(comment => {
                                    commentsData[entry.ID_IMG].push({
                                        text: comment.comment,
                                        timestamp: comment.date_input
                                    });
                                });
                            }
                            
                            // X·ª≠ l√Ω reactions (ch·ªâ tim)
                            reactionsData[entry.ID_IMG] = {
                                count_tim: entry.count_tim || 0
                            };
                        }
                    });
                }
                
                // Hi·ªÉn th·ªã trang ƒë·∫ßu ti√™n
                displayPhotosPage(1);
                updatePaginationControls();
                
                // Th√™m log
                addLog('Load refresh hi·ªÉn th·ªã ·∫£nh tr√™n grid', `${allPhotosData.length} ·∫£nh`);
                
            } catch (error) {
                console.error('L·ªói khi t·∫£i ·∫£nh t·ª´ Google Drive:', error);
                loadingSpinner.classList.add('hidden');
                
                // X·ª≠ l√Ω c√°c lo·∫°i l·ªói kh√°c nhau
                if (error.name === 'AbortError') {
                    console.log('Request b·ªã timeout sau 15 gi√¢y');
                    errorMessage.querySelector('p').textContent = '‚è∞ T·∫£i ·∫£nh b·ªã timeout. Vui l√≤ng th·ª≠ l·∫°i.';
                } else if (error.message.includes('403')) {
                    errorMessage.querySelector('p').textContent = 'üîí Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p folder ·∫£nh.';
                } else if (error.message.includes('404')) {
                    errorMessage.querySelector('p').textContent = 'üìÅ Kh√¥ng t√¨m th·∫•y folder ·∫£nh.';
                } else {
                    errorMessage.querySelector('p').textContent = '‚ùå Kh√¥ng th·ªÉ t·∫£i danh s√°ch ·∫£nh. Vui l√≤ng th·ª≠ l·∫°i.';
                }
                
                errorMessage.classList.remove('hidden');
            } finally {
                isLoadingPhotos = false;
            }
        }

        // H√†m hi·ªÉn th·ªã ·∫£nh theo trang
        function displayPhotosPage(page) {
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            const startIndex = (page - 1) * PHOTOS_PER_PAGE;
            const endIndex = Math.min(startIndex + PHOTOS_PER_PAGE, allPhotosData.length);
            
            currentPhotosPage = allPhotosData.slice(startIndex, endIndex);
            displayPhotos(currentPhotosPage, startIndex);
            updatePaginationControls();
        }

        // H√†m hi·ªÉn th·ªã ·∫£nh trong grid
        function displayPhotos(photos, startIndex = 0) {
            const photosGrid = document.getElementById('photosGrid');
            photosGrid.innerHTML = '';
            
            photos.forEach((photo, index) => {
                const globalIndex = startIndex + index;
                const photoCard = createPhotoCard(photo, globalIndex);
                photosGrid.appendChild(photoCard);
                
                // Reset flag khi hi·ªÉn th·ªã ·∫£nh t·ª´ grid ch√≠nh
                isViewingEventPhotos = false;
            });
        }

        // H√†m t·∫°o card ·∫£nh
        function createPhotoCard(photo, index) {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-lg shadow-md overflow-hidden';
            
            // T·∫°o URL ·∫£nh t·ª´ Google Drive v·ªõi nhi·ªÅu ph∆∞∆°ng √°n d·ª± ph√≤ng
            const thumbnailUrl = `https://drive.google.com/thumbnail?id=${photo.id}&sz=w400-h400`;
            const directUrl = `https://drive.google.com/uc?export=view&id=${photo.id}`;
            const fallbackUrl = `https://lh3.googleusercontent.com/d/${photo.id}=w400-h400`;
            
            // L·∫•y comments cho ·∫£nh n√†y d·ª±a tr√™n t√™n file
            const photoComments = commentsData[photo.name] || [];
            
            // L·∫•y reactions cho ·∫£nh n√†y
            const photoReactions = reactionsData[photo.name] || { count_tim: 0 };
            
            card.innerHTML = `
                <div class="relative">
                    <img src="${thumbnailUrl}" alt="${photo.name}" 
                         class="w-full h-64 object-cover cursor-pointer"
                         onclick="openPhotoModal('${photo.id}', '${photo.name}', ${index})"
                         onerror="handleThumbnailError(this, '${directUrl}', '${fallbackUrl}')"
                         loading="lazy">
                    <div class="absolute top-2 right-2 bg-black bg-opacity-50 text-white px-2 py-1 rounded text-xs cursor-pointer hover:bg-opacity-70 transition-all duration-200" 
                         onclick="event.stopPropagation(); showEventSelectionModal('${photo.id}')" 
                         title="Th√™m ·∫£nh v√†o s·ª± ki·ªán"
                         style="display: flex; align-items: center; justify-content: center; min-height: 20px;">
                        <span style="display: flex; align-items: baseline; gap: 2px; line-height: 1;">
                            <i class="bi bi-camera" style="font-size: 12px; line-height: 1;"></i>
                            <span style="font-size: 12px; font-weight: 500; line-height: 1;">${index + 1}</span>
                        </span>
                    </div>
                </div>
                
                <div class="p-4">
                    <!-- Count Section -->
                    <div class="dem-tong-count flex items-center justify-end space-x-4 mb-1.5 text-sm text-gray-600">
                        <div class="flex items-center space-x-1">
                            <i class="bi bi-heart-fill text-red-500"></i>
                            <span id="heart-count-${photo.id}">${photoReactions.count_tim}</span>
                        </div>
                        <div class="flex items-center space-x-1">
                            <i class="bi bi-chat-dots"></i>
                            <span id="comment-count-${photo.id}">${photoComments.length}</span>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="button-action flex items-center justify-around border-t border-gray-200 py-2 mb-1.5" id="button-action-${photo.id}">
                        <button class="flex flex-col items-center justify-center px-1 py-1 rounded hover:bg-gray-50 transition-colors flex-1 text-xs min-w-0" 
                                onclick="toggleReaction('${photo.id}', 'tim')" 
                                id="heart-btn-${photo.id}">
                            <i class="bi bi-heart text-gray-600 text-sm mb-1" id="heart-icon-${photo.id}"></i>
                            <span class="text-gray-700 font-medium text-xs leading-none">Th√≠ch</span>
                        </button>
                        
                        <button class="flex flex-col items-center justify-center px-1 py-1 rounded hover:bg-gray-50 transition-colors flex-1 text-xs min-w-0" 
                                onclick="toggleComments('${photo.id}')" 
                                id="comment-btn-${photo.id}">
                            <i class="bi bi-chat-right-dots text-gray-600 text-sm mb-1"></i>
                            <span class="text-gray-700 font-medium text-xs leading-none">B√¨nh lu·∫≠n</span>
                        </button>
                        
                        <button class="flex flex-col items-center justify-center px-1 py-1 rounded hover:bg-gray-50 transition-colors flex-1 text-xs min-w-0" 
                                onclick="sharePhoto('${photo.id}', '${photo.name}')" 
                                id="share-btn-${photo.id}">
                            <i class="bi bi-share text-gray-600 text-sm mb-1"></i>
                            <span class="text-gray-700 font-medium text-xs leading-none">Chia s·∫ª</span>
                        </button>
                    </div>
                    
                    <!-- Comments Section (Hidden by default) -->
                    <div class="comments-section hidden" id="comments-section-${photo.id}">
                        <div class="max-h-32 overflow-y-auto overflow-x-hidden space-y-1 mb-3" id="comments-${photo.id}">
                            ${photoComments.map((comment, commentIndex) => `
                                <div class="bg-gray-50 rounded p-2 text-sm cursor-pointer comment-item" onclick="toggleCommentTimestamp('${photo.id}', ${commentIndex})">
                                    <p class="text-gray-700 break-words" style="white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word;">${comment.text} <span class="comment-timestamp hidden text-xs text-gray-500 italic ml-2" style="font-size: 10px;" id="timestamp-${photo.id}-${commentIndex}">${new Date(comment.timestamp).toLocaleString('vi-VN')}</span></p>
                                </div>
                            `).join('')}
                        </div>
                        
                        <!-- Add Comment Form - Messenger Style -->
                        <div class="messenger-comment-box w-full mb-1.5">
                            <div class="comment-input-container w-full">
                                <textarea class="comment-input w-full" 
                                          placeholder="Vi·∫øt b√¨nh lu·∫≠n..." 
                                          id="comment-input-${photo.id}"
                                          rows="1"
                                          onkeydown="handleCommentKeyDown(event, '${photo.id}')"
                                          oninput="autoResizeTextarea(this)"
                                          onfocus="focusCommentInput('${photo.id}')"
                                          onblur="blurCommentInput('${photo.id}')"></textarea>
                                <button class="send-button" 
                                        id="send-btn-${photo.id}"
                                        onclick="addComment('${photo.id}')"
                                        disabled>
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M16.6915026,12.4744748 L3.50612381,13.2599618 C3.19218622,13.2599618 3.03521743,13.4170592 3.03521743,13.5741566 L1.15159189,20.0151496 C0.8376543,20.8006365 0.99,21.89 1.77946707,22.52 C2.41,22.99 3.50612381,23.1 4.13399899,22.8429026 L21.714504,14.0454487 C22.6563168,13.5741566 23.1272231,12.6315722 22.9702544,11.6889879 C22.8132856,10.7464035 22.0274026,10.0151496 21.0855898,10.0151496 L4.13399899,1.21769050 C3.50612381,0.960492931 2.41,1.07 1.77946707,1.54 C0.99,2.17 0.8376543,3.26 1.15159189,4.04548596 L3.03521743,10.4864789 C3.03521743,10.6435763 3.19218622,10.8006737 3.50612381,10.8006737 L16.6915026,11.5861607 C16.6915026,11.5861607 16.6915026,12.4744748 16.6915026,12.4744748 Z"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            return card;
        }

        // H√†m x·ª≠ l√Ω l·ªói khi t·∫£i thumbnail
        function handleThumbnailError(img, directUrl, fallbackUrl) {
            if (img.src !== directUrl) {
                img.src = directUrl;
            } else if (img.src !== fallbackUrl) {
                img.src = fallbackUrl;
            } else {
                img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjQwMCIgdmlld0JveD0iMCAwIDQwMCA0MDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI0MDAiIGhlaWdodD0iNDAwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0yMDAgMTUwQzE4Ni4xOSAxNTAgMTc1IDE2MS4xOSAxNzUgMTc1QzE3NSAxODguODEgMTg2LjE5IDIwMCAyMDAgMjAwQzIxMy44MSAyMDAgMjI1IDE4OC44MSAyMjUgMTc1QzIyNSAxNjEuMTkgMjEzLjgxIDE1MCAyMDAgMTUwWiIgZmlsbD0iIzlDQTNBRiIvPgo8cGF0aCBkPSJNMTI1IDEyNUMxMTguMDk2IDEyNSAxMTIuNSAxMzAuNTk2IDExMi41IDEzNy41VjI2Mi41QzExMi41IDI2OS40MDQgMTE4LjA5NiAyNzUgMTI1IDI3NUgyNzVDMjgxLjkwNCAyNzUgMjg3LjUgMjY5LjQwNCAyODcuNSAyNjIuNVYxMzcuNUMyODcuNSAxMzAuNTk2IDI4MS45MDQgMTI1IDI3NSAxMjVIMTI1WiIgc3Ryb2tlPSIjOUNBM0FGIiBzdHJva2Utd2lkdGg9IjEwIiBmaWxsPSJub25lIi8+Cjwvc3ZnPgo=';
                img.alt = 'Kh√¥ng th·ªÉ t·∫£i ·∫£nh';
            }
        }

        // H√†m c·∫≠p nh·∫≠t ƒëi·ªÅu khi·ªÉn ph√¢n trang
        function updatePaginationControls() {
            const paginationControls = document.getElementById('paginationControls');
            const currentRange = document.getElementById('currentRange');
            const totalPhotos = document.getElementById('totalPhotos');
            const currentPageDisplay = document.getElementById('currentPageDisplay');
            const totalPagesDisplay = document.getElementById('totalPagesDisplay');
            const pageNumbers = document.getElementById('pageNumbers');
            
            if (totalPages <= 1) {
                paginationControls.classList.add('hidden');
                return;
            }
            
            paginationControls.classList.remove('hidden');
            
            // C·∫≠p nh·∫≠t th√¥ng tin hi·ªÉn th·ªã
            const startIndex = (currentPage - 1) * PHOTOS_PER_PAGE + 1;
            const endIndex = Math.min(currentPage * PHOTOS_PER_PAGE, allPhotosData.length);
            
            currentRange.textContent = `${startIndex}-${endIndex}`;
            totalPhotos.textContent = allPhotosData.length;
            currentPageDisplay.textContent = currentPage;
            totalPagesDisplay.textContent = totalPages;
            
            // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t
            const firstPageBtn = document.getElementById('firstPageBtn');
            const prevPageBtn = document.getElementById('prevPageBtn');
            const nextPageBtn = document.getElementById('nextPageBtn');
            const lastPageBtn = document.getElementById('lastPageBtn');
            
            firstPageBtn.disabled = currentPage === 1;
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages;
            lastPageBtn.disabled = currentPage === totalPages;
            
            // T·∫°o s·ªë trang
            pageNumbers.innerHTML = '';
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            // ƒêi·ªÅu ch·ªânh startPage n·∫øu endPage ƒë√£ ƒë·∫°t t·ªëi ƒëa
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            // Th√™m d·∫•u ... n·∫øu c·∫ßn
            if (startPage > 1) {
                const firstPageNumber = createPageButton(1);
                pageNumbers.appendChild(firstPageNumber);
                
                if (startPage > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.className = 'px-2 py-1 text-gray-500';
                    pageNumbers.appendChild(ellipsis);
                }
            }
            
            // Th√™m c√°c s·ªë trang
            for (let i = startPage; i <= endPage; i++) {
                const pageButton = createPageButton(i);
                pageNumbers.appendChild(pageButton);
            }
            
            // Th√™m d·∫•u ... cu·ªëi n·∫øu c·∫ßn
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.className = 'px-2 py-1 text-gray-500';
                    pageNumbers.appendChild(ellipsis);
                }
                
                const lastPageNumber = createPageButton(totalPages);
                pageNumbers.appendChild(lastPageNumber);
            }
        }
        
        // H√†m t·∫°o n√∫t trang
        function createPageButton(pageNum) {
            const button = document.createElement('button');
            button.textContent = pageNum;
            button.className = `px-3 py-2 text-sm border rounded-lg transition-colors ${
                pageNum === currentPage 
                    ? 'bg-pink-500 text-white border-pink-500' 
                    : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50'
            }`;
            
            button.addEventListener('click', () => {
                if (pageNum !== currentPage) {
                    displayPhotosPage(pageNum);
                    // Cu·ªôn l√™n ƒë·∫ßu danh s√°ch ·∫£nh
                    document.getElementById('photosGrid').scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }
            });
            
            return button;
        }

        // H√†m m·ªü modal ·∫£nh v·ªõi nhi·ªÅu URL d·ª± ph√≤ng
        function openPhotoModal(photoId, imageName, index, fromEventModal = false) {
            const modal = new bootstrap.Modal(document.getElementById('photoModal'));
            const modalImage = document.getElementById('modalImage');
            const modalTitle = document.getElementById('photoModalTitle');
            const modalDescription = document.getElementById('photoModalDescription');
            const loadingSpinner = document.getElementById('imageLoadingSpinner');
            const errorMessage = document.getElementById('imageErrorMessage');
            
            // N·∫øu m·ªü t·ª´ modal s·ª± ki·ªán, ƒë√≥ng modal s·ª± ki·ªán tr∆∞·ªõc
            if (fromEventModal && eventPhotosModalInstance) {
                eventPhotosModalInstance.hide();
            }
            
            // L∆∞u ch·ªâ s·ªë ·∫£nh hi·ªán t·∫°i
            currentPhotoIndex = index;
            
            // Reset tr·∫°ng th√°i
            modalImage.classList.add('d-none');
            loadingSpinner.classList.remove('d-none');
            errorMessage.classList.add('d-none');
            
            // C·∫≠p nh·∫≠t th√¥ng tin d·ª±a tr√™n ngu·ªìn
            const totalPhotos = isViewingEventPhotos ? currentEventPhotos.length : allPhotosData.length;
            const displayIndex = isViewingEventPhotos ? index + 1 : 
                                 allPhotosData.findIndex(p => p.id === photoId) + 1;
            const displayTotal = isViewingEventPhotos ? totalPhotos : allPhotosData.length;
            
            modalTitle.textContent = `üì∑ ·∫¢nh ${displayIndex} / ${displayTotal}${isViewingEventPhotos ? ' (S·ª± ki·ªán)' : ''}`;
            modalDescription.textContent = `üíï ${imageName}`;
            
            // C·∫≠p nh·∫≠t n√∫t ƒëi·ªÅu h∆∞·ªõng
            updateNavigationButtons();
            
            // Danh s√°ch URL ƒë·ªÉ th·ª≠ theo th·ª© t·ª± ∆∞u ti√™n
            const imageUrls = [
                `https://drive.google.com/uc?export=view&id=${photoId}`,
                `https://lh3.googleusercontent.com/d/${photoId}=w1200-h1200`,
                `https://drive.google.com/thumbnail?id=${photoId}&sz=w1200-h1200`,
                `https://drive.google.com/file/d/${photoId}/view`
            ];
            
            // Th·ª≠ t·∫£i ·∫£nh v·ªõi URL ƒë·∫ßu ti√™n
            tryLoadImage(modalImage, imageUrls, 0, imageName);
            
            modal.show();
        }

        // H√†m th·ª≠ t·∫£i ·∫£nh v·ªõi nhi·ªÅu URL
        function tryLoadImage(imgElement, urls, currentIndex, imageName) {
            if (currentIndex >= urls.length) {
                // ƒê√£ th·ª≠ h·∫øt t·∫•t c·∫£ URL, hi·ªÉn th·ªã l·ªói
                handleImageError();
                return;
            }
            
            const img = new Image();
            img.onload = function() {
                imgElement.src = urls[currentIndex];
                imgElement.alt = imageName;
                handleImageLoad();
            };
            
            img.onerror = function() {
                // Th·ª≠ URL ti·∫øp theo
                tryLoadImage(imgElement, urls, currentIndex + 1, imageName);
            };
            
            // B·∫Øt ƒë·∫ßu t·∫£i ·∫£nh
            img.src = urls[currentIndex];
        }

        // Bi·∫øn l∆∞u tr·ªØ ch·ªâ s·ªë ·∫£nh hi·ªán t·∫°i trong modal
        let currentPhotoIndex = 0;
        let currentEventPhotos = []; // M·∫£ng ·∫£nh c·ªßa s·ª± ki·ªán hi·ªán t·∫°i
        let isViewingEventPhotos = false; // Flag ƒë·ªÉ bi·∫øt ƒëang xem ·∫£nh c·ªßa s·ª± ki·ªán
        let eventPhotosModalInstance = null; // L∆∞u instance c·ªßa modal s·ª± ki·ªán

        // H√†m ƒëi·ªÅu h∆∞·ªõng ·∫£nh trong modal
        function navigatePhoto(direction) {
            const photosToNavigate = isViewingEventPhotos ? currentEventPhotos : allPhotosData;
            
            if (!photosToNavigate || photosToNavigate.length === 0) return;
            
            currentPhotoIndex += direction;
            
            // X·ª≠ l√Ω v√≤ng l·∫∑p
            if (currentPhotoIndex < 0) {
                currentPhotoIndex = photosToNavigate.length - 1;
            } else if (currentPhotoIndex >= photosToNavigate.length) {
                currentPhotoIndex = 0;
            }
            
            // N·∫øu ƒëang xem t·∫•t c·∫£ ·∫£nh (kh√¥ng ph·∫£i ·∫£nh s·ª± ki·ªán), ki·ªÉm tra ph√¢n trang
            if (!isViewingEventPhotos) {
                const currentPageStart = (currentPage - 1) * PHOTOS_PER_PAGE;
                const currentPageEnd = currentPageStart + PHOTOS_PER_PAGE;
                
                // N·∫øu ·∫£nh kh√¥ng trong trang hi·ªán t·∫°i, chuy·ªÉn ƒë·∫øn trang ch·ª©a ·∫£nh ƒë√≥
                if (currentPhotoIndex < currentPageStart || currentPhotoIndex >= currentPageEnd) {
                    const targetPage = Math.floor(currentPhotoIndex / PHOTOS_PER_PAGE) + 1;
                    displayPhotosPage(targetPage);
                }
            }
            
            // C·∫≠p nh·∫≠t n√∫t ƒëi·ªÅu h∆∞·ªõng
            updateNavigationButtons();
            
            // T·∫£i ·∫£nh m·ªõi
            const photo = photosToNavigate[currentPhotoIndex];
            const modalImage = document.getElementById('modalImage');
            const modalTitle = document.getElementById('photoModalTitle');
            const modalDescription = document.getElementById('photoModalDescription');
            const loadingSpinner = document.getElementById('imageLoadingSpinner');
            const errorMessage = document.getElementById('imageErrorMessage');
            
            // Reset tr·∫°ng th√°i
            modalImage.classList.add('d-none');
            loadingSpinner.classList.remove('d-none');
            errorMessage.classList.add('d-none');
            
            // C·∫≠p nh·∫≠t th√¥ng tin
            const totalPhotos = photosToNavigate.length;
            const displayIndex = isViewingEventPhotos ? currentPhotoIndex + 1 : 
                                 allPhotosData.findIndex(p => p.id === photo.id) + 1;
            const displayTotal = isViewingEventPhotos ? totalPhotos : allPhotosData.length;
            
            modalTitle.textContent = `üì∑ ·∫¢nh ${displayIndex} / ${displayTotal}${isViewingEventPhotos ? ' (S·ª± ki·ªán)' : ''}`;
            modalDescription.textContent = `üíï ${photo.name}`;
            
            // Danh s√°ch URL ƒë·ªÉ th·ª≠ theo th·ª© t·ª± ∆∞u ti√™n
            const imageUrls = [
                `https://drive.google.com/uc?export=view&id=${photo.id}`,
                `https://lh3.googleusercontent.com/d/${photo.id}=w1200-h1200`,
                `https://drive.google.com/thumbnail?id=${photo.id}&sz=w1200-h1200`,
                `https://drive.google.com/file/d/${photo.id}/view`
            ];
            
            // Th·ª≠ t·∫£i ·∫£nh v·ªõi URL ƒë·∫ßu ti√™n
            tryLoadImage(modalImage, imageUrls, 0, photo.name);
        }

        // H√†m c·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t ƒëi·ªÅu h∆∞·ªõng
        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevPhotoBtn');
            const nextBtn = document.getElementById('nextPhotoBtn');
            
            if (allPhotosData.length <= 1) {
                prevBtn.style.display = 'none';
                nextBtn.style.display = 'none';
            } else {
                prevBtn.style.display = 'flex';
                nextBtn.style.display = 'flex';
            }
        }

        // H√†m x·ª≠ l√Ω khi ·∫£nh t·∫£i th√†nh c√¥ng
        function handleImageLoad() {
            const modalImage = document.getElementById('modalImage');
            const loadingSpinner = document.getElementById('imageLoadingSpinner');
            const errorMessage = document.getElementById('imageErrorMessage');
            
            loadingSpinner.classList.add('d-none');
            errorMessage.classList.add('d-none');
            modalImage.classList.remove('d-none');
        }

        // H√†m x·ª≠ l√Ω khi ·∫£nh t·∫£i th·∫•t b·∫°i
        function handleImageError() {
            const modalImage = document.getElementById('modalImage');
            const loadingSpinner = document.getElementById('imageLoadingSpinner');
            const errorMessage = document.getElementById('imageErrorMessage');
            
            loadingSpinner.classList.add('d-none');
            modalImage.classList.add('d-none');
            errorMessage.classList.remove('d-none');
        }

        // H√†m ƒë√≥ng modal ·∫£nh v√† quay l·∫°i modal s·ª± ki·ªán n·∫øu c·∫ßn
        function closePhotoModal() {
            const photoModal = bootstrap.Modal.getInstance(document.getElementById('photoModal'));
            if (photoModal) {
                photoModal.hide();
            }
            
            // N·∫øu ƒëang xem ·∫£nh t·ª´ s·ª± ki·ªán, m·ªü l·∫°i modal s·ª± ki·ªán
            if (isViewingEventPhotos && eventPhotosModalInstance) {
                setTimeout(() => {
                    eventPhotosModalInstance.show();
                }, 300); // Delay ƒë·ªÉ modal ·∫£nh ƒë√≥ng ho√†n to√†n tr∆∞·ªõc
            }
            
            // Reset flag khi ƒë√≥ng modal
            if (!isViewingEventPhotos) {
                currentEventPhotos = [];
            }
        }

        // H√†m hi·ªÉn th·ªã modal ch·ªçn s·ª± ki·ªán cho ·∫£nh
        async function showEventSelectionModal(photoId) {
            selectedPhotoId = photoId;
            selectedEventsForPhoto.clear();
            
            const modal = new bootstrap.Modal(document.getElementById('eventSelectionModal'));
            const loadingSpinner = document.getElementById('eventSelection-loading-spinner');
            const eventList = document.getElementById('eventSelectionList');
            const emptyState = document.getElementById('eventSelection-emptyState');
            const selectedPhotoInfo = document.getElementById('selectedPhotoInfo');
            const saveBtn = document.getElementById('savePhotoToEventsBtn');
            
            // Hi·ªÉn th·ªã th√¥ng tin ·∫£nh ƒë∆∞·ª£c ch·ªçn
            const photo = allPhotosData.find(p => p.id === photoId);
            if (photo) {
                const thumbnailUrl = `https://drive.google.com/thumbnail?id=${photoId}&sz=w200-h200`;
                selectedPhotoInfo.innerHTML = `
                    <div class="d-flex align-items-center">
                        <img src="${thumbnailUrl}" alt="${photo.name}" class="rounded me-3" style="width: 60px; height: 60px; object-fit: cover;">
                        <div>
                            <h6 class="mb-1">${photo.name}</h6>
                            <small class="text-muted">ID: ${photoId}</small>
                        </div>
                    </div>
                `;
            }
            
            // Reset UI
            loadingSpinner.classList.remove('hidden');
            eventList.innerHTML = '';
            emptyState.classList.add('hidden');
            saveBtn.disabled = true;
            
            try {
                // T·∫£i danh s√°ch s·ª± ki·ªán
                const { content: events } = await readNotes();
                
                loadingSpinner.classList.add('hidden');
                
                if (!events || events.length === 0) {
                    emptyState.classList.remove('hidden');
                    modal.show();
                    return;
                }
                
                // Hi·ªÉn th·ªã danh s√°ch s·ª± ki·ªán
                events.forEach((event, index) => {
                    const day = String(event.day).padStart(2, '0');
                    const month = String(event.month).padStart(2, '0');
                    const formattedDate = `${day}/${month}/${event.year}`;
                    const eventContent = event.contdetl || 'Kh√¥ng c√≥ n·ªôi dung';
                    const eventColor = event.colorClass || 'bg-pink-500';
                    const eventIcon = event.icon || 'üìÖ';
                    
                    // Ki·ªÉm tra xem ·∫£nh ƒë√£ c√≥ trong s·ª± ki·ªán n√†y ch∆∞a
                    const isPhotoInEvent = event.image && Array.isArray(event.image) && event.image.includes(photoId);
                    
                    const eventItem = document.createElement('div');
                    eventItem.className = 'border rounded p-3 hover:bg-gray-50 transition-colors';
                    eventItem.innerHTML = `
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="${index}" id="event-${index}" ${isPhotoInEvent ? 'checked' : ''}>
                            <label class="form-check-label w-100 cursor-pointer" for="event-${index}">
                                <div class="d-flex align-items-center">
                                    <div class="me-3">
                                        <div class="w-3 h-3 ${eventColor} rounded-circle d-inline-block" style="width: 12px; height: 12px;"></div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <div class="fw-medium">${eventIcon} ${eventContent}</div>
                                        <small class="text-muted">${formattedDate}</small>
                                    </div>
                                    ${isPhotoInEvent ? '<span class="badge bg-success">ƒê√£ c√≥ ·∫£nh</span>' : ''}
                                </div>
                            </label>
                        </div>
                    `;
                    
                    // Th√™m event listener cho checkbox
                    const checkbox = eventItem.querySelector('input[type="checkbox"]');
                    checkbox.addEventListener('change', () => {
                        if (checkbox.checked) {
                            selectedEventsForPhoto.add(index);
                        } else {
                            selectedEventsForPhoto.delete(index);
                        }
                        
                        // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t l∆∞u
                        updateSaveButtonState();
                    });
                    
                    // N·∫øu ·∫£nh ƒë√£ c√≥ trong s·ª± ki·ªán, th√™m v√†o set
                    if (isPhotoInEvent) {
                        selectedEventsForPhoto.add(index);
                    }
                    
                    eventList.appendChild(eventItem);
                });
                
                // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t l∆∞u
                updateSaveButtonState();
                
            } catch (error) {
                console.error('L·ªói khi t·∫£i danh s√°ch s·ª± ki·ªán:', error);
                loadingSpinner.classList.add('hidden');
                eventList.innerHTML = '<div class="alert alert-danger">Kh√¥ng th·ªÉ t·∫£i danh s√°ch s·ª± ki·ªán</div>';
            }
            
            modal.show();
        }

        // H√†m c·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t l∆∞u
        function updateSaveButtonState() {
            const saveBtn = document.getElementById('savePhotoToEventsBtn');
            const hasChanges = selectedEventsForPhoto.size > 0;
            saveBtn.disabled = !hasChanges;
        }

        // H√†m l∆∞u ·∫£nh v√†o c√°c s·ª± ki·ªán ƒë∆∞·ª£c ch·ªçn
        async function savePhotoToEvents() {
            const saveBtn = document.getElementById('savePhotoToEventsBtn');
            const saveSpinner = document.getElementById('savePhotoSpinner');
            
            if (!selectedPhotoId || selectedEventsForPhoto.size === 0) {
                showMessage('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt s·ª± ki·ªán', 'error');
                return;
            }
            
            // Hi·ªÉn th·ªã loading
            saveBtn.disabled = true;
            saveSpinner.classList.remove('d-none');
            
            try {
                // ƒê·ªçc d·ªØ li·ªáu s·ª± ki·ªán hi·ªán t·∫°i
                const { content: currentEvents, sha } = await readNotes();
                
                // C·∫≠p nh·∫≠t c√°c s·ª± ki·ªán ƒë∆∞·ª£c ch·ªçn
                selectedEventsForPhoto.forEach(eventIndex => {
                    const event = currentEvents[eventIndex];
                    if (event) {
                        // Kh·ªüi t·∫°o m·∫£ng image n·∫øu ch∆∞a c√≥
                        if (!event.image) {
                            event.image = [];
                        }
                        
                        // Th√™m ID ·∫£nh n·∫øu ch∆∞a c√≥ (ƒë·∫£m b·∫£o duy nh·∫•t)
                        if (!event.image.includes(selectedPhotoId)) {
                            event.image.push(selectedPhotoId);
                        }
                    }
                });
                
                // X√≥a ·∫£nh kh·ªèi c√°c s·ª± ki·ªán kh√¥ng ƒë∆∞·ª£c ch·ªçn
                currentEvents.forEach((event, index) => {
                    if (event.image && Array.isArray(event.image) && !selectedEventsForPhoto.has(index)) {
                        const photoIndex = event.image.indexOf(selectedPhotoId);
                        if (photoIndex > -1) {
                            event.image.splice(photoIndex, 1);
                        }
                    }
                });
                
                // L∆∞u l·∫°i d·ªØ li·ªáu
                await writeNotes(currentEvents, sha);
                
                // C·∫≠p nh·∫≠t giao di·ªán
                displayEvents(currentEvents);
                if (window.calendarInstance) {
                    window.calendarInstance.updateEventsFromData(currentEvents);
                }
                
                // ƒê√≥ng modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('eventSelectionModal'));
                modal.hide();
                
                showMessage('‚úÖ ƒê√£ c·∫≠p nh·∫≠t ·∫£nh cho c√°c s·ª± ki·ªán th√†nh c√¥ng!', 'success');
                
                // Th√™m log
                const selectedEventCount = selectedEventsForPhoto.size;
                addLog('C·∫≠p nh·∫≠t ·∫£nh cho s·ª± ki·ªán', `·∫¢nh ID: ${selectedPhotoId}, ${selectedEventCount} s·ª± ki·ªán`);
                
            } catch (error) {
                console.error('L·ªói khi l∆∞u ·∫£nh v√†o s·ª± ki·ªán:', error);
                showMessage('‚ùå L·ªói khi c·∫≠p nh·∫≠t ·∫£nh cho s·ª± ki·ªán. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
            } finally {
                // ·∫®n loading
                saveBtn.disabled = false;
                saveSpinner.classList.add('d-none');
            }
        }

        // H√†m hi·ªÉn th·ªã ·∫£nh c·ªßa s·ª± ki·ªán
        async function loadEventPhotos(eventIndex) {
            try {
                // ƒê·ªçc d·ªØ li·ªáu s·ª± ki·ªán
                const { content: events } = await readNotes();
                
                if (!events || !events[eventIndex]) {
                    showMessage('Kh√¥ng t√¨m th·∫•y s·ª± ki·ªán', 'error');
                    return;
                }
                
                const event = events[eventIndex];
                const modal = new bootstrap.Modal(document.getElementById('eventPhotosModal'));
                const loadingSpinner = document.getElementById('eventPhotos-loading-spinner');
                const photosGrid = document.getElementById('eventPhotosGrid');
                const emptyState = document.getElementById('eventPhotos-emptyState');
                const eventInfo = document.getElementById('eventPhotosInfo');
                
                // L∆∞u instance modal ƒë·ªÉ c√≥ th·ªÉ m·ªü l·∫°i sau
                eventPhotosModalInstance = modal;
                
                // Hi·ªÉn th·ªã th√¥ng tin s·ª± ki·ªán
                const day = String(event.day).padStart(2, '0');
                const month = String(event.month).padStart(2, '0');
                const formattedDate = `${day}/${month}/${event.year}`;
                const eventContent = event.contdetl || 'Kh√¥ng c√≥ n·ªôi dung';
                const eventIcon = event.icon || 'üìÖ';
                const eventColor = event.colorClass || 'bg-pink-500';
                
                eventInfo.innerHTML = `
                    <div class="d-flex align-items-center p-3 bg-light rounded">
                        <div class="me-3">
                            <div class="w-4 h-4 ${eventColor} rounded-circle d-inline-block" style="width: 16px; height: 16px;"></div>
                        </div>
                        <div>
                            <h6 class="mb-1">${eventIcon} ${eventContent}</h6>
                            <small class="text-muted">${formattedDate}</small>
                        </div>
                    </div>
                `;
                
                // Reset UI
                loadingSpinner.classList.remove('hidden');
                photosGrid.innerHTML = '';
                emptyState.classList.add('hidden');
                
                // Ki·ªÉm tra xem s·ª± ki·ªán c√≥ ·∫£nh kh√¥ng
                if (!event.image || !Array.isArray(event.image) || event.image.length === 0) {
                    loadingSpinner.classList.add('hidden');
                    emptyState.classList.remove('hidden');
                    modal.show();
                    return;
                }
                
                // T·∫£i th√¥ng tin ·∫£nh t·ª´ allPhotosData
                const eventPhotos = [];
                event.image.forEach(photoId => {
                    const photo = allPhotosData.find(p => p.id === photoId);
                    if (photo) {
                        eventPhotos.push(photo);
                    }
                });
                
                // L∆∞u danh s√°ch ·∫£nh s·ª± ki·ªán v√† ƒë·∫∑t flag
                currentEventPhotos = eventPhotos;
                isViewingEventPhotos = true;
                
                loadingSpinner.classList.add('hidden');
                
                if (eventPhotos.length === 0) {
                    emptyState.classList.remove('hidden');
                    modal.show();
                    return;
                }
                
                // Hi·ªÉn th·ªã ·∫£nh
                eventPhotos.forEach((photo, index) => {
                    const thumbnailUrl = `https://drive.google.com/thumbnail?id=${photo.id}&sz=w300-h300`;
                    const directUrl = `https://drive.google.com/uc?export=view&id=${photo.id}`;
                    const fallbackUrl = `https://lh3.googleusercontent.com/d/${photo.id}=w300-h300`;
                    
                    const photoCard = document.createElement('div');
                    photoCard.className = 'bg-white rounded-lg shadow-md overflow-hidden cursor-pointer';
                    photoCard.innerHTML = `
                        <div class="relative">
                            <img src="${thumbnailUrl}" alt="${photo.name}" 
                                 class="w-full h-48 object-cover"
                                 onclick="openPhotoModal('${photo.id}', '${photo.name}', ${index}, true)"
                                 onerror="handleThumbnailError(this, '${directUrl}', '${fallbackUrl}')"
                                 loading="lazy">
                            <div class="absolute top-2 right-2 bg-black bg-opacity-50 text-white px-2 py-1 rounded text-xs">
                                ${index + 1}/${eventPhotos.length}
                            </div>
                        </div>
                        <div class="p-3">
                            <p class="text-sm text-gray-700 truncate" title="${photo.name}">${photo.name}</p>
                        </div>
                    `;
                    
                    photosGrid.appendChild(photoCard);
                });
                
                modal.show();
                
                // Th√™m log
                addLog('Xem ·∫£nh c·ªßa s·ª± ki·ªán', `${eventContent}: ${eventPhotos.length} ·∫£nh`);
                
            } catch (error) {
                console.error('L·ªói khi t·∫£i ·∫£nh c·ªßa s·ª± ki·ªán:', error);
                showMessage('‚ùå Kh√¥ng th·ªÉ t·∫£i ·∫£nh c·ªßa s·ª± ki·ªán. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
            }
        }

        // H√†m x·ª≠ l√Ω khi nh·∫•n ph√≠m trong √¥ comment
        function handleCommentKeyDown(event, photoId) {
            if (event.key === 'Enter' && event.ctrlKey) {
                event.preventDefault();
                addComment(photoId);
            }
        }

        // H√†m t·ª± ƒë·ªông m·ªü r·ªông textarea
        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
            
            // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t g·ª≠i
            const photoId = textarea.id.replace('comment-input-', '');
            const sendButton = document.getElementById(`send-btn-${photoId}`);
            const hasContent = textarea.value.trim().length > 0;
            
            if (sendButton) {
                sendButton.disabled = !hasContent;
            }
        }
        
        // H√†m x·ª≠ l√Ω khi focus v√†o input
        function focusCommentInput(photoId) {
            const container = document.querySelector(`#comment-input-${photoId}`).closest('.comment-input-container');
            if (container) {
                container.classList.add('focused');
            }
        }
        
        // H√†m x·ª≠ l√Ω khi blur kh·ªèi input
        function blurCommentInput(photoId) {
            const container = document.querySelector(`#comment-input-${photoId}`).closest('.comment-input-container');
            if (container) {
                setTimeout(() => {
                    container.classList.remove('focused');
                }, 150);
            }
        }

        // H√†m toggle hi·ªÉn th·ªã b√¨nh lu·∫≠n
        function toggleComments(photoId) {
            const commentsSection = document.getElementById(`comments-section-${photoId}`);
            const commentBtn = document.getElementById(`comment-btn-${photoId}`);
            const buttonAction = document.getElementById(`button-action-${photoId}`);
            
            if (commentsSection.classList.contains('hidden')) {
                commentsSection.classList.remove('hidden');
                commentBtn.classList.add('bg-blue-50');
                commentBtn.querySelector('i').classList.add('text-blue-600');
                commentBtn.querySelector('span').classList.add('text-blue-600');
                
                // Hi·ªán ƒë∆∞·ªùng k·∫ª d∆∞·ªõi khi m·ªü b√¨nh lu·∫≠n
                if (buttonAction) {
                    buttonAction.classList.add('border-b');
                }
                
                // Focus v√†o √¥ nh·∫≠p b√¨nh lu·∫≠n
                const commentInput = document.getElementById(`comment-input-${photoId}`);
                setTimeout(() => {
                    commentInput.focus();
                }, 100);
            } else {
                commentsSection.classList.add('hidden');
                commentBtn.classList.remove('bg-blue-50');
                commentBtn.querySelector('i').classList.remove('text-blue-600');
                commentBtn.querySelector('span').classList.remove('text-blue-600');
                
                // ·∫®n ƒë∆∞·ªùng k·∫ª d∆∞·ªõi khi ƒë√≥ng b√¨nh lu·∫≠n
                if (buttonAction) {
                    buttonAction.classList.remove('border-b');
                }
            }
        }

        // H√†m chia s·∫ª ·∫£nh
        async function sharePhoto(photoId, photoName) {
            try {
                const directUrl = `https://drive.google.com/uc?export=view&id=${photoId}`;
                
                // Th·ª≠ copy link v√†o clipboard
                try {
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        await navigator.clipboard.writeText(directUrl);
                        showMessage('üìã ƒê√£ copy link ·∫£nh v√†o clipboard!', 'success');
                    } else {
                        // Fallback cho tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ clipboard API
                        const textArea = document.createElement('textarea');
                        textArea.value = directUrl;
                        textArea.style.position = 'fixed';
                        textArea.style.left = '-999999px';
                        textArea.style.top = '-999999px';
                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select();
                        
                        try {
                            document.execCommand('copy');
                            showMessage('üìã ƒê√£ copy link ·∫£nh v√†o clipboard!', 'success');
                        } catch (err) {
                            console.error('Fallback copy failed:', err);
                            showMessage(`üîó Link ·∫£nh: ${directUrl}`, 'success');
                        }
                        
                        document.body.removeChild(textArea);
                    }
                } catch (clipboardError) {
                    console.error('Clipboard error:', clipboardError);
                    showMessage(`üîó Link ·∫£nh: ${directUrl}`, 'success');
                }
                
                // Th·ª≠ m·ªü ch·ª©c nƒÉng share c·ªßa thi·∫øt b·ªã n·∫øu c√≥
                if (navigator.share && navigator.canShare && navigator.canShare({ url: directUrl })) {
                    try {
                        await navigator.share({
                            title: `üíï ${photoName}`,
                            text: 'Chia s·∫ª kho·∫£nh kh·∫Øc ƒë√°ng y√™u',
                            url: directUrl
                        });
                    } catch (shareError) {
                        // Ng∆∞·ªùi d√πng ƒë√£ h·ªßy share ho·∫∑c c√≥ l·ªói
                        console.log('Share cancelled or failed:', shareError);
                    }
                }
                
            } catch (error) {
                console.error('L·ªói khi chia s·∫ª ·∫£nh:', error);
                showMessage('‚ùå Kh√¥ng th·ªÉ chia s·∫ª ·∫£nh. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
            }
        }

        // H√†m toggle reaction (ch·ªâ tim)
        async function toggleReaction(photoId, reactionType) {
            try {
                // T√¨m t√™n file ·∫£nh t·ª´ photoId trong allPhotosData
                const photo = allPhotosData.find(p => p.id === photoId);
                const imageName = photo ? photo.name : photoId;
                
                // ƒê·ªçc d·ªØ li·ªáu comments hi·ªán t·∫°i
                const { content: currentComments, sha } = await readComments();
                
                // T√¨m ho·∫∑c t·∫°o entry cho ·∫£nh n√†y
                let imageEntry = currentComments.find(entry => entry.ID_IMG === imageName);
                
                if (!imageEntry) {
                    // T·∫°o entry m·ªõi n·∫øu ch∆∞a c√≥
                    imageEntry = {
                        ID_IMG: imageName,
                        count_tim: 0,
                        comments: []
                    };
                    currentComments.push(imageEntry);
                }
                
                // TƒÉng s·ªë l∆∞·ª£ng tim
                if (reactionType === 'tim') {
                    imageEntry.count_tim = (imageEntry.count_tim || 0) + 1;
                }
                
                // L∆∞u v√†o GitHub
                await writeComments(currentComments, sha);
                
                // C·∫≠p nh·∫≠t d·ªØ li·ªáu local
                if (!reactionsData[imageName]) {
                    reactionsData[imageName] = { count_tim: 0 };
                }
                
                if (reactionType === 'tim') {
                    reactionsData[imageName].count_tim = imageEntry.count_tim;
                }
                
                // C·∫≠p nh·∫≠t giao di·ªán
                const countElement = document.getElementById(`heart-count-${photoId}`);
                if (countElement) {
                    countElement.textContent = imageEntry.count_tim;
                }
                
                // C·∫≠p nh·∫≠t icon tim - ch·ªâ hi·ªán ƒë·ªè khi v·ª´a ·∫•n
                const heartIcon = document.getElementById(`heart-icon-${photoId}`);
                if (heartIcon) {
                    // Hi·ªán tim ƒë·ªè t·∫°m th·ªùi khi ·∫•n
                    heartIcon.className = 'bi bi-heart-fill text-red-500 mr-1 text-sm';
                    
                    // Sau 1 gi√¢y tr·ªü v·ªÅ tim tr·∫Øng
                    setTimeout(() => {
                        heartIcon.className = 'bi bi-heart text-gray-600 mr-1 text-sm';
                    }, 1000);
                }
                
                // Th√™m hi·ªáu ·ª©ng animation
                const buttonElement = document.getElementById(`heart-btn-${photoId}`);
                if (buttonElement) {
                    buttonElement.classList.add('animate-pulse');
                    setTimeout(() => {
                        buttonElement.classList.remove('animate-pulse');
                    }, 500);
                }
                
                // showMessage('üíñ +1!', 'success');
                
            } catch (error) {
                console.error('L·ªói khi c·∫≠p nh·∫≠t reaction:', error);
                showMessage('L·ªói khi c·∫≠p nh·∫≠t reaction. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
            }
        }

        // H√†m th√™m comment
        async function addComment(photoId) {
            const input = document.getElementById(`comment-input-${photoId}`);
            const sendButton = document.getElementById(`send-btn-${photoId}`);
            const commentText = input.value.trim();
            
            if (!commentText) {
                return;
            }
            
            // Th√™m hi·ªáu ·ª©ng g·ª≠i
            sendButton.classList.add('sending');
            sendButton.disabled = true;
            
            try {
                // T√¨m t√™n file ·∫£nh t·ª´ photoId trong allPhotosData
                const photo = allPhotosData.find(p => p.id === photoId);
                const imageName = photo ? photo.name : photoId;
                
                // ƒê·ªçc d·ªØ li·ªáu comments hi·ªán t·∫°i
                const { content: currentComments, sha } = await readComments();
                
                // T√¨m ho·∫∑c t·∫°o entry cho ·∫£nh n√†y
                let imageEntry = currentComments.find(entry => entry.ID_IMG === imageName);
                
                if (!imageEntry) {
                    // T·∫°o entry m·ªõi n·∫øu ch∆∞a c√≥
                    imageEntry = {
                        ID_IMG: imageName,
                        count_tim: 0,
                        comments: []
                    };
                    currentComments.push(imageEntry);
                }
                
                // Th√™m comment m·ªõi v√†o m·∫£ng comments
                const newComment = {
                    comment: commentText,
                    date_input: new Date().toISOString()
                };
                
                if (!imageEntry.comments) {
                    imageEntry.comments = [];
                }
                imageEntry.comments.push(newComment);
                
                // L∆∞u v√†o GitHub
                await writeComments(currentComments, sha);
                
                // C·∫≠p nh·∫≠t d·ªØ li·ªáu local
                if (!commentsData[imageName]) {
                    commentsData[imageName] = [];
                }
                commentsData[imageName].push({
                    text: commentText,
                    timestamp: new Date().toISOString()
                });
                
                // C·∫≠p nh·∫≠t giao di·ªán
                const commentsContainer = document.getElementById(`comments-${photoId}`);
                const commentElement = document.createElement('div');
                const commentIndex = commentsData[imageName].length - 1;
                commentElement.className = 'bg-gray-50 rounded p-2 text-sm cursor-pointer comment-item mb-1';
                commentElement.onclick = () => toggleCommentTimestamp(photoId, commentIndex);
                commentElement.innerHTML = `
                    <p class="text-gray-700 break-words" style="white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word;">${commentText} <span class="comment-timestamp hidden text-xs text-gray-500 italic ml-2" style="font-size: 10px;" id="timestamp-${photoId}-${commentIndex}">${new Date().toLocaleString('vi-VN')}</span></p>
                `;
                commentsContainer.appendChild(commentElement);
                
                // Cu·ªôn xu·ªëng comment m·ªõi
                commentsContainer.scrollTop = commentsContainer.scrollHeight;
                
                // X√≥a n·ªôi dung input v√† reset chi·ªÅu cao
                input.value = '';
                input.style.height = 'auto';
                
                // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng comments trong giao di·ªán
                const commentCountElement = document.getElementById(`comment-count-${photoId}`);
                if (commentCountElement) {
                    commentCountElement.textContent = commentsData[imageName].length;
                }
                
                // showMessage('B√¨nh lu·∫≠n ƒë√£ ƒë∆∞·ª£c th√™m! üíï', 'success');
                
            } catch (error) {
                console.error('L·ªói khi th√™m b√¨nh lu·∫≠n:', error);
                showMessage('L·ªói khi th√™m b√¨nh lu·∫≠n. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
            } finally {
                // X√≥a hi·ªáu ·ª©ng g·ª≠i
                setTimeout(() => {
                    sendButton.classList.remove('sending');
                    sendButton.disabled = true; // V·∫´n disabled v√¨ input ƒë√£ tr·ªëng
                }, 300);
            }
        }

        // H√†m toggle hi·ªÉn th·ªã timestamp c·ªßa b√¨nh lu·∫≠n
        function toggleCommentTimestamp(photoId, commentIndex) {
            const timestampElement = document.getElementById(`timestamp-${photoId}-${commentIndex}`);
            if (timestampElement) {
                timestampElement.classList.toggle('hidden');
            }
        }

        // H√†m m√£ h√≥a Base64
        function base64Encode(str) {
            return btoa(unescape(encodeURIComponent(str)));
        }

        // H√†m gi·∫£i m√£ Base64
        function base64Decode(str) {
            return decodeURIComponent(escape(atob(str)));
        }

        // H√†m ghi d·ªØ li·ªáu v√†o file
        async function writeNotes(notes, sha) {
            const content = JSON.stringify(notes, null, 2);
            const encodedContent = base64Encode(content);

            const body = JSON.stringify({
                message: 'Th√™m s·ª± ki·ªán m·ªõi',
                content: encodedContent,
                sha: sha
            });

            try {
                const response = await fetch(API_BASE_URL, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${PAT}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: body
                });

                const data = await response.json();
                console.log('ƒê√£ ghi s·ª± ki·ªán th√†nh c√¥ng l√™n GitHub:', data);
                return data;
            } catch (error) {
                console.error('L·ªói khi ghi s·ª± ki·ªán l√™n GitHub:', error);
                throw error;
            }
        }

        // H√†m x√≥a s·ª± ki·ªán
        async function deleteEvent(index) {
            const { content: currentEvents, sha } = await readNotes();
            const deletedEvent = currentEvents[index];
            currentEvents.splice(index, 1); // X√≥a ph·∫ßn t·ª≠ t·∫°i v·ªã tr√≠ index
            
            await writeNotes(currentEvents, sha);
            displayEvents(currentEvents);
            showMessage('S·ª± ki·ªán ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng! üóëÔ∏è', 'success');
            
            // Th√™m log
            const eventInfo = deletedEvent ? `${deletedEvent.day}/${deletedEvent.month}/${deletedEvent.year}: ${deletedEvent.contdetl}` : 'S·ª± ki·ªán kh√¥ng x√°c ƒë·ªãnh';
            addLog('X√≥a s·ª± ki·ªán', eventInfo);
        }

        // H√†m hi·ªÉn th·ªã th√¥ng b√°o
        function showMessage(message, type = 'success') {
            const alertClass = type === 'error' ? 'alert-danger' : 'alert-success';
            const alertHtml = `
                <div class="alert ${alertClass} alert-dismissible fade show position-fixed" style="top: 20px; right: 20px; z-index: 9999;" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', alertHtml);
            
            // T·ª± ƒë·ªông ·∫©n sau 3 gi√¢y
            setTimeout(() => {
                const alert = document.querySelector('.alert');
                if (alert) {
                    alert.remove();
                }
            }, 3000);
        }

        // H√†m ƒë·ªçc v√† ghi comments
        async function readComments() {
            try {
                // Th√™m timeout cho request
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 gi√¢y timeout
                
                const response = await fetch(COMMENTS_API_URL, {
                    headers: {
                        'Authorization': `token ${PAT}`,
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        // File ch∆∞a t·ªìn t·∫°i, t·∫°o file m·ªõi
                        return { content: [], sha: null };
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const content = JSON.parse(base64Decode(data.content));
                return { content, sha: data.sha };
            } catch (error) {
                console.error('L·ªói khi ƒë·ªçc comments t·ª´ GitHub:', error);
                return { content: [], sha: null };
            }
        }

        async function writeComments(commentsArray, sha) {
            const content = JSON.stringify(commentsArray, null, 2);
            const encodedContent = base64Encode(content);

            const body = JSON.stringify({
                message: 'C·∫≠p nh·∫≠t b√¨nh lu·∫≠n ·∫£nh',
                content: encodedContent,
                ...(sha && { sha: sha })
            });

            try {
                // Th√™m timeout cho request
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 gi√¢y timeout
                
                const response = await fetch(COMMENTS_API_URL, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${PAT}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: body,
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);

                const data = await response.json();
                console.log('ƒê√£ ghi comments th√†nh c√¥ng l√™n GitHub:', data);
                return data;
            } catch (error) {
                console.error('L·ªói khi ghi comments l√™n GitHub:', error);
                throw error;
            }
        }





        // Bi·∫øn l∆∞u tr·ªØ s·ª± ki·ªán ƒë∆∞·ª£c ch·ªçn
        let selectedEventIndex = -1;
        let currentEventsData = [];

        // H√†m t√≠nh to√°n th√¥ng tin k·ª∑ ni·ªám
        function calculateAnniversary(dateStr) {
            const now = new Date();
            const [day, month, year] = dateStr.split('/').map(Number);
            const originalDate = new Date(year, month - 1, day);
            const nextAnniversary = new Date(now.getFullYear(), month - 1, day);

            // N·∫øu ng√†y k·ª∑ ni·ªám trong nƒÉm hi·ªán t·∫°i ƒë√£ qua, t√≠nh cho nƒÉm sau
            if (nextAnniversary < now) {
                nextAnniversary.setFullYear(now.getFullYear() + 1);
            }

            // T√≠nh s·ªë ng√†y c√≤n l·∫°i
            const diffTime = nextAnniversary.getTime() - now.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            // T√≠nh s·ªë nƒÉm k·ª∑ ni·ªám ƒë√£ tr√¥i qua ho·∫∑c s·∫Øp t·ªõi
            const anniversaryYears = nextAnniversary.getFullYear() - originalDate.getFullYear();

            return {
                date: dateStr,
                daysLeft: diffDays,
                anniversaryYears: anniversaryYears
            };
        }

        // H√†m c·∫≠p nh·∫≠t th√¥ng tin k·ª∑ ni·ªám
        function updateAnniversaryInfo(events) {
            const anniversaryInfo = document.getElementById('anniversaryInfo');
            const anniversaryLabel = document.getElementById('anniversaryLabel');
            const anniversaryDate = document.getElementById('anniversaryDate');
            const daysLeft = document.getElementById('daysLeft');
            const anniversaryYears = document.getElementById('anniversaryYears');

            if (!events || events.length === 0) {
                anniversaryInfo.style.display = 'none';
                return;
            }

            // T√¨m s·ª± ki·ªán g·∫ßn nh·∫•t
            let nearestEvent = null;
            let minDays = Infinity;

            events.forEach(event => {
                if (event.day && event.month && event.year) {
                    const day = String(event.day).padStart(2, '0');
                    const month = String(event.month).padStart(2, '0');
                    const dateStr = `${day}/${month}/${event.year}`;
                    
                    const anniversary = calculateAnniversary(dateStr);
                    
                    if (anniversary.daysLeft < minDays) {
                        minDays = anniversary.daysLeft;
                        nearestEvent = {
                            ...anniversary,
                            content: event.contdetl || 'S·ª± ki·ªán'
                        };
                    }
                }
            });

            if (nearestEvent) {
                anniversaryInfo.style.display = 'block';
                
                if (nearestEvent.anniversaryYears > 0) {
                    anniversaryLabel.innerHTML = `<span style="color: #dd317f;">K·ªâ ni·ªám</span> <strong style="color: #dd317f;">${nearestEvent.anniversaryYears}</strong> <span style="color: #dd317f;">nƒÉm</span> <span style="color: red;">${nearestEvent.content}</span>`;
                } else {
                    anniversaryLabel.innerHTML = `<span style="color: red;">S·ª± ki·ªán:</span> <span style="color: red;">${nearestEvent.content}</span>`;
                }
                
                anniversaryDate.textContent = nearestEvent.date;
                daysLeft.textContent = `C√≤n ${nearestEvent.daysLeft} ng√†y`;
                anniversaryYears.textContent = '';
            } else {
                anniversaryInfo.style.display = 'none';
            }
        }

        // H√†m c·∫≠p nh·∫≠t th√¥ng tin k·ª∑ ni·ªám cho s·ª± ki·ªán ƒë∆∞·ª£c ch·ªçn
        function updateAnniversaryInfoForSelectedEvent(event) {
            const anniversaryInfo = document.getElementById('anniversaryInfo');
            const anniversaryLabel = document.getElementById('anniversaryLabel');
            const anniversaryDate = document.getElementById('anniversaryDate');
            const daysLeft = document.getElementById('daysLeft');
            const anniversaryYears = document.getElementById('anniversaryYears');

            if (!event || !event.day || !event.month || !event.year) {
                anniversaryInfo.style.display = 'none';
                return;
            }

            const day = String(event.day).padStart(2, '0');
            const month = String(event.month).padStart(2, '0');
            const dateStr = `${day}/${month}/${event.year}`;
            
            const anniversary = calculateAnniversary(dateStr);
            
            anniversaryInfo.style.display = 'block';
            
            if (anniversary.anniversaryYears > 0) {
                anniversaryLabel.innerHTML = `<span style="color: #dd317f;">K·ªâ ni·ªám</span> <strong style="color: #dd317f;">${anniversary.anniversaryYears}</strong> <span style="color: #dd317f;">nƒÉm</span> <span style="color: red;">${event.contdetl || 'S·ª± ki·ªán'}</span>`;
            } else {
                anniversaryLabel.innerHTML = `<span style="color: red;">S·ª± ki·ªán:</span> <span style="color: red;">${event.contdetl || 'S·ª± ki·ªán'}</span>`;
            }
            
            anniversaryDate.textContent = anniversary.date;
            daysLeft.textContent = `C√≤n ${anniversary.daysLeft} ng√†y`;
            anniversaryYears.textContent = '';
        }

        // H√†m hi·ªÉn th·ªã danh s√°ch s·ª± ki·ªán
        function displayEvents(events) {
            const eventsContainer = document.getElementById('eventsContainer');
            const emptyState = document.getElementById('emptyState');
            const deleteBtn = document.getElementById('deleteEventBtn');
            
            // L∆∞u d·ªØ li·ªáu s·ª± ki·ªán hi·ªán t·∫°i
            currentEventsData = events;
            
            // C·∫≠p nh·∫≠t s·ª± ki·ªán tr√™n l·ªãch
            if (window.calendarInstance) {
                window.calendarInstance.updateEventsFromData(events);
            }
            
            // C·∫≠p nh·∫≠t th√¥ng tin k·ª∑ ni·ªám
            updateAnniversaryInfo(events);
            
            if (!events || events.length === 0) {
                emptyState.classList.remove('hidden');
                deleteBtn.disabled = true;
                return;
            }
            
            // S·∫Øp x·∫øp s·ª± ki·ªán theo ng√†y tƒÉng d·∫ßn
            const sortedEvents = [...events].sort((a, b) => {
                const dateA = new Date(a.year, a.month - 1, a.day);
                const dateB = new Date(b.year, b.month - 1, b.day);
                return dateA - dateB;
            });
            
            eventsContainer.innerHTML = '';
            
            sortedEvents.forEach((event, index) => {
                const eventElement = document.createElement('div');
                eventElement.className = 'bg-gradient-to-r from-pink-50 to-purple-50 border border-pink-200 rounded-lg p-3 cursor-pointer event-item';
                eventElement.dataset.index = index;
                
                // ƒê·ªãnh d·∫°ng ng√†y theo y√™u c·∫ßu: day/month/year
                let formattedDate = 'Kh√¥ng c√≥ ng√†y';
                
                // S·ª≠ d·ª•ng event.day, event.month, event.year
                if (event.day && event.month && event.year) {
                    const day = String(event.day).padStart(2, '0');
                    const month = String(event.month).padStart(2, '0');
                    formattedDate = `${day}/${month}/${event.year}`;
                }
                
                // L·∫•y n·ªôi dung s·ª± ki·ªán t·ª´ event.contdetl
                const eventContent = event.contdetl || 'Kh√¥ng c√≥ n·ªôi dung';
                
                // L·∫•y m√†u v√† icon t·ª´ s·ª± ki·ªán
                const eventColor = event.colorClass || 'bg-pink-500';
                const eventIcon = event.icon || 'üìÖ';
                
                eventElement.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="flex-shrink-0">
                            <div class="w-3 h-3 ${eventColor} rounded-full"></div>
                        </div>
                        <div class="flex-1">
                            <p class="text-gray-800 font-medium text-sm">
                                <span class="text-pink-600 font-bold">${formattedDate}:</span> 
                                ${eventContent}
                            </p>
                        </div>
                        <div class="flex-shrink-0">
                            <button class="text-gray-500 hover:text-blue-600 transition-colors p-1 rounded hover:bg-blue-50" 
                                    onclick="loadEventPhotos(${events.findIndex(originalEvent => 
                                        originalEvent.day === event.day && 
                                        originalEvent.month === event.month && 
                                        originalEvent.year === event.year && 
                                        originalEvent.contdetl === event.contdetl
                                    )})" 
                                    title="Xem ·∫£nh c·ªßa s·ª± ki·ªán">
                                <i class="bi bi-image-fill text-sm"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                // Th√™m s·ª± ki·ªán click ƒë·ªÉ ch·ªçn s·ª± ki·ªán
                eventElement.addEventListener('click', () => {
                    // B·ªè ch·ªçn t·∫•t c·∫£ s·ª± ki·ªán kh√°c
                    document.querySelectorAll('.event-item').forEach(item => {
                        item.classList.remove('border-red-400', 'bg-gradient-to-r', 'from-red-50', 'to-red-100', 'shadow-lg', 'scale-105');
                        item.classList.add('border-pink-200', 'from-pink-50', 'to-purple-50');
                    });
                    
                    // Ch·ªçn s·ª± ki·ªán hi·ªán t·∫°i v·ªõi hi·ªáu ·ª©ng ƒë·∫πp
                    eventElement.classList.remove('border-pink-200', 'from-pink-50', 'to-purple-50');
                    eventElement.classList.add('border-red-400', 'from-red-50', 'to-red-100', 'shadow-lg', 'scale-105');
                    
                    // T√¨m ch·ªâ s·ªë g·ªëc c·ªßa s·ª± ki·ªán trong m·∫£ng ch∆∞a s·∫Øp x·∫øp
                    selectedEventIndex = events.findIndex(originalEvent => 
                        originalEvent.day === event.day && 
                        originalEvent.month === event.month && 
                        originalEvent.year === event.year && 
                        originalEvent.contdetl === event.contdetl
                    );
                    deleteBtn.disabled = false;
                    
                    // C·∫≠p nh·∫≠t th√¥ng tin k·ª∑ ni·ªám cho s·ª± ki·ªán ƒë∆∞·ª£c ch·ªçn
                    updateAnniversaryInfoForSelectedEvent(event);
                    
                    // Chuy·ªÉn l·ªãch ƒë·∫øn ng√†y c·ªßa s·ª± ki·ªán ƒë∆∞·ª£c ch·ªçn (kh√¥ng cu·ªôn)
                    if (event.day && event.month && event.year && window.calendarInstance) {
                        const eventDate = new Date(event.year, event.month - 1, event.day);
                        window.calendarInstance.goToDateWithoutScroll(eventDate);
                    }
                });
                
                eventsContainer.appendChild(eventElement);
            });
        }

        // H√†m ƒë·ªçc d·ªØ li·ªáu danh s√°ch s·ª± ki·ªán t·ª´ file
        async function readNotes() {
            try {
                const loadingSpinner = document.getElementById('loading-spinner');
                const eventsContainer = document.getElementById('eventsContainer');
                const emptyState = document.getElementById('emptyState');
                const errorMessage = document.getElementById('errorMessage');
                
                // Hi·ªÉn th·ªã loading
                loadingSpinner.classList.remove('hidden');
                eventsContainer.innerHTML = '';
                emptyState.classList.add('hidden');
                errorMessage.classList.add('hidden');
                
                const response = await fetch(API_BASE_URL, {
                    headers: {
                        'Authorization': `token ${PAT}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Gi·∫£i m√£ n·ªôi dung t·ª´ Base64
                const content = JSON.parse(base64Decode(data.content));
                loadingSpinner.classList.add('hidden');
                
                // Hi·ªÉn th·ªã danh s√°ch s·ª± ki·ªán
                displayEvents(content);
                
                // Th√™m log
                addLog('Load refresh s·ª± ki·ªán', `${content.length} s·ª± ki·ªán`);
                
                return { content, sha: data.sha };
            } catch (error) {
                console.error('L·ªói khi ƒë·ªçc ghi ch√∫ t·ª´ GitHub:', error);
                const loadingSpinner = document.getElementById('loading-spinner');
                const errorMessage = document.getElementById('errorMessage');
                
                loadingSpinner.classList.add('hidden');
                errorMessage.classList.remove('hidden');
                
                return { content: [], sha: null };
            }
        }

        class Calendar {
            constructor() {
                this.currentDate = new Date();
                this.today = new Date();
                this.selectedDate = null;
                this.monthNames = [
                    'Th√°ng 1', 'Th√°ng 2', 'Th√°ng 3', 'Th√°ng 4', 'Th√°ng 5', 'Th√°ng 6',
                    'Th√°ng 7', 'Th√°ng 8', 'Th√°ng 9', 'Th√°ng 10', 'Th√°ng 11', 'Th√°ng 12'
                ];
                this.dayNames = ['Ch·ªß nh·∫≠t', 'Th·ª© hai', 'Th·ª© ba', 'Th·ª© t∆∞', 'Th·ª© nƒÉm', 'Th·ª© s√°u', 'Th·ª© b·∫£y'];
                
                // Events and anniversaries will be loaded from data
                this.events = new Set();
                this.anniversaries = new Set();
                
                this.init();
            }

            init() {
                this.render();
                this.bindEvents();
                this.updateTodayInfo();
            }

            bindEvents() {
                document.getElementById('prevMonth').addEventListener('click', () => {
                    this.currentDate.setMonth(this.currentDate.getMonth() - 1);
                    this.render();
                });

                document.getElementById('nextMonth').addEventListener('click', () => {
                    this.currentDate.setMonth(this.currentDate.getMonth() + 1);
                    this.render();
                });
            }

            render() {
                this.updateHeader();
                this.renderDays();
            }

            updateHeader() {
                const monthYear = `${this.monthNames[this.currentDate.getMonth()]} ${this.currentDate.getFullYear()}`;
                document.getElementById('monthYear').textContent = monthYear;
                
                // Debug log
                console.log('Updating calendar for:', monthYear);
            }

            renderDays() {
                const calendarDays = document.getElementById('calendarDays');
                calendarDays.innerHTML = '';

                const year = this.currentDate.getFullYear();
                const month = this.currentDate.getMonth();
                
                // T√≠nh ng√†y ƒë·∫ßu ti√™n c·ªßa th√°ng
                const firstDay = new Date(year, month, 1);
                // T√≠nh ng√†y b·∫Øt ƒë·∫ßu hi·ªÉn th·ªã (Ch·ªß nh·∫≠t c·ªßa tu·∫ßn ch·ª©a ng√†y 1)
                const startDate = new Date(firstDay);
                startDate.setDate(firstDay.getDate() - firstDay.getDay());

                // T·∫°o 42 √¥ (6 tu·∫ßn x 7 ng√†y)
                for (let i = 0; i < 42; i++) {
                    const currentDate = new Date(startDate);
                    currentDate.setDate(startDate.getDate() + i);
                    
                    // Debug log for first few dates
                    if (i < 7) {
                        console.log(`Day ${i}: ${currentDate.getDate()}/${currentDate.getMonth() + 1}/${currentDate.getFullYear()}`);
                    }
                    
                    const dayElement = this.createDayElement(currentDate, month);
                    calendarDays.appendChild(dayElement);
                }
            }

            createDayElement(date, currentMonth) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'p-1 md:p-2 text-center cursor-pointer min-h-[45px] md:min-h-[65px] lg:min-h-[70px] flex items-center justify-center relative';
                
                const dateCell = document.createElement('div');
                dateCell.className = 'date-cell';
                dateCell.textContent = date.getDate();
                
                const dateString = this.formatDate(date);
                
                // Check if it's today
                if (this.isSameDay(date, this.today)) {
                    dateCell.classList.add('today');
                }
                
                // Check if it's in current month
                if (date.getMonth() !== currentMonth) {
                    dateCell.classList.add('other-month');
                }
                
                // Check if it's weekend
                if (date.getDay() === 0 || date.getDay() === 6) {
                    dateCell.classList.add('weekend');
                }
                
                // Check for events
                if (this.events.has(dateString)) {
                    dateCell.classList.add('has-event');
                }
                
                // Check for anniversaries
                if (this.anniversaries.has(dateString)) {
                    dateCell.classList.add('anniversary');
                }
                
                // Add click event
                dateCell.addEventListener('click', () => {
                    // Remove previous selection
                    document.querySelectorAll('.date-cell.selected').forEach(cell => {
                        cell.classList.remove('selected');
                    });
                    
                    // Add selection to clicked date
                    dateCell.classList.add('selected');
                    this.selectedDate = new Date(date);
                });

                dayDiv.appendChild(dateCell);
                return dayDiv;
            }

            formatDate(date) {
                return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            }

            isSameDay(date1, date2) {
                return date1.getDate() === date2.getDate() &&
                       date1.getMonth() === date2.getMonth() &&
                       date1.getFullYear() === date2.getFullYear();
            }

            updateTodayInfo() {
                const todayString = `${this.dayNames[this.today.getDay()]}, ${this.today.getDate()}/${this.today.getMonth() + 1}/${this.today.getFullYear()}`;
                document.getElementById('todayDate').textContent = todayString;
            }

            goToToday() {
                this.currentDate = new Date();
                this.render();
            }

            goToDate(date) {
                this.currentDate = new Date(date);
                this.render();
                
                // Highlight ng√†y ƒë∆∞·ª£c ch·ªçn
                setTimeout(() => {
                    const targetDay = date.getDate();
                    const dateCells = document.querySelectorAll('.date-cell');
                    dateCells.forEach(cell => {
                        if (parseInt(cell.textContent) === targetDay && !cell.classList.contains('other-month')) {
                            cell.classList.add('selected');
                            cell.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    });
                }, 100);
            }

            goToDateWithoutScroll(date) {
                this.currentDate = new Date(date);
                this.render();
                
                // Highlight ng√†y ƒë∆∞·ª£c ch·ªçn nh∆∞ng kh√¥ng cu·ªôn
                setTimeout(() => {
                    const targetDay = date.getDate();
                    const dateCells = document.querySelectorAll('.date-cell');
                    dateCells.forEach(cell => {
                        if (parseInt(cell.textContent) === targetDay && !cell.classList.contains('other-month')) {
                            cell.classList.add('selected');
                        }
                    });
                }, 100);
            }

            updateEventsFromData(events) {
                this.events.clear();
                this.anniversaries.clear();
                
                if (events && events.length > 0) {
                    events.forEach(event => {
                        if (event.day && event.month && event.year) {
                            const dateString = `${event.year}-${String(event.month).padStart(2, '0')}-${String(event.day).padStart(2, '0')}`;
                            this.events.add(dateString);
                            
                            // Ki·ªÉm tra n·∫øu l√† s·ª± ki·ªán k·ª∑ ni·ªám (c√≥ th·ªÉ d·ª±a v√†o n·ªôi dung ho·∫∑c icon)
                            if (event.contdetl && (event.contdetl.toLowerCase().includes('k·ª∑ ni·ªám') || 
                                event.contdetl.toLowerCase().includes('anniversary') || 
                                event.icon === '‚ù§Ô∏è')) {
                                this.anniversaries.add(dateString);
                            }
                        }
                    });
                }
                
                // Re-render calendar to show updated events
                this.render();
            }
        }

        // H√†m kh·ªüi t·∫°o ·ª©ng d·ª•ng sau khi t·∫£i c·∫•u h√¨nh
        async function initializeApp() {
            try {
                console.log('üöÄ B·∫Øt ƒë·∫ßu kh·ªüi t·∫°o ·ª©ng d·ª•ng...');
                
                // T·∫£i c·∫•u h√¨nh tr∆∞·ªõc
                try {
                    await loadConfig();
                    console.log('‚úÖ C·∫•u h√¨nh ƒë√£ ƒë∆∞·ª£c t·∫£i th√†nh c√¥ng');
                } catch (configError) {
                    console.warn('‚ö†Ô∏è Kh√¥ng th·ªÉ t·∫£i c·∫•u h√¨nh, s·ª≠ d·ª•ng c·∫•u h√¨nh m·∫∑c ƒë·ªãnh');
                    
                    // S·ª≠ d·ª•ng c·∫•u h√¨nh demo ƒë·ªÉ ·ª©ng d·ª•ng v·∫´n c√≥ th·ªÉ ch·∫°y
                    CONFIG = {
                        GITHUB_USERNAME: 'nhungcute',
                        REPO_NAME: 'LoveStory',
                        PAT1: 'ghp_a8VLpoCYQByLbUIwe',
                        PAT2: 'd3dy4hHjEpKwr3stE6T',
                        FILE_PATH: 'notes.json',
                        COMMENTS_FILE_PATH: 'mess.json',
                        PHOTOS_METADATA_FILE_PATH: 'list_file_img_ggdriver.json',
                        LOGS_FILE_PATH: 'logs.json',
                        FOLDER_ID: '1B_tpWbLwlc7mqT789-g2RO9K2pYNXVav',
                        API_KEY: 'AIzaSyDJddlVwOWA8vzdVNrcp70if4eOL30xjp0',
                        PHOTOS_PER_PAGE: 50,
                        AUTO_LOAD_METADATA: 'false'
                    };
                    
                    // Thi·∫øt l·∫≠p c√°c bi·∫øn c∆° b·∫£n
                    GITHUB_USERNAME = CONFIG.GITHUB_USERNAME;
                    REPO_NAME = CONFIG.REPO_NAME;
                    PAT = CONFIG.PAT1 + CONFIG.PAT2;
                    FILE_PATH = CONFIG.FILE_PATH;
                    COMMENTS_FILE_PATH = CONFIG.COMMENTS_FILE_PATH;
                    PHOTOS_METADATA_FILE_PATH = CONFIG.PHOTOS_METADATA_FILE_PATH;
                    LOGS_FILE_PATH = CONFIG.LOGS_FILE_PATH;
                    FOLDER_ID = CONFIG.FOLDER_ID;
                    API_KEY = CONFIG.API_KEY;
                    PHOTOS_PER_PAGE = CONFIG.PHOTOS_PER_PAGE;
                    
                    // Thi·∫øt l·∫≠p URL API (s·∫Ω kh√¥ng ho·∫°t ƒë·ªông nh∆∞ng kh√¥ng g√¢y l·ªói)
                    API_BASE_URL = `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${FILE_PATH}`;
                    COMMENTS_API_URL = `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${COMMENTS_FILE_PATH}`;
                    PHOTOS_METADATA_API_URL = `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${PHOTOS_METADATA_FILE_PATH}`;
                    LOGS_API_URL = `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${LOGS_FILE_PATH}`;
                    CONFIG_API_URL = `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/configApp.json`;
                    
                    showMessage('‚ö†Ô∏è Ch·∫°y ·ªü ch·∫ø ƒë·ªô demo - m·ªôt s·ªë t√≠nh nƒÉng c√≥ th·ªÉ kh√¥ng ho·∫°t ƒë·ªông', 'error');
                }
                
                // Kh·ªüi t·∫°o calendar
                console.log('üìÖ Kh·ªüi t·∫°o calendar...');
                const calendar = new Calendar();
                window.calendarInstance = calendar;
                console.log('‚úÖ Calendar ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o');
                
                // T·∫£i danh s√°ch s·ª± ki·ªán khi trang ƒë∆∞·ª£c t·∫£i (v·ªõi error handling)
                console.log('üìã T·∫£i danh s√°ch s·ª± ki·ªán...');
                try {
                    const { content } = await readNotes();
                    if (content && content.length > 0) {
                        calendar.updateEventsFromData(content);
                        console.log(`‚úÖ ƒê√£ t·∫£i ${content.length} s·ª± ki·ªán`);
                    } else {
                        console.log('üìù Ch∆∞a c√≥ s·ª± ki·ªán n√†o');
                    }
                } catch (eventsError) {
                    console.warn('‚ö†Ô∏è Kh√¥ng th·ªÉ t·∫£i s·ª± ki·ªán:', eventsError.message);
                }
                
                // T·∫£i ·∫£nh t·ª´ metadata GitHub (v·ªõi error handling)
                console.log('üñºÔ∏è T·∫£i danh s√°ch ·∫£nh...');
                try {
                    await loadAllPhotosFromMetadata();
                    console.log('‚úÖ ƒê√£ t·∫£i danh s√°ch ·∫£nh');
                } catch (photosError) {
                    console.warn('‚ö†Ô∏è Kh√¥ng th·ªÉ t·∫£i ·∫£nh:', photosError.message);
                }
                
                // Kh·ªüi t·∫°o c√°c s·ª± ki·ªán v√† ch·ª©c nƒÉng kh√°c
                console.log('üîß Kh·ªüi t·∫°o event handlers...');
                initializeEventHandlers();
                console.log('‚úÖ Event handlers ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o');
                
                console.log('üéâ ·ª®ng d·ª•ng ƒë√£ kh·ªüi t·∫°o th√†nh c√¥ng!');
                
            } catch (error) {
                console.error('‚ùå L·ªói nghi√™m tr·ªçng khi kh·ªüi t·∫°o ·ª©ng d·ª•ng:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
                
                // V·∫´n c·ªë g·∫Øng kh·ªüi t·∫°o calendar c∆° b·∫£n
                try {
                    console.log('üîÑ Th·ª≠ kh·ªüi t·∫°o calendar c∆° b·∫£n...');
                    const calendar = new Calendar();
                    window.calendarInstance = calendar;
                    initializeEventHandlers();
                    showMessage('‚ö†Ô∏è ·ª®ng d·ª•ng ch·∫°y ·ªü ch·∫ø ƒë·ªô h·∫°n ch·∫ø. M·ªôt s·ªë t√≠nh nƒÉng c√≥ th·ªÉ kh√¥ng ho·∫°t ƒë·ªông.', 'error');
                } catch (fallbackError) {
                    console.error('üí• Kh√¥ng th·ªÉ kh·ªüi t·∫°o ·ª©ng d·ª•ng:', fallbackError);
                    showMessage('‚ùå C√≥ l·ªói nghi√™m tr·ªçng. Vui l√≤ng t·∫£i l·∫°i trang ho·∫∑c li√™n h·ªá h·ªó tr·ª£.', 'error');
                }
            }
        }

        // H√†m kh·ªüi t·∫°o floating settings menu
        function initializeFloatingSettings() {
            const container = document.getElementById('radialMenuContainer');
            const toggleBtn = document.getElementById('settingsBtn');
            const floatingSettings = document.querySelector('.floating-settings');

            let isDragging = false;
            let hasDragged = false;
            let startX, startY, initialX, initialY;
            let dragThreshold = 3; // Gi·∫£m threshold ƒë·ªÉ ph·∫£n h·ªìi nhanh h∆°n

            // Utility function to convert CSS variable string to number
            function varToNum(varName) {
                return parseFloat(getComputedStyle(document.documentElement).getPropertyValue(varName));
            }

            // L∆∞u v√† kh√¥i ph·ª•c v·ªã tr√≠ t·ª´ localStorage
            function savePosition() {
                const rect = floatingSettings.getBoundingClientRect();
                localStorage.setItem('floatingSettingsPosition', JSON.stringify({
                    top: rect.top,
                    left: rect.left
                }));
            }

            function loadPosition() {
                const saved = localStorage.getItem('floatingSettingsPosition');
                if (saved) {
                    try {
                        const position = JSON.parse(saved);
                        // Ki·ªÉm tra v·ªã tr√≠ c√≥ h·ª£p l·ªá kh√¥ng (trong m√†n h√¨nh)
                        if (position.top >= 0 && position.left >= 0 && 
                            position.top < window.innerHeight - 100 && 
                            position.left < window.innerWidth - 100) {
                            floatingSettings.style.left = position.left + 'px';
                            floatingSettings.style.top = position.top + 'px';
                            floatingSettings.style.transform = 'translate(0, 0)'; // Remove initial centering transform
                        }
                    } catch (e) {
                        console.log('Kh√¥ng th·ªÉ kh√¥i ph·ª•c v·ªã tr√≠ settings');
                    }
                }
            }

            // Kh√¥i ph·ª•c v·ªã tr√≠ khi t·∫£i trang
            loadPosition();
            
            // C·∫≠p nh·∫≠t v·ªã tr√≠ menu ban ƒë·∫ßu
            setTimeout(() => {
                setMenuDirection();
            }, 100);

            // H√†m x√°c ƒë·ªãnh h∆∞·ªõng m·ªü menu d·ª±a tr√™n v·ªã tr√≠ hi·ªán t·∫°i
            function setMenuDirection() {
                const rect = container.getBoundingClientRect();
                const winWidth = window.innerWidth;
                const winHeight = window.innerHeight;

                const distTop = rect.top + (rect.height / 2);
                const distBottom = winHeight - (rect.bottom - (rect.height / 2));
                const distLeft = rect.left + (rect.width / 2);
                const distRight = winWidth - (rect.right - (rect.width / 2));
                const minDistance = Math.min(distTop, distBottom, distLeft, distRight);

                container.classList.remove('position-top', 'position-bottom', 'position-left', 'position-right');

                if (minDistance === distTop) {
                    container.classList.add('position-top'); // Open down
                } else if (minDistance === distBottom) {
                    container.classList.add('position-bottom'); // Open up
                } else if (minDistance === distLeft) {
                    container.classList.add('position-left'); // Open right
                } else { // distRight
                    container.classList.add('position-right'); // Open left
                }
            }

            // --- DRAG LOGIC - CH·ªà CHO N√öT TOGGLE ---
            toggleBtn.addEventListener('mousedown', (e) => {
                // Ch·ªâ x·ª≠ l√Ω khi click tr·ª±c ti·∫øp v√†o n√∫t toggle ho·∫∑c icon b√™n trong
                if (e.target !== toggleBtn && e.target.parentElement !== toggleBtn) return;
                
                isDragging = true;
                hasDragged = false;
                
                // Record the initial mouse position and the element's initial position
                startX = e.clientX;
                startY = e.clientY;
                const floatingRect = floatingSettings.getBoundingClientRect();
                initialX = floatingRect.left;
                initialY = floatingRect.top;

                // Change cursor and prevent text selection
                toggleBtn.style.cursor = 'grabbing';
                document.body.style.userSelect = 'none';
                
                // Prevent default to avoid text selection
                e.preventDefault();
                e.stopPropagation();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;

                // Calculate mouse movement
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;

                // If the mouse has moved a significant amount, register it as a drag
                if (Math.abs(dx) > dragThreshold || Math.abs(dy) > dragThreshold) {
                    if (!hasDragged) {
                        hasDragged = true;
                        container.classList.remove('active'); // Close menu when dragging starts
                        floatingSettings.classList.remove('active');
                        floatingSettings.classList.add('dragging'); // Add dragging class
                    }
                }

                if (hasDragged) {
                    // Calculate new position v·ªõi smooth tracking
                    let newLeft = initialX + dx;
                    let newTop = initialY + dy;
                    
                    // Constrain the button within the viewport
                    const containerWidth = container.offsetWidth;
                    const containerHeight = container.offsetHeight;
                    const menuDiameter = (varToNum('--menu-radius') * 2) + varToNum('--item-size');

                    newLeft = Math.max(menuDiameter / 2, Math.min(newLeft, window.innerWidth - containerWidth - (menuDiameter / 2)));
                    newTop = Math.max(menuDiameter / 2, Math.min(newTop, window.innerHeight - containerHeight - (menuDiameter / 2)));

                    // Apply new position v·ªõi requestAnimationFrame ƒë·ªÉ smooth h∆°n
                    requestAnimationFrame(() => {
                        floatingSettings.style.left = `${newLeft}px`;
                        floatingSettings.style.top = `${newTop}px`;
                        floatingSettings.style.transform = 'translate(0, 0)';
                    });
                }
            });

            document.addEventListener('mouseup', (e) => {
                if (isDragging) {
                    isDragging = false;
                    toggleBtn.style.cursor = 'grab';
                    document.body.style.userSelect = 'auto';
                    floatingSettings.classList.remove('dragging'); // Remove dragging class
                    
                    if (hasDragged) {
                        savePosition(); // Save position after dragging
                        setMenuDirection(); // Update menu direction after dragging
                        // Reset hasDragged sau m·ªôt kho·∫£ng th·ªùi gian ng·∫Øn ƒë·ªÉ tr√°nh trigger click
                        setTimeout(() => {
                            hasDragged = false;
                        }, 100);
                    }
                }
            });

            // --- MENU TOGGLE LOGIC - CH·ªà CHO N√öT TOGGLE ---
            toggleBtn.addEventListener('click', (e) => {
                // Ch·ªâ x·ª≠ l√Ω khi click tr·ª±c ti·∫øp v√†o n√∫t toggle ho·∫∑c icon b√™n trong v√† kh√¥ng ph·∫£i drag
                if (e.target !== toggleBtn && e.target.parentElement !== toggleBtn) return;
                if (hasDragged) return;
                
                e.preventDefault();
                e.stopPropagation();
                
                // Determine the best direction to open BEFORE toggling the active class
                setMenuDirection();
                const isActive = container.classList.toggle('active');
                if (isActive) {
                    floatingSettings.classList.add('active');
                } else {
                    floatingSettings.classList.remove('active');
                }
            });

            // X·ª≠ l√Ω touch events cho mobile - CH·ªà CHO N√öT TOGGLE
            function handleTouchStart(e) {
                // Ch·ªâ x·ª≠ l√Ω khi touch tr·ª±c ti·∫øp v√†o n√∫t toggle ho·∫∑c icon b√™n trong
                if (e.target !== toggleBtn && e.target.parentElement !== toggleBtn) return;
                if (e.touches.length !== 1) return;
                
                const touch = e.touches[0];
                isDragging = true;
                hasDragged = false;
                
                startX = touch.clientX;
                startY = touch.clientY;
                const floatingRect = floatingSettings.getBoundingClientRect();
                initialX = floatingRect.left;
                initialY = floatingRect.top;

                document.addEventListener('touchmove', handleTouchMove, { passive: false });
                document.addEventListener('touchend', handleTouchEnd);
                
                e.preventDefault();
                e.stopPropagation();
            }

            function handleTouchMove(e) {
                if (!isDragging || e.touches.length !== 1) return;
                
                const touch = e.touches[0];
                const dx = touch.clientX - startX;
                const dy = touch.clientY - startY;
                
                if (Math.abs(dx) > dragThreshold || Math.abs(dy) > dragThreshold) {
                    if (!hasDragged) {
                        hasDragged = true;
                        container.classList.remove('active');
                        floatingSettings.classList.remove('active');
                        floatingSettings.classList.add('dragging');
                    }
                }

                if (hasDragged) {
                    e.preventDefault(); // NgƒÉn scroll trang
                    
                    let newLeft = initialX + dx;
                    let newTop = initialY + dy;
                    
                    const containerWidth = container.offsetWidth;
                    const containerHeight = container.offsetHeight;
                    const menuDiameter = (varToNum('--menu-radius') * 2) + varToNum('--item-size');

                    newLeft = Math.max(menuDiameter / 2, Math.min(newLeft, window.innerWidth - containerWidth - (menuDiameter / 2)));
                    newTop = Math.max(menuDiameter / 2, Math.min(newTop, window.innerHeight - containerHeight - (menuDiameter / 2)));
                    
                    requestAnimationFrame(() => {
                        floatingSettings.style.left = `${newLeft}px`;
                        floatingSettings.style.top = `${newTop}px`;
                        floatingSettings.style.transform = 'translate(0, 0)';
                    });
                }
            }

            function handleTouchEnd(e) {
                document.removeEventListener('touchmove', handleTouchMove);
                document.removeEventListener('touchend', handleTouchEnd);
                
                if (isDragging) {
                    isDragging = false;
                    floatingSettings.classList.remove('dragging');
                    
                    if (hasDragged) {
                        savePosition();
                        setMenuDirection();
                        setTimeout(() => {
                            hasDragged = false;
                        }, 100);
                    } else {
                        // Touch click
                        e.preventDefault();
                        setMenuDirection();
                        const isActive = container.classList.toggle('active');
                        if (isActive) {
                            floatingSettings.classList.add('active');
                        } else {
                            floatingSettings.classList.remove('active');
                        }
                    }
                }
            }

            // Th√™m touch event listeners - CH·ªà CHO N√öT TOGGLE
            toggleBtn.addEventListener('touchstart', handleTouchStart, { passive: false });

            // ƒê√≥ng menu khi click ra ngo√†i - CH·ªà ƒê√ìNG KHI CLICK NGO√ÄI N√öT TOGGLE
            document.addEventListener('click', (e) => {
                if (!hasDragged && 
                    e.target !== toggleBtn && 
                    e.target.parentElement !== toggleBtn &&
                    !e.target.closest('.menu')) {
                    container.classList.remove('active');
                    floatingSettings.classList.remove('active');
                }
            });

            // X·ª≠ l√Ω khi thay ƒë·ªïi k√≠ch th∆∞·ªõc m√†n h√¨nh
            window.addEventListener('resize', () => {
                const rect = floatingSettings.getBoundingClientRect();
                const containerWidth = container.offsetWidth;
                const containerHeight = container.offsetHeight;
                const menuDiameter = (varToNum('--menu-radius') * 2) + varToNum('--item-size');
                
                const maxX = window.innerWidth - containerWidth - (menuDiameter / 2);
                const maxY = window.innerHeight - containerHeight - (menuDiameter / 2);
                const minX = menuDiameter / 2;
                const minY = menuDiameter / 2;
                
                if (rect.left > maxX || rect.top > maxY || rect.left < minX || rect.top < minY) {
                    const newX = Math.max(minX, Math.min(rect.left, maxX));
                    const newY = Math.max(minY, Math.min(rect.top, maxY));
                    
                    floatingSettings.style.left = newX + 'px';
                    floatingSettings.style.top = newY + 'px';
                    savePosition();
                }
                
                // C·∫≠p nh·∫≠t h∆∞·ªõng menu sau khi resize
                setTimeout(() => {
                    setMenuDirection();
                }, 100);
            });

            // X·ª≠ l√Ω c√°c n√∫t trong menu
            document.getElementById('floatingAddEvent').addEventListener('click', () => {
                document.getElementById('addEventBtn').click();
                container.classList.remove('active');
                floatingSettings.classList.remove('active');
            });

            document.getElementById('floatingDeleteEvent').addEventListener('click', () => {
                document.getElementById('deleteEventBtn').click();
                container.classList.remove('active');
                floatingSettings.classList.remove('active');
            });



            document.getElementById('floatingUploadMetadata').addEventListener('click', () => {
                document.getElementById('uploadMetadataBtn').click();
                container.classList.remove('active');
                floatingSettings.classList.remove('active');
            });

            document.getElementById('floatingAutoUpdate').addEventListener('click', () => {
                document.getElementById('autoUpdateToggle').click();
                container.classList.remove('active');
                floatingSettings.classList.remove('active');
            });

            document.getElementById('floatingRefreshPhotos').addEventListener('click', () => {
                document.getElementById('refreshPhotos').click();
                container.classList.remove('active');
                floatingSettings.classList.remove('active');
            });

            // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t x√≥a s·ª± ki·ªán
            const originalDeleteBtn = document.getElementById('deleteEventBtn');
            const floatingDeleteBtn = document.getElementById('floatingDeleteEvent');
            
            // Theo d√µi thay ƒë·ªïi tr·∫°ng th√°i disabled c·ªßa n√∫t x√≥a g·ªëc
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'disabled') {
                        if (originalDeleteBtn.disabled) {
                            floatingDeleteBtn.style.opacity = '0.5';
                            floatingDeleteBtn.style.pointerEvents = 'none';
                        } else {
                            floatingDeleteBtn.style.opacity = '1';
                            floatingDeleteBtn.style.pointerEvents = 'all';
                        }
                    }
                });
            });

            observer.observe(originalDeleteBtn, { attributes: true });

            // Thi·∫øt l·∫≠p tr·∫°ng th√°i ban ƒë·∫ßu
            if (originalDeleteBtn.disabled) {
                floatingDeleteBtn.style.opacity = '0.5';
                floatingDeleteBtn.style.pointerEvents = 'none';
            }

            // C·∫≠p nh·∫≠t m√†u n√∫t t·ª± ƒë·ªông c·∫≠p nh·∫≠t d·ª±a tr√™n tr·∫°ng th√°i
            updateAutoUpdateButtonColor();
        }

        // H√†m c·∫≠p nh·∫≠t m√†u n√∫t t·ª± ƒë·ªông c·∫≠p nh·∫≠t
        function updateAutoUpdateButtonColor() {
            const isAutoEnabled = localStorage.getItem('autoUpdateEnabled') === 'true';
            const floatingAutoBtn = document.getElementById('floatingAutoUpdate');
            const alarmIcon = floatingAutoBtn.querySelector('i');
            
            if (isAutoEnabled) {
                // Tr·∫°ng th√°i b·∫≠t - icon m√†u ƒë·ªè ƒë·ªÉ ch·ªâ c√≥ th·ªÉ t·∫Øt
                alarmIcon.style.color = '#EF4444';
            } else {
                // Tr·∫°ng th√°i t·∫Øt - icon m√†u xanh ƒë·ªÉ ch·ªâ c√≥ th·ªÉ b·∫≠t
                alarmIcon.style.color = '#10B981';
            }
        }

        // H√†m kh·ªüi t·∫°o c√°c s·ª± ki·ªán
        function initializeEventHandlers() {
            // Kh·ªüi t·∫°o floating settings menu
            initializeFloatingSettings();
            // Kh·ªüi t·∫°o t·ª± ƒë·ªông c·∫≠p nh·∫≠t t·ª´ c·∫•u h√¨nh
            const isAutoEnabled = CONFIG.AUTO_LOAD_METADATA === "true" || CONFIG.AUTO_LOAD_METADATA === true;
            const toggleBtn = document.getElementById('autoUpdateToggle');
            
            if (isAutoEnabled) {
                setupAutoUpdate();
                toggleBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                toggleBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                toggleBtn.title = 'T·∫Øt c·∫≠p nh·∫≠t t·ª± ƒë·ªông 9h s√°ng';
                localStorage.setItem('autoUpdateEnabled', 'true');
            } else {
                // T·∫Øt t·ª± ƒë·ªông c·∫≠p nh·∫≠t
                stopAutoUpdate();
                toggleBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                toggleBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
                toggleBtn.title = 'B·∫≠t c·∫≠p nh·∫≠t t·ª± ƒë·ªông 9h s√°ng';
                localStorage.setItem('autoUpdateEnabled', 'false');
            }
            
            // Th√™m s·ª± ki·ªán cho c√°c n√∫t ph√¢n trang
            document.getElementById('firstPageBtn').addEventListener('click', () => {
                if (currentPage !== 1) {
                    displayPhotosPage(1);
                    document.getElementById('photosGrid').scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }
            });
            
            document.getElementById('prevPageBtn').addEventListener('click', () => {
                if (currentPage > 1) {
                    displayPhotosPage(currentPage - 1);
                    document.getElementById('photosGrid').scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }
            });
            
            document.getElementById('nextPageBtn').addEventListener('click', () => {
                if (currentPage < totalPages) {
                    displayPhotosPage(currentPage + 1);
                    document.getElementById('photosGrid').scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }
            });
            
            document.getElementById('lastPageBtn').addEventListener('click', () => {
                if (currentPage !== totalPages) {
                    displayPhotosPage(totalPages);
                    document.getElementById('photosGrid').scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }
            });
            
            // Th√™m ƒëi·ªÅu khi·ªÉn b√†n ph√≠m cho modal ·∫£nh
            document.addEventListener('keydown', (e) => {
                const photoModal = document.getElementById('photoModal');
                if (photoModal.classList.contains('show')) {
                    switch(e.key) {
                        case 'ArrowLeft':
                            e.preventDefault();
                            navigatePhoto(-1);
                            break;
                        case 'ArrowRight':
                            e.preventDefault();
                            navigatePhoto(1);
                            break;
                        case 'Escape':
                            e.preventDefault();
                            closePhotoModal();
                            break;
                    }
                }
            });
            


            // Th√™m s·ª± ki·ªán cho n√∫t c·∫≠p nh·∫≠t metadata ·∫£nh
            document.getElementById('uploadMetadataBtn').addEventListener('click', () => {
                uploadPhotosMetadata();
            });

            // Th√™m s·ª± ki·ªán cho n√∫t b·∫≠t/t·∫Øt t·ª± ƒë·ªông c·∫≠p nh·∫≠t
            document.getElementById('autoUpdateToggle').addEventListener('click', async () => {
                const isAutoEnabled = localStorage.getItem('autoUpdateEnabled') === 'true';
                const toggleBtn = document.getElementById('autoUpdateToggle');
                
                if (isAutoEnabled) {
                    // T·∫Øt t·ª± ƒë·ªông c·∫≠p nh·∫≠t
                    localStorage.setItem('autoUpdateEnabled', 'false');
                    stopAutoUpdate();
                    toggleBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                    toggleBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
                    toggleBtn.title = 'B·∫≠t c·∫≠p nh·∫≠t t·ª± ƒë·ªông 9h s√°ng';
                    showMessage('‚èπÔ∏è ƒê√£ t·∫Øt c·∫≠p nh·∫≠t t·ª± ƒë·ªông metadata', 'success');
                    
                    // C·∫≠p nh·∫≠t c·∫•u h√¨nh
                    await updateConfigFile('AUTO_LOAD_METADATA', 'false');
                    
                    // Th√™m log
                    addLog('T·∫Øt ch·ª©c nƒÉng c·∫≠p nh·∫≠t t·ª± ƒë·ªông 9h s√°ng', 'Ng∆∞·ªùi d√πng t·∫Øt th·ªß c√¥ng');
                } else {
                    // B·∫≠t t·ª± ƒë·ªông c·∫≠p nh·∫≠t
                    localStorage.setItem('autoUpdateEnabled', 'true');
                    setupAutoUpdate();
                    toggleBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                    toggleBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                    toggleBtn.title = 'T·∫Øt c·∫≠p nh·∫≠t t·ª± ƒë·ªông 9h s√°ng';
                    showMessage('‚è∞ ƒê√£ b·∫≠t c·∫≠p nh·∫≠t t·ª± ƒë·ªông metadata l√∫c 9h s√°ng h·∫±ng ng√†y', 'success');
                    
                    // C·∫≠p nh·∫≠t c·∫•u h√¨nh
                    await updateConfigFile('AUTO_LOAD_METADATA', 'true');
                    
                    // Th√™m log
                    addLog('B·∫≠t ch·ª©c nƒÉng c·∫≠p nh·∫≠t t·ª± ƒë·ªông 9h s√°ng', 'Ng∆∞·ªùi d√πng b·∫≠t th·ªß c√¥ng');
                }
                
                // C·∫≠p nh·∫≠t m√†u n√∫t floating
                updateAutoUpdateButtonColor();
            });

            // Th√™m s·ª± ki·ªán cho n√∫t refresh d·ªØ li·ªáu (t·∫£i l·∫°i c·∫£ s·ª± ki·ªán v√† ·∫£nh)
            document.getElementById('refreshPhotos').addEventListener('click', async () => {
                try {
                    // Refresh s·ª± ki·ªán
                    const { content } = await readNotes();
                    if (content && content.length > 0 && window.calendarInstance) {
                        window.calendarInstance.updateEventsFromData(content);
                    }
                    if (window.calendarInstance) {
                        window.calendarInstance.goToToday();
                    }
                    
                    // Refresh ·∫£nh
                    await loadAllPhotosFromMetadata();
                    
                    showMessage('‚úÖ ƒê√£ refresh to√†n b·ªô d·ªØ li·ªáu th√†nh c√¥ng!', 'success');
                } catch (error) {
                    console.error('L·ªói khi refresh d·ªØ li·ªáu:', error);
                    showMessage('‚ùå C√≥ l·ªói khi refresh d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
                }
            });

            // Th√™m s·ª± ki·ªán click v√†o v√πng tr·ªëng ƒë·ªÉ b·ªè ch·ªçn
            document.addEventListener('click', (e) => {
                // Ki·ªÉm tra n·∫øu click kh√¥ng ph·∫£i v√†o s·ª± ki·ªán ho·∫∑c c√°c n√∫t ƒëi·ªÅu khi·ªÉn
                if (!e.target.closest('.event-item') && 
                    !e.target.closest('#deleteEventBtn') && 
                    !e.target.closest('#addEventBtn')) {
                    
                    // B·ªè ch·ªçn t·∫•t c·∫£ s·ª± ki·ªán
                    document.querySelectorAll('.event-item').forEach(item => {
                        item.classList.remove('border-red-400', 'bg-gradient-to-r', 'from-red-50', 'to-red-100', 'shadow-lg', 'scale-105');
                        item.classList.add('border-pink-200', 'from-pink-50', 'to-purple-50');
                    });
                    
                    // Reset selection
                    selectedEventIndex = -1;
                    document.getElementById('deleteEventBtn').disabled = true;
                    
                    // Kh√¥i ph·ª•c th√¥ng tin k·ª∑ ni·ªám v·ªÅ s·ª± ki·ªán g·∫ßn nh·∫•t
                    updateAnniversaryInfo(currentEventsData);
                }
            });

            // X·ª≠ l√Ω s·ª± ki·ªán khi nh·∫•n n√∫t "X√≥a S·ª± Ki·ªán"
            document.getElementById('deleteEventBtn').addEventListener('click', () => {
                if (selectedEventIndex === -1) {
                    showMessage('Vui l√≤ng ch·ªçn s·ª± ki·ªán c·∫ßn x√≥a.', 'error');
                    return;
                }

                const selectedEvent = currentEventsData[selectedEventIndex];
                const day = String(selectedEvent.day).padStart(2, '0');
                const month = String(selectedEvent.month).padStart(2, '0');
                const formattedDate = `${day}/${month}/${selectedEvent.year}`;
                const eventContent = selectedEvent.contdetl || 'Kh√¥ng c√≥ n·ªôi dung';
                
                // Hi·ªÉn th·ªã th√¥ng tin s·ª± ki·ªán trong modal x√°c nh·∫≠n
                document.getElementById('eventToDelete').innerHTML = `
                    <strong>${formattedDate}:</strong> ${eventContent}
                `;
                
                // Hi·ªÉn th·ªã modal x√°c nh·∫≠n
                const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
                deleteModal.show();
            });

            // X·ª≠ l√Ω s·ª± ki·ªán khi nh·∫•n n√∫t x√°c nh·∫≠n x√≥a
            document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
                const confirmBtn = document.getElementById('confirmDeleteBtn');
                const deleteSpinner = document.getElementById('deleteSpinner');
                
                // Hi·ªÉn th·ªã loading
                confirmBtn.disabled = true;
                deleteSpinner.classList.remove('d-none');

                try {
                    await deleteEvent(selectedEventIndex);
                    
                    // ƒê√≥ng modal
                    const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
                    deleteModal.hide();
                    
                    // Reset selection
                    selectedEventIndex = -1;
                    document.getElementById('deleteEventBtn').disabled = true;
                    
                } catch (error) {
                    console.error('L·ªói khi x√≥a s·ª± ki·ªán:', error);
                    showMessage('L·ªói khi x√≥a s·ª± ki·ªán. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
                } finally {
                    // ·∫®n loading
                    confirmBtn.disabled = false;
                    deleteSpinner.classList.add('d-none');
                }
            });

            // X·ª≠ l√Ω s·ª± ki·ªán khi nh·∫•n n√∫t "L∆∞u ·∫¢nh V√†o S·ª± Ki·ªán"
            document.getElementById('savePhotoToEventsBtn').addEventListener('click', savePhotoToEvents);

            // X·ª≠ l√Ω s·ª± ki·ªán khi nh·∫•n n√∫t "L∆∞u S·ª± Ki·ªán"
            document.getElementById('saveEventBtn').addEventListener('click', async () => {
                const eventDate = document.getElementById('eventDate').value;
                const eventContent = document.getElementById('eventContent').value.trim();
                const eventColor = document.querySelector('input[name="eventColor"]:checked').value;
                const eventIcon = document.querySelector('input[name="eventIcon"]:checked').value;
                const eventImageFolder = document.getElementById('eventImageFolder').value.trim();

                if (!eventDate || !eventContent) {
                    showMessage('Vui l√≤ng nh·∫≠p ng√†y v√† n·ªôi dung s·ª± ki·ªán.', 'error');
                    return;
                }

                const saveBtn = document.getElementById('saveEventBtn');
                const saveSpinner = document.getElementById('saveSpinner');
                
                // Hi·ªÉn th·ªã loading
                saveBtn.disabled = true;
                saveSpinner.classList.remove('d-none');

                try {
                    // ƒê·ªçc d·ªØ li·ªáu hi·ªán t·∫°i
                    const { content: currentEvents, sha } = await readNotes();

                    // Chuy·ªÉn ƒë·ªïi ng√†y t·ª´ YYYY-MM-DD sang DD/MM/YYYY
                    const dateParts = eventDate.split('-');
                    const day = parseInt(dateParts[2]);
                    const month = parseInt(dateParts[1]);
                    const year = parseInt(dateParts[0]);

                    // T·∫°o s·ª± ki·ªán m·ªõi
                    const newEvent = {
                        day: day,
                        month: month,
                        year: year,
                        contdetl: eventContent,
                        colorClass: eventColor,
                        icon: eventIcon,
                        URL: eventImageFolder || '',
                        date: new Date().toISOString()
                    };
                    
                    // Th√™m s·ª± ki·ªán m·ªõi v√†o m·∫£ng
                    currentEvents.push(newEvent);
                    
                    // Ghi l·∫°i m·∫£ng ƒë√£ c·∫≠p nh·∫≠t
                    await writeNotes(currentEvents, sha);

                    // C·∫≠p nh·∫≠t giao di·ªán
                    displayEvents(currentEvents);
                    if (window.calendarInstance) {
                        window.calendarInstance.updateEventsFromData(currentEvents);
                    }
                    showMessage('S·ª± ki·ªán ƒë√£ ƒë∆∞·ª£c l∆∞u th√†nh c√¥ng! üéâ');

                    // Th√™m log
                    const eventInfo = `${day}/${month}/${year}: ${eventContent}`;
                    addLog('Th√™m m·ªõi s·ª± ki·ªán', eventInfo);

                    // ƒê√≥ng modal v√† reset form
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addEventModal'));
                    modal.hide();
                    document.getElementById('addEventForm').reset();
                    
                    // Reset c√°c radio button v·ªÅ m·∫∑c ƒë·ªãnh
                    document.getElementById('color-pink').checked = true;
                    document.getElementById('icon-heart').checked = true;

                } catch (error) {
                    console.error('L·ªói khi l∆∞u s·ª± ki·ªán:', error);
                    showMessage('L·ªói khi l∆∞u s·ª± ki·ªán. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
                } finally {
                    // ·∫®n loading
                    saveBtn.disabled = false;
                    saveSpinner.classList.add('d-none');
                }
            });
        }

        // Kh·ªüi t·∫°o ·ª©ng d·ª•ng khi DOM ƒë√£ s·∫µn s√†ng
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'984fecbb24515167',t:'MTc1ODg1OTk2NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
