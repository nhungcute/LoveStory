<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Love Story - Nhật Ký Tình Yêu</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Quicksand', sans-serif;
            background: linear-gradient(135deg, #ffeef8 0%, #f3e7ff 50%, #e7f3ff 100%);
            min-height: 100vh;
        }

        .love-gradient {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
        }

        .heart-beat {
            animation: heartbeat 1.5s ease-in-out infinite;
        }

        @keyframes heartbeat {
            0% { transform: scale(1); }
            14% { transform: scale(1.1); }
            28% { transform: scale(1); }
            42% { transform: scale(1.1); }
            70% { transform: scale(1); }
        }

        .sparkle {
            animation: sparkle 2s linear infinite;
        }

        @keyframes sparkle {
            0%, 100% { opacity: 0; transform: scale(0); }
            50% { opacity: 1; transform: scale(1); }
        }

        .calendar-day {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .calendar-day:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 154, 158, 0.3);
        }

        .event-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            position: absolute;
            bottom: 2px;
            right: 2px;
        }

        .radial-menu {
            position: fixed;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .radial-menu.docked-left {
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
        }

        .radial-menu.docked-right {
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
        }

        .radial-menu.docked-top {
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
        }

        .radial-menu.docked-bottom {
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
        }

        .photo-grid img {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .photo-grid img:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .love-shadow {
            box-shadow: 0 8px 32px rgba(255, 154, 158, 0.3);
        }

        .nav-tab {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            color: white;
        }

        .nav-tab:hover:not(.active) {
            background: rgba(255, 154, 158, 0.1);
        }
    </style>
</head>
<body>
    <!-- Radial Menu -->
    <div id="radialMenu" class="radial-menu docked-right">
        <div class="bg-white rounded-full p-3 love-shadow cursor-move" id="menuHandle">
            <i class="fas fa-heart text-pink-500 text-xl heart-beat"></i>
        </div>
        <div id="menuItems" class="mt-2 space-y-2 hidden">
            <button class="btn btn-sm love-gradient text-white rounded-full p-2" onclick="showAddEventModal()">
                <i class="fas fa-plus"></i>
            </button>
            <button class="btn btn-sm bg-red-400 text-white rounded-full p-2" onclick="deleteSelectedEvent()">
                <i class="fas fa-trash"></i>
            </button>
            <button class="btn btn-sm bg-blue-400 text-white rounded-full p-2" onclick="updateMetadata()">
                <i class="fas fa-sync"></i>
            </button>
            <button class="btn btn-sm bg-green-400 text-white rounded-full p-2" onclick="toggleAutoUpdate()">
                <i class="fas fa-clock"></i>
            </button>
            <button class="btn btn-sm bg-purple-400 text-white rounded-full p-2" onclick="refreshData()">
                <i class="fas fa-refresh"></i>
            </button>
        </div>
    </div>

    <!-- Status Indicator -->
    <div id="statusIndicator" class="position-fixed bottom-0 start-0 m-3 px-3 py-2 rounded-full glass-effect text-sm" style="z-index: 999;">
        <i class="fas fa-circle text-success me-1"></i>
        <span id="statusText">Đã kết nối</span>
    </div>

    <!-- Main Container -->
    <div class="container-fluid px-4 py-6">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">
                <i class="fas fa-heart text-pink-500 heart-beat mr-2"></i>
                Love Story
                <i class="fas fa-heart text-pink-500 heart-beat ml-2"></i>
            </h1>
            <p class="text-gray-600">Nhật ký tình yêu của chúng ta</p>
        </div>

        <!-- Navigation Tabs -->
        <div class="flex justify-center mb-6">
            <div class="glass-effect rounded-full p-1">
                <div class="flex space-x-1">
                    <div class="nav-tab active px-6 py-3 rounded-full font-medium" onclick="showTab('calendar')">
                        <i class="fas fa-calendar-heart mr-2"></i>Lịch Sự Kiện
                    </div>
                    <div class="nav-tab px-6 py-3 rounded-full font-medium" onclick="showTab('moments')">
                        <i class="fas fa-images mr-2"></i>Khoảnh Khắc
                    </div>
                </div>
            </div>
        </div>

        <!-- Calendar Tab -->
        <div id="calendarTab" class="tab-content">
            <div class="row">
                <!-- Calendar -->
                <div class="col-lg-8">
                    <div class="glass-effect rounded-3xl p-6 love-shadow">
                        <div class="flex justify-between items-center mb-4">
                            <button class="btn love-gradient text-white rounded-full" onclick="previousMonth()">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <h3 id="currentMonth" class="text-2xl font-semibold text-gray-800"></h3>
                            <button class="btn love-gradient text-white rounded-full" onclick="nextMonth()">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div id="calendar" class="grid grid-cols-7 gap-2"></div>
                    </div>
                </div>

                <!-- Events List -->
                <div class="col-lg-4">
                    <div class="glass-effect rounded-3xl p-6 love-shadow">
                        <h4 class="text-xl font-semibold text-gray-800 mb-4">
                            <i class="fas fa-list-heart mr-2 text-pink-500"></i>Sự Kiện
                        </h4>
                        <div id="eventsList" class="space-y-3 max-h-96 overflow-y-auto"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Moments Tab -->
        <div id="momentsTab" class="tab-content hidden">
            <div class="glass-effect rounded-3xl p-6 love-shadow">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-semibold text-gray-800">
                        <i class="fas fa-camera-retro mr-2 text-pink-500"></i>Khoảnh Khắc Đẹp
                    </h3>
                    <button class="btn love-gradient text-white rounded-full px-4 py-2" onclick="uploadPhoto()">
                        <i class="fas fa-plus mr-2"></i>Thêm Ảnh
                    </button>
                </div>
                
                <div id="photoGrid" class="photo-grid row g-3"></div>
                
                <!-- Pagination -->
                <div class="d-flex justify-content-center mt-6">
                    <nav>
                        <ul id="pagination" class="pagination"></ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Event Modal -->
    <div class="modal fade" id="addEventModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content glass-effect border-0">
                <div class="modal-header love-gradient text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-heart mr-2"></i>Thêm Sự Kiện Mới
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="eventForm">
                        <div class="mb-3">
                            <label class="form-label">Ngày</label>
                            <input type="date" class="form-control" id="eventDate" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Nội dung</label>
                            <textarea class="form-control" id="eventContent" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Màu sắc</label>
                            <div class="d-flex gap-2">
                                <input type="color" class="form-control form-control-color" id="eventColor" value="#ff9a9e">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Biểu tượng</label>
                            <div class="d-flex gap-2 flex-wrap">
                                <button type="button" class="btn btn-outline-secondary icon-btn" data-icon="heart">
                                    <i class="fas fa-heart"></i>
                                </button>
                                <button type="button" class="btn btn-outline-secondary icon-btn" data-icon="gift">
                                    <i class="fas fa-gift"></i>
                                </button>
                                <button type="button" class="btn btn-outline-secondary icon-btn" data-icon="birthday-cake">
                                    <i class="fas fa-birthday-cake"></i>
                                </button>
                                <button type="button" class="btn btn-outline-secondary icon-btn" data-icon="ring">
                                    <i class="fas fa-ring"></i>
                                </button>
                                <button type="button" class="btn btn-outline-secondary icon-btn" data-icon="plane">
                                    <i class="fas fa-plane"></i>
                                </button>
                                <button type="button" class="btn btn-outline-secondary icon-btn" data-icon="star">
                                    <i class="fas fa-star"></i>
                                </button>
                            </div>
                            <input type="hidden" id="selectedIcon" value="heart">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn love-gradient text-white" onclick="addEvent()">
                        <i class="fas fa-save mr-2"></i>Lưu Sự Kiện
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Photo Modal -->
    <div class="modal fade" id="photoModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content glass-effect border-0">
                <div class="modal-header">
                    <h5 class="modal-title">Khoảnh Khắc</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="modalPhoto" class="img-fluid rounded-3" style="max-height: 500px;">
                    <div class="mt-4">
                        <div class="d-flex justify-content-center align-items-center gap-4 mb-3">
                            <button class="btn love-gradient text-white rounded-full" onclick="likePhoto()">
                                <i id="likeIcon" class="fas fa-heart"></i>
                                <span id="likeCount">0</span>
                            </button>
                            <button class="btn btn-outline-secondary rounded-full" onclick="previousPhoto()">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button class="btn btn-outline-secondary rounded-full" onclick="nextPhoto()">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        
                        <!-- Comments Section -->
                        <div class="text-start">
                            <h6>Bình luận</h6>
                            <div id="commentsList" class="mb-3 max-h-32 overflow-y-auto"></div>
                            <div class="input-group">
                                <input type="text" id="commentInput" class="form-control" placeholder="Thêm bình luận...">
                                <button class="btn love-gradient text-white" onclick="addComment()">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Application State
        let currentDate = new Date();
        let events = [];
        let photos = [];
        let comments = {};
        let currentPhotoIndex = 0;
        let currentPage = 1;
        const photosPerPage = 12;
        let autoUpdateEnabled = false;
        let selectedEventId = null;
        let isLoading = false;

        // API Configuration
        const API_BASE_URL = 'https://your-serverless-functions.vercel.app/api'; // Replace with your actual serverless function URL
        
        // GitHub repository configuration (for reference)
        const GITHUB_CONFIG = {
            owner: 'your-username',
            repo: 'love-story-data',
            branch: 'main'
        };

        // API Functions for GitHub Backend
        async function apiCall(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
                
                if (data) {
                    options.body = JSON.stringify(data);
                }
                
                const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API Call Error:', error);
                // Fallback to localStorage for demo purposes
                return handleOfflineMode(endpoint, method, data);
            }
        }

        // Offline mode fallback using localStorage
        function handleOfflineMode(endpoint, method, data) {
            const storageKey = `loveStory${endpoint.replace('/', '')}`;
            
            if (method === 'GET') {
                const stored = localStorage.getItem(storageKey);
                return stored ? JSON.parse(stored) : getDefaultData(endpoint);
            } else if (method === 'POST' || method === 'PUT') {
                localStorage.setItem(storageKey, JSON.stringify(data));
                return { success: true, data };
            }
        }

        function getDefaultData(endpoint) {
            switch (endpoint) {
                case '/events':
                    return [];
                case '/photos':
                    return generateSamplePhotos();
                case '/comments':
                    return {};
                default:
                    return [];
            }
        }

        // Sample photos generator (fallback)
        function generateSamplePhotos() {
            const samplePhotos = [];
            for (let i = 1; i <= 24; i++) {
                samplePhotos.push({
                    id: i,
                    url: `https://picsum.photos/400/300?random=${i}`,
                    likes: Math.floor(Math.random() * 50),
                    linkedEvents: [],
                    date: new Date(2024, Math.floor(Math.random() * 12), Math.floor(Math.random() * 28) + 1),
                    metadata: {
                        name: `photo_${i}.jpg`,
                        size: Math.floor(Math.random() * 1000000) + 500000,
                        driveId: `drive_id_${i}`
                    }
                });
            }
            return samplePhotos;
        }

        // Data Loading Functions
        async function loadAllData() {
            if (isLoading) return;
            isLoading = true;
            
            showLoadingIndicator();
            
            try {
                // Load data in parallel
                const [eventsData, photosData, commentsData] = await Promise.all([
                    apiCall('/events'),
                    apiCall('/photos'),
                    apiCall('/comments')
                ]);
                
                events = eventsData || [];
                photos = photosData || generateSamplePhotos();
                comments = commentsData || {};
                
                // Update UI
                renderCalendar();
                renderEvents();
                renderPhotos();
                
                logAction('Đã tải dữ liệu từ GitHub repository');
            } catch (error) {
                console.error('Error loading data:', error);
                showErrorMessage('Không thể tải dữ liệu. Đang sử dụng chế độ offline.');
            } finally {
                isLoading = false;
                hideLoadingIndicator();
            }
        }

        async function saveEvents() {
            try {
                await apiCall('/events', 'PUT', events);
                logAction('Đã lưu sự kiện lên GitHub');
            } catch (error) {
                console.error('Error saving events:', error);
                showErrorMessage('Không thể lưu sự kiện. Dữ liệu được lưu cục bộ.');
            }
        }

        async function saveComments() {
            try {
                await apiCall('/comments', 'PUT', comments);
                logAction('Đã lưu bình luận lên GitHub');
            } catch (error) {
                console.error('Error saving comments:', error);
                showErrorMessage('Không thể lưu bình luận. Dữ liệu được lưu cục bộ.');
            }
        }

        async function updatePhotosMetadata() {
            try {
                showLoadingIndicator('Đang cập nhật metadata từ Google Drive...');
                
                const updatedPhotos = await apiCall('/photos/update-metadata', 'POST');
                photos = updatedPhotos || photos;
                
                renderPhotos();
                logAction('Đã cập nhật metadata ảnh từ Google Drive');
                showSuccessMessage('Đã cập nhật metadata thành công!');
            } catch (error) {
                console.error('Error updating metadata:', error);
                showErrorMessage('Không thể cập nhật metadata từ Google Drive.');
            } finally {
                hideLoadingIndicator();
            }
        }

        // UI Helper Functions
        function showLoadingIndicator(message = 'Đang tải...') {
            const existingLoader = document.getElementById('loadingIndicator');
            if (existingLoader) existingLoader.remove();
            
            const loader = document.createElement('div');
            loader.id = 'loadingIndicator';
            loader.className = 'position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center';
            loader.style.backgroundColor = 'rgba(0,0,0,0.5)';
            loader.style.zIndex = '9999';
            
            loader.innerHTML = `
                <div class="glass-effect rounded-3xl p-6 text-center">
                    <div class="spinner-border text-pink-500 mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="text-gray-800 font-medium">${message}</div>
                </div>
            `;
            
            document.body.appendChild(loader);
        }

        function hideLoadingIndicator() {
            const loader = document.getElementById('loadingIndicator');
            if (loader) loader.remove();
        }

        function showSuccessMessage(message) {
            showToast(message, 'success');
        }

        function showErrorMessage(message) {
            showToast(message, 'error');
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `position-fixed top-0 end-0 m-4 p-4 rounded-3 text-white ${type === 'success' ? 'bg-success' : type === 'error' ? 'bg-danger' : 'bg-info'}`;
            toast.style.zIndex = '9999';
            toast.style.minWidth = '300px';
            
            toast.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
                    <span>${message}</span>
                    <button class="btn-close btn-close-white ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', async function() {
            initializeRadialMenu();
            
            // Load data from GitHub/API
            await loadAllData();
            
            setupAutoUpdate();
            
            // Icon selection
            document.querySelectorAll('.icon-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.icon-btn').forEach(b => b.classList.remove('btn-primary'));
                    this.classList.add('btn-primary');
                    document.getElementById('selectedIcon').value = this.dataset.icon;
                });
            });
        });

        // Radial Menu Functions
        function initializeRadialMenu() {
            const menu = document.getElementById('radialMenu');
            const handle = document.getElementById('menuHandle');
            const items = document.getElementById('menuItems');
            let isDragging = false;
            let startX, startY;

            handle.addEventListener('mousedown', function(e) {
                isDragging = true;
                startX = e.clientX - menu.offsetLeft;
                startY = e.clientY - menu.offsetTop;
                document.addEventListener('mousemove', drag);
                document.addEventListener('mouseup', stopDrag);
            });

            handle.addEventListener('click', function() {
                if (!isDragging) {
                    items.classList.toggle('hidden');
                }
            });

            function drag(e) {
                if (!isDragging) return;
                
                let newX = e.clientX - startX;
                let newY = e.clientY - startY;
                
                // Snap to edges
                const threshold = 50;
                const windowWidth = window.innerWidth;
                const windowHeight = window.innerHeight;
                
                menu.classList.remove('docked-left', 'docked-right', 'docked-top', 'docked-bottom');
                
                if (newX < threshold) {
                    menu.classList.add('docked-left');
                } else if (newX > windowWidth - threshold) {
                    menu.classList.add('docked-right');
                } else if (newY < threshold) {
                    menu.classList.add('docked-top');
                } else if (newY > windowHeight - threshold) {
                    menu.classList.add('docked-bottom');
                } else {
                    menu.style.left = newX + 'px';
                    menu.style.top = newY + 'px';
                    menu.style.transform = 'none';
                }
            }

            function stopDrag() {
                isDragging = false;
                document.removeEventListener('mousemove', drag);
                document.removeEventListener('mouseup', stopDrag);
            }
        }

        // Calendar Functions
        function renderCalendar() {
            const calendar = document.getElementById('calendar');
            const monthElement = document.getElementById('currentMonth');
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            monthElement.textContent = `Tháng ${month + 1}, ${year}`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            calendar.innerHTML = '';
            
            // Day headers
            const dayHeaders = ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'];
            dayHeaders.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'text-center font-semibold text-gray-600 py-2';
                dayHeader.textContent = day;
                calendar.appendChild(dayHeader);
            });
            
            // Calendar days
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day relative bg-white rounded-lg p-3 text-center border-2 border-transparent';
                
                if (date.getMonth() !== month) {
                    dayElement.classList.add('text-gray-300');
                } else {
                    dayElement.classList.add('text-gray-800');
                }
                
                if (date.toDateString() === new Date().toDateString()) {
                    dayElement.classList.add('love-gradient', 'text-white', 'font-bold');
                }
                
                if (date.getDay() === 0 || date.getDay() === 6) {
                    dayElement.classList.add('bg-pink-50');
                }
                
                dayElement.textContent = date.getDate();
                
                // Check for events
                const dayEvents = events.filter(event => {
                    const eventDate = new Date(event.date);
                    return eventDate.toDateString() === date.toDateString();
                });
                
                if (dayEvents.length > 0) {
                    const dot = document.createElement('div');
                    dot.className = 'event-dot';
                    dot.style.backgroundColor = dayEvents[0].color;
                    dayElement.appendChild(dot);
                }
                
                dayElement.addEventListener('click', () => selectDate(date));
                calendar.appendChild(dayElement);
            }
        }

        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }

        function selectDate(date) {
            document.getElementById('eventDate').value = date.toISOString().split('T')[0];
            showAddEventModal();
        }

        // Event Functions
        function renderEvents() {
            const eventsList = document.getElementById('eventsList');
            eventsList.innerHTML = '';
            
            const sortedEvents = events.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedEvents.forEach(event => {
                const eventElement = document.createElement('div');
                eventElement.className = `bg-white rounded-lg p-3 border-l-4 cursor-pointer transition-all hover:shadow-lg ${selectedEventId === event.id ? 'ring-2 ring-pink-300' : ''}`;
                eventElement.style.borderLeftColor = event.color;
                
                eventElement.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="fas fa-${event.icon} text-lg mr-2" style="color: ${event.color}"></i>
                            <div>
                                <div class="font-semibold text-gray-800">${event.content}</div>
                                <div class="text-sm text-gray-500">${new Date(event.date).toLocaleDateString('vi-VN')}</div>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-outline-danger" onclick="selectEventForDeletion('${event.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                eventElement.addEventListener('click', () => selectEvent(event.id));
                eventsList.appendChild(eventElement);
            });
        }

        function showAddEventModal() {
            const modal = new bootstrap.Modal(document.getElementById('addEventModal'));
            modal.show();
        }

        async function addEvent() {
            const form = document.getElementById('eventForm');
            
            const event = {
                id: Date.now().toString(),
                date: document.getElementById('eventDate').value,
                content: document.getElementById('eventContent').value,
                color: document.getElementById('eventColor').value,
                icon: document.getElementById('selectedIcon').value,
                createdAt: new Date().toISOString()
            };
            
            events.push(event);
            
            // Update UI immediately for better UX
            renderCalendar();
            renderEvents();
            
            // Save to backend
            await saveEvents();
            
            logAction(`Đã thêm sự kiện: ${event.content}`);
            showSuccessMessage('Đã thêm sự kiện thành công!');
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('addEventModal'));
            modal.hide();
            form.reset();
        }

        function selectEvent(eventId) {
            selectedEventId = selectedEventId === eventId ? null : eventId;
            renderEvents();
        }

        function selectEventForDeletion(eventId) {
            selectedEventId = eventId;
            renderEvents();
        }

        async function deleteSelectedEvent() {
            if (!selectedEventId) {
                showErrorMessage('Vui lòng chọn một sự kiện để xóa');
                return;
            }
            
            if (confirm('Bạn có chắc chắn muốn xóa sự kiện này?')) {
                const eventIndex = events.findIndex(e => e.id === selectedEventId);
                if (eventIndex > -1) {
                    const deletedEvent = events[eventIndex];
                    events.splice(eventIndex, 1);
                    
                    // Update UI immediately
                    selectedEventId = null;
                    renderCalendar();
                    renderEvents();
                    
                    // Save to backend
                    await saveEvents();
                    
                    logAction(`Đã xóa sự kiện: ${deletedEvent.content}`);
                    showSuccessMessage('Đã xóa sự kiện thành công!');
                }
            }
        }

        // Photo Functions
        function renderPhotos() {
            const photoGrid = document.getElementById('photoGrid');
            const startIndex = (currentPage - 1) * photosPerPage;
            const endIndex = startIndex + photosPerPage;
            const pagePhotos = photos.slice(startIndex, endIndex);
            
            photoGrid.innerHTML = '';
            
            pagePhotos.forEach((photo, index) => {
                const photoElement = document.createElement('div');
                photoElement.className = 'col-md-3 col-sm-6';
                
                const photoComments = comments[photo.id] || [];
                const commentCount = photoComments.filter(c => c.type !== 'like').length;
                
                photoElement.innerHTML = `
                    <div class="position-relative">
                        <img src="${photo.url}" class="img-fluid rounded-3 love-shadow" onclick="openPhotoModal(${startIndex + index})" alt="Khoảnh khắc ${photo.id}">
                        <div class="position-absolute bottom-0 start-0 end-0 bg-gradient-to-t from-black/50 to-transparent rounded-bottom-3 p-2">
                            <div class="text-white text-sm">
                                <i class="fas fa-heart text-red-400"></i> ${photo.likes || 0}
                                <i class="fas fa-comment text-blue-400 ml-2"></i> ${commentCount}
                            </div>
                        </div>
                        ${photo.linkedEvents && photo.linkedEvents.length > 0 ? 
                            `<div class="position-absolute top-0 end-0 m-2">
                                <span class="badge love-gradient">
                                    <i class="fas fa-link"></i> ${photo.linkedEvents.length}
                                </span>
                            </div>` : ''
                        }
                    </div>
                `;
                
                photoGrid.appendChild(photoElement);
            });
            
            renderPagination();
        }

        function renderPagination() {
            const pagination = document.getElementById('pagination');
            const totalPages = Math.ceil(photos.length / photosPerPage);
            
            pagination.innerHTML = '';
            
            for (let i = 1; i <= totalPages; i++) {
                const pageItem = document.createElement('li');
                pageItem.className = `page-item ${i === currentPage ? 'active' : ''}`;
                
                const pageLink = document.createElement('a');
                pageLink.className = 'page-link';
                pageLink.href = '#';
                pageLink.textContent = i;
                pageLink.onclick = (e) => {
                    e.preventDefault();
                    currentPage = i;
                    renderPhotos();
                };
                
                pageItem.appendChild(pageLink);
                pagination.appendChild(pageItem);
            }
        }

        function openPhotoModal(index) {
            currentPhotoIndex = index;
            const photo = photos[currentPhotoIndex];
            const photoComments = comments[photo.id] || [];
            
            document.getElementById('modalPhoto').src = photo.url;
            document.getElementById('likeCount').textContent = photo.likes || 0;
            document.getElementById('likeIcon').className = photo.liked ? 'fas fa-heart text-red-500' : 'fas fa-heart';
            
            renderComments();
            
            const modal = new bootstrap.Modal(document.getElementById('photoModal'));
            modal.show();
        }

        async function likePhoto() {
            const photo = photos[currentPhotoIndex];
            
            if (photo.liked) {
                photo.likes = (photo.likes || 0) - 1;
                photo.liked = false;
            } else {
                photo.likes = (photo.likes || 0) + 1;
                photo.liked = true;
            }
            
            document.getElementById('likeCount').textContent = photo.likes;
            document.getElementById('likeIcon').className = photo.liked ? 'fas fa-heart text-red-500' : 'fas fa-heart';
            
            // Update the photo in the grid
            renderPhotos();
            
            // Save likes data to comments structure
            if (!comments[photo.id]) {
                comments[photo.id] = [];
            }
            
            // Store like status in a special comment entry
            const likeEntry = comments[photo.id].find(c => c.type === 'like');
            if (likeEntry) {
                likeEntry.likes = photo.likes;
                likeEntry.liked = photo.liked;
            } else {
                comments[photo.id].push({
                    type: 'like',
                    likes: photo.likes,
                    liked: photo.liked,
                    date: new Date().toISOString()
                });
            }
            
            await saveComments();
        }

        function previousPhoto() {
            if (currentPhotoIndex > 0) {
                currentPhotoIndex--;
                openPhotoModal(currentPhotoIndex);
            }
        }

        function nextPhoto() {
            if (currentPhotoIndex < photos.length - 1) {
                currentPhotoIndex++;
                openPhotoModal(currentPhotoIndex);
            }
        }

        function renderComments() {
            const commentsList = document.getElementById('commentsList');
            const photo = photos[currentPhotoIndex];
            const photoComments = comments[photo.id] || [];
            
            commentsList.innerHTML = '';
            
            photoComments.forEach(comment => {
                const commentElement = document.createElement('div');
                commentElement.className = 'bg-gray-100 rounded p-2 mb-2';
                commentElement.innerHTML = `
                    <div class="font-semibold text-sm">${comment.author}</div>
                    <div class="text-sm">${comment.text}</div>
                    <div class="text-xs text-gray-500">${new Date(comment.date).toLocaleString('vi-VN')}</div>
                `;
                commentsList.appendChild(commentElement);
            });
        }

        async function addComment() {
            const input = document.getElementById('commentInput');
            const text = input.value.trim();
            
            if (text) {
                const photo = photos[currentPhotoIndex];
                const newComment = {
                    id: Date.now().toString(),
                    author: 'Bạn',
                    text: text,
                    date: new Date().toISOString()
                };
                
                // Initialize comments array for photo if it doesn't exist
                if (!comments[photo.id]) {
                    comments[photo.id] = [];
                }
                
                comments[photo.id].push(newComment);
                
                input.value = '';
                renderComments();
                
                // Save to backend
                await saveComments();
                
                showSuccessMessage('Đã thêm bình luận!');
            }
        }

        function uploadPhoto() {
            // Simulate photo upload
            const newPhoto = {
                id: Date.now(),
                url: `https://picsum.photos/400/300?random=${Date.now()}`,
                likes: 0,
                comments: [],
                linkedEvents: [],
                date: new Date()
            };
            
            photos.unshift(newPhoto);
            localStorage.setItem('loveStoryPhotos', JSON.stringify(photos));
            renderPhotos();
            logAction('Đã thêm ảnh mới');
        }

        // Tab Functions
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            event.target.classList.add('active');
        }

        // Admin Functions
        async function updateMetadata() {
            await updatePhotosMetadata();
        }

        function toggleAutoUpdate() {
            autoUpdateEnabled = !autoUpdateEnabled;
            localStorage.setItem('autoUpdateEnabled', JSON.stringify(autoUpdateEnabled));
            logAction(`Tự động cập nhật: ${autoUpdateEnabled ? 'Bật' : 'Tắt'}`);
            showSuccessMessage(`Tự động cập nhật đã được ${autoUpdateEnabled ? 'bật' : 'tắt'}`);
            
            // Restart auto update timer
            setupAutoUpdate();
        }

        async function refreshData() {
            await loadAllData();
            showSuccessMessage('Đã làm mới dữ liệu thành công!');
        }

        function setupAutoUpdate() {
            if (autoUpdateEnabled) {
                const now = new Date();
                const target = new Date();
                target.setHours(9, 0, 0, 0);
                
                if (now > target) {
                    target.setDate(target.getDate() + 1);
                }
                
                const timeUntilUpdate = target.getTime() - now.getTime();
                
                setTimeout(() => {
                    updateMetadata();
                    setInterval(updateMetadata, 24 * 60 * 60 * 1000); // Daily
                }, timeUntilUpdate);
            }
        }

        async function logAction(action) {
            const logEntry = {
                timestamp: new Date().toISOString(),
                action: action,
                userAgent: navigator.userAgent.substring(0, 100) // Truncate for storage
            };
            
            try {
                // Try to save to backend
                await apiCall('/logs', 'POST', logEntry);
            } catch (error) {
                // Fallback to localStorage
                const logs = JSON.parse(localStorage.getItem('loveStoryLogs')) || [];
                logs.push(logEntry);
                // Keep only last 100 logs to prevent storage overflow
                if (logs.length > 100) {
                    logs.splice(0, logs.length - 100);
                }
                localStorage.setItem('loveStoryLogs', JSON.stringify(logs));
            }
        }

        // Photo-Event Linking Functions
        function linkPhotoToEvent(photoId, eventId) {
            const photo = photos.find(p => p.id === photoId);
            const event = events.find(e => e.id === eventId);
            
            if (photo && event) {
                if (!photo.linkedEvents) {
                    photo.linkedEvents = [];
                }
                
                if (!photo.linkedEvents.includes(eventId)) {
                    photo.linkedEvents.push(eventId);
                    logAction(`Đã liên kết ảnh ${photoId} với sự kiện: ${event.content}`);
                    renderPhotos();
                    return true;
                }
            }
            return false;
        }

        function unlinkPhotoFromEvent(photoId, eventId) {
            const photo = photos.find(p => p.id === photoId);
            
            if (photo && photo.linkedEvents) {
                const index = photo.linkedEvents.indexOf(eventId);
                if (index > -1) {
                    photo.linkedEvents.splice(index, 1);
                    logAction(`Đã hủy liên kết ảnh ${photoId} với sự kiện ${eventId}`);
                    renderPhotos();
                    return true;
                }
            }
            return false;
        }

        function getPhotosForEvent(eventId) {
            return photos.filter(photo => 
                photo.linkedEvents && photo.linkedEvents.includes(eventId)
            );
        }

        // Status Management
        function updateStatus(isOnline, message) {
            const indicator = document.getElementById('statusIndicator');
            const icon = indicator.querySelector('i');
            const text = document.getElementById('statusText');
            
            if (isOnline) {
                icon.className = 'fas fa-circle text-success me-1';
                text.textContent = message || 'Đã kết nối';
            } else {
                icon.className = 'fas fa-circle text-warning me-1';
                text.textContent = message || 'Chế độ offline';
            }
        }

        // Monitor connection status
        window.addEventListener('online', () => {
            updateStatus(true, 'Đã kết nối lại');
            // Attempt to sync any pending changes
            loadAllData();
        });

        window.addEventListener('offline', () => {
            updateStatus(false, 'Mất kết nối');
        });

        // Handle comment input enter key
        document.addEventListener('keypress', function(e) {
            if (e.target.id === 'commentInput' && e.key === 'Enter') {
                addComment();
            }
        });

        /*
        SERVERLESS FUNCTION IMPLEMENTATION GUIDE:
        
        To complete the backend integration, you need to create serverless functions at:
        ${API_BASE_URL}
        
        Required endpoints:
        
        1. GET /api/events - Return events.json from GitHub
        2. PUT /api/events - Update events.json in GitHub
        3. GET /api/photos - Return photos_metadata.json from GitHub  
        4. PUT /api/photos - Update photos_metadata.json in GitHub
        5. POST /api/photos/update-metadata - Fetch from Google Drive and update metadata
        6. GET /api/comments - Return comments.json from GitHub
        7. PUT /api/comments - Update comments.json in GitHub
        8. POST /api/logs - Append to logs.json in GitHub
        
        Each function should:
        - Use GitHub API with your Personal Access Token (stored securely)
        - Handle CORS for your domain
        - Include proper error handling
        - Use SHA-based updates for GitHub file operations
        
        Example Vercel function structure:
        /api/events.js:
        export default async function handler(req, res) {
            // Handle GET/PUT operations with GitHub API
            // Use process.env.GITHUB_TOKEN for authentication
        }
        
        Google Drive integration requires:
        - Google Drive API v3 credentials
        - Folder ID where photos are stored
        - Proper OAuth2 or Service Account setup
        */
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9881221ab11a509a',t:'MTc1OTM3NTk1My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
