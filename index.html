// =======================================================
// CODE.GS - SOCIAL MEMORY API (FIXED SORTING & TIMEZONE)
// =======================================================

function doPost(e) {
  var lock = LockService.getScriptLock();
  // Thử khóa trong 10s để tránh xung đột khi ghi dữ liệu
  if (lock.tryLock(10000)) {
    try {
      var data = JSON.parse(e.postData.contents);
      var action = data.action;
      var ss = SpreadsheetApp.getActiveSpreadsheet();
      var result = {};

      switch (action) {
        // --- NHÓM 1: PROFILE ---
        case 'get_profile':
          result = handleGetProfile(ss, data);
          break;
        case 'save_profile':
          result = handleSaveProfile(ss, data);
          break;
        case 'get_profile_by_username':
          result = handleGetProfileByUsername(ss, data);
          break;

        // --- NHÓM 2: BABY RUN & STATS ---
        case 'get_babyrun_count':
          result = handleGetBabyRunCount(ss, data);
          break;
        case 'log_babyrun':
          result = handleLogBabyRun(ss, data);
          break;
        case 'get_bike_stats':
          result = handleGetBikeStats(ss, data); // <--- ĐÃ SỬA HÀM NÀY
          break;

        // --- NHÓM 3: FEED ---
        case 'feed_action':
          result = handleFeedAction(ss, data);
          break;
        case 'get_feed':
          result = handleGetFeed(ss);
          break;
          
        // --- NHÓM 4: GOLD ---
        case 'gold_entry':
          result = handleCreateGoldEntry(ss, data);
          break;

        default:
          result = { status: 'error', message: 'Unknown action: ' + action };
      }
      
      return responseJSON(result);
      
    } catch (err) {
      return responseJSON({ status: 'error', message: err.toString() });
    } finally {
      lock.releaseLock();
    }
  } else {
    return responseJSON({ status: 'error', message: 'Server busy, try again.' });
  }
}

// --- CORE FUNCTIONS ---

function handleGetProfile(ss, data) {
  var sheet = getSheet(ss, "profiles");
  var rows = sheet.getDataRange().getValues();
  for (var i = rows.length - 1; i >= 1; i--) {
    if (rows[i][0] == data.fingerprint) {
      return {
        status: 'success',
        data: {
          username: rows[i][1], fullname: rows[i][2],
          theme: rows[i][3], avaurl: rows[i][4]
        }
      };
    }
  }
  return { status: 'not_found' };
}

function handleSaveProfile(ss, data) {
  var sheet = getSheet(ss, "profiles");
  var rows = sheet.getDataRange().getValues();
  var rowIndex = -1;
  
  for (var i = 1; i < rows.length; i++) {
    // Tìm theo Username (ưu tiên) hoặc Fingerprint
    if (String(rows[i][1]) == String(data.username)) { 
      rowIndex = i + 1; 
      break; 
    }
  }
  
  var time = new Date();
  if (rowIndex > 0) {
    // Update
    sheet.getRange(rowIndex, 1).setValue(data.fingerprint);
    sheet.getRange(rowIndex, 3).setValue(data.fullname);
    sheet.getRange(rowIndex, 4).setValue(data.theme);
    sheet.getRange(rowIndex, 5).setValue(data.avaurl);
    sheet.getRange(rowIndex, 6).setValue(time);
  } else {
    // Insert
    sheet.appendRow([data.fingerprint, data.username, data.fullname, data.theme, data.avaurl, time]);
  }
  return { status: 'success' };
}

// --- HÀM LẤY THỐNG KÊ BIKE (QUAN TRỌNG: FIX LỖI CHART & TODAY) ---
function handleGetBikeStats(ss, data) {
  // 1. Lấy dữ liệu tổng hợp từ sheet 'totalbabyrun'
  var sheetTotal = ss.getSheetByName("totalbabyrun");
  var stats = { today: 0, week: 0, month: 0 };
  var chartHistory = [];

  // Lấy ngày hiện tại theo giờ Việt Nam (GMT+7) để so sánh chính xác
  var now = new Date();
  var todayStr = Utilities.formatDate(now, "GMT+7", "dd/MM/yyyy");
  var currentMonthStr = Utilities.formatDate(now, "GMT+7", "MM/yyyy");

  if (sheetTotal) {
    // Lấy dữ liệu dạng hiển thị (String) để tránh lỗi format ngày
    var rows = sheetTotal.getDataRange().getDisplayValues(); 
    
    // Duyệt qua từng dòng (Bỏ qua header dòng 0)
    for (var i = 1; i < rows.length; i++) {
      var dateStr = rows[i][0]; // Cột A: Ngày
      var count = parseInt(rows[i][1]); // Cột B: Số lượng

      // Bỏ qua dòng trống hoặc số lượng = 0 (nếu muốn)
      if (!dateStr || isNaN(count)) continue;

      // 1. Tính toán thống kê Stats
      // So sánh chuỗi ngày (dd/MM/yyyy) trực tiếp -> Chính xác tuyệt đối
      if (dateStr === todayStr) {
        stats.today = count;
      }
      
      // So sánh tháng (lấy phần MM/yyyy)
      var monthPart = dateStr.substring(3); // Cắt bỏ 'dd/' -> còn 'MM/yyyy'
      if (monthPart === currentMonthStr) {
        stats.month += count;
      }
      
      // 2. Thêm vào mảng lịch sử vẽ biểu đồ
      if (count > 0) {
        chartHistory.push({ date: dateStr, count: count });
      }
    }

    // 3. SẮP XẾP LẠI MẢNG THEO NGÀY TĂNG DẦN (QUAN TRỌNG)
    // Để biểu đồ vẽ từ Cũ -> Mới
    chartHistory.sort(function(a, b) {
       return parseDateToTime(a.date) - parseDateToTime(b.date);
    });
  }

  // 2. Lấy dữ liệu chi tiết logs (nếu cần hiển thị list bên dưới)
  var detailLogs = [];
  var sheetRaw = ss.getSheetByName("babyrun");
  if (sheetRaw) {
    var lastRow = sheetRaw.getLastRow();
    var numRows = Math.min(lastRow - 1, 50); // Lấy 50 dòng cuối
    if (numRows > 0) {
      var startRow = lastRow - numRows + 1;
      var rawData = sheetRaw.getRange(startRow, 1, numRows, 4).getDisplayValues();
      
      // Map lại dữ liệu và đảo ngược để mới nhất lên đầu
      detailLogs = rawData.reverse().map(function(r) {
        return { username: r[1], date: r[2], time: r[3] };
      });
    }
  }

  return {
    status: 'success',
    stats: stats,
    history: chartHistory, // Đã được sắp xếp Tăng dần
    logs: detailLogs
  };
}

// Hàm phụ trợ: Chuyển chuỗi "dd/MM/yyyy" thành timestamp để so sánh
function parseDateToTime(dateStr) {
  if (!dateStr) return 0;
  var parts = dateStr.split('/'); // [dd, MM, yyyy]
  if (parts.length < 3) return 0;
  // Lưu ý: Month trong JS bắt đầu từ 0 (Tháng 1 là 0)
  return new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0])).getTime();
}

function handleGetBabyRunCount(ss, data) {
  // Hàm này dùng để lấy số liệu nhanh cho Home Screen
  var dateStr = data.date; // Client gửi lên dd/MM/yyyy
  var sheet = ss.getSheetByName("totalbabyrun");
  if (!sheet) return { status: 'success', count: 0 };

  var rows = sheet.getDataRange().getDisplayValues();
  for (var i = 1; i < rows.length; i++) {
    if (rows[i][0] === dateStr) {
      return { status: 'success', count: parseInt(rows[i][1]) || 0 };
    }
  }
  return { status: 'success', count: 0 };
}

function handleLogBabyRun(ss, data) {
  var sheet = getSheet(ss, "babyrun");
  var id = Utilities.getUuid();
  var dateLog, timeLog;

  // Xử lý ngày giờ
  if (data.customDate && data.customTime) {
    dateLog = data.customDate;
    timeLog = data.customTime;
  } else {
    var now = new Date();
    dateLog = Utilities.formatDate(now, "GMT+7", "dd/MM/yyyy");
    timeLog = Utilities.formatDate(now, "GMT+7", "HH:mm:ss");
  }

  // Ghi log chi tiết
  sheet.appendRow([id, data.username, dateLog, timeLog]);
  
  // NOTE: Bạn cần có Trigger hoặc công thức trong Sheet để tự cập nhật vào 'totalbabyrun'
  // Script này chỉ ghi vào 'babyrun' (log thô) và đọc từ 'totalbabyrun' (log tổng).
  
  return { status: 'success', id: id };
}

function handleCreateGoldEntry(ss, data) {
  var sheet = getSheet(ss, "gold_entries");
  sheet.appendRow([Utilities.getUuid(), data.buyPrice, data.sellPrice, data.date, data.note, new Date()]);
  return { status: 'success' };
}

// --- FEED HANDLERS ---
function handleFeedAction(ss, data) {
  var sheet = getSheet(ss, "feed");
  var type = data.type;

  if (type === 'create') {
    var id = Utilities.getUuid();
    var nowStr = Utilities.formatDate(new Date(), "GMT+7", "dd/MM/yyyy HH:mm:ss");
    sheet.appendRow([id, nowStr, data.username, data.content, data.image]);
    return { status: 'success', id: id, time: nowStr };
  }

  var dataRange = sheet.getDataRange();
  var values = dataRange.getDisplayValues();
  var rowIndex = -1;

  // Tìm dòng cần sửa/xóa
  for (var i = values.length - 1; i >= 1; i--) {
    if (values[i][0] == data.id) { rowIndex = i + 1; break; }
  }

  if (rowIndex === -1) return { status: 'error', message: 'Not found' };

  if (type === 'update') {
    sheet.getRange(rowIndex, 4).setValue(data.content);
    if (data.image) sheet.getRange(rowIndex, 5).setValue(data.image);
    return { status: 'success' };
  }

  if (type === 'delete') {
    sheet.deleteRow(rowIndex);
    return { status: 'success' };
  }
}

function handleGetFeed(ss) {
  var feedSheet = ss.getSheetByName("feed");
  if (!feedSheet) return { status: 'success', data: [] };

  var profileSheet = ss.getSheetByName("profiles");
  var profileMap = {};
  if (profileSheet) {
    var pRows = profileSheet.getDataRange().getValues();
    for (var i = 1; i < pRows.length; i++) {
      var uName = String(pRows[i][1]).toLowerCase();
      profileMap[uName] = { fullname: pRows[i][2], avatar: pRows[i][4] };
    }
  }

  var rows = feedSheet.getDataRange().getDisplayValues();
  var posts = [];
  for (var i = rows.length - 1; i >= 1; i--) {
    if (rows[i][0]) {
      var uName = String(rows[i][2]).toLowerCase();
      var info = profileMap[uName] || {};
      posts.push({
        __backendId: rows[i][0],
        createdAt: rows[i][1],
        username: rows[i][2],
        fullname: info.fullname || rows[i][2],
        avatar: info.avatar || '',
        content: rows[i][3],
        imageData: rows[i][4],
        comments: '[]', likes: 0, liked: false
      });
    }
  }
  return { status: 'success', data: posts };
}

function handleGetProfileByUsername(ss, data) {
  var sheet = getSheet(ss, "profiles");
  var rows = sheet.getDataRange().getValues();
  for (var i = 1; i < rows.length; i++) {
    if (String(rows[i][1]).toLowerCase() == String(data.username).toLowerCase()) {
      return {
        status: 'success',
        data: {
          username: rows[i][1], fullname: rows[i][2],
          theme: rows[i][3], avaurl: rows[i][4]
        }
      };
    }
  }
  return { status: 'not_found' };
}

// --- UTILS ---
function getSheet(ss, name) {
  var sheet = ss.getSheetByName(name);
  if (!sheet) {
    sheet = ss.insertSheet(name);
    // Tạo header cơ bản nếu chưa có
    if (name === 'feed') sheet.appendRow(["ID", "Time", "Username", "Content", "Image"]);
    if (name === 'babyrun') sheet.appendRow(["ID", "Username", "Date", "Time"]);
    if (name === 'profiles') sheet.appendRow(["Fingerprint", "Username", "Fullname", "Theme", "Avatar", "Updated"]);
  }
  return sheet;
}

function responseJSON(data) {
  return ContentService.createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}
