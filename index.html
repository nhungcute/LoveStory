<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Love Story Dashboard - Quản Lý Kỷ Niệm</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
        }

        .sidebar {
            background: linear-gradient(180deg, #2d1b69 0%, #11998e 100%);
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            width: 256px;
        }



        .sidebar-text {
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .logo-text {
            transition: all 0.3s ease;
        }

        .sidebar-item {
            transition: all 0.3s ease;
            border-radius: 12px;
            margin: 4px 8px;
            display: flex;
            align-items: center;
        }

        .sidebar-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(8px);
        }

        .sidebar-item i {
            min-width: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .sidebar-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .header-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .widget-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .progress-ring {
            transform: rotate(-90deg);
        }

        .progress-ring-circle {
            transition: stroke-dashoffset 0.35s;
            transform-origin: 50% 50%;
        }

        .calendar-day {
            transition: all 0.3s ease;
            border-radius: 8px;
        }

        .calendar-day:hover {
            background: linear-gradient(135deg, #667eea, #764ba2);
            transform: scale(1.1);
        }

        .calendar-day.has-event {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .photo-item {
            transition: all 0.3s ease;
            border-radius: 12px;
            overflow: hidden;
        }

        .photo-item:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(240, 147, 251, 0.3);
        }

        .timeline-item {
            position: relative;
            padding-left: 2rem;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 2px;
            height: 100%;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
        }

        .timeline-item::after {
            content: '';
            position: absolute;
            left: -4px;
            top: 8px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .happiness-meter {
            background: conic-gradient(from 0deg, #ff6b6b 0%, #feca57 25%, #48dbfb 50%, #ff9ff3 75%, #54a0ff 100%);
            border-radius: 50%;
            padding: 4px;
        }

        .happiness-inner {
            background: #1a1a2e;
            border-radius: 50%;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            border-radius: 12px;
            padding: 12px 24px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-gradient:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            color: white;
        }

        .search-box {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .modal-dark {
            background: rgba(0, 0, 0, 0.8);
        }

        .modal-content-dark {
            background: linear-gradient(135deg, #2d1b69 0%, #11998e 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
        }

        .form-control-dark {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 8px;
        }

        .form-control-dark:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: #667eea;
            color: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .form-control-dark::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                width: 256px !important;
            }
            
            .sidebar.mobile-open {
                transform: translateX(0);
            }


        }

        .main-content {
            margin-left: 256px;
            transition: margin-left 0.3s ease;
        }



        @media (max-width: 768px) {
            .main-content {
                margin-left: 0 !important;
            }
        }

        .notification-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-slide-in {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Touch optimization for mobile */
        .touch-manipulation {
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        /* Ensure buttons are large enough for touch */
        @media (max-width: 768px) {
            button {
                min-height: 44px;
                min-width: 44px;
            }
        }
    </style>
</head>
<body class="text-white">
    <!-- Sidebar -->
    <div class="sidebar fixed left-0 top-0 h-full z-50" id="sidebar">
        <div class="p-6">
            <div class="flex items-center space-x-3 mb-8">
                <div class="w-10 h-10 bg-gradient-to-r from-pink-500 to-purple-600 rounded-full flex items-center justify-center">
                    <i class="fas fa-heart text-white"></i>
                </div>
                <h1 class="text-xl font-bold logo-text">Love Dashboard</h1>
            </div>
            
            <nav class="space-y-2">
                <a href="#" class="sidebar-item active flex items-center p-3 text-white" onclick="showSection('dashboard')">
                    <i class="fas fa-home w-5 mr-3"></i>
                    <span class="sidebar-text">Dashboard</span>
                </a>
                <a href="#" class="sidebar-item flex items-center p-3 text-white" onclick="showSection('calendar')">
                    <i class="fas fa-calendar w-5 mr-3"></i>
                    <span class="sidebar-text">Lịch Sự Kiện</span>
                </a>
                <a href="#" class="sidebar-item flex items-center p-3 text-white" onclick="showSection('memories')">
                    <i class="fas fa-images w-5 mr-3"></i>
                    <span class="sidebar-text">Kỷ Niệm</span>
                </a>
                <a href="#" class="sidebar-item flex items-center p-3 text-white" onclick="showSection('gallery')">
                    <i class="fas fa-camera w-5 mr-3"></i>
                    <span class="sidebar-text">Thư Viện Ảnh</span>
                </a>
                <a href="#" class="sidebar-item flex items-center p-3 text-white" onclick="showSection('timeline')">
                    <i class="fas fa-clock w-5 mr-3"></i>
                    <span class="sidebar-text">Timeline</span>
                </a>
                <a href="#" class="sidebar-item flex items-center p-3 text-white" onclick="showSection('analytics')">
                    <i class="fas fa-chart-bar w-5 mr-3"></i>
                    <span class="sidebar-text">Thống Kê</span>
                </a>
            </nav>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Header -->
        <header class="header-gradient p-4 flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <button class="md:hidden text-white p-2 hover:bg-white hover:bg-opacity-10 rounded-lg transition-all touch-manipulation" onclick="toggleSidebar()" style="min-width: 44px; min-height: 44px;">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                <h2 class="text-2xl font-bold hidden md:block" id="pageTitle">Dashboard</h2>
            </div>
            
            <div class="flex items-center space-x-2 md:space-x-4">
                <!-- Search Box - Desktop full, Mobile icon only -->
                <div class="relative">
                    <input type="text" placeholder="Tìm kiếm..." class="search-box px-4 py-2 text-white w-32 md:w-64 hidden md:block" id="desktopSearch">
                    <i class="fas fa-search absolute right-3 top-3 text-gray-300 hidden md:block"></i>
                    <!-- Mobile search icon -->
                    <button class="w-10 h-10 bg-white bg-opacity-10 rounded-full flex items-center justify-center hover:bg-opacity-20 transition-all md:hidden" onclick="toggleMobileSearch()">
                        <i class="fas fa-search text-white text-sm"></i>
                    </button>
                </div>
                
                <!-- Notification Icon -->
                <div class="relative">
                    <button class="w-10 h-10 bg-white bg-opacity-10 rounded-full flex items-center justify-center hover:bg-opacity-20 transition-all" onclick="toggleNotifications()">
                        <i class="fas fa-bell text-white text-sm"></i>
                        <span class="notification-badge">3</span>
                    </button>
                </div>
                
                <!-- Settings Icon -->
                <div class="relative">
                    <button class="w-10 h-10 bg-white bg-opacity-10 rounded-full flex items-center justify-center hover:bg-opacity-20 transition-all" onclick="toggleSettings()">
                        <i class="fas fa-cog text-white text-sm"></i>
                    </button>
                </div>
                
                <!-- User Icon -->
                <div class="w-10 h-10 bg-gradient-to-r from-pink-500 to-purple-600 rounded-full flex items-center justify-center cursor-pointer" onclick="toggleUserMenu()">
                    <i class="fas fa-user text-white text-sm"></i>
                </div>
            </div>
        </header>

        <!-- Notifications Dropdown -->
        <div id="notificationsDropdown" class="fixed top-16 right-4 w-80 widget-card p-4 z-50 hidden">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-semibold text-lg">Thông Báo</h3>
                <button onclick="toggleNotifications()" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-3">
                <div class="flex items-start space-x-3 p-3 bg-white bg-opacity-5 rounded-lg">
                    <div class="w-8 h-8 bg-gradient-to-r from-pink-500 to-purple-600 rounded-full flex items-center justify-center">
                        <i class="fas fa-heart text-white text-xs"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium">Kỷ niệm mới được thêm</p>
                        <p class="text-xs text-gray-400">5 phút trước</p>
                    </div>
                </div>
                <div class="flex items-start space-x-3 p-3 bg-white bg-opacity-5 rounded-lg">
                    <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-teal-600 rounded-full flex items-center justify-center">
                        <i class="fas fa-calendar text-white text-xs"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium">Sự kiện sắp tới: Ngày Valentine</p>
                        <p class="text-xs text-gray-400">1 giờ trước</p>
                    </div>
                </div>
                <div class="flex items-start space-x-3 p-3 bg-white bg-opacity-5 rounded-lg">
                    <div class="w-8 h-8 bg-gradient-to-r from-green-500 to-yellow-600 rounded-full flex items-center justify-center">
                        <i class="fas fa-camera text-white text-xs"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium">10 ảnh mới được tải lên</p>
                        <p class="text-xs text-gray-400">2 giờ trước</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Dropdown -->
        <div id="settingsDropdown" class="fixed top-16 right-4 w-80 widget-card p-4 z-50 hidden">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-semibold text-lg">Cài Đặt</h3>
                <button onclick="toggleSettings()" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-2">
                <button class="w-full text-left p-3 hover:bg-white hover:bg-opacity-10 rounded-lg transition-all">
                    <i class="fas fa-palette mr-3"></i>Giao diện
                </button>
                <button class="w-full text-left p-3 hover:bg-white hover:bg-opacity-10 rounded-lg transition-all">
                    <i class="fas fa-bell mr-3"></i>Thông báo
                </button>
                <button class="w-full text-left p-3 hover:bg-white hover:bg-opacity-10 rounded-lg transition-all">
                    <i class="fas fa-shield-alt mr-3"></i>Bảo mật
                </button>
                <button onclick="showGoogleDriveSync()" class="w-full text-left p-3 hover:bg-white hover:bg-opacity-10 rounded-lg transition-all">
                    <i class="fas fa-cloud-download-alt mr-3"></i>Đồng bộ Google Drive
                </button>
                <button class="w-full text-left p-3 hover:bg-white hover:bg-opacity-10 rounded-lg transition-all">
                    <i class="fas fa-download mr-3"></i>Sao lưu dữ liệu
                </button>
                <hr class="border-gray-600 my-2">
                <button class="w-full text-left p-3 hover:bg-white hover:bg-opacity-10 rounded-lg transition-all text-red-400">
                    <i class="fas fa-sign-out-alt mr-3"></i>Đăng xuất
                </button>
            </div>
        </div>

        <!-- Mobile Search Dropdown -->
        <div id="mobileSearchDropdown" class="fixed top-16 left-4 right-4 widget-card p-4 z-50 hidden md:hidden">
            <div class="flex items-center space-x-3">
                <div class="flex-1 relative">
                    <input type="text" placeholder="Tìm kiếm kỷ niệm, sự kiện..." class="search-box px-4 py-3 text-white w-full" id="mobileSearchInput">
                    <i class="fas fa-search absolute right-3 top-4 text-gray-300"></i>
                </div>
                <button onclick="toggleMobileSearch()" class="w-10 h-10 bg-white bg-opacity-10 rounded-full flex items-center justify-center hover:bg-opacity-20 transition-all">
                    <i class="fas fa-times text-white text-sm"></i>
                </button>
            </div>
        </div>

        <!-- User Menu Dropdown -->
        <div id="userMenuDropdown" class="fixed top-16 right-4 w-48 widget-card p-4 z-50 hidden">
            <div class="text-center mb-4">
                <div class="w-16 h-16 bg-gradient-to-r from-pink-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-2">
                    <i class="fas fa-user text-white text-xl"></i>
                </div>
                <p class="font-semibold">Couple Name</p>
                <p class="text-sm text-gray-400">couple@love.com</p>
            </div>
            <div class="space-y-2">
                <button class="w-full text-left p-2 hover:bg-white hover:bg-opacity-10 rounded-lg transition-all">
                    <i class="fas fa-user-edit mr-2"></i>Hồ sơ
                </button>
                <button class="w-full text-left p-2 hover:bg-white hover:bg-opacity-10 rounded-lg transition-all">
                    <i class="fas fa-heart mr-2"></i>Tài khoản đôi
                </button>
                <hr class="border-gray-600 my-2">
                <button class="w-full text-left p-2 hover:bg-white hover:bg-opacity-10 rounded-lg transition-all text-red-400">
                    <i class="fas fa-sign-out-alt mr-2"></i>Đăng xuất
                </button>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboardSection" class="p-6">
            <!-- Stats Widgets -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="widget-card p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-300 text-sm">Tổng Sự Kiện</p>
                            <p class="text-3xl font-bold text-white" id="totalEvents">24</p>
                        </div>
                        <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                            <i class="fas fa-calendar text-white"></i>
                        </div>
                    </div>
                </div>
                
                <div class="widget-card p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-300 text-sm">Ảnh Kỷ Niệm</p>
                            <p class="text-3xl font-bold text-white" id="totalPhotos">156</p>
                        </div>
                        <div class="w-12 h-12 bg-gradient-to-r from-pink-500 to-red-600 rounded-full flex items-center justify-center">
                            <i class="fas fa-images text-white"></i>
                        </div>
                    </div>
                </div>
                
                <div class="widget-card p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-300 text-sm">Ngày Bên Nhau</p>
                            <p class="text-3xl font-bold text-white" id="daysTogether">365</p>
                        </div>
                        <div class="w-12 h-12 bg-gradient-to-r from-green-500 to-teal-600 rounded-full flex items-center justify-center">
                            <i class="fas fa-heart text-white"></i>
                        </div>
                    </div>
                </div>
                
                <div class="widget-card p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-300 text-sm">Mức Hạnh Phúc</p>
                            <p class="text-3xl font-bold text-white">98%</p>
                        </div>
                        <div class="happiness-meter w-12 h-12">
                            <div class="happiness-inner">
                                <i class="fas fa-smile text-yellow-400"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Progress Rings -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="widget-card p-6 text-center">
                    <h3 class="text-lg font-semibold mb-4">Mục Tiêu Năm</h3>
                    <div class="relative w-32 h-32 mx-auto">
                        <svg class="progress-ring w-32 h-32">
                            <circle cx="64" cy="64" r="56" stroke="rgba(255,255,255,0.1)" stroke-width="8" fill="transparent"/>
                            <circle cx="64" cy="64" r="56" stroke="url(#gradient1)" stroke-width="8" fill="transparent" 
                                    stroke-dasharray="351.86" stroke-dashoffset="87.97" class="progress-ring-circle"/>
                            <defs>
                                <linearGradient id="gradient1" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:#667eea"/>
                                    <stop offset="100%" style="stop-color:#764ba2"/>
                                </linearGradient>
                            </defs>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span class="text-2xl font-bold">75%</span>
                        </div>
                    </div>
                    <p class="text-gray-300 mt-2">Hoàn thành mục tiêu</p>
                </div>
                
                <div class="widget-card p-6 text-center">
                    <h3 class="text-lg font-semibold mb-4">Hoạt Động Tháng</h3>
                    <div class="relative w-32 h-32 mx-auto">
                        <svg class="progress-ring w-32 h-32">
                            <circle cx="64" cy="64" r="56" stroke="rgba(255,255,255,0.1)" stroke-width="8" fill="transparent"/>
                            <circle cx="64" cy="64" r="56" stroke="url(#gradient2)" stroke-width="8" fill="transparent" 
                                    stroke-dasharray="351.86" stroke-dashoffset="105.56" class="progress-ring-circle"/>
                            <defs>
                                <linearGradient id="gradient2" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:#f093fb"/>
                                    <stop offset="100%" style="stop-color:#f5576c"/>
                                </linearGradient>
                            </defs>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span class="text-2xl font-bold">70%</span>
                        </div>
                    </div>
                    <p class="text-gray-300 mt-2">Hoạt động trong tháng</p>
                </div>
                
                <div class="widget-card p-6 text-center">
                    <h3 class="text-lg font-semibold mb-4">Kỷ Niệm Mới</h3>
                    <div class="relative w-32 h-32 mx-auto">
                        <svg class="progress-ring w-32 h-32">
                            <circle cx="64" cy="64" r="56" stroke="rgba(255,255,255,0.1)" stroke-width="8" fill="transparent"/>
                            <circle cx="64" cy="64" r="56" stroke="url(#gradient3)" stroke-width="8" fill="transparent" 
                                    stroke-dasharray="351.86" stroke-dashoffset="70.37" class="progress-ring-circle"/>
                            <defs>
                                <linearGradient id="gradient3" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:#4facfe"/>
                                    <stop offset="100%" style="stop-color:#00f2fe"/>
                                </linearGradient>
                            </defs>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span class="text-2xl font-bold">80%</span>
                        </div>
                    </div>
                    <p class="text-gray-300 mt-2">Kỷ niệm được thêm</p>
                </div>
            </div>

            <!-- Recent Activities -->
            <div class="widget-card p-6">
                <h3 class="text-xl font-semibold mb-4">Hoạt Động Gần Đây</h3>
                <div class="space-y-4">
                    <div class="flex items-center space-x-4 p-3 bg-white bg-opacity-5 rounded-lg">
                        <div class="w-10 h-10 bg-gradient-to-r from-pink-500 to-purple-600 rounded-full flex items-center justify-center">
                            <i class="fas fa-heart text-white text-sm"></i>
                        </div>
                        <div class="flex-1">
                            <p class="font-medium">Thêm sự kiện mới: "Ngày kỷ niệm 1 năm"</p>
                            <p class="text-gray-400 text-sm">2 giờ trước</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4 p-3 bg-white bg-opacity-5 rounded-lg">
                        <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-teal-600 rounded-full flex items-center justify-center">
                            <i class="fas fa-camera text-white text-sm"></i>
                        </div>
                        <div class="flex-1">
                            <p class="font-medium">Tải lên 5 ảnh mới vào thư viện</p>
                            <p class="text-gray-400 text-sm">1 ngày trước</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4 p-3 bg-white bg-opacity-5 rounded-lg">
                        <div class="w-10 h-10 bg-gradient-to-r from-green-500 to-yellow-600 rounded-full flex items-center justify-center">
                            <i class="fas fa-comment text-white text-sm"></i>
                        </div>
                        <div class="flex-1">
                            <p class="font-medium">Thêm bình luận cho ảnh "Chuyến đi Đà Lạt"</p>
                            <p class="text-gray-400 text-sm">3 ngày trước</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calendar Section -->
        <div id="calendarSection" class="p-6" style="display: none;">
            <div class="widget-card p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold">Lịch Sự Kiện</h3>
                    <div class="flex space-x-2">
                        <button class="btn-gradient" onclick="previousMonth()">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button class="btn-gradient" onclick="nextMonth()">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                
                <div class="text-center mb-6">
                    <h4 class="text-xl font-semibold" id="calendarMonth"></h4>
                </div>
                
                <div class="grid grid-cols-7 gap-2 mb-4">
                    <div class="text-center font-semibold text-gray-300 py-2">CN</div>
                    <div class="text-center font-semibold text-gray-300 py-2">T2</div>
                    <div class="text-center font-semibold text-gray-300 py-2">T3</div>
                    <div class="text-center font-semibold text-gray-300 py-2">T4</div>
                    <div class="text-center font-semibold text-gray-300 py-2">T5</div>
                    <div class="text-center font-semibold text-gray-300 py-2">T6</div>
                    <div class="text-center font-semibold text-gray-300 py-2">T7</div>
                </div>
                
                <div class="grid grid-cols-7 gap-2" id="calendarDays"></div>
            </div>
        </div>

        <!-- Memories Section -->
        <div id="memoriesSection" class="p-6" style="display: none;">
            <div class="widget-card p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold">Quản Lý Kỷ Niệm</h3>
                    <button class="btn-gradient" onclick="showAddMemoryModal()">
                        <i class="fas fa-plus mr-2"></i>Thêm Kỷ Niệm
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="memoriesList">
                    <!-- Memories will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Gallery Section -->
        <div id="gallerySection" class="p-6" style="display: none;">
            <div class="widget-card p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold">Thư Viện Ảnh</h3>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id="photoGallery">
                    <!-- Photos will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Timeline Section -->
        <div id="timelineSection" class="p-6" style="display: none;">
            <div class="widget-card p-6">
                <h3 class="text-2xl font-bold mb-6">Timeline Kỷ Niệm</h3>
                
                <div class="space-y-6" id="timelineList">
                    <!-- Timeline items will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Analytics Section -->
        <div id="analyticsSection" class="p-6" style="display: none;">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="widget-card p-6">
                    <h3 class="text-xl font-semibold mb-4">Thống Kê Hoạt Động</h3>
                    <canvas id="activityChart" width="400" height="200"></canvas>
                </div>
                
                <div class="widget-card p-6">
                    <h3 class="text-xl font-semibold mb-4">Phân Bố Sự Kiện</h3>
                    <canvas id="eventChart" width="400" height="200"></canvas>
                </div>
                
                <div class="widget-card p-6 lg:col-span-2">
                    <h3 class="text-xl font-semibold mb-4">Mức Độ Hạnh Phúc Theo Thời Gian</h3>
                    <canvas id="happinessChart" width="800" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Memory Modal -->
    <div id="addMemoryModal" class="fixed inset-0 modal-dark z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="modal-content-dark p-6 w-full max-w-md">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">Thêm Kỷ Niệm Mới</h3>
                    <button onclick="closeModal('addMemoryModal')" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <form id="memoryForm">
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">Tiêu đề</label>
                        <input type="text" id="memoryTitle" class="form-control-dark w-full p-3" placeholder="Nhập tiêu đề kỷ niệm">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">Ngày</label>
                        <input type="date" id="memoryDate" class="form-control-dark w-full p-3">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">Mô tả</label>
                        <textarea id="memoryDescription" class="form-control-dark w-full p-3 h-24" placeholder="Mô tả chi tiết về kỷ niệm"></textarea>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium mb-2">Loại sự kiện</label>
                        <select id="memoryType" class="form-control-dark w-full p-3">
                            <option value="anniversary">Kỷ niệm</option>
                            <option value="date">Hẹn hò</option>
                            <option value="travel">Du lịch</option>
                            <option value="special">Đặc biệt</option>
                        </select>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button type="button" onclick="closeModal('addMemoryModal')" class="flex-1 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                            Hủy
                        </button>
                        <button type="submit" class="flex-1 btn-gradient">
                            Thêm Kỷ Niệm
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Google Drive Sync Modal -->
    <div id="googleDriveSyncModal" class="fixed inset-0 modal-dark z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="modal-content-dark p-6 w-full max-w-4xl max-h-full overflow-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">Đồng Bộ Google Drive</h3>
                    <button onclick="closeModal('googleDriveSyncModal')" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="mb-6">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">
                        <div class="bg-white bg-opacity-5 rounded-lg p-4">
                            <h4 class="font-semibold mb-2">Cấu hình hiện tại</h4>
                            <div class="space-y-2 text-sm">
                                <p><span class="text-gray-400">Folder ID:</span> <span id="currentFolderId" class="font-mono text-xs">Chưa cấu hình</span></p>
                                <p><span class="text-gray-400">API Key:</span> <span id="currentApiKey" class="font-mono text-xs">Chưa cấu hình</span></p>
                                <p><span class="text-gray-400">GitHub Repo:</span> <span id="currentRepo" class="font-mono text-xs">Chưa cấu hình</span></p>
                            </div>
                        </div>
                        
                        <div class="bg-white bg-opacity-5 rounded-lg p-4">
                            <h4 class="font-semibold mb-2">Thống kê</h4>
                            <div class="space-y-2 text-sm">
                                <p><span class="text-gray-400">Ảnh hiện tại:</span> <span id="currentPhotosCount">0</span></p>
                                <p><span class="text-gray-400">Lần sync cuối:</span> <span id="lastSyncTime">Chưa có</span></p>
                                <p><span class="text-gray-400">Trạng thái:</span> <span id="syncStatus" class="text-green-400">Sẵn sàng</span></p>
                            </div>
                        </div>

                        <div class="bg-white bg-opacity-5 rounded-lg p-4">
                            <h4 class="font-semibold mb-3 flex items-center">
                                <i class="fas fa-sync-alt mr-2 text-blue-400"></i>
                                Đồng bộ tự động
                            </h4>
                            
                            <!-- Status Display -->
                            <div id="autoSyncStatus" class="mb-4 p-3 bg-white bg-opacity-10 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium">Trạng thái:</span>
                                    <span class="text-gray-400">⚫ Đã tắt</span>
                                </div>
                            </div>
                            
                            <!-- Schedule Configuration -->
                            <div class="space-y-4">
                                <!-- Frequency Selection -->
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-gray-300">
                                        <i class="fas fa-clock mr-1"></i>
                                        Tần suất đồng bộ:
                                    </label>
                                    <select id="autoSyncFrequency" onchange="updateAutoSyncFrequency()" class="form-control-dark px-3 py-2 w-full text-sm" style="background-color: rgba(255, 255, 255, 0.1); color: white;">
                                        <option value="hourly" style="background-color: #2d1b69; color: white;">🕐 Mỗi giờ (liên tục)</option>
                                        <option value="daily" style="background-color: #2d1b69; color: white;">📅 Hàng ngày (cùng giờ)</option>
                                        <option value="weekly" style="background-color: #2d1b69; color: white;">📆 Hàng tuần (cùng ngày giờ)</option>
                                    </select>
                                </div>
                                
                                <!-- Time Selection -->
                                <div id="timeScheduleContainer" class="hidden">
                                    <label class="block text-sm font-medium mb-2 text-gray-300">
                                        <i class="fas fa-clock mr-1"></i>
                                        Giờ chạy:
                                    </label>
                                    <div class="flex items-center space-x-2">
                                        <input type="time" id="autoSyncTime" onchange="updateAutoSyncTime()" class="form-control-dark px-3 py-2 flex-1 text-sm" value="02:00">
                                    </div>
                                </div>
                                
                                <!-- Toggle Button -->
                                <button id="autoSyncToggle" onclick="toggleAutoSync()" class="w-full px-4 py-3 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 rounded-lg text-white font-medium transition-all duration-200 shadow-lg">
                                    <i class="fas fa-power-off mr-2"></i>
                                    Bật Tự Động
                                </button>
                                
                                <!-- Schedule Info -->
                                <div class="bg-white bg-opacity-5 rounded-lg p-3 space-y-2">
                                    <div class="flex items-center justify-between text-xs">
                                        <span class="text-gray-400">
                                            <i class="fas fa-history mr-1"></i>
                                            Lần chạy cuối:
                                        </span>
                                        <span id="lastAutoSyncTime" class="text-gray-300">Chưa chạy</span>
                                    </div>
                                    <div id="nextRunTime" class="flex items-center justify-between text-xs hidden">
                                        <span class="text-gray-400">
                                            <i class="fas fa-clock mr-1"></i>
                                            Lần chạy tiếp:
                                        </span>
                                        <span id="nextRunTimeValue" class="text-blue-400 font-medium">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="syncProgress" class="mb-4 hidden">
                    <div class="bg-white bg-opacity-5 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-semibold">Đang đồng bộ...</span>
                            <span id="syncProgressPercent">0%</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2 mb-2">
                            <div id="syncProgressBar" class="bg-gradient-to-r from-blue-500 to-purple-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <p id="syncProgressText" class="text-sm text-gray-400">Chuẩn bị đồng bộ...</p>
                    </div>
                </div>
                
                <div id="syncResults" class="mb-4 hidden">
                    <div class="bg-green-500 bg-opacity-20 border border-green-500 rounded-lg p-4">
                        <div class="flex items-start space-x-3">
                            <i class="fas fa-check-circle text-green-400 mt-1"></i>
                            <div>
                                <h4 class="font-semibold text-green-300 mb-2">Đồng bộ thành công!</h4>
                                <div id="syncResultsContent" class="text-sm text-green-200"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Auto Sync Logs -->
                <div class="mb-4">
                    <div class="bg-white bg-opacity-5 rounded-lg p-4">
                        <h4 class="font-semibold mb-3 flex items-center">
                            <i class="fas fa-history mr-2"></i>
                            Lịch sử đồng bộ tự động
                        </h4>
                        <div id="autoSyncLogs" class="space-y-2 max-h-40 overflow-y-auto">
                            <p class="text-gray-400 text-sm">Chưa có log nào</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex space-x-3">
                    <button type="button" onclick="closeModal('googleDriveSyncModal')" class="flex-1 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                        Đóng
                    </button>
                    <button id="startSyncBtn" onclick="startGoogleDriveSync()" class="flex-1 btn-gradient">
                        <i class="fas fa-sync mr-2"></i>Đồng Bộ Thủ Công
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentDate = new Date();
        let memories = JSON.parse(localStorage.getItem('memories')) || [];
        let photos = JSON.parse(localStorage.getItem('photos')) || [];
        
        // Auto Sync variables
        let autoSyncInterval = null;
        let autoSyncTimeout = null;
        
        // Photo gallery variables
        let currentPage = 1;
        let totalPages = 1;
        let allPhotosData = [];
        let commentsData = {};
        let reactionsData = {};
        let isLoadingPhotos = false;
        
        // Photo modal variables - khởi tạo sớm
        let currentPhotoIndex = 0;
        let modalPhotos = [];
        

        
        // Biến cấu hình toàn cục
        let CONFIG = {};
        let GITHUB_USERNAME, REPO_NAME, PAT, FILE_PATH, COMMENTS_FILE_PATH, PHOTOS_METADATA_FILE_PATH, LOGS_FILE_PATH;
        let API_BASE_URL, COMMENTS_API_URL, PHOTOS_METADATA_API_URL, LOGS_API_URL;
        let FOLDER_ID, API_KEY, PHOTOS_PER_PAGE;
        let CONFIG_API_URL;
        
        // Hàm hiển thị thông báo
        function showMessage(message, type = 'info') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm animate-fade-in`;
            
            switch(type) {
                case 'error':
                    messageDiv.className += ' bg-red-500 text-white';
                    break;
                case 'warning':
                    messageDiv.className += ' bg-yellow-500 text-black';
                    break;
                case 'success':
                    messageDiv.className += ' bg-green-500 text-white';
                    break;
                default:
                    messageDiv.className += ' bg-blue-500 text-white';
            }
            
            messageDiv.innerHTML = `
                <div class="flex items-center justify-between">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-lg">&times;</button>
                </div>
            `;
            
            document.body.appendChild(messageDiv);
            
            // Tự động ẩn sau 5 giây
            setTimeout(() => {
                if (messageDiv.parentElement) {
                    messageDiv.remove();
                }
            }, 5000);
        }
        
        async function loadConfig() {
            try {
                console.log('🔧 Sử dụng cấu hình demo tích hợp sẵn');
                
                CONFIG = {
                    "GITHUB_USERNAME": "nhungcute",
                    "REPO_NAME": "LoveStory",
                    "PAT1": "ghp_a8VLpoCYQByLbUIwe",
                    "PAT2": "d3dy4hHjEpKwr3stE6T",
                    "FILE_PATH": "actions.json",
                    "COMMENTS_FILE_PATH": "comments.json",
                    "PHOTOS_METADATA_FILE_PATH": "image_data.json",
                    "LOGS_FILE_PATH": "logs.json",
                    "FOLDER_ID": "1B_tpWbLwlc7mqT789-g2RO9K2pYNXVav",
                    "API_KEY": "AIzaSyDJddlVwOWA8vzdVNrcp70if4eOL30xjp0",
                    "PHOTOS_PER_PAGE": 50,
                    "AUTO_LOAD_METADATA": "true"
                };
                
                console.log('✅ Đã tải cấu hình demo thành công');
            } catch (error) {
                console.error('❌ Lỗi khởi tạo cấu hình:', error);
                throw error;
            }
            
            // Thiết lập các biến từ CONFIG
            GITHUB_USERNAME = CONFIG.GITHUB_USERNAME;
            REPO_NAME = CONFIG.REPO_NAME;
            PAT = CONFIG.PAT1 + CONFIG.PAT2;
            FILE_PATH = CONFIG.FILE_PATH;
            COMMENTS_FILE_PATH = CONFIG.COMMENTS_FILE_PATH;
            PHOTOS_METADATA_FILE_PATH = CONFIG.PHOTOS_METADATA_FILE_PATH;
            LOGS_FILE_PATH = CONFIG.LOGS_FILE_PATH;
            
            // Thiết lập các URL API
            API_BASE_URL = `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${FILE_PATH}`;
            COMMENTS_API_URL = `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${COMMENTS_FILE_PATH}`;
            PHOTOS_METADATA_API_URL = `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${PHOTOS_METADATA_FILE_PATH}`;
            LOGS_API_URL = `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${LOGS_FILE_PATH}`;
            CONFIG_API_URL = `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/configApp.json`;
            
            // Cấu hình Google Drive API
            FOLDER_ID = CONFIG.FOLDER_ID;
            API_KEY = CONFIG.API_KEY;
            PHOTOS_PER_PAGE = CONFIG.PHOTOS_PER_PAGE;
            
            return true;
        }
        
        // Sample data if empty
        if (memories.length === 0) {
            memories = [
                {
                    id: 1,
                    title: "Ngày đầu gặp nhau",
                    date: "2023-02-14",
                    description: "Ngày đầu tiên chúng ta gặp nhau tại quán cà phê",
                    type: "special"
                },
                {
                    id: 2,
                    title: "Chuyến đi Đà Lạt",
                    date: "2023-05-20",
                    description: "Chuyến du lịch đầu tiên cùng nhau",
                    type: "travel"
                }
            ];
            localStorage.setItem('memories', JSON.stringify(memories));
        }

        // Initialize app with iframe safety checks
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Check if we're in a safe iframe environment
                const isSafeEnvironment = checkIframeSafety();
                
                // Hiển thị loading state
                showMessage('🔄 Đang khởi tạo ứng dụng...', 'info');
                
                await loadConfig();
                
                // Tải cấu hình auto sync từ GitHub với error handling
                try {
                    const autoSyncConfig = await loadAutoSyncConfigFromGitHub();
                    if (autoSyncConfig) {
                        console.log('📥 Đã tải cấu hình Auto Sync từ GitHub:', autoSyncConfig);
                    }
                } catch (error) {
                    console.warn('⚠️ Không thể tải cấu hình Auto Sync từ GitHub:', error.message);
                }
                
                // Khởi tạo các thành phần cơ bản trước
                updateStats();
                renderCalendar();
                renderMemories();
                renderTimeline();
                
                // Initialize charts with error handling
                try {
                    initCharts();
                } catch (chartError) {
                    console.warn('⚠️ Không thể khởi tạo biểu đồ:', chartError);
                }
                
                // Khởi tạo đồng bộ tự động nếu đã được bật và môi trường an toàn
                if (isSafeEnvironment) {
                    const schedule = getAutoSyncSchedule();
                    if (schedule.enabled) {
                        setupAutoSync();
                        console.log('🔄 Đã khởi tạo đồng bộ tự động từ cấu hình:', schedule);
                    }
                }
                
                // Load gallery sau cùng để tránh block UI
                setTimeout(() => {
                    try {
                        renderGallery();
                    } catch (galleryError) {
                        console.warn('⚠️ Lỗi tải gallery:', galleryError);
                        showSampleGallery();
                    }
                }, 500);
                
                showMessage('✅ Ứng dụng đã sẵn sàng!', 'success');
            } catch (error) {
                console.error('Lỗi khởi tạo:', error);
                showMessage('⚠️ Ứng dụng chạy ở chế độ demo', 'warning');
                
                // Vẫn khởi tạo các thành phần cơ bản
                safeInitialization();
            }
        });

        // Check iframe safety
        function checkIframeSafety() {
            try {
                // Check if we can access parent window safely
                if (window.parent && window.parent !== window) {
                    // We're in an iframe
                    try {
                        // Test access to parent
                        const parentOrigin = window.parent.location.origin;
                        return true;
                    } catch (e) {
                        // Cross-origin iframe, limited access
                        console.log('🔒 Cross-origin iframe detected, using safe mode');
                        return false;
                    }
                }
                return true;
            } catch (error) {
                console.warn('⚠️ Iframe safety check failed:', error);
                return false;
            }
        }

        // Safe initialization fallback
        function safeInitialization() {
            try {
                updateStats();
                renderCalendar();
                renderMemories();
                renderTimeline();
                
                // Try charts with fallback
                try {
                    initCharts();
                } catch (e) {
                    console.warn('Charts disabled in safe mode');
                }
                
                // Show sample gallery
                showSampleGallery();
            } catch (error) {
                console.error('Safe initialization failed:', error);
            }
        }

        // Show sample gallery when main gallery fails
        function showSampleGallery() {
            const photosGrid = document.getElementById('photoGallery');
            if (!photosGrid) return;
            
            photosGrid.innerHTML = `
                <div class="col-span-full text-center py-12">
                    <i class="fas fa-images text-6xl text-blue-400 mb-4"></i>
                    <h3 class="text-xl font-semibold mb-2">Chế độ Demo</h3>
                    <p class="text-gray-400 mb-4">Ứng dụng đang chạy ở chế độ demo với dữ liệu mẫu</p>
                    <button onclick="showGoogleDriveSync()" class="btn-gradient">
                        <i class="fas fa-sync mr-2"></i>Cấu hình đồng bộ
                    </button>
                </div>
            `;
        }

        // Navigation functions
        function showSection(sectionName) {
            // Hide all sections
            const sections = ['dashboard', 'calendar', 'memories', 'gallery', 'timeline', 'analytics'];
            sections.forEach(section => {
                document.getElementById(section + 'Section').style.display = 'none';
            });
            
            // Show selected section
            document.getElementById(sectionName + 'Section').style.display = 'block';
            
            // Update active sidebar item
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.sidebar-item').classList.add('active');
            
            // Update page title
            const titles = {
                dashboard: 'Dashboard',
                calendar: 'Lịch Sự Kiện',
                memories: 'Quản Lý Kỷ Niệm',
                gallery: 'Thư Viện Ảnh',
                timeline: 'Timeline',
                analytics: 'Thống Kê'
            };
            document.getElementById('pageTitle').textContent = titles[sectionName];
            
            // Log navigation - disabled
            // addLog('Chuyển trang', {
            //     from_section: document.querySelector('.sidebar-item.active')?.textContent?.trim() || 'unknown',
            //     to_section: sectionName,
            //     section_title: titles[sectionName]
            // });
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
                sidebar.classList.toggle('mobile-open');
                console.log('🍔 Toggle sidebar:', sidebar.classList.contains('mobile-open') ? 'Mở' : 'Đóng');
            }
        }

        // Toggle functions for dropdowns - defined first
        function toggleNotifications() {
            const dropdown = document.getElementById('notificationsDropdown');
            const settingsDropdown = document.getElementById('settingsDropdown');
            const userDropdown = document.getElementById('userMenuDropdown');
            const mobileSearchDropdown = document.getElementById('mobileSearchDropdown');
            
            // Close other dropdowns
            settingsDropdown.classList.add('hidden');
            userDropdown.classList.add('hidden');
            mobileSearchDropdown.classList.add('hidden');
            
            dropdown.classList.toggle('hidden');
        }

        function toggleSettings() {
            const dropdown = document.getElementById('settingsDropdown');
            const notificationsDropdown = document.getElementById('notificationsDropdown');
            const userDropdown = document.getElementById('userMenuDropdown');
            const mobileSearchDropdown = document.getElementById('mobileSearchDropdown');
            
            // Close other dropdowns
            notificationsDropdown.classList.add('hidden');
            userDropdown.classList.add('hidden');
            mobileSearchDropdown.classList.add('hidden');
            
            dropdown.classList.toggle('hidden');
        }

        function toggleUserMenu() {
            const dropdown = document.getElementById('userMenuDropdown');
            const notificationsDropdown = document.getElementById('notificationsDropdown');
            const settingsDropdown = document.getElementById('settingsDropdown');
            const mobileSearchDropdown = document.getElementById('mobileSearchDropdown');
            
            // Close other dropdowns
            notificationsDropdown.classList.add('hidden');
            settingsDropdown.classList.add('hidden');
            mobileSearchDropdown.classList.add('hidden');
            
            dropdown.classList.toggle('hidden');
        }

        function toggleMobileSearch() {
            const dropdown = document.getElementById('mobileSearchDropdown');
            const notificationsDropdown = document.getElementById('notificationsDropdown');
            const settingsDropdown = document.getElementById('settingsDropdown');
            const userDropdown = document.getElementById('userMenuDropdown');
            
            // Close other dropdowns
            notificationsDropdown.classList.add('hidden');
            settingsDropdown.classList.add('hidden');
            userDropdown.classList.add('hidden');
            
            dropdown.classList.toggle('hidden');
            
            // Focus on search input when opened
            if (!dropdown.classList.contains('hidden')) {
                setTimeout(() => {
                    document.getElementById('mobileSearchInput').focus();
                }, 100);
            }
        }

        // Photo upload modal function - define early
        function showAddPhotoModal() {
            // Create modal if it doesn't exist
            let modal = document.getElementById('addPhotoModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'addPhotoModal';
                modal.className = 'fixed inset-0 modal-dark z-50 hidden';
                modal.innerHTML = `
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="modal-content-dark p-6 w-full max-w-md">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold">Tải Ảnh Lên</h3>
                                <button onclick="closeModal('addPhotoModal')" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            
                            <div class="text-center py-8">
                                <i class="fas fa-cloud-upload-alt text-6xl text-blue-400 mb-4"></i>
                                <h4 class="text-lg font-semibold mb-2">Tính năng đang phát triển</h4>
                                <p class="text-gray-400 mb-4">Hiện tại bạn có thể sử dụng chức năng "Đồng bộ Google Drive" để tải ảnh từ Google Drive.</p>
                                <button onclick="closeModal('addPhotoModal'); showGoogleDriveSync();" class="btn-gradient">
                                    <i class="fas fa-sync mr-2"></i>Đồng bộ từ Google Drive
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            modal.classList.remove('hidden');
        }

        // Share current photo in modal
        function shareCurrentPhoto() {
            const photo = modalPhotos[currentPhotoIndex];
            if (photo) {
                sharePhoto(photo.id);
            }
        }

        // Make all functions globally available immediately
        window.toggleNotifications = toggleNotifications;
        window.toggleSettings = toggleSettings;
        window.toggleUserMenu = toggleUserMenu;
        window.toggleMobileSearch = toggleMobileSearch;
        window.showSection = showSection;
        window.toggleSidebar = toggleSidebar;
        window.showAddMemoryModal = showAddMemoryModal;
        window.closeModal = closeModal;
        window.addMemory = addMemory;
        window.deleteMemory = deleteMemory;
        window.editMemory = editMemory;
        window.previousMonth = previousMonth;
        window.nextMonth = nextMonth;
        window.showAddPhotoModal = showAddPhotoModal;
        window.showGoogleDriveSync = showGoogleDriveSync;
        window.startGoogleDriveSync = startGoogleDriveSync;
        window.changePhotoPage = changePhotoPage;
        window.likePhoto = likePhoto;
        window.sharePhoto = sharePhoto;
        window.shareCurrentPhoto = shareCurrentPhoto;
        window.openPhotoModal = openPhotoModal;
        window.closePhotoModal = closePhotoModal;
        window.previousPhoto = previousPhoto;
        window.nextPhoto = nextPhoto;
        window.downloadPhoto = downloadPhoto;
        window.updateModalLikes = updateModalLikes;
        window.toggleAutoSync = toggleAutoSync;
        window.updateAutoSyncFrequency = updateAutoSyncFrequency;
        window.updateAutoSyncTime = updateAutoSyncTime;
        window.addComment = addComment;
        window.toggleCommentsSection = toggleCommentsSection;
        window.togglePhotoInfo = togglePhotoInfo;
        window.closeShareModal = closeShareModal;
        window.copyShareUrl = copyShareUrl;
        window.shareViaWhatsApp = shareViaWhatsApp;
        window.shareViaFacebook = shareViaFacebook;
        window.shareViaTwitter = shareViaTwitter;
        window.shareViaEmail = shareViaEmail;



        // Modal functions
        function showAddModal() {
            document.getElementById('addMemoryModal').classList.remove('hidden');
        }

        function showAddMemoryModal() {
            document.getElementById('addMemoryModal').classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // Memory management
        function addMemory(event) {
            event.preventDefault();
            
            const memory = {
                id: Date.now(),
                title: document.getElementById('memoryTitle').value,
                date: document.getElementById('memoryDate').value,
                description: document.getElementById('memoryDescription').value,
                type: document.getElementById('memoryType').value
            };
            
            memories.push(memory);
            localStorage.setItem('memories', JSON.stringify(memories));
            
            // Log thêm kỷ niệm - disabled
            // addLog('Thêm kỷ niệm', {
            //     memory_id: memory.id,
            //     memory_title: memory.title,
            //     memory_type: memory.type,
            //     memory_date: memory.date
            // });
            
            renderMemories();
            renderTimeline();
            updateStats();
            closeModal('addMemoryModal');
            
            // Reset form
            document.getElementById('memoryForm').reset();
        }

        function deleteMemory(id) {
            if (confirm('Bạn có chắc chắn muốn xóa kỷ niệm này?')) {
                const memory = memories.find(m => m.id === id);
                memories = memories.filter(memory => memory.id !== id);
                localStorage.setItem('memories', JSON.stringify(memories));
                
                // Log xóa kỷ niệm - disabled
                // addLog('Xóa kỷ niệm', {
                //     memory_id: id,
                //     memory_title: memory?.title || 'Unknown',
                //     memory_type: memory?.type || 'Unknown'
                // });
                
                renderMemories();
                renderTimeline();
                updateStats();
            }
        }

        function editMemory(id) {
            const memory = memories.find(m => m.id === id);
            if (memory) {
                document.getElementById('memoryTitle').value = memory.title;
                document.getElementById('memoryDate').value = memory.date;
                document.getElementById('memoryDescription').value = memory.description;
                document.getElementById('memoryType').value = memory.type;
                
                // Log chỉnh sửa kỷ niệm - disabled
                // addLog('Chỉnh sửa kỷ niệm', {
                //     memory_id: id,
                //     memory_title: memory.title,
                //     memory_type: memory.type
                // });
                
                // Remove old memory and show modal
                deleteMemory(id);
                showAddMemoryModal();
            }
        }

        // Render functions
        function renderMemories() {
            const memoriesList = document.getElementById('memoriesList');
            memoriesList.innerHTML = '';
            
            memories.forEach(memory => {
                const memoryCard = document.createElement('div');
                memoryCard.className = 'widget-card p-4 animate-fade-in';
                memoryCard.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <h4 class="font-semibold text-lg">${memory.title}</h4>
                        <div class="flex space-x-2">
                            <button onclick="editMemory(${memory.id})" class="text-blue-400 hover:text-blue-300">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteMemory(${memory.id})" class="text-red-400 hover:text-red-300">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <p class="text-gray-300 text-sm mb-2">${formatDate(memory.date)}</p>
                    <p class="text-gray-400 text-sm mb-3">${memory.description}</p>
                    <span class="inline-block px-3 py-1 bg-gradient-to-r from-pink-500 to-purple-600 rounded-full text-xs">
                        ${getTypeLabel(memory.type)}
                    </span>
                `;
                memoriesList.appendChild(memoryCard);
            });
        }



        // Base64 decode function with Unicode support
        function base64Decode(str) {
            try {
                // Fix Unicode decoding issue by using proper Base64 to UTF-8 conversion
                return decodeURIComponent(escape(atob(str)));
            } catch (e) {
                console.error('Base64 decode error:', e);
                return '';
            }
        }

        async function loadPhotosMetadataFromGitHub() {
            try {
                // CHỈ tải từ GitHub metadata file
                if (!GITHUB_USERNAME || !REPO_NAME || !PAT || PAT.length < 10) {
                    console.log('❌ Không có cấu hình GitHub hợp lệ');
                    throw new Error('Thiếu cấu hình GitHub để tải metadata');
                }

                console.log('📂 Đang tải metadata từ GitHub...');
                
                // Wrap fetch in safe async operation
                const response = await safeAsyncOperation(async () => {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000);
                    
                    const fetchResponse = await fetch(PHOTOS_METADATA_API_URL, {
                        headers: {
                            'Authorization': `token ${PAT}`,
                            'Accept': 'application/vnd.github.v3+json'
                        },
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    return fetchResponse;
                }, 'GitHub metadata fetch');
                
                if (response.ok) {
                    const data = await response.json();
                    const content = JSON.parse(base64Decode(data.content));
                    
                    if (Array.isArray(content) && content.length > 0) {
                        console.log(`✅ Đã tải ${content.length} ảnh từ GitHub metadata file`);
                        return content;
                    } else {
                        console.log('📂 File metadata trống trên GitHub');
                        throw new Error('File metadata trống trên GitHub');
                    }
                } else if (response.status === 404) {
                    console.log('📂 File metadata chưa tồn tại trên GitHub');
                    throw new Error('File metadata chưa tồn tại trên GitHub');
                } else {
                    console.warn(`⚠️ Lỗi tải metadata từ GitHub: ${response.status}`);
                    throw new Error(`Lỗi tải metadata từ GitHub: ${response.status}`);
                }
                
            } catch (error) {
                console.error('❌ Lỗi khi tải metadata từ GitHub:', error);
                throw error; // Ném lại lỗi để không hiển thị ảnh
            }
        }

        // Safe async operation wrapper to handle iframe restrictions
        async function safeAsyncOperation(asyncFn, operationName = 'async operation') {
            try {
                return await asyncFn();
            } catch (error) {
                // Handle specific iframe/contentWindow errors
                if (error.message && (
                    error.message.includes('contentWindow') ||
                    error.message.includes('iframe') ||
                    error.message.includes('cross-origin') ||
                    error.name === 'SecurityError'
                )) {
                    console.warn(`🔒 ${operationName} blocked by iframe security:`, error.message);
                    throw new Error(`Operation blocked by iframe security restrictions`);
                }
                
                // Re-throw other errors
                throw error;
            }
        }

        async function readComments() {
            try {
                const response = await fetch(COMMENTS_API_URL, {
                    headers: {
                        'Authorization': `token ${PAT}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const content = JSON.parse(base64Decode(data.content));
                    return { content };
                } else {
                    return { content: [] };
                }
            } catch (error) {
                console.error('Lỗi đọc comments:', error);
                return { content: [] };
            }
        }

        async function loadAllPhotosFromMetadata() {
            if (isLoadingPhotos) return;
            isLoadingPhotos = true;
            
            const photosGrid = document.getElementById('photoGallery');
            
            try {
                // Show loading state
                photosGrid.innerHTML = `
                    <div class="col-span-full text-center py-12" id="photos-loading-spinner">
                        <i class="fas fa-spinner fa-spin text-4xl text-blue-400 mb-4"></i>
                        <p class="text-gray-400"><span>Đang tải danh sách ảnh từ GitHub...</span></p>
                    </div>
                `;
                
                // CHỈ tải từ GitHub metadata, nếu lỗi thì không hiển thị ảnh
                const photosMetadata = await loadPhotosMetadataFromGitHub();
                
                allPhotosData = photosMetadata;
                totalPages = Math.ceil(allPhotosData.length / PHOTOS_PER_PAGE);
                currentPage = 1;
                
                // Load comments and reactions với timeout ngắn hơn
                try {
                    const { content: commentsArray } = await Promise.race([
                        readComments(),
                        new Promise((_, reject) => setTimeout(() => reject(new Error('Comments timeout')), 3000))
                    ]);
                    
                    commentsData = {};
                    reactionsData = {};
                    
                    if (Array.isArray(commentsArray)) {
                        commentsArray.forEach(entry => {
                            if (entry.ID_IMG) {
                                if (entry.comments && Array.isArray(entry.comments)) {
                                    if (!commentsData[entry.ID_IMG]) {
                                        commentsData[entry.ID_IMG] = [];
                                    }
                                    entry.comments.forEach(comment => {
                                        commentsData[entry.ID_IMG].push({
                                            text: comment.comment,
                                            timestamp: comment.date_input
                                        });
                                    });
                                }
                                reactionsData[entry.ID_IMG] = {
                                    count_tim: entry.count_tim || 0
                                };
                            }
                        });
                    }
                } catch (commentsError) {
                    console.warn('Không thể tải comments, sử dụng dữ liệu mặc định:', commentsError);
                    commentsData = {};
                    reactionsData = {};
                }
                
                displayPhotosPage(1);
                updatePaginationControls();
                showMessage(`✅ Đã tải ${allPhotosData.length} ảnh từ GitHub metadata!`, 'success');
                
            } catch (error) {
                console.error('❌ Lỗi khi tải ảnh từ GitHub:', error);
                
                // KHÔNG hiển thị ảnh nếu lỗi - chỉ hiển thị thông báo lỗi
                photosGrid.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <i class="fas fa-exclamation-triangle text-6xl text-red-400 mb-4"></i>
                        <h3 class="text-xl font-semibold text-red-300 mb-2">Không thể tải ảnh</h3>
                        <p class="text-gray-400 mb-4">${error.message}</p>
                        <div class="space-y-2 text-sm text-gray-500">
                            <p>• Kiểm tra cấu hình GitHub (GITHUB_USERNAME, REPO_NAME, PAT)</p>
                            <p>• Đảm bảo file ${PHOTOS_METADATA_FILE_PATH} tồn tại trên GitHub</p>
                            <p>• Sử dụng chức năng "Đồng bộ Google Drive" để tạo metadata</p>
                        </div>
                        <button onclick="showGoogleDriveSync()" class="mt-4 btn-gradient">
                            <i class="fas fa-sync mr-2"></i>Đồng bộ từ Google Drive
                        </button>
                    </div>
                `;
                
                // Reset data
                allPhotosData = [];
                totalPages = 0;
                currentPage = 1;
                commentsData = {};
                reactionsData = {};
                
                showMessage('❌ ' + error.message, 'error');
                
            } finally {
                isLoadingPhotos = false;
            }
        }

        // Hàm này đã bị loại bỏ - không sử dụng ảnh demo nữa

        // Hàm debug để kiểm tra URL
        function debugImageUrls(photoId, photoName) {
            if (photoId && photoId.length > 20) {
                const urls = generateGoogleDriveUrls(photoId);
                console.log(`🔍 Debug URLs cho "${photoName}" (ID: ${photoId}):`);
                urls.forEach((url, index) => {
                    console.log(`  ${index + 1}. ${url}`);
                });
                return urls;
            }
            return [];
        }

        async function savePhotosMetadata(data) {
            try {
                if (!GITHUB_USERNAME || !REPO_NAME || !PAT) return;

                // Fix Unicode encoding issue
                const jsonString = JSON.stringify(data, null, 2);
                const content = btoa(unescape(encodeURIComponent(jsonString)));
                
                // Kiểm tra file có tồn tại không
                let sha = null;
                try {
                    const existingResponse = await fetch(PHOTOS_METADATA_API_URL, {
                        headers: {
                            'Authorization': `token ${PAT}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    if (existingResponse.ok) {
                        const existingData = await existingResponse.json();
                        sha = existingData.sha;
                    }
                } catch (e) {}

                const payload = {
                    message: `Cập nhật metadata ảnh - ${new Date().toLocaleString('vi-VN')}`,
                    content: content
                };

                if (sha) {
                    payload.sha = sha;
                }

                await fetch(PHOTOS_METADATA_API_URL, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${PAT}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
            } catch (error) {
                console.error('Lỗi lưu photos metadata:', error);
            }
        }

        function displayPhotosPage(page) {
            const photosGrid = document.getElementById('photoGallery');
            const startIndex = (page - 1) * PHOTOS_PER_PAGE;
            const endIndex = startIndex + PHOTOS_PER_PAGE;
            const currentPhotos = allPhotosData.slice(startIndex, endIndex);

            photosGrid.innerHTML = '';

            if (currentPhotos.length === 0) {
                photosGrid.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <i class="fas fa-images text-6xl text-gray-400 mb-4"></i>
                        <p class="text-gray-400 text-lg">Không có ảnh nào để hiển thị</p>
                    </div>
                `;
                return;
            }

            currentPhotos.forEach((photo, index) => {
                const likes = reactionsData[photo.name]?.count_tim || 0;
                const commentsCount = commentsData[photo.name]?.length || 0;
                
                const photoItem = document.createElement('div');
                photoItem.className = 'photo-item cursor-pointer relative group';
                
                // Tạo danh sách URL để thử tải ảnh
                let imageUrls = [];
                
                if (photo.id && photo.id.length > 20) {
                    // Google Drive image - sử dụng nhiều URL thay thế
                    imageUrls = generateGoogleDriveUrls(photo.id, 'w400-h400', true);
                } else if (photo.thumbnailLink) {
                    // Có sẵn thumbnail link
                    imageUrls.push(photo.thumbnailLink);
                } else if (photo.webViewLink) {
                    // Có web view link
                    imageUrls.push(photo.webViewLink);
                }
                
                // Nếu không có URL nào, hiển thị lỗi ngay
                if (imageUrls.length === 0) {
                    console.warn(`⚠️ Không có URL hợp lệ cho ảnh: ${photo.name}`);
                }
                
                photoItem.innerHTML = `
                    <div class="relative overflow-hidden rounded-lg bg-gray-800">
                        <div class="relative">
                            <img id="galleryImg_${photo.id}" 
                                 alt="${photo.name}" 
                                 class="w-full h-48 object-cover transition-transform duration-300 group-hover:scale-110"
                                 loading="lazy"
                                 decoding="async"
                                 style="display: none;">
                            
                            <div id="galleryLoader_${photo.id}" class="absolute inset-0 flex flex-col items-center justify-center bg-gray-800 rounded-lg">
                                <i class="fas fa-spinner fa-spin text-2xl text-blue-400 mb-2"></i>
                                <p class="text-xs text-gray-400">Đang tải...</p>
                            </div>
                            
                            <div id="galleryError_${photo.id}" class="absolute inset-0 flex flex-col items-center justify-center bg-gray-700 rounded-lg" style="display: none;">
                                <i class="fas fa-exclamation-triangle text-3xl text-red-500 mb-2"></i>
                                <p class="text-xs text-gray-400 text-center px-2">${photo.name}</p>
                                <p class="text-xs text-red-400 text-center px-2 mt-1">Không thể tải ảnh</p>
                            </div>
                        </div>
                        
                        <!-- Overlay -->
                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 transition-all duration-300 flex items-center justify-center">
                            <div class="opacity-0 group-hover:opacity-100 transition-opacity duration-300 text-center">
                                <button onclick="openPhotoModal('${photo.id}')" class="bg-white bg-opacity-20 hover:bg-opacity-30 rounded-full p-3 mx-1">
                                    <i class="fas fa-eye text-white"></i>
                                </button>
                                <button onclick="likePhoto('${photo.id}')" class="bg-white bg-opacity-20 hover:bg-opacity-30 rounded-full p-3 mx-1">
                                    <i class="fas fa-heart text-white"></i>
                                </button>
                                <button onclick="sharePhoto('${photo.id}')" class="bg-white bg-opacity-20 hover:bg-opacity-30 rounded-full p-3 mx-1">
                                    <i class="fas fa-share text-white"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Photo info -->
                        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black to-transparent p-3">
                            <div class="flex items-center justify-between text-xs text-gray-300">
                                <div class="flex items-center space-x-2">
                                    <span><i class="fas fa-heart text-red-400"></i> ${likes}</span>
                                    <span><i class="fas fa-comment text-blue-400"></i> ${commentsCount}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                photosGrid.appendChild(photoItem);
                
                // Tải ảnh với nhiều URL thay thế
                loadImageWithMultipleUrls(photo.id, imageUrls, photo.name);
            });
        }

        function updatePaginationControls() {
            const photosGrid = document.getElementById('photoGallery');
            
            if (totalPages <= 1) return;

            const paginationDiv = document.createElement('div');
            paginationDiv.className = 'col-span-full flex justify-center items-center space-x-2 mt-6';
            paginationDiv.id = 'paginationControls';

            let paginationHTML = '';

            // Previous button
            if (currentPage > 1) {
                paginationHTML += `
                    <button onclick="changePhotoPage(${currentPage - 1})" class="px-3 py-2 bg-white bg-opacity-10 hover:bg-opacity-20 rounded-lg transition-all">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                `;
            }

            // Page numbers
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            if (startPage > 1) {
                paginationHTML += `<button onclick="changePhotoPage(1)" class="px-3 py-2 bg-white bg-opacity-10 hover:bg-opacity-20 rounded-lg transition-all">1</button>`;
                if (startPage > 2) {
                    paginationHTML += `<span class="px-2 text-gray-400">...</span>`;
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                const isActive = i === currentPage;
                paginationHTML += `
                    <button onclick="changePhotoPage(${i})" class="px-3 py-2 ${isActive ? 'bg-gradient-to-r from-pink-500 to-purple-600' : 'bg-white bg-opacity-10 hover:bg-opacity-20'} rounded-lg transition-all">
                        ${i}
                    </button>
                `;
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHTML += `<span class="px-2 text-gray-400">...</span>`;
                }
                paginationHTML += `<button onclick="changePhotoPage(${totalPages})" class="px-3 py-2 bg-white bg-opacity-10 hover:bg-opacity-20 rounded-lg transition-all">${totalPages}</button>`;
            }

            // Next button
            if (currentPage < totalPages) {
                paginationHTML += `
                    <button onclick="changePhotoPage(${currentPage + 1})" class="px-3 py-2 bg-white bg-opacity-10 hover:bg-opacity-20 rounded-lg transition-all">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                `;
            }

            paginationDiv.innerHTML = paginationHTML;
            photosGrid.appendChild(paginationDiv);

            // Add page info
            const pageInfoDiv = document.createElement('div');
            pageInfoDiv.className = 'col-span-full text-center text-gray-400 text-sm mt-4';
            pageInfoDiv.innerHTML = `Trang ${currentPage} / ${totalPages} - Tổng ${allPhotosData.length} ảnh`;
            photosGrid.appendChild(pageInfoDiv);
        }

        async function renderGallery() {
            await loadAllPhotosFromMetadata();
        }

        function renderPhotoPagination() {
            const photosPerPage = PHOTOS_PER_PAGE || 12;
            const totalPages = Math.ceil(totalPhotos / photosPerPage);
            
            if (totalPages <= 1) return;

            const gallery = document.getElementById('photoGallery');
            const paginationDiv = document.createElement('div');
            paginationDiv.className = 'col-span-full flex justify-center items-center space-x-2 mt-6';

            let paginationHTML = '';

            // Previous button
            if (currentPage > 1) {
                paginationHTML += `
                    <button onclick="changePhotoPage(${currentPage - 1})" class="px-3 py-2 bg-white bg-opacity-10 hover:bg-opacity-20 rounded-lg transition-all">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                `;
            }

            // Page numbers
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            if (startPage > 1) {
                paginationHTML += `<button onclick="changePhotoPage(1)" class="px-3 py-2 bg-white bg-opacity-10 hover:bg-opacity-20 rounded-lg transition-all">1</button>`;
                if (startPage > 2) {
                    paginationHTML += `<span class="px-2 text-gray-400">...</span>`;
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                const isActive = i === currentPage;
                paginationHTML += `
                    <button onclick="changePhotoPage(${i})" class="px-3 py-2 ${isActive ? 'bg-gradient-to-r from-pink-500 to-purple-600' : 'bg-white bg-opacity-10 hover:bg-opacity-20'} rounded-lg transition-all">
                        ${i}
                    </button>
                `;
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHTML += `<span class="px-2 text-gray-400">...</span>`;
                }
                paginationHTML += `<button onclick="changePhotoPage(${totalPages})" class="px-3 py-2 bg-white bg-opacity-10 hover:bg-opacity-20 rounded-lg transition-all">${totalPages}</button>`;
            }

            // Next button
            if (currentPage < totalPages) {
                paginationHTML += `
                    <button onclick="changePhotoPage(${currentPage + 1})" class="px-3 py-2 bg-white bg-opacity-10 hover:bg-opacity-20 rounded-lg transition-all">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                `;
            }

            paginationDiv.innerHTML = paginationHTML;
            gallery.appendChild(paginationDiv);

            // Add page info
            const pageInfoDiv = document.createElement('div');
            pageInfoDiv.className = 'col-span-full text-center text-gray-400 text-sm mt-4';
            pageInfoDiv.innerHTML = `Trang ${currentPage} / ${totalPages} - Tổng ${totalPhotos} ảnh`;
            gallery.appendChild(pageInfoDiv);
        }

        function changePhotoPage(page) {
            currentPage = page;
            displayPhotosPage(page);
            updatePaginationControls();
            
            // Log thay đổi trang - disabled
            // addLog('Chuyển trang ảnh', {
            //     from_page: currentPage,
            //     to_page: page,
            //     total_pages: totalPages,
            //     photos_per_page: PHOTOS_PER_PAGE
            // });
            
            // Scroll to gallery top
            document.getElementById('gallerySection').scrollIntoView({ behavior: 'smooth' });
        }

        async function likePhoto(photoId) {
            try {
                const photo = allPhotosData.find(p => p.id === photoId);
                if (!photo) {
                    showMessage('❌ Không tìm thấy ảnh', 'error');
                    return;
                }
                
                const photoName = photo.name;
                
                // Update local data
                if (!reactionsData[photoName]) {
                    reactionsData[photoName] = { count_tim: 0 };
                }
                reactionsData[photoName].count_tim += 1;
                
                // Save to GitHub comments file
                await saveCommentToGitHub(photoName, null, reactionsData[photoName].count_tim);
                
                // Update display
                displayPhotosPage(currentPage);
                updatePaginationControls();
                

                
            } catch (error) {
                console.error('Lỗi khi like ảnh:', error);
                showMessage('❌ Không thể like ảnh: ' + error.message, 'error');
            }
        }

        async function sharePhoto(photoId) {
            try {
                const photo = allPhotosData.find(p => p.id === photoId);
                if (!photo) {
                    showMessage('❌ Không tìm thấy ảnh để chia sẻ', 'error');
                    return;
                }
                
                // Tạo URL chia sẻ với format đúng
                const shareUrl = `https://drive.google.com/file/d/${photo.id}/view?usp=drivesdk`;
                const shareTitle = photo.name || 'Ảnh kỷ niệm';
                const shareText = `${shareTitle} - Chia sẻ từ Love Story Dashboard`;
                
                // Thử copy link vào clipboard trước
                let clipboardSuccess = false;
                try {
                    await navigator.clipboard.writeText(shareUrl);
                    clipboardSuccess = true;
                    console.log('✅ Đã copy link vào clipboard');
                } catch (clipboardError) {
                    console.warn('⚠️ Không thể copy vào clipboard:', clipboardError);
                    
                    // Fallback cho clipboard - sử dụng execCommand
                    try {
                        const textArea = document.createElement('textarea');
                        textArea.value = shareUrl;
                        textArea.style.position = 'fixed';
                        textArea.style.left = '-999999px';
                        textArea.style.top = '-999999px';
                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select();
                        
                        if (document.execCommand('copy')) {
                            clipboardSuccess = true;
                            console.log('✅ Đã copy link bằng execCommand');
                        }
                        
                        document.body.removeChild(textArea);
                    } catch (execError) {
                        console.warn('⚠️ execCommand cũng thất bại:', execError);
                    }
                }
                
                // Tạo modal chia sẻ tùy chỉnh
                createShareModal(shareUrl, shareTitle, clipboardSuccess);
                
            } catch (error) {
                console.error('❌ Lỗi khi chia sẻ ảnh:', error);
                showMessage('❌ Không thể chia sẻ ảnh: ' + error.message, 'error');
            }
        }
        
        function createShareModal(shareUrl, shareTitle, clipboardSuccess) {
            // Xóa modal cũ nếu có
            const existingModal = document.getElementById('shareModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Tạo modal chia sẻ
            const modal = document.createElement('div');
            modal.id = 'shareModal';
            modal.className = 'fixed inset-0 modal-dark z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="modal-content-dark p-6 w-full max-w-md">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold">Chia sẻ ảnh</h3>
                        <button onclick="closeShareModal()" class="text-gray-400 hover:text-white">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="mb-4">
                        <p class="text-gray-300 mb-3">${shareTitle}</p>
                        
                        ${clipboardSuccess ? `
                            <div class="bg-green-500 bg-opacity-20 border border-green-500 rounded-lg p-3 mb-4">
                                <div class="flex items-center">
                                    <i class="fas fa-check-circle text-green-400 mr-2"></i>
                                    <span class="text-green-300 text-sm">Đã copy link vào clipboard!</span>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="bg-white bg-opacity-5 rounded-lg p-3 mb-4">
                            <p class="text-gray-400 text-xs mb-2">Link chia sẻ:</p>
                            <div class="flex items-center space-x-2">
                                <input type="text" value="${shareUrl}" readonly 
                                       class="flex-1 form-control-dark p-2 text-xs" id="shareUrlInput">
                                <button onclick="copyShareUrl()" class="px-3 py-2 bg-blue-500 bg-opacity-20 hover:bg-opacity-30 rounded-lg transition-all">
                                    <i class="fas fa-copy text-white"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <button onclick="shareViaWhatsApp('${shareUrl}', '${shareTitle}')" 
                                class="flex items-center justify-center space-x-2 bg-green-500 bg-opacity-20 hover:bg-opacity-30 p-3 rounded-lg transition-all">
                            <i class="fab fa-whatsapp text-green-400"></i>
                            <span class="text-sm">WhatsApp</span>
                        </button>
                        
                        <button onclick="shareViaFacebook('${shareUrl}')" 
                                class="flex items-center justify-center space-x-2 bg-blue-500 bg-opacity-20 hover:bg-opacity-30 p-3 rounded-lg transition-all">
                            <i class="fab fa-facebook text-blue-400"></i>
                            <span class="text-sm">Facebook</span>
                        </button>
                        
                        <button onclick="shareViaTwitter('${shareUrl}', '${shareTitle}')" 
                                class="flex items-center justify-center space-x-2 bg-blue-400 bg-opacity-20 hover:bg-opacity-30 p-3 rounded-lg transition-all">
                            <i class="fab fa-twitter text-blue-300"></i>
                            <span class="text-sm">Twitter</span>
                        </button>
                        
                        <button onclick="shareViaEmail('${shareUrl}', '${shareTitle}')" 
                                class="flex items-center justify-center space-x-2 bg-gray-500 bg-opacity-20 hover:bg-opacity-30 p-3 rounded-lg transition-all">
                            <i class="fas fa-envelope text-gray-300"></i>
                            <span class="text-sm">Email</span>
                        </button>
                    </div>
                    
                    <button onclick="closeShareModal()" class="w-full px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg transition-all">
                        Đóng
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function closeShareModal() {
            const modal = document.getElementById('shareModal');
            if (modal) {
                modal.remove();
            }
        }
        
        function copyShareUrl() {
            const input = document.getElementById('shareUrlInput');
            if (input) {
                input.select();
                input.setSelectionRange(0, 99999); // For mobile
                
                try {
                    document.execCommand('copy');
                    showMessage('📋 Đã copy link!', 'success');
                } catch (error) {
                    console.error('Lỗi copy:', error);
                    showMessage('❌ Không thể copy link', 'error');
                }
            }
        }
        
        function shareViaWhatsApp(url, title) {
            const text = encodeURIComponent(`${title} - ${url}`);
            const whatsappUrl = `https://wa.me/?text=${text}`;
            window.open(whatsappUrl, '_blank', 'noopener,noreferrer');
            closeShareModal();
        }
        
        function shareViaFacebook(url) {
            const facebookUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
            window.open(facebookUrl, '_blank', 'noopener,noreferrer');
            closeShareModal();
        }
        
        function shareViaTwitter(url, title) {
            const text = encodeURIComponent(title);
            const twitterUrl = `https://twitter.com/intent/tweet?text=${text}&url=${encodeURIComponent(url)}`;
            window.open(twitterUrl, '_blank', 'noopener,noreferrer');
            closeShareModal();
        }
        
        function shareViaEmail(url, title) {
            const subject = encodeURIComponent(`Chia sẻ: ${title}`);
            const body = encodeURIComponent(`Xem ảnh kỷ niệm này: ${url}`);
            const emailUrl = `mailto:?subject=${subject}&body=${body}`;
            window.location.href = emailUrl;
            closeShareModal();
        }

        // Hệ thống log tối ưu
        async function addLog(action, additionalDetails = {}, currentUser = 'Couple User') {
            try {
                // Tạo datetime với định dạng DD/MM/YYYY hh:mm:ss 24h (ICT)
                const now = new Date();
                const ictTime = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Ho_Chi_Minh"}));
                
                const day = String(ictTime.getDate()).padStart(2, '0');
                const month = String(ictTime.getMonth() + 1).padStart(2, '0');
                const year = ictTime.getFullYear();
                const hours = String(ictTime.getHours()).padStart(2, '0');
                const minutes = String(ictTime.getMinutes()).padStart(2, '0');
                const seconds = String(ictTime.getSeconds()).padStart(2, '0');
                
                const formattedDateTime = `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
                
                // Thu thập thông tin trình duyệt tối ưu (chỉ lưu thông tin cần thiết)
                const browserDetails = {
                    user_agent: navigator.userAgent,
                    ...additionalDetails
                };
                
                const logEntry = {
                    datetime: formattedDateTime,
                    action: action,
                    details: browserDetails,
                    current_user: currentUser
                };
                
                console.log('📝 Ghi log:', logEntry);
                
                // Lưu vào GitHub
                await saveLogToGitHub(logEntry);
                
            } catch (error) {
                console.error('❌ Lỗi ghi log:', error);
                // Lưu vào localStorage như fallback
                const fallbackEntry = {
                    datetime: new Date().toLocaleString('vi-VN'),
                    action: action,
                    details: { 
                        user_agent: navigator.userAgent,
                        error_message: error.message, 
                        ...additionalDetails 
                    },
                    current_user: currentUser
                };
                saveLogToLocalStorage(fallbackEntry);
            }
        }

        async function saveLogToGitHub(newLogEntry, retryCount = 0) {
            const maxRetries = 3;
            const retryDelay = 1000; // 1 giây delay giữa các lần retry
            
            try {
                if (!GITHUB_USERNAME || !REPO_NAME || !PAT || !LOGS_FILE_PATH) {
                    throw new Error('Thiếu cấu hình GitHub cho logs');
                }

                // Đọc logs hiện tại và lấy SHA mới nhất
                const { logs: existingLogs, sha } = await fetchLatestLogsFromGitHub();

                // Thêm log mới vào đầu mảng
                const updatedLogs = [...existingLogs];
                updatedLogs.unshift(newLogEntry);
                
                // Giữ tối đa 1000 logs gần nhất
                if (updatedLogs.length > 1000) {
                    updatedLogs.splice(1000);
                }

                // Chuẩn bị payload để lưu
                const jsonString = JSON.stringify(updatedLogs, null, 2);
                const content = btoa(unescape(encodeURIComponent(jsonString)));

                const payload = {
                    message: `Cập nhật logs - ${newLogEntry.action} - ${new Date().toLocaleString('vi-VN')} (retry: ${retryCount})`,
                    content: content
                };

                if (sha) {
                    payload.sha = sha;
                }

                // Thực hiện lưu vào GitHub
                const saveResponse = await fetch(LOGS_API_URL, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${PAT}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!saveResponse.ok) {
                    // Xử lý lỗi 409 Conflict
                    if (saveResponse.status === 409 && retryCount < maxRetries) {
                        console.warn(`⚠️ Conflict detected (409) - Retry ${retryCount + 1}/${maxRetries}`);
                        
                        // Đợi một chút trước khi retry
                        await new Promise(resolve => setTimeout(resolve, retryDelay * (retryCount + 1)));
                        
                        // Retry với số lần thử tăng lên
                        return await saveLogToGitHub(newLogEntry, retryCount + 1);
                    }
                    
                    // Nếu không phải lỗi 409 hoặc đã hết số lần retry
                    const errorText = await saveResponse.text();
                    throw new Error(`Lỗi lưu log: ${saveResponse.status} - ${errorText}`);
                }

                const responseData = await saveResponse.json();
                console.log(`✅ Đã lưu log vào GitHub thành công${retryCount > 0 ? ` (sau ${retryCount} lần retry)` : ''}`);
                
                return responseData;

            } catch (error) {
                // Nếu là lỗi 409 và còn lần retry
                if (error.message.includes('409') && retryCount < maxRetries) {
                    console.warn(`⚠️ Retry ${retryCount + 1}/${maxRetries} do lỗi: ${error.message}`);
                    
                    // Đợi trước khi retry
                    await new Promise(resolve => setTimeout(resolve, retryDelay * (retryCount + 1)));
                    
                    return await saveLogToGitHub(newLogEntry, retryCount + 1);
                }
                
                console.error(`❌ Lỗi lưu log vào GitHub (sau ${retryCount} lần retry):`, error);
                throw error;
            }
        }

        // Hàm helper để đọc logs mới nhất từ GitHub
        async function fetchLatestLogsFromGitHub() {
            try {
                const response = await fetch(LOGS_API_URL, {
                    headers: {
                        'Authorization': `token ${PAT}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const logs = JSON.parse(base64Decode(data.content));
                    return { 
                        logs: Array.isArray(logs) ? logs : [], 
                        sha: data.sha 
                    };
                } else if (response.status === 404) {
                    // File chưa tồn tại
                    console.log('📄 File logs chưa tồn tại, sẽ tạo mới');
                    return { logs: [], sha: null };
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.warn('⚠️ Không thể đọc logs từ GitHub:', error.message);
                return { logs: [], sha: null };
            }
        }

        function saveLogToLocalStorage(logEntry) {
            try {
                const localLogs = JSON.parse(localStorage.getItem('appLogs') || '[]');
                localLogs.unshift(logEntry);
                
                // Giữ tối đa 100 logs trong localStorage
                if (localLogs.length > 100) {
                    localLogs.splice(100);
                }
                
                localStorage.setItem('appLogs', JSON.stringify(localLogs));
                console.log('💾 Đã lưu log vào localStorage');
            } catch (error) {
                console.error('❌ Lỗi lưu log vào localStorage:', error);
            }
        }

        async function readLogsFromGitHub() {
            try {
                const response = await fetch(LOGS_API_URL, {
                    headers: {
                        'Authorization': `token ${PAT}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return JSON.parse(base64Decode(data.content));
                } else {
                    return [];
                }
            } catch (error) {
                console.error('Lỗi đọc logs từ GitHub:', error);
                return JSON.parse(localStorage.getItem('appLogs') || '[]');
            }
        }

        function renderTimeline() {
            const timeline = document.getElementById('timelineList');
            timeline.innerHTML = '';
            
            const sortedMemories = [...memories].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedMemories.forEach(memory => {
                const timelineItem = document.createElement('div');
                timelineItem.className = 'timeline-item animate-slide-in';
                timelineItem.innerHTML = `
                    <div class="widget-card p-4 ml-4">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-semibold text-lg">${memory.title}</h4>
                                <p class="text-gray-300 text-sm">${formatDate(memory.date)}</p>
                                <p class="text-gray-400 mt-2">${memory.description}</p>
                            </div>
                            <span class="inline-block px-3 py-1 bg-gradient-to-r from-pink-500 to-purple-600 rounded-full text-xs">
                                ${getTypeLabel(memory.type)}
                            </span>
                        </div>
                    </div>
                `;
                timeline.appendChild(timelineItem);
            });
        }

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // Update month display
            const monthNames = ['Tháng 1', 'Tháng 2', 'Tháng 3', 'Tháng 4', 'Tháng 5', 'Tháng 6',
                              'Tháng 7', 'Tháng 8', 'Tháng 9', 'Tháng 10', 'Tháng 11', 'Tháng 12'];
            document.getElementById('calendarMonth').textContent = `${monthNames[month]} ${year}`;
            
            // Get first day and number of days
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Clear calendar
            const calendarDays = document.getElementById('calendarDays');
            calendarDays.innerHTML = '';
            
            // Add empty cells
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                calendarDays.appendChild(emptyDay);
            }
            
            // Add days
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day text-center py-3 cursor-pointer';
                dayElement.textContent = day;
                
                // Check for events
                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const hasEvent = memories.some(memory => memory.date === dateString);
                
                if (hasEvent) {
                    dayElement.classList.add('has-event');
                }
                
                calendarDays.appendChild(dayElement);
            }
        }

        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
            
            // Log navigation - disabled
            // addLog('calendar_navigation', {
            //     action: 'previous_month',
            //     new_month: currentDate.getMonth() + 1,
            //     new_year: currentDate.getFullYear()
            // });
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
            
            // Log navigation - disabled
            // addLog('calendar_navigation', {
            //     action: 'next_month',
            //     new_month: currentDate.getMonth() + 1,
            //     new_year: currentDate.getFullYear()
            // });
        }

        // Utility functions
        function updateStats() {
            document.getElementById('totalEvents').textContent = memories.length;
            document.getElementById('totalPhotos').textContent = Math.floor(Math.random() * 200) + 100;
            
            // Calculate days together (from first memory)
            if (memories.length > 0) {
                const firstDate = new Date(Math.min(...memories.map(m => new Date(m.date))));
                const today = new Date();
                const daysTogether = Math.floor((today - firstDate) / (1000 * 60 * 60 * 24));
                document.getElementById('daysTogether').textContent = daysTogether;
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN');
        }

        function getTypeLabel(type) {
            const labels = {
                anniversary: 'Kỷ niệm',
                date: 'Hẹn hò',
                travel: 'Du lịch',
                special: 'Đặc biệt'
            };
            return labels[type] || type;
        }

        // Hàm tải ảnh Google Drive với nhiều URL thay thế
        function loadImageWithMultipleUrls(photoId, imageUrls, imageName) {
            const imgElement = document.getElementById(`galleryImg_${photoId}`);
            const loaderElement = document.getElementById(`galleryLoader_${photoId}`);
            const errorElement = document.getElementById(`galleryError_${photoId}`);
            
            if (!imgElement || !imageUrls || imageUrls.length === 0) {
                showImageError(photoId, imageName);
                return;
            }
            
            tryLoadImageFromUrls(imgElement, loaderElement, errorElement, imageUrls, 0, imageName);
        }
        
        function tryLoadImageFromUrls(imgElement, loaderElement, errorElement, urls, currentIndex, imageName) {
            if (currentIndex >= urls.length) {
                // Đã thử hết tất cả URL, hiển thị lỗi
                showImageError(imgElement.id.replace('galleryImg_', ''), imageName);
                return;
            }
            
            const currentUrl = urls[currentIndex];
            console.log(`🔄 Thử tải ảnh "${imageName}" từ URL ${currentIndex + 1}/${urls.length}: ${currentUrl}`);
            
            const testImg = new Image();
            
            // Timeout 4 giây cho mỗi URL
            const timeout = setTimeout(() => {
                testImg.onload = null;
                testImg.onerror = null;
                console.warn(`⏰ Timeout loading "${imageName}" from: ${currentUrl}`);
                tryLoadImageFromUrls(imgElement, loaderElement, errorElement, urls, currentIndex + 1, imageName);
            }, 4000);
            
            testImg.onload = function() {
                clearTimeout(timeout);
                console.log(`✅ Successfully loaded "${imageName}" from: ${currentUrl}`);
                
                // Hiển thị ảnh thành công
                imgElement.src = currentUrl;
                imgElement.style.display = 'block';
                if (loaderElement) loaderElement.style.display = 'none';
                if (errorElement) errorElement.style.display = 'none';
            };
            
            testImg.onerror = function() {
                clearTimeout(timeout);
                console.warn(`❌ Failed to load "${imageName}" from: ${currentUrl}`);
                // Thử URL tiếp theo
                tryLoadImageFromUrls(imgElement, loaderElement, errorElement, urls, currentIndex + 1, imageName);
            };
            
            // Bắt đầu tải ảnh
            testImg.src = currentUrl;
        }
        
        function showImageError(photoId, imageName) {
            const imgElement = document.getElementById(`galleryImg_${photoId}`);
            const loaderElement = document.getElementById(`galleryLoader_${photoId}`);
            const errorElement = document.getElementById(`galleryError_${photoId}`);
            
            if (imgElement) imgElement.style.display = 'none';
            if (loaderElement) loaderElement.style.display = 'none';
            if (errorElement) {
                errorElement.style.display = 'flex';
                // Cập nhật tên ảnh trong error display
                const errorText = errorElement.querySelector('p');
                if (errorText) errorText.textContent = imageName || 'Ảnh không tải được';
            }
            
            console.error(`❌ Không thể tải ảnh "${imageName}" từ tất cả các URL`);
        }

        // Hàm thử tải ảnh với nhiều URL - tối ưu cho thumbnail và full size (giữ lại cho modal)
        function tryLoadImage(imgElement, urls, currentIndex, imageName) {
            if (currentIndex >= urls.length) {
                // Đã thử hết tất cả URL, hiển thị ảnh placeholder
                handleImageError(imgElement, imageName);
                return;
            }
            
            const currentUrl = urls[currentIndex];
            const img = new Image();
            
            // Timeout ngắn hơn cho thumbnail, dài hơn cho full size
            const isModal = imgElement.id === 'modalImage';
            const timeoutDuration = isModal ? 3000 : 1500; // 3s cho modal, 1.5s cho grid
            
            const timeout = setTimeout(() => {
                img.onload = null;
                img.onerror = null;
                console.warn(`⏰ Timeout loading image from: ${currentUrl}`);
                tryLoadImage(imgElement, urls, currentIndex + 1, imageName);
            }, timeoutDuration);
            
            img.onload = function() {
                clearTimeout(timeout);
                console.log(`✅ Successfully loaded ${isModal ? 'full size' : 'thumbnail'} image from: ${currentUrl}`);
                handleImageLoad(imgElement, currentUrl, imageName);
            };
            
            img.onerror = function(error) {
                clearTimeout(timeout);
                console.warn(`❌ Failed to load image from: ${currentUrl}`, error);
                // Thử URL tiếp theo
                tryLoadImage(imgElement, urls, currentIndex + 1, imageName);
            };
            
            // Bắt đầu tải ảnh
            img.src = currentUrl;
        }

        function handleImageLoad(imgElement, successUrl, imageName) {
            imgElement.src = successUrl;
            imgElement.alt = imageName;
            
            // Ẩn loading spinner nếu có
            const loaderId = imgElement.id.replace('Img_', 'Loader_').replace('galleryImg_', 'galleryLoader_');
            const loader = document.getElementById(loaderId);
            if (loader) {
                loader.style.display = 'none';
            }
            
            // Ẩn modal loader nếu có
            const modalLoader = document.getElementById('imageLoader');
            if (modalLoader) {
                modalLoader.style.display = 'none';
            }
        }

        function handleImageError(imgElement, imageName) {
            // Tạo ảnh placeholder với tên ảnh
            const placeholderSvg = `
                <svg width="400" height="300" xmlns="http://www.w3.org/2000/svg">
                    <rect width="100%" height="100%" fill="#4a5568"/>
                    <text x="50%" y="40%" font-family="Arial" font-size="16" fill="#ffffff" text-anchor="middle" dy=".3em">📷</text>
                    <text x="50%" y="60%" font-family="Arial" font-size="12" fill="#cbd5e0" text-anchor="middle" dy=".3em">${imageName || 'Ảnh không tải được'}</text>
                </svg>
            `;
            
            imgElement.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(placeholderSvg)));
            imgElement.alt = imageName || 'Ảnh không tải được';
            
            // Ẩn loading spinner
            const loaderId = imgElement.id.replace('Img_', 'Loader_').replace('galleryImg_', 'galleryLoader_');
            const loader = document.getElementById(loaderId);
            if (loader) {
                loader.style.display = 'none';
            }
        }

        // Google Drive URL generation functions - CORS safe
        function generateGoogleDriveUrls(fileId, size = 'w800-h600', isForThumbnail = false) {
            if (!fileId || fileId.length < 20) return [];
            
            const urls = [];
            
            if (isForThumbnail) {
                // URLs cho thumbnail trong grid
                urls.push(`https://drive.google.com/thumbnail?id=${fileId}&sz=w400-h400`);
                urls.push(`https://drive.google.com/thumbnail?id=${fileId}&sz=w300-h300`);
                urls.push(`https://lh3.googleusercontent.com/d/${fileId}=w400-h400`);
                urls.push(`https://lh3.googleusercontent.com/d/${fileId}=w300-h300`);
                urls.push(`https://drive.google.com/uc?export=view&id=${fileId}`);
            } else {
                // URLs cho xem chi tiết (full size)
                urls.push(`https://drive.google.com/thumbnail?id=${fileId}&sz=${size}`);
                urls.push(`https://drive.google.com/thumbnail?id=${fileId}&sz=w1200-h1200`);
                urls.push(`https://drive.google.com/uc?export=view&id=${fileId}`);
                urls.push(`https://lh3.googleusercontent.com/d/${fileId}=${size}`);
                urls.push(`https://lh3.googleusercontent.com/d/${fileId}=w1200-h1200`);
            }
            
            return urls;
        }

        // Photo modal functions
        function openPhotoModal(photoId) {
            try {
                console.log('🖼️ Mở modal ảnh với ID:', photoId);
                
                const photo = allPhotosData.find(p => p.id === photoId);
                if (!photo) {
                    console.error('❌ Không tìm thấy ảnh với ID:', photoId);
                    showMessage('❌ Không tìm thấy ảnh', 'error');
                    return;
                }
                
                currentPhotoIndex = allPhotosData.findIndex(p => p.id === photoId);
                modalPhotos = [...allPhotosData]; // Clone array để tránh reference issues
                
                console.log('📍 Vị trí ảnh trong danh sách:', currentPhotoIndex);
                
                // Create modal if it doesn't exist
                let modal = document.getElementById('photoModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'photoModal';
                    modal.className = 'fixed inset-0 modal-dark z-50 hidden flex items-center justify-center p-2 md:p-4';
                    modal.innerHTML = `
                        <div class="modal-content-dark max-w-4xl w-full max-h-full overflow-auto mx-auto">
                            <!-- Header -->
                            <div class="flex justify-between items-center p-4 border-b border-gray-600">
                                <div class="flex items-center space-x-3">
                                    <h3 class="text-xl font-bold">Ảnh kỷ niệm</h3>
                                    <button onclick="togglePhotoInfo()" class="text-gray-400 hover:text-white p-2 rounded-lg hover:bg-white hover:bg-opacity-10 transition-all">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                </div>
                                <button onclick="closePhotoModal()" class="text-gray-400 hover:text-white text-2xl">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            
                            <!-- Content -->
                            <div class="p-4">
                                <!-- Image container -->
                                <div class="text-center mb-4">
                                    <div id="modalImageLoader" class="flex flex-col items-center justify-center py-12">
                                        <i class="fas fa-spinner fa-spin text-4xl text-blue-400 mb-4"></i>
                                        <p class="text-white">Đang tải ảnh...</p>
                                    </div>
                                    <img id="modalImage" class="max-w-full max-h-96 mx-auto rounded-lg shadow-lg" style="display: none;" alt=""
                                         onerror="this.style.display='none'; document.getElementById('modalImageError').style.display='flex';">
                                    <div id="modalImageError" class="flex flex-col items-center justify-center py-12" style="display: none;">
                                        <i class="fas fa-exclamation-triangle text-4xl text-red-400 mb-4"></i>
                                        <p class="text-red-300">Không thể tải ảnh</p>
                                    </div>
                                </div>
                                
                                <!-- Default Interactions Section - Always visible -->
                                <div id="defaultInteractionsSection" class="mb-4">
                                    <div class="flex items-center justify-center space-x-4 mb-4">
                                        <button onclick="updateModalLikes()" class="flex items-center space-x-2 bg-red-500 bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                                            <i class="fas fa-heart text-red-400"></i>
                                            <span class="whitespace-nowrap">Thích</span>
                                        </button>
                                        <button onclick="shareCurrentPhoto()" class="flex items-center space-x-2 bg-blue-500 bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                                            <i class="fas fa-share text-blue-400"></i>
                                            <span class="whitespace-nowrap">Chia sẻ</span>
                                        </button>
                                        <button onclick="downloadPhoto()" class="flex items-center space-x-2 bg-green-500 bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                                            <i class="fas fa-download text-green-400"></i>
                                            <span class="whitespace-nowrap">Tải về</span>
                                        </button>
                                    </div>
                                    <div class="text-center text-sm text-gray-300 space-y-1">
                                        <p class="cursor-pointer hover:text-blue-400 transition-colors" onclick="toggleCommentsSection()">
                                            <i class="fas fa-comment mr-2"></i><span id="modalComments">5</span> bình luận
                                        </p>
                                        <p><i class="fas fa-heart mr-2"></i><span id="modalLikesCount">15</span> lượt thích</p>
                                    </div>
                                </div>
                                
                                <!-- Photo Details Section - Hidden by default, shown when clicking 3-dot button -->
                                <div id="photoInfoSection" class="mb-4 hidden">
                                    <div class="bg-white bg-opacity-5 rounded-lg p-4">
                                        <h4 class="font-semibold mb-3">Thông tin ảnh</h4>
                                        <div class="space-y-2 text-sm">
                                            <p><span class="text-gray-400">Tên:</span> <span id="modalPhotoName">thumbnail22.jpg</span></p>
                                            <p><span class="text-gray-400">Ngày tạo:</span> <span id="modalCreatedTime">2/7/2025</span></p>
                                            <p><span class="text-gray-400">Kích thước:</span> <span id="modalFileSize">0.06 MB</span></p>
                                            <p><span class="text-gray-400">Loại:</span> <span id="modalMimeType">image/jpeg</span></p>
                                            <p><span class="text-gray-400">Vị trí:</span> <span id="modalPhotoIndex">1</span> / <span id="modalPhotoTotal">710</span></p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Add Comment Section - Hidden by default -->
                                <div id="addCommentSection" class="mb-4 hidden">
                                    <h5 class="font-medium mb-2">Thêm bình luận</h5>
                                    <div class="flex space-x-2">
                                        <textarea id="newCommentText" placeholder="Viết bình luận..." class="flex-1 form-control-dark p-2 text-sm resize-none" rows="2"></textarea>
                                        <button onclick="addComment()" class="px-3 py-2 bg-blue-500 bg-opacity-20 hover:bg-opacity-30 rounded-lg transition-all">
                                            <i class="fas fa-paper-plane text-white"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Comments Section - Hidden by default -->
                                <div id="commentsSection" class="mt-6 border-t border-gray-600 pt-4 hidden">
                                    <h4 class="font-semibold mb-4">Bình luận</h4>
                                    <div id="commentsList" class="space-y-3 max-h-60 overflow-y-auto">
                                        <!-- Comments will be loaded here -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Footer -->
                            <div class="flex justify-between items-center p-4 border-t border-gray-600">
                                <div class="flex space-x-2">
                                    <button onclick="previousPhoto()" class="px-4 py-2 bg-white bg-opacity-10 hover:bg-opacity-20 rounded-lg transition-all">
                                        <i class="fas fa-chevron-left mr-2"></i>Trước
                                    </button>
                                    <button onclick="nextPhoto()" class="px-4 py-2 bg-white bg-opacity-10 hover:bg-opacity-20 rounded-lg transition-all">
                                        Sau<i class="fas fa-chevron-right ml-2"></i>
                                    </button>
                                </div>
                                <button onclick="closePhotoModal()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg transition-all">
                                    Đóng
                                </button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                }
                
                // Show modal
                modal.classList.remove('hidden');
                
                // Update content
                updateModalContent();
                
                console.log('✅ Modal ảnh đã được mở thành công');
                
            } catch (error) {
                console.error('❌ Lỗi khi mở modal ảnh:', error);
                showMessage('❌ Không thể mở ảnh: ' + error.message, 'error');
            }
        }

        function closePhotoModal() {
            const modal = document.getElementById('photoModal');
            if (modal) {
                modal.classList.add('hidden');
                console.log('🔒 Đã đóng modal ảnh');
            }
        }

        function previousPhoto() {
            if (currentPhotoIndex > 0) {
                currentPhotoIndex--;
                console.log('⬅️ Chuyển về ảnh trước, index:', currentPhotoIndex);
                updateModalContent();
            } else {
                console.log('⬅️ Đã ở ảnh đầu tiên');
            }
        }

        function nextPhoto() {
            if (currentPhotoIndex < modalPhotos.length - 1) {
                currentPhotoIndex++;
                console.log('➡️ Chuyển sang ảnh tiếp theo, index:', currentPhotoIndex);
                updateModalContent();
            } else {
                console.log('➡️ Đã ở ảnh cuối cùng');
            }
        }

        function updateModalContent() {
            try {
                const photo = modalPhotos[currentPhotoIndex];
                if (!photo) {
                    console.error('❌ Không tìm thấy ảnh tại index:', currentPhotoIndex);
                    return;
                }
                
                console.log('🔄 Cập nhật nội dung modal cho ảnh:', photo.name);
                
                // Get all modal elements
                const modalImage = document.getElementById('modalImage');
                const modalPhotoName = document.getElementById('modalPhotoName');
                const modalCreatedTime = document.getElementById('modalCreatedTime');
                const modalFileSize = document.getElementById('modalFileSize');
                const modalMimeType = document.getElementById('modalMimeType');
                const modalLikesCount = document.getElementById('modalLikesCount');
                const modalComments = document.getElementById('modalComments');
                const modalImageLoader = document.getElementById('modalImageLoader');
                const modalImageError = document.getElementById('modalImageError');
                const modalPhotoIndex = document.getElementById('modalPhotoIndex');
                const modalPhotoTotal = document.getElementById('modalPhotoTotal');
                
                if (!modalImage) {
                    console.error('❌ Không tìm thấy element modalImage');
                    return;
                }
                
                // Update photo details (only when info section is visible)
                if (modalPhotoName) modalPhotoName.textContent = photo.name || 'thumbnail22.jpg';
                
                if (modalCreatedTime) {
                    const createdDate = photo.createdTime ? new Date(photo.createdTime).toLocaleDateString('vi-VN') : '2/7/2025';
                    modalCreatedTime.textContent = createdDate;
                }
                
                if (modalFileSize) {
                    const sizeInMB = photo.size ? (photo.size / (1024 * 1024)).toFixed(2) + ' MB' : '0.06 MB';
                    modalFileSize.textContent = sizeInMB;
                }
                
                if (modalMimeType) {
                    modalMimeType.textContent = photo.mimeType || 'image/jpeg';
                }
                
                // Update interaction counts - use default values or real data
                const likes = reactionsData[photo.name]?.count_tim || 15;
                const comments = commentsData[photo.name]?.length || 5;
                
                if (modalLikesCount) modalLikesCount.textContent = likes;
                if (modalComments) modalComments.textContent = comments;
                
                // Update pagination info
                if (modalPhotoIndex && modalPhotoTotal) {
                    modalPhotoIndex.textContent = currentPhotoIndex + 1;
                    modalPhotoTotal.textContent = modalPhotos.length || 710;
                }
                
                // Load comments
                loadCommentsForPhoto(photo.name);
                
                // Reset display states
                if (modalImageLoader) modalImageLoader.style.display = 'flex';
                if (modalImage) modalImage.style.display = 'none';
                if (modalImageError) modalImageError.style.display = 'none';
                
                // Load image với chất lượng cao cho modal
                let imageUrls = [];
                if (photo.id && photo.id.length > 20) {
                    // Sử dụng kích thước lớn hơn cho modal - chất lượng cao
                    imageUrls = [
                        `https://drive.google.com/thumbnail?id=${photo.id}&sz=w1920-h1080`,
                        `https://drive.google.com/thumbnail?id=${photo.id}&sz=w1600-h1200`,
                        `https://drive.google.com/thumbnail?id=${photo.id}&sz=w1200-h900`,
                        `https://lh3.googleusercontent.com/d/${photo.id}=w1920-h1080`,
                        `https://lh3.googleusercontent.com/d/${photo.id}=w1600-h1200`,
                        `https://drive.google.com/uc?export=view&id=${photo.id}`,
                        `https://lh3.googleusercontent.com/d/${photo.id}=w1200-h900`
                    ];
                } else if (photo.webViewLink) {
                    imageUrls.push(photo.webViewLink);
                } else if (photo.thumbnailLink) {
                    imageUrls.push(photo.thumbnailLink);
                }
                
                if (imageUrls.length > 0) {
                    console.log(`🔗 Thử tải ảnh modal với ${imageUrls.length} URLs`);
                    tryLoadModalImage(modalImage, modalImageLoader, modalImageError, imageUrls, 0, photo.name);
                } else {
                    // Không có URL hợp lệ
                    console.error(`❌ Không có URL hợp lệ cho ảnh modal: ${photo.name}`);
                    if (modalImageLoader) modalImageLoader.style.display = 'none';
                    if (modalImageError) modalImageError.style.display = 'flex';
                }
                
            } catch (error) {
                console.error('❌ Lỗi khi cập nhật modal content:', error);
                showMessage('❌ Lỗi hiển thị ảnh: ' + error.message, 'error');
            }
        }

        function loadCommentsForPhoto(photoName) {
            const commentsList = document.getElementById('commentsList');
            if (!commentsList) return;
            
            const photoComments = commentsData[photoName] || [];
            
            if (photoComments.length === 0) {
                commentsList.innerHTML = '<p class="text-gray-400 text-sm">Chưa có bình luận nào</p>';
                return;
            }
            
            commentsList.innerHTML = photoComments.map(comment => `
                <div class="bg-white bg-opacity-5 rounded-lg p-3">
                    <p class="text-white text-sm mb-1">${comment.text}</p>
                    <p class="text-gray-400 text-xs">${new Date(comment.timestamp).toLocaleString('vi-VN')}</p>
                </div>
            `).join('');
        }

        async function addComment() {
            try {
                const photo = modalPhotos[currentPhotoIndex];
                if (!photo) {
                    showMessage('❌ Không tìm thấy ảnh', 'error');
                    return;
                }
                
                const commentText = document.getElementById('newCommentText').value.trim();
                if (!commentText) {
                    showMessage('⚠️ Vui lòng nhập bình luận', 'warning');
                    return;
                }
                
                const photoName = photo.name;
                const newComment = {
                    comment: commentText,
                    date_input: new Date().toISOString()
                };
                
                // Update local data
                if (!commentsData[photoName]) {
                    commentsData[photoName] = [];
                }
                commentsData[photoName].push({
                    text: newComment.comment,
                    timestamp: newComment.date_input
                });
                
                // Save to GitHub
                await saveCommentToGitHub(photoName, newComment);
                
                // Show comments section if hidden
                const commentsSection = document.getElementById('commentsSection');
                const addCommentSection = document.getElementById('addCommentSection');
                if (commentsSection && commentsSection.classList.contains('hidden')) {
                    commentsSection.classList.remove('hidden');
                    addCommentSection.classList.remove('hidden');
                }
                
                // Update display
                loadCommentsForPhoto(photoName);
                updateModalContent();
                displayPhotosPage(currentPage);
                updatePaginationControls();
                
                // Clear input
                document.getElementById('newCommentText').value = '';
                

                
            } catch (error) {
                console.error('Lỗi khi thêm bình luận:', error);
                showMessage('❌ Không thể thêm bình luận: ' + error.message, 'error');
            }
        }

        async function saveCommentToGitHub(photoName, newComment = null, newLikeCount = null) {
            try {
                if (!GITHUB_USERNAME || !REPO_NAME || !PAT) {
                    throw new Error('Thiếu cấu hình GitHub');
                }
                
                // Read current comments file
                let existingComments = [];
                let sha = null;
                
                try {
                    const response = await fetch(COMMENTS_API_URL, {
                        headers: {
                            'Authorization': `token ${PAT}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        existingComments = JSON.parse(base64Decode(data.content));
                        sha = data.sha;
                    }
                } catch (e) {
                    console.log('Creating new comments file');
                }
                
                // Find or create entry for this photo
                let photoEntry = existingComments.find(entry => entry.ID_IMG === photoName);
                
                if (!photoEntry) {
                    photoEntry = {
                        ID_IMG: photoName,
                        count_tim: 0,
                        comments: []
                    };
                    existingComments.push(photoEntry);
                }
                
                // Update like count if provided
                if (newLikeCount !== null) {
                    photoEntry.count_tim = newLikeCount;
                }
                
                // Add new comment if provided
                if (newComment) {
                    photoEntry.comments.push(newComment);
                }
                
                // Save back to GitHub
                const jsonString = JSON.stringify(existingComments, null, 2);
                const content = btoa(unescape(encodeURIComponent(jsonString)));
                
                const payload = {
                    message: `Cập nhật ${newComment ? 'bình luận' : 'lượt thích'} cho ${photoName} - ${new Date().toLocaleString('vi-VN')}`,
                    content: content
                };
                
                if (sha) {
                    payload.sha = sha;
                }
                
                const saveResponse = await fetch(COMMENTS_API_URL, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${PAT}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!saveResponse.ok) {
                    const errorText = await saveResponse.text();
                    throw new Error(`GitHub API Error ${saveResponse.status}: ${errorText}`);
                }
                
                console.log(`✅ Đã lưu ${newComment ? 'bình luận' : 'lượt thích'} vào GitHub cho ảnh: ${photoName}`);
                
            } catch (error) {
                console.error('❌ Lỗi lưu vào GitHub:', error);
                throw error;
            }
        }

        // Hàm tải ảnh riêng cho modal
        function tryLoadModalImage(imgElement, loaderElement, errorElement, urls, currentIndex, imageName) {
            if (currentIndex >= urls.length) {
                // Đã thử hết tất cả URL, hiển thị lỗi
                console.error(`❌ Không thể tải ảnh modal "${imageName}" từ tất cả ${urls.length} URLs`);
                if (loaderElement) loaderElement.style.display = 'none';
                if (errorElement) errorElement.style.display = 'flex';
                return;
            }
            
            const currentUrl = urls[currentIndex];
            console.log(`🔄 Thử tải ảnh modal "${imageName}" từ URL ${currentIndex + 1}/${urls.length}: ${currentUrl}`);
            
            const testImg = new Image();
            
            // Timeout 5 giây cho modal (dài hơn grid)
            const timeout = setTimeout(() => {
                testImg.onload = null;
                testImg.onerror = null;
                console.warn(`⏰ Timeout loading modal image "${imageName}" from: ${currentUrl}`);
                tryLoadModalImage(imgElement, loaderElement, errorElement, urls, currentIndex + 1, imageName);
            }, 5000);
            
            testImg.onload = function() {
                clearTimeout(timeout);
                console.log(`✅ Successfully loaded modal image "${imageName}" from: ${currentUrl}`);
                
                // Hiển thị ảnh thành công
                imgElement.src = currentUrl;
                imgElement.alt = imageName;
                imgElement.style.display = 'block';
                if (loaderElement) loaderElement.style.display = 'none';
                if (errorElement) errorElement.style.display = 'none';
            };
            
            testImg.onerror = function() {
                clearTimeout(timeout);
                console.warn(`❌ Failed to load modal image "${imageName}" from: ${currentUrl}`);
                // Thử URL tiếp theo
                tryLoadModalImage(imgElement, loaderElement, errorElement, urls, currentIndex + 1, imageName);
            };
            
            // Bắt đầu tải ảnh
            testImg.src = currentUrl;
        }

        async function updateModalLikes() {
            const photo = modalPhotos[currentPhotoIndex];
            if (!photo) return;
            
            try {
                await likePhoto(photo.id);
                
                // Update modal display immediately
                const likes = reactionsData[photo.name]?.count_tim || 0;
                const modalLikes = document.getElementById('modalLikes');
                const modalLikesCount = document.getElementById('modalLikesCount');
                
                if (modalLikes) modalLikes.textContent = likes;
                if (modalLikesCount) modalLikesCount.textContent = likes;
                
            } catch (error) {
                console.error('Lỗi khi like ảnh từ modal:', error);
            }
        }

        function toggleCommentsSection() {
            const commentsSection = document.getElementById('commentsSection');
            const addCommentSection = document.getElementById('addCommentSection');
            
            if (commentsSection && addCommentSection) {
                const isHidden = commentsSection.classList.contains('hidden');
                
                if (isHidden) {
                    // Show comments section
                    commentsSection.classList.remove('hidden');
                    addCommentSection.classList.remove('hidden');
                } else {
                    // Hide comments section
                    commentsSection.classList.add('hidden');
                    addCommentSection.classList.add('hidden');
                }
            }
        }

        async function downloadPhoto() {
            try {
                const photo = modalPhotos[currentPhotoIndex];
                if (!photo) {
                    showMessage('❌ Không tìm thấy ảnh để tải', 'error');
                    return;
                }
                
                showMessage('📥 Đang chuẩn bị tải ảnh...', 'info');
                
                // Sử dụng webViewLink làm URL tải về chính
                let downloadUrl = null;
                
                if (photo.webViewLink) {
                    downloadUrl = photo.webViewLink;
                } else if (photo.id && photo.id.length > 20) {
                    // Fallback: tạo webViewLink từ ID nếu không có sẵn
                    downloadUrl = `https://drive.google.com/file/d/${photo.id}/view?usp=drivesdk`;
                } else {
                    const modalImage = document.getElementById('modalImage');
                    if (modalImage && modalImage.src) {
                        downloadUrl = modalImage.src;
                    }
                }
                
                if (!downloadUrl) {
                    showMessage('❌ Không tìm thấy URL để tải ảnh', 'error');
                    return;
                }
                
                // Tạo tên file với extension phù hợp
                let fileName = photo.name || `anh-ky-niem-${Date.now()}`;
                if (!fileName.includes('.')) {
                    const mimeType = photo.mimeType || 'image/jpeg';
                    const extension = mimeType.split('/')[1] || 'jpg';
                    fileName += `.${extension}`;
                }
                
                // Mở webViewLink trong tab mới để người dùng tự tải
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.target = '_blank';
                link.rel = 'noopener noreferrer';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showMessage('📥 Đã mở Google Drive để tải ảnh!', 'success');
                
            } catch (error) {
                console.error('Lỗi khi tải ảnh:', error);
                showMessage('❌ Không thể mở link tải ảnh: ' + error.message, 'error');
            }
        }

        function togglePhotoInfo() {
            const photoInfoSection = document.getElementById('photoInfoSection');
            if (photoInfoSection) {
                const isHidden = photoInfoSection.classList.contains('hidden');
                
                if (isHidden) {
                    // Hiện thông tin ảnh
                    photoInfoSection.classList.remove('hidden');
                } else {
                    // Ẩn thông tin ảnh
                    photoInfoSection.classList.add('hidden');
                }
            }
        }

        // Google Drive Sync functions
        function showGoogleDriveSync() {
            document.getElementById('googleDriveSyncModal').classList.remove('hidden');
            updateSyncModalInfo();
            loadAutoSyncLogs();
        }

        function updateSyncModalInfo() {
            // Update current configuration display
            document.getElementById('currentFolderId').textContent = FOLDER_ID || 'Chưa cấu hình';
            document.getElementById('currentApiKey').textContent = API_KEY ? API_KEY.substring(0, 10) + '...' : 'Chưa cấu hình';
            document.getElementById('currentRepo').textContent = REPO_NAME ? `${GITHUB_USERNAME}/${REPO_NAME}` : 'Chưa cấu hình';
            
            // Update stats
            document.getElementById('currentPhotosCount').textContent = allPhotosData.length;
            
            // Hiển thị thời gian sync từ cấu hình
            const schedule = getAutoSyncSchedule();
            let lastSyncText = 'Chưa có';
            
            if (schedule.lastRun) {
                lastSyncText = new Date(schedule.lastRun).toLocaleString('vi-VN');
            } else {
                const localLastSync = localStorage.getItem('lastSyncTime');
                if (localLastSync) {
                    lastSyncText = new Date(localLastSync).toLocaleString('vi-VN');
                }
            }
            
            document.getElementById('lastSyncTime').textContent = lastSyncText;
            
            // Update auto sync status
            updateAutoSyncDisplay();
        }

        async function startGoogleDriveSync() {
            const startBtn = document.getElementById('startSyncBtn');
            const progressDiv = document.getElementById('syncProgress');
            const resultsDiv = document.getElementById('syncResults');
            
            try {
                startBtn.disabled = true;
                startBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Đang đồng bộ...';
                
                progressDiv.classList.remove('hidden');
                resultsDiv.classList.add('hidden');
                
                updateSyncProgress(0, 'Bắt đầu đồng bộ...');
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Kiểm tra cấu hình
                if (!FOLDER_ID || !API_KEY) {
                    throw new Error('Thiếu cấu hình Google Drive API (FOLDER_ID hoặc API_KEY)');
                }
                
                if (!GITHUB_USERNAME || !REPO_NAME || !PAT) {
                    throw new Error('Thiếu cấu hình GitHub (GITHUB_USERNAME, REPO_NAME hoặc PAT)');
                }
                
                updateSyncProgress(20, 'Đang kết nối Google Drive API...');
                
                // Tải TOÀN BỘ danh sách ảnh từ Google Drive
                const photosFromDrive = await loadPhotosFromGoogleDrive();
                
                if (photosFromDrive.length === 0) {
                    throw new Error('Không tìm thấy ảnh nào trong Google Drive folder');
                }
                
                updateSyncProgress(60, `Đã tải ${photosFromDrive.length} ảnh từ Google Drive...`);
                
                updateSyncProgress(80, 'Đang lưu metadata vào GitHub...');
                
                // Lưu TOÀN BỘ metadata vào GitHub
                await savePhotosMetadata(photosFromDrive);
                
                updateSyncProgress(90, 'Đang cập nhật dữ liệu local...');
                
                // Cập nhật dữ liệu local
                allPhotosData = photosFromDrive;
                totalPages = Math.ceil(allPhotosData.length / PHOTOS_PER_PAGE);
                currentPage = 1;
                
                updateSyncProgress(100, 'Hoàn thành!');
                
                // Cập nhật hiển thị gallery
                displayPhotosPage(1);
                updatePaginationControls();
                
                // Show results
                setTimeout(() => {
                    progressDiv.classList.add('hidden');
                    resultsDiv.classList.remove('hidden');
                    
                    const resultsContent = document.getElementById('syncResultsContent');
                    resultsContent.innerHTML = `
                        <p>✅ Đã đồng bộ thành công ${photosFromDrive.length} ảnh từ Google Drive</p>
                        <p>📊 Cập nhật metadata: ${photosFromDrive.length} ảnh</p>
                        <p>💾 Đã lưu vào GitHub: ${PHOTOS_METADATA_FILE_PATH}</p>
                        <p>🔄 Gallery đã được cập nhật với dữ liệu mới</p>
                        <p>⏰ Thời gian: ${new Date().toLocaleString('vi-VN')}</p>
                    `;
                    
                    // Save sync time
                    localStorage.setItem('lastSyncTime', new Date().toISOString());
                    updateSyncModalInfo();
                    
                    showMessage(`✅ Đồng bộ thành công ${photosFromDrive.length} ảnh!`, 'success');
                    
                }, 1000);
                
            } catch (error) {
                console.error('Lỗi đồng bộ:', error);
                showMessage('❌ Lỗi đồng bộ: ' + error.message, 'error');
                progressDiv.classList.add('hidden');
                
                // Show error in results
                resultsDiv.classList.remove('hidden');
                const resultsContent = document.getElementById('syncResultsContent');
                resultsContent.innerHTML = `
                    <div class="bg-red-500 bg-opacity-20 border border-red-500 rounded-lg p-4">
                        <h4 class="font-semibold text-red-300 mb-2">❌ Đồng bộ thất bại</h4>
                        <p class="text-red-200 text-sm">${error.message}</p>
                        <p class="text-red-200 text-xs mt-2">Vui lòng kiểm tra cấu hình Google Drive API và GitHub</p>
                    </div>
                `;
            } finally {
                startBtn.disabled = false;
                startBtn.innerHTML = '<i class="fas fa-sync mr-2"></i>Đồng Bộ Thủ Công';
            }
        }

        function updateSyncProgress(percent, text) {
            document.getElementById('syncProgressPercent').textContent = percent + '%';
            document.getElementById('syncProgressBar').style.width = percent + '%';
            document.getElementById('syncProgressText').textContent = text;
        }



        function getAutoSyncSchedule() {
            const saved = localStorage.getItem('autoSyncSchedule');
            return saved ? JSON.parse(saved) : {
                enabled: false,
                frequency: 'daily',
                time: '02:00',
                lastRun: null
            };
        }

        async function saveAutoSyncSchedule(schedule) {
            // Lưu vào localStorage
            localStorage.setItem('autoSyncSchedule', JSON.stringify(schedule));
            
            // Lưu vào GitHub config file
            try {
                await saveAutoSyncConfigToGitHub(schedule);
            } catch (error) {
                console.warn('Không thể lưu cấu hình Auto Sync vào GitHub:', error);
            }
        }

        async function saveAutoSyncConfigToGitHub(autoSyncConfig) {
            try {
                if (!GITHUB_USERNAME || !REPO_NAME || !PAT) {
                    console.log('Không có cấu hình GitHub để lưu Auto Sync');
                    return;
                }

                // Đọc config hiện tại
                let currentConfig = {};
                let sha = null;
                
                try {
                    const response = await fetch(CONFIG_API_URL, {
                        headers: {
                            'Authorization': `token ${PAT}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        currentConfig = JSON.parse(base64Decode(data.content));
                        sha = data.sha;
                    }
                } catch (e) {
                    console.log('Tạo file config mới');
                }

                // Cập nhật AUTO_SYNC trong config
                currentConfig.AUTO_SYNC = {
                    ...autoSyncConfig,
                    updatedAt: new Date().toISOString()
                };

                // Lưu lại vào GitHub
                const jsonString = JSON.stringify(currentConfig, null, 2);
                const content = btoa(unescape(encodeURIComponent(jsonString)));

                const payload = {
                    message: `Cập nhật cấu hình Auto Sync - ${new Date().toLocaleString('vi-VN')}`,
                    content: content
                };

                if (sha) {
                    payload.sha = sha;
                }

                const saveResponse = await fetch(CONFIG_API_URL, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${PAT}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (saveResponse.ok) {
                    console.log('✅ Đã lưu cấu hình Auto Sync vào GitHub');
                } else {
                    throw new Error(`HTTP ${saveResponse.status}: ${saveResponse.statusText}`);
                }

            } catch (error) {
                console.error('❌ Lỗi lưu cấu hình Auto Sync vào GitHub:', error);
                throw error;
            }
        }

        async function toggleAutoSync() {
            const schedule = getAutoSyncSchedule();
            schedule.enabled = !schedule.enabled;
            
            if (schedule.enabled) {
                // Tính toán nextRun khi bật
                const now = new Date();
                let nextRun;
                
                switch (schedule.frequency) {
                    case 'hourly':
                        nextRun = new Date(now.getTime() + 60 * 60 * 1000);
                        break;
                    case 'daily':
                        const [hours, minutes] = schedule.time.split(':');
                        nextRun = new Date();
                        nextRun.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                        if (nextRun <= now) {
                            nextRun.setDate(nextRun.getDate() + 1);
                        }
                        break;
                    case 'weekly':
                        nextRun = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
                        break;
                }
                
                schedule.nextRun = nextRun ? nextRun.toISOString() : null;
                setupAutoSync();
                showMessage('✅ Đã bật đồng bộ tự động', 'success');
            } else {
                schedule.nextRun = null;
                clearAutoSync();
                showMessage('⏹️ Đã tắt đồng bộ tự động', 'info');
            }
            
            await saveAutoSyncSchedule(schedule);
            updateAutoSyncDisplay();
            
            // Log toggle - disabled
            // addLog('Thay đổi Auto Sync', {
            //     enabled: schedule.enabled,
            //     frequency: schedule.frequency,
            //     time: schedule.time,
            //     nextRun: schedule.nextRun
            // });
        }

        async function updateAutoSyncFrequency() {
            const frequency = document.getElementById('autoSyncFrequency').value;
            const schedule = getAutoSyncSchedule();
            schedule.frequency = frequency;
            
            // Show/hide time selection based on frequency
            const timeContainer = document.getElementById('timeScheduleContainer');
            if (frequency === 'hourly') {
                timeContainer.classList.add('hidden');
            } else {
                timeContainer.classList.remove('hidden');
            }
            
            // Tính toán lại nextRun nếu đang bật
            if (schedule.enabled) {
                const now = new Date();
                let nextRun;
                
                switch (frequency) {
                    case 'hourly':
                        nextRun = new Date(now.getTime() + 60 * 60 * 1000);
                        break;
                    case 'daily':
                        const [hours, minutes] = schedule.time.split(':');
                        nextRun = new Date();
                        nextRun.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                        if (nextRun <= now) {
                            nextRun.setDate(nextRun.getDate() + 1);
                        }
                        break;
                    case 'weekly':
                        nextRun = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
                        break;
                }
                
                schedule.nextRun = nextRun ? nextRun.toISOString() : null;
                setupAutoSync();
            }
            
            await saveAutoSyncSchedule(schedule);
            updateAutoSyncDisplay();
        }

        async function updateAutoSyncTime() {
            const time = document.getElementById('autoSyncTime').value;
            const schedule = getAutoSyncSchedule();
            schedule.time = time;
            
            // Tính toán lại nextRun nếu đang bật
            if (schedule.enabled && schedule.frequency !== 'hourly') {
                const now = new Date();
                const [hours, minutes] = time.split(':');
                const nextRun = new Date();
                nextRun.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                
                if (nextRun <= now) {
                    if (schedule.frequency === 'daily') {
                        nextRun.setDate(nextRun.getDate() + 1);
                    } else if (schedule.frequency === 'weekly') {
                        nextRun.setDate(nextRun.getDate() + 7);
                    }
                }
                
                schedule.nextRun = nextRun.toISOString();
                setupAutoSync();
            }
            
            await saveAutoSyncSchedule(schedule);
            updateAutoSyncDisplay();
        }

        function setupAutoSync() {
            clearAutoSync();
            
            const schedule = getAutoSyncSchedule();
            if (!schedule.enabled) return;
            
            const now = new Date();
            let nextRun;
            
            switch (schedule.frequency) {
                case 'hourly':
                    nextRun = new Date(now.getTime() + 60 * 60 * 1000); // 1 hour
                    autoSyncInterval = setInterval(runAutoSync, 60 * 60 * 1000);
                    break;
                    
                case 'daily':
                    const [hours, minutes] = schedule.time.split(':');
                    nextRun = new Date();
                    nextRun.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                    
                    if (nextRun <= now) {
                        nextRun.setDate(nextRun.getDate() + 1);
                    }
                    
                    const msUntilNext = nextRun.getTime() - now.getTime();
                    autoSyncTimeout = setTimeout(() => {
                        runAutoSync();
                        autoSyncInterval = setInterval(runAutoSync, 24 * 60 * 60 * 1000);
                    }, msUntilNext);
                    break;
                    
                case 'weekly':
                    // Similar logic for weekly
                    nextRun = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
                    break;
            }
            
            // Update display
            if (nextRun) {
                document.getElementById('nextRunTimeValue').textContent = nextRun.toLocaleString('vi-VN');
                document.getElementById('nextRunTime').classList.remove('hidden');
            }
        }

        function clearAutoSync() {
            if (autoSyncInterval) {
                clearInterval(autoSyncInterval);
                autoSyncInterval = null;
            }
            if (autoSyncTimeout) {
                clearTimeout(autoSyncTimeout);
                autoSyncTimeout = null;
            }
        }

        async function loadPhotosFromGoogleDrive() {
            try {
                if (!FOLDER_ID || !API_KEY) {
                    throw new Error('Thiếu cấu hình Google Drive API (FOLDER_ID hoặc API_KEY)');
                }
                
                console.log('🔍 Đang tải TOÀN BỘ ảnh từ Google Drive folder:', FOLDER_ID);
                
                let allFiles = [];
                let nextPageToken = null;
                let pageCount = 0;
                const maxPages = 50; // Giới hạn để tránh vòng lặp vô tận
                
                do {
                    pageCount++;
                    console.log(`📄 Đang tải trang ${pageCount}...`);
                    
                    // Tạo URL với pagination
                    let url = `https://www.googleapis.com/drive/v3/files?q='${FOLDER_ID}'+in+parents+and+mimeType+contains+'image/'&fields=nextPageToken,files(id,name,webViewLink,thumbnailLink,createdTime,modifiedTime,size,mimeType,description)&pageSize=1000&key=${API_KEY}`;
                    
                    if (nextPageToken) {
                        url += `&pageToken=${nextPageToken}`;
                    }
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 20000); // 20s timeout
                    
                    const response = await fetch(url, {
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        
                        if (response.status === 403) {
                            throw new Error('API Key không hợp lệ, đã hết quota, hoặc không có quyền truy cập folder');
                        } else if (response.status === 404) {
                            throw new Error('Folder ID không tồn tại hoặc không có quyền truy cập');
                        } else {
                            throw new Error(`Google Drive API Error ${response.status}: ${errorText}`);
                        }
                    }
                    
                    const data = await response.json();
                    const files = data.files || [];
                    
                    console.log(`📸 Trang ${pageCount}: Tìm thấy ${files.length} ảnh`);
                    
                    allFiles = allFiles.concat(files);
                    nextPageToken = data.nextPageToken;
                    
                    // Tránh vòng lặp vô tận
                    if (pageCount >= maxPages) {
                        console.warn(`⚠️ Đã đạt giới hạn ${maxPages} trang, dừng tải`);
                        break;
                    }
                    
                } while (nextPageToken);
                
                console.log(`✅ Hoàn thành! Tổng cộng tìm thấy ${allFiles.length} ảnh trong ${pageCount} trang`);
                
                // Chuyển đổi format để tương thích với hệ thống hiện tại
                const photosData = allFiles.map((file, index) => ({
                    id: file.id,
                    name: file.name || `Ảnh không tên ${index + 1}`,
                    webViewLink: file.webViewLink,
                    thumbnailLink: file.thumbnailLink,
                    createdTime: file.createdTime,
                    modifiedTime: file.modifiedTime,
                    size: parseInt(file.size) || 0,
                    mimeType: file.mimeType || 'image/jpeg',
                    description: file.description || `Ảnh kỷ niệm - ${file.name || `Ảnh ${index + 1}`}`,
                    tags: ['kỷ niệm', 'google-drive'],
                    // Thêm thông tin bổ sung
                    source: 'google-drive',
                    folderId: FOLDER_ID,
                    loadedAt: new Date().toISOString()
                }));
                
                console.log(`📊 Đã xử lý ${photosData.length} ảnh từ Google Drive`);
                return photosData;
                
            } catch (error) {
                console.error('❌ Lỗi tải ảnh từ Google Drive:', error);
                
                if (error.name === 'AbortError') {
                    throw new Error('Timeout khi kết nối Google Drive API (quá 20 giây)');
                }
                
                // Ném lại error với thông tin chi tiết hơn
                throw error;
            }
        }

        async function runAutoSync() {
            try {
                console.log('🔄 Chạy đồng bộ tự động...');
                
                // Update last run time và tính nextRun
                const schedule = getAutoSyncSchedule();
                const now = new Date();
                schedule.lastRun = now.toISOString();
                
                // Tính toán nextRun cho lần chạy tiếp theo
                let nextRun;
                switch (schedule.frequency) {
                    case 'hourly':
                        nextRun = new Date(now.getTime() + 60 * 60 * 1000);
                        break;
                    case 'daily':
                        const [hours, minutes] = schedule.time.split(':');
                        nextRun = new Date(now);
                        nextRun.setDate(nextRun.getDate() + 1);
                        nextRun.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                        break;
                    case 'weekly':
                        nextRun = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
                        break;
                }
                
                schedule.nextRun = nextRun ? nextRun.toISOString() : null;
                await saveAutoSyncSchedule(schedule);
                
                // Thực hiện đồng bộ thực tế với TOÀN BỘ ảnh
                if (FOLDER_ID && API_KEY && GITHUB_USERNAME && REPO_NAME && PAT) {
                    console.log('📥 Bắt đầu tải toàn bộ ảnh từ Google Drive...');
                    
                    const photosFromDrive = await loadPhotosFromGoogleDrive();
                    
                    if (photosFromDrive.length > 0) {
                        console.log(`📸 Đã tải ${photosFromDrive.length} ảnh từ Google Drive`);
                        
                        // Cập nhật dữ liệu local
                        allPhotosData = photosFromDrive;
                        totalPages = Math.ceil(allPhotosData.length / PHOTOS_PER_PAGE);
                        
                        // Lưu TOÀN BỘ metadata vào GitHub
                        await savePhotosMetadata(photosFromDrive);
                        
                        await addAutoSyncLog('Thành công', `Đồng bộ ${photosFromDrive.length} ảnh từ Google Drive và lưu vào GitHub`);
                        
                        console.log(`✅ Auto sync hoàn thành: ${photosFromDrive.length} ảnh đã được lưu vào ${PHOTOS_METADATA_FILE_PATH}`);
                    } else {
                        await addAutoSyncLog('Cảnh báo', 'Không tìm thấy ảnh nào trong Google Drive folder');
                        console.warn('⚠️ Auto sync: Không có ảnh nào trong Google Drive');
                    }
                } else {
                    const missingConfigs = [];
                    if (!FOLDER_ID) missingConfigs.push('FOLDER_ID');
                    if (!API_KEY) missingConfigs.push('API_KEY');
                    if (!GITHUB_USERNAME) missingConfigs.push('GITHUB_USERNAME');
                    if (!REPO_NAME) missingConfigs.push('REPO_NAME');
                    if (!PAT) missingConfigs.push('PAT');
                    
                    await addAutoSyncLog('Lỗi', `Thiếu cấu hình: ${missingConfigs.join(', ')}`);
                    console.warn('⚠️ Auto sync bỏ qua: thiếu cấu hình', missingConfigs);
                }
                
                updateAutoSyncDisplay();
                
                console.log('✅ Đồng bộ tự động hoàn thành. Lần tiếp theo:', nextRun?.toLocaleString('vi-VN'));
                
            } catch (error) {
                console.error('❌ Lỗi auto sync:', error);
                await addAutoSyncLog('Lỗi', `Auto sync thất bại: ${error.message}`);
            }
        }

        function updateAutoSyncDisplay() {
            const schedule = getAutoSyncSchedule();
            const statusElement = document.getElementById('autoSyncStatus');
            const toggleButton = document.getElementById('autoSyncToggle');
            const lastRunElement = document.getElementById('lastAutoSyncTime');
            const nextRunElement = document.getElementById('nextRunTimeValue');
            const nextRunContainer = document.getElementById('nextRunTime');
            
            if (schedule.enabled) {
                statusElement.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium">Trạng thái:</span>
                        <span class="text-green-400">🟢</span>
                    </div>
                `;
                toggleButton.innerHTML = '<i class="fas fa-power-off mr-2"></i>Tắt Tự Động';
                toggleButton.className = 'w-full px-4 py-3 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 rounded-lg text-white font-medium transition-all duration-200 shadow-lg';
            } else {
                statusElement.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium">Trạng thái:</span>
                        <span class="text-red-400">🔴</span>
                    </div>
                `;
                toggleButton.innerHTML = '<i class="fas fa-power-off mr-2"></i>Bật Tự Động';
                toggleButton.className = 'w-full px-4 py-3 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 rounded-lg text-white font-medium transition-all duration-200 shadow-lg';
            }
            
            // Hiển thị thời gian chạy cuối từ config
            if (schedule.lastRun) {
                lastRunElement.textContent = new Date(schedule.lastRun).toLocaleString('vi-VN');
            } else {
                lastRunElement.textContent = 'Chưa chạy';
            }
            
            // Hiển thị thời gian chạy tiếp theo từ config
            if (schedule.nextRun && schedule.enabled) {
                nextRunElement.textContent = new Date(schedule.nextRun).toLocaleString('vi-VN');
                nextRunContainer.classList.remove('hidden');
            } else {
                nextRunContainer.classList.add('hidden');
            }
            
            // Update frequency display từ config
            const frequencySelect = document.getElementById('autoSyncFrequency');
            const timeInput = document.getElementById('autoSyncTime');
            
            if (frequencySelect) {
                frequencySelect.value = schedule.frequency || 'daily';
            }
            
            if (timeInput) {
                timeInput.value = schedule.time || '02:00';
            }
            
            const timeContainer = document.getElementById('timeScheduleContainer');
            if (timeContainer) {
                if (schedule.frequency === 'hourly') {
                    timeContainer.classList.add('hidden');
                } else {
                    timeContainer.classList.remove('hidden');
                }
            }
        }

        async function addAutoSyncLog(status, message) {
            const logs = JSON.parse(localStorage.getItem('autoSyncLogs') || '[]');
            logs.unshift({
                time: new Date().toLocaleString('vi-VN'),
                status: status,
                message: message
            });
            
            // Keep only last 20 logs
            if (logs.length > 20) {
                logs.splice(20);
            }
            
            localStorage.setItem('autoSyncLogs', JSON.stringify(logs));
        }

        function loadAutoSyncLogs() {
            const logs = JSON.parse(localStorage.getItem('autoSyncLogs') || '[]');
            const logsContainer = document.getElementById('autoSyncLogs');
            
            if (logs.length === 0) {
                logsContainer.innerHTML = '<p class="text-gray-400 text-sm">Chưa có log nào</p>';
                return;
            }
            
            logsContainer.innerHTML = logs.map(log => `
                <div class="flex items-start space-x-3 p-2 bg-white bg-opacity-5 rounded text-sm">
                    <span class="text-xs text-gray-400 whitespace-nowrap">${log.time}</span>
                    <span class="flex-1 ${log.status === 'Thành công' ? 'text-green-400' : 'text-red-400'}">${log.message}</span>
                </div>
            `).join('');
        }

        async function loadAutoSyncConfigFromGitHub() {
            try {
                if (!GITHUB_USERNAME || !REPO_NAME || !PAT) {
                    console.log('Không có cấu hình GitHub, sử dụng cấu hình local');
                    return null;
                }

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                
                const response = await fetch(CONFIG_API_URL, {
                    headers: {
                        'Authorization': `token ${PAT}`,
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        console.log('File config chưa tồn tại');
                        return null;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const configContent = JSON.parse(base64Decode(data.content));
                
                if (configContent.AUTO_SYNC) {
                    console.log('✅ Đã tải cấu hình Auto Sync từ GitHub:', configContent.AUTO_SYNC);
                    
                    // Lưu vào localStorage để sử dụng
                    localStorage.setItem('autoSyncSchedule', JSON.stringify(configContent.AUTO_SYNC));
                    
                    return configContent.AUTO_SYNC;
                }
                
                return null;
            } catch (error) {
                console.error('Lỗi khi đọc cấu hình Auto Sync từ GitHub:', error);
                return null;
            }
        }

        // Charts initialization
        function initCharts() {
            // Activity Chart
            const activityCtx = document.getElementById('activityChart');
            if (activityCtx) {
                new Chart(activityCtx, {
                    type: 'line',
                    data: {
                        labels: ['T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'],
                        datasets: [{
                            label: 'Hoạt động',
                            data: [12, 19, 3, 5, 2, 3, 9],
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                labels: { color: '#ffffff' }
                            }
                        },
                        scales: {
                            y: {
                                ticks: { color: '#ffffff' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            },
                            x: {
                                ticks: { color: '#ffffff' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            }
                        }
                    }
                });
            }

            // Event Chart
            const eventCtx = document.getElementById('eventChart');
            if (eventCtx) {
                new Chart(eventCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Kỷ niệm', 'Hẹn hò', 'Du lịch', 'Đặc biệt'],
                        datasets: [{
                            data: [30, 25, 20, 25],
                            backgroundColor: [
                                '#667eea',
                                '#f093fb',
                                '#4facfe',
                                '#43e97b'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                labels: { color: '#ffffff' }
                            }
                        }
                    }
                });
            }

            // Happiness Chart
            const happinessCtx = document.getElementById('happinessChart');
            if (happinessCtx) {
                new Chart(happinessCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Tháng 1', 'Tháng 2', 'Tháng 3', 'Tháng 4', 'Tháng 5', 'Tháng 6'],
                        datasets: [{
                            label: 'Mức độ hạnh phúc (%)',
                            data: [85, 90, 78, 92, 88, 95],
                            backgroundColor: 'rgba(240, 147, 251, 0.8)',
                            borderColor: '#f093fb',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                labels: { color: '#ffffff' }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: { color: '#ffffff' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            },
                            x: {
                                ticks: { color: '#ffffff' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            }
                        }
                    }
                });
            }
        }

        // Form submission handler
        document.addEventListener('DOMContentLoaded', function() {
            const memoryForm = document.getElementById('memoryForm');
            if (memoryForm) {
                memoryForm.addEventListener('submit', addMemory);
            }
        });

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            const dropdowns = ['notificationsDropdown', 'settingsDropdown', 'userMenuDropdown', 'mobileSearchDropdown'];
            
            dropdowns.forEach(dropdownId => {
                const dropdown = document.getElementById(dropdownId);
                if (dropdown) {
                    const isClickInside = dropdown.contains(event.target);
                    const isToggleButton = event.target.closest('[onclick*="toggle"]');
                    
                    if (!isClickInside && !isToggleButton) {
                        dropdown.classList.add('hidden');
                    }
                }
            });
            
            // Close mobile sidebar when clicking outside on mobile
            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
                const isClickInSidebar = sidebar.contains(event.target);
                const isToggleButton = event.target.closest('button[onclick*="toggleSidebar"]') || 
                                     event.target.closest('i.fa-bars') ||
                                     event.target.closest('.fas.fa-bars');
                
                // Check if we're on mobile (sidebar has mobile-open class)
                if (sidebar.classList.contains('mobile-open')) {
                    // Close sidebar if clicking outside sidebar and not on toggle button
                    if (!isClickInSidebar && !isToggleButton) {
                        sidebar.classList.remove('mobile-open');
                        console.log('🍔 Đóng sidebar do click outside');
                    }
                }
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            // ESC to close modals
            if (event.key === 'Escape') {
                const modals = ['addMemoryModal', 'googleDriveSyncModal', 'photoModal'];
                modals.forEach(modalId => {
                    const modal = document.getElementById(modalId);
                    if (modal && !modal.classList.contains('hidden')) {
                        closeModal(modalId);
                    }
                });
                
                const photoModal = document.getElementById('photoModal');
                if (photoModal && photoModal.style.display === 'flex') {
                    closePhotoModal();
                }
            }
            
            // Arrow keys for photo navigation in modal
            const photoModal = document.getElementById('photoModal');
            if (photoModal && !photoModal.classList.contains('hidden')) {
                if (event.key === 'ArrowLeft') {
                    event.preventDefault();
                    previousPhoto();
                } else if (event.key === 'ArrowRight') {
                    event.preventDefault();
                    nextPhoto();
                }
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'988ac17fb72925e5',t:'MTc1OTQ3Njg1NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
