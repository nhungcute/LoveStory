<!doctype html>
<html lang="vi" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Love Story</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <style>
        body {
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
        }
        
        * {
            font-feature-settings: "kern" 1;
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        :root {
            --primary-color: #006B68;
            --secondary-color: #FFC62F;
            --accent-color: #FFFFFF;
            --text-color: #1F2937;
            --bg-color: #F9FAFB;
            --border-color: #E5E7EB;
            --shadow-color: rgba(0, 107, 104, 0.1);
        }

        .theme-spring {
            --primary-color: #10B981;
            --secondary-color: #F59E0B;
            --accent-color: #ECFDF5;
            --text-color: #065F46;
            --bg-color: #F0FDF4;
            --border-color: #D1FAE5;
            --shadow-color: rgba(16, 185, 129, 0.1);
        }

        .theme-summer {
            --primary-color: #F59E0B;
            --secondary-color: #EF4444;
            --accent-color: #FEF3C7;
            --text-color: #92400E;
            --bg-color: #FFFBEB;
            --border-color: #FDE68A;
            --shadow-color: rgba(245, 158, 11, 0.1);
        }

        .theme-night {
            --primary-color: #6366F1;
            --secondary-color: #8B5CF6;
            --accent-color: #1F2937;
            --text-color: #F9FAFB;
            --bg-color: #111827;
            --border-color: #374151;
            --shadow-color: rgba(99, 102, 241, 0.2);
        }

        .theme-romantic {
            --primary-color: #EC4899;
            --secondary-color: #F97316;
            --accent-color: #FDF2F8;
            --text-color: #BE185D;
            --bg-color: #FEF7FF;
            --border-color: #FBCFE8;
            --shadow-color: rgba(236, 72, 153, 0.1);
        }

        .theme-ocean {
            --primary-color: #0EA5E9;
            --secondary-color: #06B6D4;
            --accent-color: #F0F9FF;
            --text-color: #0C4A6E;
            --bg-color: #F8FAFC;
            --border-color: #BAE6FD;
            --shadow-color: rgba(14, 165, 233, 0.1);
        }

        .bg-primary { background-color: var(--primary-color); }
        .bg-secondary { background-color: var(--secondary-color); }
        .bg-accent { background-color: var(--accent-color); }
        .text-primary { color: var(--primary-color); }
        .text-secondary { color: var(--secondary-color); }
        .text-custom { color: var(--text-color); }
        .bg-custom { background-color: var(--bg-color); }
        .border-custom { border-color: var(--border-color); }

        .love-card {
            background-color: var(--accent-color);
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 6px var(--shadow-color);
            transition: all 0.3s ease;
        }

        .love-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px var(--shadow-color);
        }

        .love-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .love-button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .love-button.secondary {
            background-color: var(--secondary-color);
        }

        .love-input {
            border: 2px solid var(--border-color);
            background-color: var(--accent-color);
            color: var(--text-color);
            padding: 0.75rem;
            border-radius: 0.5rem;
            outline: none;
            transition: all 0.3s ease;
        }

        .love-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--shadow-color);
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--accent-color);
            border-radius: 1rem;
            padding: 2rem;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal.show .modal-content {
            transform: scale(1);
        }

        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .grid-view-1 { grid-template-columns: 1fr; }
        .grid-view-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-view-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-view-4 { grid-template-columns: repeat(4, 1fr); }
        .grid-view-5 { grid-template-columns: repeat(5, 1fr); }
        .grid-view-6 { grid-template-columns: repeat(6, 1fr); }

        @media (max-width: 768px) {
            .mobile-hide-title { display: none; }
        }

        @media (min-width: 769px) {
            .grid-view-2 { grid-template-columns: repeat(2, 1fr); }
        }

        .timeline-item {
            position: relative;
            padding-left: 1rem;
            border-left: 2px solid var(--primary-color);
            margin-bottom: 2rem;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -6px;
            top: 0;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--primary-color);
        }

        .photo-grid {
            display: grid;
            gap: 1rem;
            padding: 1rem;
        }

        .photo-item {
            aspect-ratio: 1;
            overflow: hidden;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .photo-item:hover {
            transform: scale(1.05);
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .list-view .photo-item {
            aspect-ratio: auto;
            display: flex;
            align-items: center;
            padding: 1rem;
            background-color: var(--accent-color);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .list-view .photo-item img {
            width: 80px;
            height: 80px;
            border-radius: 0.5rem;
            margin-right: 1rem;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .status-online { background-color: #10B981; }
        .status-offline { background-color: #EF4444; }

        .footer {
            margin-top: auto;
            padding: 2rem;
            text-align: center;
            border-top: 1px solid var(--border-color);
            background-color: var(--accent-color);
        }

        /* Header Menu Styles */
        .menu-icon.active {
            background-color: var(--primary-color) !important;
        }

        .menu-icon:not(.active) {
            background-color: #6B7280;
        }

        /* Theme Radio Button Styles */
        .theme-radio-default,
        .theme-radio-spring,
        .theme-radio-summer,
        .theme-radio-night,
        .theme-radio-romantic,
        .theme-radio-ocean {
            position: relative;
			display: none;
        }

        .theme-radio-default.selected,
        .theme-radio-spring.selected,
        .theme-radio-summer.selected,
        .theme-radio-night.selected,
        .theme-radio-romantic.selected,
        .theme-radio-ocean.selected {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .theme-radio-default.selected::after,
        .theme-radio-spring.selected::after,
        .theme-radio-summer.selected::after,
        .theme-radio-night.selected::after,
        .theme-radio-romantic.selected::after,
        .theme-radio-ocean.selected::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 6px;
            height: 6px;
            background-color: white;
            border-radius: 50%;
        }

        /* Toggle Switch Styles */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--primary-color);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        .log-pending {
            background-color: #FEF3C7 !important;
            border-left: 4px solid #F59E0B;
        }

        .log-saved {
            background-color: var(--accent-color);
        }
		
		/* AI Mode Button Styling */
        .ai-mode-btn {
            color: white;
            background-color: transparent;
            transition: all 0.2s ease;
            opacity: 0.7;
        }
        .ai-mode-btn.active {
            background-color: white;
            color: var(--primary-color); /* Use primary color for text */
            font-weight: 600;
            opacity: 1;
        }


    </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full bg-custom text-custom font-sans flex flex-col"><!-- Header -->
  <!--
  <header class="bg-accent border-b border-custom shadow-sm sticky top-0 z-50">
   <div class="container mx-auto px-4 py-3">
    <div class="flex items-center justify-between h-10">
     <div class="flex items-center space-x-3"><button onclick="toggleHeaderMenu()" class="flex-shrink-0 w-10 h-10 bg-primary rounded-full flex items-center justify-center transition-all duration-300" id="headerMenuBtn"> <i class="fas fa-heart text-white text-lg"></i> </button>
      <h1 id="headerTitle" class="text-xl font-bold text-primary whitespace-nowrap transition-all duration-300 hidden md:block">Love Story</h1>
     </div>
     <div id="headerMenuIcons" class="flex-1 flex items-center justify-center space-x-1 transition-opacity duration-300 opacity-0 hidden"><button onclick="selectMenuItem('chat')" class="menu-icon flex-shrink-0 w-10 h-10 bg-gray-500 rounded-full flex items-center justify-center hover:bg-primary" data-section="chat" title="Chat AI"> <i class="fas fa-robot text-white text-sm"></i> </button> <button onclick="selectMenuItem('timeline')" class="menu-icon flex-shrink-0 w-10 h-10 bg-gray-500 rounded-full flex items-center justify-center hover:bg-primary" data-section="timeline" title="Timeline"> <i class="fas fa-clock text-white text-sm"></i> </button> <button onclick="selectMenuItem('photos')" class="menu-icon flex-shrink-0 w-10 h-10 bg-gray-500 rounded-full flex items-center justify-center hover:bg-primary" data-section="photos" title="Khoảnh Khắc"> <i class="fas fa-images text-white text-sm"></i> </button> <button onclick="selectMenuItem('settings')" class="menu-icon flex-shrink-0 w-10 h-10 bg-gray-500 rounded-full flex items-center justify-center hover:bg-primary" data-section="settings" title="Cài Đặt"> <i class="fas fa-cog text-white text-sm"></i> </button>
     </div>
     <div class="flex items-center justify-end space-x-3"><button onclick="toggleHeaderMenu()" class="md:hidden flex-shrink-0 w-10 h-10 bg-gray-200 text-gray-700 rounded-full flex items-center justify-center" id="rightMenuBtn"> <i class="fas fa-bars text-lg"></i> </button> <button onclick="openModal('profileModal')" class="flex items-center space-x-2 love-card rounded-full p-1"> <img src="https://ui-avatars.com/api/?name=Hà+Mạnh+Tín&amp;background=006B68&amp;color=fff" alt="Avatar" class="w-8 h-8 rounded-full"> <span class="hidden md:block font-medium pr-3">Hà Mạnh Tín</span> </button>
     </div>
    </div>
   </div>
  </header>
  --><!-- Main Content -->
  
  <header class="bg-accent border-b border-custom shadow-sm sticky top-0 z-50">
   <div class="container mx-auto px-4 py-3">
    <div class="flex items-center justify-between h-10">
     <div class="flex items-center space-x-3"><button onclick="showSection('home')" class="flex-shrink-0 w-10 h-10 bg-primary rounded-full flex items-center justify-center transition-all duration-300" id="headerMenuBtn"> <i class="fas fa-heart text-white text-lg"></i> </button>
     <h1 id="headerTitle" class="text-xl font-bold text-primary whitespace-nowrap transition-all duration-300 hidden md:block">Love Story</h1>
     </div>
     <div id="headerMenuIcons" class="flex-1 flex items-center justify-center 
space-x-1 transition-opacity duration-300 opacity-0 hidden"><button onclick="selectMenuItem('chat')" class="menu-icon flex-shrink-0 w-10 h-10 bg-gray-500 rounded-full flex items-center justify-center hover:bg-primary" data-section="chat" title="Chat AI"> <i class="fas fa-robot text-white text-sm"></i> </button> <button onclick="selectMenuItem('timeline')" class="menu-icon flex-shrink-0 w-10 h-10 bg-gray-500 rounded-full flex items-center justify-center hover:bg-primary" data-section="timeline" title="Timeline"> <i class="fas fa-clock text-white text-sm"></i> </button> <button onclick="selectMenuItem('photos')" class="menu-icon flex-shrink-0 w-10 h-10 bg-gray-500 rounded-full flex items-center justify-center hover:bg-primary" data-section="photos" title="Khoảnh Khắc"> <i class="fas fa-images text-white text-sm"></i> </button> <button onclick="selectMenuItem('settings')" class="menu-icon flex-shrink-0 w-10 h-10 bg-gray-500 rounded-full flex items-center justify-center hover:bg-primary" data-section="settings" title="Cài Đặt"> <i class="fas fa-cog text-white text-sm"></i> </button>
     </div>
     <div class="flex items-center justify-end 
space-x-3"><button onclick="toggleHeaderMenu()" class="md:hidden flex-shrink-0 w-10 h-10 bg-gray-200 text-gray-700 rounded-full flex items-center justify-center" id="rightMenuBtn"> <i class="fas fa-bars text-lg"></i> </button> <button onclick="openModal('profileModal')" class="flex items-center space-x-2 love-card rounded-full p-1"> 
    <img src="https://ui-avatars.com/api/?name=LS&background=006B68&color=fff" alt="Avatar" class="w-8 h-8 rounded-full"> 
    <span id="userNameDisplay" class="hidden md:block font-medium pr-3"> </span> 
    </button>
     </div>
    </div>
   </div>
  </header>
  
  
  <main class="flex-1 container mx-auto px-4 py-6"><!-- Home Section -->
   <div id="homeSection" class="section">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><!-- Ngày Này Năm Xưa -->
     <div class="lg:col-span-2">
      <div class="love-card rounded-lg p-6">
       <div class="flex items-center mb-4"><i class="fas fa-calendar-day text-primary text-2xl mr-3"></i>
        <h2 class="text-xl font-bold text-primary">Ngày Này Năm Xưa</h2>
       </div>
       <div id="todayMemories">
        <div class="skeleton h-32 rounded mb-4"></div>
       </div>
      </div>
     </div><!-- Thống Kê & Đếm Ngược -->
     <div class="space-y-4">
        <div class="love-card rounded-lg p-4 flex items-center space-x-4">
            <div class="flex-shrink-0 w-12 h-12 bg-primary rounded-full flex items-center justify-center">
                <i class="fas fa-heart text-white text-xl"></i>
            </div>
            <div>
                <p class="text-sm text-gray-500">Ngày bên nhau</p>
                <p class="text-2xl font-bold text-primary" id="daysTogether">0</p>
            </div>
        </div>
        <div class="love-card rounded-lg p-4 flex items-center space-x-4">
            <div class="flex-shrink-0 w-12 h-12 bg-secondary rounded-full flex items-center justify-center">
                <i class="fas fa-star text-white text-xl"></i>
            </div>
            <div>
                <p class="text-sm text-gray-500">Kỷ niệm</p>
                <p class="text-2xl font-bold text-secondary" id="totalMemories">0</p>
            </div>
        </div>
        <div class="love-card rounded-lg p-4 flex items-center space-x-4">
            <div class="flex-shrink-0 w-12 h-12 bg-primary rounded-full flex items-center justify-center">
                <i class="fas fa-images text-white text-xl"></i>
            </div>
            <div>
                <p class="text-sm text-gray-500">Media</p>
                <p class="text-2xl font-bold text-primary" id="totalPhotos">0</p>
            </div>
        </div>
        <div class="love-card rounded-lg p-4 flex items-center space-x-4">
            <div class="flex-shrink-0 w-12 h-12 bg-primary rounded-full flex items-center justify-center">
                <i class="fas fa-clock text-white text-xl"></i>
            </div>
            <div id="upcomingEventsContainer">
                </div>
        </div>
     </div>
    </div>
   </div><!-- Chat AI Section -->
   <div id="chatSection" class="section hidden">
    <div class="max-w-4xl mx-auto">
     <div class="love-card rounded-lg overflow-hidden">
      <div class="bg-primary text-white p-4 flex justify-between items-center">
        <h2 class="text-lg font-bold"><i class="fas fa-robot mr-2"></i>Chat AI</h2>
        <div class="flex space-x-1 border border-white/50 rounded-md p-0.5">
			<button id="aiModeBtn-google" onclick="switchAiModel('google')" class="ai-mode-btn px-2 py-1 text-xs rounded-sm ">Google</button>
            <button id="aiModeBtn-gpt" onclick="switchAiModel('gpt')" class="ai-mode-btn px-2 py-1 text-xs rounded-sm">GPT</button>
           
        </div>
      </div>
      <div class="h-96 overflow-y-auto p-4" id="chatMessages">
      
      </div>
      <div class="border-t border-custom p-4">
       <div class="flex space-x-3"><input type="text" id="chatInput" placeholder="Hỏi AI về kỷ niệm, tìm kiếm sự kiện..." class="love-input flex-1" onkeypress="handleChatKeyPress(event)"> <button onclick="sendChatMessage()" class="love-button"> <i class="fas fa-paper-plane"></i> </button>
       </div>
      </div>
     </div>
    </div>
   </div><!-- Timeline Section -->
   <div id="timelineSection" class="section hidden">
    <div class="flex justify-between items-center mb-6">
     <h2 class="text-xl font-bold text-primary"><i class="fas fa-clock mr-2"></i>Sự Kiện</h2><button onclick="openModal('eventModal')" class="love-button w-10 h-10 rounded-full flex items-center justify-center p-0"> <i class="fas fa-plus"></i> </button>
    </div>
    <div id="timelineContainer">
     <div class="skeleton h-40 rounded mb-4"></div>
     <div class="skeleton h-40 rounded mb-4"></div>
     <div class="skeleton h-40 rounded"></div>
    </div>
   </div><!-- Photos Section -->
   <div id="photosSection" class="section hidden">
    <div class="flex justify-between items-center mb-6">
     <h2 class="text-xl font-bold text-primary"><i class="fas fa-photo-video mr-2"></i>Khoảnh Khắc</h2>
     <div class="flex items-center space-x-3"><button onclick="cyclePhotoView()" class="love-button flex items-center space-x-1 text-sm px-3 py-2" id="viewToggleBtn" style="transform: scale(0.85);"> <i class="fas fa-th text-sm" id="viewToggleIcon"></i> <span id="viewToggleText">2x2</span> </button>
     </div>
    </div>
    <div id="photosContainer" class="photo-grid grid-view-2"><!-- Photos will be loaded here -->
    </div>
    <div id="photosPagination" class="mt-6 flex justify-center items-center"></div><!-- Pagination will be loaded here -->
    </div>
   </div><!-- Settings Section -->
   <div id="settingsSection" class="section hidden">
    <h2 class="text-xl font-bold text-primary mb-6"><i class="fas fa-cog mr-2"></i>Cài Đặt</h2>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><!-- Giao Diện -->
     <div class="love-card rounded-lg p-6">
      <h3 class="text-lg font-bold text-primary mb-4"><i class="fas fa-palette mr-2"></i>Giao Diện</h3>
      <div class="space-y-4">
       <div class="block"><span class="text-sm font-medium mb-3 block">Chọn Theme:</span>
        <div class="grid grid-cols-2 gap-3">
			<label class="flex items-center justify-center space-x-3 cursor-pointer p-3 rounded-lg border border-custom hover:bg-gray-50 transition-colors"> <input type="radio" name="theme" value="default" class="sr-only" onchange="changeThemeRadio('default')">
				<div class="flex items-center space-x-2">
				   <div class="w-5 h-5 rounded-full bg-gradient-to-r from-teal-600 to-yellow-400 border-2 border-white shadow-sm"></div>
				   <div class="w-3 h-3 rounded-full bg-teal-600"></div>
				  </div>
				  <div class="w-4 h-4 rounded-full border-2 border-gray-300 theme-radio-default"></div>
			</label> 
			<label class="flex items-center justify-center space-x-3 cursor-pointer p-3 rounded-lg border border-custom hover:bg-gray-50 transition-colors"> <input type="radio" name="theme" value="spring" class="sr-only" onchange="changeThemeRadio('spring')">
				  <div 
			class="flex items-center space-x-2">
				   <div class="w-5 h-5 rounded-full bg-gradient-to-r from-emerald-500 to-amber-500 border-2 border-white shadow-sm"></div>
				   <div class="w-3 h-3 rounded-full bg-emerald-500"></div>
				  </div>
				  <div class="w-4 h-4 rounded-full border-2 border-gray-300 theme-radio-spring"></div>
			</label> 
			<label class="flex items-center justify-center space-x-3 cursor-pointer p-3 rounded-lg border border-custom hover:bg-gray-50 transition-colors"> <input type="radio" name="theme" value="summer" class="sr-only" onchange="changeThemeRadio('summer')">
				  <div class="flex items-center space-x-2">
		   
					<div class="w-5 h-5 rounded-full bg-gradient-to-r from-amber-500 to-red-500 border-2 border-white shadow-sm"></div>
				   <div class="w-3 h-3 rounded-full bg-amber-500"></div>
				  </div>
				  <div class="w-4 h-4 rounded-full border-2 border-gray-300 theme-radio-summer"></div>
			</label> 
			<label class="flex items-center justify-center space-x-3 cursor-pointer p-3 rounded-lg border border-custom hover:bg-gray-50 transition-colors"> <input type="radio" name="theme" value="night" class="sr-only" onchange="changeThemeRadio('night')">
				  <div class="flex items-center space-x-2">
				
			   <div class="w-5 h-5 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 border-2 border-white shadow-sm"></div>
				   <div class="w-3 h-3 rounded-full bg-indigo-500"></div>
				  </div>
				  <div class="w-4 h-4 rounded-full border-2 border-gray-300 theme-radio-night"></div>
			</label> 
			<label class="flex items-center justify-center space-x-3 cursor-pointer p-3 rounded-lg border border-custom hover:bg-gray-50 transition-colors"> <input type="radio" name="theme" value="romantic" class="sr-only" onchange="changeThemeRadio('romantic')">
				  <div class="flex items-center space-x-2">
				   <div class="w-5 
			h-5 rounded-full bg-gradient-to-r from-pink-500 to-orange-500 border-2 border-white shadow-sm"></div>
				   <div class="w-3 h-3 rounded-full bg-pink-500"></div>
				  </div>
				  <div class="w-4 h-4 rounded-full border-2 border-gray-300 theme-radio-romantic"></div>
			</label> 
			<label class="flex items-center justify-center space-x-3 cursor-pointer p-3 rounded-lg border border-custom hover:bg-gray-50 transition-colors"> <input type="radio" name="theme" value="ocean" class="sr-only" onchange="changeThemeRadio('ocean')">
				  <div class="flex items-center space-x-2">
				   <div class="w-5 h-5 rounded-full bg-gradient-to-r from-sky-500 to-cyan-500 
			border-2 border-white shadow-sm"></div>
				   <div class="w-3 h-3 rounded-full bg-sky-500"></div>
				  </div>
				  <div class="w-4 h-4 rounded-full border-2 border-gray-300 theme-radio-ocean"></div>
			</label>
		</div>
       </div>
       <div class="flex items-center justify-between">
        <div><span class="font-medium">Hiển thị nút menu</span>
         <p class="text-xs text-gray-500 mt-1">Ẩn nút menu trên giao diện</p>
        </div><label class="toggle-switch"> <input type="checkbox" id="showHamburgerMenu" checked onchange="toggleHamburgerMenu()"> <span class="toggle-slider"></span> </label>
       </div>
	   
	   <div class="flex items-center justify-between">
        <div><span class="font-medium">Thông báo hệ thống</span>
         <p class="text-xs text-gray-500 mt-1">Tắt/bật các thông báo giao diện.</p>
        </div><label class="toggle-switch"> <input type="checkbox" id="enableSystemNotifications" onchange="toggleSystemNotifications()"> <span class="toggle-slider"></span> </label>
       </div>
	   
      </div>
     </div><!-- Tự Động Cập Nhật -->
     <div class="love-card rounded-lg p-6">
      <h3 class="text-lg font-bold text-primary mb-4"><i class="fas fa-sync mr-2"></i>Data Google Drive</h3>
      <div class="space-y-4">
       <div class="flex items-center justify-between">
        <div><span class="font-medium">Đồng bộ metadata ảnh từ Google Drive</span>
         <p class="text-xs text-gray-500 mt-1">Tự động tải ảnh từ Google Drive theo lịch</p>
        </div><label class="toggle-switch"> <input type="checkbox" id="autoSync" checked onchange="updateAutoSyncConfig()"> <span class="toggle-slider"></span> </label>
       </div>
       <div class="grid grid-cols-2 gap-4"><label class="block"> <span class="text-sm font-medium mb-2 block">Tần suất:</span> <select id="syncFrequency" class="love-input w-full" onchange="updateAutoSyncConfig()"> <option value="daily">Hàng ngày</option> <option value="weekly">Hàng tuần</option> <option value="monthly">Hàng tháng</option> <option value="once">1 lần</option> </select> </label> <label class="block"> <span class="text-sm font-medium mb-2 block">Thời gian:</span> <input type="text" id="syncTime" class="love-input w-full" value="09:04" placeholder="HH:MM" maxlength="5" oninput="formatTimeInput(this)" onchange="updateAutoSyncConfig()"> </label>
       </div>
       <div class="flex space-x-3"><button onclick="manualSync()" class="love-button w-full"> <i class="fas fa-sync mr-2"></i>Đồng Bộ Thủ Công</button>
       </div>
       <div class="flex space-x-3 mt-2"><button onclick="saveAppConfig()" class="love-button secondary w-full"> <i class="fas fa-save mr-2"></i>Lưu</button>
       </div>
      </div>
     </div><!-- Nhật ký hoạt động -->
     <div class="love-card rounded-lg p-6">
      <h3 class="text-lg font-bold text-primary mb-4"><i class="fas fa-file-alt mr-2"></i>Nhật Ký Hoạt Động</h3>
      <div class="space-y-4">
       <div class="flex items-center justify-between">
        <div><span class="font-medium">Bật ký hoạt động</span>
         <p class="text-xs text-gray-500 mt-1">Lưu hoạt động người dùng</p>
        </div><label class="toggle-switch"> <input type="checkbox" id="enableLogs" checked onchange="updateLogsConfig()"> <span class="toggle-slider"></span> </label>
       </div>
       <div class="space-y-2 text-sm">
        <div class="flex justify-between"><span>Tổng số bản ghi:</span> <span class="font-bold" id="totalLogs">1,247</span>
        </div>
        <div class="flex justify-between"><span>Đã lưu file:</span> <span class="font-bold text-green-600" id="savedLogs">0</span>
        </div>
        <div class="flex justify-between"><span>Chờ lưu file:</span> <span class="font-bold text-orange-600" id="pendingLogs">0</span>
        </div>
       </div><button onclick="openModal('logsModal')" class="love-button w-full"> <i class="fas fa-eye mr-2"></i>Chi Tiết Nhật Ký </button>
      </div>
     </div><!-- Thông Tin Hệ Thống -->
     <div class="love-card rounded-lg p-6">
      <h3 class="text-lg font-bold text-primary mb-4"><i class="fas fa-info-circle mr-2"></i>Thông Tin Hệ Thống</h3>
      <div class="space-y-3 text-sm">
       <div class="flex justify-between"><span>Phiên bản:</span> <span class="font-bold">v2.1.0</span>
       </div>
       <div class="flex justify-between"><span>GitHub:</span> <span class="flex items-center"> <span class="status-indicator status-online"></span> <span class="font-bold text-green-600">Conn..</span> </span>
       </div>
       <div class="flex justify-between"><span>Google Drive:</span> <span class="flex items-center"> <span class="status-indicator status-online"></span> <span class="font-bold text-green-600">Conn..</span> </span>
       </div>
       <div class="flex justify-between"><span>Dung lượng sử dụng:</span> <span id="storageUsageDisplay" class="font-bold">Đang tính...</span>
       </div>
       <div class="flex justify-between"><span>Trạng thái:</span> <span class="flex items-center"> <span class="status-indicator status-online"></span> <span class="font-bold text-green-600" id="onlineStatus">Onl</span> </span>
       </div>
      </div>
     </div>
    </div>
   </div>
  </main><!-- Footer -->
  <footer class="footer">
   <div class="text-center text-sm text-gray-600">
    <p class="font-medium">Bản quyền thuộc về: Hà Mạnh Tín</p>
    <p>© 2025 - Ứng dụng kỷ niệm</p>
   </div>
  </footer><!-- Modals --> <!-- Search Modal -->
  <div id="searchModal" class="modal">
   <div class="modal-content w-full max-w-2xl">
    <div class="flex justify-between items-center mb-4">
     <h3 class="text-xl font-bold text-primary"><i class="fas fa-search mr-2"></i>Tìm Kiếm &amp; AI</h3><button onclick="closeModal('searchModal')" class="text-gray-500 hover:text-gray-700"> <i class="fas fa-times text-xl"></i> </button>
    </div>
    <div class="space-y-4"><input type="text" id="searchInput" placeholder="Tìm kiếm sự kiện, hỏi AI..." class="love-input w-full">
     <div class="grid grid-cols-2 md:grid-cols-4 gap-2"><button class="love-button text-sm" onclick="quickSearch('sinh nhật')">Sinh nhật</button> <button class="love-button text-sm" onclick="quickSearch('du lịch')">Du lịch</button> <button class="love-button text-sm" onclick="quickSearch('kỷ niệm')">Kỷ niệm</button> <button class="love-button text-sm" onclick="quickSearch('thống kê')">Thống kê</button>
     </div>
     <div id="searchResults" class="max-h-60 overflow-y-auto"><!-- Search results will appear here -->
     </div>
    </div>
   </div>
  </div><!-- Profile Modal -->
  <div id="profileModal" class="modal">
   <div class="modal-content w-full max-w-md">
    <div class="flex justify-between items-center mb-4">
     <h3 class="text-xl font-bold text-primary"><i class="fas fa-user mr-2"></i>Hồ Sơ Cá Nhân</h3><button onclick="closeModal('profileModal')" class="text-gray-500 hover:text-gray-700"> <i class="fas fa-times text-xl"></i> </button>
    </div>
    <div class="text-center mb-6">
        <div class="relative w-20 h-20 mx-auto mb-3">
            <img id="profileAvatarImg" src="https://ui-avatars.com/api/?name=Hà+Mạnh+Tín&background=006B68&color=fff&size=100" alt="Avatar" class="w-20 h-20 rounded-full">
            <button onclick="triggerAvatarUpload()" class="absolute -bottom-1 -right-1 w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white hover:opacity-90 border-2 border-white">
                <i class="fas fa-camera text-sm"></i>
            </button>
        </div>
        <input type="file" id="avatarUpload" class="hidden" accept="image/*" onchange="handleAvatarUpload(event)">
    </div>
    <div class="space-y-4">
        <label class="block"> <span class="text-sm font-medium mb-2 block">Họ tên:</span> <input type="text" id="profileNameInput" value="" class="love-input w-full"> </label> 
        <label class="block"> <span class="text-sm font-medium mb-2 block">Tên đăng nhập:</span> <input type="text" id="profileUsernameInput" value="" class="love-input w-full" onchange="checkExistingUsername()"> </label>
	 <div class="love-card rounded p-3">
      <h4 class="font-medium mb-2">Thông tin thiết bị:</h4>
      <div class="text-sm space-y-1">
       <p>IP: 192.168.1.100</p>
       <p>Trình duyệt: Chrome 120.0</p>
       <p>Hệ điều hành: Windows 11</p>
      </div>
     </div>
     <div class="flex space-x-3">
        <button class="love-button flex-1" onclick="saveProfile()">Lưu Thay Đổi</button> 
        <button class="love-button secondary" onclick="logoutProfile()">Đăng Xuất</button>
     </div>
    </div>
   </div>
  </div><!-- Event Modal -->
  <div id="eventModal" class="modal">
   <div class="modal-content w-full max-w-lg">
    <div class="flex justify-between items-center mb-4">
     <h3 class="text-xl font-bold text-primary"><i class="fas fa-plus mr-2"></i>Thêm Sự Kiện</h3><button onclick="closeModal('eventModal')" class="text-gray-500 hover:text-gray-700"> <i class="fas fa-times text-xl"></i> </button>
    </div>
    <form id="eventForm" onsubmit="saveEvent(event)">
     <div class="space-y-4"><label class="block"> <span class="text-sm font-medium mb-2 block">Tên sự kiện:</span> <input type="text" id="eventName" required class="love-input w-full" placeholder="Ví dụ: Sinh nhật lần thứ 25"> </label> <label class="block"> <span class="text-sm font-medium mb-2 block">Ngày:</span> <input type="text" id="eventDate" required class="love-input w-full" placeholder="dd-mm-yyyy" pattern="\d{2}-\d{2}-\d{4}" maxlength="10" oninput="formatDateInput(this)"> </label> <label class="block"> <span class="text-sm font-medium mb-2 block">Mô tả:</span> <textarea id="eventDescription" rows="3" class="love-input w-full" placeholder="Mô tả chi tiết về sự kiện..."></textarea> </label>
      <div><span class="text-sm font-medium mb-2 block">Ảnh:</span> <button type="button" onclick="openModal('imageSelectorModal')" class="love-button w-full"> <i class="fas fa-images mr-2"></i>Chọn Ảnh </button>
       <p class="text-xs text-gray-500 mt-1">Đã chọn: <span id="selectedImagesCount">0</span> ảnh</p>
      </div>
      <div class="flex space-x-3"><button type="submit" class="love-button flex-1">Lưu Sự Kiện</button> <button type="button" onclick="closeModal('eventModal')" class="love-button secondary">Hủy</button>
      </div>
     </div>
    </form>
   </div>
  </div><!-- Photo Modal -->
  <div id="photoModal" class="modal">
   <div class="modal-content w-full max-w-4xl" style="padding: 1rem;">
    <div class="flex justify-between items-center mb-4">
     <h3 class="text-xl font-bold text-primary"><i class="fas fa-image mr-2"></i>Xem Ảnh</h3><button onclick="closeModal('photoModal')" class="text-gray-500 hover:text-gray-700"> <i class="fas fa-times text-xl"></i> </button>
    </div>
    <div class="text-center mb-4"><img id="modalPhoto" src="" alt="" class="mx-auto rounded-lg" style="max-width: 100%; max-height: 50vh; width: auto; height: auto; object-fit: contain;" referrerpolicy="no-referrer">
    </div>
    <div class="flex justify-center space-x-3 mb-4"><button id="likeButton" onclick="toggleLike()" class="love-button" style="transform: scale(0.95);"> <i id="likeIcon" class="fas fa-heart mr-2"></i><span id="likeText">Thích</span> (<span id="likeCount">0</span>) </button> <button onclick="openShareModal()" class="love-button" style="transform: scale(0.95);"> <i class="fas fa-share mr-2"></i>Chia Sẻ </button> <button onclick="downloadPhoto()" class="love-button" style="transform: scale(0.95);"> <i class="fas fa-download mr-2"></i>Tải Về </button>
    </div>
    <div class="love-card rounded" style="padding: 0.5rem;">
     <h4 class="font-medium mb-3">Bình luận:</h4>
     <div id="commentsContainer" class="space-y-2 mb-4 max-h-32 overflow-y-auto">
      <div class="text-sm text-gray-500">
       Chưa có bình luận nào
      </div>
     </div>
     <div class="flex space-x-2"><input type="text" id="commentInput" placeholder="Thêm bình luận..." class="love-input flex-1" onkeypress="handleCommentKeyPress(event)"> <button onclick="addComment()" class="love-button"><i class="fas fa-paper-plane"></i></button>
     </div>
    </div>
   </div>
  </div><!-- Share Modal -->
  <div id="shareModal" class="modal">
   <div class="modal-content w-full max-w-md">
    <div class="flex justify-between items-center mb-4">
     <h3 class="text-xl font-bold text-primary"><i class="fas fa-share mr-2"></i>Chia Sẻ</h3><button onclick="closeModal('shareModal')" class="text-gray-500 hover:text-gray-700"> <i class="fas fa-times text-xl"></i> </button>
    </div>
    <div class="space-y-4">
     <div class="love-card rounded p-3"><label class="text-sm font-medium mb-2 block">Link chia sẻ:</label>
      <div class="flex space-x-2"><input type="text" id="shareLink" readonly class="love-input flex-1 text-sm"> <button onclick="copyShareLink()" class="love-button">Copy</button>
      </div>
     </div>
     <div class="grid grid-cols-2 gap-3"><button onclick="shareToFacebook()" class="love-button"> <i class="fab fa-facebook mr-2"></i>Facebook </button> <button onclick="shareToTwitter()" class="love-button"> <i class="fab fa-twitter mr-2"></i>Twitter </button> <button onclick="shareToTelegram()" class="love-button"> <i class="fab fa-telegram mr-2"></i>Telegram </button> <button onclick="generateQRCode()" class="love-button"> <i class="fas fa-qrcode mr-2"></i>Tạo QR </button>
     </div>
     <div id="qrCodeContainer" class="text-center mt-4 hidden"><img id="qrCodeImage" src="" alt="QR Code" class="w-32 h-32 mx-auto rounded">
      <p class="text-xs text-gray-500 mt-2">Quét mã QR để xem ảnh</p>
     </div>
    </div>
   </div>
  </div><!-- Image Selector Modal -->
  <div id="imageSelectorModal" class="modal">
   <div class="modal-content w-full max-w-4xl">
    <div class="flex justify-between items-center mb-4">
     <h3 class="text-xl font-bold text-primary"><i class="fas fa-images mr-2"></i>Chọn Ảnh</h3><button onclick="closeModal('imageSelectorModal')" class="text-gray-500 hover:text-gray-700"> <i class="fas fa-times text-xl"></i> </button>
    </div>
    <div class="flex justify-between items-center mb-4">
     <div class="flex space-x-2"><button onclick="selectAllImages()" class="love-button">Chọn Tất Cả</button> <button onclick="deselectAllImages()" class="love-button secondary">Bỏ Chọn</button>
     </div><span class="text-sm text-gray-600">Đã chọn: <span id="selectedCount">0</span></span>
    </div>
    <div class="grid grid-cols-4 md:grid-cols-6 gap-3 max-h-96 overflow-y-auto mb-4" id="imageSelector"><!-- Images will be loaded here -->
    </div>
    <div class="flex justify-between items-center">
     <div class="flex space-x-2"><button class="love-button text-sm">←</button> <span class="text-sm text-gray-600">Trang 1 / 10</span> <button class="love-button text-sm">→</button>
     </div><button onclick="confirmImageSelection()" class="love-button">Xác Nhận</button>
    </div>
   </div>
  </div><!-- Event Photos Modal -->
  <div id="eventPhotosModal" class="modal">
   <div class="modal-content w-full max-w-4xl">
    <div class="flex justify-between items-center mb-4">
     <h3 class="text-xl font-bold text-primary"><i class="fas fa-images mr-2"></i>Ảnh Sự Kiện</h3><button onclick="closeModal('eventPhotosModal')" class="text-gray-500 hover:text-gray-700"> <i class="fas fa-times text-xl"></i> </button>
    </div>
    <div id="eventPhotosGrid" class="grid grid-cols-3 md:grid-cols-4 gap-3 max-h-96 overflow-y-auto"><!-- Event photos will be loaded here -->
    </div>
   </div>
  </div><!-- Logs Modal -->
  <div id="logsModal" class="modal">
   <div class="modal-content w-full max-w-3xl">
    <div class="flex justify-between items-center mb-4">
     <h3 class="text-xl font-bold text-primary"><i class="fas fa-file-alt mr-2"></i>Nhật Ký Hoạt Động</h3><button onclick="closeModal('logsModal')" class="text-gray-500 hover:text-gray-700"> <i class="fas fa-times text-xl"></i> </button>
    </div>
    <div class="flex justify-between items-center mb-4">
     <div class="flex space-x-2"><button onclick="clearAllLogs()" class="love-button secondary text-xs px-3 py-1">Xóa Tất Cả</button> <button onclick="exportLogs()" class="love-button text-xs px-3 py-1">Xuất File</button>
     </div>
     <div class="flex items-center space-x-2"><label class="text-sm">Lọc:</label> <select id="logFilter" onchange="filterLogs()" class="love-input text-xs px-2 py-1"> <option value="all">Tất cả</option> <option value="Điều hướng">Điều hướng</option> <option value="Thêm sự kiện mới">Thêm sự kiện</option> <option value="Cập nhật sự kiện">Sửa sự kiện</option> <option value="Xóa sự kiện">Xóa sự kiện</option> <option value="Đồng bộ media">Đồng bộ</option> <option value="Thay đổi theme">Cài đặt</option> <option value="Mở modal">Modal</option> <option value="Tương tác ảnh">Tương tác</option> <option value="Chọn ảnh">Chọn ảnh</option> <option value="Chat AI">Chat AI</option> <option value="Thay đổi chế độ xem">Chế độ xem</option> <option value="Phân trang ảnh">Phân trang</option> </select>
     </div>
    </div>
    <div id="logsContainer" class="space-y-3 max-h-96 overflow-y-auto"><!-- Logs will be loaded here -->
    </div>
   </div>
  </div>
  <script>
        // Global variables
        let currentSection = 'home';
        
		// 1. Kiểm tra xem có phải thiết bị di động không (dựa theo CSS media query)
        const isMobile = window.innerWidth <= 768;
		
        let photoViewCycle = ['grid-2', 'grid-3', 'grid-4', 'grid-5', 'grid-6', 'grid-1', 'list'];
        let currentViewIndex = isMobile ? 0 : 4; // Bắt đầu với grid-2 (di dong), và grid 6 nếu khong phai di dong
        let currentPhotoView = photoViewCycle[currentViewIndex];
        let selectedImages = [];
        let logQueue = [];
        let isOnline = navigator.onLine;
        let pendingLogs = 0;
        let currentUser = null;
        let currentPage = 1;
        let editingEventId = null;
        let currentPhotoId = null;
        let currentPhotoName = null;
		let todayValidMemories = []; // Lưu danh sách kỷ niệm cho hôm nay
        let currentMemoryIndex = 0; // Vị trí kỷ niệm đang xem
		let currentAiModel = 'google'; // Default AI model ('gpt', 'google')
		
        // Configuration
        let config = {
            "GITHUB_USERNAME": "nhungcute",
            "REPO_NAME": "LoveStory",
            "PAT1": "ghp_a8VLpoCYQByLbUIwe",
            "PAT2": "d3dy4hHjEpKwr3stE6T",
            "CONFIG_FILE_PATH": "configApp.json"
        };
		let appConfigData = {};
  
        // Data storage
        let eventsData = [];
        let photosData = [];
        let commentsData = [];
        let profilesData = [];
        let logsData = [];
		
		// Thêm 2 dòng này (khoảng dòng 595)
        const imageErrorPlaceholder = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjQwMCIgdmlld0JveD0iMCAwIDQwMCA0MDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI0MDAiIGhlaWdodD0iNDAwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0yMDAgMTAwQzE4MC4xIDEwMCAxNjQuNCAxMTUuNyAxNjQuNCAxMzUuNkMxNjQuNCAxNTUuNSAxODAuMSAxNzEuMiAyMDAgMTcxLjJDMjE5LjkgMTcxLjIgMjM1LjYgMTU1LjUgMjM1LjYgMTM1LjZDMjM1LjYgMTE1LjcgMjE5LjkgMTAwIDIwMCAxMDBaIiBmaWxsPSIjOUI5QkEwIi8+CjxwYXRoIGQ9Ik0xMDAgMzAwSDE1MEwyMDAgMjUwTDI1MCAzMDBIMzAwVjI1MEwyNTAgMjAwTDIwMCAyNTBMMTUwIDIwMEwxMDAgMjUwVjMwMFoiIGZpbGw9IiM5QjlCQTAiLz4KPC9zdmc+';

        function getGridThumbnailUrl(media) {
            if (media.thumbnailLink && media.thumbnailLink.includes('=')) {
                // Hack URL của Google để lấy ảnh 400px (nét hơn 220px)
                return media.thumbnailLink.replace(/=s\d+/, '=s400');
            }
            // Dùng link gốc hoặc link đã tạo
            return media.thumbnailLink || driveAPI.generateThumbnailLink(media.id, media.mimeType);
        }
		
        // GitHub API helper
        class GitHubAPI {
            constructor() {
                this.baseURL = 'https://api.github.com';
                this.token = config.PAT1 + config.PAT2;
            }

            async getFile(filePath) {
                try {
                    const response = await fetch(`${this.baseURL}/repos/${config.GITHUB_USERNAME}/${config.REPO_NAME}/contents/${filePath}`, {
                        headers: {
                            'Authorization': `token ${this.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        // 1. Giải mã Base64 ra chuỗi nhị phân
                        const binaryString = atob(data.content);
                        
                        // 2. Chuyển chuỗi nhị phân thành một mảng các byte
                        const bytes = new Uint8Array(binaryString.length);
                        for (let i = 0; i < binaryString.length; i++) {
                            bytes[i] = binaryString.charCodeAt(i);
                        }
                        
                        // 3. Dùng TextDecoder để giải mã mảng byte theo chuẩn UTF-8
                        const decodedString = new TextDecoder('utf-8').decode(bytes);
                        
                        // 4. Phân tích chuỗi JSON đã được giải mã đúng
                        return JSON.parse(decodedString);
                    }
                    return [];
                } catch (error) {
                    console.error(`Error loading ${filePath}:`, error);
                    return [];
                }
            }

            async updateFile(filePath, content, message) {
                try {
                    // Lấy SHA của file hiện tại (logic này giữ nguyên)
                    const currentFile = await fetch(`${this.baseURL}/repos/${config.GITHUB_USERNAME}/${config.REPO_NAME}/contents/${filePath}`, {
                        headers: {
                            'Authorization': `token ${this.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    let sha = null;
                    if (currentFile.ok) {
                        const fileData = await currentFile.json();
                        sha = fileData.sha;
                    }

                    const jsonString = JSON.stringify(content, null, 2);
                    const utf8Bytes = new TextEncoder().encode(jsonString);

                    // Xử lý dữ liệu theo từng đoạn nhỏ để tránh lỗi stack overflow
                    let binaryString = '';
                    const chunkSize = 8192; // Xử lý 8KB mỗi lần
                    for (let i = 0; i < utf8Bytes.length; i += chunkSize) {
                        const chunk = utf8Bytes.subarray(i, i + chunkSize);
                        binaryString += String.fromCharCode.apply(null, chunk);
                    }
                    const base64String = btoa(binaryString);

                    // Gửi yêu cầu cập nhật file (logic này giữ nguyên)
                    const response = await fetch(`${this.baseURL}/repos/${config.GITHUB_USERNAME}/${config.REPO_NAME}/contents/${filePath}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${this.token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: message,
                            content: base64String,
                            sha: sha
                        })
                    });
                    return response.ok;
                } catch (error) {
                    console.error(`Error updating ${filePath}:`, error);
                    return false;
                }
            }
        }

        // Google Drive API helper
        class GoogleDriveAPI {
            constructor() {
                this.apiKey = config.API_KEY;
                this.folderId = config.FOLDER_ID;
            }

            async getAllMediaFiles() {
                try {
                    let allFiles = [];
                    let nextPageToken = null;
                    let pageNumber = 1;
                    
                    do {
                        // Xây dựng URL truy vấn để lấy tất cả media (ảnh và video)
                        // pageSize=1000 để yêu cầu tối đa 1000 file mỗi lần gọi
                        let url = `https://www.googleapis.com/drive/v3/files?q='${this.folderId}'+in+parents+and+(mimeType+contains+'image/'+or+mimeType+contains+'video/')&key=${this.apiKey}&fields=files(id,name,createdTime,modifiedTime,size,webViewLink,thumbnailLink,mimeType,parents,webContentLink),nextPageToken&pageSize=1000`;
                        
                        // Nếu có token của trang tiếp theo, thêm nó vào URL
                        if (nextPageToken) {
                            url += `&pageToken=${nextPageToken}`;
                        }
                        
                        const response = await fetch(url);
                        if (response.ok) {
                            const data = await response.json();
                            // Chuyển đổi định dạng file cho phù hợp với ứng dụng
                            const transformedFiles = data.files.map((file, index) => ({
                                id: file.id,
                                name: file.name,
                                webViewLink: file.webViewLink || `https://drive.google.com/file/d/${file.id}/view?usp=drivesdk`,
                                webContentLink: file.webContentLink || `https://drive.google.com/uc?export=download&id=${file.id}`,
                                thumbnailLink: file.thumbnailLink || this.generateThumbnailLink(file.id, file.mimeType),
                                createdTime: file.createdTime,
                                modifiedTime: file.modifiedTime || file.createdTime,
                                size: parseInt(file.size) || 0,
                                mimeType: file.mimeType,
                                description: this.generateDescription(file.name, file.mimeType),
                                source: "google-drive",
                                folderId: this.folderId,
                                loadedAt: new Date().toISOString(),
                                pageNumber: pageNumber,
                                fileType: file.mimeType.startsWith('image/') ? 'image' : 'video',
                                parents: file.parents || [this.folderId]
                            }));
                            
                            // Nối các file của trang này vào danh sách tổng
                            allFiles = allFiles.concat(transformedFiles);
                            // Lấy token cho trang kế tiếp
                            nextPageToken = data.nextPageToken;
                            pageNumber++;
                            
                            console.log(`Đã tải trang ${pageNumber - 1}: ${transformedFiles.length} files (Tổng: ${allFiles.length})`);
                        } else {
                            console.error('Lỗi khi gọi Google Drive API:', response.status, response.statusText);
                            break; // Dừng lại nếu có lỗi
                        }
                        
                    } while (nextPageToken); // Lặp lại nếu vẫn còn trang tiếp theo
                    
                    console.log(`Hoàn thành đồng bộ: ${allFiles.length} files từ ${pageNumber - 1} trang.`);
                    return allFiles;
                } catch (error) {
                    console.error('Lỗi khi tải media files:', error);
                    return [];
                }
            }

            generateThumbnailLink(fileId, mimeType) {
                return `https://drive.google.com/thumbnail?id=${fileId}&sz=w300-h300`;
            }

            generateDescription(fileName, mimeType) {
                const fileType = mimeType.startsWith('image/') ? 'Ảnh' : 'Video';
                return `${fileType} kỷ niệm - ${fileName}`;
            }

            async getPhotosMetadata() {
                // Backward compatibility - filter only images
                const allFiles = await this.getAllMediaFiles();
                return allFiles.filter(file => file.mimeType.startsWith('image/'));
            }

            getImageUrl(fileId, type = 'view') {
				const urls = {
					// Endpoint chính xác để xem ảnh (có thể cần quyền truy cập)
					view: `https://drive.google.com/uc?export=view&id=${fileId}`,
					// Endpoint thumbnail
					thumbnail: `https://drive.google.com/thumbnail?id=${fileId}&sz=w400-h300-c`,
					// Endpoint tải về trực tiếp
					direct: `https://drive.google.com/uc?export=download&id=${fileId}`,
					// SỬA: Dùng 'view' cho highQuality
					highQuality: `https://drive.google.com/uc?export=view&id=${fileId}`,
					fallback: `https://drive.google.com/file/d/${fileId}/view`
				};
				return urls[type] || urls.view;
			}
        }
 
        // Initialize API instances
        const githubAPI = new GitHubAPI();
        const driveAPI = new GoogleDriveAPI(); 

        // Data loading functions
        async function loadAllData() {
            try {
                showLoadingState();
                
                // --- BƯỚC 1: Tải file config chính TRƯỚC TIÊN ---
                try {
                    // Gán trực tiếp nội dung file JSON vào appConfigData
                    appConfigData = await githubAPI.getFile(config.CONFIG_FILE_PATH);
                    
                    if (!appConfigData || Object.keys(appConfigData).length === 0) {
                        // Nếu file rỗng, gán là object rỗng
                        appConfigData = {};
                        console.warn(`File ${config.CONFIG_FILE_PATH} rỗng.`);
                    }
                } catch (e) {
                    console.error(`Lỗi nghiêm trọng: Không thể tải file config ${config.CONFIG_FILE_PATH}. Ứng dụng không thể tiếp tục.`, e);
                    showNotification('Lỗi nghiêm trọng: Không thể tải file cấu hình!', 'error');
                    // Gán rỗng để code không bị sập ở Bước 2
                    appConfigData = {}; 
                }
                
                // --- BƯỚC 2: Gộp config Động (từ appConfigData) vào config Tĩnh (trong code) ---
                config = { ...config, ...appConfigData }; 

                // --- BƯỚC 3: Cập nhật API keys cho các instance (nếu cần) ---
                driveAPI.apiKey = config.API_KEY; 
                driveAPI.folderId = config.FOLDER_ID;

                // --- BƯỚC 4: Tải tất cả các file dữ liệu khác (dùng 'config' đã gộp) ---
                const [events, photos, comments, profiles, logs] = await Promise.all([
                    githubAPI.getFile(config.FILE_PATH),
                    githubAPI.getFile(config.PHOTOS_METADATA_FILE_PATH),
                    githubAPI.getFile(config.COMMENTS_FILE_PATH),
                    githubAPI.getFile(config.PROFILES_FILE_PATH),
                    githubAPI.getFile(config.LOGS_FILE_PATH)
                ]);

                eventsData = events || [];
                photosData = photos || [];
                commentsData = comments || [];
                profilesData = profiles || [];
                logsData = logs || [];
                
                loadCurrentUser();
                hideLoadingState();
                return true;
                
            } catch (error) {
                console.error('Lỗi nghiêm trọng khi tải dữ liệu (Rất có thể do thiếu khóa trong configApp.json):', error);
                hideLoadingState();
                showNotification('Lỗi tải dữ liệu! Vui lòng kiểm tra file configApp.json.', 'error');
                return false;
            }
        }

        async function syncPhotosMetadata(isManual = false) {
            if (!isManual && !config.AUTO_SYNC_METADATA.enabled) return;
            
            try {
                if (isManual) {
                    showNotification('Đang đồng bộ media files...', 'info');
                }
                
                // Get all media files (images and videos)
                const allMediaFiles = await driveAPI.getAllMediaFiles();
                
                // Separate images and videos for different handling
                const images = allMediaFiles.filter(file => file.fileType === 'image');
                const videos = allMediaFiles.filter(file => file.fileType === 'video');
                
                // Replace all photos data with new data (keep backward compatibility)
                const oldCount = photosData.length;
                photosData = allMediaFiles; // Store all media files in photosData
                
                await githubAPI.updateFile(
                    config.PHOTOS_METADATA_FILE_PATH, 
                    photosData, 
                    isManual ? 'Manual sync: Updated media metadata' : `Auto sync: Updated ${allMediaFiles.length} media files`
                );
                
                const message = `Đã đồng bộ ${allMediaFiles.length} files (${images.length} ảnh, ${videos.length} video) - Cũ: ${oldCount}`;
                addLog('Đồng bộ media', message);
                showNotification(message, 'success');
                
                // Refresh photos display if on photos section
                if (currentSection === 'photos') {
                    loadPhotos(1);
                }
                
                // Update stats
                updateStats();
                
            } catch (error) {
                console.error('Error syncing media:', error);
                addLog('Lỗi đồng bộ', 'Không thể đồng bộ media từ Google Drive');
                showNotification('Lỗi khi đồng bộ media!', 'error');
            }
        }
 
        // Danh sách tên (bạn có thể thêm/bớt tùy ý)
        const randomAnimals = ['Gấu', 'Hổ', 'Sư Tử', 'Voi', 'Hươu', 'Cá', 'Vẹt', 'Mèo', 'Chó', 'Rùa', 'Khỉ', 'Thỏ', 'Sói', 'Cáo', 'Heo', 'Bò', 'Gà', 'Vịt', 'Cú', 'Dê', 'Cừu', 'Kiến', 'Tép', 'Tôm'];
        const randomColors = ['Xanh', 'Đỏ', 'Tím', 'Vàng', 'Cam', 'Hồng', 'Đen', 'Trắng', 'Nâu', 'Xám', 'Lục', 'Lam', 'Bạc', 'Đồng', 'Bích', 'Mơ'];

        /**
         * Lấy một phần tử ngẫu nhiên từ mảng
         * @param {Array<string>} arr Mảng đầu vào
         * @returns {string} Một phần tử ngẫu nhiên
         */
        function getRandomItem(arr) {
            return arr[Math.floor(Math.random() * arr.length)];
        }

        /**
         * Chuẩn hóa chuỗi: xóa dấu, xóa khoảng trắng, chuyển chữ thường
         * @param {string} str Chuỗi đầu vào (Họ tên)
         * @returns {string} Chuỗi đã chuẩn hóa (username)
         */
        function normalizeString(str) {
            if (!str) return '';
            return str
                .normalize("NFD") // 1. Tách dấu (e.g., "è" -> "e" + "`")
                .replace(/[\u0300-\u036f]/g, "") // 2. Xóa các ký tự dấu
                .replace(/[đĐ]/g, "d") // 3. Thay thế 'đ' và 'Đ' thành 'd'
                .replace(/\s+/g, '') // 4. Xóa tất cả khoảng trắng
                .toLowerCase(); // 5. Chuyển thành chữ thường
        }
          
        function loadCurrentUser() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                updateUserProfile();
            } else {
                // 1. Tạo Họ tên ngẫu nhiên
                const randomAnimal = getRandomItem(randomAnimals);
                const randomColor = getRandomItem(randomColors);
                const newName = `${randomAnimal} ${randomColor}`; // Ví dụ: "Gấu Nâu"
                
                // 2. Tạo Tên đăng nhập đã chuẩn hóa
                const newUsername = normalizeString(newName); // Ví dụ: "gaunau"
                
                // 3. Tạo Avatar URL dựa trên tên mới
				const newAvatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(newName)}&background=006B68&color=fff`;

                // 4. Tạo đối tượng currentUser
                currentUser = {
                    username: newUsername,
                    name: newName,
                    avatarUrl: newAvatarUrl,
                    createdAt: new Date().toISOString(),
                    lastLoginAt: new Date().toISOString()
                };
                
                // 5. Lưu user mới vào localStorage
				localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // 6. Cập nhật giao diện (header/modal) với tên mới
                updateUserProfile();
            }
        }

        function updateUserProfile() {
            if (currentUser) {
                // Giữ nguyên việc cập nhật avatar
                document.querySelector('img[alt="Avatar"]').src = currentUser.avatarUrl;
                // Sử dụng ID mới để chỉ cập nhật tên người dùng
                document.getElementById('userNameDisplay').textContent = currentUser.name;
            }
        }

        function showLoadingState() {
            // Show skeleton loading for all sections
            document.querySelectorAll('.skeleton').forEach(el => {
                el.style.display = 'block';
            });
        }

        function hideLoadingState() {
            // Hide skeleton loading
            document.querySelectorAll('.skeleton').forEach(el => {
                el.style.display = 'none';
            });
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', async function() {
            await initializeApp();
            // 1. Thiết lập một bộ đếm thời gian, cứ mỗi 15 giây sẽ gọi hàm saveLogsBatch một lần
            setInterval(saveLogsBatch, 15000);
            
            // 2. Lắng nghe sự kiện khi người dùng đóng tab, chuyển tab hoặc ẩn trình duyệt
            // Đây là cách hiện đại và đáng tin cậy để lưu dữ liệu trước khi thoát
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'hidden') {
                    // Nếu có log đang chờ, thực hiện lưu ngay lập tức
                    if (logQueue.length > 0) {
                        saveLogsBatch();
                    }
                }
            });
            
            // 3. Xử lý khi kết nối mạng được phục hồi
            window.addEventListener('online', () => {
                isOnline = true;
                updateOnlineStatus();
                // Ngay khi có mạng, thử lưu ngay các log đang chờ
                saveLogsBatch();
                syncPhotosMetadata();
            });
                   
            window.addEventListener('offline', () => {
                isOnline = false;
                updateOnlineStatus();
            });

            // Tự động đóng menu khi người dùng cuộn trang
            document.addEventListener('scroll', function() {
                const menuIcons = document.getElementById('headerMenuIcons');
                // Chỉ đóng nếu menu đang được hiển thị
                if (menuIcons.classList.contains('show')) {
                    closeHeaderMenu();
                }
            });

            // Auto sync check
            if (config.AUTO_SYNC_METADATA.enabled) {
                checkAutoSync();
                setInterval(checkAutoSync, 60000); // Check every minute
            }

            // Update view button on window resize
            window.addEventListener('resize', updateViewToggleButton);
        });

        async function initializeApp() {
            // Load saved theme
            const savedTheme = localStorage.getItem('loveStoryTheme') || 'default';
            
            // Apply theme to body
            document.body.className = document.body.className.replace(/theme-\w+/g, '');
            if (savedTheme !== 'default') {
                document.body.classList.add(`theme-${savedTheme}`);
            }
            
            // Update radio button selection
            document.querySelector(`.theme-radio-${savedTheme}`).classList.add('selected');
            
            // Load hamburger menu setting
            const showHamburger = localStorage.getItem('showHamburgerMenu');
            if (showHamburger === 'false') {
                document.getElementById('showHamburgerMenu').checked = false;
                document.getElementById('rightMenuBtn').style.display = 'none';
            } else {
                document.getElementById('showHamburgerMenu').checked = true;
                document.getElementById('rightMenuBtn').style.display = 'flex';
            }
            
			// Load all data
            const dataLoaded = await loadAllData();
			
			// MỚI: Tải cài đặt thông báo 
            document.getElementById('enableSystemNotifications').checked = config.ENABLE_NOTI;
			
            // Initialize view toggle button
            updateViewToggleButton();
             
            if (dataLoaded) {
                // Load app configuration into UI
                loadAppConfigToUI();
                
                updateStats();
                loadTodayMemories();
                loadUpcomingEvents();
                loadTimeline();
                loadPhotos();
                updateOnlineStatus();
                updateTotalLogs();
                updateSyncStatus();
				await updateStorageUsageDisplay();
            }
            
            // Set active navigation
            updateNavigation('home');
			// Set initial AI mode button active
            switchAiModel(currentAiModel);
        }


        function checkAutoSync() {
            // 1. Lấy cấu hình hiện tại từ appConfigData
            const syncConfig = config.AUTO_SYNC_METADATA;
            if (!syncConfig.enabled) {
                console.log('[Auto Sync] Tự động đồng bộ đã bị tắt.');
                return;
            }

            // 2. Lấy thông tin về lần đồng bộ cuối cùng từ localStorage
            const lastSyncTimestampStr = localStorage.getItem('lastAutoSyncTimestamp');
            const lastSyncTimestamp = lastSyncTimestampStr ? parseInt(lastSyncTimestampStr, 10) : 0;
            const lastSyncDate = new Date(lastSyncTimestamp);

            // 3. Lấy thời gian hiện tại và thời gian mục tiêu trong ngày
            const now = new Date();
            const [hours, minutes] = syncConfig.time.split(':').map(Number);
            const targetTimeToday = new Date();
            targetTimeToday.setHours(hours, minutes, 0, 0);

            // 4. Tính toán thời điểm hợp lệ để đồng bộ tiếp theo
            let nextValidSyncTime = new Date(lastSyncTimestamp);
            
            // Dựa vào tần suất để tính toán
            switch (syncConfig.frequency) {
                case 'daily':
                    // Nếu lần cuối là hôm qua hoặc cũ hơn, thời điểm hợp lệ tiếp theo là thời gian mục tiêu của ngày hôm nay
                    if (lastSyncDate.getDate() < now.getDate() || lastSyncDate.getMonth() < now.getMonth() || lastSyncDate.getFullYear() < now.getFullYear()) {
                        nextValidSyncTime = targetTimeToday;
                    } else {
                        // Nếu đã đồng bộ hôm nay, thì thời điểm tiếp theo là ngày mai
                        nextValidSyncTime = new Date(targetTimeToday.getTime() + 24 * 60 * 60 * 1000);
                    }
                    break;
                case 'weekly':
                    // Thêm 7 ngày vào lần đồng bộ cuối
                    nextValidSyncTime.setDate(lastSyncDate.getDate() + 7);
                    nextValidSyncTime.setHours(hours, minutes, 0, 0);
                    break;
                case 'monthly':
                    // Thêm 1 tháng vào lần đồng bộ cuối
                    nextValidSyncTime.setMonth(lastSyncDate.getMonth() + 1);
                    nextValidSyncTime.setHours(hours, minutes, 0, 0);
                    break;
                case 'once':
                    // Chỉ chạy nếu chưa bao giờ đồng bộ
                    if (lastSyncTimestamp > 0) {
                        console.log('[Auto Sync] Đã chạy đồng bộ 1 lần, sẽ không chạy lại.');
                        return;
                    }
                    nextValidSyncTime = targetTimeToday;
                    break;
                default:
                    return; // Tần suất không hợp lệ
            }
            
            // 5. Kiểm tra và thực hiện đồng bộ
            // Điều kiện: Thời gian hiện tại (now) đã qua thời điểm hợp lệ (nextValidSyncTime)
            if (now >= nextValidSyncTime) {
                console.log(`[Auto Sync] Đang thực hiện đồng bộ theo lịch "${syncConfig.frequency}" lúc ${now.toLocaleTimeString()}`);
                
                // Gọi hàm đồng bộ
                syncPhotosMetadata(false); // false = không phải thủ công
                localStorage.setItem('lastAutoSyncTimestamp', now.getTime().toString());
                localStorage.setItem('lastAutoSync', now.toDateString()); // Giữ lại để tương thích nếu cần
                
                showNotification(`Tự động đồng bộ đã chạy theo lịch`, 'info');
                addLog('Tự động đồng bộ', `Đã chạy tự động đồng bộ theo lịch ${syncConfig.frequency}`);
            } else {
                console.log(`[Auto Sync] Chưa đến giờ. Lần tiếp theo dự kiến: ${nextValidSyncTime.toLocaleString()}`);
            }
        } 

        // Navigation functions
        function showSection(section) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            
            // Show selected section
            document.getElementById(section + 'Section').classList.remove('hidden');
            
            // Update navigation
            updateNavigation(section);
            
            // Log navigation activity
            const sectionNames = {
                'home': 'Trang chủ',
                'chat': 'Chat AI',
                'timeline': 'Timeline',
                'photos': 'Khoảnh khắc',
                'settings': 'Cài đặt'
            };
            
            if (currentSection !== section) {
                addLog('Điều hướng', `Chuyển từ "${sectionNames[currentSection] || currentSection}" sang "${sectionNames[section]}"`);
            }
            
            currentSection = section;
        }
 
        function toggleHeaderMenu() {
            const menuIcons = document.getElementById('headerMenuIcons');
            // Kiểm tra xem menu có đang ẩn không bằng class 'hidden'
            if (menuIcons.classList.contains('hidden')) {
                openHeaderMenu();
            } else {
                closeHeaderMenu();
            }
        }

        function openHeaderMenu() {
            const menuIcons = document.getElementById('headerMenuIcons');
            const title = document.getElementById('headerTitle');
            
            // 1. Ẩn Title trên di động
            title.classList.add('md:hidden');
            
            // 2. Hiện Menu
            menuIcons.classList.remove('hidden');
            setTimeout(() => { // Dùng setTimeout để trình duyệt kịp render và tạo hiệu ứng fade-in
                menuIcons.classList.remove('opacity-0');
            }, 10);
        }

        function closeHeaderMenu() {
            const menuIcons = document.getElementById('headerMenuIcons');
            const title = document.getElementById('headerTitle');
            
            // 1. Làm mờ Menu đi
            menuIcons.classList.add('opacity-0');
            
            // 2. Sau khi hiệu ứng mờ kết thúc (300ms), ẩn hoàn toàn Menu và hiện lại Title
            setTimeout(() => {
                menuIcons.classList.add('hidden');
                title.classList.remove('md:hidden');
            }, 300);
        }

        function toggleRightHeaderMenu() {
            toggleHeaderMenu();
        }

        function selectMenuItem(section) {
            showSection(section);
        }

        function updateNavigation(activeSection) {
            // Update header menu navigation
            document.querySelectorAll('.menu-icon').forEach(item => {
                item.classList.remove('active');
            });
            
            const activeItem = document.querySelector(`[data-section="${activeSection}"]`);
            if (activeItem) {
                activeItem.classList.add('active');
            }
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // Theme functions
        function changeTheme() {
            const theme = document.getElementById('themeSelect').value;
            document.body.className = document.body.className.replace(/theme-\w+/g, '');
            
            if (theme !== 'default') {
                document.body.classList.add(`theme-${theme}`);
            }
            
            localStorage.setItem('loveStoryTheme', theme);
            addLog('Thay đổi theme', `Đã chuyển sang theme "${document.getElementById('themeSelect').selectedOptions[0].text}"`);
        }

        function changeThemeRadio(theme) {
            // Update body classes
            document.body.className = document.body.className.replace(/theme-\w+/g, '');
            
            if (theme !== 'default') {
                document.body.classList.add(`theme-${theme}`);
            }
            
            // Update radio button selection
            document.querySelectorAll('[class*="theme-radio-"]').forEach(radio => {
                radio.classList.remove('selected');
            });
            document.querySelector(`.theme-radio-${theme}`).classList.add('selected');
            
            // Save to localStorage
            localStorage.setItem('loveStoryTheme', theme);
            
            // Get theme name for log
            const themeNames = {
                'default': 'Mặc định',
                'spring': 'Mùa Xuân', 
                'summer': 'Mùa Hè',
                'night': 'Ban Đêm',
                'romantic': 'Lãng Mạn',
                'ocean': 'Đại Dương'
            };
            
            addLog('Thay đổi theme', `Đã chuyển sang theme "${themeNames[theme]}"`);
            showNotification(`Đã chuyển sang theme ${themeNames[theme]}!`, 'success');
        }

        // Hamburger menu toggle function
        function toggleHamburgerMenu() {
            const checkbox = document.getElementById('showHamburgerMenu');
            const hamburgerBtn = document.getElementById('rightMenuBtn');
            const isEnabled = checkbox.checked;
            
            if (isEnabled) {
                hamburgerBtn.style.display = 'flex';
                localStorage.setItem('showHamburgerMenu', 'true');
                addLog('Cài đặt giao diện', 'Đã bật nút menu hamburger');
            } else {
                hamburgerBtn.style.display = 'none';
                // Đóng menu nếu đang mở
                closeHeaderMenu();
                localStorage.setItem('showHamburgerMenu', 'false');
                addLog('Cài đặt giao diện', 'Đã ẩn nút menu hamburger');
            }
            
            showNotification(isEnabled ? 'Đã bật menu!' : 'Đã ẩn menu!', 'success');
        }
		
		// HÀM MỚI: Tắt/Bật Thông Báo Hệ Thống  
        async function toggleSystemNotifications() {
            const isEnabled = document.getElementById('enableSystemNotifications').checked;
            
            if (!isEnabled) {
                // Cập nhật appConfigData TRƯỚC khi hiển thị thông báo cuối
                config.ENABLE_NOTI = false;
                showNotification('Đã tắt thông báo hệ thống!', 'info');
            } else {
                config.ENABLE_NOTI = true;
            }
            
            const logMessage = isEnabled ? 'Đã bật thông báo hệ thống' : 'Đã tắt thông báo hệ thống';
            addLog('Cài đặt giao diện', logMessage);
            
            try {
                // Gọi API để lưu file configApp.json
                const success = await githubAPI.updateFile(
                    config.CONFIG_FILE_PATH,
                    appConfigData, // Lưu toàn bộ đối tượng appConfigData
                    `Cập nhật thông báo hệ thống: ${isEnabled ? 'Bật' : 'Tắt'}`
                );
                
                if (success) {
                    if (isEnabled) {
                        // Chỉ hiển thị thông báo BẬT sau khi đã lưu thành công
                        showNotification('Đã bật và lưu thông báo hệ thống!', 'success');
                    }
                } else {
                    // Nếu lưu thất bại, đảo ngược lại trạng thái
                    config.ENABLE_NOTI = !isEnabled; 
                    document.getElementById('enableSystemNotifications').checked = !isEnabled;
                    showNotification('Lỗi khi lưu cài đặt!', 'error');
                }
            } catch (error) {
                console.error('Error saving notification config:', error);
                // Đảo ngược trạng thái nếu có lỗi
                config.ENABLE_NOTI = !isEnabled;
                document.getElementById('enableSystemNotifications').checked = !isEnabled;
                showNotification('Lỗi khi lưu cài đặt!', 'error');
            }
        }
 

        // Stats functions
        function updateStats() {
            // Ngày bên nhau: Tính từ ngày cố định 22/02/2022
            const startDate = new Date('2022-02-22');
            const today = new Date();
            const daysTogether = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));
            
            // Kỷ niệm: Lấy tổng số lượng sự kiện từ mảng eventsData
            const totalMemories = eventsData.length;

            // Media: Lấy tổng số lượng media từ mảng photosData
            const totalMedia = photosData.length;
            
            // Cập nhật các giá trị lên giao diện
            document.getElementById('daysTogether').textContent = daysTogether.toLocaleString();
            document.getElementById('totalMemories').textContent = totalMemories.toLocaleString();
            document.getElementById('totalPhotos').textContent = totalMedia.toLocaleString();
        }
		
		

        function convertDateFormat(dateStr) {
            // Convert DD-MM-YYYY to YYYY-MM-DD
            const parts = dateStr.split('-');
            return `${parts[2]}-${parts[1]}-${parts[0]}`;
        }

        function loadTodayMemories() {
			const container = document.getElementById('todayMemories');
			const today = new Date();
			// Tạo chuỗi ngày/tháng hôm nay (VD: '24-10')
			const todayDayMonthStr = `${String(today.getDate()).padStart(2, '0')}-${String(today.getMonth() + 1).padStart(2, '0')}`;
			const currentYear = today.getFullYear();
			
			// 1. Lọc các sự kiện (Hiệu quả hơn)
			const validMemories = eventsData.filter(event => {
				// Kiểm tra xem trường 'day' có tồn tại và hợp lệ không
				if (!event.day || event.day.length !== 10) return false; 
				
				const eventDayMonthStr = event.day.substring(0, 5); // Lấy DD-MM
				
				// 1a. Kiểm tra ngày và tháng
				if (eventDayMonthStr !== todayDayMonthStr) {
					return false;
				}
				
				// 1b. Kiểm tra số năm
				const eventYear = parseInt(event.day.substring(6), 10); // Lấy YYYY
				const yearsAgo = currentYear - eventYear;
				// Chỉ chấp nhận nếu ít nhất 1 năm trước
				return yearsAgo >= 1;
			});

			// 2. Sắp xếp theo năm giảm dần (mới nhất trước)
			validMemories.sort((a, b) => {
				// So sánh bằng cách tạo đối tượng Date từ YYYY-MM-DD (đảm bảo so sánh số)
				return new Date(convertDateFormat(b.day)) - new Date(convertDateFormat(a.day));
			});
			
			// 3. Lưu vào biến toàn cục và reset vị trí
			todayValidMemories = validMemories;
			// GIỮ NGUYÊN: Không reset currentMemoryIndex nếu đã có (để tránh giật lag khi chạy setInterval)
			if (currentMemoryIndex >= todayValidMemories.length) {
				currentMemoryIndex = 0; 
			}
			
			// Gọi hàm hiển thị
			displayCurrentMemory();
		}
		
		/**
         * Hiển thị kỷ niệm hiện tại (dựa trên currentMemoryIndex)
         */
        function displayCurrentMemory() {
            const container = document.getElementById('todayMemories');
            const today = new Date(); // Cần cho việc tính toán 'năm trước'

            if (todayValidMemories.length === 0) {
                // Giữ nguyên HTML khi không có kỷ niệm
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-calendar-day text-4xl mb-3"></i>
                        <p>Không có kỷ niệm nào vào ngày hôm nay</p>
                    </div>
                `;
                return;
            }

            // Lấy kỷ niệm cụ thể
			const memory = todayValidMemories[currentMemoryIndex];
			
			const eventDate = new Date(convertDateFormat(memory.day));
			const yearsAgo = today.getFullYear() - eventDate.getFullYear();
			
			let imageHtml = '';
			if (memory.image && memory.image.length > 0) {
				const imageId = memory.image[0];
				// Sử dụng thumbnail chất lượng thấp nhất để load nhanh nhất
				const imageUrl = driveAPI.getImageUrl(imageId, 'thumbnail'); 
				imageHtml = `<img src="${imageUrl}" alt="" class="w-20 h-20 rounded-lg object-cover" onerror="this.src=''; this.style.display='none';">`;
			}
			
			const safeName = escapeHtml(memory.name || '');
			const safeDescription = escapeHtml(memory.contdetl || 'Không có mô tả');

			let navHtml = '';
			if (todayValidMemories.length > 1) {
				// Thêm nút "Trước" nếu không phải kỷ niệm đầu tiên
				const prevButton = `<button onclick="navigateMemory(-1)" class="love-button w-7 h-7 rounded-full flex items-center justify-center p-0 opacity-60 hover:opacity-100 flex-shrink-0 mr-1">
										<i class="fas fa-chevron-left text-xs"></i>
									</button>`;
									
				// Thêm nút "Sau"
				const nextButton = `<button onclick="navigateMemory(1)" class="love-button w-7 h-7 rounded-full flex items-center justify-center p-0 opacity-60 hover:opacity-100 flex-shrink-0 ml-auto">
										<i class="fas fa-chevron-right text-xs"></i>
									</button>`;

				// Hiển thị cả hai nút nếu có nhiều hơn 1 kỷ niệm
				navHtml = `<div class="flex items-center space-x-2">
								${prevButton} 
								<span class="text-xs text-gray-500 whitespace-nowrap">(${currentMemoryIndex + 1}/${todayValidMemories.length})</span>
								${nextButton}
							</div>`;
			}

			container.innerHTML = `
				<div>
					<div class="flex items-start space-x-3">
						${imageHtml}
						<div class="flex-1 min-w-0">
							<div class="flex justify-between items-start">
								<h4 class="text-lg font-bold text-primary mb-1">${safeName}</h4>
								${navHtml}
							</div>
							<p class="text-secondary font-medium mb-2 text-sm">${yearsAgo} năm trước - ${formatDateToDDMMYYYY(memory.day)}</p>
						</div>
					</div>
					 <p class="text-gray-700 whitespace-pre-wrap mt-3">${safeDescription}</p>
				</div>
			`;
        }

        /**
         * Xử lý khi bấm nút next/prev của "Ngày Này Năm Xưa"
         * @param {number} direction -1 (prev) hoặc 1 (next)
         */
        function navigateMemory(direction) {
            if (todayValidMemories.length === 0) return;

            // Cập nhật vị trí
            currentMemoryIndex += direction;

            // Xử lý xoay vòng (wrap-around)
            if (currentMemoryIndex >= todayValidMemories.length) {
                currentMemoryIndex = 0; // Quay về đầu
            } else if (currentMemoryIndex < 0) {
                currentMemoryIndex = todayValidMemories.length - 1; // Đi đến cuối
            }
 
            displayCurrentMemory();
        }

        function formatDateFromDDMMYYYY(dateStr) {
            const parts = dateStr.split('-');
            const date = new Date(parts[2], parts[1] - 1, parts[0]);
            return date.toLocaleDateString('vi-VN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function formatDateToDDMMYYYY(dateStr) {
            // Convert DD-MM-YYYY to DD/MM/YYYY format
            return dateStr.replace(/-/g, '/');
        }

        function formatDateToDDMMYYHHMMSS(dateString) {
            if (!dateString) return '';
            
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return dateString;
                
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = String(date.getFullYear()).slice(-2);
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const seconds = String(date.getSeconds()).padStart(2, '0');
                
                return `${day}-${month}-${year} ${hours}:${minutes}:${seconds}`;
            } catch (error) {
                return dateString;
            }
        }

        function loadUpcomingEvents() {
            const container = document.getElementById('upcomingEventsContainer');
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Chuẩn hóa về đầu ngày để đếm cho chính xác

            // Tìm tất cả các sự kiện có thể xảy ra trong tương lai
            const futureEvents = eventsData.map(event => {
                const parts = event.day.split('-'); // Tách chuỗi dd-mm-yyyy
                const day = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10) - 1; // Tháng trong JS bắt đầu từ 0

                // Lấy ngày sự kiện trong năm nay
                let nextEventDate = new Date(today.getFullYear(), month, day);

                // Nếu ngày sự kiện của năm nay đã trôi qua, thì tính cho năm sau
                if (nextEventDate < today) {
                    nextEventDate.setFullYear(today.getFullYear() + 1);
                }

                return {
                    name: event.name,
                    date: nextEventDate,
                    // Tính số ngày chênh lệch để so sánh
                    diff: Math.ceil((nextEventDate - today) / (1000 * 60 * 60 * 24))
                };
            })
            // Sắp xếp để tìm ra sự kiện có số ngày chênh lệch nhỏ nhất (gần nhất)
            .sort((a, b) => a.diff - b.diff);

            // Lấy sự kiện gần nhất
            const nextEvent = futureEvents.length > 0 ? futureEvents[0] : null;

            // Nếu không có sự kiện nào hoặc không có dữ liệu
            if (!nextEvent) {
                container.innerHTML = `
                    <div>
                        <p class="text-sm text-gray-500">Sự Kiện Sắp Tới</p>
                        <p class="text-xl font-bold text-primary">Không có</p>
                    </div>
                `;
                return;
            }

            // Hiển thị thông tin sự kiện gần nhất
            container.innerHTML = `
                <div class="flex items-baseline space-x-2">
                    <p class="text-2xl font-bold text-primary">${nextEvent.diff}</p>
                    <p class="text-sm font-medium text-gray-600">ngày nữa</p>
                </div>
                <p class="text-sm text-gray-500">${escapeHtml(nextEvent.name)}</p>
            `;
        }

        // Timeline functions
        function loadTimeline() {
            const container = document.getElementById('timelineContainer');
            
            if (eventsData.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-clock text-6xl mb-4"></i>
                        <h3 class="text-xl font-bold mb-2">Chưa có kỷ niệm nào</h3>
                        <p class="mb-4">Hãy thêm kỷ niệm đầu tiên của bạn!</p>
                        <button onclick="openModal('eventModal')" class="love-button">
                            <i class="fas fa-plus mr-2"></i>Thêm Kỷ Niệm Đầu Tiên
                        </button>
                    </div>
                `;
                return;
            }
            
            // Sort events by date (newest first)
            const sortedEvents = [...eventsData].sort((a, b) => 
                new Date(convertDateFormat(b.day)) - new Date(convertDateFormat(a.day))
            );
            
            const timelineHTML = sortedEvents.map(event => {
                let imagesHTML = '';
                if (event.image && event.image.length > 0) {
                    const displayImages = event.image.slice(0, 3);
                    imagesHTML = `
                        <div class="flex space-x-2 mt-4">
                            ${displayImages.map(imageId => {
                                const imageUrl = driveAPI.getImageUrl(imageId, 'thumbnail');
                                return `<img src="${imageUrl}" alt="" class="w-16 h-16 rounded object-cover cursor-pointer" 
                                           onclick="viewPhoto('${driveAPI.getImageUrl(imageId, 'view')}')"
                                           onerror="this.src=''; this.style.display='none';">`;
                            }).join('')}
                            ${event.image.length > 3 ? `
                                <div class="w-16 h-16 rounded bg-gray-200 flex items-center justify-center text-sm font-medium">
                                    +${event.image.length - 3}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
                
                // Safely escape HTML content to prevent font issues
                const safeName = escapeHtml(event.name || '');
                const safeDescription = escapeHtml(event.contdetl || 'Không có mô tả');
                
                return `
                    <div class="timeline-item">
                        <div class="love-card rounded-lg px-6 py-3">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h3 class="text-base font-bold text-primary mb-0.5" style="font-size: 0.9em;">${safeName}</h3>
                                    <p class="text-secondary font-medium" style="font-size: 0.9em;">${formatDateToDDMMYYYY(event.day)}</p>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="editEvent('${event.note_id}')" class="love-button text-xs px-2 py-1" style="transform: scale(1.10);">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="viewEventPhotos('${event.note_id}')" class="love-button text-xs px-2 py-1" style="transform: scale(1.10);">
                                        <i class="fas fa-images"></i>
                                    </button>
                                    <button onclick="deleteEvent('${event.note_id}')" class="love-button secondary text-xs px-2 py-1" style="transform: scale(1.10);">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <p class="text-gray-700 whitespace-pre-wrap" style="font-size: 0.9em; line-height: 1.4;">${safeDescription}</p>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = timelineHTML;
        }

        // Photo functions
        function loadPhotos(page = 1) {
            const container = document.getElementById('photosContainer');
            const photosPerPage = config.PHOTOS_PER_PAGE;
            
            // Log page navigation
            if (currentPage !== page && page > 1) {
                addLog('Phân trang ảnh', `Chuyển từ trang ${currentPage} sang trang ${page}`);
            }
            
            currentPage = page;
            
            if (photosData.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-500 col-span-full">
                        <i class="fas fa-images text-6xl mb-4"></i>
                        <h3 class="text-xl font-bold mb-2">Chưa có media nào</h3>
                        <p class="mb-4">Ảnh và video sẽ được đồng bộ tự động từ Google Drive</p>
                        <button onclick="syncPhotosMetadata(true)" class="love-button">
                            <i class="fas fa-sync mr-2"></i>Đồng Bộ Ngay
                        </button>
                    </div>
                `;
                return;
            }
            
            // Sort media by creation time (newest first)
            const sortedMedia = [...photosData].sort((a, b) => 
                new Date(b.createdTime) - new Date(a.createdTime)
            );
            
            const startIndex = (page - 1) * photosPerPage;
            const endIndex = startIndex + photosPerPage;
            const pageMedia = sortedMedia.slice(startIndex, endIndex);
            
            if (currentPhotoView === 'list') {
                container.className = 'list-view';
                container.innerHTML = pageMedia.map(media => {
                    const thumbnailUrl = getGridThumbnailUrl(media); // Kỹ thuật hack URL
                    const mediaComments = commentsData.find(c => c.ID_IMG === media.name);
                    const likesCount = mediaComments && mediaComments.tim && Array.isArray(mediaComments.tim) ? mediaComments.tim.length : 0;
                    const commentsCount = mediaComments ? mediaComments.comments.length : 0;
                    const isVideo = media.fileType === 'video';
                    const fileIcon = isVideo ? 'fas fa-play-circle' : 'fas fa-image';
                    
                    return `
                        <div class="photo-item" onclick="viewMediaWithDetails('${media.id}', '${media.name}', '${media.fileType}')">
                            <div class="relative">
                                <img src="${thumbnailUrl}" alt="${media.name}" loading="lazy" referrerpolicy="no-referrer" onerror="this.src=imageErrorPlaceholder; this.style.objectFit='contain';">
                                ${isVideo ? '<div class="absolute inset-0 flex items-center justify-center"><i class="fas fa-play-circle text-white text-3xl opacity-80"></i></div>' : ''}
                            </div>
                            <div class="flex-1">
                                <h4 class="font-medium text-primary flex items-center">
                                    <i class="${fileIcon} mr-2"></i>${media.name}
                                </h4>
                                <p class="text-sm text-gray-600">${formatDate(media.createdTime)}</p>
                                <div class="flex items-center space-x-4 mt-2 text-xs text-gray-500">
                                    <span><i class="fas fa-heart mr-1"></i>${likesCount}</span>
                                    <span><i class="fas fa-comment mr-1"></i>${commentsCount}</span>
                                    <span><i class="fas fa-file mr-1"></i>${formatFileSize(media.size)}</span>
                                    <span class="px-2 py-1 bg-gray-200 rounded text-xs">${isVideo ? 'Video' : 'Ảnh'}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                // Map view names to CSS classes
                const viewClassMap = {
                    'grid-1': 'grid-view-1',
                    'grid-2': 'grid-view-2', 
                    'grid-3': 'grid-view-3',
                    'grid-4': 'grid-view-4',
                    'grid-5': 'grid-view-5',
                    'grid-6': 'grid-view-6'
                };
                
                const cssClass = viewClassMap[currentPhotoView] || 'grid-view-2';
                container.className = `photo-grid ${cssClass}`;
                
                container.innerHTML = pageMedia.map(media => {
                    const thumbnailUrl = getGridThumbnailUrl(media);
                    const mediaComments = commentsData.find(c => c.ID_IMG === media.name);
                    const likesCount = mediaComments && mediaComments.tim && Array.isArray(mediaComments.tim) ? mediaComments.tim.length : 0;
                    const commentsCount = mediaComments ? (mediaComments.comments ? mediaComments.comments.length : 0) : 0;
                    const isVideo = media.fileType === 'video';
                    
                    return `
                        <div class="photo-item relative" onclick="viewMediaWithDetails('${media.id}', '${media.name}', '${media.fileType}')" title="${media.name}">
                            <img src="${thumbnailUrl}" alt="${media.name}" loading="lazy" referrerpolicy="no-referrer" onerror="this.src=imageErrorPlaceholder; this.style.objectFit='contain';">
                            ${isVideo ? '<div class="absolute inset-0 flex items-center justify-center"><i class="fas fa-play-circle text-white text-4xl opacity-80"></i></div>' : ''}
                            <div class="absolute top-2 right-2">
                                <span class="bg-black bg-opacity-60 text-white text-xs px-2 py-1 rounded">
                                    ${isVideo ? 'Video' : 'Ảnh'}
                                </span>
                            </div>
                            <div class="absolute bottom-2 left-2 bg-black bg-opacity-60 text-white text-xs px-2 py-1 rounded flex items-center space-x-2">
                                <span class="flex items-center">
                                    <i class="fas fa-heart text-red-500 mr-1"></i>
                                    ${likesCount}
                                </span>
                                <span class="flex items-center">
                                    <i class="fas fa-comment text-blue-400 mr-1"></i>
                                    ${commentsCount}
                                </span>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            loadPhotosPagination(page, Math.ceil(sortedMedia.length / photosPerPage));
        }

        function formatFileSize(bytes) {
            if (!bytes) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function viewMediaWithDetails(mediaId, mediaName, fileType) {
            // Store current media info
            currentPhotoId = mediaId;
            currentPhotoName = mediaName;
            
            const modalPhoto = document.getElementById('modalPhoto');
            
            if (fileType === 'video') {
                // For videos, create a video element
                const videoUrl = `https://drive.google.com/file/d/${mediaId}/preview`;
                modalPhoto.outerHTML = `
					<iframe id="modalPhoto" src="${videoUrl}" 
							style="max-width: 95%; max-height: 50vh; width: 800px; height: 450px; border: none;"
							allow="autoplay">
					</iframe>
				`;
            } else {
                
                if (modalPhoto.tagName !== 'IMG') {
					modalPhoto.outerHTML = `<img id="modalPhoto" src="" alt="" class="mx-auto rounded-lg" style="max-width: 95%; max-height: 50vh; width: auto; height: auto; object-fit: contain;" referrerpolicy="no-referrer">`;
                }
                 
                const imgElement = document.getElementById('modalPhoto');
				loadModalImageWithFallback(imgElement, mediaId);
				
                //imgElement.style.maxWidth = '50vw';
                //imgElement.style.maxHeight = '50vh';
                //imgElement.style.width = 'auto';
                //imgElement.style.height = 'auto';
                //imgElement.style.objectFit = 'contain';
            }
            
            // Load comments and likes for this media
            loadPhotoComments(mediaName);
            loadPhotoLikes(mediaName);
            
            openModal('photoModal');
        }

		// Dán hàm này vào (khoảng dòng 1335)
        function loadModalImageWithFallback(imgElement, mediaId) {
            const media = photosData.find(p => p.id === mediaId);
            
            // 1. Tạo danh sách URL dự phòng
            const urls = [
                driveAPI.getImageUrl(mediaId, 'highQuality'), // 1. Thử link chất lượng cao
                media.thumbnailLink ? media.thumbnailLink.replace(/=s\d+/, '=s2048') : null, // 2. Thử hack link 2048px
                `https://drive.google.com/thumbnail?id=${mediaId}&sz=w1600`, // 3. Thử link 1600px
                media.thumbnailLink // 4. Thử link thumbnail gốc
            ].filter(url => url); // Lọc bỏ các link null

            // 2. Tạo và chèn spinner "Đang tải"
            const container = imgElement.parentNode;
            
            // Xóa spinner cũ nếu có
            const oldLoader = container.querySelector('.modal-loader');
            if (oldLoader) oldLoader.remove();
            
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'modal-loader w-full flex items-center justify-center mx-auto rounded-lg';
            // Dùng style giống hệt ảnh để giữ không gian
            loadingDiv.style.cssText = `max-width: 50vw; max-height: 50vh; min-height: 300px; background: #f8f9fa;`; 
            loadingDiv.innerHTML = `<div class="text-center">
                                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                                        <p class="mt-4 text-gray-600">Đang tải ảnh...</p>
                                    </div>`;
            
            imgElement.style.display = 'none'; // Ẩn ảnh đi
            container.insertBefore(loadingDiv, imgElement); // Chèn spinner vào

            // 3. Bắt đầu quá trình tải ảnh
            let urlIndex = 0;
            function tryLoad() {
                if (urlIndex >= urls.length) {
                    // Nếu tất cả URL đều lỗi
                    loadingDiv.innerHTML = '<p class="text-red-500 p-4">Không thể tải ảnh. Vui lòng thử lại.</p>';
                    return;
                }
                
                // Gán sự kiện cho ảnh
                imgElement.onload = function() {
                    loadingDiv.remove(); // Xóa spinner
                    imgElement.style.display = 'block'; // Hiện ảnh
                };
                
                imgElement.onerror = function() {
                    console.warn('Modal Image Load Failed, trying next:', urls[urlIndex]);
                    urlIndex++; // Chuyển sang URL tiếp theo
                    tryLoad(); // Thử lại
                };
                
                // Bắt đầu tải URL hiện tại
                imgElement.src = urls[urlIndex];
            }
            
            tryLoad(); // Bắt đầu tải URL đầu tiên
        }
		
		
        function viewPhotoWithDetails(photoId, photoName) {
            // Backward compatibility - assume it's an image
            viewMediaWithDetails(photoId, photoName, 'image');
        }

        function loadPhotoComments(photoName) {
            const photoComments = commentsData.find(c => c.ID_IMG === photoName);
            const commentsContainer = document.getElementById('commentsContainer');
            
            if (photoComments && photoComments.comments && photoComments.comments.length > 0) {
                commentsContainer.innerHTML = photoComments.comments.map(comment => {
                    // Safely escape HTML content to prevent font issues
                    const safeUserName = escapeHtml(comment.userName || 'Ẩn danh');
                    const safeComment = escapeHtml(comment.comment || '');
                    
                    // Map avatar by username from profiles data
                    let avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(safeUserName)}&background=006B68&color=fff`;
                    const userProfile = profilesData.find(p => p.username === comment.userName);
                    if (userProfile && userProfile.avatarUrl) {
                        avatarUrl = userProfile.avatarUrl;
                    }
                    
                    return `
                        <div class="text-sm border-b border-gray-200 pb-2">
                            <div class="flex items-center space-x-2 mb-1">
                                <img src="${avatarUrl}" 
                                     alt="" class="w-6 h-6 rounded-full"
                                     onerror="this.src='https://ui-avatars.com/api/?name=User&background=006B68&color=fff';">
                                <strong class="font-medium">${safeUserName}</strong>
                                <span class="text-xs text-gray-500">${formatDateToDDMMYYHHMMSS(comment.date_input)}</span>
                            </div>
                            <p class="whitespace-pre-wrap ml-8">${safeComment}</p>
                        </div>
                    `;
                }).join('');
            } else {
                commentsContainer.innerHTML = '<div class="text-sm text-gray-500">Chưa có bình luận nào</div>';
            }
        }

        function loadPhotosPagination(currentPage, totalPages) {
            const container = document.getElementById('photosPagination');
            
            let paginationHTML = '';
            
            if (currentPage > 1) {
                paginationHTML += `<button onclick="loadPhotos(${currentPage - 1})" class="love-button mr-2">← Trước</button>`;
            }
            
            paginationHTML += `<span class="mx-4 text-gray-600">Trang ${currentPage} / ${totalPages}</span>`;
            
            if (currentPage < totalPages) {
                paginationHTML += `<button onclick="loadPhotos(${currentPage + 1})" class="love-button ml-2">Sau →</button>`;
            }
            
            container.innerHTML = paginationHTML;
        }

        function cyclePhotoView() {
            const oldView = currentPhotoView;
            
            // Move to next view in cycle
            currentViewIndex = (currentViewIndex + 1) % photoViewCycle.length;
            currentPhotoView = photoViewCycle[currentViewIndex];
            
            // Update button text and icon
            updateViewToggleButton();
            
            // Reload photos with new view
            loadPhotos(currentPage);
            
            // Log view change
            const viewNames = {
                'grid-1': '1x1',
                'grid-2': '2x2', 
                'grid-3': '3x3',
                'grid-4': '4x4',
                'grid-5': '5x5',
                'grid-6': '6x6',
                'list': 'Danh sách'
            };
            
            addLog('Thay đổi chế độ xem', `Chuyển từ "${viewNames[oldView]}" sang "${viewNames[currentPhotoView]}"`);
        }

        function updateViewToggleButton() {
            const icon = document.getElementById('viewToggleIcon');
            const text = document.getElementById('viewToggleText');
            
            const viewConfig = {
                'grid-1': { icon: 'fas fa-square', text: '1x1' },
                'grid-2': { icon: 'fas fa-th-large', text: '2x2' },
                'grid-3': { icon: 'fas fa-th', text: '3x3' },
                'grid-4': { icon: 'fas fa-grip-horizontal', text: '4x4' },
                'grid-5': { icon: 'fas fa-grip-vertical', text: '5x5' },
                'grid-6': { icon: 'fas fa-border-all', text: '6x6' },
                'list': { icon: 'fas fa-list', text: 'Danh sách' }
            };
            
            const config = viewConfig[currentPhotoView];
            icon.className = config.icon;
            text.textContent = config.text;
        }

        function viewPhoto(url) {
            const modalPhoto = document.getElementById('modalPhoto');
            modalPhoto.src = url;
            
            // Apply consistent sizing
            modalPhoto.style.maxWidth = '50vw';
            modalPhoto.style.maxHeight = '50vh';
            modalPhoto.style.width = 'auto';
            modalPhoto.style.height = 'auto';
            modalPhoto.style.objectFit = 'contain';
            
            openModal('photoModal');
        }

        // Date formatting function
        function formatDateInput(input) {
            let value = input.value.replace(/\D/g, ''); // Remove non-digits
            
            if (value.length >= 2) {
                value = value.substring(0, 2) + '-' + value.substring(2);
            }
            if (value.length >= 5) {
                value = value.substring(0, 5) + '-' + value.substring(5, 9);
            }
            
            input.value = value;
        }

        // Image selection handler
        function handleImageSelection(input) {
            const files = input.files;
            document.getElementById('selectedImagesCount').textContent = files.length;
            
            // Convert FileList to array for easier handling
            selectedImages = Array.from(files);
        }

        // Event functions
        async function saveEvent(e) {
            e.preventDefault();
            
            const name = document.getElementById('eventName').value;
            const date = document.getElementById('eventDate').value;
            const description = document.getElementById('eventDescription').value;
            
            // Validate date format (dd-mm-yyyy)
            if (!/^\d{2}-\d{2}-\d{4}$/.test(date)) {
                showNotification('Vui lòng nhập ngày đúng định dạng dd-mm-yyyy!', 'error');
                return;
            }
            
            try {
                let success = false;
                
                // Prepare image array - always use the latest selected images (replace old list completely)
                const imageArray = Array.isArray(selectedImages) ? [...selectedImages] : [];
                
                if (editingEventId) {
                    // Update existing event
                    const eventIndex = eventsData.findIndex(event => event.note_id === editingEventId);
                    if (eventIndex !== -1) {
                        eventsData[eventIndex] = {
                            ...eventsData[eventIndex],
                            name: name,
                            day: date,
                            contdetl: description,
                            image: imageArray // Always replace with new selection
                        };
                        
                        success = await githubAPI.updateFile(
                            config.FILE_PATH, 
                            eventsData, 
                            `Cập nhật sự kiện: ${name}`
                        );
                        
                        if (success) {
                            addLog('Cập nhật sự kiện', `Đã cập nhật sự kiện "${name}" với ${imageArray.length} ảnh`);
                            showNotification('Đã cập nhật sự kiện thành công!', 'success');
                        }
                    }
                } else {
                    // Create new event
                    const newEvent = {
                        note_id: Date.now().toString(),
                        name: name,
                        day: date,
                        contdetl: description,
                        image: imageArray // Use selected image IDs
                    };
                    
                    eventsData.push(newEvent);
                    
                    success = await githubAPI.updateFile(
                        config.FILE_PATH, 
                        eventsData, 
                        `Thêm sự kiện mới: ${name}`
                    );
                    
                    if (success) {
                        addLog('Thêm sự kiện mới', `Đã thêm sự kiện "${name}" với ${imageArray.length} ảnh`);
                        showNotification('Đã lưu sự kiện thành công!', 'success');
                    } else {
                        eventsData.pop();
                    }
                }
                
                if (!success) {
                    showNotification('Lỗi khi lưu sự kiện!', 'error');
                } else {
                    // Refresh timeline and stats
                    loadTimeline();
                    updateStats();
                    loadTodayMemories();
                }
                
            } catch (error) {
                console.error('Error saving event:', error);
                if (!editingEventId) {
                    eventsData.pop();
                }
                showNotification('Lỗi khi lưu sự kiện!', 'error');
            }
            
            closeModal('eventModal');
            resetEventForm();
        }
        
        function resetEventForm() {
            document.getElementById('eventForm').reset();
            document.getElementById('selectedImagesCount').textContent = '0';
            selectedImages = [];
            editingEventId = null;
            
            // ▼▼▼ THÊM NGÀY HÔM NAY MẶC ĐỊNH ▼▼▼
            // Đặt ngày hôm nay làm mặc định khi thêm mới
            const today = new Date();
            const todayFormatted = `${String(today.getDate()).padStart(2, '0')}-${String(today.getMonth() + 1).padStart(2, '0')}-${today.getFullYear()}`;
            document.getElementById('eventDate').value = todayFormatted;
            // ▲▲▲ KẾT THÚC THÊM NGÀY MẶC ĐỊNH ▲▲▲
            
            // Reset modal title and button text
            const modalTitle = document.querySelector('#eventModal h3');
            modalTitle.innerHTML = '<i class="fas fa-plus mr-2"></i>Thêm Sự Kiện Mới';
            
            const submitBtn = document.querySelector('#eventModal button[type="submit"]');
            submitBtn.innerHTML = 'Lưu Sự Kiện';
        }

        function editEvent(id) {
            const event = eventsData.find(e => e.note_id === id);
            if (!event) {
                showNotification('Không tìm thấy sự kiện!', 'error');
                return;
            }
            
            // Set editing mode
            editingEventId = id;
            
            // Load event data into form
            document.getElementById('eventName').value = event.name || '';
            document.getElementById('eventDate').value = event.day || '';
            document.getElementById('eventDescription').value = event.contdetl || '';
            
            // Load current images - ensure it's an array
            const currentImages = Array.isArray(event.image) ? event.image : [];
            selectedImages = [...currentImages]; // Create a copy
            
            // Update selected images count
            document.getElementById('selectedImagesCount').textContent = selectedImages.length;
            
            // Update modal title to indicate editing
            const modalTitle = document.querySelector('#eventModal h3');
            modalTitle.innerHTML = '<i class="fas fa-edit mr-2"></i>Sửa Sự Kiện';
            
            // Update submit button text
            const submitBtn = document.querySelector('#eventModal button[type="submit"]');
            submitBtn.innerHTML = 'Cập Nhật Sự Kiện';
            
            // Open modal
            openModal('eventModal');
            
            addLog('Sửa sự kiện', `Đang sửa sự kiện "${event.name}"`);
        }

        async function deleteEvent(id) {
            const event = eventsData.find(e => e.note_id === id);
            if (!event) {
                showNotification('Không tìm thấy sự kiện!', 'error');
                return;
            }
            
            // Create custom confirmation modal instead of browser confirm
            const confirmDelete = await showCustomConfirm(`Bạn có chắc chắn muốn xóa sự kiện "${event.name}"?`);
            
            if (confirmDelete) {
                try {
                    // Remove event from array
                    const eventIndex = eventsData.findIndex(e => e.note_id === id);
                    if (eventIndex !== -1) {
                        eventsData.splice(eventIndex, 1);
                        
                        // Update GitHub
                        const success = await githubAPI.updateFile(
                            config.FILE_PATH, 
                            eventsData, 
                            `Xóa sự kiện: ${event.name}`
                        );
                        
                        if (success) {
                            addLog('Xóa sự kiện', `Đã xóa sự kiện "${event.name}"`);
                            showNotification('Đã xóa sự kiện thành công!', 'success');
                            
                            // Refresh timeline and stats
                            loadTimeline();
                            updateStats();
                            loadTodayMemories();
                        } else {
                            // Restore event if failed
                            eventsData.splice(eventIndex, 0, event);
                            showNotification('Lỗi khi xóa sự kiện!', 'error');
                        }
                    }
                } catch (error) {
                    console.error('Error deleting event:', error);
                    showNotification('Lỗi khi xóa sự kiện!', 'error');
                }
            }
        }
        
        function showCustomConfirm(message) {
            return new Promise((resolve) => {
                // Create custom confirmation overlay
                const overlay = document.createElement('div');
                overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                overlay.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-md mx-4">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Xác nhận xóa</h3>
                        <p class="text-gray-700 mb-6">${message}</p>
                        <div class="flex space-x-3 justify-end">
                            <button class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400" onclick="resolveConfirm(false)">
                                Hủy
                            </button>
                            <button class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600" onclick="resolveConfirm(true)">
                                Xóa
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(overlay);
                
                window.resolveConfirm = (result) => {
                    document.body.removeChild(overlay);
                    delete window.resolveConfirm;
                    resolve(result);
                };
            });
        }

        // Global variables for event photos pagination
        let currentEventPhotosPage = 1;
        let currentEventPhotos = [];
        const eventPhotosPerPage = 12;

        function viewEventPhotos(id) {
            const event = eventsData.find(e => e.note_id === id);
            if (!event) {
                showNotification('Không tìm thấy sự kiện!', 'error');
                return;
            }
            
            const modalTitle = document.querySelector('#eventPhotosModal h3');
            
            // Update modal title with event name
            modalTitle.innerHTML = `<i class="fas fa-images mr-2"></i>Ảnh: ${escapeHtml(event.name)}`;
            
            // Store current event photos
            currentEventPhotos = event.image || [];
            currentEventPhotosPage = 1;
            
            loadEventPhotosPage(1);
            openModal('eventPhotosModal');
            addLog('Xem ảnh sự kiện', `Đã xem ảnh của sự kiện "${event.name}"`);
        }

        function loadEventPhotosPage(page) {
            const eventPhotosGrid = document.getElementById('eventPhotosGrid');
            currentEventPhotosPage = page;
            
            if (currentEventPhotos.length === 0) {
                eventPhotosGrid.innerHTML = `
                    <div class="col-span-full text-center py-8 text-gray-500">
                        <i class="fas fa-images text-4xl mb-3"></i>
                        <p>Sự kiện này chưa có ảnh nào</p>
                    </div>
                `;
                updateEventPhotosPagination(0);
                return;
            }
            
            const totalPages = Math.ceil(currentEventPhotos.length / eventPhotosPerPage);
            const startIndex = (page - 1) * eventPhotosPerPage;
            const endIndex = startIndex + eventPhotosPerPage;
            const pagePhotos = currentEventPhotos.slice(startIndex, endIndex);
            
            eventPhotosGrid.innerHTML = pagePhotos.map(imageId => {
                const imageUrl = driveAPI.getImageUrl(imageId, 'thumbnail');
                const fullImageUrl = driveAPI.getImageUrl(imageId, 'view');
                
                return `
                    <div class="photo-item aspect-square rounded overflow-hidden cursor-pointer hover:opacity-80" 
                         onclick="viewPhoto('${driveAPI.getImageUrl(imageId, 'highQuality')}')">
                        <img src="${imageUrl}" alt="" class="w-full h-full object-cover"
                             onerror="this.src=''; this.style.display='none';">
                    </div>
                `;
            }).join('');
            
            updateEventPhotosPagination(totalPages);
        }

        function updateEventPhotosPagination(totalPages) {
            const modalContent = document.querySelector('#eventPhotosModal .modal-content');
            let paginationContainer = modalContent.querySelector('.event-photos-pagination');
            
            // Remove existing pagination if any
            if (paginationContainer) {
                paginationContainer.remove();
            }
            
            // Don't show pagination if only 1 page or no photos
            if (totalPages <= 1) return;
            
            // Create new pagination
            paginationContainer = document.createElement('div');
            paginationContainer.className = 'event-photos-pagination mt-4 flex justify-center items-center space-x-2';
            
            let paginationHTML = '';
            
            // Previous button
            if (currentEventPhotosPage > 1) {
                paginationHTML += `<button onclick="loadEventPhotosPage(${currentEventPhotosPage - 1})" class="love-button text-sm px-3 py-1">← Trước</button>`;
            }
            
            // Page info
            paginationHTML += `<span class="text-sm text-gray-600 mx-3">Trang ${currentEventPhotosPage} / ${totalPages}</span>`;
            
            // Next button
            if (currentEventPhotosPage < totalPages) {
                paginationHTML += `<button onclick="loadEventPhotosPage(${currentEventPhotosPage + 1})" class="love-button text-sm px-3 py-1">Sau →</button>`;
            }
            
            paginationContainer.innerHTML = paginationHTML;
            modalContent.appendChild(paginationContainer);
        }

        // Image selector functions
        let currentImageSelectorPage = 1;
        let totalImagePages = 1;

        function loadImageSelector(page = 1) {
            const imageSelector = document.getElementById('imageSelector');
            const photosPerPage = config.PHOTOS_PER_PAGE;
            currentImageSelectorPage = page;
            
            if (photosData.length === 0) {
                imageSelector.innerHTML = `
                    <div class="col-span-full text-center py-8 text-gray-500">
                        <i class="fas fa-images text-4xl mb-3"></i>
                        <p>Chưa có ảnh nào</p>
                        <button onclick="syncPhotosMetadata()" class="love-button mt-3">
                            <i class="fas fa-sync mr-2"></i>Đồng Bộ Ngay
                        </button>
                    </div>
                `;
                loadImageSelectorPagination(1, 1);
                return;
            }
            
            // Sort photos by creation time (newest first)
            const sortedPhotos = [...photosData].sort((a, b) => 
                new Date(b.createdTime) - new Date(a.createdTime)
            );
            
            totalImagePages = Math.ceil(sortedPhotos.length / photosPerPage);
            const startIndex = (page - 1) * photosPerPage;
            const endIndex = startIndex + photosPerPage;
            const pagePhotos = sortedPhotos.slice(startIndex, endIndex);
            
            // Set grid columns based on device
            const isMobile = window.innerWidth <= 768;
            const gridCols = isMobile ? 'grid-cols-3' : 'grid-cols-6';
            imageSelector.className = `grid ${gridCols} gap-3 max-h-96 overflow-y-auto mb-4`;
            
            imageSelector.innerHTML = pagePhotos.map(photo => {
                const isSelected = selectedImages.includes(photo.id);
                 
                // Xác định class cho icon (solid hoặc regular)
                const iconClass = isSelected 
                    ? 'fas fa-check-circle text-green-500 text-xl' // Icon được chọn
                    : 'far fa-check-circle text-gray-400 text-xl'; // Icon chưa chọn
 
                const iconHtml = `
                    <span class="absolute top-1.5 right-1.5 w-7 h-7 bg-white rounded-full flex items-center justify-center shadow-md">
                        <i class="${iconClass}"></i>
                    </span>
                `; 

                return `
                    
				<div class="photo-item relative aspect-square rounded overflow-hidden cursor-pointer border-2 border-transparent hover:border-primary" 
                         onclick="toggleImageSelection('${photo.id}', this)" title="${photo.name}">
                        <img src="${driveAPI.getImageUrl(photo.id, 'thumbnail')}" alt="${photo.name}" class="w-full h-full object-cover"
                             onerror="this.src=''; this.style.display='none';">
                        ${iconHtml} 
                 </div>
                `;
            }).join('');
            
            loadImageSelectorPagination(page, totalImagePages);
        }

        function loadImageSelectorPagination(currentPage, totalPages) {
          
            const paginationContainer = document.querySelector('#imageSelectorModal .flex.justify-between.items-center:last-child .flex.space-x-2'); 
            paginationContainer.classList.add('items-center'); 
            if (totalPages <= 0) {
                 paginationContainer.innerHTML = `<span class="text-sm text-gray-600">Trang 1 / 1</span>`;
                 return;
            }
            
            let paginationHTML = '';

            // Nút "Trước" (Previous)
            if (currentPage > 1) {
                // Sử dụng style 'text-sm' từ HTML gốc của modal và gọi hàm 'loadImageSelector'
                paginationHTML += `<button onclick="loadImageSelector(${currentPage - 1})" class="love-button text-sm">←</button>`;
            } else {
                // Thêm trạng thái 'disabled'
                paginationHTML += `<button class="love-button text-sm opacity-50 cursor-not-allowed" disabled>←</button>`;
            }

            // Văn bản "Trang X / Y" (Giống logic của màn hình Khoảnh khắc)
            // Thêm class 'px-3' để tạo khoảng cách với 2 nút
            paginationHTML += `<span class="text-sm text-gray-600 px-3">Trang ${currentPage} / ${totalPages}</span>`;

            // Nút "Sau" (Next)
            if (currentPage < totalPages) {
                // Sử dụng style 'text-sm' và gọi hàm 'loadImageSelector'
                paginationHTML += `<button onclick="loadImageSelector(${currentPage + 1})" class="love-button text-sm">→</button>`;
            } else {
                // Thêm trạng thái 'disabled'
                paginationHTML += `<button class="love-button text-sm opacity-50 cursor-not-allowed" disabled>→</button>`;
            }

            // Cập nhật HTML cho container
            paginationContainer.innerHTML = paginationHTML;
        }

        function selectAllImages() {
            let newSelections = 0;
            // Chọn tất cả các mục ảnh đang hiển thị
            document.querySelectorAll('#imageSelector .photo-item').forEach(item => {
                const onclick = item.getAttribute('onclick');
                const photoId = onclick.match(/'([^']+)'/)[1];
                
                // Thêm vào mảng selectedImages nếu chưa có
                if (!selectedImages.includes(photoId)) {
                    selectedImages.push(photoId);
                    newSelections++;
                }
                
                // Cập nhật icon sang trạng thái "đã chọn"
                const iconEl = item.querySelector('i');
                if (iconEl) {
                    iconEl.className = 'fas fa-check-circle text-green-500 text-xl';
                }
                
                // Xóa bất kỳ class ring nào còn sót lại (Yêu cầu số 3)
                item.classList.remove('ring-4', 'ring-primary');
            });
            
            // Cập nhật số lượng
            document.getElementById('selectedCount').textContent = selectedImages.length;
            
            if (newSelections > 0) {
                addLog('Chọn ảnh', `Đã chọn tất cả ${newSelections} ảnh trên trang hiện tại`);
            }
		}

        function deselectAllImages() {
            const previousCount = selectedImages.length;
            
            // Cập nhật tất cả icon sang trạng thái "chưa chọn"
            document.querySelectorAll('#imageSelector .photo-item').forEach(item => {
                const iconEl = item.querySelector('i');
                if (iconEl) {
                    iconEl.className = 'far fa-check-circle text-gray-400 text-xl';
                }
                // Xóa class ring (nếu có)
                item.classList.remove('ring-4', 'ring-primary');
            });
            
            // Xóa mảng
            selectedImages = [];
            document.getElementById('selectedCount').textContent = '0';
            
            if (previousCount > 0) {
                addLog('Chọn ảnh', `Đã bỏ chọn tất cả ${previousCount} ảnh`);
            }
		}

        function confirmImageSelection() {
            document.getElementById('selectedImagesCount').textContent = selectedImages.length;
            closeModal('imageSelectorModal');
        }

        // Chat functions
        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }
		 
		// Google AI helper - Refactored based on example
        class GoogleAI {
            constructor() {
 
                this.apiKey = config.AI_GOOGLE;  
                this.model = 'gemini-2.5-flash'; 
                this.apiVersion = 'v1beta'; 
            }

            /**
             * Gọi Google Generative AI API.
             * @param {object} prompt - Đối tượng chứa { query: string, context: string }.
             * @returns {Promise<string>} - Câu trả lời từ AI hoặc thông báo lỗi.
             */
            async generateResponse(prompt) {
               
                 const formattedPrompt = `
                    You are an AI assistant for a personal memory application called Love Story.
                    Use the following context data about the user's memories, media, and comments to answer their question.
                    Be friendly and helpful. If the context doesn't contain the answer, say you don't have that specific information but try to answer generally if possible.

                    Context Data:
                    ---
                    ${prompt.context || ''} 
                    ---

                    User's Question: ${prompt.query || prompt} 
                    `;

                 // 2. Tạo URL API động
                 const apiUrl = `https://generativelanguage.googleapis.com/${this.apiVersion}/models/${this.model}:generateContent?key=${config.AI_GOOGLE}`;

                 // 3. Chuẩn bị payload gửi đi
                 const payload = {
                     contents: [{
                         parts: [{
                             text: formattedPrompt
                         }]
                     }] 
                 };

                 try {
                     // 4. Thực hiện gọi API
                     const response = await fetch(apiUrl, {
                         method: 'POST',
                         headers: {
                             'Content-Type': 'application/json'
                         },
                         body: JSON.stringify(payload)
                     });

                     // 5. Xử lý kết quả
                     const result = await response.json();

                     if (!response.ok) {
                         // Xử lý lỗi từ API
                         console.error('Lỗi từ Google AI API:', result);
                         const errorMsg = result.error?.message || `Lỗi ${response.status}: ${response.statusText}`;
                         // Ném lỗi để hàm gọi (sendChatMessage) có thể bắt được
                         throw new Error(`Lỗi khi gọi Google AI API: ${errorMsg}`);
                     } else {
                         // Trích xuất văn bản từ kết quả thành công
                         const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                         if (text) {
                             return text.trim(); // Trả về nội dung text
                         } else {
                             console.warn("Cấu trúc phản hồi Google AI không mong đợi:", result);
                             // Ném lỗi nếu không có text
                             throw new Error("Không nhận được nội dung văn bản từ Google AI.");
                         }
                     }

                 } catch (error) {
                     // Bắt lỗi mạng hoặc lỗi JavaScript trong quá trình gọi
                     console.error('Lỗi mạng hoặc JavaScript khi gọi Google AI:', error);
                     // Ném lại lỗi để hàm gọi xử lý
                     throw new Error(`Đã xảy ra lỗi khi kết nối Google AI: ${error.message}`);
                 }
            }
        }
		 
        const googleAI = new GoogleAI(); 
		
		/**
         * WARNING: INSECURE - Calls OpenAI API directly from the client-side.
         * Your API key is exposed in the browser.
         * @param {string} userQuery The user's question.
         * @param {string} localContext Dữ liệu tóm tắt (events, comments, etc.).
         * @returns {Promise<string>} Câu trả lời từ GPT hoặc thông báo lỗi.
         */
        async function callGPTAPI(userQuery, localContext) {
            
			const apiKey = config.AI_GPT1 + config.AI_GPT2;
            const apiUrl = "https://api.openai.com/v1/chat/completions";
 
            const fullPrompt = `
						You are an AI assistant for a personal memory application called Love Story.
						Use the following context data about the user's memories, media, and comments to answer their question.
						Be friendly and helpful. If the context doesn't contain the answer, say you don't have that specific information but try to answer generally if possible.

						Context Data:
						---
						${localContext}
						---

						User's Question: ${userQuery}
						`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}` // Use the insecure key here
                    },
                    body: JSON.stringify({
                        model: "gpt-3.5-turbo", // Or another model like "gpt-4" if you have access
                        messages: [
                            {
                                role: "system",
                                content: "You are a helpful assistant for the Love Story application."
                            },
                            {
                                role: "user",
                                content: fullPrompt
                            }
                        ],
                        max_tokens: 150, // Limit response length
                        temperature: 0.7 // Controls creativity vs determinism
                    }),
                });

                if (!response.ok) {
                     const errorData = await response.json();
                     console.error("OpenAI API Error:", errorData);
                    throw new Error(`Error from OpenAI API: ${response.statusText} - ${errorData.error?.message || 'Unknown error'}`);
                }

                const data = await response.json();
                // Extract the answer from the response structure
                return data.choices?.[0]?.message?.content?.trim() || "GPT didn't provide a valid answer.";

            } catch (error) {
                console.error('Error calling OpenAI API directly:', error);
                // Provide a more user-friendly error message
                let errorMessage = "An error occurred connecting to the advanced AI.";
                if (error.message.includes("Incorrect API key")) {
                    errorMessage = "Connection failed: Invalid API key.";
                } else if (error.message.includes("quota")) {
                    errorMessage = "Could not connect: API quota exceeded.";
                }
                return errorMessage;
            }
        }
		
		function switchAiModel(modelName) {
            currentAiModel = modelName; // Update the global variable

            // Update button styles
            document.querySelectorAll('.ai-mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeButton = document.getElementById(`aiModeBtn-${modelName}`);
            if (activeButton) {
                activeButton.classList.add('active');
            }
            //showNotification(`Đã chuyển sang ${modelName.toUpperCase()} AI`, 'info');
            addLog('Chat AI', `Chuyển sang model: ${modelName.toUpperCase()}`);
        }
		
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            addLog('Chat AI', `Đã gửi tin nhắn: "${message.length > 50 ? message.substring(0, 50) + '...' : message}"`);
            const container = document.getElementById('chatMessages');

            // Add user message to UI
            container.innerHTML += `
                <div class="mb-4 text-right">
                    <div class="inline-block bg-primary text-white rounded-lg px-4 py-2 max-w-xs">
                        ${escapeHtml(message)}
                    </div>
                </div>
            `;
            input.value = '';
            container.scrollTop = container.scrollHeight;

            // Show typing indicator
            const typingId = 'typing-' + Date.now();
            container.innerHTML += `
                <div class="mb-4" id="${typingId}">
                    <div class="inline-block bg-accent border border-custom rounded-lg px-4 py-2 max-w-xs">
                        <div class="flex items-center mb-1">
                            <i class="fas fa-robot text-primary mr-2"></i>
                            <strong class="text-primary">AI</strong>
                        </div>
                        <div class="flex space-x-1">
                            <div class="w-2 h-2 bg-primary rounded-full animate-bounce"></div>
                            <div class="w-2 h-2 bg-primary rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                            <div class="w-2 h-2 bg-primary rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                        </div>
                    </div>
                </div>
            `;
            container.scrollTop = container.scrollHeight;

            let aiResponse = "";
            const fallbackMessage = "Xin lỗi, tôi chưa hiểu câu hỏi của bạn hoặc chưa được lập trình để trả lời về điều đó."; // Define fallback message

            try {
                
                 const eventSummary = eventsData.slice(0, 20).map(e => `- Name: ${e.name} (Date: ${e.day}, Description: ${e.contdetl || 'none'})`).join('\n');
                 const photoSummary = `Total media (photos/videos): ${photosData.length}.`;
                 const profileSummary = `Current user's name: ${currentUser.name}.`;
                 const allComments = commentsData.flatMap(c => (c.comments || []).map(comment => ({ ...comment, imageName: c.ID_IMG }))).sort((a, b) => new Date(b.date_input) - new Date(a.date_input));
                 const recentCommentSummary = allComments.slice(0, 5).map(c => `- (On image: ${c.imageName}) ${c.userName}: "${c.comment}"`).join('\n');
                 const commentSummary = `Total comments: ${allComments.length}\n5 most recent comments:\n${recentCommentSummary || "No comments yet."}`;
                 const localContext = `USER PROFILE:\n${profileSummary}\n\nEVENT SUMMARY (Up to 20 most recent):\n${eventSummary}\n\nMEDIA & COMMENT SUMMARY:\n${photoSummary}\n${commentSummary}`;

                if (currentAiModel === 'gpt') {
                    aiResponse = await callGPTAPI(message, localContext);
                } else if (currentAiModel === 'google') {
                   
                    const googleAIInstance = googleAI || new GoogleAI();
                   
                    aiResponse = await googleAIInstance.generateResponse({ query: message, context: localContext });
                } else {
                    aiResponse = "Lỗi: Chế độ AI không xác định.";
                }

            } catch (error) {
                console.error(`Error during ${currentAiModel} AI processing:`, error);
                aiResponse = `Đã xảy ra lỗi khi tôi đang xử lý bằng ${currentAiModel.toUpperCase()} AI.`;
            }

            const typingIndicator = document.getElementById(typingId);
            if (typingIndicator) {
                typingIndicator.remove();
            }

            container.innerHTML += `
                <div class="mb-4">
                    <div class="inline-block bg-accent border border-custom rounded-lg px-4 py-2 max-w-xs">
                        <div class="flex items-center mb-1">
                            <i class="fas fa-robot text-primary mr-2"></i>
                            <strong class="text-primary">AI</strong> </div>
                        ${escapeHtml(aiResponse)}
                    </div>
                </div>
            `;
            container.scrollTop = container.scrollHeight;
        }

        // Search functions
        function quickSearch(query) {
            document.getElementById('searchInput').value = query;
            performSearch(query);
        }

        function performSearch(query) {
            const results = document.getElementById('searchResults');
            
            // Simulate search results
            const matchingEvents = sampleEvents.filter(event => 
                event.name.toLowerCase().includes(query.toLowerCase()) ||
                event.description.toLowerCase().includes(query.toLowerCase())
            );
            
            if (matchingEvents.length > 0) {
                results.innerHTML = matchingEvents.map(event => `
                    <div class="love-card rounded p-3 mb-2 cursor-pointer hover:shadow-md">
                        <h4 class="font-medium text-primary">${event.name}</h4>
                        <p class="text-sm text-gray-600">${formatDate(event.date)}</p>
                    </div>
                `).join('');
            } else {
                results.innerHTML = `
                    <div class="text-center py-4 text-gray-500">
                        <i class="fas fa-search text-2xl mb-2"></i>
                        <p>Không tìm thấy kết quả nào</p>
                    </div>
                `;
            }
        }

        // Utility functions
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // New configuration functions
        function loadAppConfigToUI() {
            // Load auto sync settings
            document.getElementById('autoSync').checked = config.AUTO_SYNC_METADATA.enabled;
            document.getElementById('syncFrequency').value = config.AUTO_SYNC_METADATA.frequency;
            document.getElementById('syncTime').value = config.AUTO_SYNC_METADATA.time;
            
            // Load logs setting
            document.getElementById('enableLogs').checked = config.ENABLE_LOGS;
        }

        function formatTimeInput(input) {
            let value = input.value.replace(/\D/g, ''); // Remove non-digits
            
            if (value.length >= 2) {
                value = value.substring(0, 2) + ':' + value.substring(2, 4);
            }
            
            input.value = value;
        }

        function updateAutoSyncConfig() {
            config.AUTO_SYNC_METADATA.enabled = document.getElementById('autoSync').checked;
            config.AUTO_SYNC_METADATA.frequency = document.getElementById('syncFrequency').value;
            config.AUTO_SYNC_METADATA.time = document.getElementById('syncTime').value;
            
            // Update sync status display when config changes
            updateSyncStatus();
            
            // Log the configuration change
            const statusText = config.AUTO_SYNC_METADATA.enabled ? 'Bật' : 'Tắt';
            addLog('Cài đặt tự động đồng bộ', 
                `${statusText} tự động đồng bộ - Tần suất: ${config.AUTO_SYNC_METADATA.frequency}, Thời gian: ${config.AUTO_SYNC_METADATA.time}`);
        }

        function updateLogsConfig() {
            config.ENABLE_LOGS = document.getElementById('enableLogs').checked;
        }

        async function manualSync() {
            await syncPhotosMetadata(true);
            updateSyncStatus();
        }
 
        function updateSyncStatus() {
            updateLogCounts();
        }

        async function saveAppConfig() {
            try {
                // Update config from UI
                updateAutoSyncConfig();
                updateLogsConfig();
                
                // Save to GitHub
                const success = await githubAPI.updateFile(
                    config.CONFIG_FILE_PATH,
                    appConfigData,
                    'Cập nhật cấu hình ứng dụng'
                );
                
                if (success) {
                    showNotification('Lưu cấu hình thành công!', 'success');
                    addLog('Lưu cấu hình', 'Đã lưu cấu hình ứng dụng');
                } else {
                    showNotification('Lỗi khi lưu cấu hình!', 'error');
                }
                
            } catch (error) {
                console.error('Error saving config:', error);
                showNotification('Lỗi khi lưu cấu hình!', 'error');
            }
        }
 
        function addLog(action, details) {
            // Chỉ ghi log nếu người dùng cho phép trong cài đặt
            if (!document.getElementById('enableLogs').checked) return;
            
            const newLog = {
                timestamp: new Date().toISOString(),
                action: action,
                details: details,
                username: getSessionId(), // Lấy ID của phiên làm việc
                saved: false // Trạng thái lưu file: false = chưa lưu, true = đã lưu
            };
            
            // Thêm log mới vào hàng đợi
            logQueue.push(newLog);
            
            // Cập nhật số lượng log đang chờ trên giao diện
            updateLogCounts();
        }

        function getSessionId() {
            let sessionId = sessionStorage.getItem('sessionId');
            if (!sessionId) {
                sessionId = Date.now().toString();
                sessionStorage.setItem('sessionId', sessionId);
            }
            return sessionId;
        }

        function updateOnlineStatus() {
            const statusElement = document.getElementById('onlineStatus');
            if (isOnline) {
                statusElement.textContent = 'Online';
                statusElement.className = 'font-bold text-green-600';
                statusElement.previousElementSibling.className = 'status-indicator status-online';
            } else {
                statusElement.textContent = 'Offline';
                statusElement.className = 'font-bold text-red-600';
                statusElement.previousElementSibling.className = 'status-indicator status-offline';
            }
        }
		
		function triggerAvatarUpload() {
            // 1. Kích hoạt input file ẩn khi bấm nút icon
            document.getElementById('avatarUpload').click();
        }

        async function handleAvatarUpload(event) {
            // 2. Lấy file người dùng chọn
            const file = event.target.files[0];
            if (!file || !file.type.startsWith('image/')) {
                return;
            }
            
            try {
                // 3. Resize ảnh về ~30KB (30 * 1024 = 30720 bytes)
                //    với kích thước tối đa 256px
                const resizedBlob = await resizeImage(file, 30720, 256);
                
                // 4. Chuyển blob đã resize thành dataURL để hiển thị
                const reader = new FileReader();
                reader.onloadend = () => {
                    const dataURL = reader.result;
                    // 5. Cập nhật ảnh lên giao diện và lưu
                    updateAvatar(dataURL);
                    showNotification('Đã cập nhật avatar!', 'success');
                };
                reader.readAsDataURL(resizedBlob);
                
            } catch (error) {
                console.error('Lỗi resize ảnh:', error);
                showNotification('Lỗi khi resize ảnh!', 'error');
            }
            
            // Reset input để người dùng có thể tải lại cùng 1 file
            event.target.value = null;
        }

        /**
         * Cắt (crop) ảnh thành hình vuông, resize, và nén ảnh
         * @param {File} file File ảnh
         * @param {number} targetBytes Kích thước mong muốn (ví dụ: 30000)
         * @param {number} finalSize Kích thước cạnh cuối cùng (ví dụ: 256, cho 256x256)
         * @returns {Promise<Blob>} Blob ảnh đã resize
         */
        function resizeImage(file, targetBytes, finalSize) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = async () => {
                        
                        // 1. Xác định kích thước và vị trí crop
                        // Lấy chiều ngắn nhất của ảnh
                        const shortestSide = Math.min(img.width, img.height);
                        // Tính toán vị trí bắt đầu (X, Y) để crop từ tâm
                        const sourceX = (img.width - shortestSide) / 2;
                        const sourceY = (img.height - shortestSide) / 2;

                        // 2. Tạo canvas vuông
                        const canvas = document.createElement('canvas');
                        canvas.width = finalSize; // Kích thước cuối cùng (e.g., 256)
                        canvas.height = finalSize; // Kích thước cuối cùng (e.g., 256)
                        const ctx = canvas.getContext('2d');
                        
                        // 3. Vẽ phần đã crop (từ ảnh gốc) vào canvas (đã resize)
                        // Lệnh này sẽ lấy 1 hình vuông (shortestSide x shortestSide) từ tâm ảnh gốc
                        // và vẽ nó vào canvas (finalSize x finalSize)
                        ctx.drawImage(
                            img, 
                            sourceX,      // Bắt đầu crop X từ ảnh gốc
                            sourceY,      // Bắt đầu crop Y từ ảnh gốc
                            shortestSide, // Chiều rộng vùng crop
                            shortestSide, // Chiều cao vùng crop
                            0,            // Vẽ vào X=0 của canvas
                            0,            // Vẽ vào Y=0 của canvas
                            finalSize,    // Chiều rộng canvas (resize)
                            finalSize     // Chiều cao canvas (resize)
                        );
                        
                        // Lặp để giảm chất lượng JPEG cho đến khi đạt < 30KB
                        for (let quality = 0.9; quality >= 0.1; quality -= 0.1) {
                            const blob = await new Promise(resolveBlob => 
                                canvas.toBlob(resolveBlob, 'image/jpeg', quality)
                            );
                            
                            if (blob.size <= targetBytes) {
                                resolve(blob); // Trả về blob đạt yêu cầu
                                return;
                            }
                        }
                        
                        // Nếu không thể < 30KB, trả về chất lượng thấp nhất
                        canvas.toBlob(resolve, 'image/jpeg', 0.1);

                    };
                    img.onerror = reject;
                    img.src = e.target.result; // DataURL từ FileReader
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Cập nhật ảnh đại diện trên UI và lưu vào bộ nhớ
        function updateAvatar(dataURL) {
            // Cập nhật tất cả các ảnh có alt="Avatar"
            document.querySelectorAll('img[alt="Avatar"]').forEach(img => {
                img.src = dataURL;
            });
            
			document.getElementById('profileAvatarImg').src = dataURL;
			
            // Cập nhật đối tượng currentUser và lưu vào localStorage
            if (currentUser) {
                currentUser.avatarUrl = dataURL;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
            }
        }
		
		async function saveProfile() {
            try {
                // 1. Lấy dữ liệu từ các input và ảnh
                const name = document.getElementById('profileNameInput').value;
                const username = document.getElementById('profileUsernameInput').value.trim(); // Dùng trim()
                const avatarUrl = document.getElementById('profileAvatarImg').src; 
                const createdAt = new Date().toISOString();

                if (!name || !username) {
                    showNotification('Họ tên và Tên đăng nhập là bắt buộc!', 'error');
                    return;
                }

                // 2. Tạo đối tượng hồ sơ
                const updatedProfile = { name, username, avatarUrl, createdAt };

                // 3. Cập nhật hoặc thêm mới vào mảng profilesData
                // Tìm hồ sơ dựa trên TÊN ĐĂNG NHẬP (từ input)
                let userIndex = profilesData.findIndex(p => p.username === username);

                if (userIndex !== -1) {
                    // TRƯỜNG HỢP 1 & 3: Tên đăng nhập đã tồn tại (Login hoặc Update)
                    // Cập nhật hồ sơ tại vị trí đó
                    profilesData[userIndex] = { ...profilesData[userIndex], ...updatedProfile };
                } else {
                    // TRƯỜNG HỢP 2: Tên đăng nhập mới (Rename)
                    // Tìm user cũ (currentUser) để xóa
                    let oldUserIndex = profilesData.findIndex(p => p.username === currentUser.username);
                    if (oldUserIndex !== -1) {
                        // Xóa user cũ (vì họ đã đổi tên)
                        profilesData.splice(oldUserIndex, 1);
                    }
                    // Thêm hồ sơ mới (với tên đã đổi)
                    profilesData.push(updatedProfile);
                }

                // 4. Cập nhật currentUser (global) và localStorage
                currentUser = updatedProfile;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // 5. Cập nhật UI (header)
                updateUserProfile();
                
                // 6. Lưu file profiles.json lên GitHub
                const success = await githubAPI.updateFile(
                    config.PROFILES_FILE_PATH, 
                    profilesData, 
                    `Cập nhật hồ sơ: ${username}`
                );

                if (success) {
                    showNotification('Đã lưu hồ sơ thành công!', 'success');
                    addLog('Hồ sơ', `Đã cập nhật hồ sơ: ${username}`);
                } else {
                    showNotification('Lỗi khi lưu hồ sơ lên GitHub!', 'error');
                }
                
                closeModal('profileModal');

            } catch (error) {
                console.error('Lỗi khi lưu hồ sơ:', error);
                showNotification('Đã xảy ra lỗi khi lưu!', 'error');
            }
        }

        function logoutProfile() {
            // 1. Xóa bộ nhớ
            localStorage.removeItem('currentUser');
            currentUser = null;
            
            // 2. Clear các ô input trong modal
            document.getElementById('profileNameInput').value = '';
            document.getElementById('profileUsernameInput').value = '';
            
            // 3. Reset avatar trong modal
            const defaultAvatar = 'https://ui-avatars.com/api/?name=?&background=006B68&color=fff&size=100';
            document.getElementById('profileAvatarImg').src = defaultAvatar;

            // 4. Đóng modal và thông báo
            closeModal('profileModal');
            showNotification('Đã đăng xuất!', 'info');
            
            // 5. Tải lại user (sẽ tự động tạo user "động vật" mới)
            loadCurrentUser();
        }
		
		function checkExistingUsername() {
            const usernameInput = document.getElementById('profileUsernameInput');
            const username = usernameInput.value.trim(); // Lấy tên đăng nhập đã nhập

            // Không cần check nếu tên đăng nhập rỗng
            if (!username) return;

            // 1. Tìm kiếm trong toàn bộ profilesData [cite: 210]
            const existingProfile = profilesData.find(p => p.username === username);

            // 2. Nếu tìm thấy hồ sơ VÀ nó không phải là hồ sơ hiện tại
            if (existingProfile && existingProfile.username !== currentUser?.username) {
                
                // 3. Tải (load) Họ tên và Avatar tìm thấy vào các ô input [cite: 119]
                document.getElementById('profileNameInput').value = existingProfile.name;
                document.getElementById('profileAvatarImg').src = existingProfile.avatarUrl;
                
                // 4. THAY ĐỔI: Chuyển đổi client sang hồ sơ này ngay lập tức
                currentUser = existingProfile;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // 5. Cập nhật header
                updateUserProfile(); 
                
                // 6. Thông báo
                showNotification(`Đã chuyển sang hồ sơ: ${existingProfile.name}`, 'success');
                addLog('Hồ sơ', `Đã chuyển đổi sang hồ sơ ${existingProfile.name}`);
            }
        }
		
		async function updateStorageUsageDisplay() {
            // Ưu tiên sử dụng API Storage.estimate() hiện đại nếu có
            if (navigator.storage && navigator.storage.estimate) {
                try {
                    const estimate = await navigator.storage.estimate();
                    // estimate.usage là tổng số byte được sử dụng
                    const formattedSize = formatFileSize(estimate.usage);
                    document.getElementById('storageUsageDisplay').textContent = formattedSize;
                } catch (error) {
                    console.error('Lỗi khi ước tính dung lượng (Storage.estimate):', error);
                    calculateManualStorageUsage(); // Sử dụng phương pháp dự phòng
                }
            } else {
                calculateManualStorageUsage(); // Sử dụng phương pháp dự phòng cho trình duyệt cũ
            }
        }
        
        function calculateManualStorageUsage() {
            // Phương pháp dự phòng: tính toán thủ công localStorage và sessionStorage
            try {
                let totalBytes = 0;
                
                // Tính toán localStorage
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    const value = localStorage.getItem(key);
                    // Ước tính 2 byte mỗi ký tự (UTF-16)
                    totalBytes += (key.length + (value ? value.length : 0)) * 2; 
                }

                // Tính toán sessionStorage
                for (let i = 0; i < sessionStorage.length; i++) {
                    const key = sessionStorage.key(i);
                    const value = sessionStorage.getItem(key);
                    totalBytes += (key.length + (value ? value.length : 0)) * 2; 
                }

                // Sử dụng hàm formatFileSize đã có [cite: 412]
                const formattedSize = formatFileSize(totalBytes);
                document.getElementById('storageUsageDisplay').textContent = formattedSize;
            } catch (error) {
                console.error('Lỗi khi tính dung lượng thủ công:', error);
                document.getElementById('storageUsageDisplay').textContent = 'Lỗi';
            }
        }

        function updateTotalLogs() {
            document.getElementById('totalLogs').textContent = logsData.length.toLocaleString();
        }

        async function saveLogsBatch() {
            // Nếu không có log nào trong hàng đợi hoặc đang offline thì không làm gì cả
            if (logQueue.length === 0 || !isOnline) {
                return;
            }

            // Sao chép toàn bộ log đang chờ và xóa hàng đợi ngay lập tức
            // để các log mới có thể được thêm vào trong lúc đang lưu
            const logsToSave = [...logQueue];
            logQueue = [];
            updateLogCounts(); // Cập nhật giao diện về 0
            
            try {
                // Đánh dấu các log này là đã lưu
                const savedLogs = logsToSave.map(log => ({
                    ...log,
                    saved: true
                }));
                
                // Thêm các log mới vào đầu mảng logsData đã tải về
                logsData.unshift(...savedLogs.reverse());

                // Giới hạn chỉ lưu 1000 log gần nhất để file không quá lớn
                if (logsData.length > 1000) {
                    logsData.splice(1000);
                }
                
                // Gọi API để cập nhật file logs.json trên GitHub
                const success = await githubAPI.updateFile(
                    config.LOGS_FILE_PATH,
                    logsData,
                    `Batch log update: ${logsToSave.length} entries`
                );
                
                if (success) {
                    console.log(`Lưu thành công ${logsToSave.length} nhật ký.`);
                    // Cập nhật lại tổng số log trên giao diện
                    updateLogCounts();
                } else {
                    // Nếu lưu thất bại, trả lại các log vào hàng đợi để thử lại lần sau
                    console.error("Lưu nhật ký thất bại, các nhật ký đã được đưa lại vào hàng đợi.");
                    logQueue.unshift(...logsToSave);
                    updateLogCounts();
                }
            } catch (error) {
                console.error('Lỗi nghiêm trọng khi đang lưu nhật ký:', error);
                // Trả lại log vào hàng đợi nếu có lỗi xảy ra
                logQueue.unshift(...logsToSave);
                updateLogCounts();
            }
        }
        function updateLogCounts() {
            // Cập nhật số log chờ lưu (trong hàng đợi)
            document.getElementById('pendingLogs').textContent = logQueue.length;
            
            // Cập nhật tổng số log và số log đã lưu
            const totalLogs = logsData.length + logQueue.length;
            const savedLogs = logsData.filter(log => log.saved !== false).length;
            
            document.getElementById('totalLogs').textContent = totalLogs.toLocaleString();
            document.getElementById('savedLogs').textContent = savedLogs.toLocaleString();
        }

        // Giữ lại hàm cũ để tương thích
        function updatePendingLogs() {
            updateLogCounts();
        }

        function updateTotalLogs() {
            updateLogCounts();
        }

        function loadLogsToModal() {
            const container = document.getElementById('logsContainer');
            const filter = document.getElementById('logFilter')?.value || 'all';
            
            let filteredLogs = logsData;
            if (filter !== 'all') {
                filteredLogs = logsData.filter(log => log.action === filter);
            }
            
            if (filteredLogs.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-file-alt text-4xl mb-3"></i>
                        <p>Không có nhật ký nào${filter !== 'all' ? ' cho bộ lọc này' : ''}</p>
                    </div>
                `;
                return;
            }
            
            // Kết hợp logs đã lưu và logs chờ lưu để hiển thị
            const allLogs = [...logsData, ...logQueue.map(log => ({...log, saved: false}))];
            const sortedLogs = allLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            let displayLogs = sortedLogs;
            if (filter !== 'all') {
                displayLogs = sortedLogs.filter(log => log.action === filter);
            }
            
            container.innerHTML = displayLogs.slice(0, 50).map(log => {
                const timeAgo = getTimeAgo(log.timestamp);
                const actionIcon = getActionIcon(log.action);
                const isUnsaved = log.saved === false;
                const cardClass = isUnsaved ? 'log-pending' : 'log-saved';
                const statusIcon = isUnsaved ? 
                    '<i class="fas fa-clock text-orange-500 mr-1" title="Chờ lưu file"></i>' : 
                    '<i class="fas fa-check-circle text-green-500 mr-1" title="Đã lưu file"></i>';
                
                return `
                    <div class="love-card rounded p-3 text-sm ${cardClass}">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center mb-1">
                                    <i class="${actionIcon} text-primary mr-2"></i>
                                    <strong class="mr-2">${escapeHtml(log.action)}</strong>
                                    ${statusIcon}
                                </div>
                                <p class="text-gray-600 ml-6">${escapeHtml(log.details)}</p>
                            </div>
                            <div class="text-right ml-3">
                                <span class="text-xs text-gray-500">${timeAgo}</span>
                                <br>
                                <span class="text-xs text-gray-400">${formatDateToDDMMYYHHMMSS(log.timestamp)}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            if (displayLogs.length > 50) {
                container.innerHTML += `
                    <div class="text-center py-3 text-gray-500 text-sm">
                        Hiển thị 50/${displayLogs.length} bản ghi gần nhất
                        <br>
                        <span class="text-xs">
                            <i class="fas fa-clock text-orange-500 mr-1"></i>Chờ lưu: ${logQueue.length} | 
                            <i class="fas fa-check-circle text-green-500 mr-1"></i>Đã lưu: ${logsData.length}
                        </span>
                    </div>
                `;
            }
        }

        function getActionIcon(action) {
            const icons = {
                'Điều hướng': 'fas fa-compass',
                'Thêm sự kiện mới': 'fas fa-plus-circle',
                'Cập nhật sự kiện': 'fas fa-edit',
                'Xóa sự kiện': 'fas fa-trash',
                'Đồng bộ media': 'fas fa-sync',
                'Thay đổi theme': 'fas fa-palette',
                'Thay đổi chế độ xem': 'fas fa-th',
                'Mở modal': 'fas fa-window-maximize',
                'Tương tác ảnh': 'fas fa-heart',
                'Bình luận ảnh': 'fas fa-comment',
                'Phân trang ảnh': 'fas fa-arrow-right',
                'Sửa sự kiện': 'fas fa-edit',
                'Xem ảnh sự kiện': 'fas fa-images',
                'Cài đặt giao diện': 'fas fa-cog',
                'Lưu cấu hình': 'fas fa-save',
                'Tải ảnh': 'fas fa-download',
                'Chọn ảnh': 'fas fa-check-square',
                'Chat AI': 'fas fa-robot',
                'Xuất nhật ký': 'fas fa-file-export'
            };
            return icons[action] || 'fas fa-info-circle';
        }

        function getTimeAgo(timestamp) {
            const now = new Date();
            const time = new Date(timestamp);
            const diffInSeconds = Math.floor((now - time) / 1000);
            
            if (diffInSeconds < 60) return `${diffInSeconds} giây trước`;
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} phút trước`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} giờ trước`;
            if (diffInSeconds < 2592000) return `${Math.floor(diffInSeconds / 86400)} ngày trước`;
            return `${Math.floor(diffInSeconds / 2592000)} tháng trước`;
        }

        function filterLogs() {
            loadLogsToModal();
        }

        async function clearAllLogs() {
            const confirmClear = await showCustomConfirm('Bạn có chắc chắn muốn xóa tất cả nhật ký hoạt động?');
            
            if (confirmClear) {
                try {
                    logsData = [];
                    
                    const success = await githubAPI.updateFile(
                        config.LOGS_FILE_PATH,
                        logsData,
                        'Xóa tất cả nhật ký hoạt động'
                    );
                    
                    if (success) {
                        loadLogsToModal();
                        updateTotalLogs();
                        showNotification('Đã xóa tất cả nhật ký!', 'success');
                    } else {
                        showNotification('Lỗi khi xóa nhật ký!', 'error');
                    }
                } catch (error) {
                    console.error('Error clearing logs:', error);
                    showNotification('Lỗi khi xóa nhật ký!', 'error');
                }
            }
        }

        function exportLogs() {
            try {
                const filter = document.getElementById('logFilter')?.value || 'all';
                let exportData = logsData;
                
                if (filter !== 'all') {
                    exportData = logsData.filter(log => log.action === filter);
                }
                
                // Create CSV content
                const csvContent = [
                    ['Thời gian', 'Hành động', 'Chi tiết', 'Session ID'].join(','),
                    ...exportData.map(log => [
                        `"${formatDateToDDMMYYHHMMSS(log.timestamp)}"`,
                        `"${log.action}"`,
                        `"${log.details.replace(/"/g, '""')}"`,
                        `"${log.sessionId}"`
                    ].join(','))
                ].join('\n');
                
                // Create and download file
                const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `nhat-ky-hoat-dong-${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification(`Đã xuất ${exportData.length} bản ghi nhật ký!`, 'success');
                addLog('Xuất nhật ký', `Đã xuất ${exportData.length} bản ghi nhật ký ra file CSV`);
                
            } catch (error) {
                console.error('Error exporting logs:', error);
                showNotification('Lỗi khi xuất nhật ký!', 'error');
            }
        }

        function showNotification(message, type = 'info') {
            if (!config.ENABLE_NOTI) return;
			
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white z-50 ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }



        // Load image selector when modal opens
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('show');
            if (modalId === 'imageSelectorModal') {
                loadImageSelector(1); // Start from page 1
            } else if (modalId === 'eventModal' && !editingEventId) {
                // Reset form only when adding new event
                resetEventForm();
            } else if (modalId === 'profileModal') {
                // Tải dữ liệu người dùng hiện tại vào modal
                if (currentUser) {
                    document.getElementById('profileNameInput').value = currentUser.name;
                    document.getElementById('profileUsernameInput').value = currentUser.username;
                    document.getElementById('profileAvatarImg').src = currentUser.avatarUrl;
                }
            }
            
            // Log modal opening
            const modalNames = {
                'searchModal': 'Tìm kiếm & AI',
                'profileModal': 'Hồ sơ cá nhân',
                'eventModal': editingEventId ? 'Sửa sự kiện' : 'Thêm sự kiện mới',
                'photoModal': 'Xem ảnh chi tiết',
                'shareModal': 'Chia sẻ ảnh',
                'imageSelectorModal': 'Chọn ảnh',
                'eventPhotosModal': 'Xem ảnh sự kiện',
                'logsModal': 'Nhật ký hoạt động'
            };
            
            if (modalNames[modalId]) {
                addLog('Mở modal', `Đã mở "${modalNames[modalId]}"`);
            }
            
            // Load logs when opening logs modal
            if (modalId === 'logsModal') {
                loadLogsToModal();
            }
        }

        function toggleImageSelection(id, element) {
            const wasSelected = selectedImages.includes(id);
            // Tìm icon <i> bên trong element được nhấp
            const iconEl = element.querySelector('i');
            if (!iconEl) return; // Thoát nếu không tìm thấy icon

			if (wasSelected) {
                // Bỏ chọn
                selectedImages = selectedImages.filter(i => i !== id);
                // Đổi class của icon sang trạng thái "chưa chọn" (viền, xám)
                iconEl.className = 'far fa-check-circle text-gray-400 text-xl';
                addLog('Chọn ảnh', `Đã bỏ chọn ảnh (ID: ${id})`);
			} else {
                // Chọn
                selectedImages.push(id);
                // Đổi class của icon sang trạng thái "đã chọn" (solid, green)
                iconEl.className = 'fas fa-check-circle text-green-500 text-xl';
                addLog('Chọn ảnh', `Đã chọn ảnh (ID: ${id})`);
            }
            document.getElementById('selectedCount').textContent = selectedImages.length;
}

        // Photo interaction functions
        function loadPhotoLikes(photoName) {
            const photoComments = commentsData.find(c => c.ID_IMG === photoName);
            const likeButton = document.getElementById('likeButton');
            const likeIcon = document.getElementById('likeIcon');
            const likeText = document.getElementById('likeText');
            const likeCount = document.getElementById('likeCount');
            
            let likes = [];
            let isLiked = false;
            
            if (photoComments && photoComments.tim && Array.isArray(photoComments.tim)) {
                likes = photoComments.tim;
                isLiked = likes.some(like => like.userName === currentUser.username);
            }
            
            // Update UI
            likeCount.textContent = likes.length;
            if (isLiked) {
                likeIcon.className = 'fas fa-heart mr-2 text-white';
                likeText.textContent = 'Thích';
                likeButton.classList.remove('bg-primary', 'hover:opacity-90', 'hover:translate-y-[-1px]'); 
                 
                likeButton.style.backgroundColor = '#ff0000';
                likeButton.style.color = 'white';
                
            } else {
                likeIcon.className = 'fas fa-heart mr-2';
                likeText.textContent = 'Thích';
                likeButton.classList.add('bg-primary', 'hover:opacity-90', 'hover:translate-y-[-1px]');
                likeButton.style.backgroundColor = ''; 
                likeButton.style.color = '';
            }
        }

        async function toggleLike() {
            if (!currentPhotoName || !currentUser) return;
            
            try {
                // Find or create photo comments entry
                let photoComments = commentsData.find(c => c.ID_IMG === currentPhotoName);
                if (!photoComments) {
                    photoComments = {
                        ID_IMG: currentPhotoName,
                        tim: [],
                        comments: []
                    };
                    commentsData.push(photoComments);
                }
                
                // Ensure tim array exists
                if (!photoComments.tim) {
                    photoComments.tim = [];
                }
                
                // Check if user already liked
                const existingLikeIndex = photoComments.tim.findIndex(like => like.userName === currentUser.username);
                
                if (existingLikeIndex !== -1) {
                    // Remove like
                    photoComments.tim.splice(existingLikeIndex, 1);
                    showNotification('Đã bỏ thích!', 'info');
                } else {
                    // Add like
                    photoComments.tim.push({
                        userName: currentUser.username
                    });
                    showNotification('Đã thích ảnh!', 'success');
                }
                
                // Update GitHub
                const success = await githubAPI.updateFile(
                    config.COMMENTS_FILE_PATH,
                    commentsData,
                    `Cập nhật lượt thích cho ảnh: ${currentPhotoName}`
                );
                
                if (success) {
                    // Refresh likes display
                    loadPhotoLikes(currentPhotoName);
                    // Refresh photos grid to update like counts
                    loadPhotos(currentPage);
                    addLog('Tương tác ảnh', `Đã ${existingLikeIndex !== -1 ? 'bỏ thích' : 'thích'} ảnh "${currentPhotoName}"`);
                } else {
                    showNotification('Lỗi khi cập nhật!', 'error');
                }
                
            } catch (error) {
                console.error('Error toggling like:', error);
                showNotification('Lỗi khi thích ảnh!', 'error');
            }
        }

        function handleCommentKeyPress(event) {
            if (event.key === 'Enter') {
                addComment();
            }
        }

        async function addComment() {
            const commentInput = document.getElementById('commentInput');
            const comment = commentInput.value.trim();
            
            if (!comment || !currentPhotoName || !currentUser) return;
            
            try {
                // Find or create photo comments entry
                let photoComments = commentsData.find(c => c.ID_IMG === currentPhotoName);
                if (!photoComments) {
                    photoComments = {
                        ID_IMG: currentPhotoName,
                        tim: [],
                        comments: []
                    };
                    commentsData.push(photoComments);
                }
                
                // Ensure comments array exists
                if (!photoComments.comments) {
                    photoComments.comments = [];
                }
                
                // Add new comment
                const newComment = {
                    comment: comment,
                    date_input: new Date().toISOString(),
                    userName: currentUser.username
                };
                
                photoComments.comments.push(newComment);
                
                // Update GitHub
                const success = await githubAPI.updateFile(
                    config.COMMENTS_FILE_PATH,
                    commentsData,
                    `Thêm bình luận cho ảnh: ${currentPhotoName}`
                );
                
                if (success) {
                    // Clear input and refresh comments
                    commentInput.value = '';
                    loadPhotoComments(currentPhotoName);
                    // Refresh photos grid to update comment counts
                    loadPhotos(currentPage);
                    showNotification('Đã thêm bình luận!', 'success');
                    addLog('Bình luận ảnh', `Đã bình luận vào ảnh "${currentPhotoName}"`);
                } else {
                    // Remove comment if failed
                    photoComments.comments.pop();
                    showNotification('Lỗi khi thêm bình luận!', 'error');
                }
                
            } catch (error) {
                console.error('Error adding comment:', error);
                showNotification('Lỗi khi thêm bình luận!', 'error');
            }
        }

        function openShareModal() {
            if (!currentPhotoId) return;
            
            // Set share link to Google Drive original link
            const originalLink = `https://drive.google.com/file/d/${currentPhotoId}/view`;
            document.getElementById('shareLink').value = originalLink;
            
            // Reset QR code
            document.getElementById('qrCodeContainer').classList.add('hidden');
            
            openModal('shareModal');
        }

        function copyShareLink() {
            const shareLink = document.getElementById('shareLink');
            
            // Fallback method for older browsers or when clipboard API fails
            try {
                // Try modern clipboard API first
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(shareLink.value).then(() => {
                        showNotification('Đã copy link chia sẻ!', 'success');
                    }).catch(() => {
                        fallbackCopyTextToClipboard(shareLink.value);
                    });
                } else {
                    fallbackCopyTextToClipboard(shareLink.value);
                }
            } catch (error) {
                fallbackCopyTextToClipboard(shareLink.value);
            }
        }

        function fallbackCopyTextToClipboard(text) {
            // Create temporary textarea element
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            
            try {
                textArea.focus();
                textArea.select();
                const successful = document.execCommand('copy');
                if (successful) {
                    showNotification('Đã copy link chia sẻ!', 'success');
                } else {
                    showNotification('Không thể copy link. Vui lòng copy thủ công!', 'error');
                }
            } catch (error) {
                showNotification('Không thể copy link. Vui lòng copy thủ công!', 'error');
            } finally {
                document.body.removeChild(textArea);
            }
        }

        function shareToFacebook() {
            const shareLink = document.getElementById('shareLink').value;
            const facebookUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareLink)}`;
            window.open(facebookUrl, '_blank', 'noopener,noreferrer');
        }

        function shareToTwitter() {
            const shareLink = document.getElementById('shareLink').value;
            const twitterUrl = `https://twitter.com/intent/tweet?url=${encodeURIComponent(shareLink)}&text=${encodeURIComponent('Xem ảnh này!')}`;
            window.open(twitterUrl, '_blank', 'noopener,noreferrer');
        }

        function shareToTelegram() {
            const shareLink = document.getElementById('shareLink').value;
            const telegramUrl = `https://t.me/share/url?url=${encodeURIComponent(shareLink)}&text=${encodeURIComponent('Xem ảnh này!')}`;
            window.open(telegramUrl, '_blank', 'noopener,noreferrer');
        }

        function generateQRCode() {
            const shareLink = document.getElementById('shareLink').value;
            const qrContainer = document.getElementById('qrCodeContainer');
            const qrImage = document.getElementById('qrCodeImage');
            
            // Use QR Server API to generate QR code
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(shareLink)}`;
            
            qrImage.src = qrUrl;
            qrContainer.classList.remove('hidden');
            
            showNotification('Đã tạo mã QR!', 'success');
        }

        async function downloadPhoto() {
            if (!currentPhotoId || !currentPhotoName) return;
            
            try {
                // Use Google Drive view URL for download (same as share link)
                const downloadUrl = `https://drive.google.com/file/d/${currentPhotoId}/view`;
                
                // Create download link that opens in new tab
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.target = '_blank';
                link.rel = 'noopener noreferrer';
                
                // Trigger download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification('Đã mở trang tải ảnh!', 'success');
                addLog('Tải ảnh', `Đã mở trang tải ảnh "${currentPhotoName}"`);
                
            } catch (error) {
                console.error('Error downloading photo:', error);
                showNotification('Lỗi khi mở trang tải ảnh!', 'error');
            }
        }

        // Close modals when clicking outside
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('show');
            }
        });

        // Logic click ra ngoài để đóng menu (vẫn giữ nguyên nhưng đơn giản hơn)
        document.addEventListener('click', function(event) {
            const menuIcons = document.getElementById('headerMenuIcons');
            const header = document.querySelector('header');

            // Nếu click ra ngoài khu vực header và menu đang hiện -> đóng menu
            if (!header.contains(event.target) && !menuIcons.classList.contains('hidden')) {
                closeHeaderMenu();
            }
        });


    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98f60467b36d04e3',t:'MTc2MDYwMTU3MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
