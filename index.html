<!DOCTYPE html>
<html lang="vi" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Love Story - Ứng Dụng Kỷ Niệm</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            100: '#006B68',
                            80: '#339B98',
                            60: '#66B3B0',
                            50: '#80C4C1',
                            30: '#B3DCDA',
                            10: '#E6F5F4'
                        },
                        accent: {
                            100: '#FFC62F',
                            80: '#FFD15C',
                            60: '#FFDC89',
                            50: '#FFE4A3',
                            30: '#FFEDC9',
                            10: '#FFF8E6'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            box-sizing: border-box;
        }
        
        /* CSS Variables cho Theme System */
        :root {
            --primary-100: #006B68;
            --primary-80: #339B98;
            --primary-60: #66B3B0;
            --primary-50: #80C4C1;
            --primary-30: #B3DCDA;
            --primary-10: #E6F5F4;
            --accent-100: #FFC62F;
            --accent-80: #FFD15C;
            --accent-60: #FFDC89;
            --accent-50: #FFE4A3;
            --accent-30: #FFEDC9;
            --accent-10: #FFF8E6;
        }
        
        /* Theme Classes */
        html.theme-default {
            --primary-100: #006B68;
            --primary-80: #339B98;
            --accent-100: #FFC62F;
            --accent-80: #FFD15C;
            --bg-gradient: linear-gradient(135deg, #E6F5F4 0%, #FFF8E6 100%);
        }
        
        html.theme-spring {
            --primary-100: #2D5016;
            --primary-80: #4A7C23;
            --accent-100: #8BC34A;
            --accent-80: #9CCC65;
            --bg-gradient: linear-gradient(135deg, #E8F5E8 0%, #F1F8E9 100%);
        }
        
        html.theme-summer {
            --primary-100: #FF6B35;
            --primary-80: #FF8A65;
            --accent-100: #F7931E;
            --accent-80: #FFB74D;
            --bg-gradient: linear-gradient(135deg, #FFF3E0 0%, #FFE0B2 100%);
        }
        
        html.theme-night {
            --primary-100: #1A237E;
            --primary-80: #3949AB;
            --accent-100: #3F51B5;
            --accent-80: #5C6BC0;
            --bg-gradient: linear-gradient(135deg, #E8EAF6 0%, #C5CAE9 100%);
        }
        
        html.theme-romantic {
            --primary-100: #AD1457;
            --primary-80: #C2185B;
            --accent-100: #E91E63;
            --accent-80: #EC407A;
            --bg-gradient: linear-gradient(135deg, #FCE4EC 0%, #F8BBD9 100%);
        }
        
        html.theme-ocean {
            --primary-100: #006064;
            --primary-80: #00838F;
            --accent-100: #00BCD4;
            --accent-80: #26C6DA;
            --bg-gradient: linear-gradient(135deg, #E0F2F1 0%, #B2EBF2 100%);
        }
        
        /* Dynamic Color Classes */
        .bg-primary-100 { background-color: var(--primary-100) !important; }
        .text-primary-100 { color: var(--primary-100) !important; }
        .border-primary-100 { border-color: var(--primary-100) !important; }
        .border-l-primary-100 { border-left-color: var(--primary-100) !important; }
        .bg-accent-100 { background-color: var(--accent-100) !important; }
        .text-accent-100 { color: var(--accent-100) !important; }
        .border-accent-100 { border-color: var(--accent-100) !important; }
        .border-l-accent-100 { border-left-color: var(--accent-100) !important; }
        .hover\:bg-primary-80:hover { background-color: var(--primary-80) !important; }
        .hover\:text-primary-80:hover { color: var(--primary-80) !important; }
        .hover\:bg-accent-80:hover { background-color: var(--accent-80) !important; }
        .bg-primary-10 { background-color: var(--primary-100)1A !important; }
        .bg-accent-10 { background-color: var(--accent-100)1A !important; }
        .text-primary-30 { color: var(--primary-100)4D !important; }
        
        /* Apply gradient background */
        body {
            background: var(--bg-gradient, linear-gradient(135deg, #E6F5F4 0%, #FFF8E6 100%));
        }
        
        /* Skeleton Loading Styles */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
        }
        
        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .skeleton-widget {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 32px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .skeleton-header {
            height: 24px;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 6px;
            margin-bottom: 16px;
            width: 60%;
        }
        
        .skeleton-line {
            height: 16px;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 4px;
            margin-bottom: 12px;
        }
        
        .skeleton-line.short { width: 75%; }
        .skeleton-line.medium { width: 85%; }
        .skeleton-line.long { width: 95%; }
        
        .skeleton-image {
            height: 200px;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        
        .skeleton-card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .skeleton-timeline-item {
            background: white;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 16px;
            border-left: 4px solid #e0e0e0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .skeleton-photo-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }
        
        .skeleton-photo-item {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .skeleton-photo-item .skeleton-image {
            height: 192px;
            margin-bottom: 0;
            border-radius: 0;
        }
        
        .skeleton-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            margin-bottom: 32px;
        }
        
        .skeleton-stat-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .skeleton-stat-number {
            height: 36px;
            width: 60px;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 6px;
            margin: 0 auto 12px;
        }
        
        .skeleton-stat-label {
            height: 16px;
            width: 80px;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 4px;
            margin: 0 auto;
        }
        
        .calendar-day {
            transition: all 0.3s ease;
        }
        
        .calendar-day:hover {
            transform: scale(1.05);
        }
        
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .photo-item {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .photo-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 107, 104, 0.2);
        }
        
        .timeline-item {
            position: relative;
            padding-left: 2rem;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0.5rem;
            width: 12px;
            height: 12px;
            background: #FFC62F;
            border-radius: 50%;
            border: 3px solid #006B68;
        }
        
        .timeline-item::after {
            content: '';
            position: absolute;
            left: 5px;
            top: 1.5rem;
            width: 2px;
            height: calc(100% - 1rem);
            background: #006B68;
        }
        
        .timeline-item:last-child::after {
            display: none;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Photo modal should appear above event photos modal */
        #photo-modal {
            z-index: 1100;
        }
        
        #event-photos-modal {
            z-index: 1050;
        }
        
        /* Share modal should appear above photo modal */
        #share-modal {
            z-index: 1200;
        }
        
        .loading {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .btn-icon-small {
            background: none;
            border: 1px solid #B3D9D7;
            color: #006B68;
            padding: 5px;
            border-radius: 5px;
            transition: all 0.3s ease;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Đảm bảo layout ổn định ngay từ đầu */
        .section {
            min-height: 200px;
        }
        
        .section.hidden {
            display: none !important;
        }
        
        .section.active {
            display: block !important;
        }
        
        /* Loading state styles */
        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #006B68;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="h-full bg-gradient-to-br from-primary-10 to-accent-10 font-sans">
    <!-- Header -->
    <header class="bg-primary-100 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <h1 class="text-xl md:text-2xl font-bold flex items-center cursor-pointer hover:opacity-80 transition-opacity whitespace-nowrap" onclick="showSection('widget')" title="Về trang chủ">
                    <i class="fas fa-heart text-accent-100 mr-2"></i>
                    <span>Love Story</span>
                </h1>
                
                <div class="flex items-center space-x-4">
                    <nav class="flex space-x-2 md:space-x-6">
                        <button onclick="showSearchModal()" class="nav-btn px-2 md:px-4 py-2 rounded-lg transition-colors hover:bg-primary-80" title="Tìm kiếm thông minh">
                            <i class="fas fa-robot text-xl md:text-2xl"></i>
                        </button>
                        <button onclick="showSection('timeline')" class="nav-btn px-2 md:px-4 py-2 rounded-lg transition-colors hover:bg-primary-80 active" title="Timeline">
                            <i class="fas fa-heart-pulse text-xl md:text-2xl md:mr-2"></i>
                            <span class="hidden md:inline">Timeline</span>
                        </button>
                        <button onclick="showSection('photos')" class="nav-btn px-2 md:px-4 py-2 rounded-lg transition-colors hover:bg-primary-80" title="Khoảnh Khắc">
                            <i class="fas fa-images text-xl md:text-2xl md:mr-2"></i>
                            <span class="hidden md:inline">Khoảnh Khắc</span>
                        </button>
                        <button onclick="showSection('settings')" class="nav-btn px-2 md:px-4 py-2 rounded-lg transition-colors hover:bg-primary-80" title="Cài Đặt">
                            <i class="fas fa-cog text-xl md:text-2xl md:mr-2"></i>
                            <span class="hidden md:inline">Cài Đặt</span>
                        </button>
                    </nav>
                    
                    <!-- Profile Button -->
                    <button onclick="openProfileModal()" class="flex items-center space-x-2 p-2 rounded-lg hover:bg-primary-80 transition-colors" title="Hồ sơ cá nhân">
                        <div class="w-8 h-8 rounded-full overflow-hidden bg-accent-100 flex items-center justify-center">
                            <img id="header-avatar" src="" alt="" class="w-full h-full object-cover hidden">
                            <i id="header-avatar-icon" class="fas fa-user text-white"></i>
                        </div>
                        <span id="header-username" class="hidden md:inline text-sm font-medium">Ẩn danh</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8 min-h-[calc(100vh-200px)]">
        <!-- Widget Section -->
        <section id="widget-section" class="section active">
            <!-- Ngày Này Năm Xưa Widget -->
            <div class="bg-gradient-to-br from-primary-10 to-accent-10 rounded-xl shadow-lg p-6 mb-8">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-primary-100 flex items-center">
                        <i class="fas fa-history mr-3 text-accent-100"></i>
                        Ngày Này Năm Xưa
                    </h2>
                </div>
                <div id="memory-widget" class="bg-white rounded-lg p-6 shadow-sm">
                    <div class="skeleton-widget">
                        <div class="skeleton-header"></div>
                        <div class="skeleton-image"></div>
                        <div class="skeleton-line long"></div>
                        <div class="skeleton-line medium"></div>
                        <div class="skeleton-line short"></div>
                    </div>
                </div>
            </div>

            <!-- Đếm Ngược Sự Kiện Đặc Biệt -->
            <div class="bg-gradient-to-br from-accent-10 to-primary-10 rounded-xl shadow-lg p-6 mb-8">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-primary-100 flex items-center">
                        <i class="fas fa-calendar-alt mr-3 text-accent-100"></i>
                        Sự Kiện
                    </h2>
                </div>
                <div id="countdown-widget" class="space-y-4">
                    <div class="skeleton-card">
                        <div class="skeleton-line medium"></div>
                        <div class="skeleton-line short"></div>
                    </div>
                    <div class="skeleton-card">
                        <div class="skeleton-line long"></div>
                        <div class="skeleton-line medium"></div>
                    </div>
                    <div class="skeleton-card">
                        <div class="skeleton-line short"></div>
                        <div class="skeleton-line medium"></div>
                    </div>
                </div>
            </div>

            <!-- Thống Kê Tổng Quan -->
            <div id="stats-widget" class="grid grid-cols-2 gap-6 mb-8">
                <div class="skeleton-stat-card">
                    <div class="skeleton-stat-number"></div>
                    <div class="skeleton-stat-label"></div>
                </div>
                <div class="skeleton-stat-card">
                    <div class="skeleton-stat-number"></div>
                    <div class="skeleton-stat-label"></div>
                </div>
                <div class="skeleton-stat-card">
                    <div class="skeleton-stat-number"></div>
                    <div class="skeleton-stat-label"></div>
                </div>
            </div>


        </section>

        <!-- Timeline Section -->
        <section id="timeline-section" class="section hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-primary-100">
                        <i class="fas fa-heart-pulse mr-2"></i>Timeline
                    </h2>
                    <div class="flex items-center space-x-2">
                        <button onclick="showAddEventModal()" class="p-2 bg-primary-100 text-white rounded-lg hover:bg-primary-80 transition-colors" title="Thêm sự kiện">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
                <div id="timeline-container" class="space-y-3">
                    <div class="skeleton-timeline-item">
                        <div class="skeleton-header"></div>
                        <div class="skeleton-line long"></div>
                        <div class="skeleton-line medium"></div>
                        <div class="skeleton-line short"></div>
                    </div>
                    <div class="skeleton-timeline-item">
                        <div class="skeleton-header"></div>
                        <div class="skeleton-line medium"></div>
                        <div class="skeleton-line long"></div>
                    </div>
                    <div class="skeleton-timeline-item">
                        <div class="skeleton-header"></div>
                        <div class="skeleton-line short"></div>
                        <div class="skeleton-line medium"></div>
                        <div class="skeleton-line long"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Photos Section -->
        <section id="photos-section" class="section hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-primary-100">
                        <i class="fas fa-camera-retro mr-2"></i>Khoảnh Khắc
                    </h2>
                    <div class="flex items-center space-x-1">
                        <button onclick="toggleView('grid')" id="grid-btn" class="view-btn p-2 rounded-lg bg-gray-300 text-gray-600">
                            <i class="fas fa-th text-sm"></i>
                        </button>
                        <button onclick="toggleView('grid-2')" id="grid-2-btn" class="view-btn p-2 rounded-lg bg-primary-100 text-white">
                            <i class="fas fa-th-large text-sm"></i>
                        </button>
                        <button onclick="toggleView('list')" id="list-btn" class="view-btn p-2 rounded-lg bg-gray-300 text-gray-600">
                            <i class="fas fa-list text-sm"></i>
                        </button>
                    </div>
                </div>
                
                <div id="photos-container" class="skeleton-photo-grid">
                    <div class="skeleton-photo-item">
                        <div class="skeleton-image"></div>
                    </div>
                    <div class="skeleton-photo-item">
                        <div class="skeleton-image"></div>
                    </div>
                    <div class="skeleton-photo-item">
                        <div class="skeleton-image"></div>
                    </div>
                    <div class="skeleton-photo-item">
                        <div class="skeleton-image"></div>
                    </div>
                    <div class="skeleton-photo-item">
                        <div class="skeleton-image"></div>
                    </div>
                    <div class="skeleton-photo-item">
                        <div class="skeleton-image"></div>
                    </div>
                </div>
                
                <div id="pagination" class="flex justify-center mt-8 space-x-2">
                    <!-- Pagination will be generated here -->
                </div>
            </div>
        </section>

        <!-- Settings Section -->
        <section id="settings-section" class="section hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold text-primary-100 mb-6">
                    <i class="fas fa-cog mr-2"></i>Cài Đặt Hệ Thống
                </h2>
                
                <!-- Theme Settings -->
                <div class="bg-gradient-to-r from-accent-10 to-primary-10 rounded-lg p-6 mb-6">
                    <div class="flex items-start space-x-4">
                        <div class="flex-1">
                            <h3 class="text-base font-semibold text-primary-100 mb-6 text-center">
                                <i class="fas fa-palette mr-2"></i>Giao Diện
                            </h3>
                            
                            <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                                <div id="theme-options-settings" class="contents">
                                    <!-- Theme options will be generated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Auto Update Settings -->
                <div class="bg-gradient-to-r from-primary-10 to-accent-10 rounded-lg p-6 mb-6">
                    <div class="flex items-start space-x-4">
                        <div class="flex-1">
                            <h3 class="text-base font-semibold text-primary-100 mb-6 text-center">
                                <i class="fas fa-sync-alt mr-2"></i>Tự Động Cập Nhật
                            </h3>
                            <p class="text-gray-700 mb-4">Tự động cập nhật danh sách ảnh từ Google Drive về file Metadata.</p>
                            
                            <!-- Enable/Disable Toggle -->
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center space-x-3">
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="auto-sync-toggle" class="sr-only peer" checked>
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-30 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-100"></div>
                                    </label>
                                    <span class="text-sm font-medium text-gray-700">Bật/Tắt</span>
                                </div>
                                <div class="text-sm text-gray-500">
                                    <i class="fas fa-clock mr-1"></i>
                                    Lần cuối: <span id="last-sync-time">Chưa có</span>
                                </div>
                            </div>

                            <!-- Sync Settings -->
                            <div id="sync-settings" class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tần suất</label>
                                    <select id="sync-frequency" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-100">
                                        <option value="once">Một lần</option>
                                        <option value="daily">Hằng ngày</option>
                                        <option value="monthly">Hằng tháng</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Thời gian</label>
                                    <input type="text" id="sync-time" placeholder="__:__" maxlength="5" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-100 text-center font-mono">
                                </div>
                            </div>

                            <div class="flex justify-center space-x-3">
                                <button onclick="manualSync()" class="px-4 py-2 bg-primary-100 text-white rounded-lg hover:bg-primary-80 transition-colors">
                                    <i class="fas fa-sync mr-2"></i>Thủ công
                                </button>
                                <button onclick="saveSyncSettings()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                    <i class="fas fa-save mr-2"></i>Lưu
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Activity Logging Settings -->
                <div class="bg-gradient-to-r from-accent-10 to-primary-10 rounded-lg p-6 mb-6">
                    <div class="flex items-start space-x-4">
                        <div class="flex-1">
                            <h3 class="text-base font-semibold text-primary-100 mb-6 text-center">
                                <i class="fas fa-clipboard-list mr-2"></i>Nhật ký hoạt động
                            </h3>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="activity-log-toggle" class="sr-only peer" checked>
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-accent-30 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-accent-100"></div>
                                    </label>
                                    <span class="text-sm font-medium text-gray-700">Bật/Tắt</span>
                                </div>
                                <div class="text-sm text-gray-500">
                                    <i class="fas fa-database mr-1"></i>
                                    Tổng: <span id="total-logs">0</span> bản ghi
                                </div>
                            </div>
                            <div class="mt-4 text-center">
                                <button onclick="viewActivityLogs()" class="px-4 py-2 bg-accent-100 text-white rounded-lg hover:bg-accent-80 transition-colors">
                                    <i class="fas fa-eye mr-2"></i>Xem nhật ký
                                </button>
                            </div>
                        </div>
                    </div>
                </div>



                <!-- System Information -->
                <div class="bg-gray-50 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-primary-100 mb-4 text-center">
                        <i class="fas fa-info-circle mr-2"></i>Thông Tin Hệ Thống
                    </h3>
                    <div class="grid grid-cols-2 gap-3 max-w-4xl mx-auto">
                        <div class="bg-white rounded-lg p-3 text-center">
                            <div class="text-xs text-gray-600 mb-1">Phiên bản</div>
                            <div class="font-semibold text-primary-100 text-sm">Love Story v2.0</div>
                        </div>
                        <div class="bg-white rounded-lg p-3 text-center">
                            <div class="text-xs text-gray-600 mb-1">Kết nối GitHub</div>
                            <div class="font-semibold text-green-600 text-sm">
                                <i class="fas fa-check-circle mr-1"></i>Hoạt động
                            </div>
                        </div>
                        <div class="bg-white rounded-lg p-3 text-center">
                            <div class="text-xs text-gray-600 mb-1">Kết nối Google Drive</div>
                            <div class="font-semibold text-green-600 text-sm">
                                <i class="fas fa-check-circle mr-1"></i>Hoạt động
                            </div>
                        </div>
                        <div class="bg-white rounded-lg p-3 text-center">
                            <div class="text-xs text-gray-600 mb-1">Dung lượng sử dụng</div>
                            <div class="font-semibold text-primary-100 text-sm">
                                <span id="storage-used">0</span> MB
                            </div>
                        </div>
                        <div class="bg-white rounded-lg p-3 text-center">
                            <div class="text-xs text-gray-600 mb-1">Trạng thái kết nối</div>
                            <div class="font-semibold text-sm" id="connection-status">
                                <i class="fas fa-wifi mr-1"></i>Online
                            </div>
                        </div>
                        <div class="bg-white rounded-lg p-3 text-center">
                            <div class="text-xs text-gray-600 mb-1">Nhật ký chờ lưu</div>
                            <div class="font-semibold text-orange-600 text-sm">
                                <span id="pending-logs-count">0</span> bản ghi
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-primary-100 text-white py-6 mt-12">
        <div class="container mx-auto px-4 text-center">
            <p class="text-primary-30 text-sm">
                Bản quyền thuộc về: <span class="font-medium text-white">Hà Mạnh Tín</span>
            </p>
            <p class="text-primary-30 text-xs mt-1">
                © 2025 - Ứng dụng kỷ niệm
            </p>
        </div>
    </footer>

    <!-- Photo Modal -->
    <div id="photo-modal" class="modal">
        <div class="bg-white rounded-xl max-w-md w-full m-4">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 id="modal-title" class="text-xl font-bold text-primary-100"></h3>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4">
                <!-- Image Area -->
                <div class="mb-4">
                    <img id="modal-image" class="w-full h-64 object-cover rounded-lg shadow-lg" alt="Loading image...">
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-wrap items-center gap-2 mb-4">
                    <button onclick="likePhoto()" id="like-btn" class="flex items-center space-x-2 px-3 py-2 rounded-lg bg-red-500 text-white hover:bg-red-600 transition-colors text-sm">
                        <i class="fas fa-heart"></i>
                        <span id="like-count">0</span>
                    </button>
                    <button onclick="toggleComments()" id="comment-btn" class="flex items-center space-x-2 px-3 py-2 rounded-lg bg-primary-100 text-white hover:bg-primary-80 transition-colors text-sm">
                        <i class="fas fa-comment"></i>
                        <span id="comment-count">0</span>
                    </button>
                    <button onclick="sharePhoto()" class="flex items-center space-x-2 px-3 py-2 rounded-lg bg-blue-500 text-white hover:bg-blue-600 transition-colors text-sm">
                        <i class="fas fa-share-alt"></i>
                        <span class="hidden sm:inline">Chia sẻ</span>
                    </button>
                    <button onclick="downloadPhoto()" class="flex items-center space-x-2 px-3 py-2 rounded-lg bg-green-500 text-white hover:bg-green-600 transition-colors text-sm">
                        <i class="fas fa-download"></i>
                        <span class="hidden sm:inline">Tải về</span>
                    </button>
                </div>

                <!-- Comments Section -->
                <div id="comments-list-section" class="hidden">
                    <div class="border-t pt-4">
                        <h4 class="font-semibold text-primary-100 mb-3 flex items-center">
                            <i class="fas fa-comments mr-2"></i>
                            Bình luận
                        </h4>
                        <div id="comments-container" class="space-y-3 mb-4 max-h-40 overflow-y-auto">
                            <!-- Comments will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Comment Input -->
                <div id="comment-input-wrapper" class="hidden border-t pt-4">
                    <div class="flex space-x-2">
                        <input type="text" id="comment-input" placeholder="Thêm bình luận..." 
                               class="flex-1 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-100 text-sm">
                        <button onclick="addComment()" class="px-4 py-2 bg-primary-100 text-white rounded-lg hover:bg-primary-80 transition-colors">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Event Modal -->
    <div id="event-modal" class="modal">
        <div class="bg-white rounded-xl max-w-md w-full mx-4 my-4 sm:m-4">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 id="event-modal-title" class="text-xl font-bold text-primary-100">Thêm sự kiện mới</h3>
                <button onclick="closeEventModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="event-form" class="p-4 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tên sự kiện</label>
                    <input type="text" id="event-name" required 
                           class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-100"
                           placeholder="Nhập tên sự kiện...">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Ngày</label>
                    <input type="text" id="event-date" required 
                           class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-100 text-center"
                           placeholder="DD/MM/YYYY" maxlength="10">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Mô tả</label>
                    <textarea id="event-description" rows="3" 
                              class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-100"
                              placeholder="Mô tả chi tiết về sự kiện..."></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">List ảnh</label>
                    <div class="flex space-x-2">
                        <input type="text" id="event-images-display" readonly 
                               class="flex-1 px-3 py-2 border rounded-lg bg-gray-50 text-sm"
                               placeholder="Chưa chọn ảnh nào...">
                        <button type="button" onclick="openImageSelector()" 
                                class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                            <i class="fas fa-images mr-2"></i>Browser
                        </button>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">
                        Đã chọn: <span id="selected-images-count">0</span> ảnh
                    </div>
                </div>
                <div class="flex space-x-3 pt-4">
                    <button type="submit" class="flex-1 px-4 py-2 bg-primary-100 text-white rounded-lg hover:bg-primary-80 transition-colors">
                        <i class="fas fa-save mr-2"></i>Lưu
                    </button>
                    <button type="button" onclick="closeEventModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">
                        Hủy
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal">
        <div class="bg-white rounded-xl max-w-md w-full m-4">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold text-red-600">Xác nhận xóa</h3>
                <button onclick="closeDeleteModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4">
                <div class="flex items-center space-x-3 mb-4">
                    <i class="fas fa-exclamation-triangle text-red-500 text-2xl"></i>
                    <div>
                        <p class="font-medium text-gray-900">Bạn có chắc chắn muốn xóa sự kiện này?</p>
                        <p class="text-sm text-gray-600 mt-1" id="delete-event-name"></p>
                    </div>
                </div>
                <div class="flex space-x-3">
                    <button onclick="confirmDeleteEvent()" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                        <i class="fas fa-trash mr-2"></i>Xóa
                    </button>
                    <button onclick="closeDeleteModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">
                        Hủy
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Event Photos Modal -->
    <div id="event-photos-modal" class="modal">
        <div class="bg-white rounded-xl max-w-6xl w-full mx-2 my-2 sm:m-4 flex flex-col" style="max-height: calc(100vh - 1rem);">
            <div class="p-3 sm:p-4 border-b flex justify-between items-center flex-shrink-0">
                <h3 id="event-photos-title" class="text-lg sm:text-xl font-bold text-primary-100 truncate mr-4">Ảnh sự kiện</h3>
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <div class="flex items-center space-x-1">
                        <button onclick="toggleEventView('grid')" id="event-grid-btn" class="event-view-btn p-2 rounded-lg bg-gray-300 text-gray-600">
                            <i class="fas fa-th"></i>
                        </button>
                        <button onclick="toggleEventView('grid-2')" id="event-grid-2-btn" class="event-view-btn p-2 rounded-lg bg-primary-100 text-white">
                            <i class="fas fa-th-large"></i>
                        </button>
                        <button onclick="toggleEventView('list')" id="event-list-btn" class="event-view-btn p-2 rounded-lg bg-gray-300 text-gray-600">
                            <i class="fas fa-list"></i>
                        </button>
                    </div>
                    <button onclick="closeEventPhotosModal()" class="text-gray-500 hover:text-gray-700 flex-shrink-0">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto min-h-0">
                <div class="p-3 sm:p-4">
                    <div id="event-photos-container" class="grid grid-cols-2 gap-4">
                        <!-- Event photos will be loaded here -->
                    </div>
                    
                    <div id="event-pagination" class="flex justify-center mt-8 space-x-2">
                        <!-- Event pagination will be generated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Selector Modal -->
    <div id="image-selector-modal" class="modal">
        <div class="bg-white rounded-xl max-w-6xl w-full mx-2 my-2 sm:m-4 flex flex-col" style="max-height: calc(100vh - 1rem);">
            <div class="p-3 sm:p-4 border-b flex justify-between items-center flex-shrink-0">
                <h3 class="text-lg sm:text-xl font-bold text-primary-100">Chọn ảnh cho sự kiện</h3>
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <div class="text-sm text-gray-600">
                        Đã chọn: <span id="modal-selected-count" class="font-semibold text-primary-100">0</span> ảnh
                    </div>
                    <button onclick="closeImageSelector()" class="text-gray-500 hover:text-gray-700 flex-shrink-0">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto min-h-0">
                <div class="p-3 sm:p-4">
                    <div class="mb-4 flex justify-between items-center">
                        <div class="flex flex-wrap gap-2">
                            <button onclick="selectAllImages()" class="px-3 py-1 bg-green-500 text-white rounded text-sm hover:bg-green-600">
                                <i class="fas fa-check mr-1"></i>Chọn trang này
                            </button>
                            <button onclick="deselectAllImages()" class="px-3 py-1 bg-gray-500 text-white rounded text-sm hover:bg-gray-600">
                                <i class="fas fa-times mr-1"></i>Bỏ chọn trang này
                            </button>
                            <button onclick="selectAllPagesImages()" class="px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600">
                                <i class="fas fa-check-double mr-1"></i>Chọn tất cả trang
                            </button>
                            <button onclick="deselectAllPagesImages()" class="px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600">
                                <i class="fas fa-ban mr-1"></i>Bỏ chọn tất cả
                            </button>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="closeImageSelector()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                                Đóng
                            </button>
                        </div>
                    </div>
                    
                    <div id="image-selector-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                        <!-- Images will be loaded here -->
                    </div>
                    
                    <div id="image-selector-pagination" class="flex justify-center mt-8 space-x-2">
                        <!-- Pagination will be generated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div id="share-modal" class="modal">
        <div class="bg-white rounded-xl max-w-md w-full m-4">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold text-primary-100">
                    <i class="fas fa-share-alt mr-2"></i>Chia Sẻ Ảnh
                </h3>
                <button onclick="closeShareModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4">
                <!-- Link Copy Section -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Link ảnh gốc</label>
                    <div class="flex space-x-2">
                        <input type="text" id="share-link" readonly 
                               class="flex-1 px-3 py-2 border rounded-lg bg-gray-50 text-sm">
                        <button onclick="copyShareLink()" class="px-4 py-2 bg-primary-100 text-white rounded-lg hover:bg-primary-80 transition-colors">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>

                <!-- Social Media Platforms -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-3">Chia sẻ lên</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="shareToFacebook()" class="flex items-center justify-center space-x-2 px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fab fa-facebook-f"></i>
                            <span>Facebook</span>
                        </button>
                        <button onclick="shareToTwitter()" class="flex items-center justify-center space-x-2 px-4 py-3 bg-sky-500 text-white rounded-lg hover:bg-sky-600 transition-colors">
                            <i class="fab fa-twitter"></i>
                            <span>Twitter</span>
                        </button>
                        <button onclick="shareToTelegram()" class="flex items-center justify-center space-x-2 px-4 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                            <i class="fab fa-telegram-plane"></i>
                            <span>Telegram</span>
                        </button>
                        <button onclick="shareToWhatsApp()" class="flex items-center justify-center space-x-2 px-4 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                            <i class="fab fa-whatsapp"></i>
                            <span>WhatsApp</span>
                        </button>
                        <button onclick="shareToLinkedIn()" class="flex items-center justify-center space-x-2 px-4 py-3 bg-blue-700 text-white rounded-lg hover:bg-blue-800 transition-colors">
                            <i class="fab fa-linkedin-in"></i>
                            <span>LinkedIn</span>
                        </button>
                        <button onclick="shareToEmail()" class="flex items-center justify-center space-x-2 px-4 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                            <i class="fas fa-envelope"></i>
                            <span>Email</span>
                        </button>
                    </div>
                </div>

                <!-- QR Code Section -->
                <div class="mt-6 pt-4 border-t">
                    <div class="text-center">
                        <button onclick="generateQRCode()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                            <i class="fas fa-qrcode mr-2"></i>Tạo mã QR
                        </button>
                        <div id="qr-code-container" class="mt-3 hidden">
                            <div id="qr-code" class="flex justify-center"></div>
                            <p class="text-xs text-gray-500 mt-2">Quét mã QR để xem ảnh</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Modal -->
    <div id="search-modal" class="modal">
        <div class="bg-white rounded-xl w-full h-full sm:max-w-4xl sm:w-full sm:mx-2 sm:my-2 sm:h-auto sm:rounded-xl flex flex-col" style="max-height: 100vh; sm:max-height: calc(100vh - 1rem);">
            <div class="p-3 sm:p-4 border-b flex justify-between items-center flex-shrink-0">
                <h3 class="text-lg sm:text-xl font-bold text-primary-100">
                    <i class="fas fa-search mr-2"></i>Tìm Kiếm
                </h3>
                <button onclick="closeSearchModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <!-- Search Input -->
            <div class="p-3 sm:p-4 border-b bg-gray-50 flex-shrink-0">
                <div class="flex space-x-2">
                    <input type="text" id="search-input" placeholder="Tìm kiếm sự kiện, hỏi AI..." 
                           class="flex-1 px-3 py-2 sm:px-4 sm:py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-100 text-sm">
                    <button onclick="performSearch()" id="search-btn" class="px-3 py-2 sm:px-6 sm:py-3 bg-primary-100 text-white rounded-lg hover:bg-primary-80 transition-colors">
                        <i class="fas fa-search"></i>
                        <span class="hidden sm:inline ml-2">Tìm kiếm</span>
                    </button>
                </div>
                
                <!-- Search Options -->
                <div class="mt-3 flex flex-wrap gap-2">
                    <button onclick="setSearchMode('basic')" id="basic-search-btn" class="search-mode-btn px-2 py-1 sm:px-3 sm:py-1 bg-blue-100 text-blue-700 rounded-full text-xs sm:text-sm hover:bg-blue-200 transition-colors">
                        <i class="fas fa-search mr-1"></i><span class="hidden sm:inline">Cơ bản</span>
                    </button>
                    <button onclick="setSearchMode('ai')" id="ai-search-btn" class="search-mode-btn px-2 py-1 sm:px-3 sm:py-1 bg-purple-100 text-purple-700 rounded-full text-xs sm:text-sm hover:bg-purple-200 transition-colors">
                        <i class="fas fa-robot mr-1"></i><span class="hidden sm:inline">AI</span>
                    </button>
                </div>
                
                <!-- Quick Search Suggestions -->
                <div class="mt-3">
                    <div class="text-xs sm:text-sm text-gray-600 mb-2">Gợi ý:</div>
                    <div class="flex flex-wrap gap-1 sm:gap-2">
                        <button onclick="quickSearch('kỷ niệm gần nhất')" class="px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs hover:bg-gray-200">Gần nhất</button>
                        <button onclick="quickSearch('có bao nhiêu sự kiện')" class="px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs hover:bg-gray-200">Số lượng</button>
                        <button onclick="quickSearch('sự kiện năm 2024')" class="px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs hover:bg-gray-200">Năm 2024</button>
                        <button onclick="quickSearch('thống kê tổng quan')" class="px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs hover:bg-gray-200">Thống kê</button>
                    </div>
                </div>
            </div>
            
            <!-- Search Results -->
            <div class="flex-1 overflow-y-auto min-h-0">
                <div class="p-3 sm:p-4">
                    <div id="search-results" class="space-y-4">
                        <div class="text-center py-8 sm:py-12 text-gray-500">
                            <i class="fas fa-search text-3xl sm:text-4xl mb-4"></i>
                            <p class="text-base sm:text-lg">Nhập từ khóa để tìm kiếm</p>
                            <p class="text-xs sm:text-sm mt-2">Tìm kiếm sự kiện, hỏi AI hoặc xem thống kê</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profile-modal" class="modal">
        <div class="bg-white rounded-xl max-w-md w-full m-4">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold text-primary-100">
                    <i class="fas fa-user-circle mr-2"></i>Hồ Sơ Cá Nhân
                </h3>
                <button onclick="closeProfileModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4">
                <form id="profile-form" class="p-4 space-y-4">
                <!-- Avatar Section -->
                <div class="text-center">
                    <div class="relative inline-block">
                        <div class="w-24 h-24 rounded-full overflow-hidden bg-gray-200 mx-auto mb-4 border-4 border-primary-100">
                            <img id="profile-avatar-preview" src="" alt="" class="w-full h-full object-cover hidden">
                            <div id="profile-avatar-placeholder" class="w-full h-full flex items-center justify-center">
                                <i class="fas fa-user text-4xl text-gray-400"></i>
                            </div>
                        </div>
                        <button type="button" onclick="selectAvatar()" class="absolute bottom-0 right-0 bg-primary-100 text-white rounded-full p-2 hover:bg-primary-80 transition-colors">
                            <i class="fas fa-camera text-sm"></i>
                        </button>
                    </div>
                    <input type="file" id="avatar-input" accept="image/*" class="hidden" onchange="handleAvatarChange(event)">
                </div>

                <!-- Username Section -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tên đăng nhập</label>
                    <input type="text" id="profile-username" required 
                           class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-100"
                           placeholder="Nhập tên đăng nhập..." oninput="validateAndCheckUsername(this.value)" onblur="loadUserProfile(this.value)">
                    <div id="username-status" class="mt-1 text-sm hidden"></div>
                    <div class="text-xs text-gray-500 mt-1">Chỉ được sử dụng chữ cái không dấu, số và dấu gạch dưới</div>
                </div>

                <!-- Full Name Section -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Họ và tên</label>
                    <input type="text" id="profile-fullname" required 
                           class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-100"
                           placeholder="Nhập họ và tên đầy đủ...">
                </div>

                <!-- Action Buttons -->
                <div class="flex space-x-3 pt-4">
                    <button type="submit" id="save-profile-btn" class="flex-1 px-4 py-2 bg-primary-100 text-white rounded-lg hover:bg-primary-80 transition-colors">
                        <i class="fas fa-save mr-2"></i>Lưu hồ sơ
                    </button>
                    <button type="button" onclick="logoutUser()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                        <i class="fas fa-sign-out-alt mr-2"></i>Đăng xuất
                    </button>
                </div>

                <!-- Current User Info & Device Info - 2 columns -->
                <div class="mt-4 pt-4 border-t grid grid-cols-2 gap-4">
                    <!-- Current User Info -->
                    <div id="current-user-info" class="bg-blue-50 rounded-lg p-3 hidden">
                        <div class="text-sm font-medium text-blue-800 mb-2">Thông tin hiện tại:</div>
                        <div class="text-sm text-blue-600 space-y-1">
                            <div>Đăng nhập lần cuối: <span id="last-login-time">-</span></div>
                        </div>
                    </div>

                    <!-- Device Info -->
                    <div class="bg-gray-50 rounded-lg p-3">
                        <div class="text-sm font-medium text-gray-700 mb-2">Thông tin thiết bị:</div>
                        <div class="text-sm text-gray-600 space-y-1">
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-desktop text-primary-100"></i>
                                <span id="device-info">Đang tải...</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-globe text-primary-100"></i>
                                <span id="browser-info">Đang tải...</span>
                            </div>
                        </div>
                    </div>
                </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            GITHUB_USERNAME: "nhungcute",
            REPO_NAME: "LoveStory",
            PAT1: "ghp_a8VLpoCYQByLbUIwe",
            PAT2: "d3dy4hHjEpKwr3stE6T",
            FILE_PATH: "actions.json",
            COMMENTS_FILE_PATH: "comments.json",
            PHOTOS_METADATA_FILE_PATH: "image_data.json",
            LOGS_FILE_PATH: "logs.json",
            CONFIG_FILE_PATH: "configApp.json",
            PROFILES_FILE_PATH: "profiles.json",
            FOLDER_ID: "1B_tpWbLwlc7mqT789-g2RO9K2pYNXVav",
            API_KEY: "AIzaSyDJddlVwOWA8vzdVNrcp70if4eOL30xjp0",
            PHOTOS_PER_PAGE: 20,
            AUTO_LOAD_METADATA: "true",
            AUTO_SYNC_METADATA: {
                enabled: true,
                frequency: "daily",
                time: "09:00"
            }
        };

        // Global variables
        let currentDate = new Date();
        let timelineData = [];
        let photosData = [];
        let commentsData = {};
        let commentsMap = {}; // Map để tra cứu nhanh comments theo ID_IMG
        let currentPhotoPage = 1;
        let currentView = 'grid-2';
        let currentPhotoId = null;
        let activityLogs = [];
        let pendingLogs = []; // Nhật ký tạm thời chưa lưu
        let allLogs = []; // Tất cả nhật ký từ khi khởi tạo
        let currentEditingEventIndex = null;
        let currentDeletingEventIndex = null;
        let currentEventPhotos = [];
        let currentEventPhotoPage = 1;
        let currentEventView = 'grid-2';
        let currentEventIndex = null;
        let selectedImageIds = []; // Danh sách ID ảnh đã chọn cho sự kiện
        let currentImageSelectorPage = 1;
        let appConfig = {
            AUTO_SYNC_METADATA: {
                enabled: true,
                frequency: "daily",
                time: "09:00"
            }
        };
        let settings = {
            autoSync: true,
            activityLogging: true,
            lastSyncTime: null
        };
        let syncInterval = null;
        let logSaveInterval = null;
        let isOnline = navigator.onLine;
        
        // User & Theme variables
        let currentUser = null;
        let profilesData = [];
        let currentTheme = 'default';
        let currentSearchMode = 'basic'; // 'basic', 'ai', 'stats'
        let searchHistory = [];
        let availableThemes = {
            default: {
                name: 'Mặc định',
                className: 'theme-default'
            },
            spring: {
                name: 'Mùa xuân',
                className: 'theme-spring'
            },
            summer: {
                name: 'Mùa hè',
                className: 'theme-summer'
            },
            night: {
                name: 'Ban đêm',
                className: 'theme-night'
            },
            romantic: {
                name: 'Lãng mạn',
                className: 'theme-romantic'
            },
            ocean: {
                name: 'Đại dương',
                className: 'theme-ocean'
            }
        };
        


        // Initialize app - Khởi tạo ngay khi DOM sẵn sàng
        document.addEventListener('DOMContentLoaded', function() {
            // Khởi tạo giao diện NGAY LẬP TỨC
            initializeThemeImmediate();
            
            // Sau đó khởi tạo ứng dụng
            setTimeout(() => {
                initializeApp();
            }, 50);
        });

        // Khởi tạo theme ngay lập tức để tránh lỗi hiển thị
        function initializeThemeImmediate() {
            try {
                // Áp dụng theme mặc định ngay lập tức bằng cách thêm class
                document.documentElement.className = 'theme-default';
                
                console.log('✅ Đã khởi tạo giao diện ngay lập tức với CSS Variables');
                
            } catch (error) {
                console.error('❌ Lỗi khởi tạo giao diện ngay lập tức:', error);
                // Fallback: đảm bảo ít nhất có class mặc định
                document.documentElement.className = 'theme-default';
            }
        }

        async function initializeApp() {
            try {
                console.log('🚀 Bắt đầu khởi tạo ứng dụng...');
                
                // 1. Khởi tạo theme đầy đủ
                console.log('🎨 Khởi tạo theme...');
                initializeTheme();
                generateThemeOptions();
                
                // 2. Load cấu hình
                console.log('⚙️ Tải cấu hình...');
                await loadAppConfig();
                
                // 3. Load dữ liệu người dùng
                console.log('👤 Tải dữ liệu người dùng...');
                await loadProfilesData();
                initializeUser();
                updateDeviceInfo();
                
                // 4. Load dữ liệu ứng dụng
                console.log('📊 Tải dữ liệu ứng dụng...');
                await Promise.all([
                    loadTimelineData(),
                    loadPhotosData(),
                    loadCommentsData(),
                    loadActivityLogs()
                ]);
                
                // 5. Tạo giao diện
                console.log('🖼️ Tạo giao diện...');
                generateWidgets();
                generateTimeline();
                generatePhotos();
                
                // 6. Khởi tạo các tính năng nâng cao
                console.log('🔧 Khởi tạo tính năng nâng cao...');
                if (appConfig.AUTO_SYNC_METADATA && appConfig.AUTO_SYNC_METADATA.enabled) {
                    setupAutoSync();
                }
                
                setupLogManagement();
                setupOnlineOfflineDetection();
                
                // 7. Log hoàn thành
                logActivity('Khởi tạo ứng dụng', 'Ứng dụng Love Story đã được khởi tạo thành công');
                console.log('✅ Khởi tạo ứng dụng hoàn tất!');
                
                // 8. Ẩn loading nếu có
                hideLoadingState();
                
            } catch (error) {
                console.error('❌ Lỗi khởi tạo ứng dụng:', error);
                
                // Đảm bảo giao diện vẫn hoạt động dù có lỗi
                try {
                    initializeTheme();
                    generateThemeOptions();
                    generateWidgets();
                } catch (themeError) {
                    console.error('❌ Lỗi khởi tạo giao diện fallback:', themeError);
                }
                
                showError('Không thể tải đầy đủ dữ liệu. Một số tính năng có thể không hoạt động.');
                hideLoadingState();
            }
        }

        function hideLoadingState() {
            // Ẩn tất cả loading spinners
            document.querySelectorAll('.loading').forEach(spinner => {
                spinner.style.display = 'none';
            });
        }

        // Config loading function
        async function loadAppConfig() {
            try {
                const data = await fetchFromGitHub(CONFIG.CONFIG_FILE_PATH);
                if (data) {
                    appConfig = data;
                    // Ensure AUTO_SYNC_METADATA exists with default values if missing
                    if (!appConfig.AUTO_SYNC_METADATA) {
                        appConfig.AUTO_SYNC_METADATA = {
                            enabled: true,
                            frequency: "daily",
                            time: "09:00"
                        };
                    }
                } else {
                    // Create complete default config if file doesn't exist
                    appConfig = {
                        "GITHUB_USERNAME": "nhungcute",
                        "REPO_NAME": "LoveStory",
                        "PAT1": "ghp_a8VLpoCYQByLbUIwe",
                        "PAT2": "d3dy4hHjEpKwr3stE6T",
                        "FILE_PATH": "actions.json",
                        "COMMENTS_FILE_PATH": "comments.json",
                        "PHOTOS_METADATA_FILE_PATH": "image_data.json",
                        "LOGS_FILE_PATH": "logs.json",
                        "FOLDER_ID": "1B_tpWbLwlc7mqT789-g2RO9K2pYNXVav",
                        "API_KEY": "AIzaSyDJddlVwOWA8vzdVNrcp70if4eOL30xjp0",
                        "PHOTOS_PER_PAGE": 50,
                        "AUTO_SYNC_METADATA": {
                            "enabled": true,
                            "frequency": "daily",
                            "time": "09:00"
                        }
                    };
                }
            } catch (error) {
                console.error('Lỗi tải cấu hình:', error);
                // Use complete default config on error
                appConfig = {
                    "GITHUB_USERNAME": "nhungcute",
                    "REPO_NAME": "LoveStory",
                    "PAT1": "ghp_a8VLpoCYQByLbUIwe",
                    "PAT2": "d3dy4hHjEpKwr3stE6T",
                    "FILE_PATH": "actions.json",
                    "COMMENTS_FILE_PATH": "comments.json",
                    "PHOTOS_METADATA_FILE_PATH": "image_data.json",
                    "LOGS_FILE_PATH": "logs.json",
                    "FOLDER_ID": "1B_tpWbLwlc7mqT789-g2RO9K2pYNXVav",
                    "API_KEY": "AIzaSyDJddlVwOWA8vzdVNrcp70if4eOL30xjp0",
                    "PHOTOS_PER_PAGE": 50,
                    "AUTO_SYNC_METADATA": {
                        "enabled": true,
                        "frequency": "daily",
                        "time": "09:00"
                    }
                };
            }
        }

        async function saveAppConfig() {
            try {
                await saveToGitHub(CONFIG.CONFIG_FILE_PATH, appConfig, 'Cập nhật cấu hình ứng dụng');
                logActivity('Lưu cấu hình', 'Đã lưu cấu hình ứng dụng');
            } catch (error) {
                console.error('Lỗi lưu cấu hình:', error);
                logActivity('Lỗi lưu cấu hình', error.message);
                throw error;
            }
        }

        // GitHub API functions
        async function fetchFromGitHub(filePath) {
            const token = CONFIG.PAT1 + CONFIG.PAT2;
            const url = `https://api.github.com/repos/${CONFIG.GITHUB_USERNAME}/${CONFIG.REPO_NAME}/contents/${filePath}`;
            
            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                // Decode Base64 và fix UTF-8 encoding cho tiếng Việt
                const content = atob(data.content);
                const decoded = decodeURIComponent(escape(content));
                return JSON.parse(decoded);
            } catch (error) {
                console.error(`Lỗi tải file ${filePath}:`, error);
                return null;
            }
        }

        async function loadTimelineData() {
            const data = await fetchFromGitHub(CONFIG.FILE_PATH);
            if (data) {
                timelineData = data.sort((a, b) => {
                    const dateA = parseDate(a.day);
                    const dateB = parseDate(b.day);
                    return dateA - dateB;
                });
            }
        }

        async function loadPhotosData() {
            try {
                const data = await loadPhotosMetadataFromGitHub();
                if (data && data.length > 0) {
                    photosData = data;
                }
            } catch (error) {
                console.error('Lỗi tải dữ liệu ảnh:', error);
                photosData = [];
            }
        }

        async function loadPhotosMetadataFromGitHub() {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000);
                const token = CONFIG.PAT1 + CONFIG.PAT2;
                const url = `https://api.github.com/repos/${CONFIG.GITHUB_USERNAME}/${CONFIG.REPO_NAME}/contents/${CONFIG.PHOTOS_METADATA_FILE_PATH}`;
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                if (!response.ok) {
                    if (response.status === 404) {
                        console.log('File metadata chưa tồn tại');
                        return [];
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                const content = atob(data.content);
                const decoded = decodeURIComponent(escape(content));
                return JSON.parse(decoded);
            } catch (error) {
                console.error('Lỗi khi đọc metadata từ GitHub:', error);
                return [];
            }
        }





        async function loadCommentsData() {
            const data = await fetchFromGitHub(CONFIG.COMMENTS_FILE_PATH);
            if (data) {
                // Đảm bảo commentsData là array để sử dụng find()
                commentsData = Array.isArray(data) ? data : [];
                
                // Tối ưu hóa: Tạo Map để tra cứu nhanh O(1)
                commentsMap = commentsData.reduce((map, item) => {
                    map[item.ID_IMG] = item;
                    return map;
                }, {});
            }
        }

        async function loadActivityLogs() {
            try {
                const data = await fetchFromGitHub(CONFIG.LOGS_FILE_PATH);
                if (data && Array.isArray(data)) {
                    activityLogs = data;
                    allLogs = [...data]; // Copy toàn bộ logs từ server
                } else {
                    activityLogs = [];
                    allLogs = [];
                }
                
                // Load pending logs from localStorage
                const savedPendingLogs = localStorage.getItem('loveStoryPendingLogs');
                if (savedPendingLogs) {
                    pendingLogs = JSON.parse(savedPendingLogs);
                    // Merge pending logs vào allLogs để hiển thị
                    allLogs = [...allLogs, ...pendingLogs];
                }
                
                logActivity('Khởi tạo ứng dụng', 'Ứng dụng Love Story đã được khởi tạo thành công');
            } catch (error) {
                console.error('Lỗi tải nhật ký hoạt động:', error);
                activityLogs = [];
                allLogs = [];
                pendingLogs = [];
            }
        }

        async function saveToGitHub(filePath, data, commitMessage) {
            const token = CONFIG.PAT1 + CONFIG.PAT2;
            const url = `https://api.github.com/repos/${CONFIG.GITHUB_USERNAME}/${CONFIG.REPO_NAME}/contents/${filePath}`;
            
            try {
                // Get current file to get SHA
                const currentFile = await fetch(url, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                let sha = null;
                if (currentFile.ok) {
                    const currentData = await currentFile.json();
                    sha = currentData.sha;
                }
                
                // Encode data to Base64 with proper UTF-8 encoding
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
                
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: commitMessage,
                        content: content,
                        sha: sha
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error(`Lỗi lưu file ${filePath}:`, error);
                throw error;
            }
        }

        // Utility functions
        function parseDate(dateString) {
            const [day, month, year] = dateString.split('-');
            return new Date(year, month - 1, day);
        }

        // Helper functions for photo data - Tối ưu hóa O(1)
        function getPhotoLikes(photoName) {
            return commentsMap[photoName]?.count_tim || 0;
        }

        function getPhotoCommentsCount(photoName) {
            return commentsMap[photoName]?.comments?.length || 0;
        }

        function getPhotoComments(photoName) {
            return commentsMap[photoName]?.comments || [];
        }

        function formatDate(date) {
            return date.toLocaleDateString('vi-VN', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }





        // Navigation functions
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
                section.classList.remove('active');
            });
            
            // Show selected section
            const targetSection = document.getElementById(`${sectionName}-section`);
            targetSection.classList.remove('hidden');
            targetSection.classList.add('active');
            
            // Update navigation buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-primary-80', 'active');
            });
            
            // Find and highlight the correct nav button (only for non-widget sections)
            if (sectionName !== 'widget') {
                const navButton = document.querySelector(`[onclick="showSection('${sectionName}')"]`);
                if (navButton) {
                    navButton.classList.add('bg-primary-80', 'active');
                }
            }
        }

        // Widget functions
        function generateWidgets() {
            generateMemoryWidget();
            generateCountdownWidget();
            generateStatsWidget();
        }

        function generateMemoryWidget() {
            const container = document.getElementById('memory-widget');
            
            if (timelineData.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-calendar-times text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">Chưa có kỷ niệm nào để hiển thị</p>
                        <p class="text-gray-400 text-sm mt-2">Hãy thêm những khoảnh khắc đẹp!</p>
                    </div>
                `;
                return;
            }
            
            // Tìm sự kiện cùng ngày tháng nhưng khác năm
            const today = new Date();
            const todayDayMonth = `${String(today.getDate()).padStart(2, '0')}-${String(today.getMonth() + 1).padStart(2, '0')}`;
            
            const memoryEvents = timelineData.filter(event => {
                const eventDayMonth = event.day.substring(0, 5); // Lấy DD-MM
                return eventDayMonth === todayDayMonth;
            });
            
            if (memoryEvents.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-calendar-day text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">Không có kỷ niệm nào vào ngày này</p>
                        <p class="text-gray-400 text-sm mt-2">Hôm nay là ngày ${today.getDate()}/${today.getMonth() + 1}</p>
                    </div>
                `;
                return;
            }
            
            // Chọn ngẫu nhiên một sự kiện
            const randomEvent = memoryEvents[Math.floor(Math.random() * memoryEvents.length)];
            const eventDate = parseDate(randomEvent.day);
            const yearsAgo = today.getFullYear() - eventDate.getFullYear();
            
            // Chọn ngẫu nhiên một ảnh từ sự kiện hoặc từ tất cả ảnh
            let randomPhoto = null;
            if (randomEvent.image && randomEvent.image.length > 0) {
                const eventPhotos = photosData.filter(photo => randomEvent.image.includes(photo.id));
                if (eventPhotos.length > 0) {
                    randomPhoto = eventPhotos[Math.floor(Math.random() * eventPhotos.length)];
                }
            }
            
            if (!randomPhoto && photosData.length > 0) {
                randomPhoto = photosData[Math.floor(Math.random() * photosData.length)];
            }
            
            let photoHtml = '';
            if (randomPhoto) {
                const thumbnailUrl = `https://drive.google.com/thumbnail?id=${randomPhoto.id}&sz=w400-h400`;
                const fallbackUrl = `https://lh3.googleusercontent.com/d/${randomPhoto.id}=w400-h400`;
                photoHtml = `
                    <div class="mb-4">
                        <img src="${thumbnailUrl}" alt="${randomPhoto.name}" 
                             class="w-full h-48 object-cover rounded-lg cursor-pointer hover:opacity-90 transition-opacity"
                             data-direct-url="https://drive.google.com/uc?export=view&id=${randomPhoto.id}"
                             onclick="openPhotoModalById('${randomPhoto.id}', this)"
                             onerror="this.src='${fallbackUrl}'; this.onerror=null;">
                    </div>
                `;
            }
            
            container.innerHTML = `
                <div class="text-center">
                    <div class="mb-4">
                        <div class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-primary-100 to-accent-100 text-white rounded-full text-sm font-medium mb-3">
                            <i class="fas fa-calendar-alt mr-2"></i>
                            ${formatDate(eventDate)} - ${yearsAgo} năm trước
                        </div>
                    </div>
                    ${photoHtml}
                    <h3 class="text-xl font-bold text-primary-100 mb-3">${randomEvent.name || 'Kỷ niệm đặc biệt'}</h3>
                    <p class="text-gray-600 leading-relaxed">
                        ${randomEvent.contdetl || 'Một kỷ niệm đẹp đã diễn ra vào ngày này...'}
                    </p>
                    <div class="mt-4 flex items-center justify-center space-x-4 text-sm text-gray-500">
                        <span class="flex items-center">
                            <i class="fas fa-heart text-red-400 mr-1"></i>
                            ${yearsAgo} năm kỷ niệm
                        </span>
                        ${randomPhoto ? `
                            <span class="flex items-center">
                                <i class="fas fa-camera text-blue-400 mr-1"></i>
                                ${randomPhoto.name}
                            </span>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function generateCountdownWidget() {
            const container = document.getElementById('countdown-widget');
            
            if (timelineData.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-clock text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">Chưa có sự kiện nào để đếm ngược</p>
                    </div>
                `;
                return;
            }
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Tìm các sự kiện sắp tới (trong vòng 1 năm)
            const upcomingEvents = timelineData.filter(event => {
                const eventDate = parseDate(event.day);
                const thisYear = new Date(today.getFullYear(), eventDate.getMonth(), eventDate.getDate());
                const nextYear = new Date(today.getFullYear() + 1, eventDate.getMonth(), eventDate.getDate());
                
                const daysToThisYear = Math.ceil((thisYear - today) / (1000 * 60 * 60 * 24));
                const daysToNextYear = Math.ceil((nextYear - today) / (1000 * 60 * 60 * 24));
                
                return (daysToThisYear > 0 && daysToThisYear <= 365) || (daysToNextYear > 0 && daysToNextYear <= 365);
            }).map(event => {
                const eventDate = parseDate(event.day);
                const thisYear = new Date(today.getFullYear(), eventDate.getMonth(), eventDate.getDate());
                const nextYear = new Date(today.getFullYear() + 1, eventDate.getMonth(), eventDate.getDate());
                
                const daysToThisYear = Math.ceil((thisYear - today) / (1000 * 60 * 60 * 24));
                const daysToNextYear = Math.ceil((nextYear - today) / (1000 * 60 * 60 * 24));
                
                let targetDate, daysLeft;
                if (daysToThisYear > 0 && daysToThisYear <= 365) {
                    targetDate = thisYear;
                    daysLeft = daysToThisYear;
                } else {
                    targetDate = nextYear;
                    daysLeft = daysToNextYear;
                }
                
                return {
                    ...event,
                    targetDate,
                    daysLeft,
                    originalDate: eventDate
                };
            }).sort((a, b) => a.daysLeft - b.daysLeft);
            
            if (upcomingEvents.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-calendar-check text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">Không có sự kiện nào sắp tới</p>
                    </div>
                `;
                return;
            }
            
            // Hiển thị tối đa 2 sự kiện gần nhất
            const eventsToShow = upcomingEvents.slice(0, 2);
            
            let countdownHtml = '';
            eventsToShow.forEach(event => {
                const yearsAgo = today.getFullYear() - event.originalDate.getFullYear();
                const anniversary = yearsAgo > 0 ? ` (Kỷ niệm ${yearsAgo + 1} năm)` : '';
                
                let timeText = '';
                let colorClass = '';
                let iconClass = '';
                
                if (event.daysLeft === 0) {
                    timeText = 'Hôm nay!';
                    colorClass = 'bg-red-500';
                    iconClass = 'fas fa-star';
                } else if (event.daysLeft === 1) {
                    timeText = 'Ngày mai';
                    colorClass = 'bg-orange-500';
                    iconClass = 'fas fa-exclamation';
                } else if (event.daysLeft <= 7) {
                    timeText = `${event.daysLeft} ngày nữa`;
                    colorClass = 'bg-yellow-500';
                    iconClass = 'fas fa-clock';
                } else if (event.daysLeft <= 30) {
                    timeText = `${event.daysLeft} ngày nữa`;
                    colorClass = 'bg-blue-500';
                    iconClass = 'fas fa-calendar';
                } else {
                    const weeks = Math.floor(event.daysLeft / 7);
                    const months = Math.floor(event.daysLeft / 30);
                    if (months > 0) {
                        timeText = `${months} tháng ${event.daysLeft % 30} ngày nữa`;
                    } else {
                        timeText = `${weeks} tuần ${event.daysLeft % 7} ngày nữa`;
                    }
                    colorClass = 'bg-green-500';
                    iconClass = 'fas fa-calendar-alt';
                }
                
                countdownHtml += `
                    <div class="bg-white rounded-lg p-4 shadow-sm border-l-4 border-primary-100">
                        <div class="flex-1">
                            <h4 class="font-semibold text-primary-100 mb-1">
                                ${event.name || 'Sự kiện đặc biệt'}${anniversary} - 
                                <span class="text-red-500">Còn ${timeText.replace('Còn ', '').replace(' nữa', '')}</span>
                            </h4>
                            <p class="text-sm text-gray-600 mb-2">${formatDate(event.targetDate)}</p>
                            ${event.contdetl ? `<p class="text-xs text-gray-500">${event.contdetl}</p>` : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = countdownHtml;
        }

        function generateStatsWidget() {
            const container = document.getElementById('stats-widget');
            
            // Tính số ngày bên nhau (từ ngày cố định 22/02/2022 đến hôm nay)
            const fixedStartDate = new Date(2022, 1, 22); // 22/02/2022 (tháng 1 = tháng 2)
            const today = new Date();
            let daysTogether = Math.floor((today - fixedStartDate) / (1000 * 60 * 60 * 24));
            daysTogether = daysTogether > 0 ? daysTogether : 0;
            
            // Thay thế skeleton bằng nội dung thật
            container.innerHTML = `
                <div class="bg-white rounded-xl shadow-lg p-6 text-center">
                    <div class="text-3xl font-bold text-primary-100 mb-2">${timelineData.length}</div>
                    <div class="text-gray-600">Kỷ Niệm</div>
                    <div class="mt-2">
                        <i class="fas fa-heart text-red-400 text-2xl"></i>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 text-center">
                    <div class="text-3xl font-bold text-accent-100 mb-2">${photosData.length}</div>
                    <div class="text-gray-600">Hình Ảnh</div>
                    <div class="mt-2">
                        <i class="fas fa-camera text-blue-400 text-2xl"></i>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 text-center col-span-full">
                    <div class="text-3xl font-bold text-green-500 mb-2">${daysTogether}</div>
                    <div class="text-gray-600">Ngày Bên Nhau</div>
                    <div class="mt-2">
                        <i class="fas fa-calendar-heart text-green-400 text-2xl"></i>
                    </div>
                </div>
            `;
        }



        function refreshMemoryWidget() {
            const button = event.target;
            const originalIcon = button.innerHTML;
            
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            button.disabled = true;
            
            setTimeout(() => {
                generateMemoryWidget();
                button.innerHTML = originalIcon;
                button.disabled = false;
                
                logActivity('Làm mới widget', 'Đã làm mới widget "Ngày Này Năm Xưa"');
                showNotification('Đã làm mới kỷ niệm!', 'success');
            }, 500);
        }

        function refreshCountdownWidget() {
            const button = event.target;
            const originalIcon = button.innerHTML;
            
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            button.disabled = true;
            
            setTimeout(() => {
                generateCountdownWidget();
                button.innerHTML = originalIcon;
                button.disabled = false;
                
                logActivity('Làm mới widget', 'Đã làm mới widget "Đếm Ngược Sự Kiện"');
                showNotification('Đã cập nhật đếm ngược!', 'success');
            }, 500);
        }

        function showEventDetails(eventId) {
            // Chuyển đến trang timeline và highlight sự kiện
            showSection('timeline');
            
            // Scroll to event (có thể implement sau)
            logActivity('Xem chi tiết sự kiện', `Xem chi tiết sự kiện ID: ${eventId}`);
        }

        function openAddEventModal(selectedDate = null) {
            currentEditingEventIndex = null;
            document.getElementById('event-modal-title').textContent = 'Thêm sự kiện mới';
            document.getElementById('event-name').value = '';
            document.getElementById('event-description').value = '';
            
            // Reset selected images
            selectedImageIds = [];
            updateImageDisplay();
            
            if (selectedDate) {
                // Format date for text input (DD/MM/YYYY)
                const day = String(selectedDate.getDate()).padStart(2, '0');
                const month = String(selectedDate.getMonth() + 1).padStart(2, '0');
                const year = selectedDate.getFullYear();
                document.getElementById('event-date').value = `${day}/${month}/${year}`;
            } else {
                document.getElementById('event-date').value = '';
            }
            
            document.getElementById('event-modal').classList.add('active');
        }

        // Timeline functions
        function generateTimeline() {
            const container = document.getElementById('timeline-container');
            
            if (timelineData.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-heart-broken text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500 text-lg">Chưa có kỷ niệm nào được ghi lại</p>
                        <p class="text-gray-400 text-sm mt-2">Hãy tạo những khoảnh khắc đẹp đầu tiên!</p>
                    </div>
                `;
                return;
            }
            
            // Tối ưu hóa: Tạo chuỗi HTML hoàn chỉnh trước khi cập nhật DOM
            let timelineHtml = '';
            
            timelineData.forEach((event, index) => {
                const eventDate = parseDate(event.day);
                
                // Tính số ngày từ hôm nay
                const today = new Date();
                today.setHours(0, 0, 0, 0); // Reset time to start of day
                eventDate.setHours(0, 0, 0, 0); // Reset time to start of day
                const diffTime = today - eventDate;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                let timeAgo = '';
                let timeAgoDetailed = '';
                
                if (diffDays === 0) {
                    timeAgo = 'Hôm nay';
                    timeAgoDetailed = 'Hôm nay';
                } else if (diffDays === 1) {
                    timeAgo = 'Hôm qua';
                    timeAgoDetailed = 'Hôm qua';
                } else if (diffDays > 0) {
                    if (diffDays >= 365) {
                        const years = diffDays / 365;
                        const wholeYears = Math.floor(years);
                        const remainingDays = diffDays % 365;
                        const months = Math.floor(remainingDays / 30);
                        
                        timeAgo = `${diffDays} ngày trước`;
                        timeAgoDetailed = `${wholeYears} năm${months > 0 ? ` ${months} tháng` : ''} trước`;
                    } else {
                        timeAgo = `${diffDays} ngày trước`;
                        timeAgoDetailed = `${diffDays} ngày trước`;
                    }
                } else {
                    timeAgo = `Còn ${Math.abs(diffDays)} ngày nữa`;
                    timeAgoDetailed = `Còn ${Math.abs(diffDays)} ngày nữa`;
                }
                
                // Cộng chuỗi HTML thay vì tạo DOM element
                timelineHtml += `
                    <div class="timeline-item bg-white border-l-4 border-accent-100 shadow-md hover:shadow-lg transition-all duration-300 p-4 rounded-r-lg">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="bg-gradient-to-r from-primary-100 to-accent-100 text-white px-3 py-1 rounded-full text-sm font-medium">
                                        ${formatDate(eventDate)}
                                    </div>
                                    <div class="timeline-actions flex space-x-1 md:space-x-2">
                                        <button class="btn-icon-small" onclick="editEvent(${index})" title="Chỉnh sửa">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn-icon-small" onclick="viewEventPhotos(${index})" title="Xem ảnh">
                                            <i class="fas fa-images"></i>
                                        </button>
                                        <button class="btn-icon-small" onclick="deleteEvent(${index})" title="Xóa">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full cursor-pointer hover:bg-gray-200 transition-colors mb-2 inline-block" 
                                      onclick="toggleTimeDisplay(this, '${timeAgo}', '${timeAgoDetailed}')" 
                                      title="Nhấn để xem chi tiết">
                                    ${timeAgo}
                                </span>
                                <h3 class="text-base font-bold text-primary-100 mb-2 leading-tight cursor-pointer hover:text-primary-80 transition-colors" 
                                    onclick="toggleDescription(this)">${event.name || 'Không có tiêu đề'}</h3>
                                <div class="text-gray-700 leading-relaxed hidden description-content">
                                    ${event.contdetl ? 
                                        `<p class="mb-1 text-xs">${event.contdetl}</p>` : 
                                        '<p class="text-gray-400 italic text-xs">Không có mô tả chi tiết</p>'
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // Thêm thống kê tổng quan vào chuỗi HTML
            timelineHtml += `
                <div class="mt-8 bg-gradient-to-r from-primary-10 to-accent-10 rounded-xl p-6">
                    <div class="text-center">
                        <h4 class="text-lg font-semibold text-primary-100 mb-4">
                            <i class="fas fa-chart-line mr-2"></i>Thống Kê Kỷ Niệm
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-white rounded-lg p-4 shadow-sm">
                                <div class="text-2xl font-bold text-primary-100">${timelineData.length}</div>
                                <div class="text-sm text-gray-600">Tổng kỷ niệm</div>
                            </div>
                            <div class="bg-white rounded-lg p-4 shadow-sm">
                                <div class="text-2xl font-bold text-accent-100">${new Date().getFullYear()}</div>
                                <div class="text-sm text-gray-600">Năm hiện tại</div>
                            </div>
                            <div class="bg-white rounded-lg p-4 shadow-sm">
                                <div class="text-2xl font-bold text-red-400">
                                    <i class="fas fa-heart"></i>
                                </div>
                                <div class="text-sm text-gray-600">Tình yêu vĩnh cửu</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Chỉ cập nhật DOM một lần duy nhất
            container.innerHTML = timelineHtml;
        }

        // Photos functions
        function generatePhotos() {
            const container = document.getElementById('photos-container');
            
            if (photosData.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 col-span-full">Chưa có ảnh nào</p>';
                return;
            }
            
            container.innerHTML = '';
            if (currentView === 'grid') {
                container.className = 'photo-grid';
            } else if (currentView === 'grid-2') {
                container.className = 'grid grid-cols-2 gap-4';
            } else {
                container.className = 'space-y-4';
            }
            
            const startIndex = (currentPhotoPage - 1) * CONFIG.PHOTOS_PER_PAGE;
            const endIndex = startIndex + CONFIG.PHOTOS_PER_PAGE;
            const pagePhotos = photosData.slice(startIndex, endIndex);
            
            renderAllPhotos(pagePhotos, container);
            generatePagination();
        }

        function renderAllPhotos(photos, container) {
            // Tối ưu hóa: Tạo chuỗi HTML hoàn chỉnh trước khi cập nhật DOM
            let photosHtml = '';
            
            photos.forEach((photo, index) => {
                if (currentView === 'grid' || currentView === 'grid-2') {
                    // Tạo URL ảnh từ Google Drive với nhiều phương án dự phòng
                    const thumbnailUrl = `https://drive.google.com/thumbnail?id=${photo.id}&sz=w400-h400`;
                    const directUrl = `https://drive.google.com/uc?export=view&id=${photo.id}`;
                    const fallbackUrl = `https://lh3.googleusercontent.com/d/${photo.id}=w400-h400`;
                    
                    // Cộng chuỗi HTML thay vì tạo DOM element
                    photosHtml += `
                        <div class="photo-item bg-white rounded-lg shadow-md overflow-hidden cursor-pointer relative" 
                             data-direct-url="${directUrl}" 
                             data-photo-id="${photo.id}"
                             onclick="openPhotoModalById('${photo.id}', this)">
                            <img src="${thumbnailUrl}" alt="${photo.name}" class="w-full h-48 object-cover" 
                                 onerror="this.src='${fallbackUrl}'; this.onerror=null;">
                            <div class="absolute bottom-2 right-2 bg-black bg-opacity-70 text-white px-2 py-1 rounded-lg text-xs flex items-center space-x-2">
                                <span class="flex items-center">
                                    <i class="fas fa-heart text-red-400 mr-1"></i>
                                    ${getPhotoLikes(photo.name)}
                                </span>
                                <span class="flex items-center">
                                    <i class="fas fa-comment text-blue-400 mr-1"></i>
                                    ${getPhotoCommentsCount(photo.name)}
                                </span>
                            </div>
                        </div>
                    `;
                } else {
                    // Tạo URL ảnh từ Google Drive cho list view
                    const thumbnailUrl = `https://drive.google.com/thumbnail?id=${photo.id}&sz=w400-h400`;
                    const directUrl = `https://drive.google.com/uc?export=view&id=${photo.id}`;
                    const fallbackUrl = `https://lh3.googleusercontent.com/d/${photo.id}=w400-h400`;
                    
                    // Format file size
                    const formatFileSize = (bytes) => {
                        if (!bytes) return 'N/A';
                        const sizes = ['B', 'KB', 'MB', 'GB'];
                        const i = Math.floor(Math.log(bytes) / Math.log(1024));
                        return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
                    };
                    
                    // Format date
                    const formatPhotoDate = (dateStr) => {
                        if (!dateStr) return 'N/A';
                        try {
                            const date = new Date(dateStr);
                            return date.toLocaleDateString('vi-VN') + ' ' + date.toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'});
                        } catch {
                            return 'N/A';
                        }
                    };
                    
                    // Cộng chuỗi HTML cho list view
                    photosHtml += `
                        <div class="photo-item bg-white rounded-lg shadow-md p-4 flex items-start space-x-4 cursor-pointer hover:shadow-lg transition-shadow" 
                             data-direct-url="${directUrl}" 
                             data-photo-id="${photo.id}"
                             onclick="openPhotoModalById('${photo.id}', this)">
                            <img src="${thumbnailUrl}" alt="${photo.name}" class="w-20 h-20 object-cover rounded-lg flex-shrink-0" 
                                 onerror="this.src='${fallbackUrl}'; this.onerror=null;">
                            <div class="flex-1 min-w-0">
                                <h4 class="font-semibold text-primary-100 mb-2 truncate">${photo.name}</h4>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm text-gray-600 mb-3">
                                    <div class="flex items-center">
                                        <i class="fas fa-hdd text-gray-400 mr-2 w-4"></i>
                                        <span>${formatFileSize(photo.size)}</span>
                                    </div>
                                    <div class="flex items-center">
                                        <i class="fas fa-calendar text-gray-400 mr-2 w-4"></i>
                                        <span>${formatPhotoDate(photo.createdTime)}</span>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-4 text-sm">
                                    <span class="flex items-center text-red-500">
                                        <i class="fas fa-heart mr-1"></i> 
                                        ${getPhotoLikes(photo.name)}
                                    </span>
                                    <span class="flex items-center text-primary-100">
                                        <i class="fas fa-comment mr-1"></i> 
                                        ${getPhotoCommentsCount(photo.name)}
                                    </span>
                                    <span class="flex items-center text-gray-500">
                                        <i class="fas fa-eye mr-1"></i> 
                                        Xem chi tiết
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });
            
            // Chỉ cập nhật DOM một lần duy nhất
            container.innerHTML = photosHtml;
        }

        function generatePagination() {
            const totalPages = Math.ceil(photosData.length / CONFIG.PHOTOS_PER_PAGE);
            const pagination = document.getElementById('pagination');
            
            pagination.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            // Previous button
            if (currentPhotoPage > 1) {
                const prevBtn = document.createElement('button');
                prevBtn.className = 'px-2 py-1 rounded-lg bg-primary-100 text-white hover:bg-primary-80 text-sm';
                prevBtn.innerHTML = '<i class="fas fa-chevron-left text-xs"></i>';
                prevBtn.onclick = () => changePage(currentPhotoPage - 1);
                pagination.appendChild(prevBtn);
            }
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPhotoPage - 2 && i <= currentPhotoPage + 2)) {
                    const pageBtn = document.createElement('button');
                    pageBtn.className = `px-2 py-1 rounded-lg text-sm ${
                        i === currentPhotoPage 
                            ? 'bg-primary-100 text-white' 
                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                    }`;
                    pageBtn.textContent = i;
                    pageBtn.onclick = () => changePage(i);
                    pagination.appendChild(pageBtn);
                } else if (i === currentPhotoPage - 3 || i === currentPhotoPage + 3) {
                    const dots = document.createElement('span');
                    dots.className = 'px-1 py-1 text-gray-500 text-sm';
                    dots.textContent = '...';
                    pagination.appendChild(dots);
                }
            }
            
            // Next button
            if (currentPhotoPage < totalPages) {
                const nextBtn = document.createElement('button');
                nextBtn.className = 'px-2 py-1 rounded-lg bg-primary-100 text-white hover:bg-primary-80 text-sm';
                nextBtn.innerHTML = '<i class="fas fa-chevron-right text-xs"></i>';
                nextBtn.onclick = () => changePage(currentPhotoPage + 1);
                pagination.appendChild(nextBtn);
            }
            

        }

        function changePage(page) {
            currentPhotoPage = page;
            generatePhotos();
            

        }

        function toggleView(view) {
            currentView = view;
            
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('bg-primary-100', 'text-white');
                btn.classList.add('bg-gray-300', 'text-gray-600');
            });
            
            document.getElementById(`${view}-btn`).classList.remove('bg-gray-300', 'text-gray-600');
            document.getElementById(`${view}-btn`).classList.add('bg-primary-100', 'text-white');
            
            generatePhotos();
        }

        // Modal functions
        function openPhotoModal(photo, element = null) {
            currentPhotoId = photo.name;
            
            document.getElementById('modal-title').textContent = photo.name;
            
            // Sử dụng directUrl từ element hoặc tạo mới từ photo.id
            let directUrl;
            if (element && element.dataset.directUrl) {
                directUrl = element.dataset.directUrl;
            } else {
                directUrl = `https://drive.google.com/uc?export=view&id=${photo.id}`;
            }
            
            const modalImage = document.getElementById('modal-image');
            modalImage.src = directUrl;
            
            // Fallback nếu ảnh chất lượng cao không tải được
            modalImage.onerror = function() {
                this.src = `https://lh3.googleusercontent.com/d/${photo.id}=w800-h800`;
                this.onerror = null;
            };
            
            const likeCount = getPhotoLikes(photo.name);
            const commentCount = getPhotoCommentsCount(photo.name);
            
            document.getElementById('like-count').textContent = likeCount;
            document.getElementById('comment-count').textContent = commentCount;
            
            // Ẩn phần bình luận mặc định
            document.getElementById('comments-list-section').classList.add('hidden');
            document.getElementById('comment-input-wrapper').classList.add('hidden');
            
            loadComments(photo.name);
            
            document.getElementById('photo-modal').classList.add('active');
        }

        function openPhotoModalById(photoId, element = null) {
            const photo = photosData.find(p => p.id === photoId);
            if (photo) {
                openPhotoModal(photo, element);
            } else {
                console.error('Không tìm thấy ảnh với ID:', photoId);
                showNotification('Không tìm thấy ảnh!', 'error');
            }
        }

        function closeModal() {
            document.getElementById('photo-modal').classList.remove('active');
            currentPhotoId = null;
        }

        function toggleComments() {
            const commentsListSection = document.getElementById('comments-list-section');
            const commentInputWrapper = document.getElementById('comment-input-wrapper');
            const commentBtn = document.getElementById('comment-btn');
            const commentInput = document.getElementById('comment-input');
            
            if (commentsListSection.classList.contains('hidden')) {
                // Show comments
                commentsListSection.classList.remove('hidden');
                commentInputWrapper.classList.remove('hidden');
                
                // Update button style
                commentBtn.classList.add('bg-primary-80');
                commentBtn.classList.remove('bg-primary-100');
                
                // Focus on input after a short delay to ensure it's visible
                setTimeout(() => {
                    commentInput.focus();
                }, 150);
                
            } else {
                // Hide comments
                commentsListSection.classList.add('hidden');
                commentInputWrapper.classList.add('hidden');
                
                // Update button style
                commentBtn.classList.remove('bg-primary-80');
                commentBtn.classList.add('bg-primary-100');
                
                // Clear input and blur
                commentInput.value = '';
                commentInput.blur();
            }
        }

        function loadComments(photoName) {
            const container = document.getElementById('comments-container');
            const comments = getPhotoComments(photoName);
            
            container.innerHTML = '';
            
            if (comments.length === 0) {
                container.innerHTML = '<div class="text-center py-8"><i class="fas fa-comments text-gray-300 text-3xl mb-2"></i><p class="text-gray-500">Chưa có bình luận nào</p><p class="text-gray-400 text-sm">Hãy là người đầu tiên bình luận!</p></div>';
                return;
            }
            
            comments.forEach(comment => {
                const commentElement = document.createElement('div');
                commentElement.className = 'bg-gray-50 rounded-lg p-3 hover:bg-gray-100 transition-colors';
                const commentDate = new Date(comment.date_input).toLocaleString('vi-VN');
                
                // Get user info for comment
                const userName = comment.userName || 'Ẩn danh';
                const userAvatar = comment.userAvatar;
                
                let avatarHtml = '';
                if (userAvatar) {
                    avatarHtml = `<img src="${userAvatar}" alt="${userName}" class="w-8 h-8 rounded-full object-cover border-2 border-white shadow-sm">`;
                } else {
                    avatarHtml = `<div class="w-8 h-8 rounded-full bg-primary-100 flex items-center justify-center"><i class="fas fa-user text-white text-sm"></i></div>`;
                }
                
                commentElement.innerHTML = `
                    <div class="flex items-start space-x-3">
                        ${avatarHtml}
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center space-x-2 mb-1">
                                <span class="font-semibold text-sm text-primary-100">${userName}</span>
                                <span class="text-xs text-gray-500">${commentDate}</span>
                            </div>
                            <p class="text-gray-700 text-sm leading-relaxed">${comment.comment}</p>
                        </div>
                    </div>
                `;
                container.appendChild(commentElement);
            });
        }

        async function likePhoto() {
            if (!currentPhotoId) return;
            
            try {
                let photoData = commentsMap[currentPhotoId];
                
                if (!photoData) {
                    photoData = {
                        ID_IMG: currentPhotoId,
                        count_tim: 0,
                        comments: [],
                        likes: []
                    };
                    commentsData.push(photoData);
                    // Cập nhật Map
                    commentsMap[currentPhotoId] = photoData;
                }
                
                // Initialize likes array if not exists
                if (!photoData.likes) {
                    photoData.likes = [];
                }
                
                const userId = currentUser ? currentUser.username : 'anonymous';
                const userLikeIndex = photoData.likes.findIndex(like => like.userId === userId);
                
                if (userLikeIndex === -1) {
                    // User hasn't liked yet, add like
                    photoData.count_tim++;
                    photoData.likes.push({
                        userId: userId,
                        userName: currentUser ? currentUser.fullName : 'Ẩn danh',
                        timestamp: new Date().toISOString()
                    });
                    
                    // Update user like count
                    if (currentUser && !currentUser.isAnonymous) {
                        currentUser.likesCount = (currentUser.likesCount || 0) + 1;
                        localStorage.setItem('loveStoryCurrentUser', JSON.stringify(currentUser));
                        
                        // Update profile in profilesData
                        const profileIndex = profilesData.findIndex(p => p.username === currentUser.username);
                        if (profileIndex !== -1) {
                            profilesData[profileIndex].likesCount = currentUser.likesCount;
                        }
                    }
                    
                    showNotification('Đã thích ảnh!', 'success');
                    logActivity('Thích ảnh', `${currentUser.fullName} đã thích ảnh: ${currentPhotoId} (${photoData.count_tim} lượt thích)`);
                } else {
                    // User already liked, remove like
                    photoData.count_tim--;
                    photoData.likes.splice(userLikeIndex, 1);
                    
                    // Update user like count
                    if (currentUser && !currentUser.isAnonymous) {
                        currentUser.likesCount = Math.max(0, (currentUser.likesCount || 0) - 1);
                        localStorage.setItem('loveStoryCurrentUser', JSON.stringify(currentUser));
                        
                        // Update profile in profilesData
                        const profileIndex = profilesData.findIndex(p => p.username === currentUser.username);
                        if (profileIndex !== -1) {
                            profilesData[profileIndex].likesCount = currentUser.likesCount;
                        }
                    }
                    
                    showNotification('Đã bỏ thích ảnh!', 'info');
                    logActivity('Bỏ thích ảnh', `${currentUser.fullName} đã bỏ thích ảnh: ${currentPhotoId} (${photoData.count_tim} lượt thích)`);
                }
                
                // Update UI immediately
                const likeCountElement = document.getElementById('like-count');
                if (likeCountElement) {
                    likeCountElement.textContent = photoData.count_tim;
                }
                
                // Update like button appearance
                const likeBtn = document.getElementById('like-btn');
                if (userLikeIndex === -1) {
                    // Just liked
                    likeBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                    likeBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                } else {
                    // Just unliked
                    likeBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                    likeBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                }
                
                // Update the photo grid
                generatePhotos();
                
                // Save to GitHub in background
                saveToGitHub(CONFIG.COMMENTS_FILE_PATH, commentsData, `Cập nhật lượt thích ảnh: ${currentPhotoId}`);
                
            } catch (error) {
                console.error('Lỗi khi thích ảnh:', error);
                logActivity('Lỗi thích ảnh', error.message);
                showNotification('Lỗi khi thích ảnh!', 'error');
            }
        }

        async function addComment() {
            if (!currentPhotoId) return;
            
            const input = document.getElementById('comment-input');
            const commentText = input.value.trim();
            
            if (!commentText) {
                showNotification('Vui lòng nhập nội dung bình luận!', 'warning');
                return;
            }
            
            try {
                let photoData = commentsMap[currentPhotoId];
                
                if (!photoData) {
                    photoData = {
                        ID_IMG: currentPhotoId,
                        count_tim: 0,
                        comments: []
                    };
                    commentsData.push(photoData);
                    // Cập nhật Map
                    commentsMap[currentPhotoId] = photoData;
                }
                
                const newComment = {
                    comment: commentText,
                    date_input: new Date().toISOString(),
                    userName: currentUser ? currentUser.fullName : 'Ẩn danh',
                    userAvatar: currentUser ? currentUser.avatar : null,
                    userId: currentUser ? currentUser.username : null
                };
                
                photoData.comments.push(newComment);
                
                // Update user comment count
                if (currentUser && !currentUser.isAnonymous) {
                    currentUser.commentsCount = (currentUser.commentsCount || 0) + 1;
                    localStorage.setItem('loveStoryCurrentUser', JSON.stringify(currentUser));
                    
                    // Update profile in profilesData
                    const profileIndex = profilesData.findIndex(p => p.username === currentUser.username);
                    if (profileIndex !== -1) {
                        profilesData[profileIndex].commentsCount = currentUser.commentsCount;
                    }
                }
                
                // Clear input and update UI immediately
                input.value = '';
                loadComments(currentPhotoId);
                generatePhotos();
                
                // Update comment count in modal
                const commentCount = getPhotoCommentsCount(currentPhotoId);
                document.getElementById('comment-count').textContent = commentCount;
                
                // Save to GitHub in background
                saveToGitHub(CONFIG.COMMENTS_FILE_PATH, commentsData, `Thêm bình luận cho ảnh: ${currentPhotoId}`);
                
                // Log activity
                logActivity('Thêm bình luận', `${currentUser.fullName} đã bình luận cho ảnh: ${currentPhotoId}: "${commentText}"`);
                showNotification('Đã thêm bình luận!', 'success');
                
            } catch (error) {
                console.error('Lỗi khi thêm bình luận:', error);
                logActivity('Lỗi thêm bình luận', error.message);
                showNotification('Lỗi khi thêm bình luận!', 'error');
            }
        }

        // New functions for share and download
        function sharePhoto() {
            if (!currentPhotoId) return;
            
            const photoUrl = document.getElementById('modal-image').src;
            document.getElementById('share-link').value = photoUrl;
            document.getElementById('share-modal').classList.add('active');
            
            logActivity('Mở modal chia sẻ', `Mở modal chia sẻ cho ảnh: ${currentPhotoId}`);
        }

        function closeShareModal() {
            document.getElementById('share-modal').classList.remove('active');
            document.getElementById('qr-code-container').classList.add('hidden');
            document.getElementById('qr-code').innerHTML = '';
        }

        function copyShareLink() {
            const shareLink = document.getElementById('share-link');
            shareLink.select();
            shareLink.setSelectionRange(0, 99999);
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(shareLink.value).then(() => {
                    showNotification('Đã sao chép link ảnh!', 'success');
                    logActivity('Sao chép link', `Đã sao chép link ảnh: ${currentPhotoId}`);
                });
            } else {
                document.execCommand('copy');
                showNotification('Đã sao chép link ảnh!', 'success');
                logActivity('Sao chép link', `Đã sao chép link ảnh: ${currentPhotoId}`);
            }
        }

        function shareToFacebook() {
            const url = document.getElementById('share-link').value;
            const shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
            window.open(shareUrl, '_blank', 'width=600,height=400');
            logActivity('Chia sẻ Facebook', `Chia sẻ ảnh ${currentPhotoId} lên Facebook`);
        }

        function shareToTwitter() {
            const url = document.getElementById('share-link').value;
            const text = `Xem ảnh đẹp: ${currentPhotoId} - Love Story`;
            const shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`;
            window.open(shareUrl, '_blank', 'width=600,height=400');
            logActivity('Chia sẻ Twitter', `Chia sẻ ảnh ${currentPhotoId} lên Twitter`);
        }

        function shareToTelegram() {
            const url = document.getElementById('share-link').value;
            const text = `Xem ảnh đẹp: ${currentPhotoId}`;
            const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`;
            window.open(shareUrl, '_blank', 'width=600,height=400');
            logActivity('Chia sẻ Telegram', `Chia sẻ ảnh ${currentPhotoId} lên Telegram`);
        }

        function shareToWhatsApp() {
            const url = document.getElementById('share-link').value;
            const text = `Xem ảnh đẹp: ${currentPhotoId}\n${url}`;
            const shareUrl = `https://wa.me/?text=${encodeURIComponent(text)}`;
            window.open(shareUrl, '_blank', 'width=600,height=400');
            logActivity('Chia sẻ WhatsApp', `Chia sẻ ảnh ${currentPhotoId} lên WhatsApp`);
        }

        function shareToLinkedIn() {
            const url = document.getElementById('share-link').value;
            const shareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}`;
            window.open(shareUrl, '_blank', 'width=600,height=400');
            logActivity('Chia sẻ LinkedIn', `Chia sẻ ảnh ${currentPhotoId} lên LinkedIn`);
        }

        function shareToEmail() {
            const url = document.getElementById('share-link').value;
            const subject = `Love Story - Khoảnh khắc đẹp: ${currentPhotoId}`;
            const body = `Xin chào,\n\nTôi muốn chia sẻ với bạn một khoảnh khắc đẹp từ Love Story:\n\n${currentPhotoId}\n\nXem ảnh tại: ${url}\n\nTrân trọng!`;
            const mailtoUrl = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(mailtoUrl, '_blank');
            logActivity('Chia sẻ Email', `Chia sẻ ảnh ${currentPhotoId} qua Email`);
        }

        function generateQRCode() {
            const url = document.getElementById('share-link').value;
            const qrContainer = document.getElementById('qr-code');
            const qrCodeContainer = document.getElementById('qr-code-container');
            
            if (!url) {
                showNotification('Không có link để tạo QR code!', 'warning');
                return;
            }
            
            try {
                // Sử dụng QR Server API - dịch vụ miễn phí và ổn định
                const qrSize = 200;
                const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=${qrSize}x${qrSize}&data=${encodeURIComponent(url)}&format=png&margin=10`;
                
                // Tạo img element với error handling
                const qrImg = document.createElement('img');
                qrImg.src = qrUrl;
                qrImg.alt = 'QR Code';
                qrImg.className = 'border rounded-lg shadow-sm mx-auto';
                qrImg.style.maxWidth = '200px';
                qrImg.style.height = 'auto';
                
                // Xử lý lỗi nếu không tải được QR code
                qrImg.onerror = function() {
                    // Fallback: Sử dụng dịch vụ khác
                    const fallbackUrl = `https://chart.googleapis.com/chart?chs=200x200&cht=qr&chl=${encodeURIComponent(url)}&choe=UTF-8`;
                    this.src = fallbackUrl;
                    
                    // Nếu fallback cũng lỗi
                    this.onerror = function() {
                        qrContainer.innerHTML = `
                            <div class="text-center p-4 bg-gray-100 rounded-lg">
                                <i class="fas fa-exclamation-triangle text-yellow-500 text-2xl mb-2"></i>
                                <p class="text-sm text-gray-600">Không thể tạo mã QR</p>
                                <p class="text-xs text-gray-500 mt-1">Vui lòng thử lại sau</p>
                            </div>
                        `;
                    };
                };
                
                qrImg.onload = function() {
                    logActivity('Tạo mã QR', `Tạo mã QR thành công cho ảnh: ${currentPhotoId}`);
                };
                
                qrContainer.innerHTML = '';
                qrContainer.appendChild(qrImg);
                qrCodeContainer.classList.remove('hidden');
                
            } catch (error) {
                console.error('Lỗi tạo QR code:', error);
                logActivity('Lỗi tạo QR', `Lỗi tạo mã QR: ${error.message}`);
                
                qrContainer.innerHTML = `
                    <div class="text-center p-4 bg-red-50 rounded-lg">
                        <i class="fas fa-times-circle text-red-500 text-2xl mb-2"></i>
                        <p class="text-sm text-red-600">Lỗi tạo mã QR</p>
                        <p class="text-xs text-red-500 mt-1">${error.message}</p>
                    </div>
                `;
                qrCodeContainer.classList.remove('hidden');
                
                showNotification('Lỗi tạo mã QR!', 'error');
            }
        }

        function downloadPhoto() {
            if (!currentPhotoId) return;
            
            // Mở file Google Drive cụ thể trong tab mới
            const driveUrl = 'https://drive.google.com/file/d/1NeSp1wSvYq0eTEfPxiMT7z3KcLhRM8Le/view';
            window.open(driveUrl, '_blank', 'noopener,noreferrer');
            
            logActivity('Mở file Drive', `Đã mở file Google Drive để tải ảnh: ${currentPhotoId}`);
            showNotification('Đã mở file Google Drive!', 'success');
        }

        // Event handlers
        function showAddEventModal() {
            openAddEventModal();
        }

        function editEvent(index) {
            currentEditingEventIndex = index;
            const event = timelineData[index];
            
            document.getElementById('event-modal-title').textContent = 'Chỉnh sửa sự kiện';
            document.getElementById('event-name').value = event.name || '';
            
            // Convert date format from DD-MM-YYYY to DD/MM/YYYY for text input
            const [day, month, year] = event.day.split('-');
            document.getElementById('event-date').value = `${day.padStart(2, '0')}/${month.padStart(2, '0')}/${year}`;
            
            document.getElementById('event-description').value = event.contdetl || '';
            
            // Load existing images
            selectedImageIds = event.image ? [...event.image] : [];
            updateImageDisplay();
            
            document.getElementById('event-modal').classList.add('active');
        }

        function viewEventPhotos(index) {
            currentEventIndex = index;
            const event = timelineData[index];
            
            // Lấy danh sách ID ảnh từ sự kiện
            const imageIds = event.image || [];
            
            if (imageIds.length === 0) {
                showNotification('Sự kiện này chưa có ảnh nào', 'info');
                return;
            }
            
            // Tìm ảnh tương ứng từ photosData
            currentEventPhotos = photosData.filter(photo => imageIds.includes(photo.id));
            
            if (currentEventPhotos.length === 0) {
                showNotification('Không tìm thấy ảnh cho sự kiện này', 'warning');
                return;
            }
            
            // Reset pagination
            currentEventPhotoPage = 1;
            
            // Set modal title
            document.getElementById('event-photos-title').textContent = `Ảnh sự kiện: ${event.name || 'Không có tên'}`;
            
            // Generate photos
            generateEventPhotos();
            
            // Show modal
            document.getElementById('event-photos-modal').classList.add('active');
            
            logActivity('Xem ảnh sự kiện', `Xem ảnh cho sự kiện: ${event.name || 'Không có tên'} (${currentEventPhotos.length} ảnh)`);
        }

        function deleteEvent(index) {
            currentDeletingEventIndex = index;
            const event = timelineData[index];
            document.getElementById('delete-event-name').textContent = event.name || 'Sự kiện không có tên';
            document.getElementById('delete-modal').classList.add('active');
        }

        function closeEventPhotosModal() {
            document.getElementById('event-photos-modal').classList.remove('active');
            currentEventPhotos = [];
            currentEventPhotoPage = 1;
            currentEventIndex = null;
        }

        function generateEventPhotos() {
            const container = document.getElementById('event-photos-container');
            
            if (currentEventPhotos.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 col-span-full">Không có ảnh nào</p>';
                return;
            }
            
            const startIndex = (currentEventPhotoPage - 1) * CONFIG.PHOTOS_PER_PAGE;
            const endIndex = startIndex + CONFIG.PHOTOS_PER_PAGE;
            const pagePhotos = currentEventPhotos.slice(startIndex, endIndex);
            
            // Set container class
            if (currentEventView === 'grid') {
                container.className = 'photo-grid';
            } else if (currentEventView === 'grid-2') {
                container.className = 'grid grid-cols-2 gap-4';
            } else {
                container.className = 'space-y-4';
            }
            
            // Tối ưu hóa: Tạo chuỗi HTML hoàn chỉnh trước khi cập nhật DOM
            let eventPhotosHtml = '';
            
            pagePhotos.forEach((photo, index) => {
                if (currentEventView === 'grid' || currentEventView === 'grid-2') {
                    // Tạo URL ảnh từ Google Drive với nhiều phương án dự phòng
                    const thumbnailUrl = `https://drive.google.com/thumbnail?id=${photo.id}&sz=w400-h400`;
                    const directUrl = `https://drive.google.com/uc?export=view&id=${photo.id}`;
                    const fallbackUrl = `https://lh3.googleusercontent.com/d/${photo.id}=w400-h400`;
                    
                    // Cộng chuỗi HTML thay vì tạo DOM element
                    eventPhotosHtml += `
                        <div class="photo-item bg-white rounded-lg shadow-md overflow-hidden cursor-pointer relative" 
                             data-direct-url="${directUrl}" 
                             data-photo-id="${photo.id}"
                             onclick="openPhotoModalById('${photo.id}', this)">
                            <img src="${thumbnailUrl}" alt="${photo.name}" class="w-full h-48 object-cover" 
                                 onerror="this.src='${fallbackUrl}'; this.onerror=null;">
                            <div class="absolute bottom-2 right-2 bg-black bg-opacity-70 text-white px-2 py-1 rounded-lg text-xs flex items-center space-x-2">
                                <span class="flex items-center">
                                    <i class="fas fa-heart text-red-400 mr-1"></i>
                                    ${getPhotoLikes(photo.name)}
                                </span>
                                <span class="flex items-center">
                                    <i class="fas fa-comment text-blue-400 mr-1"></i>
                                    ${getPhotoCommentsCount(photo.name)}
                                </span>
                            </div>
                        </div>
                    `;
                } else {
                    // Tạo URL ảnh từ Google Drive cho list view
                    const thumbnailUrl = `https://drive.google.com/thumbnail?id=${photo.id}&sz=w400-h400`;
                    const directUrl = `https://drive.google.com/uc?export=view&id=${photo.id}`;
                    const fallbackUrl = `https://lh3.googleusercontent.com/d/${photo.id}=w400-h400`;
                    
                    // Format file size
                    const formatFileSize = (bytes) => {
                        if (!bytes) return 'N/A';
                        const sizes = ['B', 'KB', 'MB', 'GB'];
                        const i = Math.floor(Math.log(bytes) / Math.log(1024));
                        return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
                    };
                    
                    // Format date
                    const formatPhotoDate = (dateStr) => {
                        if (!dateStr) return 'N/A';
                        try {
                            const date = new Date(dateStr);
                            return date.toLocaleDateString('vi-VN') + ' ' + date.toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'});
                        } catch {
                            return 'N/A';
                        }
                    };
                    
                    // Cộng chuỗi HTML cho list view
                    eventPhotosHtml += `
                        <div class="photo-item bg-white rounded-lg shadow-md p-4 flex items-start space-x-4 cursor-pointer hover:shadow-lg transition-shadow" 
                             data-direct-url="${directUrl}" 
                             data-photo-id="${photo.id}"
                             onclick="openPhotoModalById('${photo.id}', this)">
                            <img src="${thumbnailUrl}" alt="${photo.name}" class="w-20 h-20 object-cover rounded-lg flex-shrink-0" 
                                 onerror="this.src='${fallbackUrl}'; this.onerror=null;">
                            <div class="flex-1 min-w-0">
                                <h4 class="font-semibold text-primary-100 mb-2 truncate">${photo.name}</h4>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm text-gray-600 mb-3">
                                    <div class="flex items-center">
                                        <i class="fas fa-hdd text-gray-400 mr-2 w-4"></i>
                                        <span>${formatFileSize(photo.size)}</span>
                                    </div>
                                    <div class="flex items-center">
                                        <i class="fas fa-calendar text-gray-400 mr-2 w-4"></i>
                                        <span>${formatPhotoDate(photo.createdTime)}</span>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-4 text-sm">
                                    <span class="flex items-center text-red-500">
                                        <i class="fas fa-heart mr-1"></i> 
                                        ${getPhotoLikes(photo.name)}
                                    </span>
                                    <span class="flex items-center text-primary-100">
                                        <i class="fas fa-comment mr-1"></i> 
                                        ${getPhotoCommentsCount(photo.name)}
                                    </span>
                                    <span class="flex items-center text-gray-500">
                                        <i class="fas fa-eye mr-1"></i> 
                                        Xem chi tiết
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });
            
            // Chỉ cập nhật DOM một lần duy nhất
            container.innerHTML = eventPhotosHtml;
            
            generateEventPagination();
        }

        function generateEventPagination() {
            const totalPages = Math.ceil(currentEventPhotos.length / CONFIG.PHOTOS_PER_PAGE);
            const pagination = document.getElementById('event-pagination');
            
            pagination.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            // Previous button
            if (currentEventPhotoPage > 1) {
                const prevBtn = document.createElement('button');
                prevBtn.className = 'px-2 py-1 rounded-lg bg-primary-100 text-white hover:bg-primary-80 text-sm';
                prevBtn.innerHTML = '<i class="fas fa-chevron-left text-xs"></i>';
                prevBtn.onclick = () => changeEventPage(currentEventPhotoPage - 1);
                pagination.appendChild(prevBtn);
            }
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentEventPhotoPage - 2 && i <= currentEventPhotoPage + 2)) {
                    const pageBtn = document.createElement('button');
                    pageBtn.className = `px-2 py-1 rounded-lg text-sm ${
                        i === currentEventPhotoPage 
                            ? 'bg-primary-100 text-white' 
                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                    }`;
                    pageBtn.textContent = i;
                    pageBtn.onclick = () => changeEventPage(i);
                    pagination.appendChild(pageBtn);
                } else if (i === currentEventPhotoPage - 3 || i === currentEventPhotoPage + 3) {
                    const dots = document.createElement('span');
                    dots.className = 'px-1 py-1 text-gray-500 text-sm';
                    dots.textContent = '...';
                    pagination.appendChild(dots);
                }
            }
            
            // Next button
            if (currentEventPhotoPage < totalPages) {
                const nextBtn = document.createElement('button');
                nextBtn.className = 'px-2 py-1 rounded-lg bg-primary-100 text-white hover:bg-primary-80 text-sm';
                nextBtn.innerHTML = '<i class="fas fa-chevron-right text-xs"></i>';
                nextBtn.onclick = () => changeEventPage(currentEventPhotoPage + 1);
                pagination.appendChild(nextBtn);
            }
        }

        function changeEventPage(page) {
            currentEventPhotoPage = page;
            generateEventPhotos();
        }

        function toggleEventView(view) {
            currentEventView = view;
            
            document.querySelectorAll('.event-view-btn').forEach(btn => {
                btn.classList.remove('bg-primary-100', 'text-white');
                btn.classList.add('bg-gray-300', 'text-gray-600');
            });
            
            document.getElementById(`event-${view}-btn`).classList.remove('bg-gray-300', 'text-gray-600');
            document.getElementById(`event-${view}-btn`).classList.add('bg-primary-100', 'text-white');
            
            generateEventPhotos();
        }

        function closeEventModal() {
            document.getElementById('event-modal').classList.remove('active');
            currentEditingEventIndex = null;
        }

        function closeDeleteModal() {
            document.getElementById('delete-modal').classList.remove('active');
            currentDeletingEventIndex = null;
        }

        async function confirmDeleteEvent() {
            if (currentDeletingEventIndex === null) return;
            
            try {
                const deletedEvent = timelineData[currentDeletingEventIndex];
                timelineData.splice(currentDeletingEventIndex, 1);
                
                // Save to GitHub
                await saveToGitHub(CONFIG.FILE_PATH, timelineData, `Xóa sự kiện: ${deletedEvent.name || 'Không có tên'}`);
                
                // Update UI
                generateTimeline();
                generateWidgets();
                closeDeleteModal();
                
                logActivity('Xóa sự kiện', `Đã xóa sự kiện: ${deletedEvent.name || 'Không có tên'}`);
                showNotification('Đã xóa sự kiện thành công!', 'success');
            } catch (error) {
                console.error('Lỗi xóa sự kiện:', error);
                logActivity('Lỗi xóa sự kiện', error.message);
                showNotification('Lỗi khi xóa sự kiện!', 'error');
            }
        }

        // Handle event form submission
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('event-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const name = document.getElementById('event-name').value.trim();
                const date = document.getElementById('event-date').value;
                const description = document.getElementById('event-description').value.trim();
                
                if (!name || !date) {
                    showNotification('Vui lòng nhập đầy đủ tên sự kiện và ngày!', 'warning');
                    return;
                }
                
                // Validate date format DD/MM/YYYY
                const dateRegex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
                if (!dateRegex.test(date)) {
                    showNotification('Vui lòng nhập ngày đúng định dạng DD/MM/YYYY!', 'warning');
                    return;
                }
                
                const [inputDay, inputMonth, inputYear] = date.split('/');
                const dateObj = new Date(inputYear, inputMonth - 1, inputDay);
                
                if (dateObj.getDate() != inputDay || dateObj.getMonth() != inputMonth - 1 || dateObj.getFullYear() != inputYear) {
                    showNotification('Ngày không hợp lệ! Vui lòng kiểm tra lại.', 'warning');
                    return;
                }
                
                // Convert date format from DD/MM/YYYY to DD-MM-YYYY
                const [day, month, year] = date.split('/');
                const formattedDate = `${day.padStart(2, '0')}-${month.padStart(2, '0')}-${year}`;
                
                const eventData = {
                    note_id: currentEditingEventIndex !== null ? timelineData[currentEditingEventIndex].note_id : Date.now(),
                    name: name,
                    day: formattedDate,
                    contdetl: description,
                    image: selectedImageIds.length > 0 ? [...selectedImageIds] : []
                };
                
                try {
                    if (currentEditingEventIndex !== null) {
                        // Edit existing event
                        timelineData[currentEditingEventIndex] = eventData;
                        logActivity('Sửa sự kiện', `Đã cập nhật sự kiện: ${name}`);
                    } else {
                        // Add new event
                        timelineData.push(eventData);
                        logActivity('Thêm sự kiện', `Đã thêm sự kiện mới: ${name}`);
                    }
                    
                    // Sort timeline by date
                    timelineData.sort((a, b) => {
                        const dateA = parseDate(a.day);
                        const dateB = parseDate(b.day);
                        return dateA - dateB;
                    });
                    
                    // Save to GitHub
                    const commitMessage = currentEditingEventIndex !== null 
                        ? `Cập nhật sự kiện: ${name}` 
                        : `Thêm sự kiện mới: ${name}`;
                    
                    await saveToGitHub(CONFIG.FILE_PATH, timelineData, commitMessage);
                    
                    // Update UI
                    generateTimeline();
                    generateWidgets();
                    closeEventModal();
                    
                    const successMessage = currentEditingEventIndex !== null 
                        ? 'Đã cập nhật sự kiện thành công!' 
                        : 'Đã thêm sự kiện mới thành công!';
                    showNotification(successMessage, 'success');
                    
                } catch (error) {
                    console.error('Lỗi lưu sự kiện:', error);
                    logActivity('Lỗi lưu sự kiện', error.message);
                    showNotification('Lỗi khi lưu sự kiện!', 'error');
                }
            });

            // Handle profile form submission
            document.getElementById('profile-form').addEventListener('submit', saveProfile);
        });

        // Google Drive API functions
        async function syncPhotosFromGoogleDrive() {
            try {
                logActivity('Đồng bộ Google Drive', 'Bắt đầu tải danh sách ảnh từ Google Drive');
                
                let allPhotos = [];
                let nextPageToken = null;
                let pageCount = 0;
                const maxPages = 50; // Giới hạn tối đa 50 trang để tránh vòng lặp vô hạn
                
                do {
                    pageCount++;
                    logActivity('Đồng bộ Google Drive', `Đang tải trang ${pageCount}...`);
                    
                    let url = `https://www.googleapis.com/drive/v3/files?q='${CONFIG.FOLDER_ID}'+in+parents+and+mimeType+contains+'image/'&fields=nextPageToken,files(id,name,webViewLink,thumbnailLink,createdTime,modifiedTime,size,mimeType,description)&pageSize=1000&key=${CONFIG.API_KEY}`;
                    
                    if (nextPageToken) {
                        url += `&pageToken=${nextPageToken}`;
                    }
                    
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`Google Drive API error: ${response.status} - ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.files && data.files.length > 0) {
                        const pagePhotos = data.files.map(file => ({
                            id: file.id,
                            name: file.name,
                            webViewLink: file.webViewLink,
                            thumbnailLink: file.thumbnailLink,
                            createdTime: file.createdTime,
                            modifiedTime: file.modifiedTime,
                            size: file.size ? parseInt(file.size) : 0,
                            mimeType: file.mimeType,
                            description: file.description || `Ảnh kỷ niệm - ${file.name}`,
                            source: "google-drive",
                            folderId: CONFIG.FOLDER_ID,
                            loadedAt: new Date().toISOString(),
                            pageNumber: pageCount
                        }));
                        
                        allPhotos = allPhotos.concat(pagePhotos);
                        logActivity('Đồng bộ Google Drive', `Trang ${pageCount}: Đã tải ${pagePhotos.length} ảnh (Tổng: ${allPhotos.length})`);
                    }
                    
                    nextPageToken = data.nextPageToken;
                    
                    // Thêm delay nhỏ giữa các request để tránh rate limiting
                    if (nextPageToken && pageCount < maxPages) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                    
                } while (nextPageToken && pageCount < maxPages);
                
                if (pageCount >= maxPages) {
                    logActivity('Đồng bộ Google Drive', `Cảnh báo: Đã đạt giới hạn ${maxPages} trang. Có thể còn ảnh chưa được tải.`);
                }
                
                // Sắp xếp theo thời gian tạo (mới nhất trước)
                allPhotos.sort((a, b) => new Date(b.createdTime) - new Date(a.createdTime));
                
                // Save to GitHub
                await saveToGitHub(CONFIG.PHOTOS_METADATA_FILE_PATH, allPhotos, `Đồng bộ ${allPhotos.length} ảnh từ Google Drive (${pageCount} trang)`);
                
                // Update local data
                photosData = allPhotos;
                
                logActivity('Đồng bộ Google Drive', `Hoàn thành đồng bộ ${allPhotos.length} ảnh từ ${pageCount} trang`);
                return allPhotos;
                
            } catch (error) {
                logActivity('Lỗi đồng bộ Google Drive', error.message);
                throw error;
            }
        }

        // Auto sync function
        function setupAutoSync() {
            // Clear existing interval
            if (syncInterval) {
                clearInterval(syncInterval);
                clearTimeout(syncInterval);
            }
            
            if (!appConfig.AUTO_SYNC_METADATA.enabled) {
                return;
            }
            
            const frequency = appConfig.AUTO_SYNC_METADATA.frequency;
            const time = appConfig.AUTO_SYNC_METADATA.time;
            
            if (frequency === 'once') {
                // Run once at specified time today or tomorrow
                scheduleOnceSync(time);
            } else if (frequency === 'daily') {
                scheduleDailySync(time);
            } else if (frequency === 'monthly') {
                scheduleMonthlySync(time);
            }
        }

        function scheduleOnceSync(time) {
            const now = new Date();
            const [hours, minutes] = time.split(':');
            const syncTime = new Date();
            syncTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);
            
            if (syncTime <= now) {
                syncTime.setDate(syncTime.getDate() + 1);
            }
            
            const timeUntilSync = syncTime.getTime() - now.getTime();
            
            syncInterval = setTimeout(() => {
                autoSyncData();
            }, timeUntilSync);
        }

        function scheduleDailySync(time) {
            const now = new Date();
            const [hours, minutes] = time.split(':');
            const syncTime = new Date();
            syncTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);
            
            if (syncTime <= now) {
                syncTime.setDate(syncTime.getDate() + 1);
            }
            
            const timeUntilSync = syncTime.getTime() - now.getTime();
            
            syncInterval = setTimeout(() => {
                autoSyncData();
                syncInterval = setInterval(autoSyncData, 24 * 60 * 60 * 1000); // Daily
            }, timeUntilSync);
        }

        function scheduleMonthlySync(time) {
            const now = new Date();
            const [hours, minutes] = time.split(':');
            const syncTime = new Date();
            syncTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);
            
            // Set to first day of next month
            syncTime.setMonth(syncTime.getMonth() + 1, 1);
            
            if (syncTime <= now) {
                syncTime.setMonth(syncTime.getMonth() + 1, 1);
            }
            
            const timeUntilSync = syncTime.getTime() - now.getTime();
            
            syncInterval = setTimeout(() => {
                autoSyncData();
                syncInterval = setInterval(autoSyncData, 30 * 24 * 60 * 60 * 1000); // Monthly (approximate)
            }, timeUntilSync);
        }

        async function autoSyncData() {
            if (!appConfig.AUTO_SYNC_METADATA.enabled) return;
            
            console.log('Đang đồng bộ dữ liệu tự động...');
            logActivity('Đồng bộ tự động', 'Bắt đầu đồng bộ dữ liệu theo lịch trình');
            
            try {
                await syncPhotosFromGoogleDrive();
                generatePhotos();
                
                settings.lastSyncTime = new Date().toISOString();
                updateLastSyncTime();
                saveSettings();
                
                logActivity('Đồng bộ tự động', 'Đồng bộ dữ liệu thành công');
                console.log('Đồng bộ dữ liệu thành công!');
            } catch (error) {
                logActivity('Lỗi đồng bộ tự động', error.message);
                console.error('Lỗi đồng bộ dữ liệu:', error);
            }
        }

        // Image selector functions
        function openImageSelector() {
            if (photosData.length === 0) {
                showNotification('Chưa có ảnh nào để chọn', 'warning');
                return;
            }
            
            currentImageSelectorPage = 1;
            generateImageSelectorGrid();
            document.getElementById('image-selector-modal').classList.add('active');
            
            logActivity('Mở chọn ảnh', 'Mở modal chọn ảnh cho sự kiện');
        }

        function closeImageSelector() {
            updateImageDisplay();
            document.getElementById('image-selector-modal').classList.remove('active');
            
            logActivity('Chọn ảnh sự kiện', `Đã chọn ${selectedImageIds.length} ảnh cho sự kiện`);
            if (selectedImageIds.length > 0) {
                showNotification(`Đã chọn ${selectedImageIds.length} ảnh`, 'success');
            }
        }

        function generateImageSelectorGrid() {
            const container = document.getElementById('image-selector-grid');
            
            if (photosData.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">Không có ảnh nào để hiển thị</div>';
                return;
            }
            
            const startIndex = (currentImageSelectorPage - 1) * CONFIG.PHOTOS_PER_PAGE;
            const endIndex = startIndex + CONFIG.PHOTOS_PER_PAGE;
            const pagePhotos = photosData.slice(startIndex, endIndex);
            
            container.innerHTML = '';
            renderAllImageSelectorPhotos(pagePhotos, container);
            generateImageSelectorPagination();
            updateImageSelectorCount();
        }

        function renderAllImageSelectorPhotos(photos, container) {
            // Tối ưu hóa: Tạo chuỗi HTML hoàn chỉnh trước khi cập nhật DOM
            let selectorPhotosHtml = '';
            
            photos.forEach(photo => {
                const isSelected = selectedImageIds.includes(photo.id);
                const thumbnailUrl = `https://drive.google.com/thumbnail?id=${photo.id}&sz=w300-h300`;
                const fallbackUrl = `https://lh3.googleusercontent.com/d/${photo.id}=w300-h300`;
                
                // Cộng chuỗi HTML thay vì tạo DOM element
                selectorPhotosHtml += `
                    <div class="relative cursor-pointer rounded-lg overflow-hidden border-2 transition-all ${
                        isSelected ? 'border-primary-100 bg-primary-10' : 'border-gray-200 hover:border-gray-300'
                    }" onclick="toggleImageSelection('${photo.id}')">
                        <img src="${thumbnailUrl}" alt="${photo.name}" class="w-full h-32 object-cover" 
                             onerror="this.src='${fallbackUrl}'; this.onerror=null;">
                        <div class="absolute top-2 right-2">
                            <div class="w-6 h-6 rounded-full border-2 ${
                                isSelected 
                                    ? 'bg-primary-100 border-primary-100' 
                                    : 'bg-white border-gray-300'
                            } flex items-center justify-center">
                                ${isSelected ? '<i class="fas fa-check text-white text-xs"></i>' : ''}
                            </div>
                        </div>
                        <div class="p-2 bg-white">
                            <div class="text-xs text-gray-600 truncate" title="${photo.name}">${photo.name}</div>
                        </div>
                    </div>
                `;
            });
            
            // Chỉ cập nhật DOM một lần duy nhất
            container.innerHTML = selectorPhotosHtml;
        }

        function generateImageSelectorPagination() {
            const totalPhotos = photosData.length;
            const totalPages = Math.ceil(totalPhotos / CONFIG.PHOTOS_PER_PAGE);
            const pagination = document.getElementById('image-selector-pagination');
            
            pagination.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            const paginationControls = document.createElement('div');
            paginationControls.className = 'flex justify-center space-x-2';
            
            // Previous button
            if (currentImageSelectorPage > 1) {
                const prevBtn = document.createElement('button');
                prevBtn.className = 'px-2 py-1 rounded-lg bg-primary-100 text-white hover:bg-primary-80 transition-colors text-sm';
                prevBtn.innerHTML = '<i class="fas fa-chevron-left mr-1 text-xs"></i>Trước';
                prevBtn.onclick = () => changeImageSelectorPage(currentImageSelectorPage - 1);
                paginationControls.appendChild(prevBtn);
            }
            
            // First page
            if (currentImageSelectorPage > 3) {
                const firstBtn = document.createElement('button');
                firstBtn.className = 'px-2 py-1 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors text-sm';
                firstBtn.textContent = '1';
                firstBtn.onclick = () => changeImageSelectorPage(1);
                paginationControls.appendChild(firstBtn);
                
                if (currentImageSelectorPage > 4) {
                    const dots = document.createElement('span');
                    dots.className = 'px-1 py-1 text-gray-500 text-sm';
                    dots.textContent = '...';
                    paginationControls.appendChild(dots);
                }
            }
            
            // Page numbers around current page
            const startPage = Math.max(1, currentImageSelectorPage - 2);
            const endPage = Math.min(totalPages, currentImageSelectorPage + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `px-2 py-1 rounded-lg transition-colors text-sm ${
                    i === currentImageSelectorPage 
                        ? 'bg-primary-100 text-white font-semibold' 
                        : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                }`;
                pageBtn.textContent = i;
                pageBtn.onclick = () => changeImageSelectorPage(i);
                paginationControls.appendChild(pageBtn);
            }
            
            // Last page
            if (currentImageSelectorPage < totalPages - 2) {
                if (currentImageSelectorPage < totalPages - 3) {
                    const dots = document.createElement('span');
                    dots.className = 'px-1 py-1 text-gray-500 text-sm';
                    dots.textContent = '...';
                    paginationControls.appendChild(dots);
                }
                
                const lastBtn = document.createElement('button');
                lastBtn.className = 'px-2 py-1 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors text-sm';
                lastBtn.textContent = totalPages;
                lastBtn.onclick = () => changeImageSelectorPage(totalPages);
                paginationControls.appendChild(lastBtn);
            }
            
            // Next button
            if (currentImageSelectorPage < totalPages) {
                const nextBtn = document.createElement('button');
                nextBtn.className = 'px-2 py-1 rounded-lg bg-primary-100 text-white hover:bg-primary-80 transition-colors text-sm';
                nextBtn.innerHTML = 'Sau<i class="fas fa-chevron-right ml-1 text-xs"></i>';
                nextBtn.onclick = () => changeImageSelectorPage(currentImageSelectorPage + 1);
                paginationControls.appendChild(nextBtn);
            }
            
            pagination.appendChild(paginationControls);
        }

        function changeImageSelectorPage(page) {
            currentImageSelectorPage = page;
            generateImageSelectorGrid();
        }

        function toggleImageSelection(imageId) {
            const index = selectedImageIds.indexOf(imageId);
            if (index > -1) {
                selectedImageIds.splice(index, 1);
            } else {
                selectedImageIds.push(imageId);
            }
            
            generateImageSelectorGrid();
            updateImageDisplay();
        }

        function selectAllImages() {
            // Chọn tất cả ảnh trên trang hiện tại
            const startIndex = (currentImageSelectorPage - 1) * CONFIG.PHOTOS_PER_PAGE;
            const endIndex = startIndex + CONFIG.PHOTOS_PER_PAGE;
            const pagePhotos = photosData.slice(startIndex, endIndex);
            
            let addedCount = 0;
            pagePhotos.forEach(photo => {
                if (!selectedImageIds.includes(photo.id)) {
                    selectedImageIds.push(photo.id);
                    addedCount++;
                }
            });
            
            generateImageSelectorGrid();
            updateImageDisplay();
            
            if (addedCount > 0) {
                showNotification(`Đã chọn thêm ${addedCount} ảnh trên trang này`, 'success');
                logActivity('Chọn ảnh', `Chọn ${addedCount} ảnh trên trang ${currentImageSelectorPage}`);
            } else {
                showNotification('Tất cả ảnh trên trang này đã được chọn', 'info');
            }
        }

        function deselectAllImages() {
            // Bỏ chọn tất cả ảnh trên trang hiện tại
            const startIndex = (currentImageSelectorPage - 1) * CONFIG.PHOTOS_PER_PAGE;
            const endIndex = startIndex + CONFIG.PHOTOS_PER_PAGE;
            const pagePhotos = photosData.slice(startIndex, endIndex);
            
            let removedCount = 0;
            pagePhotos.forEach(photo => {
                const index = selectedImageIds.indexOf(photo.id);
                if (index > -1) {
                    selectedImageIds.splice(index, 1);
                    removedCount++;
                }
            });
            
            generateImageSelectorGrid();
            updateImageDisplay();
            
            if (removedCount > 0) {
                showNotification(`Đã bỏ chọn ${removedCount} ảnh trên trang này`, 'success');
                logActivity('Bỏ chọn ảnh', `Bỏ chọn ${removedCount} ảnh trên trang ${currentImageSelectorPage}`);
            } else {
                showNotification('Không có ảnh nào được chọn trên trang này', 'info');
            }
        }

        function selectAllPagesImages() {
            let addedCount = 0;
            
            photosData.forEach(photo => {
                if (!selectedImageIds.includes(photo.id)) {
                    selectedImageIds.push(photo.id);
                    addedCount++;
                }
            });
            
            generateImageSelectorGrid();
            updateImageDisplay();
            
            if (addedCount > 0) {
                showNotification(`Đã chọn thêm ${addedCount} ảnh từ tất cả các trang`, 'success');
                logActivity('Chọn ảnh', `Chọn tất cả ${addedCount} ảnh từ ${Math.ceil(photosData.length / CONFIG.PHOTOS_PER_PAGE)} trang`);
            } else {
                showNotification('Tất cả ảnh đã được chọn', 'info');
            }
        }

        function deselectAllPagesImages() {
            // Bỏ chọn tất cả ảnh
            const removedCount = selectedImageIds.length;
            selectedImageIds = [];
            
            generateImageSelectorGrid();
            updateImageDisplay();
            
            if (removedCount > 0) {
                showNotification(`Đã bỏ chọn tất cả ${removedCount} ảnh`, 'success');
                logActivity('Bỏ chọn ảnh', `Bỏ chọn tất cả ${removedCount} ảnh`);
            } else {
                showNotification('Không có ảnh nào được chọn', 'info');
            }
        }

        function updateImageSelectorCount() {
            document.getElementById('modal-selected-count').textContent = selectedImageIds.length;
        }

        function updateImageDisplay() {
            const displayInput = document.getElementById('event-images-display');
            const countSpan = document.getElementById('selected-images-count');
            
            countSpan.textContent = selectedImageIds.length;
            
            if (selectedImageIds.length === 0) {
                displayInput.value = '';
                displayInput.placeholder = 'Chưa chọn ảnh nào...';
            } else if (selectedImageIds.length === 1) {
                const photo = photosData.find(p => p.id === selectedImageIds[0]);
                displayInput.value = photo ? photo.name : selectedImageIds[0];
            } else {
                displayInput.value = `${selectedImageIds.length} ảnh đã được chọn`;
            }
        }



        // User Management Functions
        async function loadProfilesData() {
            try {
                const data = await fetchFromGitHub(CONFIG.PROFILES_FILE_PATH);
                if (data) {
                    // Expect array format: [{username, name, avatarUrl}, ...]
                    if (Array.isArray(data)) {
                        profilesData = data.map(profile => ({
                            deviceId: profile.username, // Use username as deviceId
                            username: profile.username,
                            fullName: profile.name,
                            avatar: profile.avatarUrl,
                            isAnonymous: false,
                            createdAt: profile.createdAt || new Date().toISOString(),
                            lastLoginAt: profile.lastLoginAt || new Date().toISOString(),
                            commentsCount: profile.commentsCount || 0,
                            likesCount: profile.likesCount || 0
                        }));
                    } else {
                        // Convert from old object format to new array format
                        profilesData = Object.keys(data).map(userId => ({
                            deviceId: userId,
                            username: userId,
                            fullName: data[userId].name,
                            avatar: data[userId].avatarUrl,
                            isAnonymous: false,
                            createdAt: new Date().toISOString(),
                            lastLoginAt: new Date().toISOString(),
                            commentsCount: 0,
                            likesCount: 0
                        }));
                    }
                } else {
                    profilesData = [];
                }
            } catch (error) {
                console.error('Lỗi tải profiles:', error);
                profilesData = [];
            }
        }

        function generateDeviceFingerprint() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillText('Device fingerprint', 2, 2);
            
            const fingerprint = [
                navigator.userAgent,
                navigator.language,
                screen.width + 'x' + screen.height,
                new Date().getTimezoneOffset(),
                canvas.toDataURL()
            ].join('|');
            
            // Simple hash function
            let hash = 0;
            for (let i = 0; i < fingerprint.length; i++) {
                const char = fingerprint.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32-bit integer
            }
            return Math.abs(hash).toString(36);
        }

        function generateAnonymousName() {
            const animals = ['Chó', 'Mèo', 'Gấu', 'Thỏ', 'Cáo', 'Sói', 'Hổ', 'Sư tử', 'Voi', 'Ngựa', 'Bò', 'Heo', 'Gà', 'Vịt', 'Cá', 'Chim'];
            const colors = ['Đỏ', 'Xanh', 'Vàng', 'Tím', 'Hồng', 'Cam', 'Nâu', 'Xám', 'Đen', 'Trắng', 'Bạc', 'Vàng kim', 'Xanh lá', 'Xanh dương'];
            
            const animal = animals[Math.floor(Math.random() * animals.length)];
            const color = colors[Math.floor(Math.random() * colors.length)];
            
            return `${animal} ${color}`;
        }

        function initializeUser() {
            const deviceId = generateDeviceFingerprint();
            const savedUser = localStorage.getItem('loveStoryCurrentUser');
            
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    // Verify user still exists in profiles
                    const existingProfile = profilesData.find(p => 
                        (p.deviceId === deviceId && p.username === currentUser.username) ||
                        p.deviceId === currentUser.username ||
                        p.username === currentUser.username
                    );
                    if (existingProfile) {
                        currentUser = existingProfile;
                        currentUser.lastLoginAt = new Date().toISOString();
                        localStorage.setItem('loveStoryCurrentUser', JSON.stringify(currentUser));
                        updateHeaderProfile();
                        logActivity('Đăng nhập tự động', `Người dùng ${currentUser.fullName} đã đăng nhập tự động`);
                    } else {
                        // User not found, create anonymous
                        createAnonymousUser(deviceId);
                    }
                } catch (error) {
                    console.error('Lỗi parse user data:', error);
                    createAnonymousUser(deviceId);
                }
            } else {
                // Check if there's an existing profile for this device
                const existingProfile = profilesData.find(p => p.deviceId === deviceId);
                if (existingProfile) {
                    currentUser = existingProfile;
                    currentUser.lastLoginAt = new Date().toISOString();
                    localStorage.setItem('loveStoryCurrentUser', JSON.stringify(currentUser));
                    updateHeaderProfile();
                    logActivity('Đăng nhập tự động', `Người dùng ${currentUser.fullName} đã đăng nhập tự động từ profiles`);
                } else {
                    createAnonymousUser(deviceId);
                }
            }
        }

        function createAnonymousUser(deviceId) {
            const anonymousName = generateAnonymousName();
            currentUser = {
                deviceId: deviceId,
                username: anonymousName.toLowerCase().replace(/\s+/g, ''),
                fullName: anonymousName,
                avatar: null,
                isAnonymous: true,
                createdAt: new Date().toISOString(),
                lastLoginAt: new Date().toISOString(),
                commentsCount: 0,
                likesCount: 0
            };
            
            localStorage.setItem('loveStoryCurrentUser', JSON.stringify(currentUser));
            updateHeaderProfile();
            
            logActivity('Tạo user ẩn danh', `Đã tạo user ẩn danh: ${currentUser.fullName}`);
        }

        function updateHeaderProfile() {
            const headerUsername = document.getElementById('header-username');
            const headerAvatar = document.getElementById('header-avatar');
            const headerAvatarIcon = document.getElementById('header-avatar-icon');
            
            if (currentUser) {
                headerUsername.textContent = currentUser.fullName;
                
                if (currentUser.avatar) {
                    headerAvatar.src = currentUser.avatar;
                    headerAvatar.classList.remove('hidden');
                    headerAvatarIcon.classList.add('hidden');
                } else {
                    headerAvatar.classList.add('hidden');
                    headerAvatarIcon.classList.remove('hidden');
                }
            }
        }

        function openProfileModal() {
            if (currentUser) {
                document.getElementById('profile-username').value = currentUser.username || '';
                document.getElementById('profile-fullname').value = currentUser.fullName || '';
                
                if (currentUser.avatar) {
                    document.getElementById('profile-avatar-preview').src = currentUser.avatar;
                    document.getElementById('profile-avatar-preview').classList.remove('hidden');
                    document.getElementById('profile-avatar-placeholder').classList.add('hidden');
                } else {
                    document.getElementById('profile-avatar-preview').classList.add('hidden');
                    document.getElementById('profile-avatar-placeholder').classList.remove('hidden');
                }
                
                // Show current user info if not anonymous
                if (!currentUser.isAnonymous) {
                    document.getElementById('current-user-info').classList.remove('hidden');
                    document.getElementById('last-login-time').textContent = new Date(currentUser.lastLoginAt).toLocaleString('vi-VN');
                } else {
                    document.getElementById('current-user-info').classList.add('hidden');
                }
            }
            
            document.getElementById('profile-modal').classList.add('active');
            logActivity('Mở hồ sơ', 'Mở modal hồ sơ cá nhân');
        }

        function closeProfileModal() {
            document.getElementById('profile-modal').classList.remove('active');
            document.getElementById('username-status').classList.add('hidden');
        }

        function selectAvatar() {
            document.getElementById('avatar-input').click();
        }

        function handleAvatarChange(event) {
            const file = event.target.files[0];
            if (file) {
                // Check if it's an image
                if (!file.type.startsWith('image/')) {
                    showNotification('Vui lòng chọn file ảnh hợp lệ!', 'warning');
                    return;
                }
                
                // Show loading state
                const avatarPreview = document.getElementById('profile-avatar-preview');
                const avatarPlaceholder = document.getElementById('profile-avatar-placeholder');
                
                avatarPlaceholder.innerHTML = '<i class="fas fa-spinner fa-spin text-2xl text-gray-400"></i>';
                
                // Process image (resize if needed)
                processAvatarImage(file).then(processedImageData => {
                    avatarPreview.src = processedImageData;
                    avatarPreview.classList.remove('hidden');
                    avatarPlaceholder.classList.add('hidden');
                    
                    // Calculate and show final size
                    const finalSize = Math.round((processedImageData.length * 0.75) / 1024); // Approximate KB
                    showNotification(`Ảnh đã được tối ưu hóa (${finalSize}KB)`, 'success');
                    
                }).catch(error => {
                    console.error('Lỗi xử lý ảnh:', error);
                    showNotification('Lỗi khi xử lý ảnh! Vui lòng thử lại.', 'error');
                    
                    // Reset placeholder
                    avatarPlaceholder.innerHTML = '<i class="fas fa-user text-4xl text-gray-400"></i>';
                });
            }
        }

        async function processAvatarImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const img = new Image();
                    
                    img.onload = function() {
                        try {
                            // Create canvas for resizing
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            
                            // Calculate optimal size (max 400x400, maintain aspect ratio)
                            const maxSize = 400;
                            let { width, height } = calculateOptimalSize(img.width, img.height, maxSize);
                            
                            // Set canvas size
                            canvas.width = width;
                            canvas.height = height;
                            
                            // Enable image smoothing for better quality
                            ctx.imageSmoothingEnabled = true;
                            ctx.imageSmoothingQuality = 'high';
                            
                            // Draw resized image
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            // Convert to optimized format
                            let quality = 0.8; // Start with 80% quality
                            let imageData = canvas.toDataURL('image/jpeg', quality);
                            
                            // If still too large (>500KB), reduce quality further
                            const maxSizeBytes = 500 * 1024; // 500KB
                            let iterations = 0;
                            const maxIterations = 5;
                            
                            while (imageData.length > maxSizeBytes && quality > 0.3 && iterations < maxIterations) {
                                quality -= 0.1;
                                imageData = canvas.toDataURL('image/jpeg', quality);
                                iterations++;
                            }
                            
                            // If still too large, resize further
                            if (imageData.length > maxSizeBytes && width > 200) {
                                const scaleFactor = 0.8;
                                width = Math.floor(width * scaleFactor);
                                height = Math.floor(height * scaleFactor);
                                
                                canvas.width = width;
                                canvas.height = height;
                                ctx.drawImage(img, 0, 0, width, height);
                                imageData = canvas.toDataURL('image/jpeg', 0.7);
                            }
                            
                            // Log compression results
                            const originalSize = Math.round(file.size / 1024);
                            const finalSize = Math.round((imageData.length * 0.75) / 1024);
                            const compressionRatio = Math.round((1 - finalSize / originalSize) * 100);
                            
                            console.log(`📸 Avatar processed: ${originalSize}KB → ${finalSize}KB (${compressionRatio}% compression)`);
                            logActivity('Xử lý avatar', `Tối ưu hóa ảnh: ${originalSize}KB → ${finalSize}KB (giảm ${compressionRatio}%)`);
                            
                            resolve(imageData);
                            
                        } catch (error) {
                            reject(error);
                        }
                    };
                    
                    img.onerror = function() {
                        reject(new Error('Không thể tải ảnh'));
                    };
                    
                    img.src = e.target.result;
                };
                
                reader.onerror = function() {
                    reject(new Error('Không thể đọc file'));
                };
                
                reader.readAsDataURL(file);
            });
        }

        function calculateOptimalSize(originalWidth, originalHeight, maxSize) {
            let width = originalWidth;
            let height = originalHeight;
            
            // If image is larger than maxSize, scale it down
            if (width > maxSize || height > maxSize) {
                const aspectRatio = width / height;
                
                if (width > height) {
                    width = maxSize;
                    height = Math.round(maxSize / aspectRatio);
                } else {
                    height = maxSize;
                    width = Math.round(maxSize * aspectRatio);
                }
            }
            
            // Ensure minimum size (at least 100x100)
            const minSize = 100;
            if (width < minSize && height < minSize) {
                const aspectRatio = width / height;
                
                if (width > height) {
                    width = minSize;
                    height = Math.round(minSize / aspectRatio);
                } else {
                    height = minSize;
                    width = Math.round(minSize * aspectRatio);
                }
            }
            
            return { width, height };
        }

        function validateAndCheckUsername(username) {
            const statusDiv = document.getElementById('username-status');
            const usernameInput = document.getElementById('profile-username');
            
            if (!username.trim()) {
                statusDiv.classList.add('hidden');
                return;
            }
            
            // Validate username format: only letters, numbers, underscore
            const validUsernameRegex = /^[a-zA-Z0-9_]+$/;
            
            if (!validUsernameRegex.test(username)) {
                // Remove invalid characters
                const cleanUsername = username.replace(/[^a-zA-Z0-9_]/g, '');
                usernameInput.value = cleanUsername;
                
                statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle text-orange-500 mr-1"></i>Chỉ được sử dụng chữ cái không dấu, số và dấu gạch dưới';
                statusDiv.className = 'mt-1 text-sm text-orange-600';
                statusDiv.classList.remove('hidden');
                return;
            }
            
            // Check if username exists
            const existingProfile = profilesData.find(p => 
                p.username.toLowerCase() === username.toLowerCase()
            );
            
            if (existingProfile) {
                statusDiv.innerHTML = '<i class="fas fa-check text-green-500 mr-1"></i>Tìm thấy hồ sơ người dùng';
                statusDiv.className = 'mt-1 text-sm text-green-600';
                statusDiv.classList.remove('hidden');
            } else {
                statusDiv.innerHTML = '<i class="fas fa-info text-blue-500 mr-1"></i>Tên đăng nhập mới';
                statusDiv.className = 'mt-1 text-sm text-blue-600';
                statusDiv.classList.remove('hidden');
            }
        }

        function loadUserProfile(username) {
            if (!username.trim()) return;
            
            const existingProfile = profilesData.find(p => 
                p.username.toLowerCase() === username.toLowerCase()
            );
            
            if (existingProfile) {
                // Auto-fill form with existing profile data
                document.getElementById('profile-fullname').value = existingProfile.fullName || '';
                
                if (existingProfile.avatar) {
                    document.getElementById('profile-avatar-preview').src = existingProfile.avatar;
                    document.getElementById('profile-avatar-preview').classList.remove('hidden');
                    document.getElementById('profile-avatar-placeholder').classList.add('hidden');
                } else {
                    document.getElementById('profile-avatar-preview').classList.add('hidden');
                    document.getElementById('profile-avatar-placeholder').classList.remove('hidden');
                }
                
                logActivity('Tải hồ sơ', `Đã tải hồ sơ cho tên đăng nhập: ${username}`);
            } else {
                // Clear form for new user
                document.getElementById('profile-fullname').value = '';
                document.getElementById('profile-avatar-preview').classList.add('hidden');
                document.getElementById('profile-avatar-placeholder').classList.remove('hidden');
            }
        }

        function updateDeviceInfo() {
            const deviceInfo = document.getElementById('device-info');
            const browserInfo = document.getElementById('browser-info');
            
            // Get device type
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const deviceType = isMobile ? 'Di động' : 'Máy tính';
            const platform = navigator.platform || 'Không xác định';
            
            deviceInfo.textContent = `${deviceType} (${platform})`;
            
            // Get browser info
            const userAgent = navigator.userAgent;
            let browserName = 'Không xác định';
            
            if (userAgent.includes('Chrome')) browserName = 'Chrome';
            else if (userAgent.includes('Firefox')) browserName = 'Firefox';
            else if (userAgent.includes('Safari')) browserName = 'Safari';
            else if (userAgent.includes('Edge')) browserName = 'Edge';
            else if (userAgent.includes('Opera')) browserName = 'Opera';
            
            browserInfo.textContent = `${browserName} (${navigator.language})`;
        }

        async function saveProfile(event) {
            event.preventDefault();
            
            const username = document.getElementById('profile-username').value.trim();
            const fullName = document.getElementById('profile-fullname').value.trim();
            const avatarPreview = document.getElementById('profile-avatar-preview');
            const avatar = avatarPreview.classList.contains('hidden') ? null : avatarPreview.src;
            
            if (!username || !fullName) {
                showNotification('Vui lòng nhập đầy đủ thông tin!', 'warning');
                return;
            }
            
            // Validate username format
            const validUsernameRegex = /^[a-zA-Z0-9_]+$/;
            if (!validUsernameRegex.test(username)) {
                showNotification('Tên đăng nhập chỉ được chứa chữ cái không dấu, số và dấu gạch dưới!', 'warning');
                return;
            }
            
            const deviceId = generateDeviceFingerprint();
            
            try {
                const button = document.getElementById('save-profile-btn');
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Đang lưu...';
                button.disabled = true;
                
                console.log('🔄 Bắt đầu lưu hồ sơ...');
                
                // Tải lại dữ liệu profiles mới nhất từ GitHub trước khi lưu
                console.log('📥 Đang tải dữ liệu profiles mới nhất từ GitHub...');
                await loadProfilesData();
                
                console.log('📊 Dữ liệu profiles hiện tại:', profilesData);
                
                // Tìm profile hiện tại theo username
                const existingProfileIndex = profilesData.findIndex(p => 
                    p.username && p.username.toLowerCase() === username.toLowerCase()
                );
                
                console.log('🔍 Tìm kiếm profile:', { username, existingProfileIndex });
                
                const profileData = {
                    deviceId: deviceId,
                    username: username,
                    fullName: fullName,
                    avatar: avatar,
                    isAnonymous: false,
                    createdAt: currentUser?.createdAt || new Date().toISOString(),
                    lastLoginAt: new Date().toISOString(),
                    commentsCount: currentUser?.commentsCount || 0,
                    likesCount: currentUser?.likesCount || 0
                };
                
                if (existingProfileIndex !== -1) {
                    // Cập nhật profile hiện có - giữ nguyên thống kê
                    const existingProfile = profilesData[existingProfileIndex];
                    profilesData[existingProfileIndex] = {
                        ...profileData,
                        // Giữ nguyên các thống kê và thời gian tạo từ profile cũ
                        commentsCount: existingProfile.commentsCount || 0,
                        likesCount: existingProfile.likesCount || 0,
                        createdAt: existingProfile.createdAt || profileData.createdAt
                    };
                    console.log('✏️ Cập nhật profile hiện có:', username, profilesData[existingProfileIndex]);
                } else {
                    // Thêm profile mới vào mảng
                    profilesData.push(profileData);
                    console.log('➕ Thêm profile mới:', username, profileData);
                }
                
                // Chuyển đổi sang định dạng mảng chuẩn để lưu vào GitHub
                const profilesArray = profilesData.map(profile => ({
                    username: profile.username,
                    name: profile.fullName,
                    avatarUrl: profile.avatar || null,
                    createdAt: profile.createdAt,
                    lastLoginAt: profile.lastLoginAt,
                    commentsCount: profile.commentsCount || 0,
                    likesCount: profile.likesCount || 0
                }));
                
                console.log('💾 Chuẩn bị lưu vào GitHub - Định dạng mảng:', profilesArray);
                console.log('📝 Số lượng profiles:', profilesArray.length);
                
                // Lưu vào GitHub với định dạng mảng chuẩn
                const commitMessage = `Cập nhật hồ sơ: ${fullName} (${username}) - ${existingProfileIndex !== -1 ? 'Sửa' : 'Thêm mới'}`;
                console.log('🚀 Đang gửi lên GitHub với message:', commitMessage);
                
                const saveResult = await saveToGitHub(CONFIG.PROFILES_FILE_PATH, profilesArray, commitMessage);
                
                console.log('✅ Kết quả lưu GitHub:', saveResult);
                
                // Cập nhật currentUser
                currentUser = profileData;
                localStorage.setItem('loveStoryCurrentUser', JSON.stringify(currentUser));
                
                // Cập nhật giao diện
                updateHeaderProfile();
                closeProfileModal();
                
                const actionText = existingProfileIndex !== -1 ? 'cập nhật' : 'tạo mới';
                const successMessage = `Đã ${actionText} hồ sơ thành công!`;
                
                logActivity('Lưu hồ sơ', `${successMessage} - ${fullName} (${username}) - Tổng: ${profilesArray.length} profiles`);
                showNotification(successMessage, 'success');
                
                console.log('🎉 Hoàn thành lưu hồ sơ thành công!');
                
            } catch (error) {
                console.error('❌ Lỗi chi tiết khi lưu hồ sơ:', error);
                console.error('❌ Stack trace:', error.stack);
                
                const errorMessage = error.message || 'Lỗi không xác định';
                logActivity('Lỗi lưu hồ sơ', `${errorMessage} - Username: ${username}`);
                showNotification(`Lỗi khi lưu hồ sơ: ${errorMessage}`, 'error');
            } finally {
                const button = document.getElementById('save-profile-btn');
                button.innerHTML = '<i class="fas fa-save mr-2"></i>Lưu hồ sơ';
                button.disabled = false;
            }
        }

        function logoutUser() {
            if (confirm('Bạn có chắc chắn muốn đăng xuất? Bạn sẽ trở thành người dùng ẩn danh.')) {
                logActivity('Đăng xuất', `Người dùng ${currentUser.fullName} đã đăng xuất`);
                
                // Reset form fields
                document.getElementById('profile-username').value = '';
                document.getElementById('profile-fullname').value = '';
                document.getElementById('profile-avatar-preview').classList.add('hidden');
                document.getElementById('profile-avatar-placeholder').classList.remove('hidden');
                document.getElementById('username-status').classList.add('hidden');
                document.getElementById('current-user-info').classList.add('hidden');
                
                // Clear avatar input
                document.getElementById('avatar-input').value = '';
                
                localStorage.removeItem('loveStoryCurrentUser');
                const deviceId = generateDeviceFingerprint();
                createAnonymousUser(deviceId);
                closeProfileModal();
                
                showNotification('Đã đăng xuất thành công!', 'success');
            }
        }

        // Theme Management Functions
        function initializeTheme() {
            try {
                // Đảm bảo luôn có theme mặc định
                currentTheme = 'default';
                
                // Thử load theme đã lưu
                try {
                    const savedTheme = localStorage.getItem('loveStoryTheme');
                    if (savedTheme && availableThemes[savedTheme]) {
                        currentTheme = savedTheme;
                    }
                } catch (error) {
                    console.warn('Không thể load theme đã lưu, sử dụng theme mặc định');
                }
                
                // Áp dụng theme ngay lập tức
                applyTheme(currentTheme);
                
                console.log(`✅ Đã khởi tạo theme: ${currentTheme}`);
                
            } catch (error) {
                console.error('❌ Lỗi khởi tạo theme:', error);
                
                // Fallback cuối cùng
                try {
                    document.documentElement.className = 'theme-default';
                    currentTheme = 'default';
                } catch (fallbackError) {
                    console.error('❌ Lỗi fallback theme:', fallbackError);
                }
            }
        }

        function generateThemeOptions() {
            const container = document.getElementById('theme-options-settings');
            container.innerHTML = '';
            
            Object.keys(availableThemes).forEach(themeKey => {
                const theme = availableThemes[themeKey];
                const previewColors = getThemePreviewColors(themeKey);
                
                const option = document.createElement('div');
                option.className = `relative cursor-pointer rounded-lg border-2 transition-all p-4 ${
                    currentTheme === themeKey 
                        ? 'border-primary-100 bg-primary-10 shadow-md' 
                        : 'border-gray-200 hover:border-gray-300 bg-white hover:shadow-sm'
                }`;
                
                option.innerHTML = `
                    <div class="text-center">
                        <div class="flex justify-center space-x-1 mb-3">
                            <div class="w-5 h-5 rounded-full border-2 border-white shadow-sm" style="background-color: ${previewColors.primary}"></div>
                            <div class="w-5 h-5 rounded-full border-2 border-white shadow-sm" style="background-color: ${previewColors.accent}"></div>
                        </div>
                        <div class="font-medium text-sm ${currentTheme === themeKey ? 'text-primary-100' : 'text-gray-700'}">${theme.name}</div>
                        ${currentTheme === themeKey ? '<div class="absolute top-2 right-2"><i class="fas fa-check-circle text-primary-100"></i></div>' : ''}
                    </div>
                `;
                
                option.onclick = () => changeTheme(themeKey);
                container.appendChild(option);
            });
        }
        
        function getThemePreviewColors(themeKey) {
            const colorMap = {
                default: { primary: '#006B68', accent: '#FFC62F' },
                spring: { primary: '#2D5016', accent: '#8BC34A' },
                summer: { primary: '#FF6B35', accent: '#F7931E' },
                night: { primary: '#1A237E', accent: '#3F51B5' },
                romantic: { primary: '#AD1457', accent: '#E91E63' },
                ocean: { primary: '#006064', accent: '#00BCD4' }
            };
            return colorMap[themeKey] || colorMap.default;
        }



        function changeTheme(themeKey) {
            if (availableThemes[themeKey]) {
                currentTheme = themeKey;
                applyTheme(themeKey);
                localStorage.setItem('loveStoryTheme', themeKey);
                generateThemeOptions();
                document.getElementById('theme-selector').classList.add('hidden');
                
                logActivity('Đổi giao diện', `Đã chuyển sang giao diện: ${availableThemes[themeKey].name}`);
                showNotification(`Đã áp dụng giao diện ${availableThemes[themeKey].name}!`, 'success');
            }
        }

        function applyTheme(themeKey) {
            const theme = availableThemes[themeKey];
            
            // Fallback an toàn về theme mặc định
            if (!theme) {
                console.warn(`Theme '${themeKey}' không tồn tại, sử dụng theme mặc định`);
                themeKey = 'default';
            }
            
            try {
                // Xóa tất cả theme classes cũ
                document.documentElement.className = document.documentElement.className
                    .replace(/theme-\w+/g, '').trim();
                
                // Áp dụng theme class mới
                const themeClass = availableThemes[themeKey]?.className || 'theme-default';
                document.documentElement.classList.add(themeClass);
                
                console.log(`✅ Đã áp dụng theme: ${availableThemes[themeKey]?.name || 'Mặc định'} (${themeClass})`);
                
            } catch (error) {
                console.error('❌ Lỗi khi áp dụng theme:', error);
                // Fallback cuối cùng
                document.documentElement.className = 'theme-default';
            }
        }

        // Search Functions
        function showSearchModal() {
            document.getElementById('search-modal').classList.add('active');
            
            // Focus input after modal animation
            setTimeout(() => {
                document.getElementById('search-input').focus();
            }, 100);
            
            setSearchMode('basic'); // Default to basic search with stats
            
            logActivity('Mở tìm kiếm', 'Mở modal tìm kiếm thông minh');
        }

        function closeSearchModal() {
            document.getElementById('search-modal').classList.remove('active');
            document.getElementById('search-input').value = '';
            document.getElementById('search-results').innerHTML = `
                <div class="text-center py-12 text-gray-500">
                    <i class="fas fa-search text-4xl mb-4"></i>
                    <p class="text-lg">Nhập từ khóa để tìm kiếm</p>
                    <p class="text-sm mt-2">Bạn có thể tìm kiếm sự kiện, hỏi AI về kỷ niệm, hoặc xem thống kê</p>
                </div>
            `;
        }

        function setSearchMode(mode) {
            currentSearchMode = mode;
            
            // Update button styles
            document.querySelectorAll('.search-mode-btn').forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white', 'bg-purple-500');
                btn.classList.add('bg-gray-100', 'text-gray-700');
            });
            
            const activeBtn = document.getElementById(`${mode}-search-btn`);
            activeBtn.classList.remove('bg-gray-100', 'text-gray-700');
            
            if (mode === 'basic') {
                activeBtn.classList.add('bg-blue-500', 'text-white');
                document.getElementById('search-input').placeholder = 'Tìm kiếm sự kiện, thống kê...';
            } else if (mode === 'ai') {
                activeBtn.classList.add('bg-purple-500', 'text-white');
                document.getElementById('search-input').placeholder = 'Hỏi AI: "Kỷ niệm nào ở Đà Lạt?"...';
            }
            
            logActivity('Chuyển chế độ tìm kiếm', `Chuyển sang chế độ: ${mode}`);
        }

        function quickSearch(query) {
            document.getElementById('search-input').value = query;
            performSearch();
        }

        async function performSearch() {
            const query = document.getElementById('search-input').value.trim();
            if (!query) {
                showNotification('Vui lòng nhập từ khóa tìm kiếm!', 'warning');
                return;
            }

            const searchBtn = document.getElementById('search-btn');
            const originalText = searchBtn.innerHTML;
            searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span class="hidden sm:inline ml-2">Đang tìm...</span>';
            searchBtn.disabled = true;

            try {
                let results = [];
                
                if (currentSearchMode === 'basic') {
                    // Tích hợp thống kê vào tìm kiếm cơ bản
                    const basicResults = await performBasicSearch(query);
                    const statsResults = await performStatsSearch(query);
                    
                    // Kết hợp kết quả: thống kê trước, sau đó là kết quả tìm kiếm
                    results = [...statsResults, ...basicResults];
                } else if (currentSearchMode === 'ai') {
                    results = await performAISearch(query);
                }
                
                displaySearchResults(results, query);
                
                // Add to search history
                searchHistory.unshift({
                    query: query,
                    mode: currentSearchMode,
                    timestamp: new Date().toISOString(),
                    resultCount: Array.isArray(results) ? results.length : 1
                });
                
                // Keep only last 20 searches
                if (searchHistory.length > 20) {
                    searchHistory = searchHistory.slice(0, 20);
                }
                
                logActivity('Tìm kiếm', `${currentSearchMode}: "${query}" - ${Array.isArray(results) ? results.length : 1} kết quả`);
                
            } catch (error) {
                console.error('Lỗi tìm kiếm:', error);
                logActivity('Lỗi tìm kiếm', error.message);
                
                document.getElementById('search-results').innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <i class="fas fa-exclamation-triangle text-3xl sm:text-4xl mb-4"></i>
                        <p class="text-base sm:text-lg">Lỗi khi tìm kiếm</p>
                        <p class="text-xs sm:text-sm mt-2">${error.message}</p>
                    </div>
                `;
            } finally {
                searchBtn.innerHTML = originalText;
                searchBtn.disabled = false;
            }
        }

        async function performBasicSearch(query) {
            const results = [];
            const searchTerms = query.toLowerCase().split(' ');
            
            // Search in timeline events
            timelineData.forEach((event, index) => {
                let score = 0;
                const eventText = `${event.name || ''} ${event.contdetl || ''} ${event.day || ''}`.toLowerCase();
                
                searchTerms.forEach(term => {
                    if (eventText.includes(term)) {
                        score += eventText.split(term).length - 1;
                    }
                });
                
                if (score > 0) {
                    results.push({
                        type: 'event',
                        data: event,
                        index: index,
                        score: score,
                        matchText: highlightMatches(eventText, searchTerms)
                    });
                }
            });
            
            // Search in photos
            photosData.forEach((photo, index) => {
                let score = 0;
                const photoText = `${photo.name || ''} ${photo.description || ''}`.toLowerCase();
                
                searchTerms.forEach(term => {
                    if (photoText.includes(term)) {
                        score += photoText.split(term).length - 1;
                    }
                });
                
                if (score > 0) {
                    results.push({
                        type: 'photo',
                        data: photo,
                        index: index,
                        score: score,
                        matchText: highlightMatches(photoText, searchTerms)
                    });
                }
            });
            
            // Sort by relevance score
            results.sort((a, b) => b.score - a.score);
            
            return results;
        }

        async function performAISearch(query) {
            try {
                // Prepare context data for AI
                const contextData = {
                    events: timelineData.map(event => ({
                        name: event.name,
                        date: event.day,
                        description: event.contdetl,
                        hasImages: event.image && event.image.length > 0
                    })),
                    photos: photosData.map(photo => ({
                        name: photo.name,
                        createdTime: photo.createdTime,
                        description: photo.description
                    })),
                    stats: {
                        totalEvents: timelineData.length,
                        totalPhotos: photosData.length,
                        dateRange: getDateRange()
                    }
                };
                
                const response = await callGeminiApi(query, contextData);
                
                return [{
                    type: 'ai_response',
                    data: {
                        query: query,
                        response: response,
                        timestamp: new Date().toISOString()
                    }
                }];
                
            } catch (error) {
                throw new Error(`Lỗi AI: ${error.message}`);
            }
        }

        async function performStatsSearch(query) {
            const stats = [];
            const queryLower = query.toLowerCase();
            
            // Basic statistics
            if (queryLower.includes('số lượng') || queryLower.includes('bao nhiêu')) {
                stats.push({
                    type: 'stat',
                    title: 'Tổng số sự kiện',
                    value: timelineData.length,
                    icon: 'fas fa-calendar-alt',
                    color: 'text-blue-600'
                });
                
                stats.push({
                    type: 'stat',
                    title: 'Tổng số ảnh',
                    value: photosData.length,
                    icon: 'fas fa-images',
                    color: 'text-green-600'
                });
            }
            
            // Events by year
            if (queryLower.includes('năm') || queryLower.includes('year')) {
                const eventsByYear = {};
                timelineData.forEach(event => {
                    const year = event.day.split('-')[2];
                    eventsByYear[year] = (eventsByYear[year] || 0) + 1;
                });
                
                Object.keys(eventsByYear).sort().forEach(year => {
                    stats.push({
                        type: 'stat',
                        title: `Sự kiện năm ${year}`,
                        value: eventsByYear[year],
                        icon: 'fas fa-calendar-year',
                        color: 'text-purple-600'
                    });
                });
            }
            
            // Events by month
            if (queryLower.includes('tháng') || queryLower.includes('month')) {
                const eventsByMonth = {};
                const monthNames = ['Tháng 1', 'Tháng 2', 'Tháng 3', 'Tháng 4', 'Tháng 5', 'Tháng 6',
                                  'Tháng 7', 'Tháng 8', 'Tháng 9', 'Tháng 10', 'Tháng 11', 'Tháng 12'];
                
                timelineData.forEach(event => {
                    const month = parseInt(event.day.split('-')[1]) - 1;
                    const monthName = monthNames[month];
                    eventsByMonth[monthName] = (eventsByMonth[monthName] || 0) + 1;
                });
                
                Object.keys(eventsByMonth).forEach(month => {
                    stats.push({
                        type: 'stat',
                        title: `Sự kiện ${month}`,
                        value: eventsByMonth[month],
                        icon: 'fas fa-calendar-month',
                        color: 'text-orange-600'
                    });
                });
            }
            
            // Recent events
            if (queryLower.includes('gần nhất') || queryLower.includes('recent')) {
                const sortedEvents = [...timelineData].sort((a, b) => {
                    const dateA = parseDate(a.day);
                    const dateB = parseDate(b.day);
                    return dateB - dateA;
                });
                
                stats.push({
                    type: 'recent_events',
                    title: 'Sự kiện gần nhất',
                    data: sortedEvents.slice(0, 5),
                    icon: 'fas fa-clock',
                    color: 'text-red-600'
                });
            }
            
            return stats;
        }

        async function callGeminiApi(userMessage, contextData) {
            const apiKey = "AIzaSyDJddlVwOWA8vzdVNrcp70if4eOL30xjp0"; // Gemini API key
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`;

            // Create context string from data
            const eventsContext = contextData.events.map(event => 
                `Sự kiện: ${event.name}, Ngày: ${event.date}, Mô tả: ${event.description || 'Không có mô tả'}`
            ).join('\n');

            const photosContext = contextData.photos.slice(0, 20).map(photo => 
                `Ảnh: ${photo.name}, Ngày tạo: ${photo.createdTime || 'Không rõ'}`
            ).join('\n');

            const statsContext = `Thống kê: ${contextData.stats.totalEvents} sự kiện, ${contextData.stats.totalPhotos} ảnh`;

            const prompt = `Bạn là trợ lý AI cho ứng dụng Love Story - một ứng dụng lưu trữ kỷ niệm tình yêu.

Dữ liệu sự kiện:
${eventsContext}

Dữ liệu ảnh (một phần):
${photosContext}

${statsContext}

Hãy trả lời câu hỏi của người dùng một cách thân thiện, chi tiết và hữu ích. Nếu câu hỏi liên quan đến dữ liệu cụ thể, hãy phân tích và đưa ra thông tin chính xác. Trả lời bằng tiếng Việt.

Câu hỏi: "${userMessage}"`;

            const payload = {
                contents: [{
                    parts: [{ text: prompt }]
                }]
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                    return data.candidates[0].content.parts[0].text;
                } else {
                    throw new Error('Không nhận được phản hồi từ AI');
                }
            } catch (error) {
                console.error('Lỗi gọi Gemini API:', error);
                throw new Error('Không thể kết nối với AI. Vui lòng thử lại sau.');
            }
        }

        function displaySearchResults(results, query) {
            const container = document.getElementById('search-results');
            
            if (!results || results.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-search-minus text-3xl sm:text-4xl mb-4"></i>
                        <p class="text-base sm:text-lg">Không tìm thấy kết quả</p>
                        <p class="text-xs sm:text-sm mt-2">Thử tìm kiếm với từ khóa khác</p>
                    </div>
                `;
                return;
            }
            
            let resultsHtml = `
                <div class="mb-4 p-3 bg-blue-50 rounded-lg">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                        <div class="text-sm text-blue-700">
                            <i class="fas fa-search mr-2"></i>
                            Tìm thấy <strong>${results.length}</strong> kết quả cho "<strong class="break-words">${query}</strong>"
                        </div>
                        <div class="text-xs text-blue-600">
                            Chế độ: ${currentSearchMode === 'basic' ? 'Cơ bản + Thống kê' : 'AI'}
                        </div>
                    </div>
                </div>
            `;
            
            results.forEach((result, index) => {
                if (result.type === 'event') {
                    resultsHtml += renderEventResult(result, index);
                } else if (result.type === 'photo') {
                    resultsHtml += renderPhotoResult(result, index);
                } else if (result.type === 'ai_response') {
                    resultsHtml += renderAIResult(result);
                } else if (result.type === 'stat') {
                    resultsHtml += renderStatResult(result);
                } else if (result.type === 'recent_events') {
                    resultsHtml += renderRecentEventsResult(result);
                }
            });
            
            container.innerHTML = resultsHtml;
        }

        function renderEventResult(result, index) {
            const event = result.data;
            const eventDate = parseDate(event.day);
            const imageCount = event.image ? event.image.length : 0;
            
            return `
                <div class="bg-white border rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer" onclick="viewEventFromSearch(${result.index})">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-2">
                                <i class="fas fa-calendar-alt text-primary-100"></i>
                                <span class="text-sm font-medium text-primary-100">${formatDate(eventDate)}</span>
                                ${imageCount > 0 ? `<span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full">${imageCount} ảnh</span>` : ''}
                            </div>
                            <h4 class="font-semibold text-gray-900 mb-2">${event.name || 'Không có tiêu đề'}</h4>
                            <p class="text-sm text-gray-600 line-clamp-2">${event.contdetl || 'Không có mô tả'}</p>
                        </div>
                        <div class="ml-4">
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPhotoResult(result, index) {
            const photo = result.data;
            const thumbnailUrl = `https://drive.google.com/thumbnail?id=${photo.id}&sz=w200-h200`;
            
            return `
                <div class="bg-white border rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer" onclick="openPhotoModalById('${photo.id}')">
                    <div class="flex items-start space-x-4">
                        <img src="${thumbnailUrl}" alt="${photo.name}" class="w-16 h-16 object-cover rounded-lg flex-shrink-0">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-2">
                                <i class="fas fa-image text-green-600"></i>
                                <span class="text-sm font-medium text-green-600">Ảnh</span>
                            </div>
                            <h4 class="font-semibold text-gray-900 mb-1">${photo.name}</h4>
                            <p class="text-sm text-gray-600">${photo.description || 'Không có mô tả'}</p>
                            <div class="text-xs text-gray-500 mt-2">
                                ${photo.createdTime ? new Date(photo.createdTime).toLocaleDateString('vi-VN') : 'Không rõ ngày'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAIResult(result) {
            return `
                <div class="bg-gradient-to-r from-purple-50 to-blue-50 border border-purple-200 rounded-lg p-6">
                    <div class="flex items-center space-x-2 mb-4">
                        <i class="fas fa-robot text-purple-600 text-xl"></i>
                        <h4 class="font-semibold text-purple-800">Phản hồi từ AI</h4>
                        <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded-full">
                            ${new Date(result.data.timestamp).toLocaleTimeString('vi-VN')}
                        </span>
                    </div>
                    <div class="prose prose-sm max-w-none">
                        <div class="text-gray-800 leading-relaxed whitespace-pre-wrap">${result.data.response}</div>
                    </div>
                </div>
            `;
        }

        function renderStatResult(result) {
            return `
                <div class="bg-white border rounded-lg p-4">
                    <div class="flex items-center space-x-3">
                        <div class="flex-shrink-0">
                            <i class="${result.icon} ${result.color} text-2xl"></i>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-900">${result.title}</h4>
                            <div class="text-2xl font-bold ${result.color} mt-1">${result.value}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderRecentEventsResult(result) {
            let eventsHtml = '';
            result.data.forEach(event => {
                const eventDate = parseDate(event.day);
                eventsHtml += `
                    <div class="flex items-center justify-between py-2 border-b border-gray-100 last:border-b-0">
                        <div class="flex-1">
                            <div class="font-medium text-gray-900">${event.name || 'Không có tiêu đề'}</div>
                            <div class="text-sm text-gray-600">${formatDate(eventDate)}</div>
                        </div>
                        <button onclick="viewEventFromSearch(${timelineData.indexOf(event)})" class="text-primary-100 hover:text-primary-80">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                `;
            });
            
            return `
                <div class="bg-white border rounded-lg p-4">
                    <div class="flex items-center space-x-2 mb-4">
                        <i class="${result.icon} ${result.color} text-xl"></i>
                        <h4 class="font-semibold text-gray-900">${result.title}</h4>
                    </div>
                    <div class="space-y-2">
                        ${eventsHtml}
                    </div>
                </div>
            `;
        }

        function viewEventFromSearch(eventIndex) {
            closeSearchModal();
            showSection('timeline');
            
            // Scroll to event (simple implementation)
            setTimeout(() => {
                const timelineItems = document.querySelectorAll('.timeline-item');
                if (timelineItems[eventIndex]) {
                    timelineItems[eventIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
                    timelineItems[eventIndex].classList.add('bg-yellow-100');
                    setTimeout(() => {
                        timelineItems[eventIndex].classList.remove('bg-yellow-100');
                    }, 3000);
                }
            }, 500);
            
            logActivity('Xem sự kiện từ tìm kiếm', `Xem sự kiện: ${timelineData[eventIndex]?.name || 'Không có tên'}`);
        }

        function highlightMatches(text, searchTerms) {
            let highlighted = text;
            searchTerms.forEach(term => {
                const regex = new RegExp(`(${term})`, 'gi');
                highlighted = highlighted.replace(regex, '<mark>$1</mark>');
            });
            return highlighted;
        }

        function getDateRange() {
            if (timelineData.length === 0) return 'Không có dữ liệu';
            
            const dates = timelineData.map(event => parseDate(event.day)).sort((a, b) => a - b);
            const earliest = dates[0];
            const latest = dates[dates.length - 1];
            
            return `${formatDate(earliest)} - ${formatDate(latest)}`;
        }

        // Add event listener for search input
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        performSearch();
                    }
                });
            }
        });

        // Close modal when clicking outside
        document.getElementById('search-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeSearchModal();
            }
        });

        // Close modal when clicking outside
        document.getElementById('photo-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        document.getElementById('event-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEventModal();
            }
        });

        document.getElementById('delete-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeDeleteModal();
            }
        });

        document.getElementById('share-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeShareModal();
            }
        });

        document.getElementById('event-photos-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEventPhotosModal();
            }
        });

        document.getElementById('image-selector-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeImageSelector();
            }
        });

        document.getElementById('profile-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeProfileModal();
            }
        });

        // Handle comment input enter key
        document.getElementById('comment-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addComment();
            }
        });

        // Format date input as DD/MM/YYYY
        document.addEventListener('DOMContentLoaded', function() {
            const eventDateInput = document.getElementById('event-date');
            
            eventDateInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, ''); // Remove non-digits
                
                if (value.length >= 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2);
                }
                if (value.length >= 5) {
                    value = value.substring(0, 5) + '/' + value.substring(5, 9);
                }
                
                e.target.value = value;
            });
            
            eventDateInput.addEventListener('keydown', function(e) {
                // Allow backspace, delete, tab, escape, enter
                if ([8, 9, 27, 13, 46].indexOf(e.keyCode) !== -1 ||
                    // Allow Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
                    (e.keyCode === 65 && e.ctrlKey === true) ||
                    (e.keyCode === 67 && e.ctrlKey === true) ||
                    (e.keyCode === 86 && e.ctrlKey === true) ||
                    (e.keyCode === 88 && e.ctrlKey === true)) {
                    return;
                }
                // Ensure that it is a number and stop the keypress
                if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
                    e.preventDefault();
                }
            });
        });

        // Settings functions
        function logActivity(action, details = '') {
            if (!settings.activityLogging) return;
            
            const logEntry = {
                timestamp: new Date().toISOString(),
                action: action,
                details: details,
                id: Date.now() + Math.random(), // Đảm bảo unique ID
                sessionId: getSessionId()
            };
            
            // Thêm vào pending logs (vùng tạm)
            pendingLogs.unshift(logEntry);
            
            // Thêm vào allLogs để hiển thị ngay lập tức
            allLogs.unshift(logEntry);
            
            // Giới hạn số lượng log trong allLogs (giữ 2000 bản ghi gần nhất)
            if (allLogs.length > 2000) {
                allLogs = allLogs.slice(0, 2000);
            }
            
            // Lưu pending logs vào localStorage
            savePendingLogs();
            
            updateLogCount();
        }

        function getSessionId() {
            let sessionId = sessionStorage.getItem('loveStorySessionId');
            if (!sessionId) {
                sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                sessionStorage.setItem('loveStorySessionId', sessionId);
            }
            return sessionId;
        }

        function savePendingLogs() {
            try {
                localStorage.setItem('loveStoryPendingLogs', JSON.stringify(pendingLogs));
            } catch (error) {
                console.error('Lỗi lưu pending logs:', error);
            }
        }

        function updateLogCount() {
            const totalLogsElement = document.getElementById('total-logs');
            if (totalLogsElement) {
                totalLogsElement.textContent = allLogs.length;
            }
            
            const pendingLogsElement = document.getElementById('pending-logs-count');
            if (pendingLogsElement) {
                pendingLogsElement.textContent = pendingLogs.length;
            }
        }

        function updateConnectionStatus() {
            const statusElement = document.getElementById('connection-status');
            if (statusElement) {
                if (isOnline) {
                    statusElement.innerHTML = '<i class="fas fa-wifi mr-1 text-green-500"></i>Online';
                    statusElement.className = 'font-semibold text-green-600';
                } else {
                    statusElement.innerHTML = '<i class="fas fa-wifi-slash mr-1 text-red-500"></i>Offline';
                    statusElement.className = 'font-semibold text-red-600';
                }
            }
        }

        function updateLastSyncTime() {
            const lastSyncElement = document.getElementById('last-sync-time');
            if (lastSyncElement && settings.lastSyncTime) {
                lastSyncElement.textContent = new Date(settings.lastSyncTime).toLocaleString('vi-VN');
            }
        }

        async function manualSync() {
            const button = event.target;
            const originalText = button.innerHTML;
            
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Đang đồng bộ...';
            button.disabled = true;
            
            try {
                await syncPhotosFromGoogleDrive();
                generatePhotos();
                
                settings.lastSyncTime = new Date().toISOString();
                updateLastSyncTime();
                saveSettings();
                
                logActivity('Đồng bộ thủ công', 'Đồng bộ dữ liệu ảnh thành công từ Google Drive');
                
                showNotification('Đồng bộ thành công!', 'success');
            } catch (error) {
                console.error('Lỗi đồng bộ:', error);
                logActivity('Lỗi đồng bộ', error.message);
                showNotification('Đồng bộ thất bại!', 'error');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }



        function viewActivityLogs() {
            if (allLogs.length === 0) {
                showNotification('Chưa có nhật ký hoạt động', 'info');
                return;
            }
            
            // Tạo modal với filter
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl max-w-4xl max-h-[90vh] overflow-hidden m-4 w-full flex flex-col">
                    <div class="p-4 border-b flex justify-between items-center flex-shrink-0">
                        <h3 class="text-xl font-bold text-primary-100">Nhật Ký Hoạt Động</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <!-- Filter Section -->
                    <div class="p-4 border-b bg-gray-50 flex-shrink-0">
                        <div class="flex items-center space-x-4">
                            <div class="flex items-center space-x-2">
                                <label class="text-sm font-medium text-gray-700">Lọc theo:</label>
                                <select id="log-filter" class="px-3 py-1 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-100">
                                    <option value="all">Tất cả</option>
                                    <option value="sync">Lịch sử đồng bộ</option>
                                </select>
                            </div>
                            <div class="text-sm text-gray-600">
                                <span class="font-medium">Tổng:</span> <span id="total-count">${allLogs.length}</span> |
                                <span class="font-medium">Hiển thị:</span> <span id="filtered-count">${allLogs.length}</span> |
                                <span class="font-medium">Chưa lưu:</span> 
                                <span class="px-2 py-1 bg-orange-100 text-orange-800 rounded text-xs">${pendingLogs.length}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Logs Content -->
                    <div class="flex-1 overflow-y-auto min-h-0">
                        <div class="p-4">
                            <div id="logs-container" class="space-y-2">
                                <!-- Logs will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add event listener for filter
            const filterSelect = modal.querySelector('#log-filter');
            filterSelect.addEventListener('change', function() {
                updateLogsDisplay(modal, this.value);
            });
            
            // Initial display
            updateLogsDisplay(modal, 'all');
            
            // Close modal when clicking outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        function updateLogsDisplay(modal, filterType) {
            const logsContainer = modal.querySelector('#logs-container');
            const filteredCountElement = modal.querySelector('#filtered-count');
            
            let filteredLogs = allLogs;
            
            if (filterType === 'sync') {
                filteredLogs = allLogs.filter(log => 
                    log.action.toLowerCase().includes('đồng bộ') || 
                    log.action.toLowerCase().includes('sync') ||
                    log.details.toLowerCase().includes('đồng bộ') ||
                    log.details.toLowerCase().includes('google drive')
                );
            }
            
            // Update filtered count
            filteredCountElement.textContent = filteredLogs.length;
            
            if (filteredLogs.length === 0) {
                logsContainer.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-inbox text-4xl mb-4"></i>
                        <p>Không có nhật ký nào phù hợp với bộ lọc</p>
                    </div>
                `;
                return;
            }
            
            let logsHtml = '';
            filteredLogs.slice(0, 200).forEach(log => {
                const isPending = pendingLogs.some(p => p.id === log.id);
                const statusClass = isPending ? 'border-l-4 border-orange-400 bg-orange-50' : 'bg-gray-50';
                const statusIcon = isPending ? '<i class="fas fa-clock text-orange-500 mr-1"></i>' : '<i class="fas fa-check text-green-500 mr-1"></i>';
                
                // Highlight sync-related logs
                const isSyncLog = log.action.toLowerCase().includes('đồng bộ') || 
                                 log.action.toLowerCase().includes('sync') ||
                                 log.details.toLowerCase().includes('đồng bộ');
                const syncClass = isSyncLog ? 'border-l-4 border-blue-400' : '';
                
                logsHtml += `
                    <div class="${statusClass} ${syncClass} p-3 rounded">
                        <div class="flex justify-between items-start">
                            <div class="font-medium flex items-center">
                                ${statusIcon}
                                ${isSyncLog ? '<i class="fas fa-sync text-blue-500 mr-1"></i>' : ''}
                                ${log.action}
                            </div>
                            <div class="text-xs text-gray-500">${new Date(log.timestamp).toLocaleString('vi-VN')}</div>
                        </div>
                        ${log.details ? `<div class="text-sm text-gray-600 mt-1">${log.details}</div>` : ''}
                        ${log.sessionId ? `<div class="text-xs text-gray-400 mt-1">Session: ${log.sessionId}</div>` : ''}
                    </div>
                `;
            });
            
            logsContainer.innerHTML = logsHtml;
        }

        function exportLogs() {
            if (allLogs.length === 0) {
                showNotification('Không có dữ liệu để xuất', 'warning');
                return;
            }
            
            const exportData = {
                exportTime: new Date().toISOString(),
                totalLogs: allLogs.length,
                pendingLogs: pendingLogs.length,
                logs: allLogs
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `love-story-logs-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            logActivity('Xuất nhật ký', `Xuất file nhật ký thành công (${allLogs.length} bản ghi)`);
            showNotification('Đã xuất file nhật ký!', 'success');
        }

        function clearLogs() {
            if (confirm('Bạn có chắc chắn muốn xóa tất cả nhật ký hoạt động? Hành động này không thể hoàn tác.')) {
                const count = allLogs.length;
                
                // Clear all logs
                activityLogs = [];
                allLogs = [];
                pendingLogs = [];
                
                // Clear localStorage
                localStorage.removeItem('loveStoryPendingLogs');
                
                // Update UI
                updateLogCount();
                
                // Log this action (sẽ tạo log mới)
                logActivity('Xóa tất cả nhật ký', `Đã xóa ${count} bản ghi nhật ký`);
                
                showNotification(`Đã xóa ${count} bản ghi nhật ký`, 'success');
            }
        }

        function showNotification(message, type = 'info') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-4 py-2 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function showModal(title, content) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl max-w-2xl max-h-[80vh] overflow-auto m-4 w-full">
                    <div class="p-4 border-b flex justify-between items-center">
                        <h3 class="text-xl font-bold text-primary-100">${title}</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div class="p-4">
                        ${content}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Sync settings functions
        async function saveSyncSettings() {
            const button = event.target;
            const originalText = button.innerHTML;
            
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Đang lưu...';
            button.disabled = true;
            
            try {
                const enabled = document.getElementById('auto-sync-toggle').checked;
                const frequency = document.getElementById('sync-frequency').value;
                const time = document.getElementById('sync-time').value;
                
                if (!time) {
                    showNotification('Vui lòng chọn thời gian đồng bộ!', 'warning');
                    return;
                }
                
                // Update config
                appConfig.AUTO_SYNC_METADATA = {
                    enabled: enabled,
                    frequency: frequency,
                    time: time
                };
                
                // Save to GitHub
                await saveAppConfig();
                
                // Restart auto sync with new settings
                setupAutoSync();
                
                logActivity('Cài đặt đồng bộ', `Đã lưu cài đặt: ${enabled ? 'Bật' : 'Tắt'}, ${frequency}, ${time}`);
                showNotification('Đã lưu cài đặt thành công!', 'success');
                
            } catch (error) {
                console.error('Lỗi lưu cài đặt:', error);
                logActivity('Lỗi lưu cài đặt', error.message);
                showNotification('Lỗi khi lưu cài đặt!', 'error');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        function updateSyncSettingsUI() {
            // Update toggle
            document.getElementById('auto-sync-toggle').checked = appConfig.AUTO_SYNC_METADATA.enabled;
            
            // Update frequency
            document.getElementById('sync-frequency').value = appConfig.AUTO_SYNC_METADATA.frequency;
            
            // Update time
            document.getElementById('sync-time').value = appConfig.AUTO_SYNC_METADATA.time;
            
            // Show/hide settings based on enabled state
            const syncSettings = document.getElementById('sync-settings');
            if (appConfig.AUTO_SYNC_METADATA.enabled) {
                syncSettings.classList.remove('opacity-50', 'pointer-events-none');
            } else {
                syncSettings.classList.add('opacity-50', 'pointer-events-none');
            }
        }

        // Initialize settings on load
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved settings from localStorage
            const savedSettings = localStorage.getItem('loveStorySettings');
            if (savedSettings) {
                settings = { ...settings, ...JSON.parse(savedSettings) };
            }
            
            // Update UI
            updateLogCount();
            updateLastSyncTime();
            updateConnectionStatus();
            
            // Wait for config to load then update sync settings UI
            setTimeout(() => {
                updateSyncSettingsUI();
            }, 1000);
            
            // Set activity logging toggle
            document.getElementById('activity-log-toggle').checked = settings.activityLogging;
            
            // Add event listeners for toggles
            document.getElementById('auto-sync-toggle').addEventListener('change', function() {
                const syncSettings = document.getElementById('sync-settings');
                if (this.checked) {
                    syncSettings.classList.remove('opacity-50', 'pointer-events-none');
                } else {
                    syncSettings.classList.add('opacity-50', 'pointer-events-none');
                }
            });
            
            document.getElementById('activity-log-toggle').addEventListener('change', function() {
                const wasEnabled = settings.activityLogging;
                settings.activityLogging = this.checked;
                saveSettings();
                
                if (this.checked && !wasEnabled) {
                    // Start log management when enabled
                    setupLogManagement();
                    logActivity('Cài đặt', 'Bật ghi nhật ký hoạt động');
                } else if (!this.checked && wasEnabled) {
                    // Stop log management when disabled
                    stopLogSaveInterval();
                    logActivity('Cài đặt', 'Tắt ghi nhật ký hoạt động');
                }
            });
            
            // Add time input formatting
            const syncTimeInput = document.getElementById('sync-time');
            if (syncTimeInput) {
                syncTimeInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, ''); // Remove non-digits
                    
                    if (value.length >= 2) {
                        value = value.substring(0, 2) + ':' + value.substring(2, 4);
                    }
                    
                    e.target.value = value;
                });
                
                syncTimeInput.addEventListener('keydown', function(e) {
                    // Allow backspace, delete, tab, escape, enter, arrow keys
                    if ([8, 9, 27, 13, 46, 37, 38, 39, 40].indexOf(e.keyCode) !== -1 ||
                        // Allow Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
                        (e.keyCode === 65 && e.ctrlKey === true) ||
                        (e.keyCode === 67 && e.ctrlKey === true) ||
                        (e.keyCode === 86 && e.ctrlKey === true) ||
                        (e.keyCode === 88 && e.ctrlKey === true)) {
                        return;
                    }
                    // Ensure that it is a number and stop the keypress
                    if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
                        e.preventDefault();
                    }
                });
                
                syncTimeInput.addEventListener('blur', function(e) {
                    const value = e.target.value;
                    if (value && value.length === 5) {
                        const [hours, minutes] = value.split(':');
                        const h = parseInt(hours);
                        const m = parseInt(minutes);
                        
                        if (h < 0 || h > 23 || m < 0 || m > 59) {
                            showNotification('Thời gian không hợp lệ! Vui lòng nhập từ 00:00 đến 23:59', 'warning');
                            e.target.focus();
                        }
                    }
                });
            }
        });

        function saveSettings() {
            localStorage.setItem('loveStorySettings', JSON.stringify(settings));
        }

        function saveLogs() {
            localStorage.setItem('loveStoryLogs', JSON.stringify(activityLogs));
        }

        // Log management functions
        function setupLogManagement() {
            // Bắt đầu interval lưu logs mỗi 10 giây khi online
            if (isOnline && settings.activityLogging) {
                startLogSaveInterval();
            }
        }

        function startLogSaveInterval() {
            // Clear existing interval
            if (logSaveInterval) {
                clearInterval(logSaveInterval);
            }
            
            // Start new interval - save logs every 10 seconds
            logSaveInterval = setInterval(async () => {
                if (isOnline && pendingLogs.length > 0) {
                    await savePendingLogsToServer();
                }
            }, 10000); // 10 seconds
        }

        function stopLogSaveInterval() {
            if (logSaveInterval) {
                clearInterval(logSaveInterval);
                logSaveInterval = null;
            }
        }

        async function savePendingLogsToServer() {
            if (pendingLogs.length === 0) return;
            
            try {
                // Merge pending logs với existing logs
                const mergedLogs = [...pendingLogs, ...activityLogs];
                
                // Sort by timestamp (newest first)
                mergedLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                // Limit to 1000 most recent logs
                const finalLogs = mergedLogs.slice(0, 1000);
                
                // Save to GitHub
                await saveToGitHub(CONFIG.LOGS_FILE_PATH, finalLogs, `Cập nhật nhật ký hoạt động (${pendingLogs.length} bản ghi mới)`);
                
                // Update activityLogs
                activityLogs = finalLogs;
                
                // Clear pending logs
                const savedCount = pendingLogs.length;
                pendingLogs = [];
                localStorage.removeItem('loveStoryPendingLogs');
                
                // Update UI
                updateLogCount();
                
                console.log(`Đã lưu ${savedCount} bản ghi nhật ký lên server`);
                
            } catch (error) {
                console.error('Lỗi lưu nhật ký lên server:', error);
                // Không xóa pending logs nếu lưu thất bại
            }
        }

        function setupOnlineOfflineDetection() {
            // Listen for online/offline events
            window.addEventListener('online', handleOnline);
            window.addEventListener('offline', handleOffline);
            
            // Listen for page unload (when user closes tab/browser)
            window.addEventListener('beforeunload', handleBeforeUnload);
            
            // Listen for visibility change (when user switches tabs)
            document.addEventListener('visibilitychange', handleVisibilityChange);
        }

        function handleOnline() {
            isOnline = true;
            console.log('Đã kết nối internet');
            updateConnectionStatus();
            logActivity('Kết nối mạng', 'Đã kết nối lại internet');
            
            // Start log save interval
            if (settings.activityLogging) {
                startLogSaveInterval();
            }
            
            // Save pending logs immediately
            if (pendingLogs.length > 0) {
                savePendingLogsToServer();
            }
            
            showNotification('Đã kết nối lại internet', 'success');
        }

        function handleOffline() {
            isOnline = false;
            console.log('Mất kết nối internet');
            updateConnectionStatus();
            logActivity('Mất kết nối mạng', 'Đã mất kết nối internet, nhật ký sẽ được lưu tạm thời');
            
            // Stop log save interval
            stopLogSaveInterval();
            
            // Save pending logs immediately before going offline
            if (pendingLogs.length > 0) {
                savePendingLogsToServer().catch(error => {
                    console.log('Không thể lưu logs trước khi offline:', error);
                });
            }
            
            showNotification('Mất kết nối internet - Nhật ký sẽ được lưu tạm thời', 'warning');
        }

        function handleBeforeUnload() {
            // Save pending logs when user is about to leave
            if (pendingLogs.length > 0 && isOnline) {
                // Use sendBeacon for reliable delivery
                const data = JSON.stringify({
                    action: 'saveLogs',
                    logs: pendingLogs,
                    timestamp: new Date().toISOString()
                });
                
                // Try to save using fetch with keepalive
                fetch(`https://api.github.com/repos/${CONFIG.GITHUB_USERNAME}/${CONFIG.REPO_NAME}/contents/${CONFIG.LOGS_FILE_PATH}`, {
                    method: 'PUT',
                    keepalive: true,
                    headers: {
                        'Authorization': `token ${CONFIG.PAT1 + CONFIG.PAT2}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Lưu nhật ký khi đóng ứng dụng (${pendingLogs.length} bản ghi)`,
                        content: btoa(unescape(encodeURIComponent(JSON.stringify([...pendingLogs, ...activityLogs], null, 2))))
                    })
                }).catch(error => {
                    console.log('Không thể lưu logs khi đóng ứng dụng:', error);
                });
            }
            
            logActivity('Đóng ứng dụng', 'Người dùng đã đóng ứng dụng');
        }

        function handleVisibilityChange() {
            if (document.hidden) {
                logActivity('Chuyển tab', 'Người dùng đã chuyển sang tab khác');
            } else {
                logActivity('Quay lại tab', 'Người dùng đã quay lại ứng dụng');
            }
        }

        // Save logs periodically to localStorage
        setInterval(() => {
            savePendingLogs();
        }, 5000); // Save to localStorage every 5 seconds

        function clearCacheAndReload() {
            if (confirm('Bạn có chắc chắn muốn xóa tất cả cache và tải lại dữ liệu? Điều này sẽ làm cho lần tải tiếp theo chậm hơn.')) {
                const button = event.target;
                const originalText = button.innerHTML;
                
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Đang xóa cache...';
                button.disabled = true;
                
                try {
                    // Xóa tất cả cache
                    clearCache();
                    
                    // Reset dữ liệu
                    timelineData = [];
                    photosData = [];
                    commentsData = [];
                    
                    // Hiển thị loading
                    showLoadingState();
                    
                    // Tải lại dữ liệu
                    setTimeout(async () => {
                        try {
                            await loadTimelineData();
                            await loadPhotosData();
                            await loadCommentsData();
                            
                            generateCalendar();
                            generateTimeline();
                            generatePhotos();
                            
                            logActivity('Xóa cache', 'Đã xóa cache và tải lại dữ liệu thành công');
                            showNotification('Đã xóa cache và tải lại dữ liệu!', 'success');
                        } catch (error) {
                            console.error('Lỗi tải lại dữ liệu:', error);
                            showNotification('Lỗi khi tải lại dữ liệu!', 'error');
                        } finally {
                            button.innerHTML = originalText;
                            button.disabled = false;
                        }
                    }, 500);
                    
                } catch (error) {
                    console.error('Lỗi xóa cache:', error);
                    showNotification('Lỗi khi xóa cache!', 'error');
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            }
        }

        // Timeline toggle functions
        function toggleTimeDisplay(element, shortTime, detailedTime) {
            const isShowingShort = element.textContent.trim() === shortTime;
            element.textContent = isShowingShort ? detailedTime : shortTime;
        }

        function toggleDescription(titleElement) {
            const descriptionElement = titleElement.nextElementSibling;
            if (descriptionElement && descriptionElement.classList.contains('description-content')) {
                descriptionElement.classList.toggle('hidden');
                
                // Add visual indicator
                const isHidden = descriptionElement.classList.contains('hidden');
                titleElement.innerHTML = titleElement.innerHTML.replace(/(<i[^>]*><\/i>\s*)?$/, '') + 
                    (isHidden ? ' <i class="fas fa-chevron-down text-sm"></i>' : ' <i class="fas fa-chevron-up text-sm"></i>');
            }
        }


    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98e616be11f408e5',t:'MTc2MDQzNDU0OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
