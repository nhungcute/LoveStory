<!DOCTYPE html>
<html lang="vi" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Love Story - Ứng Dụng Kỷ Niệm</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            100: '#006B68',
                            80: '#339B98',
                            60: '#66B3B0',
                            50: '#80C4C1',
                            30: '#B3DCDA',
                            10: '#E6F5F4'
                        },
                        accent: {
                            100: '#FFC62F',
                            80: '#FFD15C',
                            60: '#FFDC89',
                            50: '#FFE4A3',
                            30: '#FFEDC9',
                            10: '#FFF8E6'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            box-sizing: border-box;
        }
        
        .calendar-day {
            transition: all 0.3s ease;
        }
        
        .calendar-day:hover {
            transform: scale(1.05);
        }
        
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .photo-item {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .photo-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 107, 104, 0.2);
        }
        
        .timeline-item {
            position: relative;
            padding-left: 2rem;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0.5rem;
            width: 12px;
            height: 12px;
            background: #FFC62F;
            border-radius: 50%;
            border: 3px solid #006B68;
        }
        
        .timeline-item::after {
            content: '';
            position: absolute;
            left: 5px;
            top: 1.5rem;
            width: 2px;
            height: calc(100% - 1rem);
            background: #006B68;
        }
        
        .timeline-item:last-child::after {
            display: none;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .loading {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .btn-icon-small {
            background: none;
            border: 1px solid #B3D9D7;
            color: #006B68;
            padding: 5px;
            border-radius: 5px;
            transition: all 0.3s ease;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body class="h-full bg-gradient-to-br from-primary-10 to-accent-10 font-sans">
    <!-- Header -->
    <header class="bg-primary-100 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <h1 class="text-xl md:text-2xl font-bold flex items-center">
                    <i class="fas fa-heart text-accent-100 mr-2"></i>
                    <span class="hidden sm:inline">Love Story</span>
                </h1>
                <nav class="flex space-x-2 md:space-x-6">
                    <button onclick="showSection('calendar')" class="nav-btn px-2 md:px-4 py-2 rounded-lg transition-colors hover:bg-primary-80 active" title="Lịch">
                        <i class="fas fa-calendar-alt md:mr-2"></i>
                        <span class="hidden md:inline">Lịch</span>
                    </button>
                    <button onclick="showSection('timeline')" class="nav-btn px-2 md:px-4 py-2 rounded-lg transition-colors hover:bg-primary-80" title="Timeline">
                        <i class="fas fa-heart-pulse md:mr-2"></i>
                        <span class="hidden md:inline">Timeline</span>
                    </button>
                    <button onclick="showSection('photos')" class="nav-btn px-2 md:px-4 py-2 rounded-lg transition-colors hover:bg-primary-80" title="Khoảnh Khắc">
                        <i class="fas fa-images md:mr-2"></i>
                        <span class="hidden md:inline">Khoảnh Khắc</span>
                    </button>
                    <button onclick="showSection('settings')" class="nav-btn px-2 md:px-4 py-2 rounded-lg transition-colors hover:bg-primary-80" title="Cài Đặt">
                        <i class="fas fa-cog md:mr-2"></i>
                        <span class="hidden md:inline">Cài Đặt</span>
                    </button>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Calendar Section -->
        <section id="calendar-section" class="section active">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-primary-100">
                        <i class="fas fa-calendar-heart mr-2"></i>Lịch Kỷ Niệm
                    </h2>
                    <div class="flex items-center space-x-4">
                        <button onclick="previousMonth()" class="p-2 rounded-lg bg-primary-100 text-white hover:bg-primary-80">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span id="current-month" class="text-lg font-semibold text-primary-100"></span>
                        <button onclick="nextMonth()" class="p-2 rounded-lg bg-primary-100 text-white hover:bg-primary-80">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-2">
                    <!-- Calendar will be generated here -->
                </div>
            </div>
        </section>

        <!-- Timeline Section -->
        <section id="timeline-section" class="section hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-primary-100">
                        <i class="fas fa-heart-pulse mr-2"></i>Timeline
                    </h2>
                    <button onclick="showAddEventModal()" class="px-4 py-2 bg-primary-100 text-white rounded-lg hover:bg-primary-80 transition-colors">
                        <i class="fas fa-plus mr-2"></i>Thêm sự kiện
                    </button>
                </div>
                <div id="timeline-container" class="space-y-3">
                    <div class="flex justify-center">
                        <i class="fas fa-spinner loading text-primary-100 text-2xl"></i>
                    </div>
                </div>
            </div>
        </section>

        <!-- Photos Section -->
        <section id="photos-section" class="section hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-primary-100">
                        <i class="fas fa-camera-retro mr-2"></i>Khoảnh Khắc Đẹp
                    </h2>
                    <div class="flex items-center space-x-4">
                        <button onclick="toggleView('grid')" id="grid-btn" class="view-btn p-2 rounded-lg bg-primary-100 text-white">
                            <i class="fas fa-th"></i>
                        </button>
                        <button onclick="toggleView('list')" id="list-btn" class="view-btn p-2 rounded-lg bg-gray-300 text-gray-600">
                            <i class="fas fa-list"></i>
                        </button>
                    </div>
                </div>
                
                <div id="photos-container" class="photo-grid">
                    <div class="flex justify-center col-span-full">
                        <i class="fas fa-spinner loading text-primary-100 text-2xl"></i>
                    </div>
                </div>
                
                <div id="pagination" class="flex justify-center mt-8 space-x-2">
                    <!-- Pagination will be generated here -->
                </div>
            </div>
        </section>

        <!-- Settings Section -->
        <section id="settings-section" class="section hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-primary-100 mb-6">
                    <i class="fas fa-cog mr-2"></i>Cài Đặt Hệ Thống
                </h2>
                
                <!-- Auto Update Settings -->
                <div class="bg-gradient-to-r from-primary-10 to-accent-10 rounded-lg p-6 mb-6">
                    <div class="flex items-start space-x-4">
                        <div class="bg-primary-100 p-3 rounded-full">
                            <i class="fas fa-sync-alt text-white text-xl"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold text-primary-100 mb-2">Tự Động Cập Nhật</h3>
                            <p class="text-gray-700 mb-4">Hệ thống sẽ tự động làm mới danh sách ảnh từ Google Drive vào 9 giờ sáng mỗi ngày.</p>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="auto-sync-toggle" class="sr-only peer" checked>
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-30 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-100"></div>
                                    </label>
                                    <span class="text-sm font-medium text-gray-700">Bật tự động cập nhật</span>
                                </div>
                                <div class="text-sm text-gray-500">
                                    <i class="fas fa-clock mr-1"></i>
                                    Lần cuối: <span id="last-sync-time">Chưa có</span>
                                </div>
                            </div>
                            <div class="mt-4 flex space-x-3">
                                <button onclick="manualSync()" class="px-4 py-2 bg-primary-100 text-white rounded-lg hover:bg-primary-80 transition-colors">
                                    <i class="fas fa-sync mr-2"></i>Đồng bộ ngay
                                </button>
                                <button onclick="showSyncHistory()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                                    <i class="fas fa-history mr-2"></i>Lịch sử
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Activity Logging Settings -->
                <div class="bg-gradient-to-r from-accent-10 to-primary-10 rounded-lg p-6 mb-6">
                    <div class="flex items-start space-x-4">
                        <div class="bg-accent-100 p-3 rounded-full">
                            <i class="fas fa-clipboard-list text-white text-xl"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold text-primary-100 mb-2">Ghi Nhật Ký Hoạt Động</h3>
                            <p class="text-gray-700 mb-4">Mọi hành động quan trọng đều được ghi lại, giúp dễ dàng theo dõi và quản lý.</p>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="activity-log-toggle" class="sr-only peer" checked>
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-accent-30 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-accent-100"></div>
                                    </label>
                                    <span class="text-sm font-medium text-gray-700">Bật ghi nhật ký</span>
                                </div>
                                <div class="text-sm text-gray-500">
                                    <i class="fas fa-database mr-1"></i>
                                    Tổng: <span id="total-logs">0</span> bản ghi
                                </div>
                            </div>
                            <div class="mt-4 flex space-x-3">
                                <button onclick="viewActivityLogs()" class="px-4 py-2 bg-accent-100 text-white rounded-lg hover:bg-accent-80 transition-colors">
                                    <i class="fas fa-eye mr-2"></i>Xem nhật ký
                                </button>
                                <button onclick="exportLogs()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                                    <i class="fas fa-download mr-2"></i>Xuất file
                                </button>
                                <button onclick="clearLogs()" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors">
                                    <i class="fas fa-trash mr-2"></i>Xóa tất cả
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- System Information -->
                <div class="bg-gray-50 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-primary-100 mb-4">
                        <i class="fas fa-info-circle mr-2"></i>Thông Tin Hệ Thống
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-white rounded-lg p-4">
                            <div class="text-sm text-gray-600 mb-1">Phiên bản</div>
                            <div class="font-semibold text-primary-100">Love Story v2.0</div>
                        </div>
                        <div class="bg-white rounded-lg p-4">
                            <div class="text-sm text-gray-600 mb-1">Kết nối GitHub</div>
                            <div class="font-semibold text-green-600">
                                <i class="fas fa-check-circle mr-1"></i>Hoạt động
                            </div>
                        </div>
                        <div class="bg-white rounded-lg p-4">
                            <div class="text-sm text-gray-600 mb-1">Kết nối Google Drive</div>
                            <div class="font-semibold text-green-600">
                                <i class="fas fa-check-circle mr-1"></i>Hoạt động
                            </div>
                        </div>
                        <div class="bg-white rounded-lg p-4">
                            <div class="text-sm text-gray-600 mb-1">Dung lượng sử dụng</div>
                            <div class="font-semibold text-primary-100">
                                <span id="storage-used">0</span> MB
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Photo Modal -->
    <div id="photo-modal" class="modal">
        <div class="bg-white rounded-xl max-w-4xl max-h-[90vh] overflow-auto m-4">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 id="modal-title" class="text-xl font-bold text-primary-100"></h3>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4">
                <img id="modal-image" class="w-full rounded-lg mb-4" alt="">
                <div class="flex items-center space-x-4 mb-4">
                    <button onclick="likePhoto()" id="like-btn" class="flex items-center space-x-2 px-4 py-2 rounded-lg bg-red-500 text-white hover:bg-red-600 transition-colors">
                        <i class="fas fa-heart text-red-100"></i>
                        <span id="like-count">0</span>
                    </button>
                    <button onclick="sharePhoto()" class="flex items-center space-x-2 px-4 py-2 rounded-lg bg-blue-500 text-white hover:bg-blue-600 transition-colors">
                        <i class="fas fa-share-alt"></i>
                        <span>Chia sẻ</span>
                    </button>
                    <button onclick="downloadPhoto()" class="flex items-center space-x-2 px-4 py-2 rounded-lg bg-green-500 text-white hover:bg-green-600 transition-colors">
                        <i class="fas fa-download"></i>
                        <span>Tải về</span>
                    </button>
                </div>
                <div class="border-t pt-4">
                    <h4 class="font-semibold text-primary-100 mb-3">Bình luận</h4>
                    <div id="comments-container" class="space-y-3 mb-4 max-h-60 overflow-y-auto">
                        <!-- Comments will be loaded here -->
                    </div>
                    <div class="flex space-x-2">
                        <input type="text" id="comment-input" placeholder="Thêm bình luận..." 
                               class="flex-1 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-100">
                        <button onclick="addComment()" class="px-4 py-2 bg-primary-100 text-white rounded-lg hover:bg-primary-80">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Event Modal -->
    <div id="event-modal" class="modal">
        <div class="bg-white rounded-xl max-w-md w-full m-4">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 id="event-modal-title" class="text-xl font-bold text-primary-100">Thêm sự kiện mới</h3>
                <button onclick="closeEventModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="event-form" class="p-4 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tên sự kiện</label>
                    <input type="text" id="event-name" required 
                           class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-100"
                           placeholder="Nhập tên sự kiện...">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Ngày</label>
                    <input type="date" id="event-date" required 
                           class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-100">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Mô tả</label>
                    <textarea id="event-description" rows="3" 
                              class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-100"
                              placeholder="Mô tả chi tiết về sự kiện..."></textarea>
                </div>
                <div class="flex space-x-3 pt-4">
                    <button type="submit" class="flex-1 px-4 py-2 bg-primary-100 text-white rounded-lg hover:bg-primary-80 transition-colors">
                        <i class="fas fa-save mr-2"></i>Lưu
                    </button>
                    <button type="button" onclick="closeEventModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">
                        Hủy
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal">
        <div class="bg-white rounded-xl max-w-md w-full m-4">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold text-red-600">Xác nhận xóa</h3>
                <button onclick="closeDeleteModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4">
                <div class="flex items-center space-x-3 mb-4">
                    <i class="fas fa-exclamation-triangle text-red-500 text-2xl"></i>
                    <div>
                        <p class="font-medium text-gray-900">Bạn có chắc chắn muốn xóa sự kiện này?</p>
                        <p class="text-sm text-gray-600 mt-1" id="delete-event-name"></p>
                    </div>
                </div>
                <div class="flex space-x-3">
                    <button onclick="confirmDeleteEvent()" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                        <i class="fas fa-trash mr-2"></i>Xóa
                    </button>
                    <button onclick="closeDeleteModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">
                        Hủy
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div id="share-modal" class="modal">
        <div class="bg-white rounded-xl max-w-md w-full m-4">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold text-primary-100">
                    <i class="fas fa-share-alt mr-2"></i>Chia Sẻ Ảnh
                </h3>
                <button onclick="closeShareModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4">
                <!-- Link Copy Section -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Link ảnh gốc</label>
                    <div class="flex space-x-2">
                        <input type="text" id="share-link" readonly 
                               class="flex-1 px-3 py-2 border rounded-lg bg-gray-50 text-sm">
                        <button onclick="copyShareLink()" class="px-4 py-2 bg-primary-100 text-white rounded-lg hover:bg-primary-80 transition-colors">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>

                <!-- Social Media Platforms -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-3">Chia sẻ lên</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="shareToFacebook()" class="flex items-center justify-center space-x-2 px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fab fa-facebook-f"></i>
                            <span>Facebook</span>
                        </button>
                        <button onclick="shareToTwitter()" class="flex items-center justify-center space-x-2 px-4 py-3 bg-sky-500 text-white rounded-lg hover:bg-sky-600 transition-colors">
                            <i class="fab fa-twitter"></i>
                            <span>Twitter</span>
                        </button>
                        <button onclick="shareToTelegram()" class="flex items-center justify-center space-x-2 px-4 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                            <i class="fab fa-telegram-plane"></i>
                            <span>Telegram</span>
                        </button>
                        <button onclick="shareToWhatsApp()" class="flex items-center justify-center space-x-2 px-4 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                            <i class="fab fa-whatsapp"></i>
                            <span>WhatsApp</span>
                        </button>
                        <button onclick="shareToLinkedIn()" class="flex items-center justify-center space-x-2 px-4 py-3 bg-blue-700 text-white rounded-lg hover:bg-blue-800 transition-colors">
                            <i class="fab fa-linkedin-in"></i>
                            <span>LinkedIn</span>
                        </button>
                        <button onclick="shareToEmail()" class="flex items-center justify-center space-x-2 px-4 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                            <i class="fas fa-envelope"></i>
                            <span>Email</span>
                        </button>
                    </div>
                </div>

                <!-- QR Code Section -->
                <div class="mt-6 pt-4 border-t">
                    <div class="text-center">
                        <button onclick="generateQRCode()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                            <i class="fas fa-qrcode mr-2"></i>Tạo mã QR
                        </button>
                        <div id="qr-code-container" class="mt-3 hidden">
                            <div id="qr-code" class="flex justify-center"></div>
                            <p class="text-xs text-gray-500 mt-2">Quét mã QR để xem ảnh</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            GITHUB_USERNAME: "nhungcute",
            REPO_NAME: "LoveStory",
            PAT1: "ghp_a8VLpoCYQByLbUIwe",
            PAT2: "d3dy4hHjEpKwr3stE6T",
            FILE_PATH: "actions.json",
            COMMENTS_FILE_PATH: "comments.json",
            PHOTOS_METADATA_FILE_PATH: "image_data.json",
            LOGS_FILE_PATH: "logs.json",
            FOLDER_ID: "1B_tpWbLwlc7mqT789-g2RO9K2pYNXVav",
            API_KEY: "AIzaSyDJddlVwOWA8vzdVNrcp70if4eOL30xjp0",
            PHOTOS_PER_PAGE: 50,
            AUTO_LOAD_METADATA: "true",
            AUTO_SYNC_METADATA: {
                enabled: true,
                frequency: "daily",
                time: "09:00"
            }
        };

        // Global variables
        let currentDate = new Date();
        let timelineData = [];
        let photosData = [];
        let commentsData = {};
        let currentPhotoPage = 1;
        let currentView = 'grid';
        let currentPhotoId = null;
        let activityLogs = [];
        let currentEditingEventIndex = null;
        let currentDeletingEventIndex = null;
        let settings = {
            autoSync: true,
            activityLogging: true,
            lastSyncTime: null
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        async function initializeApp() {
            try {
                await loadTimelineData();
                await loadPhotosData();
                await loadCommentsData();
                generateCalendar();
                generateTimeline();
                generatePhotos();
                
                // Auto sync setup
                if (CONFIG.AUTO_SYNC_METADATA.enabled) {
                    setupAutoSync();
                }
            } catch (error) {
                console.error('Lỗi khởi tạo ứng dụng:', error);
                showError('Không thể tải dữ liệu. Vui lòng thử lại sau.');
            }
        }

        // GitHub API functions
        async function fetchFromGitHub(filePath) {
            const token = CONFIG.PAT1 + CONFIG.PAT2;
            const url = `https://api.github.com/repos/${CONFIG.GITHUB_USERNAME}/${CONFIG.REPO_NAME}/contents/${filePath}`;
            
            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                // Decode Base64 và fix UTF-8 encoding cho tiếng Việt
                const content = atob(data.content);
                const decoded = decodeURIComponent(escape(content));
                return JSON.parse(decoded);
            } catch (error) {
                console.error(`Lỗi tải file ${filePath}:`, error);
                return null;
            }
        }

        async function loadTimelineData() {
            const data = await fetchFromGitHub(CONFIG.FILE_PATH);
            if (data) {
                timelineData = data.sort((a, b) => {
                    const dateA = parseDate(a.day);
                    const dateB = parseDate(b.day);
                    return dateA - dateB;
                });
            }
        }

        async function loadPhotosData() {
            try {
                const data = await loadPhotosMetadataFromGitHub();
                if (data && data.length > 0) {
                    photosData = data;
                }
            } catch (error) {
                console.error('Lỗi tải dữ liệu ảnh:', error);
                photosData = [];
            }
        }

        // Hàm đọc metadata ảnh từ GitHub
        async function loadPhotosMetadataFromGitHub() {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 giây timeout
                
                const token = CONFIG.PAT1 + CONFIG.PAT2;
                const url = `https://api.github.com/repos/${CONFIG.GITHUB_USERNAME}/${CONFIG.REPO_NAME}/contents/${CONFIG.PHOTOS_METADATA_FILE_PATH}`;
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        console.log('File metadata chưa tồn tại');
                        return [];
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const content = atob(data.content);
                const decoded = decodeURIComponent(escape(content));
                return JSON.parse(decoded);
            } catch (error) {
                console.error('Lỗi khi đọc metadata từ GitHub:', error);
                return [];
            }
        }

        async function loadCommentsData() {
            const data = await fetchFromGitHub(CONFIG.COMMENTS_FILE_PATH);
            if (data) {
                // Đảm bảo commentsData là array để sử dụng find()
                commentsData = Array.isArray(data) ? data : [];
            }
        }

        async function saveToGitHub(filePath, data, commitMessage) {
            const token = CONFIG.PAT1 + CONFIG.PAT2;
            const url = `https://api.github.com/repos/${CONFIG.GITHUB_USERNAME}/${CONFIG.REPO_NAME}/contents/${filePath}`;
            
            try {
                // Get current file to get SHA
                const currentFile = await fetch(url, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                let sha = null;
                if (currentFile.ok) {
                    const currentData = await currentFile.json();
                    sha = currentData.sha;
                }
                
                // Encode data to Base64 with proper UTF-8 encoding
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
                
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: commitMessage,
                        content: content,
                        sha: sha
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error(`Lỗi lưu file ${filePath}:`, error);
                throw error;
            }
        }

        // Utility functions
        function parseDate(dateString) {
            const [day, month, year] = dateString.split('-');
            return new Date(year, month - 1, day);
        }

        // Helper functions for photo data
        function getPhotoLikes(photoName) {
            const photoData = commentsData.find(item => item.ID_IMG === photoName);
            return photoData?.count_tim || 0;
        }

        function getPhotoCommentsCount(photoName) {
            const photoData = commentsData.find(item => item.ID_IMG === photoName);
            return photoData?.comments?.length || 0;
        }

        function getPhotoComments(photoName) {
            const photoData = commentsData.find(item => item.ID_IMG === photoName);
            return photoData?.comments || [];
        }

        function formatDate(date) {
            return date.toLocaleDateString('vi-VN', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        // Navigation functions
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
                section.classList.remove('active');
            });
            
            // Show selected section
            const targetSection = document.getElementById(`${sectionName}-section`);
            targetSection.classList.remove('hidden');
            targetSection.classList.add('active');
            
            // Update navigation buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-primary-80');
            });
            event.target.closest('.nav-btn').classList.add('bg-primary-80');
        }

        // Calendar functions
        function generateCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            document.getElementById('current-month').textContent = 
                currentDate.toLocaleDateString('vi-VN', { month: 'long', year: 'numeric' });
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            const calendarGrid = document.getElementById('calendar-grid');
            calendarGrid.innerHTML = '';
            
            // Day headers
            const dayHeaders = ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'];
            dayHeaders.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'text-center font-semibold text-primary-100 py-2';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });
            
            // Calendar days
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = `calendar-day text-center p-3 rounded-lg cursor-pointer ${
                    date.getMonth() === month ? 'text-primary-100 hover:bg-primary-10' : 'text-gray-400'
                }`;
                
                // Check for events on this date
                const dateString = formatDate(date).split('/').reverse().join('-');
                const hasEvent = timelineData.some(event => event.day === dateString);
                
                if (hasEvent) {
                    dayElement.classList.add('bg-accent-30', 'font-bold');
                    dayElement.innerHTML = `${date.getDate()}<br><i class="fas fa-heart text-accent-100 text-xs"></i>`;
                } else {
                    dayElement.textContent = date.getDate();
                }
                
                calendarGrid.appendChild(dayElement);
            }
        }

        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            generateCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            generateCalendar();
        }

        // Timeline functions
        function generateTimeline() {
            const container = document.getElementById('timeline-container');
            
            if (timelineData.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-heart-broken text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500 text-lg">Chưa có kỷ niệm nào được ghi lại</p>
                        <p class="text-gray-400 text-sm mt-2">Hãy tạo những khoảnh khắc đẹp đầu tiên!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            timelineData.forEach((event, index) => {
                const eventDate = parseDate(event.day);
                const timelineItem = document.createElement('div');
                timelineItem.className = 'timeline-item bg-white border-l-4 border-accent-100 shadow-md hover:shadow-lg transition-all duration-300 p-6 rounded-r-lg';
                
                // Tính số ngày từ hôm nay
                const today = new Date();
                const diffTime = today - eventDate;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                let timeAgo = '';
                let timeAgoDetailed = '';
                
                if (diffDays === 0) {
                    timeAgo = 'Hôm nay';
                    timeAgoDetailed = 'Hôm nay';
                } else if (diffDays === 1) {
                    timeAgo = 'Hôm qua';
                    timeAgoDetailed = 'Hôm qua';
                } else if (diffDays > 0) {
                    if (diffDays >= 365) {
                        const years = diffDays / 365;
                        const wholeYears = Math.floor(years);
                        const remainingDays = diffDays % 365;
                        const months = Math.floor(remainingDays / 30);
                        
                        timeAgo = `${diffDays} ngày trước`;
                        timeAgoDetailed = `${wholeYears} năm${months > 0 ? ` ${months} tháng` : ''} trước`;
                    } else {
                        timeAgo = `${diffDays} ngày trước`;
                        timeAgoDetailed = `${diffDays} ngày trước`;
                    }
                } else {
                    timeAgo = `Còn ${Math.abs(diffDays)} ngày nữa`;
                    timeAgoDetailed = `Còn ${Math.abs(diffDays)} ngày nữa`;
                }
                
                timelineItem.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center justify-between mb-3">
                                <div class="bg-gradient-to-r from-primary-100 to-accent-100 text-white px-3 py-1 rounded-full text-sm font-medium">
                                    ${formatDate(eventDate)}
                                </div>
                                <div class="timeline-actions flex space-x-1 md:space-x-2">
                                    <button class="btn-icon-small" onclick="editEvent(${index})" title="Chỉnh sửa">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn-icon-small" onclick="viewEventPhotos(${index})" title="Xem ảnh">
                                        <i class="fas fa-images"></i>
                                    </button>
                                    <button class="btn-icon-small" onclick="deleteEvent(${index})" title="Xóa">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full cursor-pointer hover:bg-gray-200 transition-colors mb-3 inline-block" 
                                  onclick="toggleTimeDisplay(this, '${timeAgo}', '${timeAgoDetailed}')" 
                                  title="Nhấn để xem chi tiết">
                                ${timeAgo}
                            </span>
                            <h3 class="text-lg font-bold text-primary-100 mb-3 leading-tight cursor-pointer hover:text-primary-80 transition-colors" 
                                onclick="toggleDescription(this)">${event.name || 'Không có tiêu đề'}</h3>
                            <div class="text-gray-700 leading-relaxed hidden description-content">
                                ${event.contdetl ? 
                                    `<p class="mb-2 text-sm">${event.contdetl}</p>` : 
                                    '<p class="text-gray-400 italic text-sm">Không có mô tả chi tiết</p>'
                                }
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(timelineItem);
            });
            
            // Thêm thống kê tổng quan
            const statsDiv = document.createElement('div');
            statsDiv.className = 'mt-8 bg-gradient-to-r from-primary-10 to-accent-10 rounded-xl p-6';
            statsDiv.innerHTML = `
                <div class="text-center">
                    <h4 class="text-lg font-semibold text-primary-100 mb-4">
                        <i class="fas fa-chart-line mr-2"></i>Thống Kê Kỷ Niệm
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white rounded-lg p-4 shadow-sm">
                            <div class="text-2xl font-bold text-primary-100">${timelineData.length}</div>
                            <div class="text-sm text-gray-600">Tổng kỷ niệm</div>
                        </div>
                        <div class="bg-white rounded-lg p-4 shadow-sm">
                            <div class="text-2xl font-bold text-accent-100">${new Date().getFullYear()}</div>
                            <div class="text-sm text-gray-600">Năm hiện tại</div>
                        </div>
                        <div class="bg-white rounded-lg p-4 shadow-sm">
                            <div class="text-2xl font-bold text-red-400">
                                <i class="fas fa-heart"></i>
                            </div>
                            <div class="text-sm text-gray-600">Tình yêu vĩnh cửu</div>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(statsDiv);
        }

        // Photos functions
        function generatePhotos() {
            const container = document.getElementById('photos-container');
            
            if (photosData.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 col-span-full">Chưa có ảnh nào</p>';
                return;
            }
            
            const startIndex = (currentPhotoPage - 1) * CONFIG.PHOTOS_PER_PAGE;
            const endIndex = startIndex + CONFIG.PHOTOS_PER_PAGE;
            const pagePhotos = photosData.slice(startIndex, endIndex);
            
            container.innerHTML = '';
            container.className = currentView === 'grid' ? 'photo-grid' : 'space-y-4';
            
            pagePhotos.forEach((photo, index) => {
                const photoElement = document.createElement('div');
                
                if (currentView === 'grid') {
                    // Tạo URL ảnh từ Google Drive với nhiều phương án dự phòng
                    const thumbnailUrl = `https://drive.google.com/thumbnail?id=${photo.id}&sz=w400-h400`;
                    const directUrl = `https://drive.google.com/uc?export=view&id=${photo.id}`;
                    const fallbackUrl = `https://lh3.googleusercontent.com/d/${photo.id}=w400-h400`;
                    
                    photoElement.className = 'photo-item bg-white rounded-lg shadow-md overflow-hidden cursor-pointer relative';
                    photoElement.innerHTML = `
                        <img src="${thumbnailUrl}" alt="${photo.name}" class="w-full h-48 object-cover" 
                             onerror="this.src='${fallbackUrl}'; this.onerror=null;">
                        <div class="absolute bottom-2 right-2 bg-black bg-opacity-70 text-white px-2 py-1 rounded-lg text-xs flex items-center space-x-2">
                            <span class="flex items-center">
                                <i class="fas fa-heart text-red-400 mr-1"></i>
                                ${getPhotoLikes(photo.name)}
                            </span>
                            <span class="flex items-center">
                                <i class="fas fa-comment text-blue-400 mr-1"></i>
                                ${getPhotoCommentsCount(photo.name)}
                            </span>
                        </div>
                    `;
                    
                    // Store direct URL for modal
                    photoElement.dataset.directUrl = directUrl;
                } else {
                    // Tạo URL ảnh từ Google Drive cho list view
                    const thumbnailUrl = `https://drive.google.com/thumbnail?id=${photo.id}&sz=w400-h400`;
                    const directUrl = `https://drive.google.com/uc?export=view&id=${photo.id}`;
                    const fallbackUrl = `https://lh3.googleusercontent.com/d/${photo.id}=w400-h400`;
                    
                    photoElement.className = 'photo-item bg-white rounded-lg shadow-md p-4 flex items-center space-x-4 cursor-pointer';
                    photoElement.innerHTML = `
                        <img src="${thumbnailUrl}" alt="${photo.name}" class="w-16 h-16 object-cover rounded" 
                             onerror="this.src='${fallbackUrl}'; this.onerror=null;">
                        <div class="flex-1">
                            <h4 class="font-semibold text-primary-100">${photo.name}</h4>
                            <div class="flex items-center space-x-4 mt-1 text-sm text-gray-600">
                                <span><i class="fas fa-heart text-red-500"></i> ${getPhotoLikes(photo.name)}</span>
                                <span><i class="fas fa-comment text-primary-100"></i> ${getPhotoCommentsCount(photo.name)}</span>
                            </div>
                        </div>
                    `;
                    
                    // Store direct URL for modal
                    photoElement.dataset.directUrl = directUrl;
                }
                
                photoElement.onclick = () => openPhotoModal(photo, photoElement);
                container.appendChild(photoElement);
            });
            
            generatePagination();
        }

        function generatePagination() {
            const totalPages = Math.ceil(photosData.length / CONFIG.PHOTOS_PER_PAGE);
            const pagination = document.getElementById('pagination');
            
            pagination.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            // Previous button
            if (currentPhotoPage > 1) {
                const prevBtn = document.createElement('button');
                prevBtn.className = 'px-3 py-2 rounded-lg bg-primary-100 text-white hover:bg-primary-80';
                prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
                prevBtn.onclick = () => changePage(currentPhotoPage - 1);
                pagination.appendChild(prevBtn);
            }
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPhotoPage - 2 && i <= currentPhotoPage + 2)) {
                    const pageBtn = document.createElement('button');
                    pageBtn.className = `px-3 py-2 rounded-lg ${
                        i === currentPhotoPage 
                            ? 'bg-primary-100 text-white' 
                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                    }`;
                    pageBtn.textContent = i;
                    pageBtn.onclick = () => changePage(i);
                    pagination.appendChild(pageBtn);
                } else if (i === currentPhotoPage - 3 || i === currentPhotoPage + 3) {
                    const dots = document.createElement('span');
                    dots.className = 'px-2 py-2 text-gray-500';
                    dots.textContent = '...';
                    pagination.appendChild(dots);
                }
            }
            
            // Next button
            if (currentPhotoPage < totalPages) {
                const nextBtn = document.createElement('button');
                nextBtn.className = 'px-3 py-2 rounded-lg bg-primary-100 text-white hover:bg-primary-80';
                nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
                nextBtn.onclick = () => changePage(currentPhotoPage + 1);
                pagination.appendChild(nextBtn);
            }
        }

        function changePage(page) {
            currentPhotoPage = page;
            generatePhotos();
        }

        function toggleView(view) {
            currentView = view;
            
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('bg-primary-100', 'text-white');
                btn.classList.add('bg-gray-300', 'text-gray-600');
            });
            
            document.getElementById(`${view}-btn`).classList.remove('bg-gray-300', 'text-gray-600');
            document.getElementById(`${view}-btn`).classList.add('bg-primary-100', 'text-white');
            
            generatePhotos();
        }

        // Modal functions
        function openPhotoModal(photo, element = null) {
            currentPhotoId = photo.name;
            
            document.getElementById('modal-title').textContent = photo.name;
            
            // Sử dụng directUrl từ element hoặc tạo mới từ photo.id
            let directUrl;
            if (element && element.dataset.directUrl) {
                directUrl = element.dataset.directUrl;
            } else {
                directUrl = `https://drive.google.com/uc?export=view&id=${photo.id}`;
            }
            
            const modalImage = document.getElementById('modal-image');
            modalImage.src = directUrl;
            
            // Fallback nếu ảnh chất lượng cao không tải được
            modalImage.onerror = function() {
                this.src = `https://lh3.googleusercontent.com/d/${photo.id}=w800-h800`;
                this.onerror = null;
            };
            
            const likeCount = getPhotoLikes(photo.name);
            document.getElementById('like-count').textContent = likeCount;
            
            loadComments(photo.name);
            
            document.getElementById('photo-modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('photo-modal').classList.remove('active');
            currentPhotoId = null;
        }

        function loadComments(photoName) {
            const container = document.getElementById('comments-container');
            const comments = getPhotoComments(photoName);
            
            container.innerHTML = '';
            
            if (comments.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center">Chưa có bình luận nào</p>';
                return;
            }
            
            comments.forEach(comment => {
                const commentElement = document.createElement('div');
                commentElement.className = 'bg-gray-50 rounded-lg p-3';
                const commentDate = new Date(comment.date_input).toLocaleString('vi-VN');
                commentElement.innerHTML = `
                    <div class="flex items-center space-x-2 mb-1">
                        <i class="fas fa-user-circle text-primary-100"></i>
                        <span class="font-semibold text-sm">Ẩn danh</span>
                        <span class="text-xs text-gray-500">${commentDate}</span>
                    </div>
                    <p class="text-gray-700">${comment.comment}</p>
                `;
                container.appendChild(commentElement);
            });
        }

        async function likePhoto() {
            if (!currentPhotoId) return;
            
            const button = document.getElementById('like-btn');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Đang xử lý...';
            button.disabled = true;
            
            try {
                let photoData = commentsData.find(item => item.ID_IMG === currentPhotoId);
                
                if (!photoData) {
                    photoData = {
                        ID_IMG: currentPhotoId,
                        count_tim: 0,
                        comments: []
                    };
                    commentsData.push(photoData);
                }
                
                photoData.count_tim++;
                document.getElementById('like-count').textContent = photoData.count_tim;
                
                // Save to GitHub
                await saveToGitHub(CONFIG.COMMENTS_FILE_PATH, commentsData, `Thích ảnh: ${currentPhotoId}`);
                
                // Update the photo grid
                generatePhotos();
                
                // Log activity
                logActivity('Thích ảnh', `Đã thích ảnh: ${currentPhotoId} (${photoData.count_tim} lượt thích)`);
                showNotification('Đã thích ảnh!', 'success');
                
            } catch (error) {
                console.error('Lỗi khi thích ảnh:', error);
                logActivity('Lỗi thích ảnh', error.message);
                showNotification('Lỗi khi thích ảnh!', 'error');
            } finally {
                button.innerHTML = '<i class="fas fa-heart text-red-100 mr-2"></i><span id="like-count">' + getPhotoLikes(currentPhotoId) + '</span>';
                button.disabled = false;
            }
        }

        async function addComment() {
            if (!currentPhotoId) return;
            
            const input = document.getElementById('comment-input');
            const commentText = input.value.trim();
            
            if (!commentText) {
                showNotification('Vui lòng nhập nội dung bình luận!', 'warning');
                return;
            }
            
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            button.disabled = true;
            input.disabled = true;
            
            try {
                let photoData = commentsData.find(item => item.ID_IMG === currentPhotoId);
                
                if (!photoData) {
                    photoData = {
                        ID_IMG: currentPhotoId,
                        count_tim: 0,
                        comments: []
                    };
                    commentsData.push(photoData);
                }
                
                const newComment = {
                    comment: commentText,
                    date_input: new Date().toISOString()
                };
                
                photoData.comments.push(newComment);
                
                // Save to GitHub
                await saveToGitHub(CONFIG.COMMENTS_FILE_PATH, commentsData, `Thêm bình luận cho ảnh: ${currentPhotoId}`);
                
                input.value = '';
                loadComments(currentPhotoId);
                generatePhotos();
                
                // Log activity
                logActivity('Thêm bình luận', `Đã bình luận cho ảnh: ${currentPhotoId}: "${commentText}"`);
                showNotification('Đã thêm bình luận!', 'success');
                
            } catch (error) {
                console.error('Lỗi khi thêm bình luận:', error);
                logActivity('Lỗi thêm bình luận', error.message);
                showNotification('Lỗi khi thêm bình luận!', 'error');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
                input.disabled = false;
            }
        }

        // New functions for share and download
        function sharePhoto() {
            if (!currentPhotoId) return;
            
            const photoUrl = document.getElementById('modal-image').src;
            document.getElementById('share-link').value = photoUrl;
            document.getElementById('share-modal').classList.add('active');
            
            logActivity('Mở modal chia sẻ', `Mở modal chia sẻ cho ảnh: ${currentPhotoId}`);
        }

        function closeShareModal() {
            document.getElementById('share-modal').classList.remove('active');
            document.getElementById('qr-code-container').classList.add('hidden');
            document.getElementById('qr-code').innerHTML = '';
        }

        function copyShareLink() {
            const shareLink = document.getElementById('share-link');
            shareLink.select();
            shareLink.setSelectionRange(0, 99999);
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(shareLink.value).then(() => {
                    showNotification('Đã sao chép link ảnh!', 'success');
                    logActivity('Sao chép link', `Đã sao chép link ảnh: ${currentPhotoId}`);
                });
            } else {
                document.execCommand('copy');
                showNotification('Đã sao chép link ảnh!', 'success');
                logActivity('Sao chép link', `Đã sao chép link ảnh: ${currentPhotoId}`);
            }
        }

        function shareToFacebook() {
            const url = document.getElementById('share-link').value;
            const shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
            window.open(shareUrl, '_blank', 'width=600,height=400');
            logActivity('Chia sẻ Facebook', `Chia sẻ ảnh ${currentPhotoId} lên Facebook`);
        }

        function shareToTwitter() {
            const url = document.getElementById('share-link').value;
            const text = `Xem ảnh đẹp: ${currentPhotoId} - Love Story`;
            const shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`;
            window.open(shareUrl, '_blank', 'width=600,height=400');
            logActivity('Chia sẻ Twitter', `Chia sẻ ảnh ${currentPhotoId} lên Twitter`);
        }

        function shareToTelegram() {
            const url = document.getElementById('share-link').value;
            const text = `Xem ảnh đẹp: ${currentPhotoId}`;
            const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`;
            window.open(shareUrl, '_blank', 'width=600,height=400');
            logActivity('Chia sẻ Telegram', `Chia sẻ ảnh ${currentPhotoId} lên Telegram`);
        }

        function shareToWhatsApp() {
            const url = document.getElementById('share-link').value;
            const text = `Xem ảnh đẹp: ${currentPhotoId}\n${url}`;
            const shareUrl = `https://wa.me/?text=${encodeURIComponent(text)}`;
            window.open(shareUrl, '_blank', 'width=600,height=400');
            logActivity('Chia sẻ WhatsApp', `Chia sẻ ảnh ${currentPhotoId} lên WhatsApp`);
        }

        function shareToLinkedIn() {
            const url = document.getElementById('share-link').value;
            const shareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}`;
            window.open(shareUrl, '_blank', 'width=600,height=400');
            logActivity('Chia sẻ LinkedIn', `Chia sẻ ảnh ${currentPhotoId} lên LinkedIn`);
        }

        function shareToEmail() {
            const url = document.getElementById('share-link').value;
            const subject = `Love Story - Khoảnh khắc đẹp: ${currentPhotoId}`;
            const body = `Xin chào,\n\nTôi muốn chia sẻ với bạn một khoảnh khắc đẹp từ Love Story:\n\n${currentPhotoId}\n\nXem ảnh tại: ${url}\n\nTrân trọng!`;
            const mailtoUrl = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(mailtoUrl, '_blank');
            logActivity('Chia sẻ Email', `Chia sẻ ảnh ${currentPhotoId} qua Email`);
        }

        function generateQRCode() {
            const url = document.getElementById('share-link').value;
            const qrContainer = document.getElementById('qr-code');
            const qrCodeContainer = document.getElementById('qr-code-container');
            
            // Simple QR code generation using Google Charts API
            const qrSize = 150;
            const qrUrl = `https://chart.googleapis.com/chart?chs=${qrSize}x${qrSize}&cht=qr&chl=${encodeURIComponent(url)}`;
            
            qrContainer.innerHTML = `<img src="${qrUrl}" alt="QR Code" class="border rounded-lg">`;
            qrCodeContainer.classList.remove('hidden');
            
            logActivity('Tạo mã QR', `Tạo mã QR cho ảnh: ${currentPhotoId}`);
        }

        function downloadPhoto() {
            if (!currentPhotoId) return;
            
            const photoUrl = document.getElementById('modal-image').src;
            
            // Create a temporary link element
            const link = document.createElement('a');
            link.href = photoUrl;
            link.download = currentPhotoId;
            link.target = '_blank';
            
            // Trigger download
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            logActivity('Tải ảnh', `Đã tải ảnh: ${currentPhotoId}`);
            showNotification('Đang tải ảnh...', 'info');
        }

        // Event handlers
        function showAddEventModal() {
            currentEditingEventIndex = null;
            document.getElementById('event-modal-title').textContent = 'Thêm sự kiện mới';
            document.getElementById('event-name').value = '';
            document.getElementById('event-date').value = '';
            document.getElementById('event-description').value = '';
            document.getElementById('event-modal').classList.add('active');
        }

        function editEvent(index) {
            currentEditingEventIndex = index;
            const event = timelineData[index];
            
            document.getElementById('event-modal-title').textContent = 'Chỉnh sửa sự kiện';
            document.getElementById('event-name').value = event.name || '';
            
            // Convert date format from DD-MM-YYYY to YYYY-MM-DD for input[type="date"]
            const [day, month, year] = event.day.split('-');
            document.getElementById('event-date').value = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            
            document.getElementById('event-description').value = event.contdetl || '';
            document.getElementById('event-modal').classList.add('active');
        }

        function viewEventPhotos(index) {
            showSection('photos');
        }

        function deleteEvent(index) {
            currentDeletingEventIndex = index;
            const event = timelineData[index];
            document.getElementById('delete-event-name').textContent = event.name || 'Sự kiện không có tên';
            document.getElementById('delete-modal').classList.add('active');
        }

        function closeEventModal() {
            document.getElementById('event-modal').classList.remove('active');
            currentEditingEventIndex = null;
        }

        function closeDeleteModal() {
            document.getElementById('delete-modal').classList.remove('active');
            currentDeletingEventIndex = null;
        }

        async function confirmDeleteEvent() {
            if (currentDeletingEventIndex === null) return;
            
            try {
                const deletedEvent = timelineData[currentDeletingEventIndex];
                timelineData.splice(currentDeletingEventIndex, 1);
                
                // Save to GitHub
                await saveToGitHub(CONFIG.FILE_PATH, timelineData, `Xóa sự kiện: ${deletedEvent.name || 'Không có tên'}`);
                
                // Update UI
                generateTimeline();
                generateCalendar();
                closeDeleteModal();
                
                logActivity('Xóa sự kiện', `Đã xóa sự kiện: ${deletedEvent.name || 'Không có tên'}`);
                showNotification('Đã xóa sự kiện thành công!', 'success');
            } catch (error) {
                console.error('Lỗi xóa sự kiện:', error);
                logActivity('Lỗi xóa sự kiện', error.message);
                showNotification('Lỗi khi xóa sự kiện!', 'error');
            }
        }

        // Handle event form submission
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('event-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const name = document.getElementById('event-name').value.trim();
                const date = document.getElementById('event-date').value;
                const description = document.getElementById('event-description').value.trim();
                
                if (!name || !date) {
                    showNotification('Vui lòng nhập đầy đủ tên sự kiện và ngày!', 'warning');
                    return;
                }
                
                // Convert date format from YYYY-MM-DD to DD-MM-YYYY
                const [year, month, day] = date.split('-');
                const formattedDate = `${day}-${month}-${year}`;
                
                const eventData = {
                    note_id: currentEditingEventIndex !== null ? timelineData[currentEditingEventIndex].note_id : Date.now(),
                    name: name,
                    day: formattedDate,
                    contdetl: description
                };
                
                try {
                    if (currentEditingEventIndex !== null) {
                        // Edit existing event
                        timelineData[currentEditingEventIndex] = eventData;
                        logActivity('Sửa sự kiện', `Đã cập nhật sự kiện: ${name}`);
                    } else {
                        // Add new event
                        timelineData.push(eventData);
                        logActivity('Thêm sự kiện', `Đã thêm sự kiện mới: ${name}`);
                    }
                    
                    // Sort timeline by date
                    timelineData.sort((a, b) => {
                        const dateA = parseDate(a.day);
                        const dateB = parseDate(b.day);
                        return dateA - dateB;
                    });
                    
                    // Save to GitHub
                    const commitMessage = currentEditingEventIndex !== null 
                        ? `Cập nhật sự kiện: ${name}` 
                        : `Thêm sự kiện mới: ${name}`;
                    
                    await saveToGitHub(CONFIG.FILE_PATH, timelineData, commitMessage);
                    
                    // Update UI
                    generateTimeline();
                    generateCalendar();
                    closeEventModal();
                    
                    const successMessage = currentEditingEventIndex !== null 
                        ? 'Đã cập nhật sự kiện thành công!' 
                        : 'Đã thêm sự kiện mới thành công!';
                    showNotification(successMessage, 'success');
                    
                } catch (error) {
                    console.error('Lỗi lưu sự kiện:', error);
                    logActivity('Lỗi lưu sự kiện', error.message);
                    showNotification('Lỗi khi lưu sự kiện!', 'error');
                }
            });
        });

        // Auto sync function
        function setupAutoSync() {
            const now = new Date();
            const [hours, minutes] = CONFIG.AUTO_SYNC_METADATA.time.split(':');
            const syncTime = new Date();
            syncTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);
            
            if (syncTime <= now) {
                syncTime.setDate(syncTime.getDate() + 1);
            }
            
            const timeUntilSync = syncTime.getTime() - now.getTime();
            
            setTimeout(() => {
                autoSyncData();
                setInterval(autoSyncData, 24 * 60 * 60 * 1000); // Daily
            }, timeUntilSync);
        }

        async function autoSyncData() {
            if (!settings.autoSync) return;
            
            console.log('Đang đồng bộ dữ liệu tự động...');
            logActivity('Đồng bộ tự động', 'Bắt đầu đồng bộ dữ liệu theo lịch trình');
            
            try {
                await loadPhotosData();
                generatePhotos();
                
                settings.lastSyncTime = new Date().toISOString();
                updateLastSyncTime();
                saveSettings();
                
                logActivity('Đồng bộ tự động', 'Đồng bộ dữ liệu thành công');
                console.log('Đồng bộ dữ liệu thành công!');
            } catch (error) {
                logActivity('Lỗi đồng bộ tự động', error.message);
                console.error('Lỗi đồng bộ dữ liệu:', error);
            }
        }

        // Close modal when clicking outside
        document.getElementById('photo-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        document.getElementById('event-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEventModal();
            }
        });

        document.getElementById('delete-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeDeleteModal();
            }
        });

        document.getElementById('share-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeShareModal();
            }
        });

        // Handle comment input enter key
        document.getElementById('comment-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addComment();
            }
        });

        // Settings functions
        function logActivity(action, details = '') {
            if (!settings.activityLogging) return;
            
            const logEntry = {
                timestamp: new Date().toISOString(),
                action: action,
                details: details,
                id: Date.now()
            };
            
            activityLogs.unshift(logEntry);
            
            // Giới hạn số lượng log (giữ 1000 bản ghi gần nhất)
            if (activityLogs.length > 1000) {
                activityLogs = activityLogs.slice(0, 1000);
            }
            
            updateLogCount();
        }

        function updateLogCount() {
            const totalLogsElement = document.getElementById('total-logs');
            if (totalLogsElement) {
                totalLogsElement.textContent = activityLogs.length;
            }
        }

        function updateLastSyncTime() {
            const lastSyncElement = document.getElementById('last-sync-time');
            if (lastSyncElement && settings.lastSyncTime) {
                lastSyncElement.textContent = new Date(settings.lastSyncTime).toLocaleString('vi-VN');
            }
        }

        async function manualSync() {
            const button = event.target;
            const originalText = button.innerHTML;
            
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Đang đồng bộ...';
            button.disabled = true;
            
            try {
                await loadPhotosData();
                generatePhotos();
                
                settings.lastSyncTime = new Date().toISOString();
                updateLastSyncTime();
                
                logActivity('Đồng bộ thủ công', 'Đồng bộ dữ liệu ảnh thành công');
                
                showNotification('Đồng bộ thành công!', 'success');
            } catch (error) {
                console.error('Lỗi đồng bộ:', error);
                logActivity('Lỗi đồng bộ', error.message);
                showNotification('Đồng bộ thất bại!', 'error');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        function showSyncHistory() {
            const syncLogs = activityLogs.filter(log => 
                log.action.includes('đồng bộ') || log.action.includes('Đồng bộ')
            );
            
            if (syncLogs.length === 0) {
                showNotification('Chưa có lịch sử đồng bộ', 'info');
                return;
            }
            
            let historyHtml = '<div class="space-y-2">';
            syncLogs.slice(0, 10).forEach(log => {
                historyHtml += `
                    <div class="bg-gray-50 p-3 rounded">
                        <div class="font-medium">${log.action}</div>
                        <div class="text-sm text-gray-600">${new Date(log.timestamp).toLocaleString('vi-VN')}</div>
                        ${log.details ? `<div class="text-sm text-gray-500">${log.details}</div>` : ''}
                    </div>
                `;
            });
            historyHtml += '</div>';
            
            showModal('Lịch Sử Đồng Bộ', historyHtml);
        }

        function viewActivityLogs() {
            if (activityLogs.length === 0) {
                showNotification('Chưa có nhật ký hoạt động', 'info');
                return;
            }
            
            let logsHtml = '<div class="space-y-2 max-h-96 overflow-y-auto">';
            activityLogs.slice(0, 50).forEach(log => {
                logsHtml += `
                    <div class="bg-gray-50 p-3 rounded">
                        <div class="flex justify-between items-start">
                            <div class="font-medium">${log.action}</div>
                            <div class="text-xs text-gray-500">${new Date(log.timestamp).toLocaleString('vi-VN')}</div>
                        </div>
                        ${log.details ? `<div class="text-sm text-gray-600 mt-1">${log.details}</div>` : ''}
                    </div>
                `;
            });
            logsHtml += '</div>';
            
            showModal('Nhật Ký Hoạt Động', logsHtml);
        }

        function exportLogs() {
            if (activityLogs.length === 0) {
                showNotification('Không có dữ liệu để xuất', 'warning');
                return;
            }
            
            const dataStr = JSON.stringify(activityLogs, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `love-story-logs-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            logActivity('Xuất nhật ký', 'Xuất file nhật ký thành công');
            showNotification('Đã xuất file nhật ký!', 'success');
        }

        function clearLogs() {
            if (confirm('Bạn có chắc chắn muốn xóa tất cả nhật ký hoạt động?')) {
                const count = activityLogs.length;
                activityLogs = [];
                updateLogCount();
                showNotification(`Đã xóa ${count} bản ghi nhật ký`, 'success');
            }
        }

        function showNotification(message, type = 'info') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-4 py-2 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function showModal(title, content) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl max-w-2xl max-h-[80vh] overflow-auto m-4 w-full">
                    <div class="p-4 border-b flex justify-between items-center">
                        <h3 class="text-xl font-bold text-primary-100">${title}</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div class="p-4">
                        ${content}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Initialize settings on load
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved settings from localStorage
            const savedSettings = localStorage.getItem('loveStorySettings');
            if (savedSettings) {
                settings = { ...settings, ...JSON.parse(savedSettings) };
            }
            
            // Load saved logs from localStorage
            const savedLogs = localStorage.getItem('loveStoryLogs');
            if (savedLogs) {
                activityLogs = JSON.parse(savedLogs);
            }
            
            // Update UI
            updateLogCount();
            updateLastSyncTime();
            
            // Set toggle states
            document.getElementById('auto-sync-toggle').checked = settings.autoSync;
            document.getElementById('activity-log-toggle').checked = settings.activityLogging;
            
            // Add event listeners for toggles
            document.getElementById('auto-sync-toggle').addEventListener('change', function() {
                settings.autoSync = this.checked;
                saveSettings();
                logActivity('Cài đặt', `${this.checked ? 'Bật' : 'Tắt'} tự động đồng bộ`);
            });
            
            document.getElementById('activity-log-toggle').addEventListener('change', function() {
                settings.activityLogging = this.checked;
                saveSettings();
                if (this.checked) {
                    logActivity('Cài đặt', 'Bật ghi nhật ký hoạt động');
                }
            });
        });

        function saveSettings() {
            localStorage.setItem('loveStorySettings', JSON.stringify(settings));
        }

        function saveLogs() {
            localStorage.setItem('loveStoryLogs', JSON.stringify(activityLogs));
        }

        // Save logs periodically
        setInterval(saveLogs, 30000); // Save every 30 seconds

        // Timeline toggle functions
        function toggleTimeDisplay(element, shortTime, detailedTime) {
            const isShowingShort = element.textContent.trim() === shortTime;
            element.textContent = isShowingShort ? detailedTime : shortTime;
        }

        function toggleDescription(titleElement) {
            const descriptionElement = titleElement.nextElementSibling;
            if (descriptionElement && descriptionElement.classList.contains('description-content')) {
                descriptionElement.classList.toggle('hidden');
                
                // Add visual indicator
                const isHidden = descriptionElement.classList.contains('hidden');
                titleElement.innerHTML = titleElement.innerHTML.replace(/(<i[^>]*><\/i>\s*)?$/, '') + 
                    (isHidden ? ' <i class="fas fa-chevron-down text-sm"></i>' : ' <i class="fas fa-chevron-up text-sm"></i>');
            }
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98b4f479d0673d96',t:'MTc1OTkxOTM0My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
