	<!doctype html>
	<html lang="vi" class="h-100">
	 <head>
	  <meta charset="UTF-8">
	  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	  <title>Social Memory</title>
	  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
	  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css">
	  <style>
	  
		@import url('https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap');
		
		body {
		  box-sizing: border-box;
		  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
		}
		
		:root {
			--primary-color: #4ade80;
			--primary-dark: #22c55e;
			--secondary-color: #f0fdf4;
			--text-dark: #1f2937;
			--text-light: #6b7280;
			--bg-color: #f3f4f6;
			--card-bg: #ffffff;
			
			/* 2. Cấu hình font chữ mới ở đây */
			--font-family: 'Patrick Hand', cursive; 
			
			--shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
			--shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
			--shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
			--radius: 1rem;
		}
		
		html, body {
		  height: 100%;
		  margin: 0;
		  padding: 0;
		}
		
		#app {
		  display: flex;
		  flex-direction: column;
		  height: 100%;
		  width: 100%;
		  background-color: var(--bg-color);
		}
		
		.app-header {
		  background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
		  color: white;
		  padding: 0.5rem;
		  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
		}
		
		.main-content {
		  flex: 1;
		  overflow-y: auto;
		  overflow-x: hidden;
		}
		
		.bottom-nav {
		  background: var(--surface-color);
		  border-top: 1px solid #dee2e6;
		  box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
		}
		
		.nav-link {
		  color: #6c757d;
		  transition: color 0.2s;
		}
		
		.nav-link.active {
		  color: var(--primary-color);
		}
		
		.stat-card {
		  background: var(--surface-color);
		  border-radius: 1rem;
		  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
		  transition: transform 0.2s;
		  position: relative;
		}
		
		.stat-card:active {
		  transform: scale(0.98);
		}
		
		.post-card, .memory-card, .album-card {
		  background: var(--surface-color);
		  border-radius: 1rem;
		  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
		  margin-bottom: 1rem;
		}
		
		.btn-primary {
		  background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
		  border: none;
		}
		
		.btn-primary:hover {
		  opacity: 0.9;
		}
		
		.fab-btn {
		  position: fixed;
		  bottom: 80px;
		  right: 20px;
		  width: 56px;
		  height: 56px;
		  border-radius: 50%;
		  background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
		  color: white;
		  border: none;
		  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
		  z-index: 1000;
		}
		
		.fab-btn:active {
		  transform: scale(0.9);
		}
		
		.modal-content {
		  border-radius: 1.5rem;
		  border: none;
		}
		
		.modal-header {
		  border-bottom: 1px solid #dee2e6;
		  border-radius: 1.5rem 1.5rem 0 0;
		}
		
		.avatar-circle {
		  width: 48px;
		  height: 48px;
		  border-radius: 50%;
		  border: 3px solid var(--primary-color);
		  display: flex;
		  align-items: center;
		  justify-content: center;
		  background: white;
		  overflow: hidden;
		}
		
		.avatar-circle-sm {
		  width: 40px;
		  height: 40px;
		}
		
		.avatar-circle-lg {
		  width: 96px;
		  height: 96px;
		}
		
		.theme-bg-primary {
		  background-color: var(--primary-color);
		}
		
		.theme-bg-secondary {
		  background-color: var(--secondary-color);
		}
		
		.theme-text-primary {
		  color: var(--primary-color);
		}
		
		.theme-text-secondary {
		  color: var(--secondary-color);
		}
		
		.icon-box {
		  width: 56px;
		  height: 56px;
		  border-radius: 50%;
		  display: flex;
		  align-items: center;
		  justify-content: center;
		}
		
		.icon-box-sm {
		  width: 48px;
		  height: 48px;
		}
		
		.post-image-grid {
		  display: grid;
		  gap: 0.5rem;
		  border-radius: 1rem;
		  overflow: hidden;
		}
		
		.post-image-grid.grid-1 {
		  grid-template-columns: 1fr;
		}
		
		.post-image-grid.grid-2 {
		  grid-template-columns: 1fr 1fr;
		}
		
		.post-image-grid.grid-3 {
		  grid-template-columns: repeat(2, 1fr);
		  grid-template-rows: repeat(2, 150px);
		}
		
		.post-image-grid.grid-3 img:first-child {
		  grid-column: span 2;
		}
		
		.post-image-grid.grid-4 {
		  grid-template-columns: repeat(2, 1fr);
		  grid-template-rows: repeat(2, 150px);
		}
		
		.post-image-grid.grid-5plus {
		  grid-template-columns: repeat(3, 1fr);
		  grid-template-rows: repeat(2, 150px);
		}
		
		.post-image-grid.grid-5plus img:first-child {
		  grid-column: span 2;
		  grid-row: span 2;
		}
		
		.post-image-grid img {
		  width: 100%;
		  height: 100%;
		  object-fit: cover;
		}
		
		.image-counter-overlay {
		  position: absolute;
		  inset: 0;
		  background: rgba(0,0,0,0.6);
		  display: flex;
		  align-items: center;
		  justify-content: center;
		  color: white;
		  font-size: 2rem;
		  font-weight: bold;
		}
		
		.theme-option {
		  width: 120px;
		  height: 30px;
		  border-radius: 0.5rem;
		  border: 3px solid transparent;
		  cursor: pointer;
		  transition: all 0.2s;
		}
		
		.theme-option.selected {
		  border-color: var(--primary-color);
		}
		
		.layout-preview-box {
		  padding: 0.5rem;
		  border: 2px solid #dee2e6;
		  border-radius: 0.5rem;
		  cursor: pointer;
		  transition: all 0.2s;
		}
		
		.layout-preview-box.selected {
		  border-color: var(--primary-color);
		  background: rgba(0, 107, 104, 0.05);
		}
		
		.layout-grid-visual {
		  height: 80px;
		  display: grid;
		  gap: 4px;
		  background: #e9ecef;
		  border-radius: 0.25rem;
		  padding: 4px;
		}
		
		.layout-grid-visual > div {
		  background: #6c757d;
		  border-radius: 0.25rem;
		}
		
		.edit-mode-banner {
		  background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
		  color: white;
		  padding: 1rem;
		  text-align: center;
		}
		
		.drag-handle {
		  position: absolute;
		  top: 0.5rem;
		  left: 0.5rem;
		  width: 32px;
		  height: 32px;
		  background: var(--primary-color);
		  border-radius: 0.5rem;
		  color: white;
		  display: none;
		  align-items: center;
		  justify-content: center;
		  cursor: move;
		  z-index: 10;
		}
		
		.size-toggle {
		  position: absolute;
		  bottom: 0.5rem;
		  right: 0.5rem;
		  width: 32px;
		  height: 32px;
		  background: #6f42c1;
		  border-radius: 0.5rem;
		  color: white;
		  display: none;
		  align-items: center;
		  justify-content: center;
		  cursor: pointer;
		  z-index: 10;
		}
		
		.layout-edit-mode .drag-handle,
		.layout-edit-mode .size-toggle {
		  display: flex;
		}
		
		.stat-card.dragging {
		  opacity: 0.5;
		}
		
		.stat-card.size-small {
		  transform: scale(0.85);
		  margin: -0.5rem 0;
		}
		
		.stat-card.size-medium {
		  transform: scale(1);
		}
		
		.stat-card.size-large {
		  transform: scale(1.15);
		  margin: 1rem 0;
		}
		
		.stats-container {
		  display: grid;
		  grid-template-columns: 1fr;
		  gap: 1rem;
		}
		
		.stats-container.two-columns {
		  grid-template-columns: 1fr 1fr;
		  gap: 0.75rem;
		}
		
		.like-btn.active {
		  color: #dc3545;
		}
		
		@keyframes heartBeat {
		  0%, 100% { transform: scale(1); }
		  25% { transform: scale(1.2); }
		  50% { transform: scale(1.1); }
		}
		
		.like-btn.active {
		  animation: heartBeat 0.3s ease;
		}
		
		.notification-item {
		  border-bottom: 1px solid #dee2e6;
		  transition: background 0.2s;
		}
		
		.notification-item:hover {
		  background: #f8f9fa;
		}
		
		.notification-item.unread {
		  background: #e7f3ff;
		}
		
		.notification-dot {
		  width: 8px;
		  height: 8px;
		  background: #dc3545;
		  border-radius: 50%;
		}
		
		
		/* --- SỬA LỖI MODAL CHỒNG NHAU (FINAL FIX) --- */

		/* 1. CẤU HÌNH CHO LỚP NỀN ĐẦU TIÊN (MẶC ĐỊNH) */
		/* Áp dụng cho Modal Full màn hình -> KHÔNG MỜ, KHÔNG CHE NỘI DUNG */
		.modal-backdrop.show {
			opacity: 0.5 !important;           /* Độ tối bình thường */
			background-color: #000 !important;
			z-index: 1050 !important;          /* Nằm dưới Modal Full (1055) */
			backdrop-filter: none !important;  /* TẮT HOÀN TOÀN HIỆU ỨNG MỜ */
			-webkit-backdrop-filter: none !important;
		}

		/* 2. CẤU HÌNH CHO LỚP NỀN THỨ 2 TRỞ ĐI (QUAN TRỌNG) */
		/* Dùng dấu ~ để chọn "lớp nền nằm sau một lớp nền khác" -> Chính là cái thứ 2 */
		.modal-backdrop.show ~ .modal-backdrop.show {
			z-index: 1060 !important;          /* Đè lên Modal Full (1055) */
			opacity: 0.9 !important;           /* Tối đen hơn để nổi bật Modal nhỏ */
			backdrop-filter: blur(5px) !important; /* LÀM MỜ NỘI DUNG BÊN DƯỚI */
			-webkit-backdrop-filter: blur(5px);
		}

		/* 3. ĐƯA MODAL NHỎ (THÊM LƯỢT ĐẠP) LÊN CAO NHẤT */
		#addBikeEntryModal {
			z-index: 1070 !important;          /* Cao hơn lớp nền thứ 2 (1060) */
		}

		/* 4. TRANG TRÍ MODAL NHỎ (VIỀN & BÓNG) */
		#addBikeEntryModal .modal-content {
			border: 1px solid rgba(255, 255, 255, 0.2);
			box-shadow: 0 20px 60px rgba(0,0,0,0.8) !important;
		}

		/* --- CSS BỐ CỤC ẢNH (MỚI) --- */
		.post-image-grid {
			display: grid;
			gap: 4px;
			width: 100%;
			border-radius: 12px;
			overflow: hidden;
		}

		/* 1 ảnh: Full */
		.post-image-grid.layout-1 { grid-template-columns: 1fr; }

		/* 2 ảnh: Chia đôi */
		.post-image-grid.layout-2 { grid-template-columns: 1fr 1fr; height: 250px; }

		/* Bố cục: 1 NGANG (1-wide) - Dùng cho 3 ảnh trở lên */
		.post-image-grid.layout-1-wide {
			grid-template-columns: repeat(2, 1fr);
			grid-template-rows: 200px 150px; /* Hàng trên to, hàng dưới nhỏ */
		}
		.post-image-grid.layout-1-wide .img-box:first-child {
			grid-column: span 2; /* Ảnh đầu nằm ngang hết 2 cột */
		}

		/* Bố cục: 1 DỌC (1-tall) - Dùng cho 3 ảnh trở lên */
		.post-image-grid.layout-1-tall {
			grid-template-columns: 2fr 1fr; /* Cột trái to gấp đôi cột phải */
			grid-template-rows: repeat(2, 150px);
		}
		.post-image-grid.layout-1-tall .img-box:first-child {
			grid-row: span 2; /* Ảnh đầu nằm dọc hết 2 hàng */
			height: 100%;
		}

		/* Bố cục: LƯỚI ĐỀU (2x2) */
		.post-image-grid.layout-grid-2x2 {
			grid-template-columns: repeat(2, 1fr);
			grid-template-rows: 200px 200px;
		}

		/* Style chung cho ảnh */
		.post-image-grid .img-box {
			position: relative;
			overflow: hidden;
			width: 100%;
			height: 100%;
		}
		.post-image-grid img {
			width: 100%;
			height: 100%;
			object-fit: cover;
			display: block;
		}
		.image-overlay {
			position: absolute;
			inset: 0;
			background: rgba(0,0,0,0.5);
			color: white;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 2rem;
			font-weight: bold;
		}
		
		/* --- CSS CHO LIGHTBOX (XEM ẢNH FULL) --- */
		.lightbox-item {
			width: 100%;
			background-color: #000; /* Nền đen để ảnh nổi bật */
			margin-bottom: 20px;    /* Khoảng cách giữa các ảnh */
			padding-bottom: 20px;   /* Khoảng đệm bên dưới */
			border-bottom: 1px solid #333; /* VIỀN NGĂN CÁCH MÀU XÁM */
			display: flex;
			justify-content: center;
			align-items: center;
		}

		/* Bỏ viền cho ảnh cuối cùng */
		.lightbox-item:last-child {
			border-bottom: none;
			margin-bottom: 0;
		}

		.lightbox-image {
			width: 100%;       /* Luôn rộng full màn hình */
			height: auto;      /* Chiều cao tự động theo tỉ lệ (không bị méo) */
			object-fit: contain; /* Đảm bảo ảnh hiển thị trọn vẹn */
			display: block;
			max-height: unset; /* Cho phép ảnh dài thoải mái để vuốt xem */
		}
		
		@keyframes pulse-opacity {
		  0% { opacity: 1; }
		  50% { opacity: 0.6; }
		  100% { opacity: 1; }
		}
		.animate-pulse {
		  animation: pulse-opacity 1.5s infinite;
		}

		/* Layout visual nhỏ gọn hơn */
		.layout-grid-visual.small-visual {
			height: 50px; /* Giảm chiều cao */
			gap: 2px;
		}
		.layout-preview-box {
			border: 1px solid #dee2e6; /* Viền mảnh hơn */
		}
		.layout-preview-box.selected {
			border-color: var(--primary-color);
			background-color: var(--secondary-color);
			box-shadow: 0 0 0 1px var(--primary-color);
		}

	  </style>
	  <style>@view-transition { navigation: auto; }</style>
	  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
	 </head>
	 <body class="h-100">
	  <div id="app">
	  <header class="app-header">
		<div class="d-flex align-items-center justify-content-between">
		 <div>
		  <h5 id="app-title" class="mb-0 fw-bold">Love Story</h5><small id="welcome-message" class="opacity-75">Lưu giữ kỷ niệm đẹp</small>
		 </div>
		 <div class="d-flex align-items-center gap-3"><button class="btn btn-link text-white p-0 position-relative" id="notification-btn"> <i class="bi bi-bell-fill fs-4"></i> <span id="notification-badge" class="position-absolute badge rounded-pill bg-danger d-none" style="font-size: 0.65rem; top: -5px; right: -8px;">0</span> </button> <button class="btn btn-link text-white p-0" id="profile-btn">
		   <div class="avatar-circle">
			<div id="header-avatar" class="w-100 h-100 d-flex align-items-center justify-content-center"><i class="bi bi-person-fill theme-text-primary fs-4"></i>
			</div>
		   </div></button>
		 </div>
		</div>
	   </header><div id="edit-mode-banner" class="edit-mode-banner d-none">
		<div class="fw-bold">
		 <i class="bi bi-pencil-fill me-2"></i>Chế độ chỉnh sửa bố cục
		</div><small class="d-block mt-1">Kéo <i class="bi bi-arrows-move"></i> để di chuyển • Nhấn <i class="bi bi-arrows-fullscreen"></i> để đổi kích thước</small>
		<div class="mt-2"><button class="btn btn-light btn-sm" id="exit-edit-mode">Xong</button>
		</div>
	   </div><main class="main-content"><div id="tab-feed" class="tab-pane h-100 d-none">
		 <div class="container py-3" id="posts-container">
		  <div class="text-center py-5"><i class="bi bi-newspaper theme-text-primary" style="font-size: 4rem;"></i>
		   <p class="fw-semibold fs-5 mt-3">Chưa có bài đăng</p>
		   <p class="text-muted">Nhấn + để tạo bài viết đầu tiên</p>
		  </div>
		 </div>
		</div><div id="tab-home" class="tab-pane h-100">
		 <div class="container py-3">
		  <div id="stats-container" class="stats-container pb-5"></div>
		 </div>
		</div><div id="tab-albums" class="tab-pane h-100 d-none">
		 <div class="container py-3">
		  <div class="row g-3 pb-5" id="albums-container">
		   <div class="col-12 text-center py-5"><i class="bi bi-folder theme-text-primary" style="font-size: 4rem;"></i>
			<p class="fw-semibold fs-5 mt-3">Chưa có album</p>
			<p class="text-muted">Tạo album để sắp xếp ảnh</p>
		   </div>
		  </div>
		 </div>
		</div>
	   </main><button class="fab-btn d-none" id="fab-btn"> <i class="bi bi-plus-lg fs-4"></i> </button> <nav class="bottom-nav">
		<div class="d-flex justify-content-around py-1"><button class="nav-link border-0 bg-transparent d-flex flex-column align-items-center" data-tab="feed"> <i class="bi bi-grid-3x3-gap fs-4"></i> <small class="fw-semibold">Bảng tin</small> </button> <button class="nav-link border-0 bg-transparent d-flex flex-column align-items-center active" data-tab="home"> <i class="bi bi-house-fill fs-4"></i> <small class="fw-semibold">Home</small> </button> <button class="nav-link border-0 bg-transparent d-flex flex-column align-items-center" data-tab="albums"> <i class="bi bi-folder-fill fs-4"></i> <small class="fw-semibold">Album</small> </button>
		</div>
	   </nav><div class="modal fade" id="notificationsModal" tabindex="-1">
		<div class="modal-dialog modal-fullscreen">
		 <div class="modal-content">
		  <div class="modal-header">
		   <h5 class="modal-title theme-text-primary fw-bold"><i class="bi bi-bell-fill me-2"></i>Thông báo</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button>
		  </div>
		  <div class="modal-body p-0">
		   <div class="d-flex justify-content-between align-items-center p-3 border-bottom"><button class="btn btn-sm btn-outline-primary" id="mark-all-read"> <i class="bi bi-check-all me-1"></i>Đánh dấu đã đọc </button> <button class="btn btn-sm btn-outline-danger" id="clear-all-notifications"> <i class="bi bi-trash me-1"></i>Xóa tất cả </button>
		   </div>
		   <div id="notifications-list"></div>
		  </div>
		 </div>
		</div>
	   </div>
	    
	   <div class="modal fade" id="createMemoryModal" tabindex="-1">
		<div class="modal-dialog modal-fullscreen">
		 <div class="modal-content">
		  <div class="modal-header">
		   <h5 class="modal-title theme-text-primary fw-bold">Tạo kỷ niệm</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button>
		  </div>
		  <div class="modal-body">
		   <div class="mb-3"><input type="text" class="form-control" id="memory-title" placeholder="Tiêu đề kỷ niệm">
		   </div>
		   <div class="mb-3"><input type="date" class="form-control" id="memory-date">
		   </div>
		   <div class="mb-3"><textarea class="form-control" id="memory-content" rows="4" placeholder="Kể về kỷ niệm của bạn..."></textarea>
		   </div>
		   <div id="memory-image-preview-container" class="d-none mb-3">
			<div class="position-relative"><img id="memory-image-preview" class="w-100 rounded" style="max-height: 300px; object-fit: cover;" src="" alt="Preview"> <button class="btn btn-danger position-absolute top-0 end-0 m-2" id="remove-memory-image"> <i class="bi bi-x-lg"></i> </button>
			</div>
		   </div>
		   <div class="mb-3"><label class="btn btn-outline-primary w-100"> <i class="bi bi-image me-2"></i>Thêm ảnh <input type="file" id="memory-image-input" accept="image/*" class="d-none"> </label>
		   </div><button class="btn btn-primary w-100 py-3" id="create-memory-btn"> <i class="bi bi-save me-2"></i>Lưu kỷ niệm </button>
		  </div>
		 </div>
		</div>
	   </div><div class="modal fade" id="createAlbumModal" tabindex="-1">
		<div class="modal-dialog">
		 <div class="modal-content">
		  <div class="modal-header">
		   <h5 class="modal-title theme-text-primary fw-bold">Tạo album mới</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button>
		  </div>
		  <div class="modal-body">
		   <div class="mb-3"><input type="text" class="form-control" id="album-name" placeholder="Tên album">
		   </div><button class="btn btn-primary w-100" id="create-album-btn"> <i class="bi bi-plus-circle me-2"></i>Tạo album </button>
		  </div>
		 </div>
		</div>
	   </div><div class="modal fade" id="albumDetailModal" tabindex="-1">
		<div class="modal-dialog modal-fullscreen">
		 <div class="modal-content">
		  <div class="modal-header">
		   <h5 class="modal-title theme-text-primary fw-bold" id="album-detail-title">Album</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button>
		  </div>
		  <div class="modal-body">
		   <div class="mb-3"><label class="btn btn-outline-primary w-100"> <i class="bi bi-plus-circle me-2"></i>Thêm ảnh <input type="file" id="album-image-input" accept="image/*" class="d-none"> </label>
		   </div>
		   <div class="row g-2" id="album-photos">
			<div class="col-12 text-center py-5 text-muted"><i class="bi bi-camera" style="font-size: 3rem;"></i>
			 <p class="mt-2">Chưa có ảnh</p>
			</div>
		   </div>
		  </div>
		 </div>
		</div>
	   </div><div class="modal fade" id="commentModal" tabindex="-1">
		<div class="modal-dialog modal-fullscreen">
		 <div class="modal-content">
		  <div class="modal-header">
		   <h5 class="modal-title theme-text-primary fw-bold">Bình luận</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button>
		  </div>
		  <div class="modal-body d-flex flex-column">
		   <div class="flex-grow-1 overflow-auto mb-3" id="comments-list">
			<p class="text-center text-muted py-5">Chưa có bình luận</p>
		   </div>
		   <div class="input-group"><input type="text" class="form-control" id="comment-input" placeholder="Viết bình luận..."> <button class="btn btn-primary" id="send-comment"> <i class="bi bi-send"></i> </button>
		   </div>
		  </div>
		 </div>
		</div>
	   </div><div class="modal fade" id="profileModal" tabindex="-1">
		<div class="modal-dialog modal-fullscreen">
		 <div class="modal-content">
		  <div class="modal-header">
		   <h5 class="modal-title theme-text-primary fw-bold">Hồ sơ cá nhân</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button>
		  </div>
		  <div class="modal-body"><div class="text-center mb-4">
			<div class="avatar-circle avatar-circle-lg mx-auto mb-3" style="border: 4px solid var(--primary-color);">
			 <div id="profile-avatar" class="w-100 h-100 d-flex align-items-center justify-content-center"><i class="bi bi-person-fill theme-text-primary" style="font-size: 3rem;"></i>
			 </div>
			</div><label class="btn btn-sm btn-outline-primary"> <i class="bi bi-camera me-1"></i> Đổi ảnh đại diện <input type="file" id="avatar-input" accept="image/*" class="d-none"> </label>
		   </div>
		   <div class="mb-3"><label class="form-label fw-semibold"> <i class="bi bi-person me-2"></i>Tên người dùng </label> <input type="text" class="form-control" id="profile-username" placeholder="username">
		   </div>
		   <div class="mb-4"><label class="form-label fw-semibold"> <i class="bi bi-card-text me-2"></i>Tên hiển thị </label> <input type="text" class="form-control" id="profile-fullname" placeholder="Tên của bạn">
		   </div><div class="border-top pt-4">
			<h6 class="fw-bold theme-text-primary mb-3"><i class="bi bi-gear me-2"></i>Cài đặt</h6><div class="card mb-3">
			 <div class="card-body">
			  <div class="d-flex align-items-center mb-3">
			   <div class="icon-box icon-box-sm theme-bg-primary text-white me-3"><i class="bi bi-palette-fill"></i>
			   </div>
			   <div>
				<h6 class="mb-0 fw-bold">Giao diện</h6><small class="text-muted">Chọn màu sắc cho ứng dụng</small>
			   </div>
			  </div>
			  <div class="d-flex gap-2 justify-content-between">
			   <div class="theme-option flex-fill" data-theme="green" style="background: linear-gradient(135deg, #006B68 0%, #FFC62F 100%);"></div>
			   <div class="theme-option flex-fill" data-theme="purple" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
			   <div class="theme-option flex-fill" data-theme="blue" style="background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);"></div>
			   <div class="theme-option flex-fill" data-theme="red" style="background: linear-gradient(135deg, #dc2626 0%, #fb923c 100%);"></div>
			  </div>
			 </div>
			</div><div class="card mb-3">
			 <div class="card-body">
			  <div class="d-flex align-items-center mb-3">
			   <div class="icon-box icon-box-sm text-white me-3" style="background: #6f42c1;"><i class="bi bi-grid-3x3"></i>
			   </div>
			   <div>
				<h6 class="mb-0 fw-bold">Chỉnh sửa bố cục</h6><small class="text-muted">Sắp xếp và thay đổi kích thước khối dữ liệu</small>
			   </div>
			  </div><button class="btn btn-outline-primary w-100" id="enter-layout-edit"> <i class="bi bi-pencil-square me-2"></i>Chỉnh sửa bố cục </button>
			 </div>
			</div>
		   </div><button class="btn btn-primary w-100 py-3 mt-3" id="save-profile"> <i class="bi bi-check-circle me-2"></i>Lưu thay đổi </button>
		  </div>
		 </div>
		</div>
	   </div>
	   
	   <div class="modal fade" id="postOptionsModal" tabindex="-1">
		<div class="modal-dialog modal-dialog-centered">
		 <div class="modal-content">
		  <div class="list-group list-group-flush"><button class="list-group-item list-group-item-action" id="edit-post-option"> <i class="bi bi-pencil theme-text-primary me-2"></i> <span class="fw-semibold">Chỉnh sửa bài viết</span> </button> <button class="list-group-item list-group-item-action text-danger" id="delete-post-option"> <i class="bi bi-trash me-2"></i> <span class="fw-semibold">Xóa bài viết</span> </button> <button class="list-group-item list-group-item-action" data-bs-dismiss="modal"> Hủy </button>
		  </div>
		 </div>
		</div>
	   </div>
	   <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
		<div class="modal-dialog modal-dialog-centered">
		 <div class="modal-content text-center p-3">
		  <div class="modal-body"><i class="bi bi-trash text-danger" style="font-size: 3rem;"></i>
		   <h5 class="mt-3 mb-2">Xác nhận xóa?</h5>
		   <p class="text-muted">Bạn có chắc muốn xóa không?</p>
		   <div class="d-flex gap-2"><button class="btn btn-secondary flex-fill" data-bs-dismiss="modal">Hủy</button> <button class="btn btn-danger flex-fill" id="confirm-delete">Xóa</button>
		   </div>
		  </div>
		 </div>
		</div>
	   </div>
	    
	   
	   <div class="modal fade" id="bikeStatsModal" tabindex="-1">
		<div class="modal-dialog modal-fullscreen">
		 <div class="modal-content">
		  <div class="modal-header">
		   <h5 class="modal-title theme-text-primary fw-bold"><i class="bi bi-bar-chart-fill me-2"></i>Thống kê lượt đạp</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button>
		  </div>
		  <div class="modal-body"><div class="row g-3 mb-4">
			<div class="col-4">
			 <div class="card text-center p-3"><i class="bi bi-calendar-day theme-text-primary fs-3"></i>
			  <p class="small text-muted mb-1 mt-2">Hôm nay</p>
			  <p id="stats-today" class="fs-4 fw-bold theme-text-primary mb-0">0</p>
			 </div>
			</div>
			<div class="col-4">
			 <div class="card text-center p-3"><i class="bi bi-calendar-week text-success fs-3"></i>
			  <p class="small text-muted mb-1 mt-2">Tuần này</p>
			  <p id="stats-week" class="fs-4 fw-bold text-success mb-0">0</p>
			 </div>
			</div>
			<div class="col-4">
			 <div class="card text-center p-3"><i class="bi bi-calendar-month text-warning fs-3"></i>
			  <p class="small text-muted mb-1 mt-2">Tháng này</p>
			  <p id="stats-month" class="fs-4 fw-bold text-warning mb-0">0</p>
			 </div>
			</div>
		   </div>
		   
		   <!--div class="card p-3 mb-3">
			<h6 class="fw-bold mb-3">Biểu đồ</h6>
			<div id="bike-chart" style="height: 250px;"></div>
		   </div---->
		   
		   
		   <div class="p-3 bg-white mb-2">
				<h6 class="fw-bold mb-3 small text-muted text-uppercase">Biểu đồ Lịch sử (Toàn thời gian)</h6>
				
				<div style="overflow-x: auto; overflow-y: hidden; white-space: nowrap; -webkit-overflow-scrolling: touch;">
					<div id="bike-chart" style="height: 200px; min-width: 100%;">
						 <div class="d-flex align-items-center justify-content-center h-100 text-muted small">
							 Đang tải biểu đồ...
						 </div>
					</div>
				</div>
				<div class="text-center small text-muted mt-1">Lướt sang ngang để xem thêm &larr; &rarr;</div>
			</div>
		   
		   <div class="card p-3">
			<div class="d-flex justify-content-between align-items-center mb-3">
			 <h6 class="fw-bold mb-0">Lịch sử</h6><button class="btn btn-sm btn-outline-primary" id="add-bike-entry"> <i class="bi bi-plus-circle me-1"></i>Thêm </button>
			</div>
			<div id="bike-history-list"></div>
		   </div>
		  </div>
		 </div>
		</div>
	   </div>
	   
	   
	   <div class="modal fade" id="addBikeEntryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered"> 
        <div class="modal-content"> 
            
            <div class="modal-header">
                <h5 class="modal-title fw-bold theme-text-primary">Thêm lượt đạp</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">Chọn Ngày</label>
                    <input type="date" id="manual-bike-date" class="form-control form-control-lg">
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">Chọn Giờ</label>
                    <input type="time" id="manual-bike-time" class="form-control form-control-lg">
                </div>

                <div class="text-center text-muted small">
                    Lượt đạp sẽ được lưu vào lịch sử với thời gian bạn chọn.
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary theme-bg-primary border-0" onclick="saveManualBikeEntry()">Lưu</button>
            </div>

        </div> </div> </div>
   
	   

	<div class="modal fade" id="goldStatsModal" tabindex="-1">
		<div class="modal-dialog modal-fullscreen">
		 <div class="modal-content">
		  <div class="modal-header">
		   <h5 class="modal-title theme-text-primary fw-bold"><i class="bi bi-bar-chart-fill me-2"></i>Thống kê giá vàng</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button>
		  </div>
		  <div class="modal-body"><div class="row g-3 mb-4">
			<div class="col-6">
			 <div class="card text-center p-3"><i class="bi bi-arrow-up-circle text-success fs-3"></i>
			  <p class="small text-muted mb-1 mt-2">Cao nhất</p>
			  <p id="gold-highest-price" class="fs-5 fw-bold text-success mb-0">-</p><small id="gold-highest-date" class="text-muted">-</small>
			 </div>
			</div>
			<div class="col-6">
			 <div class="card text-center p-3"><i class="bi bi-arrow-down-circle text-danger fs-3"></i>
			  <p class="small text-muted mb-1 mt-2">Thấp nhất</p>
			  <p id="gold-lowest-price" class="fs-5 fw-bold text-danger mb-0">-</p><small id="gold-lowest-date" class="text-muted">-</small>
			 </div>
			</div>
		   </div><div class="card p-3 mb-3">
			<h6 class="fw-bold mb-3">Biểu đồ 7 ngày gần nhất</h6>
			<div id="gold-chart" style="height: 250px;"></div>
		   </div><div class="card p-3">
			<div class="d-flex justify-content-between align-items-center mb-3">
			 <h6 class="fw-bold mb-0">Lịch sử</h6><button class="btn btn-sm btn-outline-primary" id="add-gold-entry"> <i class="bi bi-plus-circle me-1"></i>Thêm </button>
			</div>
			<div id="gold-history-list"></div>
		   </div>
		  </div>
		 </div>
		</div>
	   </div><div class="modal fade" id="addGoldEntryModal" tabindex="-1">
		<div class="modal-dialog">
		 <div class="modal-content">
		  <div class="modal-header">
		   <h5 class="modal-title theme-text-primary fw-bold">Thêm giá vàng</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button>
		  </div>
		  <div class="modal-body">
		   <div class="mb-3"><label class="form-label fw-semibold">Giá mua</label> <input type="number" class="form-control" id="gold-entry-buy" placeholder="15700" step="1">
		   </div>
		   <div class="mb-3"><label class="form-label fw-semibold">Giá bán</label> <input type="number" class="form-control" id="gold-entry-sell" placeholder="16000" step="1">
		   </div>
		   <div class="mb-3"><label class="form-label fw-semibold">Ngày</label> <input type="date" class="form-control" id="gold-entry-date">
		   </div>
		   <div class="mb-3"><label class="form-label fw-semibold">Ghi chú (không bắt buộc)</label> <textarea class="form-control" id="gold-entry-note" rows="2"></textarea>
		   </div><button class="btn btn-primary w-100" id="save-gold-entry"> <i class="bi bi-check-circle me-2"></i>Lưu </button>
		  </div>
		 </div>
		</div>
	   </div><div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999;">
		<div id="loadingToast" class="toast" role="alert">
		 <div class="toast-body d-flex align-items-center">
		  <div class="spinner-border spinner-border-sm me-2" role="status"></div> Đang xử lý...
		 </div>
		</div>
	   </div><div class="position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 9999;">
		<div id="successToast" class="toast" role="alert">
		 <div class="toast-body bg-success text-white rounded"><i class="bi bi-check-circle me-2"></i> <span id="toast-message">Thành công!</span>
		 </div>
		</div>
	   </div>
	  </div>
	   
	   <div class="modal fade" id="createPostModal" tabindex="-1">
		<div class="modal-dialog modal-fullscreen">
		 <div class="modal-content">
		  <div class="modal-header">
		   <h5 class="modal-title theme-text-primary fw-bold">Tạo bài viết</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button>
		  </div>
		  <div class="modal-body">
		   <div class="mb-3"><textarea class="form-control" id="post-input" rows="4" placeholder="Bạn đang nghĩ gì?"></textarea>
		   </div>
		   <div id="image-preview-container" class="d-none mb-3">
			<div class="d-flex justify-content-between align-items-center mb-2"><span class="text-muted"><span id="image-count">0</span> ảnh</span> <button class="btn btn-sm btn-outline-danger" id="clear-all-images"> <i class="bi bi-trash"></i> Xóa tất cả </button>
			</div>
			<div id="images-preview-grid" class="row g-2"></div>
		   </div>
		   
		   <div id="image-options" class="d-none mb-2 d-flex justify-content-end border-bottom pb-2">
				<div class="form-check form-switch">
					<input class="form-check-input" type="checkbox" id="hd-quality-switch" checked>
					<label class="form-check-label small fw-semibold" for="hd-quality-switch">Chất lượng HD</label>
				</div>
			</div>

			<div id="layout-selector" class="d-none mb-3">
				<label class="form-label fw-bold mb-2 small text-muted text-uppercase">Chọn bố cục hiển thị</label>
				
				<div class="row g-2">
					<div class="col-4">
						<div class="layout-preview-box p-1" data-layout="grid-2x2">
							<div class="layout-grid-visual small-visual" style="grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr;">
								<div></div><div></div><div></div><div></div>
							</div>
							<p class="text-center small fw-semibold mt-1 mb-0" style="font-size: 0.7rem;">Lưới 2x2</p>
						</div>
					</div>
					
					<div class="col-4">
						<div class="layout-preview-box p-1" data-layout="1-wide">
							<div class="layout-grid-visual small-visual" style="grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr;">
								<div style="grid-column: span 2;"></div><div></div><div></div>
							</div>
							<p class="text-center small fw-semibold mt-1 mb-0" style="font-size: 0.7rem;">1 Ngang</p>
						</div>
					</div>

					<div class="col-4">
						<div class="layout-preview-box p-1" data-layout="1-tall">
							<div class="layout-grid-visual small-visual" style="grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr;">
								<div style="grid-row: span 2;"></div><div></div><div></div>
							</div>
							<p class="text-center small fw-semibold mt-1 mb-0" style="font-size: 0.7rem;">1 Dọc</p>
						</div>
					</div>
				</div>
			</div>

		   <div class="mb-3"><label class="btn btn-outline-primary w-100"> <i class="bi bi-image me-2"></i>Thêm ảnh <input type="file" id="image-input" accept="image/*" multiple class="d-none"> </label>
		   </div>
				<button class="btn btn-primary w-100 py-3" id="post-btn" onclick="handlePostSubmit()" disabled> 
					<i class="bi bi-send me-2"></i>Đăng bài 
				</button>
		  </div>
		 </div>
		</div>
	   </div>
	   
	   <div class="modal fade" id="imageViewerModal" tabindex="-1" aria-hidden="true">
			<div class="modal-dialog modal-fullscreen">
				<div class="modal-content" style="background-color: black;">
					<div class="modal-header border-0 position-fixed w-100 p-3" style="z-index: 1060; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); top: 0;">
						<button type="button" class="btn btn-link text-white p-0" data-bs-dismiss="modal">
							<i class="bi bi-arrow-left fs-3"></i>
						</button>
						<span class="text-white ms-3 fw-bold" id="viewer-counter">Ảnh chi tiết</span>
					</div>
					
					<div class="modal-body p-0 overflow-auto d-flex flex-column align-items-center" id="full-image-list" style="padding-top: 60px !important; padding-bottom: 60px !important;">
						</div>
				</div>
			</div>
		</div>
	   
	  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
	  <script>
		// --- CẤU HÌNH KẾT NỐI ---
		const API_URL = 'https://script.google.com/macros/s/AKfycbzVfzSAWPJ2mIyAQKhv78X-DG__X8vINzvQE-HTtuij3RwkCkiLeU665Dh5NT7N-QZ_Ow/exec';
		
		let userFingerprint = null;

		// --- CÁC HÀM TIỆN ÍCH (ĐẶT LÊN ĐẦU) ---
		
		// 5. Quản lý LocalStorage
		const STORAGE_KEY = 'social_memory_profile';

		function saveLocalData(data) {
		  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
		}

		function getLocalData() {
		  const data = localStorage.getItem(STORAGE_KEY);
		  return data ? JSON.parse(data) : null;
		}

		// 1. Tạo Fingerprint (Định danh thiết bị)
		async function getBrowserFingerprint() {
			const str = navigator.userAgent + navigator.language + screen.width + 'x' + screen.height;
			const msgBuffer = new TextEncoder().encode(str);
			const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
			return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
		}

		// 2. Nén ảnh (<20KB để lưu Sheet)
		function compressImageTo20KB(file) {
			return new Promise((resolve) => {
				const reader = new FileReader();
				reader.readAsDataURL(file);
				reader.onload = (e) => {
					const img = new Image();
					img.src = e.target.result;
					img.onload = () => {
						const canvas = document.createElement('canvas');
						let w = img.width, h = img.height;
						const MAX = 600; // Resize nhỏ lại trước
						if(w > h && w > MAX) { h *= MAX/w; w = MAX; }
						else if(h > MAX) { w *= MAX/h; h = MAX; }
						
						canvas.width = w; canvas.height = h;
						const ctx = canvas.getContext('2d');
						ctx.drawImage(img, 0, 0, w, h);
						
						let quality = 0.8;
						let dataUrl = canvas.toDataURL('image/jpeg', quality);
						while(dataUrl.length > 20000 && quality > 0.1) { // Giới hạn 20KB
							quality -= 0.1;
							dataUrl = canvas.toDataURL('image/jpeg', quality);
						}
						resolve(dataUrl);
					}
				}
			});
		}

		// 3. Hàm gửi dữ liệu chung (Router Client) 
		async function sendToServer(payload) {
			try {
				const res = await fetch(API_URL, {
					method: 'POST',
					// THÊM DÒNG NÀY: Giúp bỏ qua bước kiểm duyệt CORS phức tạp của Google
					headers: {
						"Content-Type": "text/plain;charset=utf-8",
					},
					body: JSON.stringify(payload)
				});
				return await res.json();
			} catch (e) {
				console.error("Lỗi API:", e);
				return { status: 'error', message: e.message };
			}
		}

		// 4. Hàm sinh tên ngẫu nhiên
		function generateIdentity() {
			const animal = randomAnimals[Math.floor(Math.random() * randomAnimals.length)];
			const color = randomColors[Math.floor(Math.random() * randomColors.length)];
			const fullname = `${animal} ${color}`;
			// Tạo username không dấu: Gấu Đỏ -> gaudo123
			const username = fullname.normalize("NFD").replace(/[\u0300-\u036f]/g, "")
							 .replace(/\s/g, '').toLowerCase() + Math.floor(Math.random()*999);
			return { fullname, username };
		}

		// --- DỮ LIỆU RANDOM ---
		const randomAnimals = ['Gấu', 'Hổ', 'Sư Tử', 'Voi', 'Hươu', 'Cá', 'Vẹt', 'Mèo', 'Chó', 'Rùa', 'Khỉ', 'Thỏ', 'Sói', 'Cáo', 'Heo', 'Bò', 'Gà', 'Vịt', 'Cú', 'Dê', 'Cừu', 'Kiến', 'Tép', 'Tôm'];
		const randomColors = ['Xanh', 'Đỏ', 'Tím', 'Vàng', 'Cam', 'Hồng', 'Đen', 'Trắng'];

		const defaultConfig = {
		  app_title: 'Love Story',
		  welcome_message: 'Lưu giữ kỷ niệm đẹp'
		};

		const themes = {
		  green: { primary: '#006B68', secondary: '#FFC62F', text: '#212529', bg: '#f8f9fa', surface: '#ffffff' },
		  purple: { primary: '#667eea', secondary: '#764ba2', text: '#1f2937', bg: '#f8f9fa', surface: '#ffffff' },
		  blue: { primary: '#1e3a8a', secondary: '#3b82f6', text: '#000000', bg: '#f0f9ff', surface: '#ffffff' },
		  red: { primary: '#dc2626', secondary: '#fb923c', text: '#000000', bg: '#fef2f2', surface: '#ffffff' }
		};

		const defaultStatsLayout = [
		  { id: 'bike', column: 0, size: 'medium' },
		  { id: 'days', column: 0, size: 'medium' },
		  { id: 'memory', column: 0, size: 'medium' },
		  { id: 'event', column: 0, size: 'medium' },
		  { id: 'gold', column: 0, size: 'medium' }
		];

		let allData = [];
		let currentProfile = null;
		let currentTab = 'home';
		let currentAlbumId = null;
		let currentPostId = null;
		let pendingDeleteId = null;
		let pendingDeleteType = null;
		let currentImages = []; // Bây giờ mảng này sẽ chứa File Object (nhẹ), không chứa Base64 (nặng)
		let currentImagePreviews = []; // Mảng này chứa Base64 nhỏ xíu chỉ để hiển thị Preview cho đẹp
		let memoryImageData = null;
		let recordCount = 0;
		let currentTheme = 'green';
		let selectedLayout = 'grid-2x2';
		let isEditMode = false;
		let statsLayout = [...defaultStatsLayout];
		let draggedElement = null;
		let draggedId = null;

		let serverFeedData = []; // Biến chứa dữ liệu tải từ sheet feed
		
		let loadingToast, successToast;
		let createPostModal, createMemoryModal, createAlbumModal, albumDetailModal, commentModal, profileModal, postOptionsModal, deleteConfirmModal, bikeStatsModal, addBikeEntryModal, goldStatsModal, addGoldEntryModal, notificationsModal;

		let isEditingPost = false;
		let currentEditPostId = null;
		
		// --- BIẾN QUẢN LÝ PHÂN TRANG HISTORY ---
		let bikeHistoryPage = 1;
		let bikeHistoryLoading = false;
		let bikeHistoryHasMore = true;
		
		// --- BIẾN QUẢN LÝ PHÂN TRANG FEED ---
		let feedPage = 1;
		let feedLoading = false;
		let feedHasMore = true;
		// --- BIẾN QUẢN LÝ PHÂN TRANG notifPage ---
		let notifPage = 1;
		let notifLoading = false;
		let notifHasMore = true;
		let serverNotifications = []; // Cache dữ liệu
		// [MỚI] Thời điểm cuối cùng người dùng thực hiện thao tác ghi
		let pendingTasksCount = 0; 
		let lastUserActionTime = 0; 

		// Thêm dòng này vào danh sách biến global (cùng chỗ với createPostModal...)
		let imageViewerModal;

		// Trong hàm initApp hoặc (async () => { ... })();
		// Thêm dòng này vào phần khởi tạo:
		imageViewerModal = new bootstrap.Modal(document.getElementById('imageViewerModal'));
		// --- BIẾN QUẢN LÝ TIẾN TRÌNH UPLOAD ---

		// Lắng nghe sự kiện tắt trình duyệt/tab
		window.addEventListener('beforeunload', (e) => {
			if (pendingTasksCount > 0) {
				// Kích hoạt cảnh báo mặc định của trình duyệt
				e.preventDefault();
				e.returnValue = 'Dữ liệu đang được gửi lên máy chủ. Bạn có chắc muốn rời đi?';
				return 'Dữ liệu đang được gửi lên máy chủ. Bạn có chắc muốn rời đi?';
			}
		});

		function applyTheme(themeName) {
		  const theme = themes[themeName];
		  if (!theme) return;
		  
		  document.documentElement.style.setProperty('--primary-color', theme.primary);
		  document.documentElement.style.setProperty('--secondary-color', theme.secondary);
		  document.documentElement.style.setProperty('--text-color', theme.text);
		  document.documentElement.style.setProperty('--bg-color', theme.bg);
		  document.documentElement.style.setProperty('--surface-color', theme.surface);
		  
		  document.querySelectorAll('.theme-option').forEach(opt => opt.classList.remove('selected'));
		  const selected = document.querySelector(`[data-theme="${themeName}"]`);
		  if (selected) selected.classList.add('selected');
		  
		  currentTheme = themeName;
		}

		if (window.elementSdk) {
		  window.elementSdk.init({
			defaultConfig,
			onConfigChange: async (config) => {
			  //document.getElementById('app-title').textContent = config.app_title || defaultConfig.app_title;
			  document.getElementById('welcome-message').textContent = config.welcome_message || defaultConfig.welcome_message;
			},
			mapToCapabilities: () => ({ recolorables: [], borderables: [], fontEditable: undefined, fontSizeable: undefined }),
			mapToEditPanelValues: (config) => new Map([
			  ['app_title', config.app_title || defaultConfig.app_title],
			  ['welcome_message', config.welcome_message || defaultConfig.welcome_message]
			])
		  });
		}

		const dataHandler = {
		  onDataChanged(data) {
			allData = data;
			recordCount = data.length;
			
			currentProfile = data.find(d => d.type === 'profile');
			if (currentProfile) {
			  if (currentProfile.themeName) applyTheme(currentProfile.themeName);
			  if (currentProfile.statsLayout) {
				try {
				  statsLayout = JSON.parse(currentProfile.statsLayout);
				} catch {
				  statsLayout = [...defaultStatsLayout];
				}
			  }
			}
			
			updateAvatarDisplays();
			updateNotificationBadge();
			
			if (currentTab === 'feed') renderPosts();
			else if (currentTab === 'home') { renderStats(); updateStats(); }
			else if (currentTab === 'albums') renderAlbums();
			
			if (currentAlbumId && albumDetailModal && albumDetailModal._isShown) renderAlbumPhotos();
		  }
		};

		// --- KHỞI TẠO ỨNG DỤNG ---_-----------------------------------------------------------------------------------------------------------
		
		// Hàm 1: Đồng bộ Profile (Xử lý định danh)
		async function syncUserProfile() {
			try {
				// Lấy Fingerprint thiết bị
				userFingerprint = await getBrowserFingerprint();
				console.log("Fingerprint:", userFingerprint);

				// Gọi server kiểm tra
				const res = await sendToServer({
					action: 'get_profile',
					fingerprint: userFingerprint
				});

				if (res && (res.status === 'success' || res.result === 'success') && res.data) {
					// TRƯỜNG HỢP 1: Server CÓ dữ liệu
					console.log("Server found profile:", res.data);
					
					// Cập nhật Local
					currentProfile = {
						username: res.data.username,
						fullName: res.data.fullname,
						avatarData: res.data.avaurl,
						themeName: res.data.theme
					};
					saveLocalData(currentProfile);
					
					// Cập nhật UI
					applyTheme(currentProfile.themeName);
					updateAvatarDisplays();
					
					// Nếu đây là lần đầu mở máy (chưa có local) -> Chào mừng
					const localCheck = getLocalData();
					if(!localCheck) showToast(`Đồng bộ thành công: ${res.data.fullname}`);

				} else {
					// 2B: Máy TRẮNG (User mới tinh) -> Tạo mới Local -> Lưu lên Server
					console.log("New User -> Creating identity...");
					const identity = generateIdentity();
					currentProfile = {
						username: identity.username,
						fullName: identity.fullname,
						avatarData: '',
						themeName: 'green'
					};
					saveLocalData(currentProfile);
					applyTheme(currentProfile.themeName);
					updateAvatarDisplays();
					showToast(`Chào bạn mới: ${identity.fullname}`);

				}
			} catch (err) {
				console.error("Lỗi sync profile:", err);
				// Nếu lỗi mạng, vẫn dùng LocalProfile (đã load ở đầu hàm initApp)
			}
		}

		// Hàm 2: Đồng bộ Baby Run (Xử lý số liệu)
		async function syncBabyRunStats() {

			try {
				const now = new Date();
				const dateStr = `${String(now.getDate()).padStart(2, '0')}/${String(now.getMonth() + 1).padStart(2, '0')}/${now.getFullYear()}`;

				const res = await sendToServer({
					action: 'get_babyrun_count',
					date: dateStr
				});

				if (res && (res.status === 'success' || res.result === 'success')) {
					console.log("BabyRun count:", res.count);
					const bikeCountEl = document.getElementById('bike-count');
					if (bikeCountEl) {
						bikeCountEl.textContent = res.count;
						// Lưu Cache Local
						localStorage.setItem('cached_babyrun_count', res.count);
					}
				}
			} catch (err) {
				console.error("Lỗi sync babyrun:", err);
			}
		}

		// --- MAIN INITIALIZATION ---
		(async () => {
			// 1. Khởi tạo UI/Modal (Giữ nguyên)
			loadingToast = new bootstrap.Toast(document.getElementById('loadingToast'));
			successToast = new bootstrap.Toast(document.getElementById('successToast'));
			createPostModal = new bootstrap.Modal(document.getElementById('createPostModal'));
			createMemoryModal = new bootstrap.Modal(document.getElementById('createMemoryModal'));
			createAlbumModal = new bootstrap.Modal(document.getElementById('createAlbumModal'));
			albumDetailModal = new bootstrap.Modal(document.getElementById('albumDetailModal'));
			commentModal = new bootstrap.Modal(document.getElementById('commentModal'));
			profileModal = new bootstrap.Modal(document.getElementById('profileModal'));
			postOptionsModal = new bootstrap.Modal(document.getElementById('postOptionsModal'));
			deleteConfirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
			bikeStatsModal = new bootstrap.Modal(document.getElementById('bikeStatsModal'));
			addBikeEntryModal = new bootstrap.Modal(document.getElementById('addBikeEntryModal'));
			goldStatsModal = new bootstrap.Modal(document.getElementById('goldStatsModal'));
			addGoldEntryModal = new bootstrap.Modal(document.getElementById('addGoldEntryModal'));
			notificationsModal = new bootstrap.Modal(document.getElementById('notificationsModal'));

			if (window.dataSdk) await window.dataSdk.init(dataHandler);

			// 2. LOAD OFFLINE FIRST (Hiển thị ngay lập tức)
			const localData = getLocalData();
			if (localData) {
				currentProfile = localData;
				applyTheme(currentProfile.themeName);
				updateAvatarDisplays();
			}

			const cachedRun = localStorage.getItem('cached_babyrun_count');
			if (cachedRun && document.getElementById('bike-count')) {
				document.getElementById('bike-count').textContent = cachedRun;
			}

			if (currentTab === 'home') { renderStats(); updateStats(); }
			
			// Set ngày mặc định
			const today = new Date();
			if(document.getElementById('bike-entry-date')) document.getElementById('bike-entry-date').valueAsDate = today;
			if(document.getElementById('gold-entry-date')) document.getElementById('gold-entry-date').valueAsDate = today;

			// 3. GỌI CÁC HÀM ĐỒNG BỘ RIÊNG BIỆT (KHÔNG DÙNG PROMISE.ALL)
			// Profile chạy trước để đảm bảo có Username
			syncUserProfile();
			
			// Sau đó chạy BabyRun (nếu Profile ok)
			// Không await để nó chạy ngầm, không chặn giao diện
			syncBabyRunStats();
			
			// [MỚI] Gọi đồng bộ số thông báo chưa đọc
			syncUnreadCount();
			
			// [QUAN TRỌNG] Load Feed ngay lần đầu mở app (để khi bấm tab Feed là có luôn)
			loadFeedData(1);
			
			// [THÊM MỚI] Pre-load luôn danh sách thông báo để khi ấn chuông là thấy ngay
			loadNotifications(1);
			
			// Set interval: Cứ 60 giây check thông báo mới 1 lần (Tùy chọn)
			// setInterval(syncUnreadCount, 60000);
			
		})();

		function showToast(message) {
		  document.getElementById('toast-message').textContent = message;
		  successToast.show();
		}

		function showLoading() {
		  loadingToast.show();
		}

		function hideLoading() {
		  loadingToast.hide();
		}

		function updateNotificationBadge() {
		  const notifications = allData.filter(d => d.type === 'notification');
		  const unreadCount = notifications.filter(n => !n.isRead).length;
		  const badge = document.getElementById('notification-badge');
		  
		  if (unreadCount > 0) {
			badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
			badge.classList.remove('d-none');
		  } else {
			badge.classList.add('d-none');
		  }
		}

		function renderNotifications() {
		  const notifications = allData.filter(d => d.type === 'notification').sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
		  const container = document.getElementById('notifications-list');
		  
		  if (notifications.length === 0) {
			container.innerHTML = `
			  <div class="text-center py-5">
				<i class="bi bi-bell-slash theme-text-primary" style="font-size: 4rem;"></i>
				<p class="fw-semibold fs-5 mt-3">Chưa có thông báo</p>
				<p class="text-muted">Các thông báo mới sẽ hiển thị ở đây</p>
			  </div>
			`;
			return;
		  }

		  container.innerHTML = notifications.map(notif => {
			const iconMap = {
			  like: 'heart-fill text-danger',
			  comment: 'chat-fill text-primary',
			  memory: 'star-fill text-warning',
			  album: 'folder-fill text-info',
			  system: 'info-circle-fill theme-text-primary'
			};
			
			const icon = iconMap[notif.notifType] || iconMap.system;
			
			return `
			  <div class="notification-item p-3 ${notif.isRead ? '' : 'unread'}" data-id="${notif.__backendId}">
				<div class="d-flex align-items-start">
				  <div class="me-3">
					<i class="bi bi-${icon} fs-4"></i>
				  </div>
				  <div class="flex-grow-1">
					<p class="mb-1 fw-semibold">${notif.title}</p>
					<p class="mb-1 text-muted small">${notif.message}</p>
					<small class="text-muted">${formatDate(notif.createdAt)}</small>
				  </div>
				  ${!notif.isRead ? '<div class="notification-dot ms-2"></div>' : ''}
				  <button class="btn btn-sm btn-link text-danger delete-notification" data-id="${notif.__backendId}">
					<i class="bi bi-x-lg"></i>
				  </button>
				</div>
			  </div>
			`;
		  }).join('');
		}

		async function createNotification(type, title, message) {
		  if (recordCount >= 999) return;
		  
		  await window.dataSdk.create({
			type: 'notification',
			notifType: type,
			title: title,
			message: message,
			isRead: false,
			createdAt: new Date().toISOString()
		  });
		}

		function updateAvatarDisplays() {
		  const avatarText = currentProfile?.fullName?.[0]?.toUpperCase() || currentProfile?.username?.[0]?.toUpperCase() || 'U';
		  const avatarImg = currentProfile?.avatarData;
		  
		  ['header-avatar', 'profile-avatar'].forEach(id => {
			const container = document.getElementById(id);
			if (avatarImg) {
			  container.innerHTML = `<img src="${avatarImg}" class="w-100 h-100 object-fit-cover" alt="Avatar">`;
			} else {
			  container.innerHTML = `<i class="bi bi-person-fill theme-text-primary ${id === 'profile-avatar' ? 'fs-1' : 'fs-4'}"></i>`;
			}
		  });
		  
		  if (currentProfile) {
			document.getElementById('profile-username').value = currentProfile.username || '';
			document.getElementById('profile-fullname').value = currentProfile.fullName || '';
		  }
		}

		function formatDate(dateStr) {
		  const date = new Date(dateStr);
		  const now = new Date();
		  const diff = now - date;
		  const mins = Math.floor(diff / 60000);
		  const hours = Math.floor(diff / 3600000);
		  const days = Math.floor(diff / 86400000);
		  
		  if (mins < 1) return 'Vừa xong';
		  if (mins < 60) return `${mins} phút`;
		  if (hours < 24) return `${hours} giờ`;
		  if (days < 7) return `${days} ngày`;
		  return date.toLocaleDateString('vi-VN');
		}

		function parseComments(commentsStr) {
		  if (!commentsStr) return [];
		  try { return JSON.parse(commentsStr); } catch { return []; }
		}

		function parseImages(imageStr) {
		  if (!imageStr) return [];
		  try { return JSON.parse(imageStr); } catch { return imageStr ? [imageStr] : []; }
		}

		function updateStats() {
		  const startDate = new Date('2022-02-22');
		  const today = new Date();
		  const diffTime = Math.abs(today - startDate);
		  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
		  
		  const daysEl = document.getElementById('days-together');
		  if (daysEl) daysEl.textContent = `${diffDays} ngày`;
		  
		  const memoryCount = allData.filter(d => d.type === 'memory').length;
		  const memoryEl = document.getElementById('memory-count');
		  if (memoryEl) memoryEl.textContent = memoryCount;
		  
		  
		  // Giải pháp: Ưu tiên lấy từ Cache LocalStorage (do hàm syncBabyRunStats đã lưu)
  
		  const bikeEl = document.getElementById('bike-count');
		  if (bikeEl) {
			  // 1. Lấy số liệu từ Cache (Ưu tiên số 1)
			  const cachedCount = localStorage.getItem('cached_babyrun_count');
			  
			  // 2. Nếu có Cache thì dùng Cache, nếu không mới tính từ allData (Fallback)
			  if (cachedCount !== null && cachedCount !== undefined) {
				  bikeEl.textContent = cachedCount;
			  } else {
				  // Logic cũ (chỉ dùng khi không có cache)
				  const bikeEntries = allData.filter(d => d.type === 'bike_entry');
				  const todayStr = new Date().toISOString().split('T')[0];
				  const todayCount = bikeEntries.filter(e => e.date === todayStr).reduce((sum, e) => sum + (e.count || 0), 0);
				  bikeEl.textContent = todayCount;
			  }
		  }
		  
		  const goldEntries = allData.filter(d => d.type === 'gold_entry').sort((a, b) => new Date(b.date) - new Date(a.date));
		  const latestGold = goldEntries[0];
		  
		  const goldBuyEl = document.getElementById('gold-buy');
		  const goldSellEl = document.getElementById('gold-sell');
		  if (goldBuyEl && latestGold) goldBuyEl.textContent = latestGold.buyPrice?.toLocaleString('vi-VN') || '-';
		  if (goldSellEl && latestGold) goldSellEl.textContent = latestGold.sellPrice?.toLocaleString('vi-VN') || '-';
		}

		function calculateBikeStats() {
		  const bikeEntries = allData.filter(d => d.type === 'bike_entry');
		  const today = new Date();
		  const todayStr = today.toISOString().split('T')[0];
		  
		  const todayCount = bikeEntries.filter(e => e.date === todayStr).reduce((sum, e) => sum + (e.count || 0), 0);
		  
		  const weekStart = new Date(today);
		  weekStart.setDate(today.getDate() - today.getDay());
		  weekStart.setHours(0, 0, 0, 0);
		  const weekCount = bikeEntries.filter(e => {
			const entryDate = new Date(e.date);
			return entryDate >= weekStart;
		  }).reduce((sum, e) => sum + (e.count || 0), 0);
		  
		  const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
		  const monthCount = bikeEntries.filter(e => {
			const entryDate = new Date(e.date);
			return entryDate >= monthStart;
		  }).reduce((sum, e) => sum + (e.count || 0), 0);
		  
		  return { todayCount, weekCount, monthCount };
		}

		function renderBikeChart() {
		  const bikeEntries = allData.filter(d => d.type === 'bike_entry');
		  const chartContainer = document.getElementById('bike-chart');
		  
		  const days = [];
		  for (let i = 6; i >= 0; i--) {
			const date = new Date();
			date.setDate(date.getDate() - i);
			days.push(date.toISOString().split('T')[0]);
		  }
		  
		  const counts = days.map(day => {
			return bikeEntries.filter(e => e.date === day).reduce((sum, e) => sum + (e.count || 0), 0);
		  });
		  
		  const maxCount = Math.max(...counts, 1);
		  
		  chartContainer.innerHTML = `
			<div class="d-flex align-items-end justify-content-between" style="height: 100%;">
			  ${days.map((day, i) => {
				const height = (counts[i] / maxCount) * 100;
				const date = new Date(day);
				const dayName = ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'][date.getDay()];
				return `
				  <div class="d-flex flex-column align-items-center" style="flex: 1;">
					<div class="mb-2 small fw-bold theme-text-primary">${counts[i]}</div>
					<div class="w-100 theme-bg-primary rounded-top" style="height: ${height}%; min-height: 5px; max-width: 40px; margin: 0 auto;"></div>
					<div class="mt-2 small text-muted">${dayName}</div>
				  </div>
				`;
			  }).join('')}
			</div>
		  `;
		}

		function renderBikeHistory() {
		  const bikeEntries = allData.filter(d => d.type === 'bike_entry').sort((a, b) => new Date(b.date) - new Date(a.date));
		  const container = document.getElementById('bike-history-list');
		  
		  if (bikeEntries.length === 0) {
			container.innerHTML = '<p class="text-center text-muted py-3">Chưa có dữ liệu</p>';
			return;
		  }
		  
		  container.innerHTML = bikeEntries.map(entry => {
			const date = new Date(entry.date);
			const dateStr = date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
			return `
			  <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
				<div>
				  <p class="mb-0 fw-semibold">${entry.count} lượt</p>
				  <small class="text-muted">${dateStr}</small>
				  ${entry.note ? `<p class="small text-muted mb-0 mt-1">${entry.note}</p>` : ''}
				</div>
				<button class="btn btn-sm btn-outline-danger delete-bike-entry" data-id="${entry.__backendId}">
				  <i class="bi bi-trash"></i>
				</button>
			  </div>
			`;
		  }).join('');
		}

		// --- HÀM CHÍNH: HIỂN THỊ THỐNG KÊ ---
		async function showBikeStats() {
			bikeStatsModal.show();
			
			// Reset trạng thái phân trang
			bikeHistoryPage = 1;
			bikeHistoryHasMore = true;
			bikeHistoryLoading = false;

			// Reset UI Loading
			document.getElementById('stats-today').textContent = '...';
			document.getElementById('stats-week').textContent = '...';
			document.getElementById('stats-month').textContent = '...';
			
			const historyContainer = document.getElementById('bike-history-list');
			if (historyContainer) {
				historyContainer.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary"></div><div class="small text-muted mt-1">Đang tải dữ liệu mới nhất...</div></div>';
			}

			// Gọi API TRANG 1 (Limit 15 dòng - Đủ cho 1 ngày)
			loadBikeHistoryData(1);
		}
		
		async function loadBikeHistoryData(page) {
			if (bikeHistoryLoading) return;
			bikeHistoryLoading = true;

			try {
				const res = await sendToServer({ 
					action: 'get_bike_stats',
					page: page,
					limit: 15 // Chỉ tải 15 dòng mỗi lần -> Rất nhanh
				});

				if (res.status === 'success') {
					// 1. Nếu là trang 1: Cập nhật Stats & Chart
					if (page === 1) {
						if(res.stats) {
							document.getElementById('stats-today').textContent = res.stats.today;
							document.getElementById('stats-week').textContent = res.stats.week;
							document.getElementById('stats-month').textContent = res.stats.month;
						}
						if (res.history) renderBikeChartFromServer(res.history);
					}

					// 2. Render Danh sách Log
					bikeHistoryHasMore = res.hasMore; // Server báo còn dữ liệu ko
					renderBikeHistoryPaged(res.logs, page);
				}
			} catch (e) {
				console.error("Lỗi tải lịch sử:", e);
			} finally {
				bikeHistoryLoading = false;
			}
		}
		
		// --- HÀM PHỤ TRỢ: TẠO HTML CHO 1 DÒNG LOG ---
		function createLogItemHtml(log) {
			const firstLetter = log.username ? log.username.charAt(0).toUpperCase() : '?';
			return `
				<div class="list-group-item border-0 p-2 d-flex justify-content-between align-items-center mb-1 rounded hover-bg-light">
					<div class="d-flex align-items-center">
						 <div class="rounded-circle theme-bg-primary d-flex align-items-center justify-content-center text-white me-2 shadow-sm" style="width: 32px; height: 32px; font-size: 12px; font-weight: bold;">
							${firstLetter}
						 </div>
						 <div class="d-flex flex-column">
							 <span class="small fw-bold text-dark">${log.username || 'Ẩn danh'}</span>
						 </div>
					</div>
					<div class="text-end">
						<span class="badge bg-light text-secondary border fw-normal font-monospace">${log.time || '--:--'}</span>
					</div>
				</div>
			`;
		}

		// --- HÀM RENDER CHÍNH (ĐÃ FIX LỖI TRÙNG GROUP NGÀY) ---
		function renderBikeHistoryPaged(logsData, page) {
			const container = document.getElementById('bike-history-list');
			if (!container) return;

			// 1. Xóa nút Load More cũ trước khi thêm dữ liệu mới
			const oldTrigger = document.getElementById('load-more-trigger');
			if(oldTrigger) oldTrigger.remove();

			// 2. Nếu là trang 1 thì reset toàn bộ
			if (page === 1) {
				container.innerHTML = '';
				if (!logsData || logsData.length === 0) {
					container.innerHTML = '<p class="text-center text-muted py-3 small">Chưa có dữ liệu chi tiết</p>';
					return;
				}
			}

			// 3. Gom nhóm dữ liệu mới theo ngày
			const groups = {};
			logsData.forEach(item => {
				if (!item.date) return;
				if (!groups[item.date]) groups[item.date] = [];
				groups[item.date].push(item);
			});

			// Lấy danh sách các ngày trong lô dữ liệu mới (Thứ tự: Mới -> Cũ)
			const dates = Object.keys(groups);

			// 4. XỬ LÝ GỘP (MERGE) NẾU TRÙNG NGÀY
			if (page > 1 && dates.length > 0) {
				// Lấy ngày đầu tiên của lô mới
				const firstDateOfNewBatch = dates[0];
				
				// Tìm nhóm ngày cuối cùng đang hiển thị trên màn hình
				const lastRenderedGroup = container.querySelector('.history-group:last-child');
				
				if (lastRenderedGroup) {
					const lastRenderedDate = lastRenderedGroup.getAttribute('data-date');
					
					// Nếu ngày cuối cùng của lô cũ TRÙNG với ngày đầu tiên của lô mới
					if (lastRenderedDate === firstDateOfNewBatch) {
						// -> GỘP VÀO
						const itemsToAppend = groups[firstDateOfNewBatch];
						const listGroup = lastRenderedGroup.querySelector('.list-group');
						const badge = lastRenderedGroup.querySelector('.badge');
						
						// a. Thêm các dòng log mới vào nhóm cũ
						let itemsHtml = '';
						itemsToAppend.forEach(log => {
							itemsHtml += createLogItemHtml(log);
						});
						listGroup.insertAdjacentHTML('beforeend', itemsHtml);
						
						// b. Cập nhật số lượng trên Badge (Số cũ + Số mới thêm)
						if(badge) {
							// Lấy số từ text "15 lượt" -> 15
							const currentCount = parseInt(badge.textContent) || 0; 
							badge.textContent = `${currentCount + itemsToAppend.length} lượt`;
						}

						// c. Xóa ngày này khỏi danh sách cần render mới (để không bị lặp lại header)
						delete groups[firstDateOfNewBatch];
						const idx = dates.indexOf(firstDateOfNewBatch);
						if (idx > -1) dates.splice(idx, 1);
					}
				}
			}

			// 5. RENDER CÁC NHÓM CÒN LẠI (BÌNH THƯỜNG)
			let htmlContent = '';
			dates.forEach(date => {
				const items = groups[date];
				// Thêm class 'history-group' và thuộc tính 'data-date' để hỗ trợ việc tìm kiếm sau này
				htmlContent += `
					<div class="mb-3 history-group fade-in" data-date="${date}">
						<div class="d-flex align-items-center justify-content-between bg-light px-3 py-2 rounded mb-2 shadow-sm sticky-top" style="top: -1px; z-index: 5;">
							<span class="fw-bold text-dark small"><i class="bi bi-calendar-check me-1"></i> ${date}</span>
							<span class="badge theme-bg-primary rounded-pill" style="font-weight: normal;">${items.length} lượt</span>
						</div>
						<div class="list-group list-group-flush px-2">
							${items.map(log => createLogItemHtml(log)).join('')}
						</div>
					</div>
				`;
			});

			// Chèn HTML mới vào cuối container
			container.insertAdjacentHTML('beforeend', htmlContent);

			// 6. TẠO LẠI NÚT LOAD MORE (NẾU CÒN DỮ LIỆU)
			if (bikeHistoryHasMore) {
				const trigger = document.createElement('div');
				trigger.id = 'load-more-trigger';
				trigger.className = 'py-3 text-center text-muted small cursor-pointer';
				trigger.innerHTML = `<span class="spinner-border spinner-border-sm me-1 d-none" id="load-spinner"></span> <span id="load-text">Vuốt lên hoặc nhấn để xem thêm cũ hơn</span>`;
				
				trigger.addEventListener('click', () => triggerLoadMore());
				container.appendChild(trigger);
				
				// Auto Scroll
				setupInfiniteScroll(trigger);
			} else {
				const endMsg = document.createElement('div');
				endMsg.className = 'text-center py-3 text-muted small';
				endMsg.innerHTML = '--- Hết lịch sử ---';
				container.appendChild(endMsg);
			}
		}

		function triggerLoadMore() {
			if(bikeHistoryLoading || !bikeHistoryHasMore) return;
			
			// Hiệu ứng loading
			const spinner = document.getElementById('load-spinner');
			if(spinner) spinner.classList.remove('d-none');
			
			bikeHistoryPage++;
			loadBikeHistoryData(bikeHistoryPage);
		}

		function setupInfiniteScroll(target) {
			const observer = new IntersectionObserver((entries) => {
				if (entries[0].isIntersecting) {
					triggerLoadMore();
				}
			}, { threshold: 0.1 });
			observer.observe(target);
		}

		// --- HÀM VẼ BIỂU ĐỒ (Đã sửa sắp xếp Tăng dần chuẩn xác) ---
		function renderBikeChartFromServer(historyData) {
			const chartContainer = document.getElementById('bike-chart');
			if (!chartContainer) return;

			if (!historyData || historyData.length === 0) {
				chartContainer.innerHTML = '<div class="text-center py-5 text-muted small">Chưa có dữ liệu biểu đồ</div>';
				return;
			}

			// 1. Sắp xếp dữ liệu TĂNG DẦN (Cũ -> Mới)
			// Sử dụng hàm helper để parse ngày an toàn
			const parseDateVal = (dateStr) => {
				if (!dateStr) return 0;
				try {
					// dateStr dạng "15/01/2026"
					const parts = dateStr.trim().split('/'); 
					if (parts.length < 3) return 0;
					// Trả về Timestamp: Năm, Tháng (0-11), Ngày
					return new Date(parts[2], parseInt(parts[1]) - 1, parts[0]).getTime();
				} catch (e) { return 0; }
			};

			const sortedData = [...historyData].sort((a, b) => {
				return parseDateVal(a.date) - parseDateVal(b.date);
			});

			// 2. Cấu hình kích thước
			const itemWidth = 60; 
			const chartHeight = 160; 
			// Độ rộng tổng = số lượng cột * 60px (hoặc tối thiểu bằng chiều rộng màn hình)
			const totalWidth = Math.max(chartContainer.parentElement.offsetWidth, sortedData.length * itemWidth);
			
			const counts = sortedData.map(d => parseInt(d.count) || 0);
			// Tính giá trị lớn nhất để chia tỉ lệ chiều cao (thêm 20% đệm cho đẹp)
			const maxVal = Math.max(...counts, 5) * 1.2; 

			// 3. Tính tọa độ X, Y cho từng điểm
			const points = sortedData.map((d, i) => {
				const x = (i * itemWidth) + (itemWidth / 2); 
				const count = parseInt(d.count) || 0;
				const y = chartHeight - ((count / maxVal) * chartHeight);
				return { x, y, count, date: d.date };
			});

			// 4. Tạo đường cong mềm mại (Bezier Curve)
			const getControlPoint = (current, previous, next, reverse) => {
				const p = previous || current;
				const n = next || current;
				const smoothing = 0.2;
				const oX = n.x - p.x;
				const oY = n.y - p.y;
				const length = Math.sqrt(Math.pow(oX, 2) + Math.pow(oY, 2)) * smoothing;
				const angle = Math.atan2(oY, oX) + (reverse ? Math.PI : 0);
				return { x: current.x + Math.cos(angle) * length, y: current.y + Math.sin(angle) * length };
			};

			let pathD = `M ${points[0].x} ${points[0].y}`;
			for (let i = 0; i < points.length - 1; i++) {
				const p0 = points[i - 1];
				const p1 = points[i];
				const p2 = points[i + 1];
				const p3 = points[i + 2];
				const cp1 = getControlPoint(p1, p0, p2, false);
				const cp2 = getControlPoint(p2, p1, p3, true);
				pathD += ` C ${cp1.x} ${cp1.y}, ${cp2.x} ${cp2.y}, ${p2.x} ${p2.y}`;
			}

			// Tạo vùng màu bên dưới đường biểu đồ
			const areaPathD = `${pathD} L ${points[points.length - 1].x} ${chartHeight} L ${points[0].x} ${chartHeight} Z`;

			const strokeColor = 'var(--primary-color)'; 
			const circleColor = 'var(--surface-color, #fff)';

			// 5. Render SVG
			chartContainer.innerHTML = `
				<svg width="${totalWidth}" height="200" xmlns="http://www.w3.org/2000/svg">
					<defs>
						<linearGradient id="chartGradient" x1="0" x2="0" y1="0" y2="1">
							<stop offset="0%" stop-color="${strokeColor}" stop-opacity="0.4"/>
							<stop offset="100%" stop-color="${strokeColor}" stop-opacity="0.0"/>
						</linearGradient>
						<filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
							<feDropShadow dx="0" dy="4" stdDeviation="4" flood-color="${strokeColor}" flood-opacity="0.3"/>
						</filter>
					</defs>

					<line x1="0" y1="${chartHeight}" x2="${totalWidth}" y2="${chartHeight}" stroke="#eee" stroke-width="1" />
					<line x1="0" y1="${chartHeight/2}" x2="${totalWidth}" y2="${chartHeight/2}" stroke="#eee" stroke-width="1" stroke-dasharray="4" />

					<path d="${areaPathD}" fill="url(#chartGradient)" stroke="none" style="transition: fill 0.3s;" />

					<path d="${pathD}" fill="none" stroke="${strokeColor}" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" filter="url(#shadow)" style="transition: stroke 0.3s;" />

					${points.map((p, i) => `
						<g class="chart-point">
							${ (p.count > 0) ? 
								`<text x="${p.x}" y="${p.y - 12}" fill="${strokeColor}" font-size="11" text-anchor="middle" font-weight="bold">${p.count}</text>` 
								: '' 
							}
							<circle cx="${p.x}" cy="${p.y}" r="5" fill="${strokeColor}" stroke="${circleColor}" stroke-width="2" />
							<text x="${p.x}" y="${chartHeight + 25}" fill="#999" font-size="10" text-anchor="middle">${p.date.substring(0, 5)}</text>
						</g>
					`).join('')}
				</svg>
			`;

			// 6. Tự động cuộn sang phải (Right) để xem ngày mới nhất
			setTimeout(() => {
				const wrapper = chartContainer.parentElement; // div cha có overflow-x: auto
				if(wrapper) {
					wrapper.scrollLeft = wrapper.scrollWidth; // Cuộn hết cỡ sang phải
				}
			}, 100);
		}

		// --- HÀM RENDER LỊCH SỬ (GROUP BY DATE) ---
		function renderBikeHistoryFromServer(logsData) {
			const container = document.getElementById('bike-history-list');
			if (!container) return;

			if (!logsData || logsData.length === 0) {
				container.innerHTML = '<p class="text-center text-muted py-3 small">Chưa có dữ liệu chi tiết gần đây</p>';
				return;
			}

			// 1. Nhóm dữ liệu theo ngày
			const groups = {};
			logsData.forEach(item => {
				if (!item.date) return;
				if (!groups[item.date]) groups[item.date] = [];
				groups[item.date].push(item);
			});

			// 2. Tạo HTML
			let htmlContent = '';
			const dates = Object.keys(groups); // Danh sách các ngày
			
			// Lưu ý: logsData từ server thường đã được sort mới nhất -> cũ nhất
			// nên keys(groups) cũng sẽ theo thứ tự đó.

			dates.forEach(date => {
				const items = groups[date];
				
				// Header Ngày
				htmlContent += `
					<div class="mb-3">
						<div class="d-flex align-items-center justify-content-between bg-light px-3 py-2 rounded mb-2 shadow-sm sticky-top" style="top: 0px; z-index: 5;">
							<span class="fw-bold text-dark small"><i class="bi bi-calendar-check me-1"></i> ${date}</span>
							<span class="badge theme-bg-primary rounded-pill" style="font-weight: normal;">${items.length} lượt</span>
						</div>
						<div class="list-group list-group-flush px-2">
				`;
				
				// Items trong ngày
				items.forEach(log => {
					// Lấy chữ cái đầu của tên để làm Avatar
					const firstLetter = log.username ? log.username.charAt(0).toUpperCase() : '?';
					
					htmlContent += `
						<div class="list-group-item border-0 p-2 d-flex justify-content-between align-items-center mb-1 rounded hover-bg-light">
							<div class="d-flex align-items-center">
								 <div class="rounded-circle theme-bg-primary d-flex align-items-center justify-content-center text-white me-2 shadow-sm" style="width: 32px; height: 32px; font-size: 12px; font-weight: bold;">
									${firstLetter}
								 </div>
								 <div class="d-flex flex-column">
									 <span class="small fw-bold text-dark">${log.username || 'Ẩn danh'}</span>
								 </div>
							</div>
							<div class="text-end">
								<span class="badge bg-light text-secondary border fw-normal font-monospace">${log.time || '--:--'}</span>
							</div>
						</div>
					`;
				});
				
				htmlContent += `
						</div>
					</div>
				`;
			});

			container.innerHTML = htmlContent;
		}

		function calculateGoldStats() {
		  const goldEntries = allData.filter(d => d.type === 'gold_entry');
		  
		  if (goldEntries.length === 0) {
			return { highest: null, lowest: null, highestDate: null, lowestDate: null };
		  }
		  
		  let highest = goldEntries[0];
		  let lowest = goldEntries[0];
		  
		  goldEntries.forEach(entry => {
			if (entry.sellPrice > highest.sellPrice) highest = entry;
			if (entry.buyPrice < lowest.buyPrice) lowest = entry;
		  });
		  
		  return {
			highest: highest.sellPrice,
			highestDate: highest.date,
			lowest: lowest.buyPrice,
			lowestDate: lowest.date
		  };
		}

		function renderGoldChart() {
		  const goldEntries = allData.filter(d => d.type === 'gold_entry');
		  const chartContainer = document.getElementById('gold-chart');
		  
		  const days = [];
		  for (let i = 6; i >= 0; i--) {
			const date = new Date();
			date.setDate(date.getDate() - i);
			days.push(date.toISOString().split('T')[0]);
		  }
		  
		  const buyPrices = days.map(day => {
			const entry = goldEntries.find(e => e.date === day);
			return entry ? entry.buyPrice : null;
		  });
		  
		  const sellPrices = days.map(day => {
			const entry = goldEntries.find(e => e.date === day);
			return entry ? entry.sellPrice : null;
		  });
		  
		  const allPrices = [...buyPrices, ...sellPrices].filter(p => p !== null);
		  const maxPrice = allPrices.length > 0 ? Math.max(...allPrices) : 1;
		  const minPrice = allPrices.length > 0 ? Math.min(...allPrices) : 0;
		  const range = maxPrice - minPrice || 1;
		  
		  chartContainer.innerHTML = `
			<div class="position-relative" style="height: 100%;">
			  <svg width="100%" height="100%" style="position: absolute; top: 0; left: 0;">
				${days.map((day, i) => {
				  const x = (i / (days.length - 1)) * 100;
				  const buyY = buyPrices[i] ? 100 - ((buyPrices[i] - minPrice) / range * 80) : null;
				  const sellY = sellPrices[i] ? 100 - ((sellPrices[i] - minPrice) / range * 80) : null;
				  const nextBuyY = buyPrices[i + 1] ? 100 - ((buyPrices[i + 1] - minPrice) / range * 80) : null;
				  const nextSellY = sellPrices[i + 1] ? 100 - ((sellPrices[i + 1] - minPrice) / range * 80) : null;
				  const nextX = ((i + 1) / (days.length - 1)) * 100;
				  
				  let lines = '';
				  if (buyY !== null && nextBuyY !== null && i < days.length - 1) {
					lines += `<line x1="${x}%" y1="${buyY}%" x2="${nextX}%" y2="${nextBuyY}%" stroke="#198754" stroke-width="2"/>`;
				  }
				  if (sellY !== null && nextSellY !== null && i < days.length - 1) {
					lines += `<line x1="${x}%" y1="${sellY}%" x2="${nextX}%" y2="${nextSellY}%" stroke="#dc3545" stroke-width="2"/>`;
				  }
				  
				  let circles = '';
				  if (buyY !== null) {
					circles += `<circle cx="${x}%" cy="${buyY}%" r="4" fill="#198754"/>`;
				  }
				  if (sellY !== null) {
					circles += `<circle cx="${x}%" cy="${sellY}%" r="4" fill="#dc3545"/>`;
				  }
				  
				  return lines + circles;
				}).join('')}
			  </svg>
			  <div class="d-flex justify-content-between position-absolute w-100" style="bottom: 0;">
				${days.map(day => {
				  const date = new Date(day);
				  const dayName = ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'][date.getDay()];
				  return `<small class="text-muted">${dayName}</small>`;
				}).join('')}
			  </div>
			</div>
			<div class="mt-3 d-flex gap-3 justify-content-center">
			  <div><span class="badge bg-success">●</span> Giá mua</div>
			  <div><span class="badge bg-danger">●</span> Giá bán</div>
			</div>
		  `;
		}

		function renderGoldHistory() {
		  const goldEntries = allData.filter(d => d.type === 'gold_entry').sort((a, b) => new Date(b.date) - new Date(a.date));
		  const container = document.getElementById('gold-history-list');
		  
		  if (goldEntries.length === 0) {
			container.innerHTML = '<p class="text-center text-muted py-3">Chưa có dữ liệu</p>';
			return;
		  }
		  
		  container.innerHTML = goldEntries.map(entry => {
			const date = new Date(entry.date);
			const dateStr = date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
			return `
			  <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
				<div>
				  <div class="d-flex gap-3 mb-1">
					<span class="text-success fw-semibold">${entry.buyPrice?.toLocaleString('vi-VN')}</span>
					<span class="text-danger fw-semibold">${entry.sellPrice?.toLocaleString('vi-VN')}</span>
				  </div>
				  <small class="text-muted">${dateStr}</small>
				  ${entry.note ? `<p class="small text-muted mb-0 mt-1">${entry.note}</p>` : ''}
				</div>
				<button class="btn btn-sm btn-outline-danger delete-gold-entry" data-id="${entry.__backendId}">
				  <i class="bi bi-trash"></i>
				</button>
			  </div>
			`;
		  }).join('');
		}

		function showGoldStats() {
		  const stats = calculateGoldStats();
		  
		  if (stats.highest !== null) {
			document.getElementById('gold-highest-price').textContent = stats.highest.toLocaleString('vi-VN');
			document.getElementById('gold-highest-date').textContent = new Date(stats.highestDate).toLocaleDateString('vi-VN');
		  } else {
			document.getElementById('gold-highest-price').textContent = '-';
			document.getElementById('gold-highest-date').textContent = '-';
		  }
		  
		  if (stats.lowest !== null) {
			document.getElementById('gold-lowest-price').textContent = stats.lowest.toLocaleString('vi-VN');
			document.getElementById('gold-lowest-date').textContent = new Date(stats.lowestDate).toLocaleDateString('vi-VN');
		  } else {
			document.getElementById('gold-lowest-price').textContent = '-';
			document.getElementById('gold-lowest-date').textContent = '-';
		  }
		  
		  renderGoldChart();
		  renderGoldHistory();
		  goldStatsModal.show();
		}

		function renderStats() {
		  const container = document.getElementById('stats-container');
		  const leftColumn = statsLayout.filter(s => s.column === 0);
		  const rightColumn = statsLayout.filter(s => s.column === 1);
		  const hasRightColumn = rightColumn.length > 0;
		  
		  if (hasRightColumn) container.classList.add('two-columns');
		  else container.classList.remove('two-columns');
		  
		  const renderCard = (stat) => {
			const sizeClass = `size-${stat.size}`;
			
			if (stat.id === 'bike') {
			  return `
				<div class="stat-card p-3 ${sizeClass}" data-stat-id="bike" draggable="${isEditMode}">
				  <div class="drag-handle"><i class="bi bi-arrows-move"></i></div>
				  <div class="size-toggle"><i class="bi bi-arrows-fullscreen"></i></div>
				  <button class="btn btn-link p-0 position-absolute top-0 end-0 m-2 text-muted bike-chart-btn" style="z-index: 5;">
					<i class="bi bi-bar-chart-fill fs-5"></i>
				  </button>
				  <div class="text-center">
					<div class="icon-box theme-bg-primary text-white mx-auto mb-2 baby-run-btn" style="cursor: pointer; transition: transform 0.1s;">
					  <span style="font-size: 32px; filter: brightness(0) invert(1);">👣</span>
					</div>
					<p class="text-muted small mb-1">Lượt đạp hôm nay</p>
					<p id="bike-count" class="fs-2 fw-bold theme-text-primary mb-0">0</p>
				  </div>
				</div>
			  `;
			} else if (stat.id === 'days') {
			  return `
				<div class="stat-card p-3 ${sizeClass}" data-stat-id="days" draggable="${isEditMode}">
				  <div class="drag-handle"><i class="bi bi-arrows-move"></i></div>
				  <div class="size-toggle"><i class="bi bi-arrows-fullscreen"></i></div>
				  <div class="d-flex align-items-center">
					<div class="icon-box theme-bg-secondary text-white me-3">
					  <i class="bi bi-heart-fill fs-4"></i>
					</div>
					<div>
					  <p class="text-muted small mb-1">Ngày bên nhau</p>
					  <p id="days-together" class="fs-4 fw-bold theme-text-secondary mb-0">0 ngày</p>
					</div>
				  </div>
				</div>
			  `;
			} else if (stat.id === 'memory') {
			  return `
				<div class="stat-card p-3 ${sizeClass}" data-stat-id="memory" draggable="${isEditMode}">
				  <div class="drag-handle"><i class="bi bi-arrows-move"></i></div>
				  <div class="size-toggle"><i class="bi bi-arrows-fullscreen"></i></div>
				  <div class="d-flex align-items-center">
					<div class="icon-box text-white me-3" style="background: #6f42c1;">
					  <i class="bi bi-star-fill fs-4"></i>
					</div>
					<div>
					  <p class="text-muted small mb-1">Kỷ niệm</p>
					  <p id="memory-count" class="fs-4 fw-bold mb-0" style="color: #6f42c1;">0</p>
					</div>
				  </div>
				</div>
			  `;
			} else if (stat.id === 'event') {
			  return `
				<div class="stat-card p-3 ${sizeClass}" data-stat-id="event" draggable="${isEditMode}">
				  <div class="drag-handle"><i class="bi bi-arrows-move"></i></div>
				  <div class="size-toggle"><i class="bi bi-arrows-fullscreen"></i></div>
				  <div class="d-flex align-items-center mb-2">
					<div class="icon-box text-white me-3" style="background: #e91e63;">
					  <i class="bi bi-calendar-heart fs-4"></i>
					</div>
					<div>
					  <p class="text-muted small mb-1">Sự kiện tiếp theo</p>
					  <p id="next-event-countdown" class="fs-5 fw-bold mb-0" style="color: #e91e63;">Còn 39 ngày</p>
					</div>
				  </div>
				  <p id="next-event-name" class="small fw-semibold theme-text-primary ms-5 ps-2 mb-0">First day of love</p>
				</div>
			  `;
			} else if (stat.id === 'gold') {
			  return `
				<div class="stat-card p-3 ${sizeClass}" data-stat-id="gold" draggable="${isEditMode}">
				  <div class="drag-handle"><i class="bi bi-arrows-move"></i></div>
				  <div class="size-toggle"><i class="bi bi-arrows-fullscreen"></i></div>
				  <button class="btn btn-link p-0 position-absolute top-0 end-0 m-2 text-muted gold-chart-btn" style="z-index: 5;">
					<i class="bi bi-bar-chart-fill fs-5"></i>
				  </button>
				  <div class="d-flex align-items-center mb-2">
					<div class="icon-box text-white me-3" style="background: #f59e0b;">
					  <i class="bi bi-coin fs-4"></i>
					</div>
					<div>
					  <p class="text-muted small mb-1">Giá vàng</p>
					</div>
				  </div>
				  <div class="row g-2 ms-5 ps-2">
					<div class="col-6">
					  <small class="text-muted">Giá mua</small>
					  <p id="gold-buy" class="fs-5 fw-bold text-success mb-0">-</p>
					</div>
					<div class="col-6">
					  <small class="text-muted">Giá bán</small>
					  <p id="gold-sell" class="fs-5 fw-bold text-danger mb-0">-</p>
					</div>
				  </div>
				</div>
			  `;
			}
			return '';
		  };
		  
		  if (hasRightColumn) {
			container.innerHTML = leftColumn.map(renderCard).join('') + rightColumn.map(renderCard).join('');
		  } else {
			container.innerHTML = leftColumn.map(renderCard).join('');
		  }
		  
		  if (isEditMode) {
			container.classList.add('layout-edit-mode');
			setupDragAndDrop();
		  } else {
			container.classList.remove('layout-edit-mode');
		  }
		}

		function setupDragAndDrop() {
		  const cards = document.querySelectorAll('.stat-card');
		  
		  cards.forEach(card => {
			card.addEventListener('dragstart', (e) => {
			  draggedElement = card;
			  draggedId = card.dataset.statId;
			  card.classList.add('dragging');
			  e.dataTransfer.effectAllowed = 'move';
			});
			
			card.addEventListener('dragend', () => {
			  card.classList.remove('dragging');
			  document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('border', 'border-primary'));
			  draggedElement = null;
			  draggedId = null;
			});
			
			card.addEventListener('dragover', (e) => {
			  e.preventDefault();
			  if (draggedElement === card) return;
			  card.classList.add('border', 'border-primary');
			});
			
			card.addEventListener('dragleave', () => {
			  card.classList.remove('border', 'border-primary');
			});
			
			card.addEventListener('drop', (e) => {
			  e.preventDefault();
			  if (!draggedId || draggedElement === card) return;
			  
			  const targetId = card.dataset.statId;
			  const draggedStat = statsLayout.find(s => s.id === draggedId);
			  const targetStat = statsLayout.find(s => s.id === targetId);
			  
			  if (!draggedStat || !targetStat) return;
			  
			  const rect = card.getBoundingClientRect();
			  const midX = rect.left + rect.width / 2;
			  let newColumn = targetStat.column;
			  
			  if (e.clientX < midX && targetStat.column === 1) newColumn = 0;
			  else if (e.clientX >= midX && targetStat.column === 0) newColumn = 1;
			  
			  statsLayout = statsLayout.filter(s => s.id !== draggedId);
			  draggedStat.column = newColumn;
			  
			  const newTargetIndex = statsLayout.indexOf(targetStat);
			  if (newTargetIndex >= 0) {
				if (e.clientX < midX) statsLayout.splice(newTargetIndex, 0, draggedStat);
				else statsLayout.splice(newTargetIndex + 1, 0, draggedStat);
			  } else {
				statsLayout.push(draggedStat);
			  }
			  
			  card.classList.remove('border', 'border-primary');
			  renderStats();
			  updateStats();
			});
			
			const sizeToggle = card.querySelector('.size-toggle');
			sizeToggle.addEventListener('click', (e) => {
			  e.stopPropagation();
			  const statId = card.dataset.statId;
			  const stat = statsLayout.find(s => s.id === statId);
			  if (!stat) return;
			  
			  const sizes = ['small', 'medium', 'large'];
			  const currentIndex = sizes.indexOf(stat.size);
			  stat.size = sizes[(currentIndex + 1) % sizes.length];
			  
			  renderStats();
			  updateStats();
			});
		  });
		}

		function enterEditMode() {
		  isEditMode = true;
		  document.getElementById('edit-mode-banner').classList.remove('d-none');
		  profileModal.hide();
		  
		  currentTab = 'home';
		  document.querySelectorAll('.nav-link').forEach(b => b.classList.remove('active'));
		  document.querySelector('[data-tab="home"]').classList.add('active');
		  
		  document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('d-none'));
		  document.getElementById('tab-home').classList.remove('d-none');
		  
		  renderStats();
		  updateStats();
		}

		function exitEditMode() {
		  isEditMode = false;
		  document.getElementById('edit-mode-banner').classList.add('d-none');
		  renderStats();
		  updateStats();
		  saveLayoutToProfile();
		}

		async function saveLayoutToProfile() {
		  if (!currentProfile) {
			if (recordCount >= 999) {
			  showToast('Đã đạt giới hạn 999 mục!');
			  return;
			}
			
			const result = await window.dataSdk.create({
			  type: 'profile',
			  username: '',
			  fullName: '',
			  avatarData: '',
			  themeName: currentTheme,
			  statsLayout: JSON.stringify(statsLayout),
			  createdAt: new Date().toISOString()
			});
			
			if (result.isOk) showToast('Đã lưu bố cục!');
		  } else {
			await window.dataSdk.update({
			  ...currentProfile,
			  statsLayout: JSON.stringify(statsLayout)
			});
			showToast('Đã lưu bố cục!');
		  }
		}

		function renderPostImages(images, layout) {
			if (!images || images.length === 0) return '';
			const count = images.length;
			let layoutClass = '';

			// Logic chọn class CSS
			if (count === 1) {
				layoutClass = 'layout-1';
			} else if (count === 2) {
				layoutClass = 'layout-2';
			} else {
				// Từ 3 ảnh trở lên -> Xét theo Layout
				// Mặc định nếu không có layout hoặc layout lỗi thì về grid-2x2
				const validLayout = layout || 'grid-2x2';

				if (validLayout === '1-wide') {
					layoutClass = 'layout-1-wide';
				} else if (validLayout === '1-tall') {
					layoutClass = 'layout-1-tall';
				} else {
					// Mặc định là Grid 2x2
					layoutClass = 'layout-grid-2x2';
				}
			}

			let html = `<div class="post-image-grid ${layoutClass}">`;

			// Số lượng ảnh tối đa được hiển thị (tùy theo layout mà hiển thị 3, 4 hay 5 ảnh)
			// Để đơn giản và đẹp, ta hiển thị tối đa 4 khung ảnh (nếu > 4 thì hiện số +)
			// Hoặc với layout 1-wide/1-tall thì hiển thị 3 khung.
			
			let displayLimit = 4;
			if (layoutClass === 'layout-1-wide' || layoutClass === 'layout-1-tall') {
				displayLimit = 3; // Layout này chỉ đẹp khi hiện 3 ảnh (1 to 2 nhỏ)
			}

			const showCount = Math.min(count, displayLimit);

			for (let i = 0; i < showCount; i++) {
				html += `<div class="img-box">`;
				html += `<img src="${images[i]}" alt="Image">`;
				
				// Nếu là ảnh cuối cùng được vẽ VÀ tổng số ảnh nhiều hơn số chỗ hiển thị
				if (i === showCount - 1 && count > displayLimit) {
					html += `<div class="image-overlay">+${count - displayLimit}</div>`;
				}
				
				html += `</div>`;
			}

			html += '</div>';
			return html;
		}
		
		// --- HÀM RENDER POSTS (Đã thêm Sắp xếp Mới -> Cũ) ---
		// Hàm tạo HTML cho 1 bài viết (Tách ra để tái sử dụng)
		function createPostHtml(post) {
			const safeContent = encodeURIComponent(post.content || '');
			const displayName = post.fullname || post.username || 'Người dùng ẩn danh';
			const avatarUrl = post.avatar; 
			const images = parseImages(post.imageData);

			const avatarHtml = avatarUrl 
				? `<img src="${avatarUrl}" class="w-100 h-100 object-fit-cover" alt="Avatar">`
				: `<div class="w-100 h-100 d-flex align-items-center justify-content-center bg-light text-primary fw-bold" style="font-size: 1.2rem;">${displayName.charAt(0).toUpperCase()}</div>`;
			
			// [MỚI] Logic hiển thị Note trạng thái
			let statusBadge = '';
			if (post.isUploading) {
				// [CẬP NHẬT] Lấy nội dung tiến trình từ biến uploadStatus (nếu có)
				const statusText = post.uploadStatus || 'Đang đăng...';
				
				// Thêm ID: id="status-badge-${post.__backendId}" để dễ cập nhật
				statusBadge = `
					<span id="status-badge-${post.__backendId}" class="badge bg-warning text-dark ms-auto animate-pulse">
						<span class="spinner-border spinner-border-sm me-1" style="width: 0.7rem; height: 0.7rem;"></span>
						${statusText}
					</span>`;
			} else {
				// Đã xong: Hiện nút menu 3 chấm (như cũ)
				statusBadge = (currentProfile && currentProfile.username === post.username) 
					? `<button class="btn btn-sm btn-link text-muted post-menu-btn ms-auto" data-id="${post.__backendId}">
							<i class="bi bi-three-dots-vertical"></i>
					   </button>` 
					: '<div class="ms-auto"></div>';
			}

			return `
				<div class="post-card p-3 mb-3 fade-in" id="post-${post.__backendId}">
					<div class="d-flex align-items-center mb-3">
						<div class="avatar-circle avatar-circle-sm me-2 overflow-hidden border">
							${avatarHtml}
						</div>
						<div>
							<p class="fw-bold mb-0 text-dark">${displayName}</p>
							<small class="text-muted" style="font-size: 0.8rem;">
								<i class="bi bi-clock me-1"></i>${post.createdAt}
							</small>
						</div>
						
						${statusBadge}
						
					</div>
					
					${post.content ? `<div class="mb-3" style="white-space: pre-wrap; font-size: 1rem; color: #374151;">${post.content}</div>` : ''}
					
					${renderPostImages(images, post.layout || 'grid-2x2')}
					
					<div class="d-flex gap-4 pt-2 border-top mt-2">
						<button class="btn btn-sm btn-link text-decoration-none like-btn text-muted" data-id="${post.__backendId}" ${post.isUploading ? 'disabled' : ''}>
							<i class="bi bi-heart${post.liked ? '-fill text-danger' : ''} fs-5"></i>
							<span class="ms-1">${post.likes > 0 ? post.likes : 'Thích'}</span>
						</button>
						<button class="btn btn-sm btn-link text-decoration-none text-muted comment-btn" data-id="${post.__backendId}" ${post.isUploading ? 'disabled' : ''}>
							<i class="bi bi-chat fs-5"></i>
							<span class="ms-1">Bình luận</span>
						</button>
					</div>
				</div>
			`;
		}

		// Hàm Render chính (Hỗ trợ Append)
		function renderPostsPaged(newPosts, page) {
			const container = document.getElementById('posts-container');
			
			// Xóa trigger cũ
			const oldTrigger = document.getElementById('feed-load-more');
			if(oldTrigger) oldTrigger.remove();

			// Nếu trang 1: Xóa trắng container và check rỗng
			if (page === 1) {
				container.innerHTML = '';
				if (!newPosts || newPosts.length === 0) {
					container.innerHTML = `
						<div class="text-center py-5">
							<i class="bi bi-newspaper theme-text-primary" style="font-size: 4rem;"></i>
							<p class="fw-semibold fs-5 mt-3">Chưa có bài đăng</p>
							<p class="text-muted">Nhấn + để tạo bài viết đầu tiên</p>
						</div>
					`;
					return;
				}
			}

			// Append bài mới
			let html = newPosts.map(post => createPostHtml(post)).join('');
			container.insertAdjacentHTML('beforeend', html);

			// Thêm Trigger Load More nếu còn dữ liệu
			if (feedHasMore) {
				const trigger = document.createElement('div');
				trigger.id = 'feed-load-more';
				trigger.className = 'py-4 text-center text-muted small';
				trigger.innerHTML = `<div class="spinner-border spinner-border-sm text-secondary" role="status"></div> Đang tải thêm tin...`;
				
				container.appendChild(trigger);
				
				// Setup Infinite Scroll
				const observer = new IntersectionObserver((entries) => {
					if (entries[0].isIntersecting && !feedLoading) {
						feedPage++; // Tăng số trang
						loadFeedData(feedPage); // Gọi API trang tiếp theo
					}
				}, { threshold: 0.1 });
				
				observer.observe(trigger);
			} else if (page > 1) {
				// Đã hết tin để load
				container.insertAdjacentHTML('beforeend', '<div class="text-center py-4 text-muted small">--- Bạn đã xem hết tin ---</div>');
			}
		}

		// Giữ lại hàm renderPosts cũ (nhưng gọi sang hàm mới) để tương thích với các đoạn code khác gọi nó
		function renderPosts() {
			// Hàm này chủ yếu dùng khi Create/Edit post xong muốn vẽ lại tất cả
			// Trong logic mới, tốt nhất là chỉ render lại từ đầu mảng serverFeedData
			renderPostsPaged(serverFeedData, 1);
		}

		function renderAlbums() {
		  const container = document.getElementById('albums-container');
		  const albums = allData.filter(d => d.type === 'album').sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
		  
		  if (albums.length === 0) {
			container.innerHTML = `
			  <div class="col-12 text-center py-5">
				<i class="bi bi-folder theme-text-primary" style="font-size: 4rem;"></i>
				<p class="fw-semibold fs-5 mt-3">Chưa có album</p>
				<p class="text-muted">Tạo album để sắp xếp ảnh</p>
			  </div>
			`;
			return;
		  }

		  container.innerHTML = albums.map(album => {
			const photos = allData.filter(d => d.type === 'album_photo' && d.albumId === album.__backendId);
			const coverImg = photos[0]?.imageData;
			
			return `
			  <div class="col-6">
				<div class="album-card album-item" data-album-id="${album.__backendId}" style="cursor: pointer;">
				  <div class="ratio ratio-1x1 bg-light rounded-top overflow-hidden">
					${coverImg 
					  ? `<img src="${coverImg}" class="object-fit-cover" alt="Album">`
					  : `<div class="d-flex align-items-center justify-content-center"><i class="bi bi-folder theme-text-primary" style="font-size: 3rem;"></i></div>`
					}
				  </div>
				  <div class="p-2">
					<p class="fw-bold mb-0 text-truncate">${album.albumName}</p>
					<small class="text-muted">${photos.length} ảnh</small>
				  </div>
				</div>
			  </div>
			`;
		  }).join('');
		}

		function renderAlbumPhotos() {
		  const container = document.getElementById('album-photos');
		  const photos = allData.filter(d => d.type === 'album_photo' && d.albumId === currentAlbumId);
		  
		  if (photos.length === 0) {
			container.innerHTML = `
			  <div class="col-12 text-center py-5 text-muted">
				<i class="bi bi-camera" style="font-size: 3rem;"></i>
				<p class="mt-2">Chưa có ảnh</p>
			  </div>
			`;
			return;
		  }

		  container.innerHTML = photos.map(photo => `
			<div class="col-4">
			  <div class="position-relative">
				<img src="${photo.imageData}" class="w-100 rounded ratio ratio-1x1 object-fit-cover" alt="Photo">
				<button class="btn btn-danger btn-sm position-absolute top-0 end-0 m-1 delete-photo-btn" data-id="${photo.__backendId}">
				  <i class="bi bi-x-lg"></i>
				</button>
			  </div>
			</div>
		  `).join('');
		}

		function renderComments(postId) {
		  const post = allData.find(d => d.__backendId === postId);
		  if (!post) return;
		  
		  const comments = parseComments(post.comments);
		  const container = document.getElementById('comments-list');
		  
		  if (comments.length === 0) {
			container.innerHTML = `<p class="text-center text-muted py-5">Chưa có bình luận</p>`;
			return;
		  }

		  container.innerHTML = comments.map(comment => `
			<div class="card mb-2">
			  <div class="card-body p-3">
				<div class="d-flex align-items-center mb-2">
				  <div class="avatar-circle avatar-circle-sm me-2" style="width: 32px; height: 32px;">
					<span class="small theme-text-primary fw-bold">${comment.author?.[0]?.toUpperCase() || 'U'}</span>
				  </div>
				  <div>
					<p class="fw-bold small mb-0">${comment.author || 'Người dùng'}</p>
					<small class="text-muted">${formatDate(comment.time)}</small>
				  </div>
				</div>
				<p class="mb-0 ms-5">${comment.text}</p>
			  </div>
			</div>
		  `).join('');
		}

		function updateImagePreview() {
			const previewContainer = document.getElementById('image-preview-container');
			const imageOptions = document.getElementById('image-options'); // [MỚI]
			const layoutSelector = document.getElementById('layout-selector');
			const postBtn = document.getElementById('post-btn');
			const imageCount = document.getElementById('image-count');
			const gridContainer = document.getElementById('images-preview-grid');

			if (currentImages.length === 0) {
				previewContainer.classList.add('d-none');
				imageOptions.classList.add('d-none');   // Ẩn nút HD
				layoutSelector.classList.add('d-none'); // Ẩn Layout
				postBtn.disabled = !document.getElementById('post-input').value.trim();
				return;
			}

			// Hiển thị container ảnh
			previewContainer.classList.remove('d-none');
			imageCount.textContent = currentImages.length;
			postBtn.disabled = false;

			// [LOGIC MỚI] Hiển thị nút HD ngay khi có ảnh
			imageOptions.classList.remove('d-none');

			// [LOGIC MỚI] Chỉ hiển thị chọn Layout nếu >= 3 ảnh
			if (currentImages.length >= 3) {
				layoutSelector.classList.remove('d-none');
			} else {
				layoutSelector.classList.add('d-none');
			}

			gridContainer.innerHTML = renderPostImages(currentImagePreviews, selectedLayout);
		}
		
		// Sửa thêm: Nút xóa tất cả
		document.getElementById('clear-all-images').addEventListener('click', () => {
		  currentImages = [];
		  currentImagePreviews = [];
		  updateImagePreview();
		});

		function compressImage(file, maxWidth = 1920, quality = 0.8) {
		  return new Promise((resolve) => {
			const reader = new FileReader();
			reader.onload = (e) => {
			  const img = new Image();
			  img.onload = () => {
				const canvas = document.createElement('canvas');
				let width = img.width;
				let height = img.height;
				
				// Resize thông minh: Chỉ thu nhỏ nếu ảnh quá lớn (>1920px)
				if (width > maxWidth) {
				  height = (height * maxWidth) / width;
				  width = maxWidth;
				}
				
				canvas.width = width;
				canvas.height = height;
				const ctx = canvas.getContext('2d');
				
				// Vẽ ảnh lên canvas (làm mịn ảnh)
				ctx.imageSmoothingEnabled = true;
				ctx.imageSmoothingQuality = 'high';
				ctx.drawImage(img, 0, 0, width, height);
				
				// Xuất ra Base64 chất lượng cao
				resolve(canvas.toDataURL('image/jpeg', quality));
			  };
			  img.src = e.target.result;
			};
			reader.readAsDataURL(file);
		  });
		}

		// Notifications
		// --- XỬ LÝ THÔNG BÁO (NOTIFICATIONS) ---

		// 1. Nút Đánh dấu tất cả đã đọc
		document.getElementById('mark-all-read').addEventListener('click', async () => {
			// 1. OPTIMISTIC UPDATE (Cập nhật giao diện ngay lập tức)
			const badges = document.querySelectorAll('.notification-item.unread');
			badges.forEach(el => {
				el.classList.remove('unread');
				// Tìm và xóa chấm đỏ
				const dot = el.querySelector('.notification-dot');
				if(dot) dot.remove();
			});
			
			// Ẩn badge đỏ trên header
			document.getElementById('notification-badge').classList.add('d-none');
			
			// Thông báo cho người dùng cảm thấy nhanh
			showToast('Đã đánh dấu tất cả đã đọc');

			// 2. BACKGROUND SYNC (Gửi lệnh lên server chạy ngầm)
			try {
				await sendToServer({
					action: 'notification_action',
					type: 'mark_all_read'
				});
				// Không cần làm gì thêm nếu thành công vì giao diện đã xong rồi
			} catch (e) {
				console.error("Lỗi sync:", e);
				// Nếu lỗi quá nghiêm trọng mới cần báo, còn không thì bỏ qua để trải nghiệm mượt
			}
		});

		// 2. Nút Xóa tất cả thông báo
		document.getElementById('clear-all-notifications').addEventListener('click', async () => {
			if(!confirm("Bạn có chắc muốn xóa sạch lịch sử thông báo không?")) return;

			const list = document.getElementById('notifications-list');
			const originalContent = list.innerHTML; // Backup để hoàn tác nếu lỗi

			// 1. OPTIMISTIC UPDATE
			list.innerHTML = `
			  <div class="text-center py-5">
				<i class="bi bi-bell-slash theme-text-primary" style="font-size: 3rem;"></i>
				<p class="fw-semibold mt-3">Chưa có thông báo</p>
			  </div>
			`;
			document.getElementById('notification-badge').classList.add('d-none');
			showToast('Đã xóa tất cả thông báo');

			// 2. BACKGROUND SYNC
			try {
				const res = await sendToServer({
					action: 'notification_action',
					type: 'delete_all'
				});
				if (res.status !== 'success') throw new Error(res.message);
				
				// Xóa cache local
				serverNotifications = [];
				
			} catch (e) {
				console.error(e);
				showToast('Lỗi kết nối! Đang khôi phục...');
				list.innerHTML = originalContent; // Hoàn tác giao diện
			}
		});

		document.getElementById('notifications-list').addEventListener('click', async (e) => {
			// 1. XỬ LÝ TOGGLE TRẠNG THÁI (Đọc <-> Chưa đọc)
			const notifItem = e.target.closest('.notification-item');
			
			// Chỉ xử lý nếu click vào item và KHÔNG phải click vào nút xóa
			if (notifItem && !e.target.closest('.delete-notification')) {
				const notifId = notifItem.dataset.id;
				
				// Kiểm tra trạng thái hiện tại trên giao diện
				const isCurrentlyUnread = notifItem.classList.contains('unread');
				
				// Logic mới: Nếu đang "Chưa đọc" -> Thành "Đã đọc" (True)
				//            Nếu đang "Đã đọc"   -> Thành "Chưa đọc" (False)
				const nextStateIsRead = isCurrentlyUnread; 
				
				// --- A. OPTIMISTIC UI UPDATE ---
				if (nextStateIsRead) {
					// Chuyển thành ĐÃ ĐỌC
					notifItem.classList.remove('unread');
					const dot = notifItem.querySelector('.notification-dot');
					if(dot) dot.remove();
				} else {
					// Chuyển thành CHƯA ĐỌC
					notifItem.classList.add('unread');
					// Thêm chấm đỏ nếu chưa có
					if (!notifItem.querySelector('.notification-dot')) {
						 const flexContainer = notifItem.querySelector('.d-flex');
						 const dotHtml = `<div class="notification-dot ms-auto me-3" style="flex-shrink: 0;"></div>`;
						 flexContainer.insertAdjacentHTML('beforeend', dotHtml);
					}
				}
				
				// --- B. CẬP NHẬT CACHE LOCAL ---
				const cachedItem = serverNotifications.find(n => n.__backendId === notifId);
				if(cachedItem) cachedItem.isRead = nextStateIsRead;

				// --- C. GỬI SERVER (BACKGROUND) ---
				sendToServer({
					action: 'notification_action',
					type: 'toggle_read',
					id: notifId,
					status: nextStateIsRead
				}).catch(err => {
					console.error("Lỗi toggle:", err);
					// Có thể revert lại UI ở đây nếu muốn chặt chẽ
				});
				
				return; // Dừng xử lý để không chạy tiếp logic khác
			}
		  
			// 2. XỬ LÝ NÚT XÓA 1 THÔNG BÁO (Logic cũ giữ nguyên hoặc update lạc quan tương tự)
			const deleteBtn = e.target.closest('.delete-notification');
			if (deleteBtn) {
				if(!confirm('Xóa thông báo này?')) return;
				
				const notifItem = deleteBtn.closest('.notification-item');
				const notifId = deleteBtn.dataset.id;
				
				// Optimistic Remove
				if(notifItem) {
					notifItem.style.transition = "opacity 0.3s";
					notifItem.style.opacity = "0";
					setTimeout(() => notifItem.remove(), 300);
				}
				
				sendToServer({ action: 'notification_action', type: 'delete_one', id: notifId }) // Bạn cần thêm case 'delete_one' ở server nếu chưa có, hoặc dùng logic cũ
				.catch(console.error);
			}
		});

 
		// Navigation điều hướng 
		// --- SỬA LẠI LOGIC CHUYỂN TAB ---
		document.querySelectorAll('.nav-link').forEach(btn => {
		  btn.addEventListener('click', () => {
			if (isEditMode) {
			  showToast('Vui lòng thoát chế độ chỉnh sửa trước!');
			  return;
			}
			
			const targetTab = btn.dataset.tab; // feed, home, albums
			
			// 1. Cập nhật UI Active cho nút bấm
			document.querySelectorAll('.nav-link').forEach(b => b.classList.remove('active'));
			btn.classList.add('active');
			
			// 2. Ẩn/Hiện Tab Content (Chỉ thao tác CSS, không đụng vào dữ liệu)
			document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('d-none'));
			document.getElementById(`tab-${targetTab}`).classList.remove('d-none');
			
			currentTab = targetTab;
			
			// 3. Xử lý nút FAB (Nút tròn +)
			const fabBtn = document.getElementById('fab-btn');
			if (currentTab === 'home') fabBtn.classList.add('d-none');
			else fabBtn.classList.remove('d-none');
			
			// 4. [TỐI ƯU] KHÔNG RESET DỮ LIỆU KHI CHUYỂN TAB
			// Chỉ tải lần đầu tiên nếu chưa có dữ liệu
			if (currentTab === 'feed' && serverFeedData.length === 0) {
				loadFeedData(1);
			}
			else if (currentTab === 'home') {
				// Home thì có thể update nhẹ số liệu nếu muốn
				updateStats(); 
			}
			else if (currentTab === 'albums') {
				// Album ít thay đổi, chỉ load nếu chưa có
				const albumsContainer = document.getElementById('albums-container');
				if(albumsContainer.children.length <= 1) renderAlbums();
			}
		  });
		});
		
		// --- XỬ LÝ NÚT CHUÔNG (MỞ MODAL & LOAD DỮ LIỆU) ---
		// --- 3. CẬP NHẬT SỰ KIỆN CLICK NÚT CHUÔNG ---
		// Khi ấn vào chuông -> Ẩn số đỏ đi (Giả định người dùng đã xem)
		document.getElementById('notification-btn').addEventListener('click', () => {
			notificationsModal.show();
			
			// 1. Ẩn badge đỏ ngay (UI phản hồi tức thì)
			const badge = document.getElementById('notification-badge');
			badge.classList.add('d-none'); 
			badge.textContent = '0';
			
			const container = document.getElementById('notifications-list');

			// 2. KIỂM TRA & HIỂN THỊ DỮ LIỆU TỪ CACHE
			if (serverNotifications.length > 0) {
				// [FIX] Nếu đã có dữ liệu ngầm, phải VẼ RA NGAY
				container.innerHTML = ''; 
				renderNotificationsPaged(serverNotifications, container);
			} else {
				// Nếu chưa có gì (mới mở web), hiện Spinner quay
				container.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div><p class="mt-2 small text-muted">Đang tải thông báo...</p></div>';
			}

			// 3. LUÔN GỌI SERVER ĐỂ LẤY TIN MỚI NHẤT (Silent Refresh)
			// Để đảm bảo nếu có tin mới hơn cache thì nó sẽ tự cập nhật sau 1-2 giây
			loadNotifications(1);
		});
		
		// --- HÀM TẢI THÔNG BÁO TỪ SERVER (THÔNG MINH HƠN) ---
		async function loadNotifications(page) {
			// Nếu đang loading (trừ khi là trang 1 chạy ngầm thì có thể cho qua, nhưng để an toàn cứ chặn)
			if (notifLoading) return;
			
			// Chỉ hiện spinner nếu Modal đang mở và chưa có dữ liệu
			const container = document.getElementById('notifications-list');
			const isModalOpen = document.getElementById('notificationsModal').classList.contains('show');

			if (isModalOpen && page === 1 && serverNotifications.length === 0) {
				container.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div><p class="mt-2 small text-muted">Đang tải thông báo...</p></div>';
			}

			notifLoading = true;

			try {
				const res = await sendToServer({
					action: 'get_notifications',
					page: page,
					limit: 10
				});

				if (res.status === 'success') {
					notifHasMore = res.hasMore;
					
					// 1. CẬP NHẬT DỮ LIỆU VÀO BỘ NHỚ (CACHE)
					if (page === 1) {
						serverNotifications = res.data;
					} else {
						serverNotifications = serverNotifications.concat(res.data);
					}
					
					// 2. CHỈ VẼ GIAO DIỆN NẾU MODAL ĐANG MỞ
					if (isModalOpen) {
						if (page === 1) container.innerHTML = ''; // Xóa loading cũ
						else {
							const oldTrigger = document.getElementById('notif-load-more');
							if(oldTrigger) oldTrigger.remove();
						}
						renderNotificationsPaged(res.data, container);
					}
					// Nếu Modal đóng: Dữ liệu đã vào serverNotifications. 
					// Lần sau ấn chuông, sự kiện Click sẽ lấy serverNotifications ra hiển thị ngay lập tức.
				}
			} catch (e) {
				console.error(e);
				if(isModalOpen && page === 1) container.innerHTML = '<div class="text-center py-3 text-danger small">Lỗi kết nối</div>';
			} finally {
				notifLoading = false;
			}
		}
 
		// --- HÀM RENDER THÔNG BÁO (ĐÚNG FORMAT & CHẤM ĐỎ) ---
		function renderNotificationsPaged(newNotifs, container) {
			if (serverNotifications.length === 0) {
				container.innerHTML = `
				  <div class="text-center py-5">
					<i class="bi bi-bell-slash theme-text-primary" style="font-size: 3rem;"></i>
					<p class="fw-semibold mt-3">Chưa có thông báo</p>
				  </div>
				`;
				return;
			}

			const html = newNotifs.map(notif => {
				// Map Icon
				const iconMap = {
				  like: 'heart-fill text-danger',
				  comment: 'chat-fill text-primary',
				  memory: 'star-fill text-warning',
				  album: 'folder-fill text-info',
				  system: 'info-circle-fill theme-text-primary',
				  create_post: 'pencil-square text-success',
				  update_post: 'pencil-fill text-warning',
				  delete_post: 'trash-fill text-danger'
				};
				
				let iconClass = iconMap.system;
				if (notif.action) {
					 if(notif.action.includes('create')) iconClass = iconMap.create_post;
					 else if(notif.action.includes('update')) iconClass = iconMap.update_post;
					 else if(notif.action.includes('delete')) iconClass = iconMap.delete_post;
					 else iconClass = iconMap[notif.action] || iconMap.system;
				}

				// Logic chấm đỏ: Chỉ hiện khi chưa đọc
				// Dùng ms-auto để đẩy sang phải cùng, me-3 để cách nút xóa ra một chút
				const dotHtml = !notif.isRead 
					? `<div class="notification-dot ms-auto me-3" style="flex-shrink: 0;"></div>` 
					: `<div class="ms-auto me-3"></div>`; // Div rỗng để giữ layout nếu cần, hoặc bỏ đi

				return `
				  <div class="notification-item p-3 ${notif.isRead ? '' : 'unread'}" data-id="${notif.__backendId}">
					<div class="d-flex align-items-center">
					  
					  <div class="me-3">
						<i class="bi bi-${iconClass} fs-4"></i>
					  </div>

					  <div class="flex-grow-1" style="font-size: 0.95rem; line-height: 1.5;">
						<strong>${notif.fullname}</strong> ${notif.title} vào lúc ${notif.formattedTime}
						${notif.message ? `<div class="text-muted small text-truncate" style="max-width: 250px;">${notif.message}</div>` : ''}
					  </div>

					  ${dotHtml}

					  </div>
				  </div>
				`;
			}).join('');

			container.insertAdjacentHTML('beforeend', html);

			// Load More Logic (Giữ nguyên)
			if (notifHasMore) {
				const trigger = document.createElement('div');
				trigger.id = 'notif-load-more';
				trigger.className = 'py-3 text-center text-muted small cursor-pointer';
				trigger.innerHTML = '<span>Đang tải thêm...</span>';
				container.appendChild(trigger);
				
				const observer = new IntersectionObserver((entries) => {
					if (entries[0].isIntersecting && !notifLoading) {
						notifPage++;
						loadNotifications(notifPage);
					}
				}, { threshold: 0.1 });
				observer.observe(trigger);
			} else if (serverNotifications.length > 5) {
				 container.insertAdjacentHTML('beforeend', '<div class="text-center py-3 text-muted small">--- Hết thông báo ---</div>');
			}
		}

		// Layout Edit Mode
		document.getElementById('enter-layout-edit').addEventListener('click', enterEditMode);
		document.getElementById('exit-edit-mode').addEventListener('click', exitEditMode);

		// FAB Button
		document.getElementById('fab-btn').addEventListener('click', () => {
		  if (currentTab === 'feed') createPostModal.show();
		  else if (currentTab === 'albums') createAlbumModal.show();
		});

		// Theme Selection
		document.querySelectorAll('.theme-option').forEach(opt => {
		  opt.addEventListener('click', () => applyTheme(opt.dataset.theme));
		});

		// Layout Selection 
		document.querySelectorAll('.layout-preview-box').forEach(opt => {
			opt.addEventListener('click', () => {
				const layout = opt.dataset.layout;
				updateLayoutSelectionUI(layout); // Dùng hàm mới để đồng bộ
				
				// Render lại ảnh preview ngay lập tức
				updateImagePreview();
			});
		});

		// Create Post
		const postInput = document.getElementById('post-input');
		const postBtn = document.getElementById('post-btn');
		const imageInput = document.getElementById('image-input');

		postInput.addEventListener('input', () => {
		  postBtn.disabled = !postInput.value.trim() && currentImages.length === 0;
		});

		// --- SỬA LẠI SỰ KIỆN CHỌN ẢNH ---
		imageInput.addEventListener('change', async (e) => {
			const files = Array.from(e.target.files);
			if (files.length === 0) return;
			
			// [THÊM DÒNG NÀY] Luôn tự động bật HD khi người dùng chọn ảnh mới
			document.getElementById('hd-quality-switch').checked = true;

			// Giới hạn 50 ảnh
			if (currentImages.length + files.length > 50) {
				showToast('Chỉ được chọn tối đa 50 ảnh!');
				return;
			}

			showLoading();
			
			for (const file of files) {
				// 1. Lưu file gốc vào mảng (để dành tí nữa upload)
				currentImages.push(file);

				// 2. Tạo bản Preview nhẹ (resize nhỏ xíu chỉ để xem trên web)
				// Dùng hàm nén cũ để tạo thumbnail hiển thị cho đỡ lag máy
				const previewBase64 = await compressImage(file, 300, 0.6); 
				currentImagePreviews.push(previewBase64);
			}
			
			if (currentImages.length >= 3) {
				// Mặc định chọn 1 Ngang
				updateLayoutSelectionUI('1-wide');
			} else {
				// Nếu ít ảnh, mặc định về lưới cơ bản
				updateLayoutSelectionUI('grid-2x2');
			}

			hideLoading();
			updateImagePreview(); // Hàm này cần sửa lại chút ở bước dưới
			e.target.value = '';
		});

		document.getElementById('images-preview-grid').addEventListener('click', (e) => {
		  const removeBtn = e.target.closest('.remove-preview-img');
		  if (removeBtn) {
			const index = parseInt(removeBtn.dataset.index);
			currentImages.splice(index, 1);
			updateImagePreview();
		  }
		});

		document.getElementById('clear-all-images').addEventListener('click', () => {
		  currentImages = [];
		  updateImagePreview();
		});
 

		// Reset lại modal về chế độ "Tạo mới" khi đóng
		document.getElementById('createPostModal').addEventListener('hidden.bs.modal', function () {
			isEditingPost = false;
			currentEditPostId = null;
			
			// SỬA 1: Dùng đúng ID 'post-input' thay vì 'post-content'
			const postInputEl = document.getElementById('post-input');
			if(postInputEl) postInputEl.value = ''; 

			// SỬA 2: Gọi hàm updateImagePreview() để reset ảnh thay vì gọi ID sai
			currentImages = []; // Xóa dữ liệu ảnh
			updateImagePreview(); // Hàm này sẽ tự động ẩn container ảnh

			// Reset text tiêu đề và nút bấm
			document.querySelector('#createPostModal .modal-title').textContent = "Tạo bài viết";
			
			// Reset nút đăng (giữ lại icon)
			const postBtn = document.getElementById('post-btn');
			if(postBtn) postBtn.innerHTML = '<i class="bi bi-send me-2"></i>Đăng bài';
			// [THÊM DÒNG NÀY] Đảm bảo lần sau mở lên nút vẫn Bật
			document.getElementById('hd-quality-switch').checked = true;
			// Reset layout về mặc định
			updateLayoutSelectionUI('1-wide');
		});

		// Create Memory
		const memoryImageInput = document.getElementById('memory-image-input');
		const memoryImagePreview = document.getElementById('memory-image-preview');
		const memoryImagePreviewContainer = document.getElementById('memory-image-preview-container');

		memoryImageInput.addEventListener('change', async (e) => {
		  const file = e.target.files[0];
		  if (file) {
			showLoading();
			memoryImageData = await compressImage(file);
			memoryImagePreview.src = memoryImageData;
			memoryImagePreviewContainer.classList.remove('d-none');
			hideLoading();
		  }
		});

		document.getElementById('remove-memory-image').addEventListener('click', () => {
		  memoryImageData = null;
		  memoryImagePreviewContainer.classList.add('d-none');
		  memoryImageInput.value = '';
		});

		document.getElementById('create-memory-btn').addEventListener('click', async () => {
		  if (recordCount >= 999) {
			showToast('Đã đạt giới hạn 999 mục!');
			return;
		  }
		  
		  const title = document.getElementById('memory-title').value.trim();
		  const date = document.getElementById('memory-date').value;
		  const content = document.getElementById('memory-content').value.trim();
		  
		  if (!title && !content && !memoryImageData) return;
		  
		  showLoading();
		  const result = await window.dataSdk.create({
			type: 'memory',
			memoryTitle: title || 'Kỷ niệm',
			memoryDate: date || new Date().toISOString().split('T')[0],
			content: content,
			imageData: memoryImageData || '',
			createdAt: new Date().toISOString()
		  });
		  hideLoading();
		  
		  if (result.isOk) {
			document.getElementById('memory-title').value = '';
			document.getElementById('memory-date').value = '';
			document.getElementById('memory-content').value = '';
			memoryImageData = null;
			memoryImagePreviewContainer.classList.add('d-none');
			memoryImageInput.value = '';
			createMemoryModal.hide();
			showToast('Đã lưu kỷ niệm!');
			await createNotification('memory', 'Kỷ niệm mới', `Đã thêm kỷ niệm: ${title || 'Kỷ niệm'}`);
		  } else {
			showToast('Lỗi: ' + result.error.message);
		  }
		});

		// Create Album
		document.getElementById('create-album-btn').addEventListener('click', async () => {
		  if (recordCount >= 999) {
			showToast('Đã đạt giới hạn 999 mục!');
			return;
		  }
		  
		  const name = document.getElementById('album-name').value.trim();
		  if (!name) return;
		  
		  showLoading();
		  const result = await window.dataSdk.create({
			type: 'album',
			albumName: name,
			createdAt: new Date().toISOString()
		  });
		  hideLoading();
		  
		  if (result.isOk) {
			document.getElementById('album-name').value = '';
			createAlbumModal.hide();
			showToast('Đã tạo album!');
			await createNotification('album', 'Album mới', `Đã tạo album: ${name}`);
		  } else {
			showToast('Lỗi: ' + result.error.message);
		  }
		});

		// Album Detail
		document.getElementById('albums-container').addEventListener('click', (e) => {
		  const albumCard = e.target.closest('.album-item');
		  if (albumCard) {
			currentAlbumId = albumCard.dataset.albumId;
			const album = allData.find(d => d.__backendId === currentAlbumId);
			document.getElementById('album-detail-title').textContent = album?.albumName || 'Album';
			renderAlbumPhotos();
			albumDetailModal.show();
		  }
		});

		document.getElementById('albumDetailModal').addEventListener('hidden.bs.modal', () => {
		  currentAlbumId = null;
		});

		document.getElementById('album-image-input').addEventListener('change', async (e) => {
		  if (recordCount >= 999) {
			showToast('Đã đạt giới hạn 999 mục!');
			return;
		  }
		  
		  const file = e.target.files[0];
		  if (file && currentAlbumId) {
			showLoading();
			const compressed = await compressImage(file);
			const result = await window.dataSdk.create({
			  type: 'album_photo',
			  albumId: currentAlbumId,
			  imageData: compressed,
			  createdAt: new Date().toISOString()
			});
			hideLoading();
			if (result.isOk) {
			  showToast('Đã thêm ảnh!');
			} else {
			  showToast('Lỗi: ' + result.error.message);
			}
		  }
		  e.target.value = '';
		});

		document.getElementById('album-photos').addEventListener('click', (e) => {
		  const deleteBtn = e.target.closest('.delete-photo-btn');
		  if (deleteBtn) {
			e.stopPropagation();
			showDeleteConfirm('Xóa ảnh này?', deleteBtn.dataset.id, 'photo');
		  }
		});

		// Profile
		document.getElementById('profile-btn').addEventListener('click', () => profileModal.show());

		// 3. Đổi Ảnh Đại Diện (Sửa: Chỉ Preview, KHÔNG lưu server ngay)
		document.getElementById('avatar-input').addEventListener('change', async (e) => {
		  const file = e.target.files[0];
		  if (file) {
			  showLoading();
			  try {
				  // 1. Nén ảnh xuống < 20KB
				  const avatarData = await compressImageTo20KB(file);
				  
				  // 2. Cập nhật biến local 'currentProfile' để hiển thị preview ngay lập tức
				  
				currentProfile = {
					username: '',
					fullName: '',
					avatarData: '', 
					themeName: currentProfile.themeName
				};
				  
				currentProfile.avatarData = avatarData;
				currentProfile.username = document.getElementById('profile-username').value.trim()||'';
				currentProfile.fullName = document.getElementById('profile-fullname').value.trim()||'';

				// 3. Vẽ lại ảnh lên giao diện (Header và Modal)
				updateAvatarDisplays(); 

				// 4. Thông báo (Không gọi sendToServer ở đây nữa)
				showToast('Đã tải ảnh (Nhấn "Lưu thay đổi" để hoàn tất)');
			  } catch (err) {
				  console.error(err);
				  showToast('Lỗi xử lý ảnh');
			  } finally {
				  hideLoading();
			  }
		  }
		});

		// 4. Lưu Thông Tin Profile (Cập nhật LocalStorage)
		// Xử lý nút LƯU trong Modal Hồ sơ (OPTIMISTIC UI)
		const saveProfileBtn = document.getElementById('save-profile');
		if (saveProfileBtn) {
			saveProfileBtn.addEventListener('click', () => {
				lastUserActionTime = Date.now(); // [MỚI] Chặn sync để không load lại avatar cũ
				const fullnameInput = document.getElementById('profile-fullname');
				const usernameInput = document.getElementById('profile-username');
				
				// 1. Validate dữ liệu
				const newUsername = usernameInput.value.trim();
				const newFullname = fullnameInput.value.trim();

				if (!newUsername) {
					showToast('Vui lòng nhập Username!');
					return;
				}

				// --- BẮT ĐẦU OPTIMISTIC UI UPDATE ---
				
				// 2. Cập nhật ngay lập tức vào biến cục bộ
				const previousProfile = { ...currentProfile }; // Lưu lại đề phòng lỗi
				
				// Tạo object profile mới
				currentProfile = {
					...currentProfile,
					username: newUsername,
					fullName: newFullname || newUsername,
					themeName: currentTheme,
					avatarData: currentProfile.avatarData || ''
				};

				// 3. Lưu ngay vào LocalStorage
				saveLocalData(currentProfile);

				// 4. Cập nhật giao diện ngay lập tức (Header, Avatar...)
				updateAvatarDisplays();
				//const appTitle = document.getElementById('app-title');
				//if(appTitle) appTitle.textContent = currentProfile.fullName;

				// 5. Đóng Modal NGAY LẬP TỨC
				const modalEl = document.getElementById('profileModal');
				const modalInstance = bootstrap.Modal.getInstance(modalEl);
				if (modalInstance) modalInstance.hide();
				
				// 6. Báo thành công ngay
				showToast('Đã cập nhật hồ sơ!');

				// --- XỬ LÝ NGẦM (BACKGROUND SYNC) ---
				// Gửi lên server sau, không bắt người dùng chờ
				sendToServer({
					action: 'save_profile',
					username: currentProfile.username,
					fullname: currentProfile.fullName,
					avaurl: currentProfile.avatarData || '',
					theme: currentProfile.themeName || 'green',
					fingerprint: userFingerprint || 'unknown'
				}).then(res => {
					if (res.status === 'success') {
						console.log('Đồng bộ Server thành công');
					} else {
						console.warn('Server chưa lưu được, nhưng Local đã lưu');
					}
				}).catch(err => {
					console.error('Lỗi đồng bộ server:', err);
					// Tùy chọn: Có thể revert lại profile cũ nếu muốn chặt chẽ
					// currentProfile = previousProfile;
					// saveLocalData(currentProfile);
					// showToast('Lỗi kết nối! Đã hoàn tác.');
				});
			});
		}

		// Post interactions
		document.getElementById('posts-container').addEventListener('click', async (e) => {
		  const likeBtn = e.target.closest('.like-btn');
		  if (likeBtn) {
			lastUserActionTime = Date.now(); // <--- THÊM VÀO ĐÂY
			const postId = likeBtn.dataset.id;
			const post = allData.find(d => d.__backendId === postId);
			if (post) {
			  const newLiked = !post.liked;
			  const newLikes = newLiked ? (post.likes || 0) + 1 : Math.max(0, (post.likes || 0) - 1);
			  
			  await window.dataSdk.update({
				...post,
				liked: newLiked,
				likes: newLikes
			  });
			  
			  if (newLiked) {
				await createNotification('like', 'Yêu thích', 'Bạn đã thích một bài viết');
			  }
			}
			return;
		  }
		  
		  const commentBtn = e.target.closest('.comment-btn');
		  if (commentBtn) {
			currentPostId = commentBtn.dataset.id;
			renderComments(currentPostId);
			commentModal.show();
			return;
		  }
		  
		  const menuBtn = e.target.closest('.post-menu-btn');
		  if (menuBtn) {
			currentPostId = menuBtn.dataset.id;
			postOptionsModal.show();
		  }
		});

		// Post Options
		// Post Options - Sửa bài viết
document.getElementById('edit-post-option').addEventListener('click', () => {
  // Gọi hàm openEditPost đã sửa ở trên
  openEditPost(currentPostId);
});

		document.getElementById('delete-post-option').addEventListener('click', () => {
		  postOptionsModal.hide();
		  showDeleteConfirm('Xóa bài đăng này?', currentPostId, 'post');
		});

		// Comments
		document.getElementById('commentModal').addEventListener('hidden.bs.modal', () => {
		  currentPostId = null;
		});

		document.getElementById('send-comment').addEventListener('click', async () => {
		  const input = document.getElementById('comment-input');
		  const text = input.value.trim();
		  if (!text || !currentPostId) return;
		  
		  const post = allData.find(d => d.__backendId === currentPostId);
		  if (!post) return;
		  
		  const comments = parseComments(post.comments);
		  comments.push({
			text: text,
			author: currentProfile?.fullName || currentProfile?.username || 'Người dùng',
			time: new Date().toISOString()
		  });
		  
		  showLoading();
		  await window.dataSdk.update({
			...post,
			comments: JSON.stringify(comments)
		  });
		  hideLoading();
		  
		  input.value = '';
		  renderComments(currentPostId);
		  showToast('Đã bình luận!');
		  await createNotification('comment', 'Bình luận mới', 'Bạn đã bình luận trên một bài viết');
		});

		// Delete confirmation
		function showDeleteConfirm(message, id, type) {
		  pendingDeleteId = id;
		  pendingDeleteType = type;
		  deleteConfirmModal.show();
		}

		// Bike stats
		document.getElementById('stats-container').addEventListener('click', (e) => {
		  const chartBtn = e.target.closest('.bike-chart-btn');
		  if (chartBtn) {
			e.stopPropagation();
			showBikeStats();
		  }
		  
		  const goldChartBtn = e.target.closest('.gold-chart-btn');
		  if (goldChartBtn) {
			e.stopPropagation();
			showGoldStats();
		  }
		});

		document.getElementById('add-bike-entry').addEventListener('click', () => {
		  //document.getElementById('bike-entry-count').value = 1;
		  //document.getElementById('bike-entry-date').valueAsDate = new Date();
		  //document.getElementById('bike-entry-note').value = '';
		  addBikeEntryModal.show();
		});
 
		document.getElementById('bike-history-list').addEventListener('click', async (e) => {
		  const deleteBtn = e.target.closest('.delete-bike-entry');
		  if (deleteBtn) {
			const entryId = deleteBtn.dataset.id;
			const entry = allData.find(d => d.__backendId === entryId);
			if (entry) {
			  showLoading();
			  await window.dataSdk.delete(entry);
			  hideLoading();
			  showToast('Đã xóa!');
			  showBikeStats();
			}
		  }
		});

		// Gold stats
		document.getElementById('add-gold-entry').addEventListener('click', () => {
		  document.getElementById('gold-entry-buy').value = '';
		  document.getElementById('gold-entry-sell').value = '';
		  document.getElementById('gold-entry-date').valueAsDate = new Date();
		  document.getElementById('gold-entry-note').value = '';
		  addGoldEntryModal.show();
		});

		document.getElementById('save-gold-entry').addEventListener('click', async () => {
			lastUserActionTime = Date.now(); // [MỚI]
		
		  if (recordCount >= 999) {
			showToast('Đã đạt giới hạn 999 mục!');
			return;
		  }
		  
		  const buyPrice = parseInt(document.getElementById('gold-entry-buy').value);
		  const sellPrice = parseInt(document.getElementById('gold-entry-sell').value);
		  const date = document.getElementById('gold-entry-date').value;
		  const note = document.getElementById('gold-entry-note').value.trim();
		  
		  if (!buyPrice || !sellPrice || !date) {
			showToast('Vui lòng nhập đầy đủ thông tin!');
			return;
		  }
		  
		  showLoading();
		  const result = await window.dataSdk.create({
			type: 'gold_entry',
			buyPrice: buyPrice,
			sellPrice: sellPrice,
			date: date,
			note: note,
			createdAt: new Date().toISOString()
		  });
		  hideLoading();
		  
		  if (result.isOk) {
			addGoldEntryModal.hide();
			showToast('Đã thêm giá vàng!');
			showGoldStats();
		  } else {
			showToast('Lỗi: ' + result.error.message);
		  }
		});

		document.getElementById('gold-history-list').addEventListener('click', async (e) => {
		  const deleteBtn = e.target.closest('.delete-gold-entry');
		  if (deleteBtn) {
			const entryId = deleteBtn.dataset.id;
			const entry = allData.find(d => d.__backendId === entryId);
			if (entry) {
			  showLoading();
			  await window.dataSdk.delete(entry);
			  hideLoading();
			  showToast('Đã xóa!');
			  showGoldStats();
			}
		  }
		});

		// --- XỬ LÝ XÓA (OPTIMISTIC UPDATE CHO BÀI VIẾT) ---
		document.getElementById('confirm-delete').addEventListener('click', async () => {
			if (!pendingDeleteId) {
				deleteConfirmModal.hide();
				return;
			}

			// ===============================================
			// TRƯỜNG HỢP 1: XÓA BÀI VIẾT (POST) -> CẬP NHẬT LẠC QUAN
			// ===============================================
			if (pendingDeleteType === 'post') {
				const postId = pendingDeleteId;
				const postEl = document.getElementById(`post-${postId}`);

				// 1. Đóng Modal xác nhận ngay lập tức
				deleteConfirmModal.hide();

				// 2. Backup dữ liệu (để hoàn tác nếu lỗi)
				const originalFeedData = [...serverFeedData]; 
				
				// 3. Cập nhật UI ngay lập tức
				// A. Xóa khỏi biến dữ liệu cục bộ
				const postIndex = serverFeedData.findIndex(p => p.__backendId === postId);
				if (postIndex > -1) {
					serverFeedData.splice(postIndex, 1);
				}

				// B. Tạo hiệu ứng biến mất trên giao diện
				if (postEl) {
					// Thêm style transition để bài viết mờ dần và trượt sang phải
					postEl.style.transition = "all 0.4s ease-out";
					postEl.style.opacity = "0";
					postEl.style.transform = "translateX(50px)";
					postEl.style.height = postEl.offsetHeight + 'px'; // Cố định chiều cao để animation mượt
					
					// Sau 400ms (khi hiệu ứng xong) thì xóa hẳn khỏi DOM
					setTimeout(() => {
						postEl.style.height = '0';
						postEl.style.margin = '0';
						postEl.style.padding = '0';
						postEl.style.overflow = 'hidden';
						
						setTimeout(() => {
							postEl.remove();
							// Nếu xóa hết sạch bài thì hiện thông báo "Chưa có bài đăng"
							if(serverFeedData.length === 0) renderPosts(); 
						}, 200);
					}, 400);
				}

				showToast('Đã xóa bài viết');

				// 4. Gửi lệnh xuống Server (Chạy ngầm - Background)
				try {
					const res = await sendToServer({
						action: 'feed_action', // Đảm bảo action đúng với code server
						type: 'delete',
						id: postId
					});

					if (res.status !== 'success') {
						throw new Error(res.message || 'Lỗi từ server');
					}
					
					// Thành công: Không cần làm gì thêm vì giao diện đã xóa rồi

				} catch (e) {
					console.error("Lỗi xóa post:", e);
					
					// 5. HOÀN TÁC (ROLLBACK) NẾU LỖI
					showToast('Lỗi kết nối! Đang khôi phục bài viết...');
					
					// Khôi phục dữ liệu
					serverFeedData = originalFeedData;
					
					// Vẽ lại giao diện để bài viết hiện lại
					renderPosts();
				}

				// Reset biến tạm
				pendingDeleteId = null;
				pendingDeleteType = null;
				return;
			}

			// ===============================================
			// TRƯỜNG HỢP 2: CÁC LOẠI XÓA KHÁC (ALBUM, ẢNH...) -> LOGIC CŨ
			// ===============================================
			
			// Hiện loading vì các tác vụ này chưa làm lạc quan
			showLoading();
			
			try {
				if (pendingDeleteType === 'photo') {
					 // Logic xóa ảnh trong album (nếu có API)
					 // await sendToServer(...)
					 // Tạm thời dùng logic cũ của bạn hoặc bổ sung sau
					 const item = allData.find(d => d.__backendId === pendingDeleteId);
					 if (item) await window.dataSdk.delete(item); // Fallback logic cũ
					 showToast('Đã xóa ảnh!');
					 if(currentAlbumId) renderAlbumPhotos(); // Refresh album
				} 
				else if (pendingDeleteType === 'album') {
					 // Logic xóa album
					 const item = allData.find(d => d.__backendId === pendingDeleteId);
					 if (item) await window.dataSdk.delete(item);
					 showToast('Đã xóa album!');
					 renderAlbums();
				}
				else {
					 // Fallback cho các loại khác
					 const item = allData.find(d => d.__backendId === pendingDeleteId);
					 if (item) await window.dataSdk.delete(item);
					 showToast('Đã xóa!');
				}

			} catch (e) {
				console.error(e);
				showToast('Lỗi khi xóa!');
			} finally {
				hideLoading();
				deleteConfirmModal.hide();
				pendingDeleteId = null;
				pendingDeleteType = null;
			}
		});

		document.getElementById('deleteConfirmModal').addEventListener('hidden.bs.modal', () => {
		  pendingDeleteId = null;
		  pendingDeleteType = null;
		});
		
		// --- XỬ LÝ: TỰ ĐỘNG LOAD THÔNG TIN KHI NHẬP USERNAME ---
		const usernameInput = document.getElementById('profile-username');

		usernameInput.addEventListener('blur', async () => {
			const inputVal = usernameInput.value.trim();

			// 1. Nếu ô trống hoặc giống tên hiện tại thì bỏ qua
			if (!inputVal || (currentProfile && inputVal === currentProfile.username)) {
				return;
			}

			showLoading();

			try {
				// 2. Gọi API kiểm tra username
				const res = await sendToServer({
					action: 'get_profile_by_username',
					username: inputVal
				});

				// 3. Nếu User tồn tại -> Load thông tin
				if (res.status === 'success' && res.data) {
					console.log("Tìm thấy user cũ:", res.data);

					// Cập nhật biến local
					currentProfile = {
						username: res.data.username,
						fullName: res.data.fullname,
						avatarData: res.data.avaurl,
						themeName: res.data.theme
					};

					// LƯU LOCAL STORAGE LUÔN
					saveLocalData(currentProfile);
			
					// Cập nhật giao diện (Avatar, Tên hiển thị, Màu sắc)
					updateAvatarDisplays();
					applyTheme(currentProfile.themeName);
					
					showToast(`Đã tải hồ sơ của: ${res.data.fullname}`);
				} else {
					// 4. Nếu chưa có -> Không làm gì cả (như yêu cầu)
					console.log("Username mới, chưa có dữ liệu.");
				}
			} catch (e) {
				console.error(e);
			} finally {
				hideLoading();
			}
		});
		
		// --- XỬ LÝ CLICK BABY RUN (OPTIMISTIC UPDATE) ---
		document.getElementById('stats-container').addEventListener('click', async (e) => {
			// --- XỬ LÝ CLICK BABY RUN (OPTIMISTIC UPDATE) ---
			const btn = e.target.closest('.baby-run-btn');
			if (btn) {
				lastUserActionTime = Date.now(); // [MỚI] Chặn sync ngầm trong 10s tới
				// 1. Hiệu ứng click (Thu nhỏ nhẹ tạo cảm giác bấm thật)
				btn.style.transition = "transform 0.1s";
				btn.style.transform = "scale(0.85)";
				setTimeout(() => btn.style.transform = "scale(1)", 150);

				// 2. Cập nhật UI ngay lập tức
				const countEl = document.getElementById('bike-count');
				const currentVal = parseInt(countEl.textContent) || 0;
				countEl.textContent = currentVal + 1;
				
				// Rung nhẹ số đếm
				countEl.style.transition = "color 0.2s";
				countEl.style.color = "var(--secondary-color)"; // Đổi màu chớp nhoáng
				setTimeout(() => countEl.style.color = "", 300);

				// 3. Gửi Server (Background)
				const username = currentProfile ? currentProfile.username : 'anonymous';
				
				// Không dùng await để không chặn luồng
				sendToServer({
					action: 'log_babyrun',
					username: username,
					fingerprint: userFingerprint
				}).then(res => {
					if (res.status !== 'success' && res.result !== 'success') {
						throw new Error('Lỗi server');
					}
				}).catch(err => {
					console.error('Lỗi babyrun:', err);
					// Hoàn tác nếu lỗi
					countEl.textContent = currentVal;
					showToast('Lỗi mạng! Không lưu được.');
				});
				
				return; // Dừng xử lý sự kiện click
			}
		});
		
		// --- HÀM LƯU LƯỢT ĐẠP THỦ CÔNG --- 
		async function saveManualBikeEntry() {
			lastUserActionTime = Date.now(); // [MỚI]
			// 1. Lấy dữ liệu Input
			const dateInput = document.getElementById('manual-bike-date');
			const timeInput = document.getElementById('manual-bike-time');
			
			if (!dateInput || !timeInput || !dateInput.value || !timeInput.value) {
				showToast('Vui lòng chọn đầy đủ Ngày và Giờ');
				return;
			}

			// 2. Chuẩn bị dữ liệu
			const [year, month, day] = dateInput.value.split('-');
			const formattedDate = `${day}/${month}/${year}`; // dd/MM/yyyy
			const formattedTime = timeInput.value + ':00';   // HH:mm:ss

			// --- BƯỚC QUAN TRỌNG: UI PHẢN HỒI NGAY LẬP TỨC ---
			
			// A. Đóng Modal ngay (Không chờ server)
			const modalEl = document.getElementById('addBikeEntryModal');
			const modalInstance = bootstrap.Modal.getInstance(modalEl);
			if (modalInstance) modalInstance.hide();

			// B. Hiển thị thông báo thành công ngay ("Giả vờ" là đã xong)
			showToast('Đã ghi nhận lượt đạp!');

			// C. Cập nhật số liệu trên giao diện NGAY (Nếu ngày chọn là "Hôm nay")
			const today = new Date();
			const isToday = (parseInt(day) === today.getDate() && 
							 parseInt(month) === (today.getMonth() + 1) && 
							 parseInt(year) === today.getFullYear());

			let oldTodayCount = 0; // Lưu lại để rollback nếu lỗi
			const countEl = document.getElementById('bike-count'); // Số ở màn hình chính
			const statsTodayEl = document.getElementById('stats-today'); // Số ở trong Modal thống kê

			if (isToday) {
				// Cập nhật màn hình chính
				if (countEl) {
					oldTodayCount = parseInt(countEl.textContent) || 0;
					countEl.textContent = oldTodayCount + 1;
					
					// Hiệu ứng nhún nhảy cho số
					countEl.style.transition = "transform 0.2s";
					countEl.style.transform = "scale(1.3)";
					setTimeout(() => countEl.style.transform = "scale(1)", 200);
				}
				// Cập nhật modal thống kê (nếu đang mở)
				if (statsTodayEl) {
					const val = parseInt(statsTodayEl.textContent) || 0;
					statsTodayEl.textContent = val + 1;
				}
			}

			// --- BƯỚC 3: GỬI SERVER (CHẠY NGẦM - BACKGROUND) ---
			try {
				const res = await sendToServer({
					action: 'log_babyrun',
					username: currentProfile ? currentProfile.username : 'anonymous',
					customDate: formattedDate,
					customTime: formattedTime
				});

				if (res.status !== 'success' && res.result !== 'success') {
					throw new Error(res.message || 'Lỗi server');
				}
				
				// Nếu thành công thật sự: Reload ngầm lại thống kê để đảm bảo đồng bộ
				// (Không gọi showBikeStats() vì nó sẽ bật modal lên, chỉ gọi cập nhật ngầm nếu cần)
				// Ở đây ta tin tưởng vào Optimistic UI nên không cần reload lại ngay.

			} catch (e) {
				console.error("Lỗi lưu server:", e);
				
				// --- ROLLBACK (NẾU LỖI) ---
				// Trả lại số cũ nếu nãy lỡ cộng
				if (isToday && countEl) countEl.textContent = oldTodayCount;
				if (isToday && statsTodayEl) statsTodayEl.textContent = parseInt(statsTodayEl.textContent) - 1;
				
				showToast('Lỗi kết nối! Đã hoàn tác dữ liệu.');
			}
		}

		// Kiểm tra phần tử tồn tại trước khi gắn sự kiện
		const addBikeModalEl = document.getElementById('addBikeEntryModal');
		if (addBikeModalEl) {
			addBikeModalEl.addEventListener('show.bs.modal', function () {
				const now = new Date();
				
				// Set Date: YYYY-MM-DD
				const yyyy = now.getFullYear();
				const mm = String(now.getMonth() + 1).padStart(2, '0');
				const dd = String(now.getDate()).padStart(2, '0');
				
				const dateInput = document.getElementById('manual-bike-date');
				if(dateInput) dateInput.value = `${yyyy}-${mm}-${dd}`;
				
				// Set Time: HH:mm
				const hh = String(now.getHours()).padStart(2, '0');
				const min = String(now.getMinutes()).padStart(2, '0');
				
				const timeInput = document.getElementById('manual-bike-time');
				if(timeInput) timeInput.value = `${hh}:${min}`;
			});
		}
	  
		// --- HÀM XỬ LÝ ĐĂNG / CẬP NHẬT BÀI VIẾT (ĐÃ SỬA) ---
		// Xử lý Đăng bài / Lưu bài viết (OPTIMISTIC UI)
		// --- HÀM XỬ LÝ ĐĂNG / CẬP NHẬT BÀI VIẾT (FULL) ---
		// --- HÀM XỬ LÝ ĐĂNG BÀI (LOGIC KÉP: HD & STANDARD) ---
		// --- HÀM XỬ LÝ ĐĂNG BÀI (ĐÃ FIX LỖI MẤT ẢNH KHI ĐÓNG MODAL) ---
		// --- HÀM XỬ LÝ ĐĂNG / SỬA BÀI (THÔNG MINH: KHÔNG UPLOAD LẠI ẢNH CŨ) ---
		// --- HÀM XỬ LÝ ĐĂNG / SỬA BÀI (ĐÃ FIX LỖI ID BÀI VIẾT BỊ RESET) ---
		async function handlePostSubmit() {
			const contentInput = document.getElementById('post-input');
			const content = contentInput.value;
			const postBtn = document.getElementById('post-btn');
			const isHD = document.getElementById('hd-quality-switch').checked;

			// 1. Sao chép dữ liệu để tránh lỗi khi đóng Modal (QUAN TRỌNG)
			const imagesToProcess = [...currentImages]; 
			const previewsToSave = [...currentImagePreviews];
			
			// [FIX] LƯU TRẠNG THÁI SỬA BÀI VÀO BIẾN CỤC BỘ NGAY LẬP TỨC
			// Để dù Modal có đóng và reset biến toàn cục thì ta vẫn còn giữ ID này
			const isUpdateMode = isEditingPost; 
			const postIdToUpdate = currentEditPostId; 

			if (!content && imagesToProcess.length === 0) {
				showToast('Vui lòng viết gì đó hoặc thêm ảnh!');
				return;
			}

			// --- CHUẨN BỊ ---
			lastUserActionTime = Date.now();
			pendingTasksCount++; 
			postBtn.disabled = true;

			// --- XỬ LÝ OPTIMISTIC UI ---
			let tempId;

			if (isUpdateMode && postIdToUpdate) {
				// TRƯỜNG HỢP SỬA: Cập nhật trực tiếp vào bài cũ
				tempId = postIdToUpdate;
				const postIndex = serverFeedData.findIndex(p => p.__backendId === tempId);
				if (postIndex !== -1) {
					serverFeedData[postIndex] = {
						...serverFeedData[postIndex],
						content: content,
						imageData: JSON.stringify(previewsToSave),
						layout: selectedLayout,
						isUploading: true,
						uploadStatus: 'Đang lưu...'
					};
				}
			} else {
				// TRƯỜNG HỢP MỚI: Tạo bài tạm
				tempId = 'temp_' + Date.now();
				const now = new Date();
				const newOptimisticPost = {
					__backendId: tempId,
					username: currentProfile ? currentProfile.username : 'AnDanh',
					fullname: currentProfile ? currentProfile.fullName : 'Ẩn Danh',
					avatar: currentProfile ? currentProfile.avatarData : '',
					content: content,
					imageData: JSON.stringify(previewsToSave), 
					createdAt: "Vừa xong",
					timestamp: now.getTime(),
					layout: selectedLayout,
					likes: 0,
					liked: false,
					comments: '[]',
					isUploading: true,
					uploadStatus: 'Đang xử lý...' 
				};
				serverFeedData.unshift(newOptimisticPost);
			}

			renderPosts();

			if (currentTab !== 'feed') document.querySelector('[data-tab="feed"]').click();
			
			// Đóng Modal (Việc này sẽ reset biến toàn cục isEditingPost & currentEditPostId)
			const modalEl = document.getElementById('createPostModal');
			const modalInstance = bootstrap.Modal.getInstance(modalEl);
			if (modalInstance) modalInstance.hide();
			
			try {
				let finalImageData = []; 

				// ============================================================
				// VÒNG LẶP XỬ LÝ ẢNH
				// ============================================================
				if (imagesToProcess.length > 0) {
					for (let i = 0; i < imagesToProcess.length; i++) {
						const item = imagesToProcess[i];
						
						// Link ảnh cũ -> Giữ nguyên
						if (typeof item === 'string') {
							finalImageData.push(item); 
							continue; 
						}

						// File mới -> Upload
						const file = item;
						const qualityText = isHD ? "HD" : "SD";
						updatePostStatus(tempId, `Đang tải ảnh ${i + 1}/${imagesToProcess.length} (${qualityText})...`);

						if (isHD) {
							if (i > 0) await new Promise(r => setTimeout(r, 500));
							const base64Data = await readFileAsBase64(file);
							const fileName = new Date().getTime() + "_" + i;
							
							const res = await sendToServer({
								action: 'upload_single_image', 
								image: base64Data,
								name: fileName
							});
							if (res.status === 'success') finalImageData.push(res.url);
							else throw new Error("Lỗi ảnh số " + (i+1));
						} else {
							const compressedBase64 = await compressImage(file, 1920, 0.8);
							finalImageData.push(compressedBase64);
						}
					}
				}

				// ============================================================
				// GỬI LỆNH LÊN SERVER
				// ============================================================
				updatePostStatus(tempId, 'Đang hoàn tất...');

				// [FIX] Sử dụng biến cục bộ postIdToUpdate thay vì currentEditPostId
				const res = await sendToServer({
					action: 'feed_action',
					type: isUpdateMode ? 'update' : 'create',
					id: isUpdateMode ? postIdToUpdate : undefined, // <--- QUAN TRỌNG NHẤT
					username: currentProfile ? currentProfile.username : 'Anonymous',
					content: content,
					image: JSON.stringify(finalImageData),
					layout: selectedLayout,
					fingerprint: userFingerprint
				});

				if (res.status === 'success') {
					const targetId = isUpdateMode ? postIdToUpdate : tempId;
					const finalPost = serverFeedData.find(p => p.__backendId === targetId);
					
					if (finalPost) {
						if (!isUpdateMode && res.id) finalPost.__backendId = res.id;
						if (res.time) finalPost.createdAt = res.time;
						if (res.images && res.images.length > 0) finalPost.imageData = JSON.stringify(res.images);
						
						delete finalPost.isUploading;
						delete finalPost.uploadStatus;
						
						renderPosts();
						showToast(isUpdateMode ? 'Đã cập nhật bài viết!' : 'Đã đăng thành công!');
					}
				} else {
					throw new Error(res.message);
				}

			} catch (err) {
				console.error("Lỗi:", err);
				showToast('Lỗi: ' + err.message);
				const badgeEl = document.getElementById(`status-badge-${tempId}`);
				if (badgeEl) {
					badgeEl.className = "badge bg-danger text-white ms-auto";
					badgeEl.innerHTML = `<i class="bi bi-exclamation-triangle me-1"></i> Lỗi`;
				}
			} finally {
				postBtn.disabled = false;
				postBtn.innerHTML = '<i class="bi bi-send me-2"></i>Đăng bài';
				pendingTasksCount--; 
				
				if(contentInput) contentInput.value = '';
				currentImages = [];
				currentImagePreviews = [];
				// Không cần reset isEditingPost ở đây vì sự kiện đóng modal đã làm rồi
				// [SỬA DÒNG NÀY] Đổi false thành true
				document.getElementById('hd-quality-switch').checked = true;
				
			}
		}

		// Hàm phụ trợ cập nhật trạng thái UI cho gọn code
		function updatePostStatus(tempId, text) {
			const tempPost = serverFeedData.find(p => p.__backendId === tempId);
			if (tempPost) tempPost.uploadStatus = text;

			const badgeEl = document.getElementById(`status-badge-${tempId}`);
			if (badgeEl) {
				badgeEl.innerHTML = `
					<span class="spinner-border spinner-border-sm me-1" style="width: 0.7rem; height: 0.7rem;"></span>
					${text}
				`;
			}
		}
		
		// --- HÀM XÓA BÀI VIẾT ---
		async function deletePost(postId) {
			if (!confirm('Bạn có chắc chắn muốn xóa bài viết này?')) return;

			// 1. Ẩn bài viết trên giao diện NGAY LẬP TỨC (Optimistic UI)
			const postEl = document.getElementById(`post-${postId}`);
			if (postEl) {
				postEl.style.transition = "opacity 0.5s";
				postEl.style.opacity = "0";
				setTimeout(() => postEl.remove(), 500);
			}

			try {
				// 2. Gửi lệnh xóa lên Server
				const res = await sendToServer({
					action: 'feed_action',
					type: 'delete',
					id: postId
				});

				if (res.status === 'success' || res.result === 'success') {
					showToast('Đã xóa bài viết');
				} else {
					showToast('Lỗi xóa server: ' + res.message);
					// Nếu lỗi thì reload lại feed để hiện lại bài
					loadFeedData(); 
				}
			} catch (e) {
				console.error(e);
				showToast('Lỗi kết nối!');
			}
		}
		 
		// --- 2. HÀM CHUẨN BỊ FORM ĐỂ SỬA (ĐÃ FIX LOAD ẢNH) ---
		// --- 2. HÀM CHUẨN BỊ FORM ĐỂ SỬA (ĐÃ FIX LOAD ẢNH PREVIEW) ---
		function openEditPost(id) {
			// 1. Tìm bài viết
			let post = null;
			if (typeof serverFeedData !== 'undefined' && serverFeedData.length > 0) {
				post = serverFeedData.find(d => d.__backendId === id);
			}
			if (!post) post = allData.find(d => d.__backendId === id);

			if (!post) {
				showToast("Không tìm thấy dữ liệu bài viết!");
				return;
			}

			isEditingPost = true;
			currentEditPostId = id;

			// 2. Điền nội dung
			const contentInput = document.getElementById('post-input');
			if(contentInput) contentInput.value = post.content || '';
			
			// 3. Xử lý ảnh
			currentImages = parseImages(post.imageData); 
			
			// [FIX QUAN TRỌNG] Đồng bộ sang biến Previews để hiển thị lên UI
			// Vì ảnh cũ là Link URL nên có thể dùng làm src cho thẻ img luôn
			currentImagePreviews = [...currentImages];

			// 4. Xử lý Layout
			// Nếu layout cũ là 'auto' (do dữ liệu cũ) hoặc null -> ép về 'grid-2x2'
			let postLayout = post.layout;
			if (!postLayout || postLayout === 'auto') postLayout = 'grid-2x2';
	
			selectedLayout = postLayout;
			
			if (currentImages.length >= 3) {
				document.getElementById('layout-selector').classList.remove('d-none');
				// Gọi hàm update UI để highlight đúng ô đang lưu
				updateLayoutSelectionUI(selectedLayout);
			} else {
				document.getElementById('layout-selector').classList.add('d-none');
				// Reset về mặc định nếu ẩn
				updateLayoutSelectionUI('grid-2x2');
			}
			
			// 5. Cập nhật giao diện Preview
			updateImagePreview();
			
			// 6. Đổi tiêu đề Modal
			const modalTitle = document.querySelector('#createPostModal .modal-title');
			if(modalTitle) modalTitle.textContent = "Chỉnh sửa bài viết";
			
			const modalBtn = document.querySelector('#createPostModal .btn-primary');
			if(modalBtn) modalBtn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Lưu thay đổi';

			// 7. Mở Modal
			const modalEl = document.getElementById('createPostModal');
			const modal = new bootstrap.Modal(modalEl);
			modal.show();
			
			// Ẩn modal tùy chọn cũ
			const optionsModalEl = document.getElementById('postOptionsModal');
			const optionsModal = bootstrap.Modal.getInstance(optionsModalEl);
			if (optionsModal) optionsModal.hide();
		}

		// --- 3. SỬA LỖI RESET FORM KHI ĐÓNG MODAL (FIX LỖI NULL) ---
		const createPostModalEl = document.getElementById('createPostModal');
		if (createPostModalEl) {
			createPostModalEl.addEventListener('hidden.bs.modal', function () {
				isEditingPost = false;
				currentEditPostId = null;
				
				// QUAN TRỌNG: Dùng đúng ID 'post-input' để xóa trắng
				const contentInput = document.getElementById('post-input');
				if(contentInput) contentInput.value = '';
				
				// Reset ảnh và giao diện về mặc định
				currentImages = [];
				updateImagePreview();
				
				document.querySelector('#createPostModal .modal-title').textContent = "Tạo bài viết";
				const modalBtn = document.querySelector('#createPostModal .btn-primary');
				if(modalBtn) modalBtn.innerHTML = '<i class="bi bi-send me-2"></i>Đăng bài';
				
				selectedLayout = 'grid-2x2';
			});
		}
		
		async function loadFeedData(page = 1) {
			const container = document.getElementById('posts-container');
			
			// Chặn gọi trùng lặp
			if (feedLoading) return;
			feedLoading = true;

			// UI Loading: Trang 1 thì hiện giữa màn hình, trang sau thì hiện ở đáy (đã có trigger lo)
			if (page === 1) {
				container.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-2 text-muted">Đang tải bảng tin...</p></div>';
			}

			try {
				// Gọi Server với tham số phân trang
				const res = await sendToServer({ 
					action: 'get_feed', 
					page: page, 
					limit: 10 // Tải 10 bài mỗi lần
				});

				if (res.status === 'success') {
					// Cập nhật dữ liệu vào biến toàn cục
					if (page === 1) {
						serverFeedData = res.data;
					} else {
						serverFeedData = serverFeedData.concat(res.data);
					}
					
					feedHasMore = res.hasMore;
					
					// Gọi hàm render mới (có tham số page)
					renderPostsPaged(res.data, page);
				} else {
					if (page === 1) container.innerHTML = '<div class="text-center py-5 text-danger">Lỗi tải dữ liệu</div>';
				}
			} catch (e) {
				console.error(e);
				if (page === 1) container.innerHTML = '<div class="text-center py-5 text-muted">Không có kết nối mạng</div>';
			} finally {
				feedLoading = false;
			}
		}
		
		// --- 1. THÊM HÀM ĐỒNG BỘ SỐ LƯỢNG CHƯA ĐỌC ---
		async function syncUnreadCount() {
			try {
				const res = await sendToServer({ action: 'get_unread_count' });
				
				if (res.status === 'success') {
					const badge = document.getElementById('notification-badge');
					const count = res.count;
					
					if (count > 0) {
						// Nếu > 99 thì hiện 99+ cho gọn
						badge.textContent = count > 99 ? '99+' : count;
						badge.classList.remove('d-none');
						
						// Hiệu ứng rung nhẹ để gây chú ý
						badge.style.animation = "none";
						setTimeout(() => badge.style.animation = "heartBeat 0.5s", 10);
					} else {
						badge.classList.add('d-none');
					}
				}
			} catch (e) {
				console.error("Lỗi lấy số lượng noti:", e);
			}
		}
		
		// --- TÍNH NĂNG XEM ẢNH FULL (LIGHTBOX) ---

		// Gắn sự kiện click cho container chứa bài viết
		document.getElementById('posts-container').addEventListener('click', (e) => {
			// Tìm xem người dùng có click vào khung ảnh (.img-box) không
			const imgBox = e.target.closest('.img-box');
			
			if (imgBox) {
				// Tìm bài viết tương ứng
				const postCard = imgBox.closest('.post-card');
				if (postCard) {
					// Lấy ID bài viết (dạng post-UID -> lấy UID)
					const postId = postCard.id.replace('post-', '');
					openImageViewer(postId);
				}
			}
		});

		function openImageViewer(postId) {
			// 1. Tìm dữ liệu bài viết
			const post = serverFeedData.find(p => p.__backendId === postId);
			if (!post) return;

			// 2. Lấy danh sách ảnh
			const images = parseImages(post.imageData);
			if (!images || images.length === 0) return;

			// 3. Render ảnh vào Modal
			const container = document.getElementById('full-image-list');
			const counter = document.getElementById('viewer-counter');
			
			container.innerHTML = '';
			counter.textContent = `Chi tiết (${images.length} ảnh)`;

			images.forEach((imgUrl, index) => {
				// Tạo container wrapper
				const wrapper = document.createElement('div');
				wrapper.className = "lightbox-item"; // Sử dụng class CSS mới tạo
				
				// Tạo thẻ ảnh
				const img = document.createElement('img');
				img.src = imgUrl; 
				img.className = "lightbox-image"; // Sử dụng class CSS mới tạo
				img.alt = `Ảnh chi tiết ${index + 1}`;
				
				// Lazy load để mở modal nhanh hơn
				img.loading = "lazy"; 
				
				wrapper.appendChild(img);
				container.appendChild(wrapper);
			});

			// 4. Hiển thị Modal
			imageViewerModal.show();
		}
		
		// Thêm vào vùng Utils
		function readFileAsBase64(file) {
			return new Promise((resolve, reject) => {
				const reader = new FileReader();
				reader.onload = () => resolve(reader.result);
				reader.onerror = error => reject(error);
				reader.readAsDataURL(file);
			});
		}

		// Xử lý khi đóng modal để xóa sạch dữ liệu (tiết kiệm bộ nhớ)
		document.getElementById('imageViewerModal').addEventListener('hidden.bs.modal', function () {
			document.getElementById('full-image-list').innerHTML = '';
		});
		
		// --- TÍNH NĂNG TỰ ĐỘNG CẬP NHẬT (BACKGROUND SYNC) ---

		async function runBackgroundSync() {
			// --- CHECK 1: KIỂM TRA ĐẦU VÀO (Như cũ) ---
			if (typeof isEditingPost !== 'undefined' && isEditingPost) return;
			if (typeof pendingTasksCount !== 'undefined' && pendingTasksCount > 0) return;
			if (typeof lastUserActionTime !== 'undefined' && (Date.now() - lastUserActionTime < 10000)) return;

			console.log("Đang chạy đồng bộ ngầm...");

			// Các hàm đồng bộ nhẹ (Notification, Stats...) có thể để chạy tự nhiên
			syncUnreadCount();
			syncBabyRunStats();
			loadNotifications(1);

			// --- PHẦN QUAN TRỌNG: ĐỒNG BỘ FEED ---
			try {
				// Gọi Server (Mất 1-2 giây để phản hồi)
				const res = await sendToServer({ 
					action: 'get_feed', 
					page: 1, 
					limit: 5 
				});

				// ============================================================
				// [QUAN TRỌNG] CHECK 2: KIỂM TRA LẠI SAU KHI CÓ DỮ LIỆU
				// ============================================================
				// Lý do: Trong lúc chờ server (1-2s kia), có thể người dùng đã kịp ấn "Đăng bài"
				// Nếu lúc này ta vẽ lại giao diện thì sẽ làm hỏng bài đăng mới của họ.
				
				if (typeof isEditingPost !== 'undefined' && isEditingPost) {
					console.log("Hủy sync feed vì người dùng đang sửa bài.");
					return;
				}
				if (typeof pendingTasksCount !== 'undefined' && pendingTasksCount > 0) {
					console.log("Hủy sync feed vì phát hiện tác vụ upload mới.");
					return;
				}
				if (typeof lastUserActionTime !== 'undefined' && (Date.now() - lastUserActionTime < 10000)) {
					console.log("Hủy sync feed vì người dùng vừa thao tác.");
					return;
				}
				// ============================================================

				if (res.status === 'success' && res.data.length > 0) {
					processNewFeedData(res.data);
				}
			} catch (e) {
				console.warn("Lỗi sync ngầm:", e);
			}
		}

		// Hàm xử lý dữ liệu Feed mới (Chỉ thêm bài chưa có)
		// [FIX] Hàm xử lý dữ liệu Feed: Hỗ trợ cả Thêm, Sửa và Xóa tự động
		function processNewFeedData(newPosts) {
			if (!serverFeedData) return;

			const container = document.getElementById('posts-container');
			
			// ============================================================
			// 1. XỬ LÝ DELETE (Xóa bài đã mất trên server khỏi Client)
			// ============================================================
			if (newPosts.length > 0) {
				// Lấy timestamp của bài CŨ NHẤT trong danh sách vừa tải về (làm mốc)
				// Ví dụ: Server trả về 5 bài mới nhất, bài thứ 5 là mốc thời gian.
				const oldestFetchedTime = newPosts[newPosts.length - 1].timestamp;
				
				// Duyệt qua các bài đang hiển thị trên màn hình
				// (Clone mảng bằng [...] để tránh lỗi khi splice trực tiếp)
				[...serverFeedData].forEach((localPost) => {
					 // Logic: Nếu bài ở local có thời gian >= mốc thời gian vừa tải về
					 // (nghĩa là nó thuộc phạm vi Top 5 bài mới nhất)
					 // NHƯNG lại không tìm thấy trong danh sách newPosts -> Đã bị xóa trên Server.
					 if (localPost.timestamp >= oldestFetchedTime) {
						 const stillExists = newPosts.some(p => p.__backendId === localPost.__backendId);
						 
						 if (!stillExists) {
							 // A. Xóa khỏi giao diện
							 const el = document.getElementById(`post-${localPost.__backendId}`);
							 if (el) {
								 el.style.transition = "all 0.5s";
								 el.style.opacity = "0";
								 el.style.height = "0";
								 setTimeout(() => el.remove(), 500);
							 }
							 
							 // B. Xóa khỏi bộ nhớ đệm
							 const realIndex = serverFeedData.findIndex(p => p.__backendId === localPost.__backendId);
							 if (realIndex > -1) serverFeedData.splice(realIndex, 1);
							 
							 console.log("Đã đồng bộ: Xóa bài", localPost.__backendId);
						 }
					 }
				});
			}

			// ============================================================
			// 2. XỬ LÝ ADD (Thêm) & UPDATE (Sửa)
			// ============================================================
			// Duyệt ngược từ cũ -> mới để chèn lên đầu đúng thứ tự
			for (let i = newPosts.length - 1; i >= 0; i--) {
				const serverPost = newPosts[i];
				const localIndex = serverFeedData.findIndex(p => p.__backendId === serverPost.__backendId);
				
				// --- TRƯỜNG HỢP 1: BÀI VIẾT MỚI (ADD) ---
				if (localIndex === -1) {
					serverFeedData.unshift(serverPost);
					
					if (container) {
						// Xóa thông báo rỗng nếu có
						const emptyMsg = container.querySelector('.text-center.py-5');
						if (emptyMsg && emptyMsg.innerText.includes('Chưa có bài')) emptyMsg.remove(); 

						const postHtml = createPostHtml(serverPost);
						container.insertAdjacentHTML('afterbegin', postHtml);
						
						// Hiệu ứng highlight màu xanh nhẹ
						const newEl = document.getElementById(`post-${serverPost.__backendId}`);
						if (newEl) {
							newEl.style.backgroundColor = "#f0fdf4";
							setTimeout(() => newEl.style.backgroundColor = "", 2000);
						}
					}
				} 
				// --- TRƯỜNG HỢP 2: BÀI VIẾT ĐÃ CÓ (UPDATE) ---
				else {
					const localPost = serverFeedData[localIndex];
					
					// So sánh xem có gì thay đổi không (Nội dung, Ảnh, Layout, Like...)
					const isChanged = 
						localPost.content !== serverPost.content ||
						localPost.imageData !== serverPost.imageData ||
						localPost.layout !== serverPost.layout ||
						localPost.likes !== serverPost.likes;
					
					if (isChanged) {
						console.log("Đã đồng bộ: Cập nhật bài", serverPost.__backendId);
						
						// A. Cập nhật dữ liệu vào bộ nhớ (Merge đè lên cái cũ)
						serverFeedData[localIndex] = { ...localPost, ...serverPost };
						
						// B. Vẽ lại giao diện (Render lại HTML)
						const existingEl = document.getElementById(`post-${serverPost.__backendId}`);
						if (existingEl) {
							// Tạo HTML mới từ dữ liệu mới
							const newHtmlFull = createPostHtml(serverPost);
							
							// Mẹo: Tạo div tạm để lấy nội dung bên trong, giữ nguyên thẻ bao ngoài cũ
							const tempDiv = document.createElement('div');
							tempDiv.innerHTML = newHtmlFull;
							const newContent = tempDiv.firstElementChild.innerHTML;
							
							// Gán nội dung mới vào
							existingEl.innerHTML = newContent;
							
							// Hiệu ứng nháy vàng nhẹ báo hiệu vừa update
							existingEl.style.transition = "background-color 0.5s";
							existingEl.style.backgroundColor = "#fffbeb"; 
							setTimeout(() => existingEl.style.backgroundColor = "", 1000);
						}
					}
				}
			}
		}
		
		// Hàm cập nhật giao diện ô chọn Layout (Highlight ô được chọn)
		function updateLayoutSelectionUI(layoutName) {
			// Cập nhật biến toàn cục
			selectedLayout = layoutName;

			// Cập nhật giao diện (xóa class selected cũ, thêm vào ô mới)
			document.querySelectorAll('.layout-preview-box').forEach(opt => {
				opt.classList.remove('selected');
				if (opt.dataset.layout === layoutName) {
					opt.classList.add('selected');
				}
			});
		}

		// KÍCH HOẠT ĐỊNH KỲ (Khuyên dùng 60s thay vì 10s)
		setInterval(runBackgroundSync, 60000);

	  </script>
	 </body>
	</html>
