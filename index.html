<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Love Story 💕</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Quicksand', sans-serif;
            background: linear-gradient(135deg, #FFF5F7 0%, #FFE8ED 50%, #FFF0F5 100%);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(255, 182, 193, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 105, 180, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(255, 192, 203, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }
        
        .calendar-container {
            background: linear-gradient(145deg, #ffffff 0%, #fef7ff 100%);
            border-radius: 20px;
            box-shadow: 
                0 20px 40px rgba(252, 189, 210, 0.3),
                0 0 0 1px rgba(255, 182, 193, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            overflow: hidden;
            width: 90vw;
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            backdrop-filter: blur(10px);
        }
        
        .calendar-container::before {
            content: '';
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 20px;
            animation: sparkle 2s ease-in-out infinite;
            z-index: 10;
        }
        
        .calendar-container::after {
            content: '💖';
            position: absolute;
            bottom: 15px;
            left: 20px;
            font-size: 18px;
            animation: heartbeat 1.5s ease-in-out infinite;
            z-index: 10;
        }
        
        @keyframes sparkle {
            0%, 100% { transform: scale(1) rotate(0deg); opacity: 0.7; }
            50% { transform: scale(1.2) rotate(180deg); opacity: 1; }
        }
        
        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .calendar-header {
            background: linear-gradient(135deg, #FF85A2 0%, #FF6B9D 50%, #E91E63 100%);
            border-radius: 20px 20px 0 0;
            position: relative;
            overflow: hidden;
        }
        
        .calendar-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 30% 20%, rgba(255, 255, 255, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 70% 80%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }
        
        .calendar-header::after {
            content: '🌸 💕 🌸';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
            opacity: 0.3;
            white-space: nowrap;
            pointer-events: none;
        }
        
        .day-name {
            color: #FF85A2;
            font-weight: 600;
        }
        
        .day-name.weekend {
            color: #FF5252;
        }
        
        .date-cell {
            border-radius: 50%;
            width: clamp(28px, 4vw, 45px);
            height: clamp(28px, 4vw, 45px);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
            margin: auto;
            font-size: clamp(14px, 2.3vw, 23px);
        }
        
        .date-cell:hover {
            background-color: #FFE0E8;
            transform: scale(1.1);
        }
        
        .date-cell.today {
            background-color: #FF85A2;
            color: white;
            font-weight: bold;
        }
        
        .date-cell.active {
            background-color: #FFE0E8;
            color: #FF85A2;
            font-weight: bold;
        }
        
        .date-cell.selected {
            box-shadow: 0 0 0 2px #FF5252;
            z-index: 10;
            font-weight: bold;
        }
        
        .date-cell.today.active {
            background-color: #FF85A2;
            color: white;
        }
        
        .date-cell.other-month {
            opacity: 0.4;
            color: #999;
        }
        
        .date-cell.weekend {
            color: #FF5252;
        }
        
        .date-cell.weekend.other-month {
            color: #FF5252;
            opacity: 0.4;
        }
        
        .date-cell.has-event::after {
            content: '';
            position: absolute;
            bottom: 2px;
            width: 4px;
            height: 4px;
            background-color: #FF85A2;
            border-radius: 50%;
        }
        
        .date-cell.weekend.has-event::after {
            background-color: #FF5252;
        }
        
        .date-cell.today.has-event::after,
        .date-cell.active.has-event::after {
            background-color: white;
        }
        
        .date-cell.anniversary {
            position: relative;
            z-index: 1;
        }
        
        .date-cell.anniversary::before {
            content: '❤️';
            position: absolute;
            font-size: 10px;
            top: -2px;
            right: 0px;
            z-index: 1;
        }
        
        .date-cell.anniversary::after {
            content: '❤️';
            position: absolute;
            font-size: 10px;
            bottom: -2px;
            left: 0px;
            z-index: 1;
        }
        
        .month-nav {
            transition: all 0.3s ease;
            background-color: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .month-nav:hover {
            transform: scale(1.2);
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        .today-info {
            background: linear-gradient(145deg, #ffffff 0%, #fef7ff 100%);
            border: 2px solid #FFE0E8;
            border-radius: 20px;
            box-shadow: 
                0 8px 25px rgba(252, 189, 210, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            position: relative;
            overflow: hidden;
        }
        
        .today-info::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 182, 193, 0.1) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
            pointer-events: none;
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .today-info > * {
            position: relative;
            z-index: 1;
        }
        
        /* Photo Modal Styles */
        #photoModal .modal-dialog {
            margin: 0;
            width: 100vw;
            height: 100vh;
            max-width: none;
        }
        
        #photoModal .modal-content {
            border-radius: 0;
        }
        
        #photoModal .btn-close {
            transition: all 0.3s ease;
            transform: scale(1);
        }
        
        #photoModal .btn-close:hover {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.2) !important;
        }
        
        #photoModal .modal-header {
            transition: opacity 0.3s ease;
        }
        
        #photoModal .modal-footer {
            transition: opacity 0.3s ease;
        }
        
        #photoModal:hover .modal-header,
        #photoModal:hover .modal-footer {
            opacity: 1;
        }
        
        /* Messenger Style Comment Box */
        .messenger-comment-box {
            margin-top: 6px;
        }
        
        .comment-input-container {
            display: flex;
            align-items: center;
            background: #f0f2f5;
            border-radius: 20px;
            padding: 8px 12px;
            gap: 4px;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }
        
        .comment-input-container.focused {
            background: #ffffff;
            border-color: #e91e63;
            box-shadow: 0 0 0 2px rgba(233, 30, 99, 0.2);
        }
        
        .comment-input {
            flex: 1;
            border: none;
            background: transparent;
            resize: none;
            outline: none;
            font-family: 'Quicksand', sans-serif;
            font-size: 14px;
            line-height: 24px;
            max-height: 100px;
            min-height: 24px;
            padding: 0;
            color: #1c1e21;
            display: flex;
            align-items: center;
        }
        
        .comment-input::placeholder {
            color: #65676b;
        }
        
        .send-button {
            background: #e91e63;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: white;
            flex-shrink: 0;
        }
        
        .send-button:hover:not(:disabled) {
            background: #c2185b;
            transform: scale(1.05);
        }
        
        .send-button:active:not(:disabled) {
            transform: scale(0.95);
        }
        
        .send-button:disabled {
            background: #e4e6ea;
            color: #bcc0c4;
            cursor: not-allowed;
            transform: none;
        }
        
        .send-button svg {
            transition: transform 0.2s ease;
            width: 12px;
            height: 12px;
            display: block;
            margin: 0;
            padding: 0;
        }
        
        .send-button:hover:not(:disabled) svg {
            transform: translateX(1px);
        }
        
        /* Animation for send button */
        @keyframes sendPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .send-button.sending {
            animation: sendPulse 0.3s ease;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            #photoModal .modal-header,
            #photoModal .modal-footer {
                padding: 15px;
            }
            
            #photoModal .btn-close {
                padding: 10px;
            }
            
            #modalImage {
                max-height: 85vh !important;
                max-width: 90vw !important;
            }
            
            .comment-input-container {
                padding: 6px 10px;
            }
            
            .send-button {
                width: 21px;
                height: 21px;
            }
            
            .send-button svg {
                width: 9px;
                height: 9px;
            }
        }
        
        @media (max-width: 576px) {
            #photoModal .modal-header h5 {
                font-size: 1rem;
            }
            
            #photoModal .modal-footer p {
                font-size: 0.9rem;
            }
        }

        .p-4 {
            padding: 0.5rem !important; 
        }

        /* Radial Menu Variables */
        :root {
            --menu-radius: 56px;
            --toggle-size: 40px;
            --item-size: 36px;
            --transition-speed: 0.3s;
            --toggle-btn-color: #ff4e00;
            --toggle-btn-hover: #e63900;
            --item-btn-color: #9CA3AF;
            --item-btn-hover: #6B7280;
            --icon-color: white;
        }

        /* Floating Settings Container */
        .floating-settings {
            position: fixed;
            top: 20px;
            right: 15px;
            z-index: 9999;
            cursor: move;
            user-select: none;
            transition: none;
        }

        .floating-settings.dragging {
            transition: none !important;
            pointer-events: none;
        }

        .floating-settings.dragging * {
            pointer-events: none;
        }

        .floating-settings:not(.dragging) {
            transition: all 0.3s ease;
        }

        .radial-menu-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            width: calc(var(--menu-radius) * 2.5);
            height: calc(var(--menu-radius) * 2.5);
        }

        .toggle-btn {
            position: relative;
            width: var(--toggle-size);
            height: var(--toggle-size);
            background: var(--toggle-btn-color);
            border: none;
            border-radius: 50%;
            color: var(--icon-color);
            font-size: calc(var(--toggle-size) * 0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 10;
            transition: transform var(--transition-speed) cubic-bezier(0.68, -0.55, 0.27, 1.55), background 0.2s ease;
            box-shadow: 0 4px 15px rgba(107, 114, 128, 0.4);
        }

        .toggle-btn:hover {
            background: var(--toggle-btn-hover);
            box-shadow: 0 6px 20px rgba(107, 114, 128, 0.6);
        }

        .radial-menu-container.active .toggle-btn {
            transform: rotate(135deg);
        }

        .menu {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none; 
        }

        .menu .item {
            position: absolute;
            top: 50%;
            left: 50%;
            width: var(--item-size);
            height: var(--item-size);
            margin-top: calc(var(--item-size) / -2);
            margin-left: calc(var(--item-size) / -2);
            background: var(--item-btn-color);
            border: 2px solid #9CA3AF;
            border-radius: 50%;
            color: #6B7280;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 16px;
            text-decoration: none;
            opacity: 0;
            transform: translate(0, 0);
            transition: transform var(--transition-speed) ease-out, opacity var(--transition-speed) ease-out, background 0.2s ease, color 0.2s ease, border-color 0.2s ease;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            cursor: pointer;
        }

        .menu .item:hover {
            background: var(--item-btn-hover);
            border-color: #6B7280;
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(107, 114, 128, 0.4);
        }

        .radial-menu-container.active .menu {
            pointer-events: auto;
        }

        .radial-menu-container.active .menu .item {
            opacity: 1;
        }

        .radial-menu-container.active .item:nth-child(1) {
            transform: rotate(0deg) translateY(calc(var(--menu-radius) * -1)) rotate(0deg);
            transition-delay: 0.0s;
        }

        .radial-menu-container.active .item:nth-child(2) {
            transform: rotate(-45deg) translateY(calc(var(--menu-radius) * -1)) rotate(45deg);
            transition-delay: 0.05s;
        }

        .radial-menu-container.active .item:nth-child(3) {
            transform: rotate(-90deg) translateY(calc(var(--menu-radius) * -1)) rotate(90deg);
            transition-delay: 0.1s;
        }

        .radial-menu-container.active .item:nth-child(4) {
            transform: rotate(-135deg) translateY(calc(var(--menu-radius) * -1)) rotate(135deg);
            transition-delay: 0.15s;
        }

        .radial-menu-container.active .item:nth-child(5) {
            transform: rotate(-180deg) translateY(calc(var(--menu-radius) * -1)) rotate(180deg);
            transition-delay: 0.2s;
        }

        /* Tooltip cho radial menu items */
        .menu .item::before {
            content: attr(data-tooltip);
            position: absolute;
            top: 50%;
            right: calc(100% + 10px);
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 10000;
            pointer-events: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .menu .item:hover::before {
            opacity: 1;
            visibility: visible;
        }

    </style>
</head>
<body class="min-h-screen">
    <!-- Floating Decorations -->
    <div class="fixed inset-0 pointer-events-none z-0">
        <div class="absolute top-10 left-10 text-2xl animate-bounce" style="animation-delay: 0s;">🌸</div>
        <div class="absolute top-20 right-16 text-xl animate-pulse" style="animation-delay: 1s;">💖</div>
        <div class="absolute top-1/3 left-20 text-lg animate-bounce" style="animation-delay: 2s;">✨</div>
        <div class="absolute top-1/2 right-10 text-2xl animate-pulse" style="animation-delay: 0.5s;">🌺</div>
        <div class="absolute bottom-1/3 left-16 text-xl animate-bounce" style="animation-delay: 1.5s;">💕</div>
        <div class="absolute bottom-20 right-20 text-lg animate-pulse" style="animation-delay: 2.5s;">🦋</div>
        <div class="absolute bottom-10 left-1/4 text-2xl animate-bounce" style="animation-delay: 3s;">🌷</div>
        <div class="absolute top-1/4 right-1/3 text-lg animate-pulse" style="animation-delay: 0.8s;">💫</div>
    </div>

    <!-- Floating Settings Button -->
    <div class="floating-settings">
        <div class="radial-menu-container" id="radialMenuContainer">
            <div class="menu">
                <button class="item" data-tooltip="Thêm sự kiện" id="floatingAddEvent">
                    <i class="bi bi-cloud-plus" style="color: #10B981;"></i>
                </button>
                <button class="item" data-tooltip="Xóa sự kiện" id="floatingDeleteEvent">
                    <i class="bi bi-trash" style="color: #EF4444;"></i>
                </button>

                <button class="item" data-tooltip="Cập nhật danh sách ảnh" id="floatingUploadMetadata">
                    <i class="bi bi-cloud-download" style="color: white;"></i>
                </button>
                <button class="item" data-tooltip="Bật/Tắt tự động 9h sáng" id="floatingAutoUpdate">
                    <i class="bi bi-alarm"></i>
                </button>
                <button class="item" data-tooltip="Refresh dữ liệu" id="floatingRefreshPhotos">
                    <i class="bi bi-arrow-repeat" style="color: #06B6D4;"></i>
                </button>
            </div>
            <button class="toggle-btn" id="settingsBtn">
                <i class="bi bi-gear"></i>
            </button>
        </div>
    </div>



    <div class="w-full mx-auto relative z-10">
        <!-- Header -->
        <div class="text-center mb-8 px-4">
            <!-- Header removed -->
        </div>

        <!-- Calendar Container -->
        <div class="calendar-container mx-auto">
            <!-- Calendar Header -->
            <div class="calendar-header p-4 md:p-6">
                <div class="flex items-center justify-between">
                    <button id="prevMonth" class="month-nav">
                        <svg class="w-5 h-5" fill="white" stroke="white" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                    </button>
                    
                    <div class="text-center">
                        <h2 id="monthYear" class="text-xl md:text-2xl font-bold text-white"></h2>
                    </div>
                    
                    <button id="nextMonth" class="month-nav">
                        <svg class="w-5 h-5" fill="white" stroke="white" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Days of Week -->
            <div class="grid grid-cols-7 bg-gray-50 border-b">
                <div class="p-2 md:p-3 text-center font-semibold day-name text-base md:text-lg">CN</div>
                <div class="p-2 md:p-3 text-center font-semibold day-name text-base md:text-lg">T2</div>
                <div class="p-2 md:p-3 text-center font-semibold day-name text-base md:text-lg">T3</div>
                <div class="p-2 md:p-3 text-center font-semibold day-name text-base md:text-lg">T4</div>
                <div class="p-2 md:p-3 text-center font-semibold day-name text-base md:text-lg">T5</div>
                <div class="p-2 md:p-3 text-center font-semibold day-name weekend text-base md:text-lg">T6</div>
                <div class="p-2 md:p-3 text-center font-semibold day-name weekend text-base md:text-lg">T7</div>
            </div>

            <!-- Calendar Days -->
            <div id="calendarDays" class="grid grid-cols-7 p-2">
                <!-- Days will be generated by JavaScript -->
            </div>
        </div>

        <!-- Today's Info and Anniversary Info -->
        <div class="mt-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 w-[90%] max-w-[1200px] mx-auto">
                <div class="today-info px-6 py-4 min-h-[120px] flex flex-col justify-center text-center">
                    <p class="text-gray-600 text-sm">Hôm nay</p>
                    <p id="todayDate" class="text-lg font-bold text-gray-800"></p>
                </div>
                <div id="anniversaryInfo" class="today-info px-6 py-4 bg-gradient-to-r from-pink-50 to-red-50 border-pink-300 min-h-[120px] flex flex-col justify-center text-center">
                    <p id="anniversaryLabel" class="text-pink-600 text-sm">Kỉ niệm sắp tới</p>
                    <p id="anniversaryDate" class="text-lg font-bold text-pink-800"></p>
                    <p id="daysLeft" class="text-sm text-pink-600 mt-1"></p>
                    <p id="anniversaryYears" class="text-xs text-pink-500"></p>
                </div>
            </div>
        </div>

        <!-- Events List -->
        <div class="mt-8 flex justify-center">
            <div class="calendar-container mx-auto">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-800">📅 Sự kiện</h3>
                        <div class="flex space-x-2" style="display: none;">
                            <button id="addEventBtn" class="p-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors" data-bs-toggle="modal" data-bs-target="#addEventModal">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
                                </svg>
                            </button>
                            <button id="deleteEventBtn" class="p-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors" disabled>
                                <i class="bi bi-trash"></i>
                            </button>

                        </div>
                    </div>
                    
                    <!-- Loading Spinner -->
                    <div id="loading-spinner" class="hidden flex justify-center items-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-pink-500"></div>
                        <span class="ml-2 text-gray-600">Đang tải...</span>
                    </div>
                    
                    <!-- Events Container -->
                    <div id="eventsContainer" class="space-y-3">
                        <!-- Events will be loaded here -->
                    </div>
                    
                    <!-- Empty State -->
                    <div id="emptyState" class="hidden text-center py-8 text-gray-500">
                        <p>📝 Chưa có sự kiện nào</p>
                    </div>
                    
                    <!-- Error Message -->
                    <div id="errorMessage" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 text-red-700">
                        <p>❌ Không thể tải danh sách sự kiện</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Newsfeed Section -->
        <div class="mt-8 flex justify-center">
            <div class="calendar-container mx-auto">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-gray-800">📸 Khoảnh Khắc Đáng Yêu</h3>
                        <div class="flex space-x-2" style="display: none;">
                            <button id="uploadMetadataBtn" class="p-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors" title="Cập nhật danh sách ảnh">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                                </svg>
                            </button>
                            <button id="autoUpdateToggle" class="p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors" title="Bật/Tắt cập nhật tự động 9h sáng">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                                </svg>
                            </button>
                            <button id="refreshPhotos" class="p-2 bg-pink-500 text-white rounded-lg hover:bg-pink-600 transition-colors" title="Refresh dữ liệu">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Loading Spinner for Photos -->
                    <div id="photos-loading-spinner" class="hidden flex justify-center items-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-pink-500"></div>
                        <span class="ml-2 text-gray-600">Đang tải ảnh...</span>
                    </div>
                    
                    <!-- Photos Grid -->
                    <div id="photosGrid" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
                        <!-- Photos will be loaded here -->
                    </div>
                    
                    <!-- Pagination Controls -->
                    <div id="paginationControls" class="hidden mt-8 flex flex-col sm:flex-row items-center justify-between gap-4">
                        <div class="text-sm text-gray-600">
                            Hiển thị <span id="currentRange"></span> trong tổng số <span id="totalPhotos"></span> ảnh
                        </div>
                        
                        <div class="flex items-center gap-2">
                            <button id="firstPageBtn" class="px-3 py-2 text-sm bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                                <i class="bi bi-chevron-double-left"></i>
                            </button>
                            <button id="prevPageBtn" class="px-3 py-2 text-sm bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                                <i class="bi bi-chevron-left"></i>
                            </button>
                            
                            <div class="flex items-center gap-1" id="pageNumbers">
                                <!-- Page numbers will be generated here -->
                            </div>
                            
                            <button id="nextPageBtn" class="px-3 py-2 text-sm bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                                <i class="bi bi-chevron-right"></i>
                            </button>
                            <button id="lastPageBtn" class="px-3 py-2 text-sm bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                                <i class="bi bi-chevron-double-right"></i>
                            </button>
                        </div>
                        
                        <div class="text-sm text-gray-600">
                            Trang <span id="currentPageDisplay"></span> / <span id="totalPagesDisplay"></span>
                        </div>
                    </div>
                    
                    <!-- Empty State for Photos -->
                    <div id="photosEmptyState" class="hidden text-center py-8 text-gray-500">
                        <p>📷 Chưa có ảnh nào</p>
                    </div>
                    
                    <!-- Error Message for Photos -->
                    <div id="photosErrorMessage" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 text-red-700">
                        <p>❌ Không thể tải danh sách ảnh</p>
                    </div>
                </div>
            </div>
        </div>

    </div>



    <!-- Modal Thêm Sự Kiện -->
    <div class="modal fade" id="addEventModal" tabindex="-1" aria-labelledby="addEventModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-gradient-to-r from-pink-500 to-purple-600 text-white">
                    <h5 class="modal-title" id="addEventModalLabel">✨ Thêm Mới Sự Kiện</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addEventForm">
                        <!-- Ngày sự kiện -->
                        <div class="mb-3">
                            <label for="eventDate" class="form-label fw-bold">📅 Ngày sự kiện</label>
                            <input type="date" class="form-control" id="eventDate" required>
                            <div class="form-text">Hoặc nhập theo định dạng DD/MM/YYYY</div>
                        </div>

                        <!-- Nội dung -->
                        <div class="mb-3">
                            <label for="eventContent" class="form-label fw-bold">📝 Nội dung</label>
                            <textarea class="form-control" id="eventContent" rows="3" placeholder="Nhập nội dung sự kiện..." required></textarea>
                        </div>

                        <!-- Màu -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">🎨 Màu</label>
                            <div class="d-flex flex-wrap gap-2 mt-2 justify-content-center justify-content-sm-start">
                                <input type="radio" class="btn-check" name="eventColor" id="color-pink" value="bg-pink-500" checked>
                                <label class="btn btn-outline-secondary p-2" for="color-pink">
                                    <div class="w-6 h-6 bg-pink-500 rounded" style="width: 24px; height: 24px;"></div>
                                </label>

                                <input type="radio" class="btn-check" name="eventColor" id="color-blue" value="bg-blue-500">
                                <label class="btn btn-outline-secondary p-2" for="color-blue">
                                    <div class="w-6 h-6 bg-blue-500 rounded" style="width: 24px; height: 24px;"></div>
                                </label>

                                <input type="radio" class="btn-check" name="eventColor" id="color-green" value="bg-green-500">
                                <label class="btn btn-outline-secondary p-2" for="color-green">
                                    <div class="w-6 h-6 bg-green-500 rounded" style="width: 24px; height: 24px;"></div>
                                </label>

                                <input type="radio" class="btn-check" name="eventColor" id="color-yellow" value="bg-yellow-500">
                                <label class="btn btn-outline-secondary p-2" for="color-yellow">
                                    <div class="w-6 h-6 bg-yellow-500 rounded" style="width: 24px; height: 24px;"></div>
                                </label>

                                <input type="radio" class="btn-check" name="eventColor" id="color-purple" value="bg-purple-500">
                                <label class="btn btn-outline-secondary p-2" for="color-purple">
                                    <div class="w-6 h-6 bg-purple-500 rounded" style="width: 24px; height: 24px;"></div>
                                </label>

                                <input type="radio" class="btn-check" name="eventColor" id="color-red" value="bg-red-500">
                                <label class="btn btn-outline-secondary p-2" for="color-red">
                                    <div class="w-6 h-6 bg-red-500 rounded" style="width: 24px; height: 24px;"></div>
                                </label>
                            </div>
                        </div>

                        <!-- Icon -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">🎭 Icon</label>
                            <div class="d-flex flex-wrap gap-2 mt-2 justify-content-center justify-content-sm-start">
                                <input type="radio" class="btn-check" name="eventIcon" id="icon-heart" value="❤️" checked>
                                <label class="btn btn-outline-secondary" for="icon-heart">❤️</label>

                                <input type="radio" class="btn-check" name="eventIcon" id="icon-star" value="⭐">
                                <label class="btn btn-outline-secondary" for="icon-star">⭐</label>

                                <input type="radio" class="btn-check" name="eventIcon" id="icon-cake" value="🎂">
                                <label class="btn btn-outline-secondary" for="icon-cake">🎂</label>

                                <input type="radio" class="btn-check" name="eventIcon" id="icon-gift" value="🎁">
                                <label class="btn btn-outline-secondary" for="icon-gift">🎁</label>

                                <input type="radio" class="btn-check" name="eventIcon" id="icon-party" value="🎉">
                                <label class="btn btn-outline-secondary" for="icon-party">🎉</label>

                                <input type="radio" class="btn-check" name="eventIcon" id="icon-music" value="🎵">
                                <label class="btn btn-outline-secondary" for="icon-music">🎵</label>

                                <input type="radio" class="btn-check" name="eventIcon" id="icon-travel" value="✈️">
                                <label class="btn btn-outline-secondary" for="icon-travel">✈️</label>

                                <input type="radio" class="btn-check" name="eventIcon" id="icon-work" value="💼">
                                <label class="btn btn-outline-secondary" for="icon-work">💼</label>
                            </div>
                        </div>

                        <!-- Folder ảnh -->
                        <div class="mb-3">
                            <label for="eventImageFolder" class="form-label fw-bold">📁 Folder ảnh</label>
                            <input type="text" class="form-control" id="eventImageFolder" placeholder="Nhập đường dẫn folder ảnh...">
                            <div class="form-text">Tùy chọn: Đường dẫn đến thư mục chứa ảnh liên quan</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" id="saveEventBtn">
                        <span class="spinner-border spinner-border-sm d-none" id="saveSpinner" role="status" aria-hidden="true"></span>
                        💾 Lưu Sự Kiện
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Photo Modal -->
    <div class="modal fade" id="photoModal" tabindex="-1" aria-labelledby="photoModalLabel" aria-hidden="true" data-bs-backdrop="true" data-bs-keyboard="true">
        <div class="modal-dialog modal-fullscreen-lg-down modal-xl modal-dialog-centered">
            <div class="modal-content bg-transparent border-0 h-100">
                <!-- Header với nút đóng -->
                <div class="modal-header border-0 position-absolute w-100 d-flex justify-content-between align-items-center p-3" style="top: 0; left: 0; z-index: 1060; background: linear-gradient(180deg, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0.3) 50%, transparent 100%);">
                    <h5 id="photoModalTitle" class="modal-title text-white fw-bold m-0" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.8);"></h5>
                    <button type="button" class="position-relative" onclick="closePhotoModal()" aria-label="Đóng" style="background: white; border: none; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; color: red; font-size: 18px; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
                        ✕
                    </button>
                </div>
                
                <!-- Nút điều hướng căn giữa -->
                <button type="button" id="prevPhotoBtn" class="btn btn-outline-light position-absolute" onclick="navigatePhoto(-1)" style="left: 20px; top: 50%; transform: translateY(-50%); z-index: 1060; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.6); border: 2px solid rgba(255,255,255,0.3); backdrop-filter: blur(10px);">
                    <i class="bi bi-chevron-left" style="font-size: 20px;"></i>
                </button>
                <button type="button" id="nextPhotoBtn" class="btn btn-outline-light position-absolute" onclick="navigatePhoto(1)" style="right: 20px; top: 50%; transform: translateY(-50%); z-index: 1060; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.6); border: 2px solid rgba(255,255,255,0.3); backdrop-filter: blur(10px);">
                    <i class="bi bi-chevron-right" style="font-size: 20px;"></i>
                </button>
                
                <!-- Body chứa ảnh -->
                <div class="modal-body p-0 d-flex align-items-center justify-content-center h-100 position-relative" style="background: rgba(0,0,0,0.9);">
                    <!-- Loading spinner -->
                    <div id="imageLoadingSpinner" class="position-absolute d-flex flex-column align-items-center justify-content-center text-white">
                        <div class="spinner-border text-light mb-3" role="status" style="width: 3rem; height: 3rem;">
                            <span class="visually-hidden">Đang tải...</span>
                        </div>
                        <p class="text-center">Đang tải ảnh...</p>
                    </div>
                    
                    <!-- Ảnh chính -->
                    <img id="modalImage" src="" alt="Photo" class="img-fluid d-none" 
                         style="max-height: 90vh; max-width: 95vw; object-fit: contain; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);"
                         onload="handleImageLoad()" 
                         onerror="handleImageError()">
                    
                    <!-- Thông báo lỗi -->
                    <div id="imageErrorMessage" class="d-none text-center text-white">
                        <div class="mb-3">
                            <i class="bi bi-exclamation-triangle" style="font-size: 3rem;"></i>
                        </div>
                        <h5>Không thể tải ảnh</h5>
                        <p class="text-muted">Vui lòng thử lại sau</p>
                    </div>
                </div>
                
                <!-- Footer với thông tin ảnh -->
                <div class="modal-footer border-0 position-absolute w-100 d-flex justify-content-center p-3" style="bottom: 0; left: 0; z-index: 1060; background: linear-gradient(0deg, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0.3) 50%, transparent 100%);">
                    <p id="photoModalDescription" class="text-white text-center m-0" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.8);"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Chọn Sự Kiện Cho Ảnh -->
    <div class="modal fade" id="eventSelectionModal" tabindex="-1" aria-labelledby="eventSelectionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-gradient-to-r from-blue-500 to-purple-600 text-white">
                    <h5 class="modal-title" id="eventSelectionModalLabel">
                        <i class="bi bi-camera-fill me-2"></i>
                        Thêm Ảnh Vào Sự Kiện
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <p class="text-muted">Chọn sự kiện để thêm ảnh này vào:</p>
                        <div id="selectedPhotoInfo" class="bg-light p-3 rounded mb-3">
                            <!-- Thông tin ảnh được chọn sẽ hiển thị ở đây -->
                        </div>
                    </div>
                    
                    <!-- Loading Spinner -->
                    <div id="eventSelection-loading-spinner" class="hidden flex justify-center items-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                        <span class="ml-2 text-gray-600">Đang tải danh sách sự kiện...</span>
                    </div>
                    
                    <!-- Danh sách sự kiện -->
                    <div id="eventSelectionList" class="space-y-2 max-h-96 overflow-y-auto">
                        <!-- Danh sách sự kiện sẽ được tải ở đây -->
                    </div>
                    
                    <!-- Empty State -->
                    <div id="eventSelection-emptyState" class="hidden text-center py-8 text-gray-500">
                        <i class="bi bi-calendar-x display-1 text-muted"></i>
                        <p class="mt-3">Chưa có sự kiện nào</p>
                        <p class="text-sm">Vui lòng tạo sự kiện trước khi thêm ảnh</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" id="savePhotoToEventsBtn" disabled>
                        <span class="spinner-border spinner-border-sm d-none" id="savePhotoSpinner" role="status" aria-hidden="true"></span>
                        <i class="bi bi-check-lg me-1"></i>
                        Lưu Thay Đổi
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Hiển Thị Ảnh Của Sự Kiện -->
    <div class="modal fade" id="eventPhotosModal" tabindex="-1" aria-labelledby="eventPhotosModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-gradient-to-r from-pink-500 to-purple-600 text-white">
                    <h5 class="modal-title" id="eventPhotosModalLabel">
                        <i class="bi bi-images me-2"></i>
                        Ảnh Của Sự Kiện
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="eventPhotosInfo" class="mb-4">
                        <!-- Thông tin sự kiện sẽ hiển thị ở đây -->
                    </div>
                    
                    <!-- Loading Spinner -->
                    <div id="eventPhotos-loading-spinner" class="hidden flex justify-center items-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-pink-500"></div>
                        <span class="ml-2 text-gray-600">Đang tải ảnh...</span>
                    </div>
                    
                    <!-- Grid ảnh -->
                    <div id="eventPhotosGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        <!-- Ảnh sẽ được tải ở đây -->
                    </div>
                    
                    <!-- Empty State -->
                    <div id="eventPhotos-emptyState" class="hidden text-center py-8 text-gray-500">
                        <i class="bi bi-image display-1 text-muted"></i>
                        <p class="mt-3">Sự kiện này chưa có ảnh nào</p>
                        <p class="text-sm">Sử dụng nút <i class="bi bi-camera-fill"></i> trên ảnh để thêm vào sự kiện này</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Xác Nhận Xóa -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deleteConfirmModalLabel">
                        <i class="bi bi-trash me-2"></i>
                        Xác Nhận Xóa
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-3">Bạn có chắc chắn muốn xóa sự kiện này không?</p>
                    <div id="eventToDelete" class="bg-light p-3 rounded">
                        <!-- Thông tin sự kiện sẽ được hiển thị ở đây -->
                    </div>
                    <p class="text-muted mt-2 mb-0"><small>⚠️ Hành động này không thể hoàn tác!</small></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                        <span class="spinner-border spinner-border-sm d-none" id="deleteSpinner" role="status" aria-hidden="true"></span>
                        <i class="bi bi-trash me-1"></i>
                        Xóa Sự Kiện
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Biến cấu hình toàn cục
        let CONFIG = {};
        let GITHUB_USERNAME, REPO_NAME, PAT, FILE_PATH, COMMENTS_FILE_PATH, PHOTOS_METADATA_FILE_PATH, LOGS_FILE_PATH;
        let API_BASE_URL, COMMENTS_API_URL, PHOTOS_METADATA_API_URL, LOGS_API_URL;
        let FOLDER_ID, API_KEY, PHOTOS_PER_PAGE;
        let CONFIG_API_URL;

        // Hàm cập nhật file cấu hình
        async function updateConfigFile(key, value) {
            try {
                // Đọc file cấu hình hiện tại
                const response = await fetch(CONFIG_API_URL, {
                    headers: {
                        'Authorization': `token ${PAT}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const currentConfig = JSON.parse(base64Decode(data.content));
                
                // Cập nhật giá trị
                currentConfig[key] = value;
                CONFIG[key] = value; // Cập nhật biến toàn cục
                
                // Ghi lại file cấu hình
                const updatedContent = JSON.stringify(currentConfig, null, 2);
                const encodedContent = base64Encode(updatedContent);
                
                const updateResponse = await fetch(CONFIG_API_URL, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${PAT}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify({
                        message: `Cập nhật cấu hình ${key} = ${value}`,
                        content: encodedContent,
                        sha: data.sha
                    })
                });
                
                if (!updateResponse.ok) {
                    throw new Error(`HTTP error! status: ${updateResponse.status}`);
                }
                
                console.log(`✅ Đã cập nhật cấu hình ${key} = ${value}`);
                
            } catch (error) {
                console.error('❌ Lỗi khi cập nhật file cấu hình:', error);
                // Không throw error để không ảnh hưởng đến chức năng chính
            }
        }

        // Hàm tải cấu hình từ file configApp.json
        async function loadConfig() {
            try {
                console.log('🔧 Đang tải cấu hình từ configApp.json...');
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 giây timeout
                
                const response = await fetch('./configApp.json', {
                    signal: controller.signal,
                    cache: 'no-cache'
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    console.error(`❌ HTTP Error: ${response.status} - ${response.statusText}`);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                CONFIG = await response.json();
                console.log('📄 Raw config loaded:', CONFIG);
                
                // Kiểm tra các trường bắt buộc với logging chi tiết
                const requiredFields = ['GITHUB_USERNAME', 'REPO_NAME', 'PAT1', 'PAT2'];
                const missingFields = requiredFields.filter(field => !CONFIG[field]);
                
                if (missingFields.length > 0) {
                    console.error('❌ Thiếu các trường bắt buộc:', missingFields);
                    throw new Error(`Thiếu cấu hình: ${missingFields.join(', ')}`);
                }
                
                // Thiết lập các biến từ config
                GITHUB_USERNAME = CONFIG.GITHUB_USERNAME;
                REPO_NAME = CONFIG.REPO_NAME;
                PAT = CONFIG.PAT1 + CONFIG.PAT2; // Ghép PAT1 và PAT2
                FILE_PATH = CONFIG.FILE_PATH || 'events.json';
                COMMENTS_FILE_PATH = CONFIG.COMMENTS_FILE_PATH || 'comments.json';
                PHOTOS_METADATA_FILE_PATH = CONFIG.PHOTOS_METADATA_FILE_PATH || 'photos_metadata.json';
                LOGS_FILE_PATH = CONFIG.LOGS_FILE_PATH || 'logs.json';
                
                // Thiết lập các URL API
                API_BASE_URL = `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${FILE_PATH}`;
                COMMENTS_API_URL = `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${COMMENTS_FILE_PATH}`;
                PHOTOS_METADATA_API_URL = `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${PHOTOS_METADATA_FILE_PATH}`;
                LOGS_API_URL = `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${LOGS_FILE_PATH}`;
                CONFIG_API_URL = `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/configApp.json`;
                
                // Cấu hình Google Drive API
                FOLDER_ID = CONFIG.FOLDER_ID || '';
                API_KEY = CONFIG.API_KEY || '';
                PHOTOS_PER_PAGE = CONFIG.PHOTOS_PER_PAGE || 12;
                
                console.log('✅ Đã tải cấu hình thành công:', {
                    username: GITHUB_USERNAME,
                    repo: REPO_NAME,
                    folderId: FOLDER_ID ? 'Có' : 'Không có',
                    apiKey: API_KEY ? 'Có' : 'Không có',
                    photosPerPage: PHOTOS_PER_PAGE,
                    autoLoadMetadata: CONFIG.AUTO_LOAD_METADATA
                });
                
                return true;
            } catch (error) {
                console.error('❌ Chi tiết lỗi khi tải cấu hình:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
                
                let errorMessage = '❌ Không thể tải cấu hình ứng dụng';
                
                if (error.name === 'AbortError') {
                    errorMessage = '⏰ Timeout khi tải cấu hình (quá 10 giây)';
                } else if (error.message.includes('404')) {
                    errorMessage = '📄 Không tìm thấy file configApp.json';
                } else if (error.message.includes('Thiếu cấu hình')) {
                    errorMessage = `🔧 ${error.message}`;
                } else if (error.message.includes('JSON')) {
                    errorMessage = '📝 File cấu hình không đúng định dạng JSON';
                }
                
                showMessage(errorMessage, 'error');
                throw error;
            }
        }

        // Global variables
        let allPhotosData = [];
        let currentPhotosPage = [];
        let commentsData = {};
        let reactionsData = {};
        let currentPage = 1;
        let totalPages = 1;
        let isLoadingPhotos = false;
        let autoUpdateInterval = null;
        let selectedPhotoId = null;
        let selectedEventsForPhoto = new Set();

        // Hệ thống logging
        async function readLogs() {
            try {
                const response = await fetch(LOGS_API_URL, {
                    headers: {
                        'Authorization': `token ${PAT}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 404) {
                        // File chưa tồn tại, tạo file mới
                        return { content: [], sha: null };
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const content = JSON.parse(base64Decode(data.content));
                return { content, sha: data.sha };
            } catch (error) {
                console.error('Lỗi khi đọc logs từ GitHub:', error);
                return { content: [], sha: null };
            }
        }

        async function writeLogs(logsArray, sha) {
            const content = JSON.stringify(logsArray, null, 2);
            const encodedContent = base64Encode(content);

            const body = JSON.stringify({
                message: 'Cập nhật logs hoạt động',
                content: encodedContent,
                ...(sha && { sha: sha })
            });

            try {
                const response = await fetch(LOGS_API_URL, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${PAT}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: body
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Đã ghi log thành công lên GitHub:', data);
                return data;
            } catch (error) {
                console.error('Lỗi khi ghi log lên GitHub:', error);
                throw error;
            }
        }

        async function addLog(action, details = '') {
            try {
                const now = new Date();
                const vietnamTime = new Date(now.getTime() + (7 * 60 * 60 * 1000)); // UTC+7
                
                const logEntry = {
                    date: vietnamTime.toLocaleDateString('vi-VN'),
                    time: vietnamTime.toLocaleTimeString('vi-VN'),
                    action: action,
                    details: details,
                    timestamp: vietnamTime.toISOString()
                };

                // Đọc logs hiện tại
                const { content: currentLogs, sha } = await readLogs();
                
                // Thêm log mới vào đầu mảng (log mới nhất ở trên)
                currentLogs.unshift(logEntry);
                
                // Giới hạn số lượng logs (giữ 1000 logs gần nhất)
                if (currentLogs.length > 1000) {
                    currentLogs.splice(1000);
                }
                
                // Ghi lại logs
                await writeLogs(currentLogs, sha);
                
                console.log('Đã thêm log:', logEntry);
            } catch (error) {
                console.error('Lỗi khi thêm log:', error);
                // Không throw error để không ảnh hưởng đến chức năng chính
            }
        }

        // Hàm kiểm tra và tự động cập nhật metadata
        function setupAutoUpdate() {
            // Kiểm tra xem đã đến giờ cập nhật chưa
            function checkAndUpdate() {
                const now = new Date();
                const hour = now.getHours();
                const minute = now.getMinutes();
                
                // Kiểm tra nếu là 9h sáng (từ 9:00 đến 9:05)
                if (hour === 9 && minute >= 0 && minute <= 5) {
                    const lastUpdateKey = 'lastMetadataUpdate';
                    const today = now.toDateString();
                    const lastUpdate = localStorage.getItem(lastUpdateKey);
                    
                    // Chỉ cập nhật nếu chưa cập nhật hôm nay
                    if (lastUpdate !== today) {
                        console.log('🕘 Bắt đầu cập nhật metadata tự động lúc 9h sáng...');
                        uploadPhotosMetadata(true).then((photoCount) => {
                            localStorage.setItem(lastUpdateKey, today);
                            showMessage('🌅 Đã tự động cập nhật metadata ảnh lúc 9h sáng!', 'success');
                            // Log đã được thêm trong hàm uploadPhotosMetadata
                            
                            // Thêm log hoàn thành
                            addLog('Chức năng cập nhật tự động 9h sáng chạy hoàn thành', `Thành công: ${photoCount} ảnh`);
                        }).catch(error => {
                            console.error('Lỗi cập nhật tự động:', error);
                            showMessage('⚠️ Cập nhật tự động thất bại. Vui lòng cập nhật thủ công.', 'error');
                            // Thêm log lỗi
                            addLog('Cập nhật danh sách ảnh vào file metadata tự động', 'Thất bại: ' + error.message);
                            addLog('Chức năng cập nhật tự động 9h sáng chạy hoàn thành', 'Thất bại: ' + error.message);
                        });
                    }
                }
            }
            
            // Kiểm tra mỗi phút
            autoUpdateInterval = setInterval(checkAndUpdate, 60000);
            
            // Kiểm tra ngay khi khởi động
            checkAndUpdate();
            
            console.log('⏰ Đã thiết lập cập nhật tự động metadata lúc 9h sáng hằng ngày');
        }

        // Hàm dừng tự động cập nhật
        function stopAutoUpdate() {
            if (autoUpdateInterval) {
                clearInterval(autoUpdateInterval);
                autoUpdateInterval = null;
                console.log('⏹️ Đã dừng cập nhật tự động');
            }
        }

        // Hàm upload metadata ảnh lên GitHub
        async function uploadPhotosMetadata(isAutoUpdate = false) {
            const uploadBtn = document.getElementById('uploadMetadataBtn');
            const loadingSpinner = document.getElementById('photos-loading-spinner');
            const photosGrid = document.getElementById('photosGrid');
            const emptyState = document.getElementById('photosEmptyState');
            const errorMessage = document.getElementById('photosErrorMessage');
            
            if (isLoadingPhotos) return;
            isLoadingPhotos = true;
            
            try {
                // Hiển thị loading
                loadingSpinner.classList.remove('hidden');
                photosGrid.innerHTML = '';
                emptyState.classList.add('hidden');
                errorMessage.classList.add('hidden');
                uploadBtn.disabled = true;
                
                // Cập nhật text loading
                const loadingText = loadingSpinner.querySelector('span');
                if (loadingText) {
                    const updateType = isAutoUpdate ? 'tự động' : 'thủ công';
                    loadingText.textContent = `Đang tải metadata từ Google Drive (${updateType})...`;
                }
                
                // Tải tất cả ảnh từ Google Drive
                let allFiles = [];
                let nextPageToken = '';
                let pageCount = 0;
                
                do {
                    const url = `https://www.googleapis.com/drive/v3/files?q='${FOLDER_ID}'+in+parents+and+mimeType+contains+'image/'&key=${API_KEY}&fields=files(id,name,webViewLink,thumbnailLink,webContentLink,createdTime,modifiedTime,size),nextPageToken&pageSize=1000${nextPageToken ? `&pageToken=${nextPageToken}` : ''}`;
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 giây timeout
                    
                    const response = await fetch(url, {
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    allFiles = allFiles.concat(data.files || []);
                    nextPageToken = data.nextPageToken || '';
                    pageCount++;
                    
                    // Cập nhật loading với số lượng ảnh đã tải
                    if (loadingText) {
                        loadingText.textContent = `Đang tải metadata... (${allFiles.length} ảnh, trang ${pageCount})`;
                    }
                    
                    // Thêm delay nhỏ giữa các request để tránh rate limit
                    if (nextPageToken) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                    
                } while (nextPageToken);
                
                // Cập nhật text loading
                if (loadingText) {
                    loadingText.textContent = `Đang lưu metadata lên GitHub... (${allFiles.length} ảnh)`;
                }
                
                // Lưu metadata lên GitHub
                await writePhotosMetadata(allFiles);
                
                // Cập nhật dữ liệu local
                allPhotosData = allFiles;
                totalPages = Math.ceil(allPhotosData.length / PHOTOS_PER_PAGE);
                currentPage = 1;
                
                // Tải comments và reactions
                const { content: commentsArray } = await readComments();
                commentsData = {};
                reactionsData = {};
                
                if (Array.isArray(commentsArray)) {
                    commentsArray.forEach(entry => {
                        if (entry.ID_IMG) {
                            if (entry.comments && Array.isArray(entry.comments)) {
                                if (!commentsData[entry.ID_IMG]) {
                                    commentsData[entry.ID_IMG] = [];
                                }
                                entry.comments.forEach(comment => {
                                    commentsData[entry.ID_IMG].push({
                                        text: comment.comment,
                                        timestamp: comment.date_input
                                    });
                                });
                            }
                            
                            reactionsData[entry.ID_IMG] = {
                                count_tim: entry.count_tim || 0
                            };
                        }
                    });
                }
                
                loadingSpinner.classList.add('hidden');
                
                if (allPhotosData.length === 0) {
                    emptyState.classList.remove('hidden');
                    showMessage('Không tìm thấy ảnh nào trong folder!', 'error');
                    return;
                }
                
                // Hiển thị trang đầu tiên
                displayPhotosPage(1);
                updatePaginationControls();
                
                const updateType = isAutoUpdate ? 'tự động' : 'thủ công';
                showMessage(`✅ Đã cập nhật ${updateType} thành công ${allFiles.length} ảnh lên GitHub!`, 'success');
                
                // Thêm log cho cả hai loại cập nhật
                if (isAutoUpdate) {
                    addLog('Cập nhật danh sách ảnh vào file metadata tự động', `${allFiles.length} ảnh`);
                } else {
                    addLog('Cập nhật danh sách ảnh vào file metadata thủ công', `${allFiles.length} ảnh`);
                }
                
                // Trả về số lượng ảnh để sử dụng trong log tự động
                return allFiles.length;
                
            } catch (error) {
                console.error('Lỗi khi upload metadata:', error);
                loadingSpinner.classList.add('hidden');
                
                if (error.name === 'AbortError') {
                    errorMessage.querySelector('p').textContent = '⏰ Upload metadata bị timeout. Vui lòng thử lại.';
                } else if (error.message.includes('403')) {
                    errorMessage.querySelector('p').textContent = '🔒 Không có quyền truy cập folder ảnh hoặc GitHub.';
                } else if (error.message.includes('404')) {
                    errorMessage.querySelector('p').textContent = '📁 Không tìm thấy folder ảnh hoặc repository.';
                } else {
                    errorMessage.querySelector('p').textContent = '❌ Không thể upload metadata. Vui lòng thử lại.';
                }
                
                errorMessage.classList.remove('hidden');
                showMessage('❌ Lỗi khi cập nhật metadata ảnh!', 'error');
            } finally {
                isLoadingPhotos = false;
                uploadBtn.disabled = false;
            }
        }

        // Hàm ghi metadata ảnh lên GitHub
        async function writePhotosMetadata(photosArray, sha = null) {
            const content = JSON.stringify(photosArray, null, 2);
            const encodedContent = base64Encode(content);

            // Nếu không có sha, thử đọc file hiện tại để lấy sha
            if (!sha) {
                try {
                    const response = await fetch(PHOTOS_METADATA_API_URL, {
                        headers: {
                            'Authorization': `token ${PAT}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        sha = data.sha;
                    }
                } catch (error) {
                    console.log('File metadata chưa tồn tại, sẽ tạo mới');
                }
            }

            const body = JSON.stringify({
                message: `Cập nhật metadata ${photosArray.length} ảnh - ${new Date().toLocaleString('vi-VN')}`,
                content: encodedContent,
                ...(sha && { sha: sha })
            });

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 giây timeout
                
                const response = await fetch(PHOTOS_METADATA_API_URL, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${PAT}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: body,
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Đã ghi metadata ảnh thành công lên GitHub:', data);
                return data;
            } catch (error) {
                console.error('Lỗi khi ghi metadata ảnh lên GitHub:', error);
                throw error;
            }
        }

        // Hàm đọc metadata ảnh từ GitHub
        async function loadPhotosMetadataFromGitHub() {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 giây timeout
                
                const response = await fetch(PHOTOS_METADATA_API_URL, {
                    headers: {
                        'Authorization': `token ${PAT}`,
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        console.log('File metadata chưa tồn tại');
                        return [];
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const content = JSON.parse(base64Decode(data.content));
                return content;
            } catch (error) {
                console.error('Lỗi khi đọc metadata từ GitHub:', error);
                return [];
            }
        }

        // Hàm tải tất cả ảnh từ GitHub metadata (thay thế cho Google Drive API)
        async function loadAllPhotosFromMetadata() {
            if (isLoadingPhotos) return;
            isLoadingPhotos = true;
            
            const loadingSpinner = document.getElementById('photos-loading-spinner');
            const photosGrid = document.getElementById('photosGrid');
            const emptyState = document.getElementById('photosEmptyState');
            const errorMessage = document.getElementById('photosErrorMessage');
            
            try {
                // Hiển thị loading
                loadingSpinner.classList.remove('hidden');
                photosGrid.innerHTML = '';
                emptyState.classList.add('hidden');
                errorMessage.classList.add('hidden');
                
                const loadingText = loadingSpinner.querySelector('span');
                if (loadingText) {
                    loadingText.textContent = 'Đang tải danh sách ảnh...';
                }
                
                // Tải metadata từ GitHub
                const photosMetadata = await loadPhotosMetadataFromGitHub();
                
                if (!photosMetadata || photosMetadata.length === 0) {
                    loadingSpinner.classList.add('hidden');
                    emptyState.classList.remove('hidden');
                    showMessage('📷 Chưa có metadata ảnh. Vui lòng nhấn nút cập nhật để tải ảnh từ Google Drive!', 'error');
                    return;
                }
                
                allPhotosData = photosMetadata;
                totalPages = Math.ceil(allPhotosData.length / PHOTOS_PER_PAGE);
                currentPage = 1;
                
                // Tải comments và reactions
                const { content: commentsArray } = await readComments();
                commentsData = {};
                reactionsData = {};
                
                if (Array.isArray(commentsArray)) {
                    commentsArray.forEach(entry => {
                        if (entry.ID_IMG) {
                            if (entry.comments && Array.isArray(entry.comments)) {
                                if (!commentsData[entry.ID_IMG]) {
                                    commentsData[entry.ID_IMG] = [];
                                }
                                entry.comments.forEach(comment => {
                                    commentsData[entry.ID_IMG].push({
                                        text: comment.comment,
                                        timestamp: comment.date_input
                                    });
                                });
                            }
                            
                            reactionsData[entry.ID_IMG] = {
                                count_tim: entry.count_tim || 0
                            };
                        }
                    });
                }
                
                loadingSpinner.classList.add('hidden');
                
                // Hiển thị trang đầu tiên
                displayPhotosPage(1);
                updatePaginationControls();
                
                // Thêm log
                addLog('Load refresh hiển thị ảnh trên grid', `${allPhotosData.length} ảnh`);
                
            } catch (error) {
                console.error('Lỗi khi tải metadata từ GitHub:', error);
                loadingSpinner.classList.add('hidden');
                
                if (error.name === 'AbortError') {
                    errorMessage.querySelector('p').textContent = '⏰ Tải metadata bị timeout. Vui lòng thử lại.';
                } else {
                    errorMessage.querySelector('p').textContent = '❌ Không thể tải danh sách ảnh. Vui lòng thử lại.';
                }
                
                errorMessage.classList.remove('hidden');
            } finally {
                isLoadingPhotos = false;
            }
        }

        // Hàm tải tất cả ảnh từ Google Drive với phân trang (giữ lại để backup)
        async function loadAllPhotosFromDrive() {
            if (isLoadingPhotos) return;
            isLoadingPhotos = true;
            
            const loadingSpinner = document.getElementById('photos-loading-spinner');
            const photosGrid = document.getElementById('photosGrid');
            const emptyState = document.getElementById('photosEmptyState');
            const errorMessage = document.getElementById('photosErrorMessage');
            
            try {
                // Hiển thị loading
                loadingSpinner.classList.remove('hidden');
                photosGrid.innerHTML = '';
                emptyState.classList.add('hidden');
                errorMessage.classList.add('hidden');
                
                // Tải tất cả ảnh với pageSize lớn và timeout
                let allFiles = [];
                let nextPageToken = '';
                let pageCount = 0;
                const maxPages = 10; // Giảm số trang để tránh timeout
                
                do {
                    const url = `https://www.googleapis.com/drive/v3/files?q='${FOLDER_ID}'+in+parents+and+mimeType+contains+'image/'&key=${API_KEY}&fields=files(id,name,webViewLink,thumbnailLink,webContentLink),nextPageToken&pageSize=500${nextPageToken ? `&pageToken=${nextPageToken}` : ''}`;
                    
                    // Thêm timeout cho fetch request
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 giây timeout
                    
                    const response = await fetch(url, {
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    allFiles = allFiles.concat(data.files || []);
                    nextPageToken = data.nextPageToken || '';
                    pageCount++;
                    
                    // Cập nhật loading với số lượng ảnh đã tải
                    const loadingText = loadingSpinner.querySelector('span');
                    if (loadingText) {
                        loadingText.textContent = `Đang tải ảnh... (${allFiles.length} ảnh)`;
                    }
                    
                    // Thêm delay nhỏ giữa các request để tránh rate limit
                    if (nextPageToken && pageCount < maxPages) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                    
                } while (nextPageToken && pageCount < maxPages);
                
                allPhotosData = allFiles;
                totalPages = Math.ceil(allPhotosData.length / PHOTOS_PER_PAGE);
                currentPage = 1;
                
                loadingSpinner.classList.add('hidden');
                
                if (allPhotosData.length === 0) {
                    emptyState.classList.remove('hidden');
                    return;
                }
                
                // Tải comments và reactions, chuyển đổi cấu trúc dữ liệu
                const { content: commentsArray } = await readComments();
                commentsData = {};
                reactionsData = {};
                
                // Chuyển đổi từ mảng sang object với key là tên file ảnh
                if (Array.isArray(commentsArray)) {
                    commentsArray.forEach(entry => {
                        if (entry.ID_IMG) {
                            // Xử lý comments từ mảng comments trong entry
                            if (entry.comments && Array.isArray(entry.comments)) {
                                if (!commentsData[entry.ID_IMG]) {
                                    commentsData[entry.ID_IMG] = [];
                                }
                                entry.comments.forEach(comment => {
                                    commentsData[entry.ID_IMG].push({
                                        text: comment.comment,
                                        timestamp: comment.date_input
                                    });
                                });
                            }
                            
                            // Xử lý reactions (chỉ tim)
                            reactionsData[entry.ID_IMG] = {
                                count_tim: entry.count_tim || 0
                            };
                        }
                    });
                }
                
                // Hiển thị trang đầu tiên
                displayPhotosPage(1);
                updatePaginationControls();
                
                // Thêm log
                addLog('Load refresh hiển thị ảnh trên grid', `${allPhotosData.length} ảnh`);
                
            } catch (error) {
                console.error('Lỗi khi tải ảnh từ Google Drive:', error);
                loadingSpinner.classList.add('hidden');
                
                // Xử lý các loại lỗi khác nhau
                if (error.name === 'AbortError') {
                    console.log('Request bị timeout sau 15 giây');
                    errorMessage.querySelector('p').textContent = '⏰ Tải ảnh bị timeout. Vui lòng thử lại.';
                } else if (error.message.includes('403')) {
                    errorMessage.querySelector('p').textContent = '🔒 Không có quyền truy cập folder ảnh.';
                } else if (error.message.includes('404')) {
                    errorMessage.querySelector('p').textContent = '📁 Không tìm thấy folder ảnh.';
                } else {
                    errorMessage.querySelector('p').textContent = '❌ Không thể tải danh sách ảnh. Vui lòng thử lại.';
                }
                
                errorMessage.classList.remove('hidden');
            } finally {
                isLoadingPhotos = false;
            }
        }

        // Hàm hiển thị ảnh theo trang
        function displayPhotosPage(page) {
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            const startIndex = (page - 1) * PHOTOS_PER_PAGE;
            const endIndex = Math.min(startIndex + PHOTOS_PER_PAGE, allPhotosData.length);
            
            currentPhotosPage = allPhotosData.slice(startIndex, endIndex);
            displayPhotos(currentPhotosPage, startIndex);
            updatePaginationControls();
        }

        // Hàm hiển thị ảnh trong grid
        function displayPhotos(photos, startIndex = 0) {
            const photosGrid = document.getElementById('photosGrid');
            photosGrid.innerHTML = '';
            
            photos.forEach((photo, index) => {
                const globalIndex = startIndex + index;
                const photoCard = createPhotoCard(photo, globalIndex);
                photosGrid.appendChild(photoCard);
                
                // Reset flag khi hiển thị ảnh từ grid chính
                isViewingEventPhotos = false;
            });
        }

        // Hàm tạo card ảnh
        function createPhotoCard(photo, index) {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-lg shadow-md overflow-hidden';
            
            // Tạo URL ảnh từ Google Drive với nhiều phương án dự phòng
            const thumbnailUrl = `https://drive.google.com/thumbnail?id=${photo.id}&sz=w400-h400`;
            const directUrl = `https://drive.google.com/uc?export=view&id=${photo.id}`;
            const fallbackUrl = `https://lh3.googleusercontent.com/d/${photo.id}=w400-h400`;
            
            // Lấy comments cho ảnh này dựa trên tên file
            const photoComments = commentsData[photo.name] || [];
            
            // Lấy reactions cho ảnh này
            const photoReactions = reactionsData[photo.name] || { count_tim: 0 };
            
            card.innerHTML = `
                <div class="relative">
                    <img src="${thumbnailUrl}" alt="${photo.name}" 
                         class="w-full h-64 object-cover cursor-pointer"
                         onclick="openPhotoModal('${photo.id}', '${photo.name}', ${index})"
                         onerror="handleThumbnailError(this, '${directUrl}', '${fallbackUrl}')"
                         loading="lazy">
                    <div class="absolute top-2 right-2 bg-black bg-opacity-50 text-white px-2 py-1 rounded text-xs cursor-pointer hover:bg-opacity-70 transition-all duration-200" 
                         onclick="event.stopPropagation(); showEventSelectionModal('${photo.id}')" 
                         title="Thêm ảnh vào sự kiện"
                         style="display: flex; align-items: center; justify-content: center; min-height: 20px;">
                        <span style="display: flex; align-items: baseline; gap: 2px; line-height: 1;">
                            <i class="bi bi-camera" style="font-size: 12px; line-height: 1;"></i>
                            <span style="font-size: 12px; font-weight: 500; line-height: 1;">${index + 1}</span>
                        </span>
                    </div>
                </div>
                
                <div class="p-4">
                    <!-- Count Section -->
                    <div class="dem-tong-count flex items-center justify-end space-x-4 mb-1.5 text-sm text-gray-600">
                        <div class="flex items-center space-x-1">
                            <i class="bi bi-heart-fill text-red-500"></i>
                            <span id="heart-count-${photo.id}">${photoReactions.count_tim}</span>
                        </div>
                        <div class="flex items-center space-x-1">
                            <i class="bi bi-chat-dots"></i>
                            <span id="comment-count-${photo.id}">${photoComments.length}</span>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="button-action flex items-center justify-around border-t border-gray-200 py-2 mb-1.5" id="button-action-${photo.id}">
                        <button class="flex flex-col items-center justify-center px-1 py-1 rounded hover:bg-gray-50 transition-colors flex-1 text-xs min-w-0" 
                                onclick="toggleReaction('${photo.id}', 'tim')" 
                                id="heart-btn-${photo.id}">
                            <i class="bi bi-heart text-gray-600 text-sm mb-1" id="heart-icon-${photo.id}"></i>
                            <span class="text-gray-700 font-medium text-xs leading-none">Thích</span>
                        </button>
                        
                        <button class="flex flex-col items-center justify-center px-1 py-1 rounded hover:bg-gray-50 transition-colors flex-1 text-xs min-w-0" 
                                onclick="toggleComments('${photo.id}')" 
                                id="comment-btn-${photo.id}">
                            <i class="bi bi-chat-right-dots text-gray-600 text-sm mb-1"></i>
                            <span class="text-gray-700 font-medium text-xs leading-none">Bình luận</span>
                        </button>
                        
                        <button class="flex flex-col items-center justify-center px-1 py-1 rounded hover:bg-gray-50 transition-colors flex-1 text-xs min-w-0" 
                                onclick="sharePhoto('${photo.id}', '${photo.name}')" 
                                id="share-btn-${photo.id}">
                            <i class="bi bi-share text-gray-600 text-sm mb-1"></i>
                            <span class="text-gray-700 font-medium text-xs leading-none">Chia sẻ</span>
                        </button>
                    </div>
                    
                    <!-- Comments Section (Hidden by default) -->
                    <div class="comments-section hidden" id="comments-section-${photo.id}">
                        <div class="max-h-32 overflow-y-auto overflow-x-hidden space-y-1 mb-3" id="comments-${photo.id}">
                            ${photoComments.map((comment, commentIndex) => `
                                <div class="bg-gray-50 rounded p-2 text-sm cursor-pointer comment-item" onclick="toggleCommentTimestamp('${photo.id}', ${commentIndex})">
                                    <p class="text-gray-700 break-words" style="white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word;">${comment.text} <span class="comment-timestamp hidden text-xs text-gray-500 italic ml-2" style="font-size: 10px;" id="timestamp-${photo.id}-${commentIndex}">${new Date(comment.timestamp).toLocaleString('vi-VN')}</span></p>
                                </div>
                            `).join('')}
                        </div>
                        
                        <!-- Add Comment Form - Messenger Style -->
                        <div class="messenger-comment-box w-full mb-1.5">
                            <div class="comment-input-container w-full">
                                <textarea class="comment-input w-full" 
                                          placeholder="Viết bình luận..." 
                                          id="comment-input-${photo.id}"
                                          rows="1"
                                          onkeydown="handleCommentKeyDown(event, '${photo.id}')"
                                          oninput="autoResizeTextarea(this)"
                                          onfocus="focusCommentInput('${photo.id}')"
                                          onblur="blurCommentInput('${photo.id}')"></textarea>
                                <button class="send-button" 
                                        id="send-btn-${photo.id}"
                                        onclick="addComment('${photo.id}')"
                                        disabled>
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M16.6915026,12.4744748 L3.50612381,13.2599618 C3.19218622,13.2599618 3.03521743,13.4170592 3.03521743,13.5741566 L1.15159189,20.0151496 C0.8376543,20.8006365 0.99,21.89 1.77946707,22.52 C2.41,22.99 3.50612381,23.1 4.13399899,22.8429026 L21.714504,14.0454487 C22.6563168,13.5741566 23.1272231,12.6315722 22.9702544,11.6889879 C22.8132856,10.7464035 22.0274026,10.0151496 21.0855898,10.0151496 L4.13399899,1.21769050 C3.50612381,0.960492931 2.41,1.07 1.77946707,1.54 C0.99,2.17 0.8376543,3.26 1.15159189,4.04548596 L3.03521743,10.4864789 C3.03521743,10.6435763 3.19218622,10.8006737 3.50612381,10.8006737 L16.6915026,11.5861607 C16.6915026,11.5861607 16.6915026,12.4744748 16.6915026,12.4744748 Z"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            return card;
        }

        // Hàm xử lý lỗi khi tải thumbnail
        function handleThumbnailError(img, directUrl, fallbackUrl) {
            if (img.src !== directUrl) {
                img.src = directUrl;
            } else if (img.src !== fallbackUrl) {
                img.src = fallbackUrl;
            } else {
                img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjQwMCIgdmlld0JveD0iMCAwIDQwMCA0MDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI0MDAiIGhlaWdodD0iNDAwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0yMDAgMTUwQzE4Ni4xOSAxNTAgMTc1IDE2MS4xOSAxNzUgMTc1QzE3NSAxODguODEgMTg2LjE5IDIwMCAyMDAgMjAwQzIxMy44MSAyMDAgMjI1IDE4OC44MSAyMjUgMTc1QzIyNSAxNjEuMTkgMjEzLjgxIDE1MCAyMDAgMTUwWiIgZmlsbD0iIzlDQTNBRiIvPgo8cGF0aCBkPSJNMTI1IDEyNUMxMTguMDk2IDEyNSAxMTIuNSAxMzAuNTk2IDExMi41IDEzNy41VjI2Mi41QzExMi41IDI2OS40MDQgMTE4LjA5NiAyNzUgMTI1IDI3NUgyNzVDMjgxLjkwNCAyNzUgMjg3LjUgMjY5LjQwNCAyODcuNSAyNjIuNVYxMzcuNUMyODcuNSAxMzAuNTk2IDI4MS45MDQgMTI1IDI3NSAxMjVIMTI1WiIgc3Ryb2tlPSIjOUNBM0FGIiBzdHJva2Utd2lkdGg9IjEwIiBmaWxsPSJub25lIi8+Cjwvc3ZnPgo=';
                img.alt = 'Không thể tải ảnh';
            }
        }

        // Hàm cập nhật điều khiển phân trang
        function updatePaginationControls() {
            const paginationControls = document.getElementById('paginationControls');
            const currentRange = document.getElementById('currentRange');
            const totalPhotos = document.getElementById('totalPhotos');
            const currentPageDisplay = document.getElementById('currentPageDisplay');
            const totalPagesDisplay = document.getElementById('totalPagesDisplay');
            const pageNumbers = document.getElementById('pageNumbers');
            
            if (totalPages <= 1) {
                paginationControls.classList.add('hidden');
                return;
            }
            
            paginationControls.classList.remove('hidden');
            
            // Cập nhật thông tin hiển thị
            const startIndex = (currentPage - 1) * PHOTOS_PER_PAGE + 1;
            const endIndex = Math.min(currentPage * PHOTOS_PER_PAGE, allPhotosData.length);
            
            currentRange.textContent = `${startIndex}-${endIndex}`;
            totalPhotos.textContent = allPhotosData.length;
            currentPageDisplay.textContent = currentPage;
            totalPagesDisplay.textContent = totalPages;
            
            // Cập nhật trạng thái nút
            const firstPageBtn = document.getElementById('firstPageBtn');
            const prevPageBtn = document.getElementById('prevPageBtn');
            const nextPageBtn = document.getElementById('nextPageBtn');
            const lastPageBtn = document.getElementById('lastPageBtn');
            
            firstPageBtn.disabled = currentPage === 1;
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages;
            lastPageBtn.disabled = currentPage === totalPages;
            
            // Tạo số trang
            pageNumbers.innerHTML = '';
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            // Điều chỉnh startPage nếu endPage đã đạt tối đa
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            // Thêm dấu ... nếu cần
            if (startPage > 1) {
                const firstPageNumber = createPageButton(1);
                pageNumbers.appendChild(firstPageNumber);
                
                if (startPage > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.className = 'px-2 py-1 text-gray-500';
                    pageNumbers.appendChild(ellipsis);
                }
            }
            
            // Thêm các số trang
            for (let i = startPage; i <= endPage; i++) {
                const pageButton = createPageButton(i);
                pageNumbers.appendChild(pageButton);
            }
            
            // Thêm dấu ... cuối nếu cần
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.className = 'px-2 py-1 text-gray-500';
                    pageNumbers.appendChild(ellipsis);
                }
                
                const lastPageNumber = createPageButton(totalPages);
                pageNumbers.appendChild(lastPageNumber);
            }
        }
        
        // Hàm tạo nút trang
        function createPageButton(pageNum) {
            const button = document.createElement('button');
            button.textContent = pageNum;
            button.className = `px-3 py-2 text-sm border rounded-lg transition-colors ${
                pageNum === currentPage 
                    ? 'bg-pink-500 text-white border-pink-500' 
                    : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50'
            }`;
            
            button.addEventListener('click', () => {
                if (pageNum !== currentPage) {
                    displayPhotosPage(pageNum);
                    // Cuộn lên đầu danh sách ảnh
                    document.getElementById('photosGrid').scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }
            });
            
            return button;
        }

        // Hàm mở modal ảnh với nhiều URL dự phòng
        function openPhotoModal(photoId, imageName, index, fromEventModal = false) {
            const modal = new bootstrap.Modal(document.getElementById('photoModal'));
            const modalImage = document.getElementById('modalImage');
            const modalTitle = document.getElementById('photoModalTitle');
            const modalDescription = document.getElementById('photoModalDescription');
            const loadingSpinner = document.getElementById('imageLoadingSpinner');
            const errorMessage = document.getElementById('imageErrorMessage');
            
            // Nếu mở từ modal sự kiện, đóng modal sự kiện trước
            if (fromEventModal && eventPhotosModalInstance) {
                eventPhotosModalInstance.hide();
            }
            
            // Lưu chỉ số ảnh hiện tại
            currentPhotoIndex = index;
            
            // Reset trạng thái
            modalImage.classList.add('d-none');
            loadingSpinner.classList.remove('d-none');
            errorMessage.classList.add('d-none');
            
            // Cập nhật thông tin dựa trên nguồn
            const totalPhotos = isViewingEventPhotos ? currentEventPhotos.length : allPhotosData.length;
            const displayIndex = isViewingEventPhotos ? index + 1 : 
                                 allPhotosData.findIndex(p => p.id === photoId) + 1;
            const displayTotal = isViewingEventPhotos ? totalPhotos : allPhotosData.length;
            
            modalTitle.textContent = `📷 Ảnh ${displayIndex} / ${displayTotal}${isViewingEventPhotos ? ' (Sự kiện)' : ''}`;
            modalDescription.textContent = `💕 ${imageName}`;
            
            // Cập nhật nút điều hướng
            updateNavigationButtons();
            
            // Danh sách URL để thử theo thứ tự ưu tiên
            const imageUrls = [
                `https://drive.google.com/uc?export=view&id=${photoId}`,
                `https://lh3.googleusercontent.com/d/${photoId}=w1200-h1200`,
                `https://drive.google.com/thumbnail?id=${photoId}&sz=w1200-h1200`,
                `https://drive.google.com/file/d/${photoId}/view`
            ];
            
            // Thử tải ảnh với URL đầu tiên
            tryLoadImage(modalImage, imageUrls, 0, imageName);
            
            modal.show();
        }

        // Hàm thử tải ảnh với nhiều URL
        function tryLoadImage(imgElement, urls, currentIndex, imageName) {
            if (currentIndex >= urls.length) {
                // Đã thử hết tất cả URL, hiển thị lỗi
                handleImageError();
                return;
            }
            
            const img = new Image();
            img.onload = function() {
                imgElement.src = urls[currentIndex];
                imgElement.alt = imageName;
                handleImageLoad();
            };
            
            img.onerror = function() {
                // Thử URL tiếp theo
                tryLoadImage(imgElement, urls, currentIndex + 1, imageName);
            };
            
            // Bắt đầu tải ảnh
            img.src = urls[currentIndex];
        }

        // Biến lưu trữ chỉ số ảnh hiện tại trong modal
        let currentPhotoIndex = 0;
        let currentEventPhotos = []; // Mảng ảnh của sự kiện hiện tại
        let isViewingEventPhotos = false; // Flag để biết đang xem ảnh của sự kiện
        let eventPhotosModalInstance = null; // Lưu instance của modal sự kiện

        // Hàm điều hướng ảnh trong modal
        function navigatePhoto(direction) {
            const photosToNavigate = isViewingEventPhotos ? currentEventPhotos : allPhotosData;
            
            if (!photosToNavigate || photosToNavigate.length === 0) return;
            
            currentPhotoIndex += direction;
            
            // Xử lý vòng lặp
            if (currentPhotoIndex < 0) {
                currentPhotoIndex = photosToNavigate.length - 1;
            } else if (currentPhotoIndex >= photosToNavigate.length) {
                currentPhotoIndex = 0;
            }
            
            // Nếu đang xem tất cả ảnh (không phải ảnh sự kiện), kiểm tra phân trang
            if (!isViewingEventPhotos) {
                const currentPageStart = (currentPage - 1) * PHOTOS_PER_PAGE;
                const currentPageEnd = currentPageStart + PHOTOS_PER_PAGE;
                
                // Nếu ảnh không trong trang hiện tại, chuyển đến trang chứa ảnh đó
                if (currentPhotoIndex < currentPageStart || currentPhotoIndex >= currentPageEnd) {
                    const targetPage = Math.floor(currentPhotoIndex / PHOTOS_PER_PAGE) + 1;
                    displayPhotosPage(targetPage);
                }
            }
            
            // Cập nhật nút điều hướng
            updateNavigationButtons();
            
            // Tải ảnh mới
            const photo = photosToNavigate[currentPhotoIndex];
            const modalImage = document.getElementById('modalImage');
            const modalTitle = document.getElementById('photoModalTitle');
            const modalDescription = document.getElementById('photoModalDescription');
            const loadingSpinner = document.getElementById('imageLoadingSpinner');
            const errorMessage = document.getElementById('imageErrorMessage');
            
            // Reset trạng thái
            modalImage.classList.add('d-none');
            loadingSpinner.classList.remove('d-none');
            errorMessage.classList.add('d-none');
            
            // Cập nhật thông tin
            const totalPhotos = photosToNavigate.length;
            const displayIndex = isViewingEventPhotos ? currentPhotoIndex + 1 : 
                                 allPhotosData.findIndex(p => p.id === photo.id) + 1;
            const displayTotal = isViewingEventPhotos ? totalPhotos : allPhotosData.length;
            
            modalTitle.textContent = `📷 Ảnh ${displayIndex} / ${displayTotal}${isViewingEventPhotos ? ' (Sự kiện)' : ''}`;
            modalDescription.textContent = `💕 ${photo.name}`;
            
            // Danh sách URL để thử theo thứ tự ưu tiên
            const imageUrls = [
                `https://drive.google.com/uc?export=view&id=${photo.id}`,
                `https://lh3.googleusercontent.com/d/${photo.id}=w1200-h1200`,
                `https://drive.google.com/thumbnail?id=${photo.id}&sz=w1200-h1200`,
                `https://drive.google.com/file/d/${photo.id}/view`
            ];
            
            // Thử tải ảnh với URL đầu tiên
            tryLoadImage(modalImage, imageUrls, 0, photo.name);
        }

        // Hàm cập nhật trạng thái nút điều hướng
        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevPhotoBtn');
            const nextBtn = document.getElementById('nextPhotoBtn');
            
            if (allPhotosData.length <= 1) {
                prevBtn.style.display = 'none';
                nextBtn.style.display = 'none';
            } else {
                prevBtn.style.display = 'flex';
                nextBtn.style.display = 'flex';
            }
        }

        // Hàm xử lý khi ảnh tải thành công
        function handleImageLoad() {
            const modalImage = document.getElementById('modalImage');
            const loadingSpinner = document.getElementById('imageLoadingSpinner');
            const errorMessage = document.getElementById('imageErrorMessage');
            
            loadingSpinner.classList.add('d-none');
            errorMessage.classList.add('d-none');
            modalImage.classList.remove('d-none');
        }

        // Hàm xử lý khi ảnh tải thất bại
        function handleImageError() {
            const modalImage = document.getElementById('modalImage');
            const loadingSpinner = document.getElementById('imageLoadingSpinner');
            const errorMessage = document.getElementById('imageErrorMessage');
            
            loadingSpinner.classList.add('d-none');
            modalImage.classList.add('d-none');
            errorMessage.classList.remove('d-none');
        }

        // Hàm đóng modal ảnh và quay lại modal sự kiện nếu cần
        function closePhotoModal() {
            const photoModal = bootstrap.Modal.getInstance(document.getElementById('photoModal'));
            if (photoModal) {
                photoModal.hide();
            }
            
            // Nếu đang xem ảnh từ sự kiện, mở lại modal sự kiện
            if (isViewingEventPhotos && eventPhotosModalInstance) {
                setTimeout(() => {
                    eventPhotosModalInstance.show();
                }, 300); // Delay để modal ảnh đóng hoàn toàn trước
            }
            
            // Reset flag khi đóng modal
            if (!isViewingEventPhotos) {
                currentEventPhotos = [];
            }
        }

        // Hàm hiển thị modal chọn sự kiện cho ảnh
        async function showEventSelectionModal(photoId) {
            selectedPhotoId = photoId;
            selectedEventsForPhoto.clear();
            
            const modal = new bootstrap.Modal(document.getElementById('eventSelectionModal'));
            const loadingSpinner = document.getElementById('eventSelection-loading-spinner');
            const eventList = document.getElementById('eventSelectionList');
            const emptyState = document.getElementById('eventSelection-emptyState');
            const selectedPhotoInfo = document.getElementById('selectedPhotoInfo');
            const saveBtn = document.getElementById('savePhotoToEventsBtn');
            
            // Hiển thị thông tin ảnh được chọn
            const photo = allPhotosData.find(p => p.id === photoId);
            if (photo) {
                const thumbnailUrl = `https://drive.google.com/thumbnail?id=${photoId}&sz=w200-h200`;
                selectedPhotoInfo.innerHTML = `
                    <div class="d-flex align-items-center">
                        <img src="${thumbnailUrl}" alt="${photo.name}" class="rounded me-3" style="width: 60px; height: 60px; object-fit: cover;">
                        <div>
                            <h6 class="mb-1">${photo.name}</h6>
                            <small class="text-muted">ID: ${photoId}</small>
                        </div>
                    </div>
                `;
            }
            
            // Reset UI
            loadingSpinner.classList.remove('hidden');
            eventList.innerHTML = '';
            emptyState.classList.add('hidden');
            saveBtn.disabled = true;
            
            try {
                // Tải danh sách sự kiện
                const { content: events } = await readNotes();
                
                loadingSpinner.classList.add('hidden');
                
                if (!events || events.length === 0) {
                    emptyState.classList.remove('hidden');
                    modal.show();
                    return;
                }
                
                // Hiển thị danh sách sự kiện
                events.forEach((event, index) => {
                    const day = String(event.day).padStart(2, '0');
                    const month = String(event.month).padStart(2, '0');
                    const formattedDate = `${day}/${month}/${event.year}`;
                    const eventContent = event.contdetl || 'Không có nội dung';
                    const eventColor = event.colorClass || 'bg-pink-500';
                    const eventIcon = event.icon || '📅';
                    
                    // Kiểm tra xem ảnh đã có trong sự kiện này chưa
                    const isPhotoInEvent = event.image && Array.isArray(event.image) && event.image.includes(photoId);
                    
                    const eventItem = document.createElement('div');
                    eventItem.className = 'border rounded p-3 hover:bg-gray-50 transition-colors';
                    eventItem.innerHTML = `
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="${index}" id="event-${index}" ${isPhotoInEvent ? 'checked' : ''}>
                            <label class="form-check-label w-100 cursor-pointer" for="event-${index}">
                                <div class="d-flex align-items-center">
                                    <div class="me-3">
                                        <div class="w-3 h-3 ${eventColor} rounded-circle d-inline-block" style="width: 12px; height: 12px;"></div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <div class="fw-medium">${eventIcon} ${eventContent}</div>
                                        <small class="text-muted">${formattedDate}</small>
                                    </div>
                                    ${isPhotoInEvent ? '<span class="badge bg-success">Đã có ảnh</span>' : ''}
                                </div>
                            </label>
                        </div>
                    `;
                    
                    // Thêm event listener cho checkbox
                    const checkbox = eventItem.querySelector('input[type="checkbox"]');
                    checkbox.addEventListener('change', () => {
                        if (checkbox.checked) {
                            selectedEventsForPhoto.add(index);
                        } else {
                            selectedEventsForPhoto.delete(index);
                        }
                        
                        // Cập nhật trạng thái nút lưu
                        updateSaveButtonState();
                    });
                    
                    // Nếu ảnh đã có trong sự kiện, thêm vào set
                    if (isPhotoInEvent) {
                        selectedEventsForPhoto.add(index);
                    }
                    
                    eventList.appendChild(eventItem);
                });
                
                // Cập nhật trạng thái nút lưu
                updateSaveButtonState();
                
            } catch (error) {
                console.error('Lỗi khi tải danh sách sự kiện:', error);
                loadingSpinner.classList.add('hidden');
                eventList.innerHTML = '<div class="alert alert-danger">Không thể tải danh sách sự kiện</div>';
            }
            
            modal.show();
        }

        // Hàm cập nhật trạng thái nút lưu
        function updateSaveButtonState() {
            const saveBtn = document.getElementById('savePhotoToEventsBtn');
            const hasChanges = selectedEventsForPhoto.size > 0;
            saveBtn.disabled = !hasChanges;
        }

        // Hàm lưu ảnh vào các sự kiện được chọn
        async function savePhotoToEvents() {
            const saveBtn = document.getElementById('savePhotoToEventsBtn');
            const saveSpinner = document.getElementById('savePhotoSpinner');
            
            if (!selectedPhotoId || selectedEventsForPhoto.size === 0) {
                showMessage('Vui lòng chọn ít nhất một sự kiện', 'error');
                return;
            }
            
            // Hiển thị loading
            saveBtn.disabled = true;
            saveSpinner.classList.remove('d-none');
            
            try {
                // Đọc dữ liệu sự kiện hiện tại
                const { content: currentEvents, sha } = await readNotes();
                
                // Cập nhật các sự kiện được chọn
                selectedEventsForPhoto.forEach(eventIndex => {
                    const event = currentEvents[eventIndex];
                    if (event) {
                        // Khởi tạo mảng image nếu chưa có
                        if (!event.image) {
                            event.image = [];
                        }
                        
                        // Thêm ID ảnh nếu chưa có (đảm bảo duy nhất)
                        if (!event.image.includes(selectedPhotoId)) {
                            event.image.push(selectedPhotoId);
                        }
                    }
                });
                
                // Xóa ảnh khỏi các sự kiện không được chọn
                currentEvents.forEach((event, index) => {
                    if (event.image && Array.isArray(event.image) && !selectedEventsForPhoto.has(index)) {
                        const photoIndex = event.image.indexOf(selectedPhotoId);
                        if (photoIndex > -1) {
                            event.image.splice(photoIndex, 1);
                        }
                    }
                });
                
                // Lưu lại dữ liệu
                await writeNotes(currentEvents, sha);
                
                // Cập nhật giao diện
                displayEvents(currentEvents);
                if (window.calendarInstance) {
                    window.calendarInstance.updateEventsFromData(currentEvents);
                }
                
                // Đóng modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('eventSelectionModal'));
                modal.hide();
                
                showMessage('✅ Đã cập nhật ảnh cho các sự kiện thành công!', 'success');
                
                // Thêm log
                const selectedEventCount = selectedEventsForPhoto.size;
                addLog('Cập nhật ảnh cho sự kiện', `Ảnh ID: ${selectedPhotoId}, ${selectedEventCount} sự kiện`);
                
            } catch (error) {
                console.error('Lỗi khi lưu ảnh vào sự kiện:', error);
                showMessage('❌ Lỗi khi cập nhật ảnh cho sự kiện. Vui lòng thử lại.', 'error');
            } finally {
                // Ẩn loading
                saveBtn.disabled = false;
                saveSpinner.classList.add('d-none');
            }
        }

        // Hàm hiển thị ảnh của sự kiện
        async function loadEventPhotos(eventIndex) {
            try {
                // Đọc dữ liệu sự kiện
                const { content: events } = await readNotes();
                
                if (!events || !events[eventIndex]) {
                    showMessage('Không tìm thấy sự kiện', 'error');
                    return;
                }
                
                const event = events[eventIndex];
                const modal = new bootstrap.Modal(document.getElementById('eventPhotosModal'));
                const loadingSpinner = document.getElementById('eventPhotos-loading-spinner');
                const photosGrid = document.getElementById('eventPhotosGrid');
                const emptyState = document.getElementById('eventPhotos-emptyState');
                const eventInfo = document.getElementById('eventPhotosInfo');
                
                // Lưu instance modal để có thể mở lại sau
                eventPhotosModalInstance = modal;
                
                // Hiển thị thông tin sự kiện
                const day = String(event.day).padStart(2, '0');
                const month = String(event.month).padStart(2, '0');
                const formattedDate = `${day}/${month}/${event.year}`;
                const eventContent = event.contdetl || 'Không có nội dung';
                const eventIcon = event.icon || '📅';
                const eventColor = event.colorClass || 'bg-pink-500';
                
                eventInfo.innerHTML = `
                    <div class="d-flex align-items-center p-3 bg-light rounded">
                        <div class="me-3">
                            <div class="w-4 h-4 ${eventColor} rounded-circle d-inline-block" style="width: 16px; height: 16px;"></div>
                        </div>
                        <div>
                            <h6 class="mb-1">${eventIcon} ${eventContent}</h6>
                            <small class="text-muted">${formattedDate}</small>
                        </div>
                    </div>
                `;
                
                // Reset UI
                loadingSpinner.classList.remove('hidden');
                photosGrid.innerHTML = '';
                emptyState.classList.add('hidden');
                
                // Kiểm tra xem sự kiện có ảnh không
                if (!event.image || !Array.isArray(event.image) || event.image.length === 0) {
                    loadingSpinner.classList.add('hidden');
                    emptyState.classList.remove('hidden');
                    modal.show();
                    return;
                }
                
                // Tải thông tin ảnh từ allPhotosData
                const eventPhotos = [];
                event.image.forEach(photoId => {
                    const photo = allPhotosData.find(p => p.id === photoId);
                    if (photo) {
                        eventPhotos.push(photo);
                    }
                });
                
                // Lưu danh sách ảnh sự kiện và đặt flag
                currentEventPhotos = eventPhotos;
                isViewingEventPhotos = true;
                
                loadingSpinner.classList.add('hidden');
                
                if (eventPhotos.length === 0) {
                    emptyState.classList.remove('hidden');
                    modal.show();
                    return;
                }
                
                // Hiển thị ảnh
                eventPhotos.forEach((photo, index) => {
                    const thumbnailUrl = `https://drive.google.com/thumbnail?id=${photo.id}&sz=w300-h300`;
                    const directUrl = `https://drive.google.com/uc?export=view&id=${photo.id}`;
                    const fallbackUrl = `https://lh3.googleusercontent.com/d/${photo.id}=w300-h300`;
                    
                    const photoCard = document.createElement('div');
                    photoCard.className = 'bg-white rounded-lg shadow-md overflow-hidden cursor-pointer';
                    photoCard.innerHTML = `
                        <div class="relative">
                            <img src="${thumbnailUrl}" alt="${photo.name}" 
                                 class="w-full h-48 object-cover"
                                 onclick="openPhotoModal('${photo.id}', '${photo.name}', ${index}, true)"
                                 onerror="handleThumbnailError(this, '${directUrl}', '${fallbackUrl}')"
                                 loading="lazy">
                            <div class="absolute top-2 right-2 bg-black bg-opacity-50 text-white px-2 py-1 rounded text-xs">
                                ${index + 1}/${eventPhotos.length}
                            </div>
                        </div>
                        <div class="p-3">
                            <p class="text-sm text-gray-700 truncate" title="${photo.name}">${photo.name}</p>
                        </div>
                    `;
                    
                    photosGrid.appendChild(photoCard);
                });
                
                modal.show();
                
                // Thêm log
                addLog('Xem ảnh của sự kiện', `${eventContent}: ${eventPhotos.length} ảnh`);
                
            } catch (error) {
                console.error('Lỗi khi tải ảnh của sự kiện:', error);
                showMessage('❌ Không thể tải ảnh của sự kiện. Vui lòng thử lại.', 'error');
            }
        }

        // Hàm xử lý khi nhấn phím trong ô comment
        function handleCommentKeyDown(event, photoId) {
            if (event.key === 'Enter' && event.ctrlKey) {
                event.preventDefault();
                addComment(photoId);
            }
        }

        // Hàm tự động mở rộng textarea
        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
            
            // Cập nhật trạng thái nút gửi
            const photoId = textarea.id.replace('comment-input-', '');
            const sendButton = document.getElementById(`send-btn-${photoId}`);
            const hasContent = textarea.value.trim().length > 0;
            
            if (sendButton) {
                sendButton.disabled = !hasContent;
            }
        }
        
        // Hàm xử lý khi focus vào input
        function focusCommentInput(photoId) {
            const container = document.querySelector(`#comment-input-${photoId}`).closest('.comment-input-container');
            if (container) {
                container.classList.add('focused');
            }
        }
        
        // Hàm xử lý khi blur khỏi input
        function blurCommentInput(photoId) {
            const container = document.querySelector(`#comment-input-${photoId}`).closest('.comment-input-container');
            if (container) {
                setTimeout(() => {
                    container.classList.remove('focused');
                }, 150);
            }
        }

        // Hàm toggle hiển thị bình luận
        function toggleComments(photoId) {
            const commentsSection = document.getElementById(`comments-section-${photoId}`);
            const commentBtn = document.getElementById(`comment-btn-${photoId}`);
            const buttonAction = document.getElementById(`button-action-${photoId}`);
            
            if (commentsSection.classList.contains('hidden')) {
                commentsSection.classList.remove('hidden');
                commentBtn.classList.add('bg-blue-50');
                commentBtn.querySelector('i').classList.add('text-blue-600');
                commentBtn.querySelector('span').classList.add('text-blue-600');
                
                // Hiện đường kẻ dưới khi mở bình luận
                if (buttonAction) {
                    buttonAction.classList.add('border-b');
                }
                
                // Focus vào ô nhập bình luận
                const commentInput = document.getElementById(`comment-input-${photoId}`);
                setTimeout(() => {
                    commentInput.focus();
                }, 100);
            } else {
                commentsSection.classList.add('hidden');
                commentBtn.classList.remove('bg-blue-50');
                commentBtn.querySelector('i').classList.remove('text-blue-600');
                commentBtn.querySelector('span').classList.remove('text-blue-600');
                
                // Ẩn đường kẻ dưới khi đóng bình luận
                if (buttonAction) {
                    buttonAction.classList.remove('border-b');
                }
            }
        }

        // Hàm chia sẻ ảnh
        async function sharePhoto(photoId, photoName) {
            try {
                const directUrl = `https://drive.google.com/uc?export=view&id=${photoId}`;
                
                // Thử copy link vào clipboard
                try {
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        await navigator.clipboard.writeText(directUrl);
                        showMessage('📋 Đã copy link ảnh vào clipboard!', 'success');
                    } else {
                        // Fallback cho trình duyệt không hỗ trợ clipboard API
                        const textArea = document.createElement('textarea');
                        textArea.value = directUrl;
                        textArea.style.position = 'fixed';
                        textArea.style.left = '-999999px';
                        textArea.style.top = '-999999px';
                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select();
                        
                        try {
                            document.execCommand('copy');
                            showMessage('📋 Đã copy link ảnh vào clipboard!', 'success');
                        } catch (err) {
                            console.error('Fallback copy failed:', err);
                            showMessage(`🔗 Link ảnh: ${directUrl}`, 'success');
                        }
                        
                        document.body.removeChild(textArea);
                    }
                } catch (clipboardError) {
                    console.error('Clipboard error:', clipboardError);
                    showMessage(`🔗 Link ảnh: ${directUrl}`, 'success');
                }
                
                // Thử mở chức năng share của thiết bị nếu có
                if (navigator.share && navigator.canShare && navigator.canShare({ url: directUrl })) {
                    try {
                        await navigator.share({
                            title: `💕 ${photoName}`,
                            text: 'Chia sẻ khoảnh khắc đáng yêu',
                            url: directUrl
                        });
                    } catch (shareError) {
                        // Người dùng đã hủy share hoặc có lỗi
                        console.log('Share cancelled or failed:', shareError);
                    }
                }
                
            } catch (error) {
                console.error('Lỗi khi chia sẻ ảnh:', error);
                showMessage('❌ Không thể chia sẻ ảnh. Vui lòng thử lại.', 'error');
            }
        }

        // Hàm toggle reaction (chỉ tim)
        async function toggleReaction(photoId, reactionType) {
            try {
                // Tìm tên file ảnh từ photoId trong allPhotosData
                const photo = allPhotosData.find(p => p.id === photoId);
                const imageName = photo ? photo.name : photoId;
                
                // Đọc dữ liệu comments hiện tại
                const { content: currentComments, sha } = await readComments();
                
                // Tìm hoặc tạo entry cho ảnh này
                let imageEntry = currentComments.find(entry => entry.ID_IMG === imageName);
                
                if (!imageEntry) {
                    // Tạo entry mới nếu chưa có
                    imageEntry = {
                        ID_IMG: imageName,
                        count_tim: 0,
                        comments: []
                    };
                    currentComments.push(imageEntry);
                }
                
                // Tăng số lượng tim
                if (reactionType === 'tim') {
                    imageEntry.count_tim = (imageEntry.count_tim || 0) + 1;
                }
                
                // Lưu vào GitHub
                await writeComments(currentComments, sha);
                
                // Cập nhật dữ liệu local
                if (!reactionsData[imageName]) {
                    reactionsData[imageName] = { count_tim: 0 };
                }
                
                if (reactionType === 'tim') {
                    reactionsData[imageName].count_tim = imageEntry.count_tim;
                }
                
                // Cập nhật giao diện
                const countElement = document.getElementById(`heart-count-${photoId}`);
                if (countElement) {
                    countElement.textContent = imageEntry.count_tim;
                }
                
                // Cập nhật icon tim - chỉ hiện đỏ khi vừa ấn
                const heartIcon = document.getElementById(`heart-icon-${photoId}`);
                if (heartIcon) {
                    // Hiện tim đỏ tạm thời khi ấn
                    heartIcon.className = 'bi bi-heart-fill text-red-500 mr-1 text-sm';
                    
                    // Sau 1 giây trở về tim trắng
                    setTimeout(() => {
                        heartIcon.className = 'bi bi-heart text-gray-600 mr-1 text-sm';
                    }, 1000);
                }
                
                // Thêm hiệu ứng animation
                const buttonElement = document.getElementById(`heart-btn-${photoId}`);
                if (buttonElement) {
                    buttonElement.classList.add('animate-pulse');
                    setTimeout(() => {
                        buttonElement.classList.remove('animate-pulse');
                    }, 500);
                }
                
                // showMessage('💖 +1!', 'success');
                
            } catch (error) {
                console.error('Lỗi khi cập nhật reaction:', error);
                showMessage('Lỗi khi cập nhật reaction. Vui lòng thử lại.', 'error');
            }
        }

        // Hàm thêm comment
        async function addComment(photoId) {
            const input = document.getElementById(`comment-input-${photoId}`);
            const sendButton = document.getElementById(`send-btn-${photoId}`);
            const commentText = input.value.trim();
            
            if (!commentText) {
                return;
            }
            
            // Thêm hiệu ứng gửi
            sendButton.classList.add('sending');
            sendButton.disabled = true;
            
            try {
                // Tìm tên file ảnh từ photoId trong allPhotosData
                const photo = allPhotosData.find(p => p.id === photoId);
                const imageName = photo ? photo.name : photoId;
                
                // Đọc dữ liệu comments hiện tại
                const { content: currentComments, sha } = await readComments();
                
                // Tìm hoặc tạo entry cho ảnh này
                let imageEntry = currentComments.find(entry => entry.ID_IMG === imageName);
                
                if (!imageEntry) {
                    // Tạo entry mới nếu chưa có
                    imageEntry = {
                        ID_IMG: imageName,
                        count_tim: 0,
                        comments: []
                    };
                    currentComments.push(imageEntry);
                }
                
                // Thêm comment mới vào mảng comments
                const newComment = {
                    comment: commentText,
                    date_input: new Date().toISOString()
                };
                
                if (!imageEntry.comments) {
                    imageEntry.comments = [];
                }
                imageEntry.comments.push(newComment);
                
                // Lưu vào GitHub
                await writeComments(currentComments, sha);
                
                // Cập nhật dữ liệu local
                if (!commentsData[imageName]) {
                    commentsData[imageName] = [];
                }
                commentsData[imageName].push({
                    text: commentText,
                    timestamp: new Date().toISOString()
                });
                
                // Cập nhật giao diện
                const commentsContainer = document.getElementById(`comments-${photoId}`);
                const commentElement = document.createElement('div');
                const commentIndex = commentsData[imageName].length - 1;
                commentElement.className = 'bg-gray-50 rounded p-2 text-sm cursor-pointer comment-item mb-1';
                commentElement.onclick = () => toggleCommentTimestamp(photoId, commentIndex);
                commentElement.innerHTML = `
                    <p class="text-gray-700 break-words" style="white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word;">${commentText} <span class="comment-timestamp hidden text-xs text-gray-500 italic ml-2" style="font-size: 10px;" id="timestamp-${photoId}-${commentIndex}">${new Date().toLocaleString('vi-VN')}</span></p>
                `;
                commentsContainer.appendChild(commentElement);
                
                // Cuộn xuống comment mới
                commentsContainer.scrollTop = commentsContainer.scrollHeight;
                
                // Xóa nội dung input và reset chiều cao
                input.value = '';
                input.style.height = 'auto';
                
                // Cập nhật số lượng comments trong giao diện
                const commentCountElement = document.getElementById(`comment-count-${photoId}`);
                if (commentCountElement) {
                    commentCountElement.textContent = commentsData[imageName].length;
                }
                
                // showMessage('Bình luận đã được thêm! 💕', 'success');
                
            } catch (error) {
                console.error('Lỗi khi thêm bình luận:', error);
                showMessage('Lỗi khi thêm bình luận. Vui lòng thử lại.', 'error');
            } finally {
                // Xóa hiệu ứng gửi
                setTimeout(() => {
                    sendButton.classList.remove('sending');
                    sendButton.disabled = true; // Vẫn disabled vì input đã trống
                }, 300);
            }
        }

        // Hàm toggle hiển thị timestamp của bình luận
        function toggleCommentTimestamp(photoId, commentIndex) {
            const timestampElement = document.getElementById(`timestamp-${photoId}-${commentIndex}`);
            if (timestampElement) {
                timestampElement.classList.toggle('hidden');
            }
        }

        // Hàm mã hóa Base64
        function base64Encode(str) {
            return btoa(unescape(encodeURIComponent(str)));
        }

        // Hàm giải mã Base64
        function base64Decode(str) {
            return decodeURIComponent(escape(atob(str)));
        }

        // Hàm ghi dữ liệu vào file
        async function writeNotes(notes, sha) {
            const content = JSON.stringify(notes, null, 2);
            const encodedContent = base64Encode(content);

            const body = JSON.stringify({
                message: 'Thêm sự kiện mới',
                content: encodedContent,
                sha: sha
            });

            try {
                const response = await fetch(API_BASE_URL, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${PAT}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: body
                });

                const data = await response.json();
                console.log('Đã ghi sự kiện thành công lên GitHub:', data);
                return data;
            } catch (error) {
                console.error('Lỗi khi ghi sự kiện lên GitHub:', error);
                throw error;
            }
        }

        // Hàm xóa sự kiện
        async function deleteEvent(index) {
            const { content: currentEvents, sha } = await readNotes();
            const deletedEvent = currentEvents[index];
            currentEvents.splice(index, 1); // Xóa phần tử tại vị trí index
            
            await writeNotes(currentEvents, sha);
            displayEvents(currentEvents);
            showMessage('Sự kiện đã được xóa thành công! 🗑️', 'success');
            
            // Thêm log
            const eventInfo = deletedEvent ? `${deletedEvent.day}/${deletedEvent.month}/${deletedEvent.year}: ${deletedEvent.contdetl}` : 'Sự kiện không xác định';
            addLog('Xóa sự kiện', eventInfo);
        }

        // Hàm hiển thị thông báo
        function showMessage(message, type = 'success') {
            const alertClass = type === 'error' ? 'alert-danger' : 'alert-success';
            const alertHtml = `
                <div class="alert ${alertClass} alert-dismissible fade show position-fixed" style="top: 20px; right: 20px; z-index: 9999;" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', alertHtml);
            
            // Tự động ẩn sau 3 giây
            setTimeout(() => {
                const alert = document.querySelector('.alert');
                if (alert) {
                    alert.remove();
                }
            }, 3000);
        }

        // Hàm đọc và ghi comments
        async function readComments() {
            try {
                // Thêm timeout cho request
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 giây timeout
                
                const response = await fetch(COMMENTS_API_URL, {
                    headers: {
                        'Authorization': `token ${PAT}`,
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        // File chưa tồn tại, tạo file mới
                        return { content: [], sha: null };
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const content = JSON.parse(base64Decode(data.content));
                return { content, sha: data.sha };
            } catch (error) {
                console.error('Lỗi khi đọc comments từ GitHub:', error);
                return { content: [], sha: null };
            }
        }

        async function writeComments(commentsArray, sha) {
            const content = JSON.stringify(commentsArray, null, 2);
            const encodedContent = base64Encode(content);

            const body = JSON.stringify({
                message: 'Cập nhật bình luận ảnh',
                content: encodedContent,
                ...(sha && { sha: sha })
            });

            try {
                // Thêm timeout cho request
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 giây timeout
                
                const response = await fetch(COMMENTS_API_URL, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${PAT}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: body,
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);

                const data = await response.json();
                console.log('Đã ghi comments thành công lên GitHub:', data);
                return data;
            } catch (error) {
                console.error('Lỗi khi ghi comments lên GitHub:', error);
                throw error;
            }
        }





        // Biến lưu trữ sự kiện được chọn
        let selectedEventIndex = -1;
        let currentEventsData = [];

        // Hàm tính toán thông tin kỷ niệm
        function calculateAnniversary(dateStr) {
            const now = new Date();
            const [day, month, year] = dateStr.split('/').map(Number);
            const originalDate = new Date(year, month - 1, day);
            const nextAnniversary = new Date(now.getFullYear(), month - 1, day);

            // Nếu ngày kỷ niệm trong năm hiện tại đã qua, tính cho năm sau
            if (nextAnniversary < now) {
                nextAnniversary.setFullYear(now.getFullYear() + 1);
            }

            // Tính số ngày còn lại
            const diffTime = nextAnniversary.getTime() - now.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            // Tính số năm kỷ niệm đã trôi qua hoặc sắp tới
            const anniversaryYears = nextAnniversary.getFullYear() - originalDate.getFullYear();

            return {
                date: dateStr,
                daysLeft: diffDays,
                anniversaryYears: anniversaryYears
            };
        }

        // Hàm cập nhật thông tin kỷ niệm
        function updateAnniversaryInfo(events) {
            const anniversaryInfo = document.getElementById('anniversaryInfo');
            const anniversaryLabel = document.getElementById('anniversaryLabel');
            const anniversaryDate = document.getElementById('anniversaryDate');
            const daysLeft = document.getElementById('daysLeft');
            const anniversaryYears = document.getElementById('anniversaryYears');

            if (!events || events.length === 0) {
                anniversaryInfo.style.display = 'none';
                return;
            }

            // Tìm sự kiện gần nhất
            let nearestEvent = null;
            let minDays = Infinity;

            events.forEach(event => {
                if (event.day && event.month && event.year) {
                    const day = String(event.day).padStart(2, '0');
                    const month = String(event.month).padStart(2, '0');
                    const dateStr = `${day}/${month}/${event.year}`;
                    
                    const anniversary = calculateAnniversary(dateStr);
                    
                    if (anniversary.daysLeft < minDays) {
                        minDays = anniversary.daysLeft;
                        nearestEvent = {
                            ...anniversary,
                            content: event.contdetl || 'Sự kiện'
                        };
                    }
                }
            });

            if (nearestEvent) {
                anniversaryInfo.style.display = 'block';
                
                if (nearestEvent.anniversaryYears > 0) {
                    anniversaryLabel.innerHTML = `<span style="color: #dd317f;">Kỉ niệm</span> <strong style="color: #dd317f;">${nearestEvent.anniversaryYears}</strong> <span style="color: #dd317f;">năm</span> <span style="color: red;">${nearestEvent.content}</span>`;
                } else {
                    anniversaryLabel.innerHTML = `<span style="color: red;">Sự kiện:</span> <span style="color: red;">${nearestEvent.content}</span>`;
                }
                
                anniversaryDate.textContent = nearestEvent.date;
                daysLeft.textContent = `Còn ${nearestEvent.daysLeft} ngày`;
                anniversaryYears.textContent = '';
            } else {
                anniversaryInfo.style.display = 'none';
            }
        }

        // Hàm cập nhật thông tin kỷ niệm cho sự kiện được chọn
        function updateAnniversaryInfoForSelectedEvent(event) {
            const anniversaryInfo = document.getElementById('anniversaryInfo');
            const anniversaryLabel = document.getElementById('anniversaryLabel');
            const anniversaryDate = document.getElementById('anniversaryDate');
            const daysLeft = document.getElementById('daysLeft');
            const anniversaryYears = document.getElementById('anniversaryYears');

            if (!event || !event.day || !event.month || !event.year) {
                anniversaryInfo.style.display = 'none';
                return;
            }

            const day = String(event.day).padStart(2, '0');
            const month = String(event.month).padStart(2, '0');
            const dateStr = `${day}/${month}/${event.year}`;
            
            const anniversary = calculateAnniversary(dateStr);
            
            anniversaryInfo.style.display = 'block';
            
            if (anniversary.anniversaryYears > 0) {
                anniversaryLabel.innerHTML = `<span style="color: #dd317f;">Kỉ niệm</span> <strong style="color: #dd317f;">${anniversary.anniversaryYears}</strong> <span style="color: #dd317f;">năm</span> <span style="color: red;">${event.contdetl || 'Sự kiện'}</span>`;
            } else {
                anniversaryLabel.innerHTML = `<span style="color: red;">Sự kiện:</span> <span style="color: red;">${event.contdetl || 'Sự kiện'}</span>`;
            }
            
            anniversaryDate.textContent = anniversary.date;
            daysLeft.textContent = `Còn ${anniversary.daysLeft} ngày`;
            anniversaryYears.textContent = '';
        }

        // Hàm hiển thị danh sách sự kiện
        function displayEvents(events) {
            const eventsContainer = document.getElementById('eventsContainer');
            const emptyState = document.getElementById('emptyState');
            const deleteBtn = document.getElementById('deleteEventBtn');
            
            // Lưu dữ liệu sự kiện hiện tại
            currentEventsData = events;
            
            // Cập nhật sự kiện trên lịch
            if (window.calendarInstance) {
                window.calendarInstance.updateEventsFromData(events);
            }
            
            // Cập nhật thông tin kỷ niệm
            updateAnniversaryInfo(events);
            
            if (!events || events.length === 0) {
                emptyState.classList.remove('hidden');
                deleteBtn.disabled = true;
                return;
            }
            
            // Sắp xếp sự kiện theo ngày tăng dần
            const sortedEvents = [...events].sort((a, b) => {
                const dateA = new Date(a.year, a.month - 1, a.day);
                const dateB = new Date(b.year, b.month - 1, b.day);
                return dateA - dateB;
            });
            
            eventsContainer.innerHTML = '';
            
            sortedEvents.forEach((event, index) => {
                const eventElement = document.createElement('div');
                eventElement.className = 'bg-gradient-to-r from-pink-50 to-purple-50 border border-pink-200 rounded-lg p-3 cursor-pointer event-item';
                eventElement.dataset.index = index;
                
                // Định dạng ngày theo yêu cầu: day/month/year
                let formattedDate = 'Không có ngày';
                
                // Sử dụng event.day, event.month, event.year
                if (event.day && event.month && event.year) {
                    const day = String(event.day).padStart(2, '0');
                    const month = String(event.month).padStart(2, '0');
                    formattedDate = `${day}/${month}/${event.year}`;
                }
                
                // Lấy nội dung sự kiện từ event.contdetl
                const eventContent = event.contdetl || 'Không có nội dung';
                
                // Lấy màu và icon từ sự kiện
                const eventColor = event.colorClass || 'bg-pink-500';
                const eventIcon = event.icon || '📅';
                
                eventElement.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="flex-shrink-0">
                            <div class="w-3 h-3 ${eventColor} rounded-full"></div>
                        </div>
                        <div class="flex-1">
                            <p class="text-gray-800 font-medium text-sm">
                                <span class="text-pink-600 font-bold">${formattedDate}:</span> 
                                ${eventContent}
                            </p>
                        </div>
                        <div class="flex-shrink-0">
                            <button class="text-gray-500 hover:text-blue-600 transition-colors p-1 rounded hover:bg-blue-50" 
                                    onclick="loadEventPhotos(${events.findIndex(originalEvent => 
                                        originalEvent.day === event.day && 
                                        originalEvent.month === event.month && 
                                        originalEvent.year === event.year && 
                                        originalEvent.contdetl === event.contdetl
                                    )})" 
                                    title="Xem ảnh của sự kiện">
                                <i class="bi bi-image-fill text-sm"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                // Thêm sự kiện click để chọn sự kiện
                eventElement.addEventListener('click', () => {
                    // Bỏ chọn tất cả sự kiện khác
                    document.querySelectorAll('.event-item').forEach(item => {
                        item.classList.remove('border-red-400', 'bg-gradient-to-r', 'from-red-50', 'to-red-100', 'shadow-lg', 'scale-105');
                        item.classList.add('border-pink-200', 'from-pink-50', 'to-purple-50');
                    });
                    
                    // Chọn sự kiện hiện tại với hiệu ứng đẹp
                    eventElement.classList.remove('border-pink-200', 'from-pink-50', 'to-purple-50');
                    eventElement.classList.add('border-red-400', 'from-red-50', 'to-red-100', 'shadow-lg', 'scale-105');
                    
                    // Tìm chỉ số gốc của sự kiện trong mảng chưa sắp xếp
                    selectedEventIndex = events.findIndex(originalEvent => 
                        originalEvent.day === event.day && 
                        originalEvent.month === event.month && 
                        originalEvent.year === event.year && 
                        originalEvent.contdetl === event.contdetl
                    );
                    deleteBtn.disabled = false;
                    
                    // Cập nhật thông tin kỷ niệm cho sự kiện được chọn
                    updateAnniversaryInfoForSelectedEvent(event);
                    
                    // Chuyển lịch đến ngày của sự kiện được chọn (không cuộn)
                    if (event.day && event.month && event.year && window.calendarInstance) {
                        const eventDate = new Date(event.year, event.month - 1, event.day);
                        window.calendarInstance.goToDateWithoutScroll(eventDate);
                    }
                });
                
                eventsContainer.appendChild(eventElement);
            });
        }

        // Hàm đọc dữ liệu danh sách sự kiện từ file
        async function readNotes() {
            try {
                const loadingSpinner = document.getElementById('loading-spinner');
                const eventsContainer = document.getElementById('eventsContainer');
                const emptyState = document.getElementById('emptyState');
                const errorMessage = document.getElementById('errorMessage');
                
                // Hiển thị loading
                loadingSpinner.classList.remove('hidden');
                eventsContainer.innerHTML = '';
                emptyState.classList.add('hidden');
                errorMessage.classList.add('hidden');
                
                const response = await fetch(API_BASE_URL, {
                    headers: {
                        'Authorization': `token ${PAT}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Giải mã nội dung từ Base64
                const content = JSON.parse(base64Decode(data.content));
                loadingSpinner.classList.add('hidden');
                
                // Hiển thị danh sách sự kiện
                displayEvents(content);
                
                // Thêm log
                addLog('Load refresh sự kiện', `${content.length} sự kiện`);
                
                return { content, sha: data.sha };
            } catch (error) {
                console.error('Lỗi khi đọc ghi chú từ GitHub:', error);
                const loadingSpinner = document.getElementById('loading-spinner');
                const errorMessage = document.getElementById('errorMessage');
                
                loadingSpinner.classList.add('hidden');
                errorMessage.classList.remove('hidden');
                
                return { content: [], sha: null };
            }
        }

        class Calendar {
            constructor() {
                this.currentDate = new Date();
                this.today = new Date();
                this.selectedDate = null;
                this.monthNames = [
                    'Tháng 1', 'Tháng 2', 'Tháng 3', 'Tháng 4', 'Tháng 5', 'Tháng 6',
                    'Tháng 7', 'Tháng 8', 'Tháng 9', 'Tháng 10', 'Tháng 11', 'Tháng 12'
                ];
                this.dayNames = ['Chủ nhật', 'Thứ hai', 'Thứ ba', 'Thứ tư', 'Thứ năm', 'Thứ sáu', 'Thứ bảy'];
                
                // Events and anniversaries will be loaded from data
                this.events = new Set();
                this.anniversaries = new Set();
                
                this.init();
            }

            init() {
                this.render();
                this.bindEvents();
                this.updateTodayInfo();
            }

            bindEvents() {
                document.getElementById('prevMonth').addEventListener('click', () => {
                    this.currentDate.setMonth(this.currentDate.getMonth() - 1);
                    this.render();
                });

                document.getElementById('nextMonth').addEventListener('click', () => {
                    this.currentDate.setMonth(this.currentDate.getMonth() + 1);
                    this.render();
                });
            }

            render() {
                this.updateHeader();
                this.renderDays();
            }

            updateHeader() {
                const monthYear = `${this.monthNames[this.currentDate.getMonth()]} ${this.currentDate.getFullYear()}`;
                document.getElementById('monthYear').textContent = monthYear;
                
                // Debug log
                console.log('Updating calendar for:', monthYear);
            }

            renderDays() {
                const calendarDays = document.getElementById('calendarDays');
                calendarDays.innerHTML = '';

                const year = this.currentDate.getFullYear();
                const month = this.currentDate.getMonth();
                
                // Tính ngày đầu tiên của tháng
                const firstDay = new Date(year, month, 1);
                // Tính ngày bắt đầu hiển thị (Chủ nhật của tuần chứa ngày 1)
                const startDate = new Date(firstDay);
                startDate.setDate(firstDay.getDate() - firstDay.getDay());

                // Tạo 42 ô (6 tuần x 7 ngày)
                for (let i = 0; i < 42; i++) {
                    const currentDate = new Date(startDate);
                    currentDate.setDate(startDate.getDate() + i);
                    
                    // Debug log for first few dates
                    if (i < 7) {
                        console.log(`Day ${i}: ${currentDate.getDate()}/${currentDate.getMonth() + 1}/${currentDate.getFullYear()}`);
                    }
                    
                    const dayElement = this.createDayElement(currentDate, month);
                    calendarDays.appendChild(dayElement);
                }
            }

            createDayElement(date, currentMonth) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'p-1 md:p-2 text-center cursor-pointer min-h-[45px] md:min-h-[65px] lg:min-h-[70px] flex items-center justify-center relative';
                
                const dateCell = document.createElement('div');
                dateCell.className = 'date-cell';
                dateCell.textContent = date.getDate();
                
                const dateString = this.formatDate(date);
                
                // Check if it's today
                if (this.isSameDay(date, this.today)) {
                    dateCell.classList.add('today');
                }
                
                // Check if it's in current month
                if (date.getMonth() !== currentMonth) {
                    dateCell.classList.add('other-month');
                }
                
                // Check if it's weekend
                if (date.getDay() === 0 || date.getDay() === 6) {
                    dateCell.classList.add('weekend');
                }
                
                // Check for events
                if (this.events.has(dateString)) {
                    dateCell.classList.add('has-event');
                }
                
                // Check for anniversaries
                if (this.anniversaries.has(dateString)) {
                    dateCell.classList.add('anniversary');
                }
                
                // Add click event
                dateCell.addEventListener('click', () => {
                    // Remove previous selection
                    document.querySelectorAll('.date-cell.selected').forEach(cell => {
                        cell.classList.remove('selected');
                    });
                    
                    // Add selection to clicked date
                    dateCell.classList.add('selected');
                    this.selectedDate = new Date(date);
                });

                dayDiv.appendChild(dateCell);
                return dayDiv;
            }

            formatDate(date) {
                return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            }

            isSameDay(date1, date2) {
                return date1.getDate() === date2.getDate() &&
                       date1.getMonth() === date2.getMonth() &&
                       date1.getFullYear() === date2.getFullYear();
            }

            updateTodayInfo() {
                const todayString = `${this.dayNames[this.today.getDay()]}, ${this.today.getDate()}/${this.today.getMonth() + 1}/${this.today.getFullYear()}`;
                document.getElementById('todayDate').textContent = todayString;
            }

            goToToday() {
                this.currentDate = new Date();
                this.render();
            }

            goToDate(date) {
                this.currentDate = new Date(date);
                this.render();
                
                // Highlight ngày được chọn
                setTimeout(() => {
                    const targetDay = date.getDate();
                    const dateCells = document.querySelectorAll('.date-cell');
                    dateCells.forEach(cell => {
                        if (parseInt(cell.textContent) === targetDay && !cell.classList.contains('other-month')) {
                            cell.classList.add('selected');
                            cell.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    });
                }, 100);
            }

            goToDateWithoutScroll(date) {
                this.currentDate = new Date(date);
                this.render();
                
                // Highlight ngày được chọn nhưng không cuộn
                setTimeout(() => {
                    const targetDay = date.getDate();
                    const dateCells = document.querySelectorAll('.date-cell');
                    dateCells.forEach(cell => {
                        if (parseInt(cell.textContent) === targetDay && !cell.classList.contains('other-month')) {
                            cell.classList.add('selected');
                        }
                    });
                }, 100);
            }

            updateEventsFromData(events) {
                this.events.clear();
                this.anniversaries.clear();
                
                if (events && events.length > 0) {
                    events.forEach(event => {
                        if (event.day && event.month && event.year) {
                            const dateString = `${event.year}-${String(event.month).padStart(2, '0')}-${String(event.day).padStart(2, '0')}`;
                            this.events.add(dateString);
                            
                            // Kiểm tra nếu là sự kiện kỷ niệm (có thể dựa vào nội dung hoặc icon)
                            if (event.contdetl && (event.contdetl.toLowerCase().includes('kỷ niệm') || 
                                event.contdetl.toLowerCase().includes('anniversary') || 
                                event.icon === '❤️')) {
                                this.anniversaries.add(dateString);
                            }
                        }
                    });
                }
                
                // Re-render calendar to show updated events
                this.render();
            }
        }

        // Hàm khởi tạo ứng dụng sau khi tải cấu hình
        async function initializeApp() {
            try {
                console.log('🚀 Bắt đầu khởi tạo ứng dụng...');
                
                // Tải cấu hình trước
                try {
                    await loadConfig();
                    console.log('✅ Cấu hình đã được tải thành công');
                } catch (configError) {
                    console.warn('⚠️ Không thể tải cấu hình, sử dụng cấu hình mặc định');
                    
                    // Sử dụng cấu hình demo để ứng dụng vẫn có thể chạy
                    CONFIG = {
                        GITHUB_USERNAME: 'nhungcute',
                        REPO_NAME: 'LoveStory',
                        PAT1: 'ghp_a8VLpoCYQByLbUIwe',
                        PAT2: 'd3dy4hHjEpKwr3stE6T',
                        FILE_PATH: 'notes.json',
                        COMMENTS_FILE_PATH: 'mess.json',
                        PHOTOS_METADATA_FILE_PATH: 'list_file_img_ggdriver.json',
                        LOGS_FILE_PATH: 'logs.json',
                        FOLDER_ID: '1B_tpWbLwlc7mqT789-g2RO9K2pYNXVav',
                        API_KEY: 'AIzaSyDJddlVwOWA8vzdVNrcp70if4eOL30xjp0',
                        PHOTOS_PER_PAGE: 50,
                        AUTO_LOAD_METADATA: 'false'
                    };
                    
                    // Thiết lập các biến cơ bản
                    GITHUB_USERNAME = CONFIG.GITHUB_USERNAME;
                    REPO_NAME = CONFIG.REPO_NAME;
                    PAT = CONFIG.PAT1 + CONFIG.PAT2;
                    FILE_PATH = CONFIG.FILE_PATH;
                    COMMENTS_FILE_PATH = CONFIG.COMMENTS_FILE_PATH;
                    PHOTOS_METADATA_FILE_PATH = CONFIG.PHOTOS_METADATA_FILE_PATH;
                    LOGS_FILE_PATH = CONFIG.LOGS_FILE_PATH;
                    FOLDER_ID = CONFIG.FOLDER_ID;
                    API_KEY = CONFIG.API_KEY;
                    PHOTOS_PER_PAGE = CONFIG.PHOTOS_PER_PAGE;
                    
                    // Thiết lập URL API (sẽ không hoạt động nhưng không gây lỗi)
                    API_BASE_URL = `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${FILE_PATH}`;
                    COMMENTS_API_URL = `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${COMMENTS_FILE_PATH}`;
                    PHOTOS_METADATA_API_URL = `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${PHOTOS_METADATA_FILE_PATH}`;
                    LOGS_API_URL = `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${LOGS_FILE_PATH}`;
                    CONFIG_API_URL = `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/configApp.json`;
                    
                    showMessage('⚠️ Chạy ở chế độ demo - một số tính năng có thể không hoạt động', 'error');
                }
                
                // Khởi tạo calendar
                console.log('📅 Khởi tạo calendar...');
                const calendar = new Calendar();
                window.calendarInstance = calendar;
                console.log('✅ Calendar đã được khởi tạo');
                
                // Tải danh sách sự kiện khi trang được tải (với error handling)
                console.log('📋 Tải danh sách sự kiện...');
                try {
                    const { content } = await readNotes();
                    if (content && content.length > 0) {
                        calendar.updateEventsFromData(content);
                        console.log(`✅ Đã tải ${content.length} sự kiện`);
                    } else {
                        console.log('📝 Chưa có sự kiện nào');
                    }
                } catch (eventsError) {
                    console.warn('⚠️ Không thể tải sự kiện:', eventsError.message);
                }
                
                // Tải ảnh từ metadata GitHub (với error handling)
                console.log('🖼️ Tải danh sách ảnh...');
                try {
                    await loadAllPhotosFromMetadata();
                    console.log('✅ Đã tải danh sách ảnh');
                } catch (photosError) {
                    console.warn('⚠️ Không thể tải ảnh:', photosError.message);
                }
                
                // Khởi tạo các sự kiện và chức năng khác
                console.log('🔧 Khởi tạo event handlers...');
                initializeEventHandlers();
                console.log('✅ Event handlers đã được khởi tạo');
                
                console.log('🎉 Ứng dụng đã khởi tạo thành công!');
                
            } catch (error) {
                console.error('❌ Lỗi nghiêm trọng khi khởi tạo ứng dụng:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
                
                // Vẫn cố gắng khởi tạo calendar cơ bản
                try {
                    console.log('🔄 Thử khởi tạo calendar cơ bản...');
                    const calendar = new Calendar();
                    window.calendarInstance = calendar;
                    initializeEventHandlers();
                    showMessage('⚠️ Ứng dụng chạy ở chế độ hạn chế. Một số tính năng có thể không hoạt động.', 'error');
                } catch (fallbackError) {
                    console.error('💥 Không thể khởi tạo ứng dụng:', fallbackError);
                    showMessage('❌ Có lỗi nghiêm trọng. Vui lòng tải lại trang hoặc liên hệ hỗ trợ.', 'error');
                }
            }
        }

        // Hàm khởi tạo floating settings menu
        function initializeFloatingSettings() {
            const container = document.getElementById('radialMenuContainer');
            const toggleBtn = document.getElementById('settingsBtn');
            const floatingSettings = document.querySelector('.floating-settings');

            let isDragging = false;
            let dragStartX = 0;
            let dragStartY = 0;
            let initialX = 0;
            let initialY = 0;
            let dragTimeout = null;

            // Lưu và khôi phục vị trí từ localStorage
            function savePosition() {
                const rect = floatingSettings.getBoundingClientRect();
                localStorage.setItem('floatingSettingsPosition', JSON.stringify({
                    top: rect.top,
                    left: rect.left
                }));
            }

            function loadPosition() {
                const saved = localStorage.getItem('floatingSettingsPosition');
                if (saved) {
                    try {
                        const position = JSON.parse(saved);
                        // Kiểm tra vị trí có hợp lệ không (trong màn hình)
                        if (position.top >= 0 && position.left >= 0 && 
                            position.top < window.innerHeight - 100 && 
                            position.left < window.innerWidth - 100) {
                            floatingSettings.style.top = position.top + 'px';
                            floatingSettings.style.left = position.left + 'px';
                            floatingSettings.style.right = 'auto';
                        }
                    } catch (e) {
                        console.log('Không thể khôi phục vị trí settings');
                    }
                }
            }

            // Khôi phục vị trí khi tải trang
            loadPosition();

            // Xử lý sự kiện kéo thả
            function handleMouseDown(e) {
                // Chỉ cho phép kéo bằng chuột trái
                if (e.button !== 0) return;
                
                isDragging = false;
                dragStartX = e.clientX;
                dragStartY = e.clientY;
                
                const rect = floatingSettings.getBoundingClientRect();
                initialX = rect.left;
                initialY = rect.top;

                // Thêm event listeners cho document
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
                
                // Ngăn chặn selection
                e.preventDefault();
            }

            function handleMouseMove(e) {
                const deltaX = e.clientX - dragStartX;
                const deltaY = e.clientY - dragStartY;
                
                // Chỉ bắt đầu kéo khi di chuyển đủ xa (tránh kéo nhầm khi click)
                if (!isDragging && (Math.abs(deltaX) > 5 || Math.abs(deltaY) > 5)) {
                    isDragging = true;
                    floatingSettings.classList.add('dragging');
                    container.classList.remove('active'); // Đóng menu khi bắt đầu kéo
                }

                if (isDragging) {
                    let newX = initialX + deltaX;
                    let newY = initialY + deltaY;
                    
                    // Giới hạn trong màn hình
                    const maxX = window.innerWidth - floatingSettings.offsetWidth;
                    const maxY = window.innerHeight - floatingSettings.offsetHeight;
                    
                    newX = Math.max(0, Math.min(newX, maxX));
                    newY = Math.max(0, Math.min(newY, maxY));
                    
                    floatingSettings.style.left = newX + 'px';
                    floatingSettings.style.top = newY + 'px';
                    floatingSettings.style.right = 'auto';
                }
            }

            function handleMouseUp(e) {
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
                
                if (isDragging) {
                    floatingSettings.classList.remove('dragging');
                    savePosition(); // Lưu vị trí mới
                    
                    // Delay một chút trước khi cho phép click lại
                    setTimeout(() => {
                        isDragging = false;
                    }, 100);
                } else {
                    // Nếu không kéo thì xử lý như click bình thường
                    e.stopPropagation();
                    container.classList.toggle('active');
                }
            }

            // Xử lý touch events cho mobile
            function handleTouchStart(e) {
                if (e.touches.length !== 1) return;
                
                const touch = e.touches[0];
                isDragging = false;
                dragStartX = touch.clientX;
                dragStartY = touch.clientY;
                
                const rect = floatingSettings.getBoundingClientRect();
                initialX = rect.left;
                initialY = rect.top;

                document.addEventListener('touchmove', handleTouchMove, { passive: false });
                document.addEventListener('touchend', handleTouchEnd);
            }

            function handleTouchMove(e) {
                if (e.touches.length !== 1) return;
                
                const touch = e.touches[0];
                const deltaX = touch.clientX - dragStartX;
                const deltaY = touch.clientY - dragStartY;
                
                if (!isDragging && (Math.abs(deltaX) > 5 || Math.abs(deltaY) > 5)) {
                    isDragging = true;
                    floatingSettings.classList.add('dragging');
                    container.classList.remove('active');
                }

                if (isDragging) {
                    e.preventDefault(); // Ngăn scroll trang
                    
                    let newX = initialX + deltaX;
                    let newY = initialY + deltaY;
                    
                    const maxX = window.innerWidth - floatingSettings.offsetWidth;
                    const maxY = window.innerHeight - floatingSettings.offsetHeight;
                    
                    newX = Math.max(0, Math.min(newX, maxX));
                    newY = Math.max(0, Math.min(newY, maxY));
                    
                    floatingSettings.style.left = newX + 'px';
                    floatingSettings.style.top = newY + 'px';
                    floatingSettings.style.right = 'auto';
                }
            }

            function handleTouchEnd(e) {
                document.removeEventListener('touchmove', handleTouchMove);
                document.removeEventListener('touchend', handleTouchEnd);
                
                if (isDragging) {
                    floatingSettings.classList.remove('dragging');
                    savePosition();
                    
                    setTimeout(() => {
                        isDragging = false;
                    }, 100);
                } else {
                    // Touch click
                    e.preventDefault();
                    container.classList.toggle('active');
                }
            }

            // Thêm event listeners
            toggleBtn.addEventListener('mousedown', handleMouseDown);
            toggleBtn.addEventListener('touchstart', handleTouchStart, { passive: true });

            // Đóng menu khi click ra ngoài (chỉ khi không đang kéo)
            document.addEventListener('click', (e) => {
                if (!isDragging && !e.target.closest('.radial-menu-container')) {
                    container.classList.remove('active');
                }
            });

            // Xử lý khi thay đổi kích thước màn hình
            window.addEventListener('resize', () => {
                const rect = floatingSettings.getBoundingClientRect();
                const maxX = window.innerWidth - floatingSettings.offsetWidth;
                const maxY = window.innerHeight - floatingSettings.offsetHeight;
                
                if (rect.left > maxX || rect.top > maxY) {
                    const newX = Math.max(0, Math.min(rect.left, maxX));
                    const newY = Math.max(0, Math.min(rect.top, maxY));
                    
                    floatingSettings.style.left = newX + 'px';
                    floatingSettings.style.top = newY + 'px';
                    savePosition();
                }
            });

            // Xử lý các nút trong menu
            document.getElementById('floatingAddEvent').addEventListener('click', () => {
                document.getElementById('addEventBtn').click();
                container.classList.remove('active');
            });

            document.getElementById('floatingDeleteEvent').addEventListener('click', () => {
                document.getElementById('deleteEventBtn').click();
                container.classList.remove('active');
            });



            document.getElementById('floatingUploadMetadata').addEventListener('click', () => {
                document.getElementById('uploadMetadataBtn').click();
                container.classList.remove('active');
            });

            document.getElementById('floatingAutoUpdate').addEventListener('click', () => {
                document.getElementById('autoUpdateToggle').click();
                container.classList.remove('active');
            });

            document.getElementById('floatingRefreshPhotos').addEventListener('click', () => {
                document.getElementById('refreshPhotos').click();
                container.classList.remove('active');
            });

            // Cập nhật trạng thái nút xóa sự kiện
            const originalDeleteBtn = document.getElementById('deleteEventBtn');
            const floatingDeleteBtn = document.getElementById('floatingDeleteEvent');
            
            // Theo dõi thay đổi trạng thái disabled của nút xóa gốc
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'disabled') {
                        if (originalDeleteBtn.disabled) {
                            floatingDeleteBtn.style.opacity = '0.5';
                            floatingDeleteBtn.style.pointerEvents = 'none';
                        } else {
                            floatingDeleteBtn.style.opacity = '1';
                            floatingDeleteBtn.style.pointerEvents = 'all';
                        }
                    }
                });
            });

            observer.observe(originalDeleteBtn, { attributes: true });

            // Thiết lập trạng thái ban đầu
            if (originalDeleteBtn.disabled) {
                floatingDeleteBtn.style.opacity = '0.5';
                floatingDeleteBtn.style.pointerEvents = 'none';
            }

            // Cập nhật màu nút tự động cập nhật dựa trên trạng thái
            updateAutoUpdateButtonColor();
        }

        // Hàm cập nhật màu nút tự động cập nhật
        function updateAutoUpdateButtonColor() {
            const isAutoEnabled = localStorage.getItem('autoUpdateEnabled') === 'true';
            const floatingAutoBtn = document.getElementById('floatingAutoUpdate');
            const alarmIcon = floatingAutoBtn.querySelector('i');
            
            if (isAutoEnabled) {
                // Trạng thái bật - icon màu đỏ để chỉ có thể tắt
                alarmIcon.style.color = '#EF4444';
            } else {
                // Trạng thái tắt - icon màu xanh để chỉ có thể bật
                alarmIcon.style.color = '#10B981';
            }
        }

        // Hàm khởi tạo các sự kiện
        function initializeEventHandlers() {
            // Khởi tạo floating settings menu
            initializeFloatingSettings();
            // Khởi tạo tự động cập nhật từ cấu hình
            const isAutoEnabled = CONFIG.AUTO_LOAD_METADATA === "true" || CONFIG.AUTO_LOAD_METADATA === true;
            const toggleBtn = document.getElementById('autoUpdateToggle');
            
            if (isAutoEnabled) {
                setupAutoUpdate();
                toggleBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                toggleBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                toggleBtn.title = 'Tắt cập nhật tự động 9h sáng';
                localStorage.setItem('autoUpdateEnabled', 'true');
            } else {
                // Tắt tự động cập nhật
                stopAutoUpdate();
                toggleBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                toggleBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
                toggleBtn.title = 'Bật cập nhật tự động 9h sáng';
                localStorage.setItem('autoUpdateEnabled', 'false');
            }
            
            // Thêm sự kiện cho các nút phân trang
            document.getElementById('firstPageBtn').addEventListener('click', () => {
                if (currentPage !== 1) {
                    displayPhotosPage(1);
                    document.getElementById('photosGrid').scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }
            });
            
            document.getElementById('prevPageBtn').addEventListener('click', () => {
                if (currentPage > 1) {
                    displayPhotosPage(currentPage - 1);
                    document.getElementById('photosGrid').scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }
            });
            
            document.getElementById('nextPageBtn').addEventListener('click', () => {
                if (currentPage < totalPages) {
                    displayPhotosPage(currentPage + 1);
                    document.getElementById('photosGrid').scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }
            });
            
            document.getElementById('lastPageBtn').addEventListener('click', () => {
                if (currentPage !== totalPages) {
                    displayPhotosPage(totalPages);
                    document.getElementById('photosGrid').scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }
            });
            
            // Thêm điều khiển bàn phím cho modal ảnh
            document.addEventListener('keydown', (e) => {
                const photoModal = document.getElementById('photoModal');
                if (photoModal.classList.contains('show')) {
                    switch(e.key) {
                        case 'ArrowLeft':
                            e.preventDefault();
                            navigatePhoto(-1);
                            break;
                        case 'ArrowRight':
                            e.preventDefault();
                            navigatePhoto(1);
                            break;
                        case 'Escape':
                            e.preventDefault();
                            closePhotoModal();
                            break;
                    }
                }
            });
            


            // Thêm sự kiện cho nút cập nhật metadata ảnh
            document.getElementById('uploadMetadataBtn').addEventListener('click', () => {
                uploadPhotosMetadata();
            });

            // Thêm sự kiện cho nút bật/tắt tự động cập nhật
            document.getElementById('autoUpdateToggle').addEventListener('click', async () => {
                const isAutoEnabled = localStorage.getItem('autoUpdateEnabled') === 'true';
                const toggleBtn = document.getElementById('autoUpdateToggle');
                
                if (isAutoEnabled) {
                    // Tắt tự động cập nhật
                    localStorage.setItem('autoUpdateEnabled', 'false');
                    stopAutoUpdate();
                    toggleBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                    toggleBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
                    toggleBtn.title = 'Bật cập nhật tự động 9h sáng';
                    showMessage('⏹️ Đã tắt cập nhật tự động metadata', 'success');
                    
                    // Cập nhật cấu hình
                    await updateConfigFile('AUTO_LOAD_METADATA', 'false');
                    
                    // Thêm log
                    addLog('Tắt chức năng cập nhật tự động 9h sáng', 'Người dùng tắt thủ công');
                } else {
                    // Bật tự động cập nhật
                    localStorage.setItem('autoUpdateEnabled', 'true');
                    setupAutoUpdate();
                    toggleBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                    toggleBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                    toggleBtn.title = 'Tắt cập nhật tự động 9h sáng';
                    showMessage('⏰ Đã bật cập nhật tự động metadata lúc 9h sáng hằng ngày', 'success');
                    
                    // Cập nhật cấu hình
                    await updateConfigFile('AUTO_LOAD_METADATA', 'true');
                    
                    // Thêm log
                    addLog('Bật chức năng cập nhật tự động 9h sáng', 'Người dùng bật thủ công');
                }
                
                // Cập nhật màu nút floating
                updateAutoUpdateButtonColor();
            });

            // Thêm sự kiện cho nút refresh dữ liệu (tải lại cả sự kiện và ảnh)
            document.getElementById('refreshPhotos').addEventListener('click', async () => {
                try {
                    // Refresh sự kiện
                    const { content } = await readNotes();
                    if (content && content.length > 0 && window.calendarInstance) {
                        window.calendarInstance.updateEventsFromData(content);
                    }
                    if (window.calendarInstance) {
                        window.calendarInstance.goToToday();
                    }
                    
                    // Refresh ảnh
                    await loadAllPhotosFromMetadata();
                    
                    showMessage('✅ Đã refresh toàn bộ dữ liệu thành công!', 'success');
                } catch (error) {
                    console.error('Lỗi khi refresh dữ liệu:', error);
                    showMessage('❌ Có lỗi khi refresh dữ liệu. Vui lòng thử lại.', 'error');
                }
            });

            // Thêm sự kiện click vào vùng trống để bỏ chọn
            document.addEventListener('click', (e) => {
                // Kiểm tra nếu click không phải vào sự kiện hoặc các nút điều khiển
                if (!e.target.closest('.event-item') && 
                    !e.target.closest('#deleteEventBtn') && 
                    !e.target.closest('#addEventBtn')) {
                    
                    // Bỏ chọn tất cả sự kiện
                    document.querySelectorAll('.event-item').forEach(item => {
                        item.classList.remove('border-red-400', 'bg-gradient-to-r', 'from-red-50', 'to-red-100', 'shadow-lg', 'scale-105');
                        item.classList.add('border-pink-200', 'from-pink-50', 'to-purple-50');
                    });
                    
                    // Reset selection
                    selectedEventIndex = -1;
                    document.getElementById('deleteEventBtn').disabled = true;
                    
                    // Khôi phục thông tin kỷ niệm về sự kiện gần nhất
                    updateAnniversaryInfo(currentEventsData);
                }
            });

            // Xử lý sự kiện khi nhấn nút "Xóa Sự Kiện"
            document.getElementById('deleteEventBtn').addEventListener('click', () => {
                if (selectedEventIndex === -1) {
                    showMessage('Vui lòng chọn sự kiện cần xóa.', 'error');
                    return;
                }

                const selectedEvent = currentEventsData[selectedEventIndex];
                const day = String(selectedEvent.day).padStart(2, '0');
                const month = String(selectedEvent.month).padStart(2, '0');
                const formattedDate = `${day}/${month}/${selectedEvent.year}`;
                const eventContent = selectedEvent.contdetl || 'Không có nội dung';
                
                // Hiển thị thông tin sự kiện trong modal xác nhận
                document.getElementById('eventToDelete').innerHTML = `
                    <strong>${formattedDate}:</strong> ${eventContent}
                `;
                
                // Hiển thị modal xác nhận
                const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
                deleteModal.show();
            });

            // Xử lý sự kiện khi nhấn nút xác nhận xóa
            document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
                const confirmBtn = document.getElementById('confirmDeleteBtn');
                const deleteSpinner = document.getElementById('deleteSpinner');
                
                // Hiển thị loading
                confirmBtn.disabled = true;
                deleteSpinner.classList.remove('d-none');

                try {
                    await deleteEvent(selectedEventIndex);
                    
                    // Đóng modal
                    const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
                    deleteModal.hide();
                    
                    // Reset selection
                    selectedEventIndex = -1;
                    document.getElementById('deleteEventBtn').disabled = true;
                    
                } catch (error) {
                    console.error('Lỗi khi xóa sự kiện:', error);
                    showMessage('Lỗi khi xóa sự kiện. Vui lòng thử lại.', 'error');
                } finally {
                    // Ẩn loading
                    confirmBtn.disabled = false;
                    deleteSpinner.classList.add('d-none');
                }
            });

            // Xử lý sự kiện khi nhấn nút "Lưu Ảnh Vào Sự Kiện"
            document.getElementById('savePhotoToEventsBtn').addEventListener('click', savePhotoToEvents);

            // Xử lý sự kiện khi nhấn nút "Lưu Sự Kiện"
            document.getElementById('saveEventBtn').addEventListener('click', async () => {
                const eventDate = document.getElementById('eventDate').value;
                const eventContent = document.getElementById('eventContent').value.trim();
                const eventColor = document.querySelector('input[name="eventColor"]:checked').value;
                const eventIcon = document.querySelector('input[name="eventIcon"]:checked').value;
                const eventImageFolder = document.getElementById('eventImageFolder').value.trim();

                if (!eventDate || !eventContent) {
                    showMessage('Vui lòng nhập ngày và nội dung sự kiện.', 'error');
                    return;
                }

                const saveBtn = document.getElementById('saveEventBtn');
                const saveSpinner = document.getElementById('saveSpinner');
                
                // Hiển thị loading
                saveBtn.disabled = true;
                saveSpinner.classList.remove('d-none');

                try {
                    // Đọc dữ liệu hiện tại
                    const { content: currentEvents, sha } = await readNotes();

                    // Chuyển đổi ngày từ YYYY-MM-DD sang DD/MM/YYYY
                    const dateParts = eventDate.split('-');
                    const day = parseInt(dateParts[2]);
                    const month = parseInt(dateParts[1]);
                    const year = parseInt(dateParts[0]);

                    // Tạo sự kiện mới
                    const newEvent = {
                        day: day,
                        month: month,
                        year: year,
                        contdetl: eventContent,
                        colorClass: eventColor,
                        icon: eventIcon,
                        URL: eventImageFolder || '',
                        date: new Date().toISOString()
                    };
                    
                    // Thêm sự kiện mới vào mảng
                    currentEvents.push(newEvent);
                    
                    // Ghi lại mảng đã cập nhật
                    await writeNotes(currentEvents, sha);

                    // Cập nhật giao diện
                    displayEvents(currentEvents);
                    if (window.calendarInstance) {
                        window.calendarInstance.updateEventsFromData(currentEvents);
                    }
                    showMessage('Sự kiện đã được lưu thành công! 🎉');

                    // Thêm log
                    const eventInfo = `${day}/${month}/${year}: ${eventContent}`;
                    addLog('Thêm mới sự kiện', eventInfo);

                    // Đóng modal và reset form
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addEventModal'));
                    modal.hide();
                    document.getElementById('addEventForm').reset();
                    
                    // Reset các radio button về mặc định
                    document.getElementById('color-pink').checked = true;
                    document.getElementById('icon-heart').checked = true;

                } catch (error) {
                    console.error('Lỗi khi lưu sự kiện:', error);
                    showMessage('Lỗi khi lưu sự kiện. Vui lòng thử lại.', 'error');
                } finally {
                    // Ẩn loading
                    saveBtn.disabled = false;
                    saveSpinner.classList.add('d-none');
                }
            });
        }

        // Khởi tạo ứng dụng khi DOM đã sẵn sàng
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9849e773856d03b7',t:'MTc1ODc5NjgzNC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
